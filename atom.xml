<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dokey_</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-03-24T08:09:26.991Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Dokey_</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>DokeyC2_Demo_v4.3</title>
    <link href="http://example.com/ed2f8944.html"/>
    <id>http://example.com/ed2f8944.html</id>
    <published>2025-03-22T09:11:35.000Z</published>
    <updated>2025-03-24T08:09:26.991Z</updated>
    
    <content type="html"><![CDATA[<div class="note "><p><strong>DokeyC2</strong></p><p>已完成第一阶段demo开发, 目前实现了客户端到服务端之间的通信, 向服务端发送命令、获取监听器信息、获取被控端信息、向所有客户端推送信息; 被控端到服务端之间的通信, 向服务端获取命令执行、向服务端发送心跳包保持活跃, 向服务端发送系统信息等</p></div><span id="more"></span><h2 id="运行展示"><a href="#运行展示" class="headerlink" title="运行展示"></a>运行展示</h2><h2 id="DockeyC2通信架构"><a href="#DockeyC2通信架构" class="headerlink" title="DockeyC2通信架构"></a>DockeyC2通信架构</h2><h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><ul><li><code>C2服务端</code>到<code>客户端</code>选择使用HTTPS通信，使用TLS（传输层安全协议加密通信内容）；服务端和客户端之前长连接机制来保证连接复用，在多次请求&#x2F;响应周期中复用连接，避免频繁建立和断开连接的开销，提高系统性能和响应速度。</li><li><code>C2服务端</code>到<code>被控端</code>目前支持HTTP协议通信，因为这块后续需要根据监听器（HTTP、HTTPS、DNS）来选择并创建不同的Beacon，所以目前只实现了HTTP逻辑。</li></ul><h2 id="服务端（Server）"><a href="#服务端（Server）" class="headerlink" title="服务端（Server）"></a>服务端（Server）</h2><h3 id="服务端主要功能概述"><a href="#服务端主要功能概述" class="headerlink" title="服务端主要功能概述"></a>服务端主要功能概述</h3><h4 id="监听连接"><a href="#监听连接" class="headerlink" title="监听连接"></a>监听连接</h4><ul><li>监听<code>4433</code>端口，并使用线程处理每个验证通过的客户端，可以多个客户端连接到服务端</li><li>可以通过客户端在服务端创建监听器，被控端（Beacon）通过监听器连接至服务端，支持多个被控端连接到该监听器并正确处理请求</li></ul><h4 id="命令分发与执行"><a href="#命令分发与执行" class="headerlink" title="命令分发与执行"></a>命令分发与执行</h4><ul><li>在服务端通过工厂模式来模块化处理客户端、被控端的请求，不同的请求对应不同的处理逻辑</li><li>客户端通过HTTPS请求将命令传递到服务端，服务端根据<code>beacon_id</code>将命令存储到对应命令队列中，并等待被控端通过请求来获取需要执行的命令</li><li>被控端通过<code>/CommandRetrieval</code>接口请求需要执行的命令，当获取命令后根据<code>command_id</code>将命令状态置为<code>正在执行</code>状态，当执行完并返回结果后根据<code>command_id</code>将命令状态置为<code>已执行</code>状态；保证获取命令时不会获取已执行的命令；此处将命令执行完成将命令状态置为<code>已完成</code>状态，暂未实现将命令删除或转存，后续可能需要获取命令执行历史记录</li></ul><h4 id="信息存储"><a href="#信息存储" class="headerlink" title="信息存储"></a>信息存储</h4><ul><li>客户端连接存储：使用<code>std::unordered_map &lt;std::string, std::shared_ptr&lt;ClientSession&gt;&gt;</code>来存储客户端session，以<code>client_id</code>为键，值为<code>std::shared_ptr&lt;ClientSession&gt;</code>；首先<code>std::unordered_map</code>提供了高效查找，可以通过<code>std::mutex</code>来实现线程安全；其次使用<code>std::shared_ptr&lt;ClientSession&gt;</code>可以动态管理内存，简化对象的共享和传递，避免重复传递对象；另外<code>std::unordered_map</code>支持快速扩展，可以轻松地添加或删除客户端会话，确保性能稳定</li><li>被控端连接存储：使用<code>std::unordered_map&lt;std::string, std::shared_ptr&lt;Beacon&gt;&gt;</code>来存储被控端session，以<code>beacon_id</code>为键，值为<code>std::shared_ptr&lt;Beacon&gt;</code>，使用特性和客户端连接存储同理</li><li>监听器存储：使用<code>std::unordered_map &lt;std::string, std::shared_ptr&lt;IListener&gt;&gt;</code>来存储监听器信息，使用特性和客户端连接存储同理</li></ul><h3 id="服务端架构与代码结构"><a href="#服务端架构与代码结构" class="headerlink" title="服务端架构与代码结构"></a>服务端架构与代码结构</h3><h4 id="服务端结构概述"><a href="#服务端结构概述" class="headerlink" title="服务端结构概述"></a>服务端结构概述</h4><ul><li><strong>C2服务端</strong>：作为指挥中心，负责接收来自客户端的命令、验证客户端身份、管理客户端连接以及向被控端下发指令。</li><li><strong>C2客户端</strong>：用于与服务端通信的用户界面，通常负责显示当前连接的状态、管理连接、发送命令、接收执行结果等。</li><li><strong>被控端（Beacon）</strong>：被控制的目标机器，通过 C2 服务端下发的命令执行操作，并将结果反馈给服务端。</li></ul><h4 id="通信流程"><a href="#通信流程" class="headerlink" title="通信流程"></a>通信流程</h4><h5 id="客户端连接与认证"><a href="#客户端连接与认证" class="headerlink" title="客户端连接与认证"></a>客户端连接与认证</h5><ol><li>建立连接：C2客户端发起 HTTPS 请求，尝试与服务端建立连接。</li><li>身份验证：<ul><li>客户端在请求中附带加密的身份验证信息（如用户名&#x2F;密码或密钥）。</li><li>服务端接收到请求后，解密并验证身份。</li><li>如果身份验证通过，服务端生成一个会话令牌（目前为client_id）并发送给客户端，表示身份验证成功。客户端保存此令牌并在后续的请求中使用。</li><li>如果身份验证失败，服务端返回错误响应，客户端需要重新进行身份验证。</li></ul></li></ol><h5 id="命令交互"><a href="#命令交互" class="headerlink" title="命令交互"></a>命令交互</h5><ol start="3"><li>客户端发送命令：<br> +客户端通过 HTTPS 向服务端发送执行命令请求（如执行 Beacon 任务、查询 Beacon 状态等）。请求中会附带会话令牌作为身份验证。</li><li>服务端处理命令：<ul><li>服务端接收到请求后，验证会话令牌的有效性。</li><li>如果令牌有效，服务端根据请求内容查找对应的 Beacon，并将命令下发给目标 Beacon。</li><li>服务端等待 Beacon 返回执行结果。</li></ul></li></ol><h5 id="Beacon执行与反馈"><a href="#Beacon执行与反馈" class="headerlink" title="Beacon执行与反馈"></a>Beacon执行与反馈</h5><ol start="5"><li>Beacon 接收命令：<ul><li>Beacon 定期向服务端发送心跳包或 Beacon 信息，表明自己在线，并接收下发的命令。</li></ul></li><li>Beacon 执行命令：<ul><li>eacon 根据服务端下发的命令执行相应操作，并将结果返回给服务端（例如执行 Shell 命令、获取系统信息等）。</li></ul></li><li>服务端反馈结果：<ul><li>服务端接收到 Beacon 返回的结果后，整理并通过 HTTPS 返回给客户端。</li><li>客户端收到执行结果并显示给用户，更新客户端的状态。</li></ul></li></ol><h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DokeyC2</span><br><span class="line">├── <span class="built_in">Commands</span> (命令处理模块)</span><br><span class="line">│   ├── <span class="built_in">Include</span> (接口文件)</span><br><span class="line">|   |   ├── ICommand.<span class="built_in">hpp</span> (命令基类实现)</span><br><span class="line">|   |   └── ICommandFactory.<span class="built_in">hpp</span> (工厂模式基类实现)</span><br><span class="line">│   ├── <span class="built_in">ListenerCommand</span> (监听器命令处理模块)</span><br><span class="line">|   |   └── HttpCommand.hpp / HttpCommand.<span class="built_in">cpp</span> (http命令处理头文件 / 具体处理函数实现)</span><br><span class="line">│   ├── Command.hpp / Command.<span class="built_in">cpp</span> (客户端命令处理头文件 / 具体处理函数实现)</span><br><span class="line">│   └── CommandFactory.hpp / CommandFactory.<span class="built_in">cpp</span> (命令工厂模式头文件 / 具体工厂模式函数实现)</span><br><span class="line">├── <span class="built_in">Networks</span> (网络通信处理模块)</span><br><span class="line">│   ├── <span class="built_in">Beacons</span> (被控端)</span><br><span class="line">│   │   └── Beacon.hpp / Beacon.<span class="built_in">cpp</span> (被控端头文件 / 被控端逻辑实现)</span><br><span class="line">│   ├── <span class="built_in">Clients</span> (客户端)</span><br><span class="line">│   │   └── Client.hpp / Client.<span class="built_in">cpp</span> (客户端头文件 / 客户端逻辑实现)</span><br><span class="line">│   ├── <span class="built_in">Include</span> (接口文件)</span><br><span class="line">│   │   ├── IListener.<span class="built_in">hpp</span> (监听器基类实现)</span><br><span class="line">│   │   └── INetworkManager.<span class="built_in">hpp</span> (网络通信管理基类实现)</span><br><span class="line">│   ├── <span class="built_in">Listeners</span> (监听器)</span><br><span class="line">│   │   └── HttpListener.hpp / HttpListener.<span class="built_in">cpp</span> (http监听器头文件 / http监听器处理函数实现)</span><br><span class="line">│   ├── <span class="built_in">Manager</span> (网络通信管理)</span><br><span class="line">│   │   ├── AuthManager.<span class="built_in">hpp</span> (客户端身份验证头文件, 逻辑实现)</span><br><span class="line">│   │   └── NetworkManager.hpp / NetworkManager.<span class="built_in">cpp</span> (网络通信管理头文件 / 网络通信管理处理函数实现)</span><br><span class="line">│   └── <span class="built_in">Sessions</span> (连接处理)</span><br><span class="line">│   │   ├── ClientSession.<span class="built_in">hpp</span> (客户端session处理逻辑头文件)</span><br><span class="line">│   │   ├── HttpSession.hpp / HttpSession.<span class="built_in">cpp</span> (http session处理逻辑头文件 / http session处理函数实现)</span><br><span class="line">│   |   └── ListenerSession.<span class="built_in">hpp</span> (监听器session处理逻辑头文件)</span><br><span class="line">└── <span class="built_in">Tools</span> (工具模块)</span><br><span class="line">    └── Serialization.hpp / Serialization.<span class="built_in">cpp</span> (处理通信序列化头文件 / 处理通信序列化逻辑实现)</span><br></pre></td></tr></table></figure><h4 id="服务端与客户端、Beacon通信数据验证"><a href="#服务端与客户端、Beacon通信数据验证" class="headerlink" title="服务端与客户端、Beacon通信数据验证"></a>服务端与客户端、Beacon通信数据验证</h4><h5 id="服务端与客户端（HTTPS）"><a href="#服务端与客户端（HTTPS）" class="headerlink" title="服务端与客户端（HTTPS）"></a>服务端与客户端（HTTPS）</h5><blockquote><p>客户端发送的请求以及服务端的回应都会使用 SSL&#x2F;TLS 进行加密，保证数据传输的安全性。</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202503241600009.png' data-fancybox='default' data-caption='服务端与客户端（HTTPS）数据验证'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241600009.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241600009.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="服务端与客户端（HTTPS）数据验证"></a><span class='image-caption'>服务端与客户端（HTTPS）数据验证</span></div></div><h5 id="服务端与被控端（HTTP）"><a href="#服务端与被控端（HTTP）" class="headerlink" title="服务端与被控端（HTTP）"></a>服务端与被控端（HTTP）</h5><blockquote><p>当前支持HTTP监听器, 后续添加HTTPS、DNS类型监听器</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202503241607945.png' data-fancybox='default' data-caption='服务端与被控端（HTTP）数据验证'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241607945.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241607945.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="服务端与被控端（HTTP）数据验证"></a><span class='image-caption'>服务端与被控端（HTTP）数据验证</span></div></div><h2 id="客户端（Client）"><a href="#客户端（Client）" class="headerlink" title="客户端（Client）"></a>客户端（Client）</h2><blockquote><p>客户端使用 MFC 单文档开发，界面参考 cobalt strike ；自实现 C2 上版本使用 <code>MFC基于对话框</code> 进行客户端界面开发，在视觉效果上总觉得差强人意，在视图、数据的展示会存在很多隐藏的bug，所以选用MFC单文档进行开发，也一边学习 MFC 单文档开发模式</p></blockquote><h3 id="MFC单文档概述"><a href="#MFC单文档概述" class="headerlink" title="MFC单文档概述"></a>MFC单文档概述</h3><blockquote><p>MFC（Microsoft Foundation Class）是一个基于 C++ 的类库，提供了丰富的界面和功能来帮助开发 Windows 应用程序。MFC 支持多种应用程序架构，其中 单文档界面（SDI） 是最常用的一种。</p></blockquote><ul><li>单文档界面 (SDI)：在单文档界面应用程序中，通常只有一个主窗口（即主框架窗口），并且该窗口的内容或数据通过一个文档对象来管理。SDI 应用程序的特点是每次只能打开一个文档实例。</li><li>特点：简单、直观、适用于需要操作单一数据集的应用，用户界面清晰。</li></ul><h3 id="MFC单文档应用程序的基本结构"><a href="#MFC单文档应用程序的基本结构" class="headerlink" title="MFC单文档应用程序的基本结构"></a>MFC单文档应用程序的基本结构</h3><p>在 MFC 单文档应用程序中，主要有以下几个关键组成部分：</p><ul><li>文档类（CDocument）：负责应用程序的数据管理和存储。文档类通常用于存储应用程序中的核心数据（如网络连接信息、命令队列等），并提供对这些数据的操作接口。</li><li>视图类（CView）：负责显示文档中的内容，并与用户进行交互。视图类的任务是将文档中的数据可视化，提供用户与应用程序交互的界面。</li><li>框架类（CFrameWnd）：负责窗口的布局、菜单、工具栏等界面的控制。框架窗口是应用程序的主要容器，包含视图和文档的显示界面。</li></ul><h3 id="C2客户端设计"><a href="#C2客户端设计" class="headerlink" title="C2客户端设计"></a>C2客户端设计</h3><h4 id="网络连接与通信"><a href="#网络连接与通信" class="headerlink" title="网络连接与通信"></a>网络连接与通信</h4><blockquote><p>客户端与 C2 服务端通过 HTTPS 建立连接并保持会话。使用 Boost.Beast 库来实现与服务端的通信。</p></blockquote><ol><li>建立连接：客户端在启动时通过 HTTPS 长连接与服务端进行通信，进行身份验证等。</li><li>命令发送与结果接收：客户端可以通过发送命令请求（如执行 Beacon 操作、查询 Beacon 状态等），等待服务端返回结果并显示。</li></ol><h5 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h5><ol><li><p>在 HttpsClient.h 中实现了对服务端的连接并进行响应解析，并且在 StartReceiveResponse 函数中对响应进行持续读取解析，并通过自定义消息（WM_HTTPS_RESPONSE）将响应发送到主框架处理</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StartReceiveResponse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 清空响应正文</span></span><br><span class="line">response_.<span class="built_in">body</span>().<span class="built_in">clear</span>();</span><br><span class="line"><span class="comment">// 重置响应头部和状态码</span></span><br><span class="line">response_.<span class="built_in">clear</span>();</span><br><span class="line"><span class="comment">// 清空缓冲区</span></span><br><span class="line">buffer_.<span class="built_in">consume</span>(buffer_.<span class="built_in">size</span>());</span><br><span class="line">boost::beast::http::<span class="built_in">async_read</span>(*stream_, buffer_, response_,</span><br><span class="line">[<span class="keyword">this</span>](boost::system::error_code ec, std::<span class="type">size_t</span> <span class="comment">/*length*/</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (ec) &#123;</span><br><span class="line"><span class="built_in">HandleError</span>(ec, <span class="string">&quot;读取服务器响应失败&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">std::vector&lt;<span class="type">char</span>&gt; <span class="built_in">body_data</span>(response_.<span class="built_in">body</span>().<span class="built_in">begin</span>(), response_.<span class="built_in">body</span>().<span class="built_in">end</span>());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Command2Server deserializedServer;</span><br><span class="line">std::stringstream <span class="built_in">ss</span>(std::<span class="built_in">string</span>(body_data.<span class="built_in">begin</span>(), body_data.<span class="built_in">end</span>()));</span><br><span class="line">boost::archive::binary_iarchive <span class="built_in">ia</span>(ss);</span><br><span class="line">ia &gt;&gt; deserializedServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pMainWnd_) &#123;</span><br><span class="line">Command2Server* pData = <span class="keyword">new</span> <span class="built_in">Command2Server</span>(deserializedServer);</span><br><span class="line">pMainWnd_-&gt;<span class="built_in">PostMessage</span>(WM_HTTPS_RESPONSE, <span class="built_in">reinterpret_cast</span>&lt;WPARAM&gt;(pData), <span class="number">0</span>);</span><br><span class="line"><span class="comment">//手动处理消息循环, 让WM_HTTPS_RESPONSE先被处理</span></span><br><span class="line">MSG msg;</span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">PeekMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line"><span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">CString msg;</span><br><span class="line">msg.<span class="built_in">Format</span>(_T(<span class="string">&quot;解析响应失败: %S&quot;</span>), e.<span class="built_in">what</span>());</span><br><span class="line"><span class="built_in">AfxOutputDebugString</span>(msg);</span><br><span class="line"><span class="built_in">AfxMessageBox</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 你可以继续读取响应数据</span></span><br><span class="line"><span class="built_in">StartReceiveResponse</span>();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在 MainFrm.cpp 中对响应进行细化处理，根据不同的命令类型解析出数据并传递到文档类（CDocument），通过文档类（CDocument）来通知视图类（CView）进行数据更新</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">CMainFrame::OnHttpsResponse</span><span class="params">(WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">Command2Server* pData = <span class="built_in">reinterpret_cast</span>&lt;Command2Server*&gt;(wParam);</span><br><span class="line"><span class="comment">// 获取当前活动视图</span></span><br><span class="line">CView* pView = <span class="built_in">GetActiveView</span>();</span><br><span class="line"><span class="keyword">if</span> (pData &amp;&amp; pView)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 处理 pData 数据</span></span><br><span class="line"><span class="function">CString <span class="title">cstrMessage</span><span class="params">(pData-&gt;message.c_str())</span></span>; <span class="comment">// std::string 转 CString</span></span><br><span class="line"><span class="comment">// 获取与当前视图关联的文档</span></span><br><span class="line">CDokeyC2Demov43ClientDoc* pDoc = <span class="built_in">dynamic_cast</span>&lt;CDokeyC2Demov43ClientDoc*&gt;(pView-&gt;<span class="built_in">GetDocument</span>());</span><br><span class="line"><span class="built_in">AfxOutputDebugString</span>(cstrMessage);</span><br><span class="line">pDoc-&gt;<span class="built_in">AddLog</span>(cstrMessage);</span><br><span class="line"><span class="keyword">if</span> (pData-&gt;command == <span class="string">&quot;INITIALIZE_CONNECTION&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">client_id_ = pData-&gt;client_id;</span><br><span class="line">pDoc-&gt;<span class="built_in">UpdateClientID</span>(pData-&gt;client_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(pData-&gt;command == <span class="string">&quot;CREATE_LISTENER&quot;</span> || pData-&gt;command == <span class="string">&quot;GET_LISTENERS&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 反序列化 data 中的 ListenerInfo</span></span><br><span class="line">std::stringstream <span class="built_in">listenerDataStream</span>(pData-&gt;data);</span><br><span class="line">boost::<span class="function">archive::binary_iarchive <span class="title">iaListener</span><span class="params">(listenerDataStream)</span></span>;</span><br><span class="line">ListenerInfo newListener;</span><br><span class="line">iaListener &gt;&gt; newListener;  <span class="comment">// 从 data 中恢复 ListenerInfo</span></span><br><span class="line">pDoc-&gt;<span class="built_in">UpdateListenerInfo</span>(newListener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (pData-&gt;command == <span class="string">&quot;PUSH_BEACON_INFO&quot;</span> || pData-&gt;command == <span class="string">&quot;GET_BEACONS&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">std::stringstream <span class="built_in">beaconSystemInfoDataStream</span>(pData-&gt;data);</span><br><span class="line">boost::<span class="function">archive::binary_iarchive <span class="title">iaBeaconSystemInfos</span><span class="params">(beaconSystemInfoDataStream)</span></span>;</span><br><span class="line">BeaconsInfo newBeacons;</span><br><span class="line">iaBeaconSystemInfos &gt;&gt; newBeacons;</span><br><span class="line">pDoc-&gt;<span class="built_in">UpdateBeaconInfo</span>(newBeacons);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (pData-&gt;command == <span class="string">&quot;COMMAND_RESULT_REPORT&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">pDoc-&gt;<span class="built_in">UpdateCommandResult</span>(*pData);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (pData-&gt;command == <span class="string">&quot;UPDATE_DELAY&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">pDoc-&gt;<span class="built_in">UpdateBeaconUpdateDelay</span>(*pData);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span> pData;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e)</span><br><span class="line">&#123;</span><br><span class="line">CString msg;</span><br><span class="line">msg.<span class="built_in">Format</span>(_T(<span class="string">&quot;接收响应出现错误: %s&quot;</span>), <span class="built_in">CString</span>(e.<span class="built_in">what</span>()));</span><br><span class="line"><span class="built_in">AfxMessageBox</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">LRESULT</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="用户界面（UI）设计"><a href="#用户界面（UI）设计" class="headerlink" title="用户界面（UI）设计"></a>用户界面（UI）设计</h4><p>在主界面上，使用 SDI 架构的主窗口展示核心功能和信息。主界面通常包括以下部分：</p><ul><li>列表控件：显示当前所有连接的 Beacon 信息，包括 Beacon ID、状态、IP 地址、用户名、计算机名、延迟等。</li><li>标签页控件：通过动态创建标签来展现不同标签页内容，包括日志标签页、监听器信息标签页、Beacon 命令执行&#x2F;执行结果展示标签页。</li><li>日志视图：显示客户端与服务端的交互日志，帮助用户了解当前操作的执行情况。使用 CRichEdit 控件展示日志信息。属于动态标签页。</li><li>监听器信息视图：属于动态标签页，显示通过客户端创建的监听器信息。</li><li>Beacon 命令操作视图：属于动态标签页，包括输入命令CRichEdit控件、执行结果展示CRichEdit控件；分别用于输入命令、展示执行结果。</li></ul><h5 id="界面详情"><a href="#界面详情" class="headerlink" title="界面详情"></a>界面详情</h5><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202503241025756.png' data-fancybox='default' data-caption='DokeyC2_Demo_v4.3_Client'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241025756.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202503241025756.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="DokeyC2_Demo_v4.3_Client"></a><span class='image-caption'>DokeyC2_Demo_v4.3_Client</span></div></div><h2 id="被控端（Beacon）"><a href="#被控端（Beacon）" class="headerlink" title="被控端（Beacon）"></a>被控端（Beacon）</h2><h3 id="Beacon主要功能"><a href="#Beacon主要功能" class="headerlink" title="Beacon主要功能"></a>Beacon主要功能</h3><h4 id="定期通信（心跳和报告）"><a href="#定期通信（心跳和报告）" class="headerlink" title="定期通信（心跳和报告）"></a>定期通信（心跳和报告）</h4><p>Beacon 定期与 C2 服务端保持连接，以确保与控制中心的联系始终畅通。这种通信通常以 心跳包 形式进行，目的是：</p><ul><li>确保 Beacon 仍然处于在线状态。</li><li>使得 C2 服务端能够实时监控 Beacon 的状态。</li></ul><h4 id="获取命令"><a href="#获取命令" class="headerlink" title="获取命令"></a>获取命令</h4><p>Beacon 通过 HTTP&#x2F;HTTPS&#x2F;DNS 连接到 C2 服务端并通过接口来获取命令指挥 Beacon 执行不同的任务。命令可能包括：</p><ul><li>执行系统命令或脚本。</li><li>获取目标系统的信息（如硬件信息、操作系统版本等）。</li></ul><h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><p>Beacon 收到服务端的指令后，执行相应的操作。根据命令类型，Beacon 可以：</p><ul><li>执行系统命令、shell 命令或自定义脚本。</li><li>获取并返回系统的状态信息或日志。</li><li>执行恶意操作（如删除文件、修改配置、植入后门等）。</li></ul><h4 id="反馈执行结果"><a href="#反馈执行结果" class="headerlink" title="反馈执行结果"></a>反馈执行结果</h4><p>执行完命令后，Beacon 会将结果反馈给 C2 服务端。这些结果可能包括：</p><ul><li>执行成功或失败的状态。</li><li>执行过程中的错误信息或输出结果。</li><li>执行时间、命令日志等。</li></ul><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><blockquote><p>后期实现功能清单</p></blockquote><div class='checkbox cyan'><input type="checkbox" />            <p>在客户端、服务端实现自动生成Beacon功能</p>            </div><div class='checkbox cyan'><input type="checkbox" />            <p>重构Beacon代码结构, 使其结构化, 具备自动生成</p>            </div><div class='checkbox cyan'><input type="checkbox" />            <p>服务端、客户端实现创建监听器保存至文件, 运行服务端自动加载并开启监听</p>            </div><div class='checkbox cyan'><input type="checkbox" />            <p>支持更多监听器类型（HTTPS、DNS）</p>            </div>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note &quot;&gt;&lt;p&gt;&lt;strong&gt;DokeyC2&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;已完成第一阶段demo开发, 目前实现了客户端到服务端之间的通信, 向服务端发送命令、获取监听器信息、获取被控端信息、向所有客户端推送信息; 被控端到服务端之间的通信, 向服务端获取命令执行、向服务端发送心跳包保持活跃, 向服务端发送系统信息等&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Windows内核-私有句柄表</title>
    <link href="http://example.com/fa796fb.html"/>
    <id>http://example.com/fa796fb.html</id>
    <published>2024-12-01T14:16:41.000Z</published>
    <updated>2024-12-07T11:52:06.728Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>私有句柄表</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;私有句柄表&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-全局句柄表</title>
    <link href="http://example.com/7943e1e8.html"/>
    <id>http://example.com/7943e1e8.html</id>
    <published>2024-11-21T12:29:57.000Z</published>
    <updated>2024-11-30T15:44:48.168Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>全局句柄表</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="句柄的种类"><a href="#句柄的种类" class="headerlink" title="句柄的种类"></a>句柄的种类</h3><blockquote><p>全局句柄表: 进程、线程句柄;</p></blockquote><blockquote><p>私有句柄表: 进程私有的;</p></blockquote><blockquote><p>窗口句柄</p></blockquote><blockquote><p><code>ObTypeIndexTable</code>: 对象类型数组<br><code>_OBJECT_TYPE</code>: 对象类型 类型<br><code>_HANDLE_TABLE</code>: 句柄表类型</p></blockquote><h3 id="如何通过进程ID在句柄表中找到进程对象"><a href="#如何通过进程ID在句柄表中找到进程对象" class="headerlink" title="如何通过进程ID在句柄表中找到进程对象"></a>如何通过进程ID在句柄表中找到进程对象</h3><blockquote><p>通过<code>OpenPorcess</code>中的参数进程ID（pid, 唯一编号）, 通过pid去全局句柄表中找到对应的进程对象, 然后把进程对象插入到进程的私有句柄表中, 从而返回一个索引号交给三环, 这就是句柄了;</p></blockquote><blockquote><p>进程和线程存在一张表中, 无论进程还是线程中的id都是全局句柄表中的索引号;</p></blockquote><blockquote><p>句柄表的地址不完全是一个地址; 当地址的尾数为0时代表它就是一张表, 默认大小为4096, 每一项为8个字节, 共能存储512项; 当地址尾数为1时代表它是一个目录, 其中共1024项, 每一项指向一张表; 当地址的尾数为2时新创建的表中每一项指向一个目录;</p></blockquote><blockquote><p><code>PspCidTable</code>不导出, 可通过IDA进行定位;</p></blockquote><h4 id="查找Dbgview进程句柄"><a href="#查找Dbgview进程句柄" class="headerlink" title="查找Dbgview进程句柄"></a>查找Dbgview进程句柄</h4><blockquote><p>Dbgview进程ID为600, 在任务管理器中看到的是十进制;</p></blockquote><blockquote><p>第一次查找（行不通）</p></blockquote><ul><li>600 &#x2F; 4 &#x3D; 150 &#x3D;&gt; 150 &#x2F; 512 &#x3D; 0（代表在第一张表中）;</li><li>600 % 512 &#x3D; 88（在表中的索引号）;</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; x nt!Psp*cid*</span><br><span class="line"><span class="number">83f</span>a0d94          nt!PspCidTable = &lt;no type information&gt;</span><br><span class="line">kd&gt; dd PspCidTable</span><br><span class="line"><span class="number">83f</span>a0d94  <span class="number">89201080</span> <span class="number">00000000</span> <span class="number">80000020</span> <span class="number">00000101</span></span><br><span class="line"><span class="number">83f</span>a0da4  <span class="number">800002</span>ac <span class="number">80000024</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0db4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000113</span></span><br><span class="line"><span class="number">83f</span>a0dc4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">83f</span>4e8a4 <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0dd4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000008</span></span><br><span class="line"><span class="number">83f</span>a0de4  <span class="number">00000000</span> <span class="number">83f</span>a0de8 <span class="number">83f</span>a0de8 <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0df4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0e04  <span class="number">00000000</span> <span class="number">807</span>c8c28 <span class="number">807</span>c4c28 <span class="number">00000000</span></span><br><span class="line">kd&gt; dt _HANDLE_TABLE <span class="number">89201080</span></span><br><span class="line">ntdll!_HANDLE_TABLE</span><br><span class="line">   +<span class="number">0x000</span> TableCode        : <span class="number">0x984fb001</span>     <span class="comment">// 代表有两层</span></span><br><span class="line">   +<span class="number">0x004</span> QuotaProcess     : (null)         <span class="comment">// 全局句柄表为null, 私有句柄表表示哪个进程</span></span><br><span class="line">   +<span class="number">0x008</span> UniqueProcessId  : (null)         <span class="comment">// 全局句柄表为null, 私有句柄表表示哪个进程id</span></span><br><span class="line">   +<span class="number">0x00c</span> HandleLock       : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x010</span> HandleTableList  : _LIST_ENTRY [ <span class="number">0x89201090</span> - <span class="number">0x89201090</span> ]</span><br><span class="line">   +<span class="number">0x018</span> HandleContentionEvent : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x01c</span> DebugInfo        : (null) </span><br><span class="line">   +<span class="number">0x020</span> ExtraInfoPages   : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x024</span> Flags            : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x024</span> StrictFIFO       : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x028</span> FirstFreeHandle  : <span class="number">0x324</span></span><br><span class="line">   +<span class="number">0x02c</span> LastFreeHandleEntry : <span class="number">0x89204220</span> _HANDLE_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x030</span> HandleCount      : <span class="number">0x269</span></span><br><span class="line">   +<span class="number">0x034</span> NextHandleNeedingPool : <span class="number">0x1000</span></span><br><span class="line">   +<span class="number">0x038</span> HandleCountHighWatermark : <span class="number">0x2b0</span></span><br><span class="line">kd&gt; dd <span class="number">0x984fb000</span>     <span class="comment">// 取尾数为0这张表</span></span><br><span class="line">ReadVirtual: <span class="number">984f</span>b000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">984f</span>b000  <span class="number">89204000</span> <span class="number">984f</span>c000 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b010  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b020  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b030  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b040  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b050  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b060  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>b070  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>第二次查找</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd PspCidTable</span><br><span class="line"><span class="number">83f</span>a0d94  <span class="number">89201080</span> <span class="number">00000000</span> <span class="number">80000020</span> <span class="number">00000101</span></span><br><span class="line"><span class="number">83f</span>a0da4  <span class="number">800002</span>ac <span class="number">80000024</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0db4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000113</span></span><br><span class="line"><span class="number">83f</span>a0dc4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">83f</span>4e8a4 <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0dd4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000008</span></span><br><span class="line"><span class="number">83f</span>a0de4  <span class="number">00000000</span> <span class="number">83f</span>a0de8 <span class="number">83f</span>a0de8 <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0df4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>a0e04  <span class="number">00000000</span> <span class="number">807</span>c8c28 <span class="number">807</span>c4c28 <span class="number">00000000</span></span><br><span class="line">kd&gt; dt _HANDLE_TABLE <span class="number">89201080</span></span><br><span class="line">ntdll!_HANDLE_TABLE</span><br><span class="line">   +<span class="number">0x000</span> TableCode        : <span class="number">0x984fb001</span></span><br><span class="line">   +<span class="number">0x004</span> QuotaProcess     : (null) </span><br><span class="line">   +<span class="number">0x008</span> UniqueProcessId  : (null) </span><br><span class="line">   +<span class="number">0x00c</span> HandleLock       : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x010</span> HandleTableList  : _LIST_ENTRY [ <span class="number">0x89201090</span> - <span class="number">0x89201090</span> ]</span><br><span class="line">   +<span class="number">0x018</span> HandleContentionEvent : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x01c</span> DebugInfo        : (null) </span><br><span class="line">   +<span class="number">0x020</span> ExtraInfoPages   : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x024</span> Flags            : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x024</span> StrictFIFO       : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x028</span> FirstFreeHandle  : <span class="number">0xa78</span></span><br><span class="line">   +<span class="number">0x02c</span> LastFreeHandleEntry : <span class="number">0x984fca70</span> _HANDLE_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x030</span> HandleCount      : <span class="number">0x27b</span></span><br><span class="line">   +<span class="number">0x034</span> NextHandleNeedingPool : <span class="number">0x1000</span></span><br><span class="line">   +<span class="number">0x038</span> HandleCountHighWatermark : <span class="number">0x2b0</span></span><br><span class="line">kd&gt; dq <span class="number">984f</span>b000+<span class="number">0x3D0</span>*<span class="number">8</span></span><br><span class="line"><span class="number">984f</span>ce80  <span class="number">00000000</span>`<span class="number">85</span>d0e939 <span class="number">00000000</span>`<span class="number">85</span>dd09f1</span><br><span class="line"><span class="number">984f</span>ce90  <span class="number">00000</span>d1c`<span class="number">00000000</span> <span class="number">00000f</span>48`<span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>cea0  <span class="number">00000b</span>b8`<span class="number">00000000</span> <span class="number">00000f</span>f0`<span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>ceb0  <span class="number">00000000</span>`<span class="number">86b</span>7a359 <span class="number">00000</span>d30`<span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>cec0  <span class="number">00000</span>d18`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">86</span>cd2631</span><br><span class="line"><span class="number">984f</span>ced0  <span class="number">00000720</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">86f</span>b3331</span><br><span class="line"><span class="number">984f</span>cee0  <span class="number">00000000</span>`<span class="number">86</span>d0e561 <span class="number">00000730</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">984f</span>cef0  <span class="number">00000</span>adc`<span class="number">00000000</span> <span class="number">00000120</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; dt _EPROCESS <span class="number">00000000</span>`<span class="number">85</span>d0e939</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Pcb              : _KPROCESS</span><br><span class="line">   +<span class="number">0x098</span> ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x0a0</span> CreateTime       : _LARGE_INTEGER <span class="number">0x0001db40</span>`e097dfa6</span><br><span class="line">   +<span class="number">0x0a8</span> ExitTime         : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x0b0</span> RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x0b4</span> UniqueProcessId  : <span class="number">0x7000000f</span> Void</span><br><span class="line">   +<span class="number">0x0b8</span> ActiveProcessLinks : _LIST_ENTRY [ <span class="number">0x7883fa0d</span> - <span class="number">0xdc860192</span> ]</span><br><span class="line">   +<span class="number">0x0c0</span> ProcessQuotaUsage : [<span class="number">2</span>] <span class="number">0x4c000016</span></span><br><span class="line">   +<span class="number">0x0c8</span> ProcessQuotaPeak : [<span class="number">2</span>] <span class="number">0x64000018</span></span><br><span class="line">   +<span class="number">0x0d0</span> CommitCharge     : <span class="number">0x40000001</span></span><br><span class="line">   +<span class="number">0x0d4</span> QuotaBlock       : <span class="number">0x0086a700</span> _EPROCESS_QUOTA_BLOCK</span><br><span class="line">   +<span class="number">0x0d8</span> CpuQuotaBlock    : (null) </span><br><span class="line">   +<span class="number">0x0dc</span> PeakVirtualSize  : <span class="number">0x559a0</span></span><br><span class="line">   +<span class="number">0x0e0</span> VirtualSize      : <span class="number">0x10055800</span></span><br><span class="line">   +<span class="number">0x0e4</span> SessionProcessLinks : _LIST_ENTRY [ <span class="number">0x8c8d64a0</span> - <span class="number">0x85dde8</span> ]</span><br><span class="line">   +<span class="number">0x0ec</span> DebugPort        : <span class="number">0xb0000000</span> Void</span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortData : <span class="number">0x68869e9b</span> Void</span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortValue : <span class="number">0x68869e9b</span></span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortState : <span class="number">0</span>y011</span><br><span class="line">   +<span class="number">0x0f4</span> ObjectTable      : <span class="number">0x37a7c976</span> _HANDLE_TABLE</span><br><span class="line">   +<span class="number">0x0f8</span> Token            : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x0fc</span> WorkingSetPage   : <span class="number">0x2e4</span></span><br><span class="line">   +<span class="number">0x100</span> AddressCreationLock : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x104</span> RotateInProgress : (null) </span><br><span class="line">   +<span class="number">0x108</span> ForkInProgress   : (null) </span><br><span class="line">   +<span class="number">0x10c</span> HardwareTrigger  : <span class="number">0x18000000</span></span><br><span class="line">   +<span class="number">0x110</span> PhysicalVadRoot  : <span class="number">0x0086df05</span> _MM_AVL_TABLE</span><br><span class="line">   +<span class="number">0x114</span> CloneRoot        : <span class="number">0x8b000000</span> Void</span><br><span class="line">   +<span class="number">0x118</span> NumberOfPrivatePages : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x11c</span> NumberOfLockedPages : <span class="number">0xc0000000</span></span><br><span class="line">   +<span class="number">0x120</span> Win32Process     : <span class="number">0xc0ffa2db</span> Void</span><br><span class="line">   +<span class="number">0x124</span> Job              : <span class="number">0xa885cc24</span> _EJOB</span><br><span class="line">   +<span class="number">0x128</span> SectionObject    : <span class="number">0x00ab5b01</span> Void</span><br><span class="line">   +<span class="number">0x12c</span> SectionBaseAddress : <span class="number">0x7b00c300</span> Void</span><br><span class="line">   +<span class="number">0x130</span> Cookie           : <span class="number">0x2b0cf7</span></span><br><span class="line">   +<span class="number">0x134</span> Spare8           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x138</span> WorkingSetWatch  : <span class="number">0x40000000</span> _PAGEFAULT_HISTORY</span><br><span class="line">   +<span class="number">0x13c</span> Win32WindowStation : <span class="number">0xac000000</span> Void</span><br><span class="line">   +<span class="number">0x140</span> InheritedFromUniqueProcessId : <span class="number">0x00000009</span> Void</span><br><span class="line">   +<span class="number">0x144</span> LdtInformation   : (null) </span><br><span class="line">   +<span class="number">0x148</span> VdmObjects       : (null) </span><br><span class="line">   +<span class="number">0x14c</span> ConsoleHostProcess : <span class="number">0xe0000000</span></span><br><span class="line">   +<span class="number">0x150</span> DeviceMap        : <span class="number">0x008ee2f1</span> Void</span><br><span class="line">   +<span class="number">0x154</span> EtwDataSource    : (null) </span><br><span class="line">   +<span class="number">0x158</span> FreeTebHint      : <span class="number">0x007ffdd0</span> Void</span><br><span class="line">   +<span class="number">0x160</span> PageDirectoryPte : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x168</span> Session          : <span class="number">0x448d64a0</span> Void</span><br><span class="line">   +<span class="number">0x16c</span> ImageFileName    : [<span class="number">15</span>]  <span class="string">&quot;bgview.exe&quot;</span></span><br></pre></td></tr></table></figure><h4 id="判断是进程还是线程（失败）"><a href="#判断是进程还是线程（失败）" class="headerlink" title="判断是进程还是线程（失败）"></a>判断是进程还是线程（失败）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_HEADER <span class="number">00000000</span>`<span class="number">85</span>d0e930<span class="number">-0x18</span></span><br><span class="line">nt!_OBJECT_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PointerCount     : <span class="number">0</span>n108</span><br><span class="line">   +<span class="number">0x004</span> HandleCount      : <span class="number">0</span>n<span class="number">-2080816192</span></span><br><span class="line">   +<span class="number">0x004</span> NextToFree       : <span class="number">0x83f943c0</span> Void</span><br><span class="line">   +<span class="number">0x008</span> Lock             : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x00c</span> TypeIndex        : <span class="number">0x4</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x00d TraceFlags       : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x00e</span> InfoMask         : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x00f Flags            : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x010</span> ObjectCreateInfo : (null) </span><br><span class="line">   +<span class="number">0x010</span> QuotaBlockCharged : (null) </span><br><span class="line">   +<span class="number">0x014</span> SecurityDescriptor : <span class="number">0x00080007</span> Void</span><br><span class="line">   +<span class="number">0x018</span> Body             : _QUAD</span><br><span class="line">kd&gt; dd ObTypeIndexTable+<span class="number">0x4</span>*<span class="number">4</span></span><br><span class="line"><span class="number">83f</span>a2770  <span class="number">85533638</span> <span class="number">855</span>c2040 <span class="number">855</span>c2f40 <span class="number">855</span>c2e78</span><br><span class="line"><span class="number">83f</span>a2780  <span class="number">855</span>c2db0 <span class="number">855</span>c2ce8 <span class="number">855</span>c2c20 <span class="number">855</span>c2548</span><br><span class="line"><span class="number">83f</span>a2790  <span class="number">855</span>ddb50 <span class="number">855</span>d6418 <span class="number">855</span>d6350 <span class="number">855</span>d7418</span><br><span class="line"><span class="number">83f</span>a27a0  <span class="number">855</span>d7350 <span class="number">855</span>d8418 <span class="number">855</span>d8350 <span class="number">855e1758</span></span><br><span class="line"><span class="number">83f</span>a27b0  <span class="number">855e1690</span> <span class="number">855e1</span>da0 <span class="number">855e1</span>cd8 <span class="number">855e1388</span></span><br><span class="line"><span class="number">83f</span>a27c0  <span class="number">855e12</span>c0 <span class="number">855e5930</span> <span class="number">855e5868</span> <span class="number">855</span>daf78</span><br><span class="line"><span class="number">83f</span>a27d0  <span class="number">855</span>daeb0 <span class="number">855</span>da950 <span class="number">855</span>da888 <span class="number">855</span>da7c0</span><br><span class="line"><span class="number">83f</span>a27e0  <span class="number">855</span>da6f8 <span class="number">855</span>da528 <span class="number">855</span>da460 <span class="number">855</span>df7f0</span><br><span class="line">kd&gt; dt _OBJECT_TYPE <span class="number">85533638</span></span><br><span class="line">ntdll!_OBJECT_TYPE</span><br><span class="line">   +<span class="number">0x000</span> TypeList         : _LIST_ENTRY [ <span class="number">0x85533638</span> - <span class="number">0x85533638</span> ]</span><br><span class="line">   +<span class="number">0x008</span> Name             : _UNICODE_STRING <span class="string">&quot;SymbolicLink&quot;</span></span><br><span class="line">   +<span class="number">0x010</span> DefaultObject    : <span class="number">0x83fa1a40</span> Void</span><br><span class="line">   +<span class="number">0x014</span> Index            : <span class="number">0x4</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x018 TotalNumberOfObjects : 0x121</span></span><br><span class="line"><span class="string">   +0x01c TotalNumberOfHandles : 5</span></span><br><span class="line"><span class="string">   +0x020 HighWaterNumberOfObjects : 0x121</span></span><br><span class="line"><span class="string">   +0x024 HighWaterNumberOfHandles : 6</span></span><br><span class="line"><span class="string">   +0x028 TypeInfo         : _OBJECT_TYPE_INITIALIZER</span></span><br><span class="line"><span class="string">   +0x078 TypeLock         : _EX_PUSH_LOCK</span></span><br><span class="line"><span class="string">   +0x07c Key              : 0x626d7953</span></span><br><span class="line"><span class="string">   +0x080 CallbackList     : _LIST_ENTRY [ 0x855336b8 - 0x855336b8 ]</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="保护进程"><a href="#保护进程" class="headerlink" title="保护进程"></a>保护进程</h3><h4 id="PsLookupProcessByProcessId"><a href="#PsLookupProcessByProcessId" class="headerlink" title="PsLookupProcessByProcessId"></a>PsLookupProcessByProcessId</h4><blockquote><p><code>PsLookupProcessByProcessId</code>如何遍历进程; </p></blockquote><p>调用链: PsLookupProcessByProcessId &#x3D;&gt; ExMapHandleToPointer &#x3D;&gt; ExpLookupHandleTableEntry</p><h4 id="蓝屏错误分析"><a href="#蓝屏错误分析" class="headerlink" title="蓝屏错误分析"></a>蓝屏错误分析</h4><blockquote><p>在保护进程后, 如果不把进程pid设置为0会导致蓝屏;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; kv</span><br><span class="line"> # ChildEBP RetAddr      Args to Child              </span><br><span class="line"><span class="number">00</span> <span class="number">8</span>d45f6f4 <span class="number">83f</span>27407     <span class="number">00000003</span> <span class="number">7</span>a0c3854 <span class="number">00000065</span> nt!<span class="built_in">RtlpBreakWithStatusInstruction</span> (FPO: [<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>])</span><br><span class="line"><span class="number">01</span> <span class="number">8</span>d45f744 <span class="number">83f</span>27f04     <span class="number">00000003</span> <span class="number">857</span>ced20 <span class="number">00000000</span> nt!KiBugCheckDebugBreak+<span class="number">0x1c</span></span><br><span class="line"><span class="number">02</span> <span class="number">8</span>d45fb0c <span class="number">83f</span>2727b     <span class="number">00000017</span> <span class="number">00000000</span> <span class="number">00000000</span> nt!KeBugCheck2+<span class="number">0x68a</span></span><br><span class="line"><span class="number">03</span> <span class="number">8</span>d45fb2c <span class="number">840</span>c6ca2     <span class="number">00000017</span> <span class="number">855</span>d5eb0 <span class="number">857</span>ced08 nt!KeBugCheck+<span class="number">0x14</span></span><br><span class="line"><span class="number">04</span> <span class="number">8</span>d45fb64 <span class="number">84074b</span>30     <span class="number">857</span>ced20 <span class="number">857</span>ced20 <span class="number">857</span>ced08 nt!PspProcessDelete+<span class="number">0x185</span>         <span class="comment">// 此函数会进行判断然后调用ExDestroyHandle函数导致蓝屏</span></span><br><span class="line"><span class="number">05</span> <span class="number">8</span>d45fb7c <span class="number">83</span>eaa1e0     <span class="number">00000000</span> <span class="number">00000f</span>08 <span class="number">857</span>ced08 nt!ObpRemoveObjectRoutine+<span class="number">0x59</span></span><br><span class="line"><span class="number">06</span> <span class="number">8</span>d45fb90 <span class="number">83</span>eaa150     <span class="number">857</span>ced20 <span class="number">84097</span>eb1 <span class="number">99901950</span> nt!ObfDereferenceObjectWithTag+<span class="number">0x88</span> (FPO: [<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>])</span><br><span class="line"><span class="number">07</span> <span class="number">8</span>d45fb98 <span class="number">84097</span>eb1     <span class="number">99901950</span> <span class="number">86b</span>11778 <span class="number">00000f</span>08 nt!ObfDereferenceObject+<span class="number">0xd</span> (FPO: [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line"><span class="number">08</span> <span class="number">8</span>d45fbdc <span class="number">84097b</span>c5     <span class="number">99901950</span> <span class="number">97f</span>fbe10 <span class="number">86</span>a3fd20 nt!ObpCloseHandleTableEntry+<span class="number">0x22f</span></span><br><span class="line"><span class="number">09</span> <span class="number">8</span>d45fc0c <span class="number">84097f</span>71     <span class="number">86</span>a3fd20 <span class="number">86b</span>11701 <span class="number">00</span>c3f7e8 nt!ObpCloseHandle+<span class="number">0x7f</span></span><br><span class="line"><span class="number">0</span>a <span class="number">8</span>d45fc28 <span class="number">83e84</span>a3a     <span class="number">00000f</span>08 <span class="number">00</span>c3f7ec <span class="number">76e66</span>b94 nt!NtClose+<span class="number">0x4e</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PspProcessDelete函数中导致蓝屏代码处</span></span><br><span class="line">...</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)&amp;PROCESS[<span class="number">1</span>].LdtDescriptor.LimitLow</span><br><span class="line">    &amp;&amp; !<span class="built_in">ExDestroyHandle</span>(<span class="number">0</span>, (<span class="type">int</span> *)PspCidTable, *(_DWORD *)&amp;PROCESS[<span class="number">1</span>].LdtDescriptor.LimitLow) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">KeBugCheck</span>(<span class="number">0x17</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="利用小漏洞"><a href="#利用小漏洞" class="headerlink" title="利用小漏洞"></a>利用小漏洞</h4><blockquote><p><code>ExpLookupHandleTableEntry</code>函数中存在判断如果pid &amp; 0xFFFFFFFC &gt;&#x3D; this[13];</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExpLookupHandleTableEntry函数中判断处</span></span><br><span class="line">  <span class="keyword">if</span> ( (a2 &amp; <span class="number">0xFFFFFFFC</span>) &gt;= <span class="keyword">this</span>[<span class="number">13</span>] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><blockquote><p><code>ProcessProtection.h</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PVOID GetPspCidTable();</span></span><br><span class="line"><span class="comment">// ULONG_PTR GetExpLookupHandleTableEntry();</span></span><br><span class="line"></span><br><span class="line"><span class="function">PVOID <span class="title">MyExpLookupHandleTableEntry</span><span class="params">(HANDLE pid)</span></span>;</span><br><span class="line"><span class="comment">// 保护进程</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">ProcessProtection</span><span class="params">(HANDLE pid)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><code>Search.h</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FindCode</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR code[<span class="number">0x200</span>];</span><br><span class="line">ULONG len;</span><br><span class="line"><span class="type">int</span> offset;</span><br><span class="line">ULONG lastAddressOffset;</span><br><span class="line">&#125;FindCode, *PFindCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">SystemBasicInformation,</span><br><span class="line">SystemProcessorInformation,             <span class="comment">// obsolete...delete</span></span><br><span class="line">SystemPerformanceInformation,</span><br><span class="line">SystemTimeOfDayInformation,</span><br><span class="line">SystemPathInformation,</span><br><span class="line">SystemProcessInformation,</span><br><span class="line">SystemCallCountInformation,</span><br><span class="line">SystemDeviceInformation,</span><br><span class="line">SystemProcessorPerformanceInformation,</span><br><span class="line">SystemFlagsInformation,</span><br><span class="line">SystemCallTimeInformation,</span><br><span class="line">SystemModuleInformation,</span><br><span class="line">SystemLocksInformation,</span><br><span class="line">SystemStackTraceInformation,</span><br><span class="line">SystemPagedPoolInformation,</span><br><span class="line">SystemNonPagedPoolInformation,</span><br><span class="line">SystemHandleInformation,</span><br><span class="line">SystemObjectInformation,</span><br><span class="line">SystemPageFileInformation,</span><br><span class="line">SystemVdmInstemulInformation,</span><br><span class="line">SystemVdmBopInformation,</span><br><span class="line">SystemFileCacheInformation,</span><br><span class="line">SystemPoolTagInformation,</span><br><span class="line">SystemInterruptInformation,</span><br><span class="line">SystemDpcBehaviorInformation,</span><br><span class="line">SystemFullMemoryInformation,</span><br><span class="line">SystemLoadGdiDriverInformation,</span><br><span class="line">SystemUnloadGdiDriverInformation,</span><br><span class="line">SystemTimeAdjustmentInformation,</span><br><span class="line">SystemSummaryMemoryInformation,</span><br><span class="line">SystemMirrorMemoryInformation,</span><br><span class="line">SystemPerformanceTraceInformation,</span><br><span class="line">SystemObsolete0,</span><br><span class="line">SystemExceptionInformation,</span><br><span class="line">SystemCrashDumpStateInformation,</span><br><span class="line">SystemKernelDebuggerInformation,</span><br><span class="line">SystemContextSwitchInformation,</span><br><span class="line">SystemRegistryQuotaInformation,</span><br><span class="line">SystemExtendServiceTableInformation,</span><br><span class="line">SystemPrioritySeperation,</span><br><span class="line">SystemVerifierAddDriverInformation,</span><br><span class="line">SystemVerifierRemoveDriverInformation,</span><br><span class="line">SystemProcessorIdleInformation,</span><br><span class="line">SystemLegacyDriverInformation,</span><br><span class="line">SystemCurrentTimeZoneInformation,</span><br><span class="line">SystemLookasideInformation,</span><br><span class="line">SystemTimeSlipNotification,</span><br><span class="line">SystemSessionCreate,</span><br><span class="line">SystemSessionDetach,</span><br><span class="line">SystemSessionInformation,</span><br><span class="line">SystemRangeStartInformation,</span><br><span class="line">SystemVerifierInformation,</span><br><span class="line">SystemVerifierThunkExtend,</span><br><span class="line">SystemSessionProcessInformation,</span><br><span class="line">SystemLoadGdiDriverInSystemSpace,</span><br><span class="line">SystemNumaProcessorMap,</span><br><span class="line">SystemPrefetcherInformation,</span><br><span class="line">SystemExtendedProcessInformation,</span><br><span class="line">SystemRecommendedSharedDataAlignment,</span><br><span class="line">SystemComPlusPackage,</span><br><span class="line">SystemNumaAvailableMemory,</span><br><span class="line">SystemProcessorPowerInformation,</span><br><span class="line">SystemEmulationBasicInformation,</span><br><span class="line">SystemEmulationProcessorInformation,</span><br><span class="line">SystemExtendedHandleInformation,</span><br><span class="line">SystemLostDelayedWriteInformation,</span><br><span class="line">SystemBigPoolInformation,</span><br><span class="line">SystemSessionPoolTagInformation,</span><br><span class="line">SystemSessionMappedViewInformation,</span><br><span class="line">SystemHotpatchInformation,</span><br><span class="line">SystemObjectSecurityMode,</span><br><span class="line">SystemWatchdogTimerHandler,</span><br><span class="line">SystemWatchdogTimerInformation,</span><br><span class="line">SystemLogicalProcessorInformation,</span><br><span class="line">SystemWow64SharedInformation,</span><br><span class="line">SystemRegisterFirmwareTableInformationHandler,</span><br><span class="line">SystemFirmwareTableInformation,</span><br><span class="line">SystemModuleInformationEx,</span><br><span class="line">SystemVerifierTriageInformation,</span><br><span class="line">SystemSuperfetchInformation,</span><br><span class="line">SystemMemoryListInformation,</span><br><span class="line">SystemFileCacheInformationEx,</span><br><span class="line">MaxSystemInfoClass  <span class="comment">// MaxSystemInfoClass should always be the last enum</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_RTL_PROCESS_MODULE_INFORMATION</span> &#123;</span><br><span class="line">HANDLE Section;                 <span class="comment">// Not filled in</span></span><br><span class="line">PVOID MappedBase;</span><br><span class="line">PVOID ImageBase;</span><br><span class="line">ULONG ImageSize;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadOrderIndex;</span><br><span class="line">USHORT InitOrderIndex;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT OffsetToFileName;</span><br><span class="line">UCHAR  FullPathName[<span class="number">256</span>];</span><br><span class="line">&#125; RTL_PROCESS_MODULE_INFORMATION, *PRTL_PROCESS_MODULE_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_RTL_PROCESS_MODULES</span> &#123;</span><br><span class="line">ULONG NumberOfModules;</span><br><span class="line">RTL_PROCESS_MODULE_INFORMATION Modules[<span class="number">1</span>];</span><br><span class="line">&#125; RTL_PROCESS_MODULES, *PRTL_PROCESS_MODULES;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">ZwQuerySystemInformation</span><span class="params">(SYSTEM_INFORMATION_CLASS SystemInformationClass, PVOID SystemInformation, ULONG SystemInformationLength, PULONG ReturnLength)</span></span>;</span><br><span class="line"><span class="function">ULONG <span class="title">searchOtherCode</span><span class="params">(ULONG_PTR startAddr, ULONG_PTR endAddr, <span class="type">char</span>* code, <span class="type">int</span> offset)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p><code>ProcessProtection.c</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ProcessProtection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Search.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">PVOID <span class="title">GetPspCidTable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">static</span> PVOID scidTable = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (scidTable) <span class="keyword">return</span> scidTable;</span><br><span class="line"></span><br><span class="line">UNICODE_STRING unName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;unName, <span class="string">L&quot;PsLookupProcessByProcessId&quot;</span>);</span><br><span class="line">PUCHAR startFunc = <span class="built_in">MmGetSystemRoutineAddress</span>(&amp;unName);</span><br><span class="line"></span><br><span class="line">scidTable = (PVOID)<span class="built_in">searchOtherCode</span>(startFunc, startFunc + <span class="number">0x100</span>, <span class="string">&quot;8B*****E8****8BF885FF74*8B1F&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (scidTable)</span><br><span class="line">&#123;</span><br><span class="line">scidTable = **(PVOID ***)scidTable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> scidTable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">GetExpLookupHandleTableEntry</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">static</span> PVOID ExpLookupHandleTableEntry = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (ExpLookupHandleTableEntry) <span class="keyword">return</span> ExpLookupHandleTableEntry;</span><br><span class="line"></span><br><span class="line">UNICODE_STRING unName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;unName, <span class="string">L&quot;ExEnumHandleTable&quot;</span>);</span><br><span class="line">PUCHAR startFunc = <span class="built_in">MmGetSystemRoutineAddress</span>(&amp;unName);</span><br><span class="line"></span><br><span class="line">PUCHAR searchFunc = (PVOID)<span class="built_in">searchOtherCode</span>(startFunc, startFunc + <span class="number">0x200</span>, <span class="string">&quot;FF75*8B4D*E8****8BF085F675*EB&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (searchFunc)</span><br><span class="line">&#123;</span><br><span class="line">ExpLookupHandleTableEntry = (searchFunc + <span class="number">5</span>) + *(PULONG)(searchFunc + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ExpLookupHandleTableEntry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PVOID <span class="title">MyExpLookupHandleTableEntry</span><span class="params">(HANDLE pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// handleTable参数压栈至ecx, xxx压栈到edx, id参数push到栈上, 模拟__thiscall</span></span><br><span class="line"><span class="comment">// x64 不需要这样来定义调用堆栈, 原函数并非3个参数, 原为2个参数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span> <span class="params">(__fastcall * ExpLookupHandleTableEntryProc)</span><span class="params">(PVOID handleTable, ULONG xxx, HANDLE id)</span></span>;</span><br><span class="line">PVOID pspTable = <span class="built_in">GetPspCidTable</span>();</span><br><span class="line">ExpLookupHandleTableEntryProc func = (ExpLookupHandleTableEntryProc)<span class="built_in">GetExpLookupHandleTableEntry</span>();</span><br><span class="line"><span class="keyword">if</span> (!pspTable || !func) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">func</span>(pspTable, <span class="number">0</span>, pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG <span class="title">GetProcessIdOffset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">UNICODE_STRING unName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;unName, <span class="string">L&quot;PsGetProcessId&quot;</span>);</span><br><span class="line">PUCHAR startFunc = <span class="built_in">MmGetSystemRoutineAddress</span>(&amp;unName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> *(PULONG)(startFunc + <span class="number">11</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">ProcessProtection</span><span class="params">(HANDLE pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PEPROCESS Process = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsLookupProcessByProcessId</span>(pid, &amp;Process);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(Process);</span><br><span class="line"></span><br><span class="line">PVOID pHandleEntry = <span class="built_in">MyExpLookupHandleTableEntry</span>(pid);</span><br><span class="line"><span class="comment">// 抹除相关信息（_HANDLE_TABLE_ENTRY）</span></span><br><span class="line"><span class="built_in">memset</span>(pHandleEntry, <span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line"><span class="comment">// ULONG offset = GetProcessIdOffset();</span></span><br><span class="line">*(PHANDLE)((PUCHAR)Process + <span class="number">0xb4</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>Search.c</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Search.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntimage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将字节转换成16进制</span></span><br><span class="line"><span class="function">UCHAR <span class="title">Char2Hex</span><span class="params">(UCHAR * szCh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> temp[<span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (szCh[i] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; szCh[i] &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = (szCh[i] - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (szCh[i] &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; szCh[i] &lt;= <span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = (szCh[i] - <span class="string">&#x27;A&#x27;</span>) + <span class="number">0xA</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (szCh[i] &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; szCh[i] &lt;= <span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = (szCh[i] - <span class="string">&#x27;a&#x27;</span>) + <span class="number">0xA</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ((temp[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xf0</span>) | (temp[<span class="number">1</span>] &amp; <span class="number">0xf</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化结构</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initFindCodeStruct</span><span class="params">(PFindCode findCode, PCHAR code, ULONG_PTR offset, ULONG_PTR lastAddressOffset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">memset</span>(findCode, <span class="number">0</span>, <span class="built_in">sizeof</span>(FindCode));</span><br><span class="line"></span><br><span class="line">findCode-&gt;lastAddressOffset = lastAddressOffset;</span><br><span class="line">findCode-&gt;offset = offset;</span><br><span class="line"></span><br><span class="line">PCHAR pTemp = code;</span><br><span class="line">ULONG_PTR i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; *pTemp != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (*pTemp == <span class="string">&#x27;*&#x27;</span> || *pTemp == <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">findCode-&gt;code[i] = *pTemp;</span><br><span class="line">pTemp++;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">findCode-&gt;code[i] = <span class="built_in">Char2Hex</span>(pTemp);</span><br><span class="line">pTemp += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">findCode-&gt;len = i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">findAddressByCode</span><span class="params">(ULONG_PTR beginAddr, ULONG_PTR endAddr, PFindCode findCode, ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ULONG64 j = <span class="number">0</span>;</span><br><span class="line">LARGE_INTEGER rtna = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (ULONG_PTR i = beginAddr; i &lt;= endAddr; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">MmIsAddressValid</span>((PVOID)i))</span><br><span class="line">&#123;</span><br><span class="line">i = i &amp; (~<span class="number">0xfff</span>) + PAGE_SIZE - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; size; j++)</span><br><span class="line">&#123;</span><br><span class="line">FindCode fc = findCode[j];</span><br><span class="line">ULONG_PTR tempAddress = i;</span><br><span class="line"></span><br><span class="line">UCHAR * code = (UCHAR *)(tempAddress + fc.offset);</span><br><span class="line">BOOLEAN isFlags = FALSE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ULONG_PTR k = <span class="number">0</span>; k &lt; fc.len; k++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">MmIsAddressValid</span>((PVOID)(code + k)))</span><br><span class="line">&#123;</span><br><span class="line">isFlags = TRUE;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (fc.code[k] == <span class="string">&#x27;*&#x27;</span> || fc.code[k] == <span class="string">&#x27;?&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (code[k] != fc.code[k])</span><br><span class="line">&#123;</span><br><span class="line">isFlags = TRUE;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isFlags) <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (j == size)</span><br><span class="line">&#123;</span><br><span class="line">rtna.QuadPart = i;</span><br><span class="line">rtna.LowPart += findCode[<span class="number">0</span>].lastAddressOffset;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rtna.QuadPart;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ULONG_PTR findAddressByCode(ULONG_PTR beginAddr, ULONG_PTR endAddr, PFindCode  findCode, ULONG numbers)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//ULONG64 j = 0;</span></span><br><span class="line"><span class="comment">//LARGE_INTEGER rtna = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//for (ULONG_PTR i = beginAddr; i &lt;= endAddr; i++)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//if (!MmIsAddressValid((PVOID)i))</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//i = i &amp; (~0xfff) + PAGE_SIZE - 1;</span></span><br><span class="line"><span class="comment">//continue;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//for (j = 0; j &lt; numbers; j++)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//FindCode  fc = findCode[j];</span></span><br><span class="line"><span class="comment">//ULONG_PTR tempAddress = i;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//UCHAR * code = (UCHAR *)(tempAddress + fc.offset);</span></span><br><span class="line"><span class="comment">//BOOLEAN isFlags = FALSE;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//for (ULONG_PTR k = 0; k &lt; fc.len; k++)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//if (!MmIsAddressValid((PVOID)(code + k)))</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//isFlags = TRUE;</span></span><br><span class="line"><span class="comment">//break;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//if (fc.code[k] == &#x27;*&#x27; || fc.code[k] == &#x27;?&#x27;) continue;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//if (code[k] != fc.code[k])</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//isFlags = TRUE;</span></span><br><span class="line"><span class="comment">//break;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//if (isFlags) break;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////找到了</span></span><br><span class="line"><span class="comment">//if (j == numbers)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//rtna.QuadPart = i;</span></span><br><span class="line"><span class="comment">//rtna.LowPart += findCode[0].lastAddressOffset;</span></span><br><span class="line"><span class="comment">//break;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//return rtna.QuadPart;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> * <span class="title">Char2Uper</span><span class="params">(<span class="type">char</span> * wstr, BOOLEAN isAllocateMemory)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> * ret = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isAllocateMemory)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> len = <span class="built_in">strlen</span>(wstr) + <span class="number">2</span>;</span><br><span class="line">ret = <span class="built_in">ExAllocatePool</span>(PagedPool, len);</span><br><span class="line"><span class="built_in">memset</span>(ret, <span class="number">0</span>, len);</span><br><span class="line"><span class="built_in">memcpy</span>(ret, wstr, len - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">ret = wstr;</span><br><span class="line">&#125;</span><br><span class="line">_strupr(ret);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">QueryModule</span><span class="params">(PUCHAR pModuleName, ULONG_PTR * pModuleSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (pModuleName == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">RTL_PROCESS_MODULES RtlModules = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">PRTL_PROCESS_MODULES pRtlModules = &amp;RtlModules;</span><br><span class="line">BOOLEAN bFlags = FALSE;</span><br><span class="line"><span class="comment">// 测量长度</span></span><br><span class="line">ULONG * ReturnLength = <span class="number">0</span>;<span class="comment">// 需要申请内存的实际大小</span></span><br><span class="line">NTSTATUS status = <span class="built_in">ZwQuerySystemInformation</span>(SystemModuleInformation, pRtlModules, <span class="built_in">sizeof</span>(RTL_PROCESS_MODULES), &amp;ReturnLength);</span><br><span class="line"><span class="comment">// 判断长度不匹配</span></span><br><span class="line"><span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH)</span><br><span class="line">&#123;</span><br><span class="line">pRtlModules = <span class="built_in">ExAllocatePool</span>(PagedPool, ReturnLength + <span class="built_in">sizeof</span>(RTL_PROCESS_MODULES));</span><br><span class="line"><span class="keyword">if</span> (!pRtlModules) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">memset</span>(pRtlModules, <span class="number">0</span>, ReturnLength + <span class="built_in">sizeof</span>(RTL_PROCESS_MODULES));</span><br><span class="line">status = <span class="built_in">ZwQuerySystemInformation</span>(SystemModuleInformation, pRtlModules, ReturnLength + <span class="built_in">sizeof</span>(RTL_PROCESS_MODULES), &amp;ReturnLength);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ExFreePool</span>(pRtlModules);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">bFlags = TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUCHAR pKernelModuleName = <span class="literal">NULL</span>;</span><br><span class="line">ULONG_PTR pModuleBase = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (_stricmp(pModuleName, <span class="string">&quot;ntkrnlpa.exe&quot;</span>) == <span class="number">0</span> || _stricmp(pModuleName, <span class="string">&quot;ntoskrnl.exe&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">PRTL_PROCESS_MODULE_INFORMATION pModuleInformation = &amp;pRtlModules-&gt;Modules[<span class="number">0</span>];</span><br><span class="line">pModuleBase = pModuleInformation-&gt;ImageBase;</span><br><span class="line"><span class="keyword">if</span> (pModuleSize) *pModuleSize = pModuleInformation-&gt;ImageSize;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pKernelModuleName = <span class="built_in">ExAllocatePool</span>(PagedPool, <span class="built_in">strlen</span>(pModuleName) + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memset</span>(pKernelModuleName, <span class="number">0</span>, <span class="built_in">strlen</span>(pModuleName) + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(pKernelModuleName, pModuleName, <span class="built_in">strlen</span>(pModuleName));</span><br><span class="line">_strupr(pKernelModuleName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pRtlModules-&gt;NumberOfModules; i++)</span><br><span class="line">&#123;</span><br><span class="line">PRTL_PROCESS_MODULE_INFORMATION pModuleInformation = &amp;pRtlModules-&gt;Modules[i];</span><br><span class="line">PUCHAR FullPathName = _strupr(pModuleInformation-&gt;FullPathName);</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;BaseName = %s, FullName = %s\r\n&quot;</span>, pModuleInformation-&gt;FullPathName + pModuleInformation-&gt;OffsetToFileName, pModuleInformation-&gt;FullPathName);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(FullPathName, pKernelModuleName))</span><br><span class="line">&#123;</span><br><span class="line">pModuleBase = pModuleInformation-&gt;ImageBase;</span><br><span class="line"><span class="keyword">if</span> (pModuleSize) *pModuleSize = pModuleInformation-&gt;ImageSize;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pKernelModuleName)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ExFreePool</span>(pKernelModuleName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bFlags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ExFreePool</span>(pRtlModules);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pModuleBase;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//ULONG searchOtherCode(ULONG_PTR startAddr, ULONG_PTR endAddr, char* code, int offset)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//FindCode fc[1] = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">//initFindCodeStruct(&amp;fc[0], code, 0, offset);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////SIZE_T moduleBase = 0;</span></span><br><span class="line"><span class="comment">////ULONG size = QueryModule(&quot;ntoskrnl.exe&quot;, &amp;moduleBase);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//ULONG_PTR func = findAddressByCode(startAddr, endAddr, fc, 1);</span></span><br><span class="line"><span class="comment">//return func;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function">ULONG <span class="title">searchOtherCode</span><span class="params">(ULONG_PTR startAdd, ULONG_PTR endAddr, <span class="type">char</span> * code, <span class="type">int</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FindCode fs[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">initFindCodeStruct</span>(&amp;fs[<span class="number">0</span>], code, <span class="number">0</span>, offset);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ULONG_PTR func = <span class="built_in">findAddressByCode</span>(startAdd, endAddr, fs, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG <span class="title">searchNtCode</span><span class="params">(<span class="type">char</span>* code, <span class="type">int</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FindCode fc[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">initFindCodeStruct</span>(&amp;fc[<span class="number">0</span>], code, <span class="number">0</span>, offset);</span><br><span class="line"></span><br><span class="line">SIZE_T moduleBase = <span class="number">0</span>;</span><br><span class="line">ULONG size = <span class="built_in">QueryModule</span>(<span class="string">&quot;ntoskrnl.exe&quot;</span>, &amp;moduleBase);</span><br><span class="line"></span><br><span class="line">ULONG_PTR func = <span class="built_in">findAddressByCode</span>(moduleBase, size + moduleBase, fc, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG <span class="title">searchCode</span><span class="params">(<span class="type">char</span> * moduleName, <span class="type">char</span>* segmentName, <span class="type">char</span>* code, <span class="type">int</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FindCode fc[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">initFindCodeStruct</span>(&amp;fc[<span class="number">0</span>], code, <span class="number">0</span>, offset);</span><br><span class="line"></span><br><span class="line">SIZE_T moduleBase = <span class="number">0</span>;</span><br><span class="line">ULONG size = <span class="built_in">QueryModule</span>(moduleName, &amp;moduleBase);</span><br><span class="line"><span class="keyword">if</span> (!moduleBase)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)moduleBase;</span><br><span class="line">PIMAGE_NT_HEADERS pNts = (PIMAGE_NT_HEADERS)(moduleBase + pDos-&gt;e_lfanew);</span><br><span class="line">PIMAGE_SECTION_HEADER pSection = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNts);</span><br><span class="line">PIMAGE_SECTION_HEADER pTemp = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pNts-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> bufName[<span class="number">9</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">memcpy</span>(bufName, pSection-&gt;Name, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">if</span> (_stricmp(bufName, segmentName) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">pTemp = pSection;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">pSection++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pTemp)</span><br><span class="line">&#123;</span><br><span class="line">moduleBase = pSection-&gt;VirtualAddress + moduleBase;</span><br><span class="line">size = pSection-&gt;SizeOfRawData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ULONG_PTR func = <span class="built_in">findAddressByCode</span>(moduleBase, size + moduleBase, fc, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>DriverEntry.c</code></p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ProcessProtection.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: DriverUnload Running\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: DriverEntry Running\r\n&quot;</span>);</span><br><span class="line"><span class="comment">/*PVOID pspTable = GetPspCidTable();</span></span><br><span class="line"><span class="comment">ULONG_PTR funcAddr = GetExpLookupHandleTableEntry();</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;[db]: %x, %x\r\n&quot;, pspTable, funcAddr);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PVOID pHandleEntry = MyExpLookupHandleTableEntry((HANDLE)3140);</span></span><br><span class="line"><span class="comment">// DbgPrintEx(77, 0, &quot;[db]: %x\r\n&quot;, pHandleEntry);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ProcessProtection</span>((HANDLE)<span class="number">2932</span>);</span><br><span class="line"></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>vm3dmp.sys</code>会导致蓝屏, 可摘除钩子</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;全局句柄表&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-线程</title>
    <link href="http://example.com/2776887d.html"/>
    <id>http://example.com/2776887d.html</id>
    <published>2024-11-17T14:56:33.000Z</published>
    <updated>2024-11-19T05:43:06.756Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>线程</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="线程执行的必要条件"><a href="#线程执行的必要条件" class="headerlink" title="线程执行的必要条件"></a>线程执行的必要条件</h3><blockquote><p>线程需要什么才能执行</p></blockquote><ol><li>必须有<code>CR3</code>指向的内存, 线程一定绑定在某个进程上;</li><li>如果是内核线程, 只有一个堆栈; <code>PsCreateSystemThread</code>如果不指定进程的情况下, 一定是system进程; 如果是普通的R3线程<code>CreateThread</code>, 会有两个堆栈（系统调用时会存在R3堆栈和R0堆栈）;普通线程是区分R0、R3的上下文环境的</li></ol><blockquote><p>R0下的上下文环境是<code>Ktrap_frame</code>（其中之一）;<br>R3下的上下文环境描述是<code>TEB</code>, R0下上下文环境描述是<code>E/KTHREAD</code>;</p></blockquote><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><h4 id="KTHREAD"><a href="#KTHREAD" class="headerlink" title="KTHREAD"></a>KTHREAD</h4><h5 id="内核态线程堆栈"><a href="#内核态线程堆栈" class="headerlink" title="内核态线程堆栈"></a>内核态线程堆栈</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">0x028</span> InitialStack     : Ptr32 Void     <span class="comment">// 栈底</span></span><br><span class="line">+<span class="number">0x02c</span> StackLimit       : Ptr32 Void     <span class="comment">// ESP（切换线程恢复时使用）</span></span><br><span class="line">+<span class="number">0x030</span> KernelStack      : Ptr32 Void     <span class="comment">// 栈顶</span></span><br></pre></td></tr></table></figure><blockquote><p>每个线程在创建堆栈的时候预留了<code>0x29c</code>的位置（包括<code>trap_frame</code>和浮点）, 想要求出真正的栈底需要加上<code>0x29c</code>; 在系统调用时<code>trap_frame</code>保存环境</p></blockquote><h5 id="结构原型"><a href="#结构原型" class="headerlink" title="结构原型"></a>结构原型</h5><blockquote><p><code>Priority</code>字段<br>在xp下就32个链表<br>在WIN7之后不是32个链表, 每个核32个链表, 存在KPCR, 32个链表组成一个数组, 数字越大, 优先级越高;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD</span><br><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +<span class="number">0x000</span> Header           : _DISPATCHER_HEADER     <span class="comment">// </span></span><br><span class="line">   +<span class="number">0x010</span> CycleTime        : Uint8B</span><br><span class="line">   +<span class="number">0x018</span> HighCycleTime    : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> QuantumTarget    : Uint8B                 <span class="comment">// 总耗时的时间碎片</span></span><br><span class="line">   +<span class="number">0x028</span> InitialStack     : Ptr32 Void             <span class="comment">// 堆栈栈底</span></span><br><span class="line">   +<span class="number">0x02c</span> StackLimit       : Ptr32 Void             <span class="comment">// 堆栈栈顶</span></span><br><span class="line">   +<span class="number">0x030</span> KernelStack      : Ptr32 Void             <span class="comment">// ESP</span></span><br><span class="line">   +<span class="number">0x034</span> ThreadLock       : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> WaitRegister     : _KWAIT_STATUS_REGISTER</span><br><span class="line">   +<span class="number">0x039</span> Running          : UChar</span><br><span class="line">   +<span class="number">0x03a</span> Alerted          : [<span class="number">2</span>] UChar              <span class="comment">// 可警惕性</span></span><br><span class="line">   +<span class="number">0x03c</span> KernelStackResident : Pos <span class="number">0</span>, <span class="number">1</span> Bit        <span class="comment">// 堆栈拓展</span></span><br><span class="line">   +<span class="number">0x03c</span> ReadyTransition  : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> ProcessReadyQueue : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> WaitNext         : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> SystemAffinityActive : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> Alertable        : Pos <span class="number">5</span>, <span class="number">1</span> Bit           <span class="comment">// 是否支持可被唤醒</span></span><br><span class="line">   +<span class="number">0x03c</span> GdiFlushActive   : Pos <span class="number">6</span>, <span class="number">1</span> Bit           <span class="comment">// gdi是否刷新</span></span><br><span class="line">   +<span class="number">0x03c</span> UserStackWalkActive : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> ApcInterruptRequest : Pos <span class="number">8</span>, <span class="number">1</span> Bit        <span class="comment">// 是否允许apc</span></span><br><span class="line">   +<span class="number">0x03c</span> ForceDeferSchedule : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> QuantumEndMigrate : Pos <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> UmsDirectedSwitchEnable : Pos <span class="number">11</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> TimerActive      : Pos <span class="number">12</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x03c</span> SystemThread     : Pos <span class="number">13</span>, <span class="number">1</span> Bit          <span class="comment">// 判断是否是内核线程（api：IoIsSystemThread）</span></span><br><span class="line">   +<span class="number">0x03c</span> Reserved         : Pos <span class="number">14</span>, <span class="number">18</span> Bits</span><br><span class="line">   +<span class="number">0x03c</span> MiscFlags        : Int4B</span><br><span class="line">   +<span class="number">0x040</span> ApcState         : _KAPC_STATE            <span class="comment">// apc状态</span></span><br><span class="line">        kd&gt; dt _KAPC_STATE</span><br><span class="line">            ntdll!_KAPC_STATE</span><br><span class="line">            +<span class="number">0x000</span> ApcListHead      : [<span class="number">2</span>] _LIST_ENTRY       <span class="comment">// </span></span><br><span class="line">            +<span class="number">0x010</span> Process          : Ptr32 _KPROCESS       <span class="comment">// 当前线程的上下文环境是谁</span></span><br><span class="line">            +<span class="number">0x014</span> KernelApcInProgress : UChar</span><br><span class="line">            +<span class="number">0x015</span> KernelApcPending : UChar</span><br><span class="line">            +<span class="number">0x016</span> UserApcPending   : UChar</span><br><span class="line">   ----------------------------------------------------------</span><br><span class="line">   +<span class="number">0x040</span> ApcStateFill     : [<span class="number">23</span>] UChar</span><br><span class="line">   +<span class="number">0x057</span> Priority         : Char           <span class="comment">// 线程优先级的级别</span></span><br><span class="line">   +<span class="number">0x058</span> NextProcessor    : Uint4B         <span class="comment">// 亲核性, 决定线程下一次运行在哪个核</span></span><br><span class="line">   +<span class="number">0x05c</span> DeferredProcessor : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> ApcQueueLock     : Uint4B</span><br><span class="line">   +<span class="number">0x064</span> ContextSwitches  : Uint4B         <span class="comment">// 线程切换次数</span></span><br><span class="line">   +<span class="number">0x068</span> State            : UChar          <span class="comment">// 线程的状态</span></span><br><span class="line">   +<span class="number">0x069</span> NpxState         : Char</span><br><span class="line">   +<span class="number">0x06a</span> WaitIrql         : UChar</span><br><span class="line">   +<span class="number">0x06b</span> WaitMode         : Char</span><br><span class="line">   +<span class="number">0x06c</span> WaitStatus       : Int4B</span><br><span class="line">   +<span class="number">0x070</span> WaitBlockList    : Ptr32 _KWAIT_BLOCK</span><br><span class="line">   +<span class="number">0x074</span> WaitListEntry    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x074</span> SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x07c</span> Queue            : Ptr32 _KQUEUE      <span class="comment">// 队列</span></span><br><span class="line">   +<span class="number">0x080</span> WaitTime         : Uint4B</span><br><span class="line">   +<span class="number">0x084</span> KernelApcDisable : Int2B</span><br><span class="line">   +<span class="number">0x086</span> SpecialApcDisable : Int2B</span><br><span class="line">   +<span class="number">0x084</span> CombinedApcDisable : Uint4B</span><br><span class="line">   +<span class="number">0x088</span> Teb              : Ptr32 Void</span><br><span class="line">   +<span class="number">0x090</span> Timer            : _KTIMER            <span class="comment">// 定时器</span></span><br><span class="line">   +<span class="number">0x0b8</span> AutoAlignment    : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> DisableBoost     : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> EtwStackTraceApc1Inserted : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> EtwStackTraceApc2Inserted : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> CalloutActive    : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> ApcQueueable     : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> EnableStackSwap  : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> GuiThread        : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> UmsPerformingSyscall : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> VdmSafe          : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> UmsDispatched    : Pos <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0b8</span> ReservedFlags    : Pos <span class="number">11</span>, <span class="number">21</span> Bits</span><br><span class="line">   +<span class="number">0x0b8</span> ThreadFlags      : Int4B</span><br><span class="line">   +<span class="number">0x0bc</span> ServiceTable     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0c0</span> WaitBlock        : [<span class="number">4</span>] _KWAIT_BLOCK</span><br><span class="line">   +<span class="number">0x120</span> QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x128</span> TrapFrame        : Ptr32 _KTRAP_FRAME</span><br><span class="line">   +<span class="number">0x12c</span> FirstArgument    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x130</span> CallbackStack    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x130</span> CallbackDepth    : Uint4B</span><br><span class="line">   +<span class="number">0x134</span> ApcStateIndex    : UChar</span><br><span class="line">   +<span class="number">0x135</span> BasePriority     : Char</span><br><span class="line">   +<span class="number">0x136</span> PriorityDecrement : Char</span><br><span class="line">   +<span class="number">0x136</span> ForegroundBoost  : Pos <span class="number">0</span>, <span class="number">4</span> Bits</span><br><span class="line">   +<span class="number">0x136</span> UnusualBoost     : Pos <span class="number">4</span>, <span class="number">4</span> Bits</span><br><span class="line">   +<span class="number">0x137</span> Preempted        : UChar              <span class="comment">// 抢占</span></span><br><span class="line">   +<span class="number">0x138</span> AdjustReason     : UChar</span><br><span class="line">   +<span class="number">0x139</span> AdjustIncrement  : Char</span><br><span class="line">   +<span class="number">0x13a</span> PreviousMode     : Char</span><br><span class="line">   +<span class="number">0x13b</span> Saturation       : Char</span><br><span class="line">   +<span class="number">0x13c</span> SystemCallNumber : Uint4B</span><br><span class="line">   +<span class="number">0x140</span> FreezeCount      : Uint4B</span><br><span class="line">   +<span class="number">0x144</span> UserAffinity     : _GROUP_AFFINITY</span><br><span class="line">   +<span class="number">0x150</span> Process          : Ptr32 _KPROCESS        <span class="comment">// 代表谁创建了这个线程</span></span><br><span class="line">   +<span class="number">0x154</span> Affinity         : _GROUP_AFFINITY</span><br><span class="line">   +<span class="number">0x160</span> IdealProcessor   : Uint4B</span><br><span class="line">   +<span class="number">0x164</span> UserIdealProcessor : Uint4B</span><br><span class="line">   +<span class="number">0x168</span> ApcStatePointer  : [<span class="number">2</span>] Ptr32 _KAPC_STATE</span><br><span class="line">   +<span class="number">0x170</span> SavedApcState    : _KAPC_STATE</span><br><span class="line">   +<span class="number">0x170</span> SavedApcStateFill : [<span class="number">23</span>] UChar</span><br><span class="line">   +<span class="number">0x187</span> WaitReason       : UChar</span><br><span class="line">   +<span class="number">0x188</span> SuspendCount     : Char</span><br><span class="line">   +<span class="number">0x189</span> Spare1           : Char</span><br><span class="line">   +<span class="number">0x18a</span> OtherPlatformFill : UChar</span><br><span class="line">   +<span class="number">0x18c</span> Win32Thread      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x190</span> StackBase        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x194</span> SuspendApc       : _KAPC</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill0  : [<span class="number">1</span>] UChar</span><br><span class="line">   +<span class="number">0x195</span> ResourceIndex    : UChar</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill1  : [<span class="number">3</span>] UChar</span><br><span class="line">   +<span class="number">0x197</span> QuantumReset     : UChar</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill2  : [<span class="number">4</span>] UChar</span><br><span class="line">   +<span class="number">0x198</span> KernelTime       : Uint4B</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill3  : [<span class="number">36</span>] UChar</span><br><span class="line">   +<span class="number">0x1b8</span> WaitPrcb         : Ptr32 _KPRCB</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill4  : [<span class="number">40</span>] UChar</span><br><span class="line">   +<span class="number">0x1bc</span> LegoData         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x194</span> SuspendApcFill5  : [<span class="number">47</span>] UChar</span><br><span class="line">   +<span class="number">0x1c3</span> LargeStack       : UChar</span><br><span class="line">   +<span class="number">0x1c4</span> UserTime         : Uint4B</span><br><span class="line">   +<span class="number">0x1c8</span> SuspendSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x1c8</span> SuspendSemaphorefill : [<span class="number">20</span>] UChar</span><br><span class="line">   +<span class="number">0x1dc</span> SListFaultCount  : Uint4B</span><br><span class="line">   +<span class="number">0x1e0</span> ThreadListEntry  : _LIST_ENTRY        <span class="comment">// 线程链表, 对应KPROCESS中的ThreadListHead</span></span><br><span class="line">   +<span class="number">0x1e8</span> MutantListHead   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1f0</span> SListFaultAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1f4</span> ThreadCounters   : Ptr32 _KTHREAD_COUNTERS</span><br><span class="line">   +<span class="number">0x1f8</span> XStateSave       : Ptr32 _XSTATE_SAVE</span><br></pre></td></tr></table></figure><h4 id="ETHREAD"><a href="#ETHREAD" class="headerlink" title="ETHREAD"></a>ETHREAD</h4><blockquote><p>线程断链要断执行体的（ETHREAD）, 断完之后R3下通过API遍历线程是遍历不到的;<br>隐藏线程的好处:</p></blockquote><ol><li>不PG;</li><li>防止别人搜索自己的代码;</li></ol><blockquote><p>当用系统取创建线程时将<code>StartAddress</code>和<code>Win32StartAddress</code>弄干净, 必须要指向一个其他模块, 而不是自己的模块, 否则会被查出来;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _ETHREAD</span><br><span class="line">ntdll!_ETHREAD</span><br><span class="line">   +<span class="number">0x000</span> Tcb              : _KTHREAD</span><br><span class="line">   +<span class="number">0x200</span> CreateTime       : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x208</span> ExitTime         : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x208</span> KeyedWaitChain   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x210</span> ExitStatus       : Int4B</span><br><span class="line">   +<span class="number">0x214</span> PostBlockList    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x214</span> ForwardLinkShadow : Ptr32 Void</span><br><span class="line">   +<span class="number">0x218</span> StartAddress     : Ptr32 Void         <span class="comment">// 线程的入口点</span></span><br><span class="line">   +<span class="number">0x21c</span> TerminationPort  : Ptr32 _TERMINATION_PORT</span><br><span class="line">   +<span class="number">0x21c</span> ReaperLink       : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x21c</span> KeyedWaitValue   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x220</span> ActiveTimerListLock : Uint4B</span><br><span class="line">   +<span class="number">0x224</span> ActiveTimerListHead : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x22c</span> Cid              : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x234</span> KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x234</span> AlpcWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x248</span> ClientSecurity   : _PS_CLIENT_SECURITY_CONTEXT</span><br><span class="line">   +<span class="number">0x24c</span> IrpList          : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x254</span> TopLevelIrp      : Uint4B</span><br><span class="line">   +<span class="number">0x258</span> DeviceToVerify   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x25c</span> CpuQuotaApc      : Ptr32 _PSP_CPU_QUOTA_APC</span><br><span class="line">   +<span class="number">0x260</span> Win32StartAddress : Ptr32 Void            <span class="comment">// ui线程入口点</span></span><br><span class="line">   +<span class="number">0x264</span> LegacyPowerObject : Ptr32 Void</span><br><span class="line">   +<span class="number">0x268</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x270</span> RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x274</span> ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x278</span> ReadClusterSize  : Uint4B</span><br><span class="line">   +<span class="number">0x27c</span> MmLockOrdering   : Int4B</span><br><span class="line">   +<span class="number">0x280</span> CrossThreadFlags : Uint4B</span><br><span class="line">   +<span class="number">0x280</span> Terminated       : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> ThreadInserted   : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> HideFromDebugger : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> ActiveImpersonationInfo : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> Reserved         : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> HardErrorsAreDisabled : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> BreakOnTermination : Pos <span class="number">6</span>, <span class="number">1</span> Bit     <span class="comment">// 置为1，别人无法关闭线程, 关闭就会蓝屏</span></span><br><span class="line">   +<span class="number">0x280</span> SkipCreationMsg  : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> SkipTerminationMsg : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> CopyTokenOnOpen  : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> ThreadIoPriority : Pos <span class="number">10</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x280</span> ThreadPagePriority : Pos <span class="number">13</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x280</span> RundownFail      : Pos <span class="number">16</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x280</span> NeedsWorkingSetAging : Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> SameThreadPassiveFlags : Uint4B</span><br><span class="line">   +<span class="number">0x284</span> ActiveExWorker   : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> ExWorkerCanWaitUser : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> MemoryMaker      : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> ClonedThread     : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> KeyedEventInUse  : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x284</span> RateApcState     : Pos <span class="number">5</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x284</span> SelfTerminate    : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> SameThreadApcFlags : Uint4B</span><br><span class="line">   +<span class="number">0x288</span> Spare            : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> StartAddressInvalid : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> EtwPageFaultCalloutActive : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> OwnsProcessWorkingSetExclusive : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> OwnsProcessWorkingSetShared : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> OwnsSystemCacheWorkingSetExclusive : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> OwnsSystemCacheWorkingSetShared : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x288</span> OwnsSessionWorkingSetExclusive : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsSessionWorkingSetShared : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsProcessAddressSpaceExclusive : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsProcessAddressSpaceShared : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> SuppressSymbolLoad : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> Prefetching      : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsDynamicMemoryShared : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsChangeControlAreaExclusive : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x289</span> OwnsChangeControlAreaShared : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x28a</span> OwnsPagedPoolWorkingSetExclusive : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x28a</span> OwnsPagedPoolWorkingSetShared : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x28a</span> OwnsSystemPtesWorkingSetExclusive : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x28a</span> OwnsSystemPtesWorkingSetShared : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x28a</span> TrimTrigger      : Pos <span class="number">4</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x28a</span> Spare1           : Pos <span class="number">6</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x28b</span> PriorityRegionActive : UChar</span><br><span class="line">   +<span class="number">0x28c</span> CacheManagerActive : UChar</span><br><span class="line">   +<span class="number">0x28d</span> DisablePageFaultClustering : UChar</span><br><span class="line">   +<span class="number">0x28e</span> ActiveFaultCount : UChar</span><br><span class="line">   +<span class="number">0x28f</span> LockOrderState   : UChar</span><br><span class="line">   +<span class="number">0x290</span> AlpcMessageId    : Uint4B</span><br><span class="line">   +<span class="number">0x294</span> AlpcMessage      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x294</span> AlpcReceiveAttributeSet : Uint4B</span><br><span class="line">   +<span class="number">0x298</span> AlpcWaitListEntry : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x2a0</span> CacheManagerCount : Uint4B</span><br><span class="line">   +<span class="number">0x2a4</span> IoBoostCount     : Uint4B</span><br><span class="line">   +<span class="number">0x2a8</span> IrpListLock      : Uint4B</span><br><span class="line">   +<span class="number">0x2ac</span> ReservedForSynchTracking : Ptr32 Void</span><br><span class="line">   +<span class="number">0x2b0</span> CmCallbackListHead : _SINGLE_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x2b4</span> KernelStackReference : Uint4B </span><br></pre></td></tr></table></figure><h3 id="线程查找"><a href="#线程查找" class="headerlink" title="线程查找"></a>线程查找</h3><h3 id="线程主动切换"><a href="#线程主动切换" class="headerlink" title="线程主动切换"></a>线程主动切换</h3><h4 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_KTHREAD_STATE</span> &#123;</span><br><span class="line">    Initialized,        <span class="comment">// 初始化</span></span><br><span class="line">    Ready,              <span class="comment">// 就绪</span></span><br><span class="line">    Running,            <span class="comment">// 运行状态</span></span><br><span class="line">    Standby,            <span class="comment">// 备用状态</span></span><br><span class="line">    Terminated,         <span class="comment">// 结束</span></span><br><span class="line">    Waiting,            <span class="comment">// 等待</span></span><br><span class="line">    Transition,         <span class="comment">// 转化</span></span><br><span class="line">    DeferredReady,      <span class="comment">// 延时就绪</span></span><br><span class="line">    GateWait            <span class="comment">// 未使用</span></span><br><span class="line">&#125; KTHREAD_STATE</span><br></pre></td></tr></table></figure><h3 id="线程被动切换"><a href="#线程被动切换" class="headerlink" title="线程被动切换"></a>线程被动切换</h3>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;线程&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-KPCR</title>
    <link href="http://example.com/bd2c183d.html"/>
    <id>http://example.com/bd2c183d.html</id>
    <published>2024-11-15T01:31:59.000Z</published>
    <updated>2024-11-18T02:44:23.310Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>KPCR_进程</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="KPCR-结构"><a href="#KPCR-结构" class="headerlink" title="KPCR 结构"></a>KPCR 结构</h3><blockquote><p>FS&#x3D;0x30, 在内核中的时候就是指向KPCR;<br>FS&#x3D;0x3b, 在应用层的时候指向当前线程的TEB;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPCR</span><br><span class="line">ntdll!_KPCR</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">        kd&gt; dt _NT_TIB</span><br><span class="line">            ntdll!_NT_TIB</span><br><span class="line">            +<span class="number">0x000</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">            +<span class="number">0x004</span> StackBase        : Ptr32 Void        <span class="comment">// 动态, 记录当前线程堆栈</span></span><br><span class="line">            +<span class="number">0x008</span> StackLimit       : Ptr32 Void        <span class="comment">// 动态, 记录当前线程堆栈</span></span><br><span class="line">            +<span class="number">0x00c</span> SubSystemTib     : Ptr32 Void</span><br><span class="line">            +<span class="number">0x010</span> FiberData        : Ptr32 Void</span><br><span class="line">            +<span class="number">0x010</span> Version          : Uint4B</span><br><span class="line">            +<span class="number">0x014</span> ArbitraryUserPointer : Ptr32 Void</span><br><span class="line">            +<span class="number">0x018</span> Self             : Ptr32 _NT_TIB     <span class="comment">// 指向_NT_TIB本身, 在某些情况下会指向TEB</span></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">   +<span class="number">0x000</span> Used_ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD     <span class="comment">// 异常链表</span></span><br><span class="line">   +<span class="number">0x004</span> Used_StackBase   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> Spare2           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> TssCopy          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> ContextSwitches  : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> SetMemberCopy    : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Used_Self        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> SelfPcr          : Ptr32 _KPCR            <span class="comment">// 一定指向自己（KPCR）</span></span><br><span class="line">   +<span class="number">0x020</span> Prcb             : Ptr32 _KPRCB           <span class="comment">// _KPRCB（CPU控制块拓展块）, 指向0x120 PrcbData: _KPRCB</span></span><br><span class="line">   +<span class="number">0x024</span> Irql             : UChar                  <span class="comment">// 和中断相关</span></span><br><span class="line">   +<span class="number">0x028</span> IRR              : Uint4B                 <span class="comment">// 和中断相关, 派发的中断</span></span><br><span class="line">   +<span class="number">0x02c</span> IrrActive        : Uint4B                 <span class="comment">// 和中断相关</span></span><br><span class="line">   +<span class="number">0x030</span> IDR              : Uint4B                 <span class="comment">// 和中断相关, 已经派发的中断</span></span><br><span class="line">   +<span class="number">0x034</span> KdVersionBlock   : Ptr32 Void             <span class="comment">// kd版本</span></span><br><span class="line">   +<span class="number">0x038</span> IDT              : Ptr32 _KIDTENTRY       <span class="comment">// IDT表</span></span><br><span class="line">   +<span class="number">0x03c</span> GDT              : Ptr32 _KGDTENTRY       <span class="comment">// GDT表</span></span><br><span class="line">   +<span class="number">0x040</span> TSS              : Ptr32 _KTSS</span><br><span class="line">   +<span class="number">0x044</span> MajorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x046</span> MinorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x048</span> SetMember        : Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> StallScaleFactor : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> SpareUnused      : UChar</span><br><span class="line">   +<span class="number">0x051</span> Number           : UChar</span><br><span class="line">   +<span class="number">0x052</span> Spare0           : UChar</span><br><span class="line">   +<span class="number">0x053</span> SecondLevelCacheAssociativity : UChar</span><br><span class="line">   +<span class="number">0x054</span> VdmAlert         : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> KernelReserved   : [<span class="number">14</span>] Uint4B</span><br><span class="line">   +<span class="number">0x090</span> SecondLevelCacheSize : Uint4B</span><br><span class="line">   +<span class="number">0x094</span> HalReserved      : [<span class="number">16</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0d4</span> InterruptMode    : Uint4B</span><br><span class="line">   +<span class="number">0x0d8</span> Spare1           : UChar</span><br><span class="line">   +<span class="number">0x0dc</span> KernelReserved2  : [<span class="number">17</span>] Uint4B</span><br><span class="line">   +<span class="number">0x120</span> PrcbData         : _KPRCB</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><blockquote><p>KiProcessorBlock CPU控制扩展块数组<br>KeNumberProcessors CPU核心数量</p></blockquote><blockquote><p>dd KiProcessorBlock(80b9c120) &#x3D;&gt; dq 80b98800(80409380&#96;c0004fff) &#x3D;&gt; 80b9c000 + 0x120</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; x nt!*ProcessorBlock*</span><br><span class="line"><span class="number">84142f</span>bb          nt!<span class="built_in">KiConfigureProcessorBlock</span> (_KiConfigureProcessorBlock@<span class="number">8</span>)</span><br><span class="line"><span class="number">83f</span>89a00          nt!KiProcessorBlock = &lt;no type information&gt;</span><br><span class="line">kd&gt; dd KiProcessorBlock</span><br><span class="line"><span class="number">83f</span>89a00  <span class="number">80b</span>9c120 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a10  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a20  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a30  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a40  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a50  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a60  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89a70  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`c0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; x nt!*KeNumber*</span><br><span class="line"><span class="number">83f</span>89ac8          nt!KeNumberProcessors = &lt;no type information&gt;</span><br><span class="line"><span class="number">83f</span>89ac4          nt!KeNumberNodes = &lt;no type information&gt;</span><br><span class="line"><span class="number">83f</span>899fb          nt!KeNumberProcessorsGroup0 = &lt;no type information&gt;</span><br><span class="line">kd&gt; dd KeNumberProcessors</span><br><span class="line"><span class="number">83f</span>89ac8  <span class="number">00000001</span> <span class="number">00000002</span> <span class="number">00000001</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89ad8  <span class="number">00000000</span> <span class="number">00000020</span> <span class="number">111f</span>0000 <span class="number">00000006</span></span><br><span class="line"><span class="number">83f</span>89ae8  <span class="number">0000</span>a502 <span class="number">77516b</span>38 <span class="number">77516</span>a38 <span class="number">77516</span>aa0</span><br><span class="line"><span class="number">83f</span>89af8  <span class="number">77516</span>ae8 <span class="number">7750554f</span> <span class="number">83e7</span>f414 <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89b08  <span class="number">00000191</span> <span class="number">83e7</span>fa5c <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">83f</span>89b18  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">7750554</span>d <span class="number">77505524</span></span><br><span class="line"><span class="number">83f</span>89b28  <span class="number">00000000</span> <span class="number">00</span>cdaa56 <span class="number">841</span>ec5b8 <span class="number">841554f</span>4</span><br><span class="line"><span class="number">83f</span>89b38  <span class="number">83</span>ef468f <span class="number">00000000</span> <span class="number">83e7</span>f414 <span class="number">00000000</span></span><br><span class="line">kd&gt; dt _KPCR <span class="number">80b</span>9c000</span><br><span class="line">ntdll!_KPCR</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0x000</span> Used_ExceptionList : <span class="number">0x83f4913c</span> _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> Used_StackBase   : (null) </span><br><span class="line">   +<span class="number">0x008</span> Spare2           : (null) </span><br><span class="line">   +<span class="number">0x00c</span> TssCopy          : <span class="number">0x80b98c00</span> Void</span><br><span class="line">   +<span class="number">0x010</span> ContextSwitches  : <span class="number">0x3998d</span></span><br><span class="line">   +<span class="number">0x014</span> SetMemberCopy    : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x018</span> Used_Self        : (null) </span><br><span class="line">   +<span class="number">0x01c</span> SelfPcr          : <span class="number">0x80b9c000</span> _KPCR</span><br><span class="line">   +<span class="number">0x020</span> Prcb             : <span class="number">0x80b9c120</span> _KPRCB</span><br><span class="line">   +<span class="number">0x024</span> Irql             : <span class="number">0x1f</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x028 IRR              : 0</span></span><br><span class="line"><span class="string">   +0x02c IrrActive        : 0</span></span><br><span class="line"><span class="string">   +0x030 IDR              : 0xffffffff</span></span><br><span class="line"><span class="string">   +0x034 KdVersionBlock   : 0x83f4cdc0 Void</span></span><br><span class="line"><span class="string">   +0x038 IDT              : 0x80b98000 _KIDTENTRY</span></span><br><span class="line"><span class="string">   +0x03c GDT              : 0x80b98800 _KGDTENTRY</span></span><br><span class="line"><span class="string">   +0x040 TSS              : 0x80b98c00 _KTSS</span></span><br><span class="line"><span class="string">   +0x044 MajorVersion     : 1                  // 版本, 扩展使用</span></span><br><span class="line"><span class="string">   +0x046 MinorVersion     : 1                  // 版本, 扩展使用</span></span><br><span class="line"><span class="string">   +0x048 SetMember        : 1                  // 线程切换使用</span></span><br><span class="line"><span class="string">   +0x04c StallScaleFactor : 0xa20</span></span><br><span class="line"><span class="string">   +0x050 SpareUnused      : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x051</span> Number           : <span class="number">0</span> <span class="string">&#x27;&#x27;               // 当前核数</span></span><br><span class="line"><span class="string">   +0x052 Spare0           : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x053</span> SecondLevelCacheAssociativity : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x054 VdmAlert         : 0</span></span><br><span class="line"><span class="string">   +0x058 KernelReserved   : [14] 0</span></span><br><span class="line"><span class="string">   +0x090 SecondLevelCacheSize : 0</span></span><br><span class="line"><span class="string">   +0x094 HalReserved      : [16] 0x1000000</span></span><br><span class="line"><span class="string">   +0x0d4 InterruptMode    : 0</span></span><br><span class="line"><span class="string">   +0x0d8 Spare1           : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x0dc</span> KernelReserved2  : [<span class="number">17</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x120</span> PrcbData         : _KPRCB</span><br></pre></td></tr></table></figure><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><blockquote><p>Ex: 执行体函数, 进程、线程、链表、对象属性赋值、取值, 加锁相关;<br>Ke: 内核函数, 大部分导出;<br>Ki: 微内核函数, 不导出, 内部自己使用, 进程、线程、CPU调度相关<br>Ps: 执行体函数, 进程、线程相关;<br>Mm: 内存相关函数, 一般导出;<br>Mi: 内存相关函数, Mm函数底层调用Mi, 不导出;<br>Io: 文件、设备相关, 导出;<br>Cc: 文件缓存;<br>Rtl: 导出函数, 一般是运行库、字符串, 执行体函数;<br>Zw: SSDT, 但是Zw不需要修改线程的先前模式;<br>Nt: Zw函数会调用到Nt, 本身Zw函数不实现功能;<br>CM: 注册表相关;<br>hal: 硬件相关函数;<br>Ob: 对象管理器, 句柄、创建内核对象、查询内核对象;<br>Pnp: 电源管理;<br>Psp: 执行体函数, 进程、线程, Ps函数实现复杂功能的时候都是调用Psp;</p></blockquote><h4 id="OBJECT-HEADER（对象头结构体）"><a href="#OBJECT-HEADER（对象头结构体）" class="headerlink" title="OBJECT_HEADER（对象头结构体）"></a>OBJECT_HEADER（对象头结构体）</h4><blockquote><p>32位下为<code>0x18</code>, 64位下为<code>0x30</code>;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_HEADER</span><br><span class="line">nt!_OBJECT_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PointerCount     : Int4B           <span class="comment">// Ob类函数引用次数</span></span><br><span class="line">   +<span class="number">0x004</span> HandleCount      : Int4B           <span class="comment">// 句柄引用</span></span><br><span class="line">   +<span class="number">0x004</span> NextToFree       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> Lock             : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x00c</span> TypeIndex        : UChar</span><br><span class="line">   +<span class="number">0x00d</span> TraceFlags       : UChar</span><br><span class="line">   +<span class="number">0x00e</span> InfoMask         : UChar</span><br><span class="line">   +<span class="number">0x00f</span> Flags            : UChar           <span class="comment">// 设置为4保护进程</span></span><br><span class="line">   +<span class="number">0x010</span> ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION</span><br><span class="line">   +<span class="number">0x010</span> QuotaBlockCharged : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> Body             : _QUAD</span><br></pre></td></tr></table></figure><h4 id="EPROCESS（执行体结构）"><a href="#EPROCESS（执行体结构）" class="headerlink" title="EPROCESS（执行体结构）"></a>EPROCESS（执行体结构）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _EPROCESS</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Pcb              : _KPROCESS</span><br><span class="line">   +<span class="number">0x098</span> ProcessLock      : _EX_PUSH_LOCK            <span class="comment">// 进程锁</span></span><br><span class="line">   +<span class="number">0x0a0</span> CreateTime       : _LARGE_INTEGER           <span class="comment">// 进程创建时间</span></span><br><span class="line">   +<span class="number">0x0a8</span> ExitTime         : _LARGE_INTEGER           <span class="comment">// 进程结束时间</span></span><br><span class="line">   +<span class="number">0x0b0</span> RundownProtect   : _EX_RUNDOWN_REF          <span class="comment">// 进程运行保护锁</span></span><br><span class="line">   +<span class="number">0x0b4</span> UniqueProcessId  : Ptr32 Void               <span class="comment">// 进程ID</span></span><br><span class="line">   +<span class="number">0x0b8</span> ActiveProcessLinks : _LIST_ENTRY            <span class="comment">// 活动进程链表</span></span><br><span class="line">   +<span class="number">0x0c0</span> ProcessQuotaUsage : [<span class="number">2</span>] Uint4B              <span class="comment">// 统计进程所用内存</span></span><br><span class="line">   +<span class="number">0x0c8</span> ProcessQuotaPeak : [<span class="number">2</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0d0</span> CommitCharge     : Uint4B</span><br><span class="line">   +<span class="number">0x0d4</span> QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK</span><br><span class="line">   +<span class="number">0x0d8</span> CpuQuotaBlock    : Ptr32 _PS_CPU_QUOTA_BLOCK</span><br><span class="line">   +<span class="number">0x0dc</span> PeakVirtualSize  : Uint4B</span><br><span class="line">   +<span class="number">0x0e0</span> VirtualSize      : Uint4B</span><br><span class="line">   +<span class="number">0x0e4</span> SessionProcessLinks : _LIST_ENTRY           <span class="comment">// 针对某个用户的进程链表</span></span><br><span class="line">   +<span class="number">0x0ec</span> DebugPort        : Ptr32 Void               <span class="comment">// 有值代表正在被调式</span></span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortData : Ptr32 Void              <span class="comment">// 异常</span></span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortValue : Uint4B                 <span class="comment">// 异常</span></span><br><span class="line">   +<span class="number">0x0f0</span> ExceptionPortState : Pos <span class="number">0</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x0f4</span> ObjectTable      : Ptr32 _HANDLE_TABLE      <span class="comment">// 句柄表</span></span><br><span class="line">   +<span class="number">0x0f8</span> Token            : _EX_FAST_REF             <span class="comment">// 代表有什么权限</span></span><br><span class="line">   +<span class="number">0x0fc</span> WorkingSetPage   : Uint4B                   <span class="comment">// 目前用了多少页</span></span><br><span class="line">   +<span class="number">0x100</span> AddressCreationLock : _EX_PUSH_LOCK      </span><br><span class="line">   +<span class="number">0x104</span> RotateInProgress : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x108</span> ForkInProgress   : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x10c</span> HardwareTrigger  : Uint4B</span><br><span class="line">   +<span class="number">0x110</span> PhysicalVadRoot  : Ptr32 _MM_AVL_TABLE</span><br><span class="line">   +<span class="number">0x114</span> CloneRoot        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x118</span> NumberOfPrivatePages : Uint4B</span><br><span class="line">   +<span class="number">0x11c</span> NumberOfLockedPages : Uint4B</span><br><span class="line">   +<span class="number">0x120</span> Win32Process     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x124</span> Job              : Ptr32 _EJOB</span><br><span class="line">   +<span class="number">0x128</span> SectionObject    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x12c</span> SectionBaseAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x130</span> Cookie           : Uint4B</span><br><span class="line">   +<span class="number">0x134</span> Spare8           : Uint4B</span><br><span class="line">   +<span class="number">0x138</span> WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY</span><br><span class="line">   +<span class="number">0x13c</span> Win32WindowStation : Ptr32 Void</span><br><span class="line">   +<span class="number">0x140</span> InheritedFromUniqueProcessId : Ptr32 Void</span><br><span class="line">   +<span class="number">0x144</span> LdtInformation   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x148</span> VdmObjects       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x14c</span> ConsoleHostProcess : Uint4B</span><br><span class="line">   +<span class="number">0x150</span> DeviceMap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x154</span> EtwDataSource    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x158</span> FreeTebHint      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x160</span> PageDirectoryPte : Uint8B</span><br><span class="line">   +<span class="number">0x168</span> Session          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x16c</span> ImageFileName    : [<span class="number">15</span>] UChar            <span class="comment">// 进程名称</span></span><br><span class="line">   +<span class="number">0x17b</span> PriorityClass    : UChar</span><br><span class="line">   +<span class="number">0x17c</span> JobLinks         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x184</span> LockedPagesList  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x188</span> ThreadListHead   : _LIST_ENTRY           <span class="comment">// 线程链表</span></span><br><span class="line">   +<span class="number">0x190</span> SecurityPort     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x194</span> PaeTop           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x198</span> ActiveThreads    : Uint4B                <span class="comment">// 当前进程有多少进程</span></span><br><span class="line">   +<span class="number">0x19c</span> ImagePathHash    : Uint4B</span><br><span class="line">   +<span class="number">0x1a0</span> DefaultHardErrorProcessing : Uint4B</span><br><span class="line">   +<span class="number">0x1a4</span> LastThreadExitStatus : Int4B</span><br><span class="line">   +<span class="number">0x1a8</span> Peb              : Ptr32 _PEB            <span class="comment">// peb</span></span><br><span class="line">   +<span class="number">0x1ac</span> PrefetchTrace    : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x1b0</span> ReadOperationCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1b8</span> WriteOperationCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c0</span> OtherOperationCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c8</span> ReadTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1d0</span> WriteTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1d8</span> OtherTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e0</span> CommitChargeLimit : Uint4B</span><br><span class="line">   +<span class="number">0x1e4</span> CommitChargePeak : Uint4B</span><br><span class="line">   +<span class="number">0x1e8</span> AweInfo          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1ec</span> SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO        <span class="comment">// 完整路径</span></span><br><span class="line">   +<span class="number">0x1f0</span> Vm               : _MMSUPPORT</span><br><span class="line">   +<span class="number">0x25c</span> MmProcessLinks   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x264</span> HighestUserAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x268</span> ModifiedPageCount : Uint4B</span><br><span class="line">   +<span class="number">0x26c</span> Flags2           : Uint4B</span><br><span class="line">   +<span class="number">0x26c</span> JobNotReallyActive : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> AccountingFolded : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> NewProcessReported : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ExitProcessReported : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ReportCommitChanges : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> LastReportMemory : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ReportPhysicalPageChanges : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> HandleTableRundown : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> NeedsHandleRundown : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> RefTraceEnabled  : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> NumaAware        : Pos <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ProtectedProcess : Pos <span class="number">11</span>, <span class="number">1</span> Bit            <span class="comment">// 进程保护</span></span><br><span class="line">   +<span class="number">0x26c</span> DefaultPagePriority : Pos <span class="number">12</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x26c</span> PrimaryTokenFrozen : Pos <span class="number">15</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ProcessVerifierTarget : Pos <span class="number">16</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> StackRandomizationDisabled : Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> AffinityPermanent : Pos <span class="number">18</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> AffinityUpdateEnable : Pos <span class="number">19</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> PropagateNode    : Pos <span class="number">20</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ExplicitAffinity : Pos <span class="number">21</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> Spare1           : Pos <span class="number">22</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> ForceRelocateImages : Pos <span class="number">23</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> DisallowStrippedImages : Pos <span class="number">24</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> LowVaAccessible  : Pos <span class="number">25</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> RestrictIndirectBranchPrediction : Pos <span class="number">26</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> AddressPolicyFrozen : Pos <span class="number">27</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x26c</span> SpeculativeStoreBypassDisable : Pos <span class="number">28</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x270</span> CreateReported   : Pos <span class="number">0</span>, <span class="number">1</span> Bit          <span class="comment">// 创建进程时是否上报</span></span><br><span class="line">   +<span class="number">0x270</span> NoDebugInherit   : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> ProcessExiting   : Pos <span class="number">2</span>, <span class="number">1</span> Bit          <span class="comment">// 进程是否在退出中</span></span><br><span class="line">   +<span class="number">0x270</span> ProcessDelete    : Pos <span class="number">3</span>, <span class="number">1</span> Bit          <span class="comment">// 进程内存是否全部删除</span></span><br><span class="line">   +<span class="number">0x270</span> Wow64SplitPages  : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> VmDeleted        : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> OutswapEnabled   : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> Outswapped       : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> ForkFailed       : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> Wow64VaSpace4Gb  : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> AddressSpaceInitialized : Pos <span class="number">10</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x270</span> SetTimerResolution : Pos <span class="number">12</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> BreakOnTermination : Pos <span class="number">13</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> DeprioritizeViews : Pos <span class="number">14</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> WriteWatch       : Pos <span class="number">15</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> ProcessInSession : Pos <span class="number">16</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> OverrideAddressSpace : Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> HasAddressSpace  : Pos <span class="number">18</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> LaunchPrefetched : Pos <span class="number">19</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> InjectInpageErrors : Pos <span class="number">20</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> VmTopDown        : Pos <span class="number">21</span>, <span class="number">1</span> Bit         <span class="comment">// 置1代表申请内存时从最后开始申请</span></span><br><span class="line">   +<span class="number">0x270</span> ImageNotifyDone  : Pos <span class="number">22</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> PdeUpdateNeeded  : Pos <span class="number">23</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> VdmAllowed       : Pos <span class="number">24</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> CrossSessionCreate : Pos <span class="number">25</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> ProcessInserted  : Pos <span class="number">26</span>, <span class="number">1</span> Bit         <span class="comment">// 设置为0将进程保护起来，打开不了句柄</span></span><br><span class="line">   +<span class="number">0x270</span> DefaultIoPriority : Pos <span class="number">27</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x270</span> ProcessSelfDelete : Pos <span class="number">30</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x270</span> SetTimerResolutionLink : Pos <span class="number">31</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x274</span> ExitStatus       : Int4B              <span class="comment">// 进程退出状态码（通常创建时为259或0x103）</span></span><br><span class="line">   +<span class="number">0x278</span> VadRoot          : _MM_AVL_TABLE</span><br><span class="line">   +<span class="number">0x298</span> AlpcContext      : _ALPC_PROCESS_CONTEXT</span><br><span class="line">   +<span class="number">0x2a8</span> TimerResolutionLink : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x2b0</span> RequestedTimerResolution : Uint4B</span><br><span class="line">   +<span class="number">0x2b4</span> ActiveThreadsHighWatermark : Uint4B</span><br><span class="line">   +<span class="number">0x2b8</span> SmallestTimerResolution : Uint4B</span><br><span class="line">   +<span class="number">0x2bc</span> TimerResolutionStackRecord : Ptr32 _PO_DIAG_STACK_RECORD</span><br><span class="line">   +<span class="number">0x2c0</span> SequenceNumber   : Uint8B</span><br><span class="line">   +<span class="number">0x2c8</span> CreateInterruptTime : Uint8B</span><br><span class="line">   +<span class="number">0x2d0</span> CreateUnbiasedInterruptTime : Uint8B</span><br><span class="line">   +<span class="number">0x2d8</span> SecurityDomain   : Uint8B</span><br></pre></td></tr></table></figure><blockquote><p>作业: ActiveProcessLinks 断链</p></blockquote><h4 id="KPROCESS（内核结构）"><a href="#KPROCESS（内核结构）" class="headerlink" title="KPROCESS（内核结构）"></a>KPROCESS（内核结构）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPROCESS</span><br><span class="line">ntdll!_KPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Header           : _DISPATCHER_HEADER</span><br><span class="line">   +<span class="number">0x010</span> ProfileListHead  : _LIST_ENTRY        <span class="comment">// 性能分析</span></span><br><span class="line">   +<span class="number">0x018</span> DirectoryTableBase : Uint4B           <span class="comment">// 当前进程的cr3</span></span><br><span class="line">   +<span class="number">0x01c</span> LdtDescriptor    : _KGDTENTRY</span><br><span class="line">   +<span class="number">0x024</span> Int21Descriptor  : _KIDTENTRY</span><br><span class="line">   +<span class="number">0x02c</span> ThreadListHead   : _LIST_ENTRY    </span><br><span class="line">   +<span class="number">0x034</span> ProcessLock      : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> Affinity         : _KAFFINITY_EX      <span class="comment">// 亲核性</span></span><br><span class="line">   +<span class="number">0x044</span> ReadyListHead    : _LIST_ENTRY        <span class="comment">// 就绪链表</span></span><br><span class="line">   +<span class="number">0x04c</span> SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x050</span> ActiveProcessors : _KAFFINITY_EX</span><br><span class="line">   +<span class="number">0x05c</span> AutoAlignment    : Pos <span class="number">0</span>, <span class="number">1</span> Bit       <span class="comment">// 进程是否是对齐的</span></span><br><span class="line">   +<span class="number">0x05c</span> DisableBoost     : Pos <span class="number">1</span>, <span class="number">1</span> Bit       <span class="comment">// </span></span><br><span class="line">   +<span class="number">0x05c</span> DisableQuantum   : Pos <span class="number">2</span>, <span class="number">1</span> Bit       <span class="comment">// 进程关闭线程时间碎片的设置</span></span><br><span class="line">   +<span class="number">0x05c</span> ActiveGroupsMask : Pos <span class="number">3</span>, <span class="number">1</span> Bit       <span class="comment">// </span></span><br><span class="line">   +<span class="number">0x05c</span> ReservedFlags    : Pos <span class="number">4</span>, <span class="number">28</span> Bits</span><br><span class="line">   +<span class="number">0x05c</span> ProcessFlags     : Int4B</span><br><span class="line">   +<span class="number">0x060</span> BasePriority     : Char               <span class="comment">// 线程继承的优先级</span></span><br><span class="line">   +<span class="number">0x061</span> QuantumReset     : Char               <span class="comment">// 时间碎片</span></span><br><span class="line">   +<span class="number">0x062</span> Visited          : UChar              </span><br><span class="line">   +<span class="number">0x063</span> Unused3          : UChar</span><br><span class="line">   +<span class="number">0x064</span> ThreadSeed       : [<span class="number">1</span>] Uint4B</span><br><span class="line">   +<span class="number">0x068</span> IdealNode        : [<span class="number">1</span>] Uint2B</span><br><span class="line">   +<span class="number">0x06a</span> IdealGlobalNode  : Uint2B</span><br><span class="line">   +<span class="number">0x06c</span> Flags            : _KEXECUTE_OPTIONS</span><br><span class="line">   +<span class="number">0x06d</span> AddressPolicy    : UChar</span><br><span class="line">   +<span class="number">0x06e</span> IopmOffset       : Uint2B</span><br><span class="line">   +<span class="number">0x070</span> Unused4          : Uint4B</span><br><span class="line">   +<span class="number">0x074</span> StackCount       : _KSTACK_COUNT</span><br><span class="line">   +<span class="number">0x078</span> ProcessListEntry : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x080</span> CycleTime        : Uint8B</span><br><span class="line">   +<span class="number">0x088</span> KernelTime       : Uint4B</span><br><span class="line">   +<span class="number">0x08c</span> UserTime         : Uint4B</span><br><span class="line">   +<span class="number">0x090</span> VdmTrapcHandler  : Ptr32 Void</span><br></pre></td></tr></table></figure><h3 id="保护进程"><a href="#保护进程" class="headerlink" title="保护进程"></a>保护进程</h3><blockquote><p>通过将设置<code>OBJECT_HEADER</code>中的<code>Flags</code>为4, 保护进程不被打开;</p></blockquote><h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C UCHAR * <span class="title">PsGetProcessImageFileName</span><span class="params">(__in PEPROCESS Process)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#define OB_FLAG_NEW_OBJECT              0x01</span></span><br><span class="line"><span class="comment">#define OB_FLAG_KERNEL_OBJECT           0x02</span></span><br><span class="line"><span class="comment">#define OB_FLAG_CREATOR_INFO            0x04// 表示进程刚被创建, 还未创建ObjectCreateInfo，不让打开</span></span><br><span class="line"><span class="comment">#define OB_FLAG_EXCLUSIVE_OBJECT        0x08</span></span><br><span class="line"><span class="comment">#define OB_FLAG_PERMANENT_OBJECT        0x10</span></span><br><span class="line"><span class="comment">#define OB_FLAG_DEFAULT_SECURITY_QUOTA  0x20</span></span><br><span class="line"><span class="comment">#define OB_FLAG_SINGLE_HANDLE_ENTRY     0x40</span></span><br><span class="line"><span class="comment">#define OB_FLAG_DELETED_INLINE          0x80</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">SetProcessFlag</span><span class="params">(PEPROCESS pEProcess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR pObjectHeader = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">pObjectHeader = ((PUCHAR)pEProcess - <span class="number">0x30</span>);</span><br><span class="line">*(pObjectHeader + <span class="number">0x1b</span>) |= <span class="number">4</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">pObjectHeader = ((PUCHAR)pEProcess - <span class="number">0x18</span>);</span><br><span class="line">*(pObjectHeader + <span class="number">0x0f</span>) |= <span class="number">4</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _WIN64</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ReSetProcessFlag</span><span class="params">(PEPROCESS pEProcess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR pObjectHeader = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">pObjectHeader = ((PUCHAR)pEProcess - <span class="number">0x30</span>);</span><br><span class="line">*(pObjectHeader + <span class="number">0x1b</span>) &amp;= ~<span class="number">4</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">pObjectHeader = ((PUCHAR)pEProcess - <span class="number">0x18</span>);</span><br><span class="line">*(pObjectHeader + <span class="number">0x0f</span>) &amp;= ~<span class="number">4</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _WIN64</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PEPROCESS <span class="title">FindProcessByName</span><span class="params">(<span class="type">char</span> * szName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PEPROCESS pFindEProcess = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">4</span>; i &lt; <span class="number">0x1000000</span>; i+=<span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line">PEPROCESS pEProcess = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsLookupProcessByProcessId</span>((HANDLE)i, &amp;pEProcess);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// PsGetProcessImageFileName函数返回的名称有长度限制（15个字节）</span></span><br><span class="line">PUCHAR pszProcessName = <span class="built_in">PsGetProcessImageFileName</span>(pEProcess);</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[+] FindProcessByName: %s\r\n&quot;</span>, pszProcessName);</span><br><span class="line"><span class="keyword">if</span> (pszProcessName &amp;&amp; _stricmp(szName, pszProcessName) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">pFindEProcess = pEProcess;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 引用计数减一</span></span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pFindEProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-------------DriverUnload-------------&quot;</span>);</span><br><span class="line">PEPROCESS pEProcess = <span class="built_in">FindProcessByName</span>(<span class="string">&quot;Dbgview.exe&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!pEProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">ReSetProcessFlag</span>(pEProcess);</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-------------DriverEntry-------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">PEPROCESS pEProcess = <span class="built_in">FindProcessByName</span>(<span class="string">&quot;Dbgview.exe&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!pEProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;FindProcessByName Done.&quot;</span>);</span><br><span class="line"><span class="built_in">SetProcessFlag</span>(pEProcess);</span><br><span class="line"></span><br><span class="line"><span class="comment">// PsLookupProcessByProcessId((HANDLE)3824, &amp;pEProcess);</span></span><br><span class="line"><span class="comment">// 32位：0x18</span></span><br><span class="line"><span class="comment">// 64位：0x30</span></span><br><span class="line"><span class="comment">/*PUCHAR pObjectHeader = ((PUCHAR)pEProcess + 0x18);</span></span><br><span class="line"><span class="comment">*(pObjectHeader + 0xf) |= 4;*/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line"></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="进程断链（ActiveProcessLinks）"><a href="#进程断链（ActiveProcessLinks）" class="headerlink" title="进程断链（ActiveProcessLinks）"></a>进程断链（ActiveProcessLinks）</h3><h4 id="获取ActiveProcessLinks偏移"><a href="#获取ActiveProcessLinks偏移" class="headerlink" title="获取ActiveProcessLinks偏移"></a>获取ActiveProcessLinks偏移</h4><blockquote><p>在内核文件中存在<code>PsGetProcessId</code>函数, 代码中存在<code>eax+0B4h</code>（代表EPROCESS中<code>0x0b4 UniqueProcessId</code>进程ID）, 通过此处再加4得到ActiveProcessLinks偏移;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">004B</span>87D6 ; <span class="function">HANDLE __stdcall <span class="title">PsGetProcessId</span><span class="params">(PEPROCESS Process)</span></span></span><br><span class="line"><span class="function">.text:<span class="number">004B</span>87D6                 public _PsGetProcessId@<span class="number">4</span></span></span><br><span class="line"><span class="function">.text:<span class="number">004B</span>87D6 _PsGetProcessId@<span class="number">4</span> proc near             ;</span> CODE XREF: <span class="built_in">EtwpNotifyGuid</span>(x,x)+<span class="number">13</span>E↓p</span><br><span class="line">.text:<span class="number">004B</span>87D6</span><br><span class="line">.text:<span class="number">004B</span>87D6 Process         = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">004B</span>87D6</span><br><span class="line">.text:<span class="number">004B</span>87D6                 mov     edi, edi</span><br><span class="line">.text:<span class="number">004B</span>87D8                 push    ebp</span><br><span class="line">.text:<span class="number">004B</span>87D9                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">004B</span>87DB                 mov     eax, [ebp+Process]</span><br><span class="line">.text:<span class="number">004B</span>87DE                 mov     eax, [eax+<span class="number">0B</span>4h]</span><br><span class="line">.text:<span class="number">004B</span>87E4                 pop     ebp</span><br><span class="line">.text:<span class="number">004B</span>87E5                 retn    <span class="number">4</span></span><br><span class="line">.text:<span class="number">004B</span>87E5 _PsGetProcessId@<span class="number">4</span> endp</span><br></pre></td></tr></table></figure><h4 id="实验代码-1"><a href="#实验代码-1" class="headerlink" title="实验代码"></a>实验代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FindProcessByName 暴力枚举进程</span></span><br><span class="line"><span class="function">PEPROCESS <span class="title">FindProcessByName</span><span class="params">(PWCH wcProcessName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PEPROCESS pEProcess = <span class="literal">NULL</span>;</span><br><span class="line">PEPROCESS pFindEProcess = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">8</span>; i &lt; <span class="number">0x10000000</span>; i+=<span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsLookupProcessByProcessId</span>((HANDLE)i, &amp;pEProcess);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">PUNICODE_STRING usProcessName = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="comment">// SeLocateProcessImageName 获取进程全路径, PsGetProcessImageFileName函数获取的进程名称只有15字节, 进程名称过长会导致截断, 无法正确判断</span></span><br><span class="line">status = <span class="built_in">SeLocateProcessImageName</span>(pEProcess, &amp;usProcessName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (usProcessName-&gt;Length)</span><br><span class="line">&#123;</span><br><span class="line">_wcsupr(usProcessName-&gt;Buffer);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">wcsstr</span>(usProcessName-&gt;Buffer, wcProcessName) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">pFindEProcess = pEProcess;</span><br><span class="line">            <span class="comment">// ExFreePoolWithTag 释放内存</span></span><br><span class="line"><span class="built_in">ExFreePoolWithTag</span>(usProcessName, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">ExFreePoolWithTag</span>(usProcessName, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pFindEProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetActiveProcessLinksOffset 获取ActiveProcessLinks偏移</span></span><br><span class="line"><span class="function">ULONG <span class="title">GetActiveProcessLinksOffset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">static</span> ULONG offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (offset) <span class="keyword">return</span> offset;</span><br><span class="line">UNICODE_STRING usFuncName;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;usFuncName, <span class="string">L&quot;PsGetProcessId&quot;</span>);</span><br><span class="line">PUCHAR pFunc = (PUCHAR)<span class="built_in">MmGetSystemRoutineAddress</span>(&amp;usFuncName);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pFunc[i] == <span class="number">0x8b</span> &amp;&amp; pFunc[i+<span class="number">1</span>] == <span class="number">0x80</span>)</span><br><span class="line">&#123;</span><br><span class="line">offset = *(PUCHAR)(pFunc + i + <span class="number">2</span>);</span><br><span class="line">offset += <span class="number">4</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: DriverUnload Running.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: DriverEntry Running.&quot;</span>);</span><br><span class="line"></span><br><span class="line">PEPROCESS pEProcess = <span class="built_in">FindProcessByName</span>(<span class="string">L&quot;DBGVIEW.EXE&quot;</span>);</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: FindProcessByName Done.&quot;</span>);</span><br><span class="line"><span class="comment">// 断链</span></span><br><span class="line">ULONG offset = <span class="built_in">GetActiveProcessLinksOffset</span>();</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: GetActiveProcessLinksOffset Done.&quot;</span>);</span><br><span class="line"><span class="built_in">RemoveEntryList</span>((PUCHAR)pEProcess + offset);</span><br><span class="line"><span class="comment">// 初始化进程链表（防止退出进程后随机出现蓝屏）</span></span><br><span class="line"><span class="built_in">InitializeListHead</span>((PUCHAR)pEProcess + offset);</span><br><span class="line"></span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pEProcess);</span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;KPCR_进程&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-系统调用</title>
    <link href="http://example.com/930cd1ef.html"/>
    <id>http://example.com/930cd1ef.html</id>
    <published>2024-11-12T01:41:52.000Z</published>
    <updated>2024-11-15T01:43:39.962Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>系统调用</strong></p></div><span id="more"></span><h2 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="自己实现NtOpenProcess"><a href="#自己实现NtOpenProcess" class="headerlink" title="自己实现NtOpenProcess"></a>自己实现NtOpenProcess</h4><h4 id="在Ring3的代码下调用了sysenter指令之后-CPU会做出如下操作"><a href="#在Ring3的代码下调用了sysenter指令之后-CPU会做出如下操作" class="headerlink" title="在Ring3的代码下调用了sysenter指令之后, CPU会做出如下操作"></a>在Ring3的代码下调用了sysenter指令之后, CPU会做出如下操作</h4><ol><li>将<code>SYSENTER_CS_MSR</code>的值装载到<code>cs</code>寄存器;             &#x2F;&#x2F; rdmsr 174</li><li>将<code>SYSENTER_EIP_MSR</code>的值装载到<code>eip</code>寄存器;           &#x2F;&#x2F; rdmsr 176</li><li>将<code>SYSENTER_CS_MSR</code>的值加8（Ring0的堆栈段描述符）装载到<code>ss</code>寄存器;</li><li>将<code>SYSENTER_ESP_MSR</code>的值装载到<code>esp</code>寄存器;           &#x2F;&#x2F; rdmsr 175</li><li>将特权级别切换到Ring0;</li><li>如果<code>EFLAGS</code>寄存器的<code>VM</code>标志被置位, 则清除该标志;</li><li>开始执行指定的Ring0代码;</li></ol><h4 id="在Ring0代码执行完毕-调用SYEXIT指令退回Ring3时-CPU会做出如下操作"><a href="#在Ring0代码执行完毕-调用SYEXIT指令退回Ring3时-CPU会做出如下操作" class="headerlink" title="在Ring0代码执行完毕, 调用SYEXIT指令退回Ring3时, CPU会做出如下操作"></a>在Ring0代码执行完毕, 调用SYEXIT指令退回Ring3时, CPU会做出如下操作</h4><ol><li>将<code>SYSENTER_CS_MSR</code>的值加16（Ring3的代码段描述符）装载到<code>cs</code>寄存器;</li><li>将寄存器<code>edx</code>的值装载到eip寄存器;</li><li>将<code>SYSENTER_CS_MSR</code>的值加24（Ring3的堆栈段描述符）装载到<code>ss</code>寄存器;</li><li>将寄存器<code>ecx</code>的值装载到<code>esp</code>寄存器;</li><li>将特权等级切换到Ring3;</li><li>继续执行Ring3的代码</li></ol><h4 id="rdmsr用法"><a href="#rdmsr用法" class="headerlink" title="rdmsr用法"></a>rdmsr用法</h4><blockquote><ol><li>读取msr寄存器</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">    mov ecx, <span class="number">0x174</span>;</span><br><span class="line">    rdmsr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回值存在ecx和edx寄存器中</span></span><br><span class="line"><span class="comment">// eax: 低32位</span></span><br><span class="line"><span class="comment">// edx: 高32位</span></span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>写入msr寄存器</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">    mov eax, <span class="number">0x12345678</span>;</span><br><span class="line">    mov edx, <span class="number">0</span>;</span><br><span class="line">    mov ecx, <span class="number">176</span>h;</span><br><span class="line">    wrmsr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="KTRAP-FRAME"><a href="#KTRAP-FRAME" class="headerlink" title="_KTRAP_FRAME"></a>_KTRAP_FRAME</h4><blockquote><p>内核下的<code>CONTEXT</code></p></blockquote><h3 id="SSDT-Hook"><a href="#SSDT-Hook" class="headerlink" title="SSDT Hook"></a>SSDT Hook</h3>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;系统调用&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-驱动内存加载</title>
    <link href="http://example.com/87f76606.html"/>
    <id>http://example.com/87f76606.html</id>
    <published>2024-11-03T01:21:39.000Z</published>
    <updated>2024-11-10T02:59:43.557Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动内存加载</strong></p></div><span id="more"></span><h2 id="驱动内存加载"><a href="#驱动内存加载" class="headerlink" title="驱动内存加载"></a>驱动内存加载</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><blockquote><ol><li>通过<code>explore.exe</code>定位到文件</li><li>使用<code>CreateProcess</code>创建进程（CreateUserProcess）<ul><li>a. 创建进程开辟一块内存   PEB     内核下需要挂<code>C0000000</code></li><li>b. 通过文件路径载入exe</li><li>c. 拉伸PE, 解析PE头, 把对应的数据目录存放到内存相关偏移的地址</li><li>d. 修复重定位</li><li>e. IAT 导入表修复</li><li>f. 修复TLS（驱动没有）</li><li>g. 修复延迟导入表（驱动没有, 驱动存在Cookie）</li><li>h. 修复异常表</li><li>i. CALL入口点</li></ul></li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动内存加载&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-驱动通信</title>
    <link href="http://example.com/6195666c.html"/>
    <id>http://example.com/6195666c.html</id>
    <published>2024-11-01T01:24:38.000Z</published>
    <updated>2024-11-03T01:26:52.746Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动通信</strong></p><p>驱动通信</p></div><span id="more"></span><h2 id="驱动通信"><a href="#驱动通信" class="headerlink" title="驱动通信"></a>驱动通信</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="DRIVER-OBJECT"><a href="#DRIVER-OBJECT" class="headerlink" title="DRIVER_OBJECT"></a>DRIVER_OBJECT</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DEVICE_OBJECT</span><br><span class="line">ntdll!_DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B                      <span class="comment">// 设备大小</span></span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> ReferenceCount   : Int4B</span><br><span class="line">   +<span class="number">0x008</span> DriverObject     : Ptr32 _DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x00c</span> NextDevice       : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x010</span> AttachedDevice   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x014</span> CurrentIrp       : Ptr32 _IRP                 <span class="comment">// 当前请求IRP</span></span><br><span class="line">   +<span class="number">0x018</span> Timer            : Ptr32 _IO_TIMER            <span class="comment">// 时钟</span></span><br><span class="line">   +<span class="number">0x01c</span> Flags            : Uint4B                     <span class="comment">// 以什么方式读写设备</span></span><br><span class="line">   +<span class="number">0x020</span> Characteristics  : Uint4B                     <span class="comment">// 设置属性</span></span><br><span class="line">   +<span class="number">0x024</span> Vpb              : Ptr32 _VPB                 <span class="comment">// 磁盘相关, 暂不涉及</span></span><br><span class="line">   +<span class="number">0x028</span> DeviceExtension  : Ptr32 Void                 <span class="comment">// 扩展</span></span><br><span class="line">   +<span class="number">0x02c</span> DeviceType       : Uint4B                     <span class="comment">// 设备类型</span></span><br><span class="line">   +<span class="number">0x030</span> StackSize        : Char                       <span class="comment">// 设备栈的大小</span></span><br><span class="line">   +<span class="number">0x034</span> Queue            : &lt;unnamed-tag&gt;              <span class="comment">// 队列</span></span><br><span class="line">   +<span class="number">0x05c</span> AlignmentRequirement : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> DeviceQueue      : _KDEVICE_QUEUE</span><br><span class="line">   +<span class="number">0x074</span> Dpc              : _KDPC</span><br><span class="line">   +<span class="number">0x094</span> ActiveThreadCount : Uint4B</span><br><span class="line">   +<span class="number">0x098</span> SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +<span class="number">0x09c</span> DeviceLock       : _KEVENT</span><br><span class="line">   +<span class="number">0x0ac</span> SectorSize       : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> Spare1           : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> DeviceObjectExtension : Ptr32 _DEVOBJ_EXTENSION</span><br><span class="line">   +<span class="number">0x0b4</span> Reserved         : Ptr32 Void</span><br></pre></td></tr></table></figure><h4 id="IRP"><a href="#IRP" class="headerlink" title="IRP"></a>IRP</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _IRP</span><br><span class="line">ntdll!_IRP</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> MdlAddress       : Ptr32 _MDL</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> AssociatedIrp    : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> IoStatus         : _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x020</span> RequestorMode    : Char</span><br><span class="line">   +<span class="number">0x021</span> PendingReturned  : UChar</span><br><span class="line">   +<span class="number">0x022</span> StackCount       : Char       <span class="comment">// 总大小（有多少设备）</span></span><br><span class="line">   +<span class="number">0x023</span> CurrentLocation  : Char       <span class="comment">// 当前设备栈的索引</span></span><br><span class="line">   +<span class="number">0x024</span> Cancel           : UChar</span><br><span class="line">   +<span class="number">0x025</span> CancelIrql       : UChar</span><br><span class="line">   +<span class="number">0x026</span> ApcEnvironment   : Char</span><br><span class="line">   +<span class="number">0x027</span> AllocationFlags  : UChar</span><br><span class="line">   +<span class="number">0x028</span> UserIosb         : Ptr32 _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x02c</span> UserEvent        : Ptr32 _KEVENT</span><br><span class="line">   +<span class="number">0x030</span> Overlay          : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x038</span> CancelRoutine    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x03c</span> UserBuffer       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Tail             : &lt;unnamed-tag&gt;</span><br></pre></td></tr></table></figure><h4 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  PDRIVER_OBJECT DriverObject,          <span class="comment">// 要提供的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceExtensionSize,            <span class="comment">// 设备扩展, 0代表这个地方没有指向</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PUNICODE_STRING DeviceName,        <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  DEVICE_TYPE DeviceType,               <span class="comment">// 设备类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceCharacteristics,          <span class="comment">// 设备属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  BOOLEAN Exclusive,                    <span class="comment">// 是否独占</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_result_nullonfailure_</span></span></span><br><span class="line"><span class="params"><span class="function">    _At_(*DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">        __drv_allocatesMem(Mem)</span></span></span><br><span class="line"><span class="params"><span class="function">        _When_((((_In_function_class_(DRIVER_INITIALIZE))</span></span></span><br><span class="line"><span class="params"><span class="function">               ||(_In_function_class_(DRIVER_DISPATCH)))),</span></span></span><br><span class="line"><span class="params"><span class="function">             __drv_aliasesMem))</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT *DeviceObject                <span class="comment">// 创建成功后返回的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="自定义控制码"><a href="#自定义控制码" class="headerlink" title="自定义控制码"></a>自定义控制码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE( DeviceType, Function, Method, Access ) (                 \</span></span><br><span class="line"><span class="meta">    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_KEY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line">                          <span class="comment">// 虚拟设备类型       // 索引号        // 通信方式        // 访问权限</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+1, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+2, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_BASE_DLL CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+3, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_PROTECT_PID CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+4, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure><h4 id="创建符号链接"><a href="#创建符号链接" class="headerlink" title="创建符号链接"></a>创建符号链接</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTKERNELAPI</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING SymbolicLinkName,          <span class="comment">// 符号链接名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING DeviceName                 <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="设置驱动派发回调函数"><a href="#设置驱动派发回调函数" class="headerlink" title="设置驱动派发回调函数"></a>设置驱动派发回调函数</h4><blockquote><p><code>IRP_MJ_CREATE</code>和<code>IRP_MJ_CLOSE</code>必须设置</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建设备开启/关闭回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;        <span class="comment">// 输入</span></span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;       <span class="comment">// 输出</span></span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="驱动完整代码"><a href="#驱动完整代码" class="headerlink" title="驱动完整代码"></a>驱动完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义设备名称和符号链接</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\Device\\MyUniqueDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM_LINK_NAME <span class="string">L&quot;\\DosDevices\\MyUniqueDevice&quot;</span><span class="comment">// \\??\\ 等价于\\DosDevices\\， \\DosDevices\\兼容性更高</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 IOCTL 控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动卸载函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UnloadDriver</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> </span>&#123;</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"><span class="built_in">IoDeleteSymbolicLink</span>(&amp;symLink);  <span class="comment">// 删除符号链接</span></span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(DriverObject-&gt;DeviceObject);  <span class="comment">// 删除设备对象</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;-----------DriverUnloaded-----------\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动入口</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">NTSTATUS status;</span><br><span class="line">PDEVICE_OBJECT deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">UNICODE_STRING deviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(DEVICE_NAME);</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备对象</span></span><br><span class="line">status = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0</span>, &amp;deviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;deviceObject);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create device\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建符号链接</span></span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;symLink, &amp;deviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(deviceObject);</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create symbolic link\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Driver loaded successfully\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="用户态完整代码"><a href="#用户态完整代码" class="headerlink" title="用户态完整代码"></a>用户态完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="string">L&quot;\\\\.\\MyUniqueDevice&quot;</span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> inputBuffer[<span class="number">100</span>] = <span class="string">&quot;Hello, driver!&quot;</span>;</span><br><span class="line"><span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesReturned;</span><br><span class="line"><span class="comment">// 使用DeviceIoControl打开设备并通过自定义控制码发送和接收数据</span></span><br><span class="line">BOOL success = <span class="built_in">DeviceIoControl</span>(hDevice,</span><br><span class="line">IOCTL_MY_CONTROL_CODE,</span><br><span class="line">inputBuffer, <span class="built_in">sizeof</span>(inputBuffer),</span><br><span class="line">outputBuffer, <span class="built_in">sizeof</span>(outputBuffer),</span><br><span class="line">&amp;bytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, outputBuffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;DeviceIoControl failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用ReadFile进行通信"><a href="#使用ReadFile进行通信" class="headerlink" title="使用ReadFile进行通信"></a>使用ReadFile进行通信</h3><h4 id="驱动代码"><a href="#驱动代码" class="headerlink" title="驱动代码"></a>驱动代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理读取回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceReadControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line"></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line">ULONG bufferLength = stack-&gt;Parameters.Read.Length;</span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备要发送到用户态的数据</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* message = <span class="string">&quot;Hello From Kernel!&quot;</span>;</span><br><span class="line">ULONG messageLength = (ULONG)<span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查缓冲区大小</span></span><br><span class="line"><span class="keyword">if</span> (bufferLength &lt; messageLength) &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 将数据复制到用户态缓冲区</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(Irp-&gt;AssociatedIrp.SystemBuffer, message, messageLength);</span><br><span class="line">Irp-&gt;IoStatus.Information = messageLength;  <span class="comment">// 返回数据长度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建设备</span></span><br><span class="line">    ...</span><br><span class="line">    deviceObject-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">    <span class="comment">// 创建符号链接</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置回调函数</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_READ] = MyDriverDeviceReadControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="用户态代码"><a href="#用户态代码" class="headerlink" title="用户态代码"></a>用户态代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\MyUniqueDevice&quot;</span>), GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesRead;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ReadFile 从驱动读取数据</span></span><br><span class="line">BOOL success = <span class="built_in">ReadFile</span>(hDevice, buffer, <span class="built_in">sizeof</span>(buffer), &amp;bytesRead, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ReadFile failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_BUFFERED                 0       <span class="comment">// 缓冲模式, 复制一份数据</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_IN_DIRECT                1       <span class="comment">// 映射同一个物理地址, 共享物理地址</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_OUT_DIRECT               2       <span class="comment">// </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_NEITHER                  3       <span class="comment">// 直写</span></span></span><br></pre></td></tr></table></figure><h3 id="驱动通信封装"><a href="#驱动通信封装" class="headerlink" title="驱动通信封装"></a>驱动通信封装</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li>注册通信方法</li><li>销毁的方法</li><li>发送通知</li></ol><div class="note red bug"><p><strong>注意</strong></p><p>在使用<code>WriteFile</code>时第四个参数不能使用<code>LPDWORD</code>指针类型直接传参, 会导致程序奔溃, 需要使用<code>DWORD</code>类型然后传递指针;</p></div>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动通信&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;驱动通信&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-驱动开发</title>
    <link href="http://example.com/b57f2803.html"/>
    <id>http://example.com/b57f2803.html</id>
    <published>2024-10-24T01:03:39.000Z</published>
    <updated>2024-11-01T00:33:36.445Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动开发</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="驱动是进程吗"><a href="#驱动是进程吗" class="headerlink" title="驱动是进程吗"></a>驱动是进程吗</h3><blockquote><p>驱动并不是进程, 而是叫模块（本质上和dll是一样的）;</p></blockquote><h3 id="驱动类型"><a href="#驱动类型" class="headerlink" title="驱动类型"></a>驱动类型</h3><blockquote><p>NT: NT4虚拟驱动（现在基本没有纯NT4的驱动）;<br>WDM: 是一个热拔插方式;<br>WDF: 简化开发, 相当于事件驱动机制; KWDF（内核驱动框架）, UWDF（用户驱动框架）;</p></blockquote><h3 id="加载驱动"><a href="#加载驱动" class="headerlink" title="加载驱动"></a>加载驱动</h3><blockquote><ol><li>服务加载<br>OpenSrcManager<br>CreateService<br>StartService<br>StopService<br>DeleteService</li></ol></blockquote><blockquote><ol start="2"><li>本地加载<br>Zw&#x2F;NtLoadDriver<br>Zw&#x2F;NtUnloadDriver</li></ol></blockquote><h1 id="驱动基础"><a href="#驱动基础" class="headerlink" title="驱动基础"></a>驱动基础</h1><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><blockquote><p>int &#x3D;&gt; INT short &#x3D;&gt; SHORT long &#x3D;&gt; LONG</p></blockquote><h3 id="字符串函数-申请内存函数"><a href="#字符串函数-申请内存函数" class="headerlink" title="字符串函数, 申请内存函数"></a>字符串函数, 申请内存函数</h3><h4 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h4><blockquote><ol><li>RtlInitString: 初始化多字节ascii</li></ol></blockquote><blockquote><ol start="2"><li>RtlInitUnicodeString: 初始化宽字符</li></ol></blockquote><blockquote><ol start="3"><li>RtlFreeUnicodeString: 释放unicode字符串</li></ol></blockquote><blockquote><ol start="4"><li>RtlStringCbPrintfA: 格式化输出, 引用#include &lt;ntstrsafe.h&gt;</li></ol></blockquote><blockquote><ol start="5"><li>RtlCompareUnicodeString: 字符串比较</li></ol></blockquote><h4 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h4><blockquote><ol><li>ExAllocatePool（内存申请）<br>NonPagedPool &#x3D;&gt; 非分页内存（带执行属性）<br>PagedPool &#x3D;&gt; 分页内存（不带执行属性）</li></ol></blockquote><blockquote><ol start="2"><li>ExFreePool（释放内存）</li></ol></blockquote><h3 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h3><blockquote><ol><li>PsCreateSystemThread（创建线程）</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数</span></span><br><span class="line"><span class="function">VOID <span class="title">work</span><span class="params">(PVOID StartContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, work, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ZwClose</span>(hThread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="普通链表"><a href="#普通链表" class="headerlink" title="普通链表"></a>普通链表</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><blockquote><p>InitializeListHead（初始化链表）<br>IsListEmpty（判断链表是否为空）<br>InsertHeadList（链表头部插入数据）<br>InsertTailList（链表尾部插入数据）<br>RemoveHeadList（移除链表头部数据）<br>RemoveTailList（移除链表尾部数据）<br>RemoveEntryList（移除空链表）</p></blockquote><h3 id="驱动遍历"><a href="#驱动遍历" class="headerlink" title="驱动遍历"></a>驱动遍历</h3><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// DbgBreakPoint();</span></span><br><span class="line"><span class="comment">// 遍历驱动</span></span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (next != pre)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="驱动断链"><a href="#驱动断链" class="headerlink" title="驱动断链"></a>驱动断链</h3><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DRIVER_OBJECT</span><br><span class="line">ntdll!_DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Int2B</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : Ptr32 Void                 <span class="comment">// 链表</span></span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : Ptr32     <span class="type">long</span> </span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] Ptr32     <span class="type">long</span> </span><br></pre></td></tr></table></figure><h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="params"><span class="function">__in ULONG Attributes,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="params"><span class="function">__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="params"><span class="function">__out PVOID *Object</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE * IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverHide</span><span class="params">(PWCH wcObjectName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">LARGE_INTEGER in = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">in.QuadPart = <span class="number">-10000</span> * <span class="number">5000</span>;</span><br><span class="line"><span class="built_in">KeDelayExecutionThread</span>(KernelMode, FALSE, &amp;in);</span><br><span class="line">UNICODE_STRING usDriverName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;usDriverName, wcObjectName);</span><br><span class="line">PDRIVER_OBJECT pDriverObject = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">ObReferenceObjectByName</span>(&amp;usDriverName, FILE_ALL_ACCESS, <span class="number">0</span>, <span class="number">0</span>, IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObject);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriverObject-&gt;DriverSection;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;ldr-&gt;FullDllName);</span><br><span class="line"><span class="comment">// pDriverObject-&gt;DriverSection = ldr-&gt;InLoadOrderLinks.Flink;// 修复pc hunter 卡死（移花接木）</span></span><br><span class="line"><span class="built_in">RemoveEntryList</span>(&amp;ldr-&gt;InLoadOrderLinks);</span><br><span class="line">pDriverObject-&gt;DriverInit = <span class="literal">NULL</span>;</span><br><span class="line">pDriverObject-&gt;DriverSection = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pDriverObject);<span class="comment">// 引用计数清除</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;DriverHide ObReferenceObjectByName Failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 断链隐藏自身</span></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, DriverHide, <span class="string">&quot;\\drivers\\MyDriver3&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NtClose</span>(hThread);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 有BUG</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">DbgBreakPoint();</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName1 = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName1, L&quot;\\drivers\\http&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName, L&quot;http.sys&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">while (next != pre)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">// DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">if (next-&gt;BaseDllName.Length != 0 &amp;&amp; RtlCompareUnicodeString(&amp;usDriverName, &amp;next-&gt;BaseDllName, TRUE) == 0)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">PDRIVER_OBJECT pDriverObject = NULL;</span></span><br><span class="line"><span class="comment">NTSTATUS status = ObReferenceObjectByName(&amp;usDriverName1, FILE_ALL_ACCESS, 0, 0, IoDriverObjectType, KernelMode, NULL, &amp;pDriverObject);</span></span><br><span class="line"><span class="comment">if (NT_SUCCESS(status))</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverInit = NULL;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverSection = NULL;</span></span><br><span class="line"><span class="comment">// pDriverObject-&gt;Type = 0;// 规避暴露搜索</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">else</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;DriverHide ObReferenceObjectByName Failed&quot;);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span></span><br><span class="line"><span class="comment">break;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动开发&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-控制寄存器</title>
    <link href="http://example.com/fefdec16.html"/>
    <id>http://example.com/fefdec16.html</id>
    <published>2024-10-21T15:35:45.000Z</published>
    <updated>2024-10-21T16:14:51.473Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>控制寄存器</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="CR2"><a href="#CR2" class="headerlink" title="CR2"></a>CR2</h3><blockquote><p>CR2寄存器（内存有问题）保存了出异常的线性地址;</p></blockquote><h3 id="CR3"><a href="#CR3" class="headerlink" title="CR3"></a>CR3</h3><h4 id="PCD"><a href="#PCD" class="headerlink" title="PCD"></a>PCD</h4><blockquote><p>当PCD位为1的时候, 整个页表的缓存全关;</p></blockquote><h4 id="PWT"><a href="#PWT" class="headerlink" title="PWT"></a>PWT</h4><blockquote><p>当PWT位为1的时候, 代表只写（优化性能）;</p></blockquote><h3 id="CR0"><a href="#CR0" class="headerlink" title="CR0"></a>CR0</h3><h4 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h4><blockquote><p>开启保护模式, 但是没有分页保护, 只有段保护;</p></blockquote><h4 id="PG"><a href="#PG" class="headerlink" title="PG"></a>PG</h4><blockquote><p>开启分页模式;</p></blockquote><blockquote><p>PE和PG组合<br>PE &#x3D; 0, PG &#x3D; 1 &#x3D;&gt; 错误的<br>PE &#x3D; 0, PG &#x3D; 0 &#x3D;&gt; 正确的（实模式）<br>PE &#x3D; 1, PG &#x3D; 0 &#x3D;&gt; 正确的（段模式）<br>PE &#x3D; 1, PG &#x3D; 1 &#x3D;&gt; 正确的（段页模式）</p></blockquote><h4 id="CD"><a href="#CD" class="headerlink" title="CD"></a>CD</h4><blockquote><p>关闭缓存; 如果CD位为1, 所有进程的页表缓存通通关闭;</p></blockquote><h4 id="AM"><a href="#AM" class="headerlink" title="AM"></a>AM</h4><blockquote><p>当AM位置为1时, 三环的应用程序必须经过对齐检查（堆栈在32位下必须是4字节对齐, 在64位下必须是8字节对齐）</p></blockquote><h4 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h4><blockquote><p>关闭写保护, 不可写的地址变为可写;</p></blockquote><h3 id="CR4"><a href="#CR4" class="headerlink" title="CR4"></a>CR4</h3><h4 id="VME"><a href="#VME" class="headerlink" title="VME"></a>VME</h4><blockquote><p>开启虚拟中断, 并且允许开启虚拟8086模式;</p></blockquote><h4 id="PVI"><a href="#PVI" class="headerlink" title="PVI"></a>PVI</h4><blockquote><p>当PVI位为1时, 允许虚拟8086模式支持虚拟化中断;</p></blockquote><h4 id="TSD"><a href="#TSD" class="headerlink" title="TSD"></a>TSD</h4><blockquote></blockquote><h4 id="DE"><a href="#DE" class="headerlink" title="DE"></a>DE</h4><blockquote></blockquote><h4 id="PSE"><a href="#PSE" class="headerlink" title="PSE"></a>PSE</h4><blockquote><p>当PSE位为0时, 就算PDE.ps &#x3D; 1也是小页; 控制所有大页的开关是否有效</p></blockquote><h4 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h4><blockquote><p>在32位下, 如果PAE位为1, 表示分页模式为2-9-9-12模式; 否则为10-10-12模式;</p></blockquote><h4 id="MCE"><a href="#MCE" class="headerlink" title="MCE"></a>MCE</h4><blockquote><p>机器检查</p></blockquote><h4 id="PGE"><a href="#PGE" class="headerlink" title="PGE"></a>PGE</h4><blockquote><p>如果PGE &#x3D; 1, G &#x3D; 1代表全局页有效; 如果PGE &#x3D; 0, G &#x3D; 1代表无效;</p></blockquote><h4 id="PCE"><a href="#PCE" class="headerlink" title="PCE"></a>PCE</h4><blockquote></blockquote><h4 id="VMXE"><a href="#VMXE" class="headerlink" title="VMXE"></a>VMXE</h4><blockquote><p>VT的开启位, 进入VT之后这个位必须为1</p></blockquote><h4 id="SMXE"><a href="#SMXE" class="headerlink" title="SMXE"></a>SMXE</h4><blockquote><p>上帝模式</p></blockquote><h4 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h4><blockquote><p>super mode execute protected</p></blockquote><h4 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h4><blockquote><p>super mode access protected</p></blockquote><h4 id="PKE"><a href="#PKE" class="headerlink" title="PKE"></a>PKE</h4><blockquote><p>页表密钥</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;控制寄存器&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-缓存</title>
    <link href="http://example.com/b89f0cae.html"/>
    <id>http://example.com/b89f0cae.html</id>
    <published>2024-10-19T01:34:43.000Z</published>
    <updated>2024-10-21T15:33:52.680Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>缓存</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="WC（写组合-写合并）"><a href="#WC（写组合-写合并）" class="headerlink" title="WC（写组合&#x2F;写合并）"></a>WC（写组合&#x2F;写合并）</h3><blockquote><p>同一时刻只能保证4个地址; </p></blockquote><h3 id="WB（写回绕-回写）"><a href="#WB（写回绕-回写）" class="headerlink" title="WB（写回绕&#x2F;回写）"></a>WB（写回绕&#x2F;回写）</h3><blockquote></blockquote><h3 id="WT（直写）"><a href="#WT（直写）" class="headerlink" title="WT（直写）"></a>WT（直写）</h3><blockquote><p>通常是做多媒体</p></blockquote><h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>课程中test1比test2快, 实验是test2比test1快???</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_19_Cache(缓存).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOCATE_SIZE 0x10000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MASK (ALLOCATE_SIZE - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> j = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (j--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = j &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = j;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h3><h2 id="TLB"><a href="#TLB" class="headerlink" title="TLB"></a>TLB</h2><blockquote><p>每个核有4个TLB, 2个数据核（dTLB）, 2个指令TLB（iTLB）;</p></blockquote><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>申请2个地址, 分别赋值;</li><li>把第一个地址挂在0地址上, 然后访问, 取出结果保存变量;</li><li>又把第二个地址挂在0地址上, 然后访问, 取出结果也保存变量;</li><li>观察变量1, 变量2有什么不同;</li></ol><blockquote><p>401080<br>gdtr: 0040ec00&#96;00081080</p></blockquote><h3 id="实验代码-1"><a href="#实验代码-1" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>代码出现问题, 获取0地址时为0;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_21_TLB.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PUCHAR addr1 = <span class="literal">NULL</span>;</span><br><span class="line">PUCHAR addr2 = <span class="literal">NULL</span>;</span><br><span class="line">ULONG temp1 = <span class="number">0</span>, temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>  __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">pushad;</span><br><span class="line">pushfd;</span><br><span class="line">push <span class="number">0x30</span>;</span><br><span class="line">pop fs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov eax, [addr1]; <span class="comment">// 线形地址1, 使用原始汇编代码, 注释代码会导致系统蓝屏</span></span><br><span class="line">shr eax, <span class="number">0x9</span>;</span><br><span class="line"><span class="keyword">and</span> eax, <span class="number">0x7ffff8</span>;</span><br><span class="line">mov ecx, [eax<span class="number">-0x3FFFFFFC</span>];</span><br><span class="line">sub eax, <span class="number">0x40000000</span>;</span><br><span class="line">mov ecx, [eax];</span><br><span class="line">mov edx, [eax + <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//int 3;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000000</span>], ecx;</span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000004</span>], edx;</span><br><span class="line">mov eax, dword ptr ds:[<span class="number">0</span>];</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">mov [temp1], eax;</span><br><span class="line"></span><br><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov eax, [addr2]; // 线形地址2</span></span><br><span class="line"><span class="comment">//shr eax, 0x9;</span></span><br><span class="line"><span class="comment">//and eax, 0x7ffff8;</span></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000000], ecx;</span></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000004], edx;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds : [0];</span></span><br><span class="line"><span class="comment">//mov [temp2], eax;</span></span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">popfd;</span><br><span class="line">popad;</span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">addr1 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">addr2 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">*(PUCHAR)addr1 = <span class="number">0x1000</span>;</span><br><span class="line">*(PUCHAR)addr2 = <span class="number">0x2000</span>;</span><br><span class="line"></span><br><span class="line">temp1 = <span class="number">0</span>;</span><br><span class="line">temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;addr1 = %x, addr2 = %x, test = %x\r\n&quot;</span>, addr1, addr2, test);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push fs;</span></span><br><span class="line">call fword ptr bufcode;</span><br><span class="line"><span class="comment">// pop fs;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;temp1 = %x, temp2 = %x\r\n&quot;</span>, temp1, temp2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="刷新CR3"><a href="#刷新CR3" class="headerlink" title="刷新CR3"></a>刷新CR3</h3><blockquote><ol><li>当切换CR3的时候, CPU就认为在切换不同的页表; 当页表发生变化的时候, TLB就会产生一个刷新; 凡是G位等于0的通通刷新掉; 刷新除G位为1的情况;<br>切换线程的时候, 判断当前被切换与切换是否是一个进程, 如果不是, 会切换页表（CR3）;</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>把地址变为无效缓存; 刷新一条</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invlpg dword ptr ds:[<span class="number">0</span>];<span class="comment">// 强制刷新TLB中某一行</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>CR4控制寄存器中有一个PGE位, 这个是控制所有的G位是否有效; 刷新所有;</li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;缓存&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页下</title>
    <link href="http://example.com/2d7503f2.html"/>
    <id>http://example.com/2d7503f2.html</id>
    <published>2024-10-17T01:01:28.000Z</published>
    <updated>2024-10-17T15:48:19.838Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表基址</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><blockquote><p>线性地址和物理地址是一对一映射关系, 等价映射;</p></blockquote><blockquote><p>每个进程在高地址中有4兆空间是不共享的, 他指向的是本进程的PDE和PTE;</p></blockquote><blockquote><p>判断一个线性地址是否有效？</p></blockquote><ol><li>如果是PDE.p &#x3D; 1并且PS&#x3D;1, 那么有效</li><li>如果PDE.p&#x3D;1 PS&#x3D;0, PTE.p&#x3D;1 PTE.PAT&#x3D;0, 有效</li></ol><h3 id="101012下页表基址计算"><a href="#101012下页表基址计算" class="headerlink" title="101012下页表基址计算"></a>101012下页表基址计算</h3><ul><li>汇编代码<blockquote><p>MiIsAddressValid（线性地址有效性验证函数）</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0048</span>DBB8                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">0048</span>DBBA                 shr     eax, <span class="number">14</span>h        ; 右移动 <span class="number">20</span>位 eax &gt;&gt; <span class="number">20</span></span><br><span class="line">.text:<span class="number">0048</span>DBBD                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FCh      ; (eax &gt;&gt; <span class="number">20</span>) &amp; ffc</span><br><span class="line">.text:<span class="number">0048</span>DBC2                 sub     eax, <span class="number">3F</span>D00000h</span><br><span class="line">.text:<span class="number">0048</span>DBC7                 mov     eax, [eax]      ; C0300000是一个起始地址</span><br><span class="line">.text:<span class="number">0048</span>DBC9                 test    al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBCB                 jnz     <span class="type">short</span> loc_48DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBCD loc_48DBCD:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">32</span>↓j</span><br><span class="line">.text:<span class="number">0048</span>DBCD                 <span class="keyword">xor</span>     al, al</span><br><span class="line">.text:<span class="number">0048</span>DBCF                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBD0 loc_48DBD0:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">13</span>↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD0                 test    al, al</span><br><span class="line">.text:<span class="number">0048</span>DBD2                 jns     <span class="type">short</span> loc_48DBD7 ; 判断是否是大页</span><br><span class="line">.text:<span class="number">0048</span>DBD4                 mov     al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBD6                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD7</span><br><span class="line">.text:<span class="number">0048</span>DBD7 loc_48DBD7:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">1</span>A↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD7                 shr     ecx, <span class="number">0</span>Ah</span><br><span class="line">.text:<span class="number">0048</span>DBDA                 <span class="keyword">and</span>     ecx, <span class="number">3F</span>FFFCh</span><br><span class="line">.text:<span class="number">0048</span>DBE0                 sub     ecx, <span class="number">40000000</span>h  ; C0000000</span><br><span class="line">.text:<span class="number">0048</span>DBE6                 mov     eax, [ecx]</span><br><span class="line">.text:<span class="number">0048</span>DBE8                 test    al, <span class="number">1</span>           ; PTE</span><br><span class="line">.text:<span class="number">0048</span>DBEA                 jz      <span class="type">short</span> loc_48DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBEC                 <span class="keyword">and</span>     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBEE                 cmp     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBF0                 setnz   al</span><br><span class="line">.text:<span class="number">0048</span>DBF3                 retn</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>C0300000 PDE基址<br>C0300000 + ((线性地址 &gt;&gt; 0x14) &amp; 0xFFC)</p></blockquote><blockquote><p>C0000000 PTE基址<br>C000000 + ((线性地址 &gt;&gt; 0xA) &amp; 0x3FFFFC)</p></blockquote><h3 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h3><blockquote><p>最大能支持36根地址总线<br>2^32 &#x3D; 4G<br>2^33 &#x3D; 4G * 2 &#x3D; 8G<br>2^36 &#x3D; 4G*2^4 &#x3D; 64G</p></blockquote><h2 id="2-9-9-12分页"><a href="#2-9-9-12分页" class="headerlink" title="2-9-9-12分页"></a>2-9-9-12分页</h2><blockquote><ol><li>2^2 &#x3D; 4, 有4种（00, 01, 10, 11）, 所以CR3是以0x20来递增的;</li></ol></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><ol><li>2-9-9-12拆法;</li><li>逆向分析2-9-9-12分页模式下内核函数MmIsAddressValied;</li><li>通过调用门进入R0修改高2G的所有PDE、PTE的u&#x2F;s位, 然后返回应用层访问高地址, 分页模式10-10-12;</li></ol>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表基址&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页表</title>
    <link href="http://example.com/1d0822fc.html"/>
    <id>http://example.com/1d0822fc.html</id>
    <published>2024-10-14T01:22:18.000Z</published>
    <updated>2024-10-17T01:01:20.225Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="内核文件"><a href="#内核文件" class="headerlink" title="内核文件"></a>内核文件</h3><blockquote><p>32位特有的</p></blockquote><ul><li>如果是29912分页, 运行的内核 ntkrnlpa.exe;</li><li>如果是101012分页, 运行的内核 ntoskrnl.exe;</li></ul><blockquote><p>C:\Windows\System32\drivers目录下保存的都是一些系统驱动;</p></blockquote><blockquote><ol><li>线性地址一致, 为什么内存数据不一致</li><li>物理内存小于虚拟内存</li></ol></blockquote><h3 id="物理地址的拆分"><a href="#物理地址的拆分" class="headerlink" title="物理地址的拆分"></a>物理地址的拆分</h3><blockquote><p>10-10-12分页拆分</p></blockquote><ol><li>在notepad中键入字符串后使用CE找到该字符串的逻辑地址: 0009DE08</li><li>拆分地址<br>0009DE08 &#x3D;&gt; 0000 0000 0000 | 0000 1001 1101 | 1110 0000 1000<br>0000 0000 0000  &#x3D;&gt; 0        &#x2F;&#x2F; 页目录项<br>0000 1001 1101  &#x3D;&gt; 09D      &#x2F;&#x2F; 页表项<br>1110 0000 1000  &#x3D;&gt; E08      &#x2F;&#x2F; 页内偏移</li><li>在WinDBG中查找<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先使用命令!process 0 0找到notepad进程的CR3</span></span><br><span class="line"><span class="comment">// 注意：物理内存要使用感叹号(!)</span></span><br><span class="line"></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000            <span class="comment">// notepad进程的CR3（代表这本书）</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000+<span class="number">0</span>*<span class="number">4</span>        <span class="comment">// 每一项代表的是指针, 32位下为4字节, 所以需要乘以4</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c1ce000+<span class="number">09</span>D*<span class="number">4</span>      <span class="comment">// 去除最后的12位（后面的12位在页目录下代表了注意事项, 也就是属性）, 然后加上页表项09D</span></span><br><span class="line">#<span class="number">1</span>c1ce274 <span class="number">2</span>cea5867 <span class="number">212f</span>c867 <span class="number">27</span>c7e867 <span class="number">2</span>d13f867</span><br><span class="line">#<span class="number">1</span>c1ce284 <span class="number">20f</span>43867 <span class="number">28843867</span> <span class="number">286</span>c3867 <span class="number">03244867</span></span><br><span class="line">#<span class="number">1</span>c1ce294 <span class="number">02b</span>85847 <span class="number">3038b</span>867 <span class="number">0</span>a4ca847 <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2a4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2b4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2c4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2d4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2e4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2</span>cea5000+E08        <span class="comment">// 同样去除后12位后加上页内偏移后找到这个字</span></span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">00620061</span> <span class="number">00640063</span> <span class="number">00320031</span> <span class="number">00340033</span></span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">00370035</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00000000</span> <span class="number">005f</span>0004 <span class="number">59f</span>3c08e <span class="number">0800730b</span></span><br><span class="line">#<span class="number">2</span>cea5e58 <span class="number">000</span>a1aa0 <span class="number">000</span>a1c20 <span class="number">5</span>cf3c08b <span class="number">08007303</span></span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">00000409</span> <span class="number">0019f</span>2e0 <span class="number">0019f</span>220 <span class="number">0019f</span>2e0</span><br><span class="line">#<span class="number">2</span>cea5e78 <span class="number">001865</span>cc <span class="number">00000003</span> <span class="number">0019</span>ee7c <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">2</span>cea5000+E08</span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">61</span> <span class="number">00</span> <span class="number">62</span> <span class="number">00</span> <span class="number">63</span> <span class="number">00</span> <span class="number">64</span> <span class="number">00</span><span class="number">-31</span> <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">33</span> <span class="number">00</span> <span class="number">34</span> <span class="number">00</span> a.b.c.d<span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.4</span>.</span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">35</span> <span class="number">00</span> <span class="number">37</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5.7</span>.............</span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">5f</span> <span class="number">00</span><span class="number">-8</span>e c0 f3 <span class="number">59</span> <span class="number">0b</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> ......_....Y.s..</span><br><span class="line">#<span class="number">2</span>cea5e58 a0 <span class="number">1</span>a <span class="number">0</span>a <span class="number">00</span> <span class="number">20</span> <span class="number">1</span>c <span class="number">0</span>a <span class="number">00</span><span class="number">-8b</span> c0 f3 <span class="number">5</span>c <span class="number">03</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> .... ......\.s..</span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">09</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span><span class="number">-20</span> f2 <span class="number">19</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span> ........ .......</span><br><span class="line">#<span class="number">2</span>cea5e78 cc <span class="number">65</span> <span class="number">18</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-7</span>c ee <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> .e......|.......</span><br></pre></td></tr></table></figure></li></ol><h3 id="计算一次缓存的字节数"><a href="#计算一次缓存的字节数" class="headerlink" title="计算一次缓存的字节数"></a>计算一次缓存的字节数</h3><blockquote><p>总字节数 &#x2F; linesize &#x2F; x way &#x3D; y组<br>y 组 &#x2F; x way &#x3D; 1组z行     z行 * linesize &#x3D; 一组缓存的字节数<br>(32K * 1024) &#x2F; 64 &#x2F; 8 &#x3D; 总组数（64）<br>64（总组数） &#x2F; 8 &#x3D; 8行<br>8 * 64字节 &#x3D; 512组的字节数</p></blockquote><h2 id="P-US-RW"><a href="#P-US-RW" class="headerlink" title="P_US_RW"></a>P_US_RW</h2><blockquote><p>PDE和PTE是与的关系（PDE.arr &amp; PTE.arr）, 最后得出为1的才是有效的;</p></blockquote><h3 id="P位"><a href="#P位" class="headerlink" title="P位"></a>P位</h3><blockquote><p>如果是PDE的P位置0, 那么代表PTT为无效;<br>如果是PTE的P为置0, 那么代表物理页为无效;</p></blockquote><h3 id="R-W位"><a href="#R-W位" class="headerlink" title="R&#x2F;W位"></a>R&#x2F;W位</h3><blockquote><p>R&#x2F;W位为0, 代表只读;<br>R&#x2F;W位为1, 代表可写;</p></blockquote><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>a57 b30 &#x3D;&gt; 0000 0000 10 | 10 0101 0111 | 1011 0011 0000<br>0000 0000 0010  &#x3D;&gt; 2<br>0010 0101 0111  &#x3D;&gt; 257<br>1011 0011 0000  &#x3D;&gt; b30</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1622e000</span>+<span class="number">2</span>*<span class="number">4</span>        <span class="comment">// 1622e000为实验程序的CR3, PDE(18996867)最后一位为7(0111), 证明可写</span></span><br><span class="line">#<span class="number">1622e008</span> <span class="number">18996867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e018</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e028</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e038</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e048</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e058</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e068</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e078</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">18996000</span>+<span class="number">257</span>*<span class="number">4</span>      <span class="comment">// 去除后12位加上页表项乘以4, PTE(0abb8005)最后一位为5(0101), 证明不可写</span></span><br><span class="line">#<span class="number">1899695</span>c <span class="number">0</span>abb8005 <span class="number">1</span>cc79005 <span class="number">00000000</span> <span class="number">19352847</span></span><br><span class="line">#<span class="number">1899696</span>c <span class="number">31b</span>a6005 <span class="number">09e2</span>f205 <span class="number">3685e005</span> <span class="number">3</span>d0da005</span><br><span class="line">#<span class="number">1899697</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899698</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899699</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>ac <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969b</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>cc <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">1899695</span>c <span class="number">0</span>abb8007   <span class="comment">// 将0abb8005修改为0abb8007, PTE(0abb8007)最后一位为7(0111), &amp;之后R/W位为1, 修改为可写状态</span></span><br><span class="line">kd&gt; !dd <span class="number">0</span>abb8000+b30</span><br><span class="line"># abb8b30 <span class="number">61647361</span> <span class="number">73676473</span> <span class="number">00616664</span> <span class="number">00000000</span></span><br><span class="line"># abb8b40 <span class="number">0</span>a0d7825 <span class="number">00000000</span> <span class="number">73756170</span> <span class="number">00000065</span></span><br><span class="line"># abb8b50 <span class="number">0</span>a0d7325 <span class="number">00000000</span> <span class="number">00</span>a57c18 <span class="number">00</span>a57d28</span><br><span class="line"># abb8b60 <span class="number">00</span>a57e80 <span class="number">00</span>a57ea4 <span class="number">00</span>a57ee4 <span class="number">00</span>a57f18</span><br><span class="line"># abb8b70 <span class="number">00000001</span> <span class="number">00000000</span> <span class="number">00000001</span> <span class="number">00000001</span></span><br><span class="line"># abb8b80 <span class="number">00000001</span> <span class="number">00000001</span> <span class="number">63617453</span> <span class="number">7261206b</span></span><br><span class="line"># abb8b90 <span class="number">646e756</span>f <span class="number">65687420</span> <span class="number">72617620</span> <span class="number">6</span>c626169</span><br><span class="line"># abb8ba0 <span class="number">00272065</span> <span class="number">61772027</span> <span class="number">6f</span>632073 <span class="number">70757272</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30       <span class="comment">// 实验程序中的字符串</span></span><br><span class="line"># abb8b30 <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> asdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br><span class="line">kd&gt; g</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30        <span class="comment">// 已经被修改</span></span><br><span class="line"># abb8b30 <span class="number">31</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>sdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> *x = (<span class="type">char</span>*)<span class="string">&quot;asdasdgsdfa&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line">x[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="U-S位（user-super）"><a href="#U-S位（user-super）" class="headerlink" title="U&#x2F;S位（user&#x2F;super）"></a>U&#x2F;S位（user&#x2F;super）</h3><blockquote><p>如果U&#x2F;S位为0, 代表只有内核可以访问页;<br>如果U&#x2F;S位为1, 代表三环可以访问页;</p></blockquote><h4 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>80b98800 &#x3D;&gt; 0010 0000 0010 | 0011 1001 1000 | 1000 0000 0000<br>0010 0000 0010 &#x3D;&gt; 202 &#x2F;&#x2F; 前面的往后移, 前面补0<br>0011 1001 1000 &#x3D;&gt; 398<br>1000 0000 0000 &#x3D;&gt; 100</li></ol></blockquote><blockquote><ol start="2"><li>查询gdtr属性</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x80b98800</span>     <span class="comment">// 查询默认gdtr地址</span></span><br><span class="line">                 VA <span class="number">80b</span>98800</span><br><span class="line">PDE at C0300808         PTE at C0202E60</span><br><span class="line">contains <span class="number">0018</span>A063       contains <span class="number">00B</span>98163   <span class="comment">// 最后一位是3（0011）, 代表P位和R/W位有值, U/S位为0, 意味着用户模式下访问不到, 只能内核访问</span></span><br><span class="line">pfn <span class="number">18</span>a   ---DA--KWEV   pfn b98   -G-DA--KWEV</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span>      <span class="comment">// 获取当前进程的PDE</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a063 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !ed <span class="number">199</span>a808 <span class="number">0018</span>a067    <span class="comment">// 设置PDE中U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a067 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span>      <span class="comment">// 查询当前进程的PTE</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98163 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98167     <span class="comment">// 设置PTE的U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98167 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98167</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98067         <span class="comment">// 设置PTE的G位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98067 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98067</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br></pre></td></tr></table></figure><blockquote><ol start="4"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// u/s位代码试验</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sgdt buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> address = *(PULONG)&amp;buf[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> * x = (<span class="type">int</span>*)address;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, *x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="A位"><a href="#A位" class="headerlink" title="A位"></a>A位</h3><blockquote><p>不是人为设置, 如果从来没有访问过可能是个0, 一旦访问过一次（读或者写）就会变成1;</p></blockquote><h3 id="G位（全局页）"><a href="#G位（全局页）" class="headerlink" title="G位（全局页）"></a>G位（全局页）</h3><h2 id="挂页（幽灵地址）"><a href="#挂页（幽灵地址）" class="headerlink" title="挂页（幽灵地址）"></a>挂页（幽灵地址）</h2><h3 id="申请内存并挂到0地址上"><a href="#申请内存并挂到0地址上" class="headerlink" title="申请内存并挂到0地址上"></a>申请内存并挂到0地址上</h3><blockquote><ol><li>拆地址<br>1d0000 &#x3D;&gt; 0000 0000 00 | 01 1101 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1101 0000 &#x3D;&gt; 1d0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 04922847</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000        <span class="comment">// 通过CR3获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>+<span class="number">1</span>d0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">23325740</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325750</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325760</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325770</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325780</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325790</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257</span>a0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257b</span>0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">04922000</span>            <span class="comment">// 查看PTE</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000            <span class="comment">// 获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>            <span class="comment">// 查看PDE</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">23325000</span> <span class="number">04922847</span>       <span class="comment">// 将PDE指针指向PTE的值（04922847）</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; g</span><br><span class="line">Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">04922000</span>        <span class="comment">// 成功修改成100（0x64）</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> d...............</span><br><span class="line"># <span class="number">4922010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * x = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">*x = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在本进程中的0地址上执行shellcode"><a href="#在本进程中的0地址上执行shellcode" class="headerlink" title="在本进程中的0地址上执行shellcode"></a>在本进程中的0地址上执行shellcode</h3><blockquote><ol><li>拆地址<br>2f0000 &#x3D;&gt; 0000 0000 00 | 10 1111 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0010 1111 0000 &#x3D;&gt; 2f0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 0a512867</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">20f</span>6a000        <span class="comment">// 根据进程CR3获取PDE</span></span><br><span class="line">#<span class="number">20f</span>6a000 <span class="number">38736867</span> <span class="number">03</span>c45867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>+<span class="number">2f</span>0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">38736b</span>c0 <span class="number">0</span>a512867 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>d0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>e0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>f0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c00 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c10 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c20 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c30 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>a512000            <span class="comment">// 查看数据</span></span><br><span class="line"># a512000 <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># a512010 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512020 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512030 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512040 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512050 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512060 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512070 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>            <span class="comment">// 查看0地址</span></span><br><span class="line">#<span class="number">38736000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736040</span> <span class="number">0</span>c350847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">38736000</span> <span class="number">0</span>a512867       <span class="comment">// 将PTE（0a512867）挂到0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="built_in">func</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将物理页挂到其他进程并执行shellcode"><a href="#将物理页挂到其他进程并执行shellcode" class="headerlink" title="将物理页挂到其他进程并执行shellcode"></a>将物理页挂到其他进程并执行shellcode</h3><div class="note red bug"><p><strong>注意</strong></p><ul><li>该实验无法在cheatengine-i386.exe（CE）上成功复现, 在notepad.exe上成功复现;</li></ul></div><blockquote><ol><li>拆地址<br>180000 &#x3D;&gt; 0000 0000 00 | 01 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1000 0000 &#x3D;&gt; 180<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li>notepad.exe进程信息<br>PROCESS 87460570  SessionId: 1  Cid: 0978    Peb: 7ffda000  ParentCid: 0a48<br>  DirBase: 015de000  ObjectTable: b3a87c30  HandleCount:  60.<br>  Image: notepad.exe</li><li>实验进程信息<br>PROCESS 87620030  SessionId: 1  Cid: 03f8    Peb: 7ffdc000  ParentCid: 060c<br>  DirBase: 03005000  ObjectTable: a4d11110  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">03005000</span>            <span class="comment">// 首先通过本进程的CR3获取PDE</span></span><br><span class="line"># <span class="number">3005000</span> <span class="number">22</span>edd867 <span class="number">1f</span>d2e867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">22</span>edd000+<span class="number">180</span>*<span class="number">4</span>      <span class="comment">// 获取本进程的PTE</span></span><br><span class="line">#<span class="number">22</span>edd600 <span class="number">27e84867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd610 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd620 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd630 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd640 <span class="number">39944005</span> <span class="number">381</span>d4867 <span class="number">1f</span>dd5867 <span class="number">021</span>d6867</span><br><span class="line">#<span class="number">22</span>edd650 <span class="number">36457867</span> <span class="number">29b</span>d8867 <span class="number">1</span>d119867 <span class="number">22b</span>1a867</span><br><span class="line">#<span class="number">22</span>edd660 <span class="number">3175</span>c867 <span class="number">30</span>d5d867 <span class="number">2e620867</span> <span class="number">291</span>a1867</span><br><span class="line">#<span class="number">22</span>edd670 <span class="number">29f</span>21867 <span class="number">14</span>a62867 <span class="number">253e2867</span> <span class="number">03</span>c23867</span><br><span class="line">kd&gt; !db <span class="number">27e84000</span>            <span class="comment">// 查看数据</span></span><br><span class="line">#<span class="number">27e84000</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line">#<span class="number">27e84010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">015</span>de000            <span class="comment">// 通过notepad.exe的CR3获取PDE</span></span><br><span class="line"># <span class="number">15</span>de000 <span class="number">3b</span>822867 <span class="number">37</span>a23867 <span class="number">0</span>c64e867 <span class="number">07f</span>55867</span><br><span class="line"># <span class="number">15</span>de010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">29f</span>af867</span><br><span class="line"># <span class="number">15</span>de020 <span class="number">285b</span>3867 <span class="number">38</span>cf1867 <span class="number">023f</span>5867 <span class="number">04737867</span></span><br><span class="line"># <span class="number">15</span>de030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">3b</span>822000            <span class="comment">// 查看notepad.exe的PTE</span></span><br><span class="line">#<span class="number">3b</span>822000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822040 <span class="number">321f</span>8847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">3b</span>822000 <span class="number">27e84867</span>       <span class="comment">// 将进程的PTE挂到notepad.exe的0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">2424</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="带页内偏移挂页"><a href="#带页内偏移挂页" class="headerlink" title="带页内偏移挂页"></a>带页内偏移挂页</h3><blockquote><ol><li>拆地址<br>80000 &#x3D;&gt; 0000 0000 00 | 00 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0000 1000 0000 &#x3D;&gt; 080<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li><p>notepad.exe进程信息<br>PROCESS 87564030  SessionId: 1  Cid: 129c    Peb: 7ffdf000  ParentCid: 0a48<br>  DirBase: 34cc7000  ObjectTable: 95581928  HandleCount:  60.<br>  Image: notepad.exe</p></li><li><p>实验程序进程信息<br>PROCESS 86d307c8  SessionId: 1  Cid: 151c    Peb: 7ffd9000  ParentCid: 1478<br>  DirBase: 1611b000  ObjectTable: 954c7388  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1611b</span>000        <span class="comment">// 通过实验程序获取PDE</span></span><br><span class="line">#<span class="number">1611b</span>000 <span class="number">2915f</span>867 <span class="number">0</span>c066867 <span class="number">00000000</span> <span class="number">05</span>cdc867</span><br><span class="line">#<span class="number">1611b</span>010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2915f</span>000+<span class="number">080</span>*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">2915f</span>200 <span class="number">06204867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>210 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>220 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>230 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>240 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>250 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>260 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>270 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">06204000</span>            <span class="comment">// 查看数据</span></span><br><span class="line"># <span class="number">6204000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">06204000</span>+<span class="number">0x100</span>      <span class="comment">// 由于页内偏移为0x100, 所以需要加上0x100</span></span><br><span class="line"># <span class="number">6204100</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># <span class="number">6204110</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204120</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204130</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204140</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204150</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204160</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204170</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">34</span>cc7000            <span class="comment">// 获取notepad.exe的PDE</span></span><br><span class="line">#<span class="number">34</span>cc7000 <span class="number">09f</span>40867 <span class="number">3</span>af52867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7010 <span class="number">26825867</span> <span class="number">22b</span>e6867 <span class="number">0</span>c4c7867 <span class="number">30</span>d00867</span><br><span class="line">#<span class="number">34</span>cc7020 <span class="number">3</span>d901867 <span class="number">00000000</span> <span class="number">26f</span>d8867 <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">09f</span>40000            <span class="comment">// 获取notepad.exe的PTE</span></span><br><span class="line"># <span class="number">9f</span>40000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40040 <span class="number">28f</span>16847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">09f</span>40000 <span class="number">06204867</span>   <span class="comment">// 将实验程序的PTE挂到notepad.exe的0地址上</span></span><br><span class="line">kd&gt; g</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> * mem = (<span class="type">char</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem+<span class="number">0x100</span>, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">4764</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)<span class="number">0x100</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页表配置</title>
    <link href="http://example.com/220f9f18.html"/>
    <id>http://example.com/220f9f18.html</id>
    <published>2024-10-13T14:54:31.000Z</published>
    <updated>2024-10-14T01:21:57.880Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表配置</strong></p></div><span id="more"></span><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul><li>关闭pae选项<br>bcdedit &#x2F;set pae ForceDisable</li><li>设置nx<br>bcdedit &#x2F;set nx AlwaysOff</li></ul>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表配置&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-中断门</title>
    <link href="http://example.com/7297abab.html"/>
    <id>http://example.com/7297abab.html</id>
    <published>2024-10-11T01:13:13.000Z</published>
    <updated>2024-10-13T14:41:28.889Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>中断门</strong></p></div><span id="more"></span><h2 id="中断门知识点"><a href="#中断门知识点" class="headerlink" title="中断门知识点"></a>中断门知识点</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li><p>int 32的计算: 80b98100 - 80b98000 &#x3D; 100（16进制） &#x2F; 8 &#x3D; 20 &#x3D;&gt; 32（10进制）</p></li><li><p>填充中断门描述符, 函数地址是: 00401080;<br>0040ee00&#96;00081080</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">00000000</span>`<span class="number">00080000</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br><span class="line"></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98100 <span class="number">0040</span>ee00`<span class="number">00081080</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">0040</span>ee00`<span class="number">00081080</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br></pre></td></tr></table></figure></li><li><p>中断门0环堆栈压了五个值, eip, cs, eflags, esp, ss, 3环堆栈无内容;<br>3环寄存器:<br>EAX &#x3D; 00000000 EBX &#x3D; 7FFD5000 ECX &#x3D; BFBDF6C4 EDX &#x3D; 005F0178 ESI &#x3D; 0012FE3C EDI &#x3D; 0012FF08 EIP &#x3D; 004011A7 ESP &#x3D; <code>0012FE3C</code> EBP &#x3D; 0012FF08 EFL &#x3D; 00000246<br>CS &#x3D; 001B DS &#x3D; 0023 ES &#x3D; 0023 SS &#x3D; 0023 FS &#x3D; 003B GS &#x3D; 0000<br>0环寄存器:<br>eax&#x3D;00000000 ebx&#x3D;7ffd5000 ecx&#x3D;bfbdf6c4 edx&#x3D;005f0178 esi&#x3D;0012fe3c edi&#x3D;0012ff08<br>eip&#x3D;00401080 esp&#x3D;<code>94e63c9c</code> ebp&#x3D;0012ff08 iopl&#x3D;0         nv up di pl zr na pe nc<br>cs&#x3D;0008  ss&#x3D;0010  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;0030  gs&#x3D;0000             efl&#x3D;00000046</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dds <span class="number">94e63</span>c9c</span><br><span class="line"><span class="number">94e63</span>c9c  <span class="number">004011</span>a9          &lt;== eip</span><br><span class="line"><span class="number">94e63</span>ca0  <span class="number">0000001b</span>          &lt;== cs</span><br><span class="line"><span class="number">94e63</span>ca4  <span class="number">00000246</span>          &lt;== eflags</span><br><span class="line"><span class="number">94e63</span>ca8  <span class="number">0012f</span>e3c          &lt;== esp</span><br><span class="line"><span class="number">94e63</span>cac  <span class="number">00000023</span>          &lt;== ss</span><br><span class="line"><span class="number">94e63</span>cb0  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb4  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb8  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cbc  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cc0  <span class="number">0000027f</span></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_11_InterruptGate(中断门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_GDTINFO</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">short</span> limit;</span><br><span class="line">ULONG table;</span><br><span class="line">&#125;GDTINFO;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="comment">//char bufgdt[6];</span></span><br><span class="line"><span class="comment">//char bufidt[6];</span></span><br><span class="line">GDTINFO gdts;</span><br><span class="line">GDTINFO idts;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*sgdt bufgdt;</span></span><br><span class="line"><span class="comment">sidt bufidt;*/</span></span><br><span class="line">sgdt gdts;          <span class="comment">// 获取gdtr</span></span><br><span class="line">sidt idts;          <span class="comment">// 获取idtr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="IDT和GDT的关联"><a href="#IDT和GDT的关联" class="headerlink" title="IDT和GDT的关联"></a>IDT和GDT的关联</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br></pre></td></tr></table></figure><ul><li>在IDT中, int3中的3代表的是索引;</li><li>83e5ee00<code>00085fc0</code>（int 3）中段选择子0008表示去查找GDT中00cf9b00&#96;0000ffff;</li></ul><h3 id="IDT描述符"><a href="#IDT描述符" class="headerlink" title="IDT描述符"></a>IDT描述符</h3><blockquote><p>5.11 页码123</p></blockquote><ul><li>D位（第11位）是指默认操作数, 32位下为1, 16位下为0;</li></ul><h3 id="3环获取GDT和IDT的指令"><a href="#3环获取GDT和IDT的指令" class="headerlink" title="3环获取GDT和IDT的指令"></a>3环获取GDT和IDT的指令</h3><ul><li><p>获取GDT&#x2F;获取IDT: sgdt&#x2F;sidt（3环下调用）;</p><blockquote><p>获取到gdt的值为<code>ff 03 00 88 b9 80</code>; 其中前两个字节为表的长度, 后四个字节为表的地址; </p></blockquote></li><li><p>修改GDT&#x2F;修改IDT: lgdt&#x2F;lidt（0环下才能调用）;</p></li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><blockquote><p>iretd中的<code>d</code>描述宽度用的; 16位（iret）、32位（iretd）、64位（iretq）;</p></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>返回一定要用iretd吗? 使用retf;</li></ol></blockquote><ul><li>iretd 解除阻塞;</li><li>retf 没有解除阻塞;</li><li>sti 解除阻塞, 并且给eflags.IF &#x3D; 1;</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InterruptGate_retf.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断门使用retf返回</span></span><br><span class="line"><span class="comment">// 0040ee00`00081080 </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sti;<span class="comment">// 解除阻塞, 并且使eflags.IF = 1</span></span><br><span class="line"><span class="comment">// int 3</span></span><br><span class="line">retf <span class="number">4</span>;<span class="comment">// 使用 retf 4 是为了确保在中断处理程序返回时，除了恢复 CS:EIP 外，还能从栈中弹出这个附加的 4 字节（通常是错误代码），确保栈平衡</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push 0x12345678;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>构建陷阱门自己调用;</li></ol></blockquote><ul><li>TYPE位为f, 0040ee00&#96;00081080;</li></ul><div class="note bug"><p><strong>中断门和陷阱门的区别</strong></p><p>1.<br>进入中断门会清除eflag VM NT IF TF 位<br>进入陷阱门会清除eflag VM NT TF 位<br>2.<br>由于中断门会清除IF位，导致一些中断触发会悬挂，陷阱门则不会</p></div><h2 id="int3-hook"><a href="#int3-hook" class="headerlink" title="int3_hook"></a>int3_hook</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>第一步：添加一个代码段在0x48位置</li><li>第二步：计算代码段0x48的base<br> 目标地址 - int 3偏移&#x3D; base<br> 写回0x48位置</li><li>第三步：修改int 3中断门的段选择子为0x48</li><li>Hook函数编写<br> 由于有缓存的存在, 可以执行一会, 那么我们在这要做二次跳转<br> jmp 0x48: xxx地址</li><li>当调到xxx地址后, 通过调用打印函数, 确定调用成功</li><li>jmp回int 3原本的偏移</li></ol><div class="note info"><p><strong></strong></p><p>base：401080 - 83e44fc0(int 3) &#x3D; 7C5B C0C0</p><p>段描述：00cf9b00&#96;0000ffff</p><p>修改gdtr 0x48位置<br>eq 80b98848 7Ccf9b5B&#96;C0C0ffff</p><p>修改int 3段选择子为48<br>eq 80b98018 83e7ee00&#96;0048dfc0</p><p>83e11c60</p></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_24_int3_hook.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BASE：401080 - 83e7dfc0(int 3) = 7C58 30C0</span></span><br><span class="line"><span class="comment">// 段描述：00cf9b00`0000ffff</span></span><br><span class="line"><span class="comment">// 修改GDTR：eq 80b98848 7Ccf9b58`30c0ffff</span></span><br><span class="line"><span class="comment">// 修改IDTR：eq 80b98018 83e7ee00`0048dfc0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span><span class="params">(__CRTDECL *DbgPrintProc)</span><span class="params">(_In_z_ _Printf_format_string_ <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> _Format, ...)</span></span>;</span><br><span class="line">DbgPrintProc DbgPrint = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> * xxxstr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//push 0x8;</span></span><br><span class="line"><span class="comment">//push haha;</span></span><br><span class="line">sub esp, <span class="number">8</span>;</span><br><span class="line">lea eax, haha;</span><br><span class="line">mov [esp], eax;</span><br><span class="line">mov [esp+<span class="number">4</span>], <span class="number">0x8</span>;</span><br><span class="line">jmp fword ptr [esp];</span><br><span class="line">haha:</span><br><span class="line">add esp, <span class="number">8</span>;</span><br><span class="line">push fs;</span><br><span class="line">mov ax, <span class="number">0x30</span>;</span><br><span class="line">mov fs, ax;</span><br><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line">mov eax, [xxxstr];</span><br><span class="line">push eax;</span><br><span class="line">call DbgPrint;</span><br><span class="line">add esp, <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">pop fs;</span><br><span class="line"><span class="comment">// 跳回int3</span></span><br><span class="line">mov dword ptr ss:[esp<span class="number">-4</span>], <span class="number">0x83e44fc0</span>;</span><br><span class="line">jmp dword ptr ss:[esp<span class="number">-4</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line">xxxstr = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(xxxstr, <span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>));</span><br><span class="line">xxxstr[<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">DbgPrint = (DbgPrintProc)<span class="number">0x83e11c60</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;中断门&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-调用门提权</title>
    <link href="http://example.com/fb02f1f0.html"/>
    <id>http://example.com/fb02f1f0.html</id>
    <published>2024-10-10T14:40:57.000Z</published>
    <updated>2024-10-11T15:47:38.553Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>调用门提权</strong></p></div><span id="more"></span><h2 id="调用门知识点"><a href="#调用门知识点" class="headerlink" title="调用门知识点"></a>调用门知识点</h2><blockquote><p>当S位为0, TYPE位为C, 这个就是调用门;</p></blockquote><blockquote><p>cs.DPL &#x3D;&#x3D; ss.DPL &#x3D;&#x3D; 调用门.DPL;</p></blockquote><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li>填充调用门描述符（参数暂时为0个）; 函数地址为00401080;<br>0040ec00&#96;00081080</li><li>修改gdtr<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure></li><li>cs寄存器为0008, ss寄存器为0010<blockquote><p>cs + 8 &#x3D; ss</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">7f</span>fd6000 ecx=<span class="number">4</span>a36ab6a edx=<span class="number">0052017</span>c esi=<span class="number">0012f</span>e28 edi=<span class="number">0012f</span>f08</span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">89b</span>49c98 ebp=<span class="number">0012f</span>f08 iopl=<span class="number">0</span>         nv up ei pl zr na pe nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li>返回时报错<blockquote><p>进入0环前fs寄存器为0x3b, 进入0环后会将fs修改成0x30, 在返回时未进行修复;</p></blockquote></li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_10_CallGate(调用门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line">call fword ptr bufcode;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权只压两个值（eip, cs）; 跨段提权会压四个值（eip, cs, esp, ss）;</p></blockquote><blockquote><p>retf有参数时需要加上参数, 两个参数retf 8;</p></blockquote><h3 id="系统描述符类型"><a href="#系统描述符类型" class="headerlink" title="系统描述符类型"></a>系统描述符类型</h3><p>当段描述符的S标志（描述符类型）为0, 则描述符为系统描述符。处理器可以识别以下类型的系统描述符: </p><ul><li>局部描述符表（LDT）段描述符;</li><li>任务状态段（TSS）描述符;</li><li>调用门描述符;</li><li>中断门描述符;</li><li>陷阱门描述符;</li><li>任务门描述符;</li></ul><blockquote><p>这些描述符又可以分为两类: 系统段描述符和门描述符。系统段描述符指向系统段（LDT和TSS段）。门描述符它们自身就是”门”, 它们或者持有指向放置在代码段中的过程入口点的指针, 或者持有TSS（任务门）的段选择子。</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png' data-fancybox='default' data-caption='系统段和门描述类型'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="系统段和门描述类型"></a><span class='image-caption'>系统段和门描述类型</span></div></div><h3 id="调用门格式"><a href="#调用门格式" class="headerlink" title="调用门格式"></a>调用门格式</h3><blockquote><p>4.8.3, 页码是93;</p></blockquote><blockquote><p>调用门为不同特权级间的进程控制转移提供了便利。它们一般只用在使用特权级保护机制的操作系统或管理程序中。调用门也可用于16位和32位代码段之间进程控制转移, 这在17.4.“混合尺寸代码段之间的控制转移”中进行描述。</p></blockquote><blockquote><p>调用门描述符可用在GDT或LDT中, 但是不能在中断描述符表（IDT）中。它具有六个方面的功能:</p></blockquote><ul><li>确定将要访问的代码段;</li><li>定义例程在指定代码段的入口;</li><li>指定调用例程的所应当有的特权级;</li><li>如果有栈切换, 就确定在栈之间拷贝的可选参数的个数;</li><li>定义压入目标栈的值的尺寸: 16位的门执行16位的压栈, 32位的门执行32位的压栈;</li><li>确定调用门描述符是否有效;</li></ul><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>使用jmp跨段跳转调用门;</li></ol></blockquote><ul><li>在调用门上不支持改cs寄存器的值;</li><li>jmp在调用门只能同权限跳转;</li></ul><blockquote><ol start="2"><li>既然ret也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>无法修改cs寄存器的值, 无法提权, 也没有提权的悬念</li></ul><blockquote><ol start="3"><li>既然retf也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>英特尔规定retf只能同权限或向低权限跳转;</li></ul><blockquote><p>补充</p></blockquote><ul><li>call是同权限或者提权跳转</li></ul>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;调用门提权&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-数据段代码段的权限规则</title>
    <link href="http://example.com/93e9d7f1.html"/>
    <id>http://example.com/93e9d7f1.html</id>
    <published>2024-10-08T16:52:16.000Z</published>
    <updated>2024-10-08T18:06:06.493Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>数据段代码段的权限规则</strong></p><ol><li>段的权限规则 代码段、数据段、堆栈段;</li><li>跨段跳转不提权 写法 jmp call;</li></ol></div><span id="more"></span><h2 id="裸函数知识点"><a href="#裸函数知识点" class="headerlink" title="裸函数知识点"></a>裸函数知识点</h2><ul><li>关闭<code>增量链接</code>;</li><li>关闭<code>随机基址</code>;</li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 裸函数 不生成多余汇编代码</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        ret     ;<span class="comment">// 不加ret会导致程序报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据段代码段的权限规则知识点"><a href="#数据段代码段的权限规则知识点" class="headerlink" title="数据段代码段的权限规则知识点"></a>数据段代码段的权限规则知识点</h2><ul><li>DPL: Descriptor privilege level;</li><li>CPL: Current privilege level（CS段描述符的DPL）;</li><li>RPL: Request privilege level;</li></ul><blockquote><p>普通的数据段（DS、ES）下RPL可以乱给的;<br>在堆栈段（SS）下是有用的, RPL &#x3D;&#x3D; CPL &#x3D;&#x3D; DPL才能更改;<br>在代码段（DS）上是没用的, CPL &#x3D;&#x3D; DPL能更改, RPL系统会改回去;</p></blockquote><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权跳转会将ESP和CS压到堆栈中, 所以会是ESP-8;<br>使用<code>retf</code>;</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;数据段代码段的权限规则&lt;/strong&gt;&lt;/p&gt;&lt;ol&gt;&lt;li&gt;段的权限规则 代码段、数据段、堆栈段;&lt;/li&gt;&lt;li&gt;跨段跳转不提权 写法 jmp call;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-段探测</title>
    <link href="http://example.com/b4fed552.html"/>
    <id>http://example.com/b4fed552.html</id>
    <published>2024-09-29T02:26:26.000Z</published>
    <updated>2024-10-11T15:37:05.770Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>段</strong></p></div><span id="more"></span><h2 id="段知识点"><a href="#段知识点" class="headerlink" title="段知识点"></a>段知识点</h2><div class="note info"><p><strong></strong></p><ul><li>CS 代码寄存器 描述的代码</li><li>SS 栈段 描述的栈  比如局部变量</li><li>DS 数据段 堆地址  比如全局变量</li><li>ES 扩展段 串copy movsb so edi esi</li><li>FS 上下文环境段 R3: 代表TEB R0: 代表KPCR</li></ul></div><h3 id="段选择子"><a href="#段选择子" class="headerlink" title="段选择子"></a>段选择子</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png' data-fancybox='default' data-caption='段选择子'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段选择子"></a><span class='image-caption'>段选择子</span></div></div><blockquote><p>段选择子是一个16位的段的标识码。它并不直接指向段, 而是指向定义段的描述符。段选择子包含以下项目:</p></blockquote><ul><li><p>Index(索引): 第3位到第15位。选择GDT或LDT中8192个描述符中的某一个。处理器将索引值乘以8（段描述符的字节数）, 然后加上GDT或LDT的基地址（分别在GDTR寄存器或者LDTR寄存器中）。</p></li><li><p>TI(table indivator) flag: 第2位。确定使用哪一个描述符表: 将这个标志置0, 则表示用GDT。将这个标志置1, 标识用LDT;</p></li><li><p>Request Privilege Level(RPL 请求的特权级): 第0位和第1位。确定选择子的特权级。特权级的范围是0到3, 0为最高特权级。</p></li></ul><h3 id="段描述符"><a href="#段描述符" class="headerlink" title="段描述符"></a>段描述符</h3><blockquote><p><code>段描述符</code>是GDT或LDT中的一个数据结构, 它为处理器提供诸如段基地址、段大小、访问权限以及状态等信息。<code>段描述符</code>主要是由编译器、连接器、装载器或者操作系统&#x2F;管理程序设立的, 而不是由应用程序产生的。 </p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png' data-fancybox='default' data-caption='段描述符'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段描述符"></a><span class='image-caption'>段描述符</span></div></div><h4 id="段描述符中的标志和域"><a href="#段描述符中的标志和域" class="headerlink" title="段描述符中的标志和域"></a>段描述符中的标志和域</h4><blockquote><p>段界限域: 指定段的大小。处理器将两个段界限域合在一起组成一个20位的段界限值。根据G标志位（粒度）的不同设置, 处理器按两种不同的方式解释段界限</p></blockquote><ul><li>如果粒度标志位为0, 则段大小可以从1字节到1M字节, 段长增量单位为字节（以字节为单位）;</li><li>如果粒度标志位为1, 则段大小可以从4K字节到4G字节, 段长增量单位为4K字节（以页为单位 （0xFFFFF +1） * 4096(0x1000) &#x3D; （0xFFFFF +1） * 4096(0x1000) - 1）;</li></ul><blockquote><p>基地址域: 确定段的第一个字节（字节0）在4GB线性地址空间中位置。处理器将3个基地址域组合在一起构成了一个32位地址值。段基地址应当是16字节边界对齐的。16字节边界对齐不是必须的, 当这种段边界的对齐能够是程序把代码和数据对齐到16字节边界上而最大化其性能;</p></blockquote><blockquote><p>类型域: 指明段或门的类型, 确定段的访问权限和增长方向。如何解释这个域, 取决于该描述符是应用程序描述符（代码和数据）还是系统描述符。代码段、数据段和系统段对类型域有不同的编码</p></blockquote><blockquote><p>S(描述符类型)标志: 确定段描述符四系统描述符（S标记为0）或者代码、数据段描述符（S标记为1）;</p></blockquote><blockquote><p>DPL(描述符特权级)域: 指明段的特权级。特权级从0到3, 0为最高特权。DPL用来控制对段的访问;</p></blockquote><blockquote><p>P(段有效位)标志: 指明段当前是否在内存中（1表示在内存中, 0表示不在）。当指向段描述符的段选择子被装进段寄存器时, 如果这个标志为0, 处理器会产生段不存在异常（#NP）。内存管理软件可以通过这个标志, 来控制在某个特定时间有哪些段是真正的被载入物理内存的。这是除分页之外的另一个虚拟内存控制机制;</p></blockquote><blockquote><p>D&#x2F;B(默认操作数大小&#x2F;默认栈指针大小和&#x2F;或上限)标志: 根据段描述符所指的是可执行代码段、向下扩展的数据段还是堆栈段, 这个标志有不同的功能。（对32位的代码和数据段, 这个标志总是被设置成1, 而16位的代码和数据段, 这个标志总是被置为0）</p></blockquote><ul><li><p>可执行代码段: 这个标志被称为D标志, 它指明段中指令的有效地址和操作符的默认位数。如果该标志为1, 则默认32位的地址, 32位或者8位的操作符; 若为0, 则默认16位的地址, 16位或者8位的操作符。指令前缀66H可以指定操作符的长度而不使用缺省长度。前缀67H可用来指定地址值的长度。</p></li><li><p>堆栈段（SS寄存器所指的数据段）: 这个标志位被称为B（大的）标志, 它为隐含的栈操作（如push、pop和call）确定栈指针的大小。如果该标志为1, 则使用32位的栈指针, 栈指针放在32位的ESP寄存器中; 如该标志为0, 则使用16位的栈指针, 栈指针存放在SP寄存器。 如果堆栈段为一个向下扩展的数据段, 则B标志还确定堆栈段的地址上界。</p></li><li><p>向下扩展的数据段: 这个标志称为B标志, 确定段的地址上界。如果该标志为1, 则段地址上界为FFFFFFFFH(4GB); 若该标志为0, 则段地址上界为FFFFH(64KB)。</p></li></ul><blockquote><p>G(粒度)标志: 确定段界限扩展的增量。当G标志为0, 则段界限以字节为单位扩展; G标志为1, 则段界限以4KB为单位扩展。（这个标志不影响段基址的粒度, 段基址的粒度永远都是字节）如果G标志为1, 那么当检测偏移是否超越段界限时, 不用测试偏移的低12位。</p></blockquote><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h4 id="1-段存在权限限制"><a href="#1-段存在权限限制" class="headerlink" title="1.段存在权限限制"></a>1.段存在权限限制</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Segments.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段的初探</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> val = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> val2 = <span class="number">0x2</span>;</span><br><span class="line"><span class="comment">// 段读写的探测</span></span><br><span class="line"><span class="comment">/*__asm</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">mov ax, cs;</span></span><br><span class="line"><span class="comment">mov ds, ax;</span></span><br><span class="line"><span class="comment">mov eax, dword ptr [val];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov cx, ss;</span></span><br><span class="line"><span class="comment">mov ds, cx;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov dword ptr [val2], eax;</span></span><br><span class="line"><span class="comment">&#125;;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对base的探测</span></span><br><span class="line"><span class="comment">//__asm </span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//mov ax, 0x4b;</span></span><br><span class="line"><span class="comment">//mov ds, ax;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds:[val];</span></span><br><span class="line"><span class="comment">//mov dword ptr ss:[val2], eax;</span></span><br><span class="line"><span class="comment">//mov cx, es;</span></span><br><span class="line"><span class="comment">//mov ds, cx;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段长度的探测</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax, fs:[<span class="number">0xffc</span>];<span class="comment">// base + 0</span></span><br><span class="line">mov val2, eax;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, val2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><p>拆分GDTR</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800 L30</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0001f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98880  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98890  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>988a0  <span class="number">800089b</span>9`ad900067 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>00cf9b00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cf9300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cffb00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>80008bb9&#96;8c0020ab</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98c00</td><td align="left">000020ab</td><td align="left">b</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>804093b9&#96;b0004fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9b000</td><td align="left">4fff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0040f300&#96;00000fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">00fff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0000f200&#96;0400ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000400</td><td align="left">ffff</td><td align="left">2</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0001ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000001</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad200067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad20</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;acb00067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9acb0</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800092b9&#96;880003ff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98800</td><td align="left">03ff</td><td align="left">2</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad900067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad90</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><h2 id="D-B标志知识点"><a href="#D-B标志知识点" class="headerlink" title="D&#x2F;B标志知识点"></a>D&#x2F;B标志知识点</h2><div class="note info"><p><strong>D/B标志</strong></p><ul><li>当D&#x2F;B位作用于代码段时为D位, 当作用于数据段时为B位;</li><li>当描述代码段时, 默认操作数将会改变成16位的段;</li><li>当描述堆栈段时, 堆栈寻址将变成16位;</li><li>当描述普通数据段时, 没有任何反应;</li></ul></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 描述代码段时</span></span><br><span class="line"><span class="comment">// 1. 复制GDTR中cs段的描述符至0x48位置</span></span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 使用JMP指令进行cs段修改</span></span><br><span class="line">jmp far <span class="number">0x0048</span>:<span class="number">0x77D7062E</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 描述堆栈段</span></span><br><span class="line"><span class="comment">// 1. 修改0x48位置为00cff200`0000ffff（type域为2）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ss寄存器的值</span></span><br><span class="line">mov ax, <span class="number">0x4b</span>;</span><br><span class="line">mov ss, ax;</span><br><span class="line"><span class="comment">// 3. 加载段时0x48位置type域变成3</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><h2 id="TYPE域知识点"><a href="#TYPE域知识点" class="headerlink" title="TYPE域知识点"></a>TYPE域知识点</h2><blockquote><p>当段描述符中S标志（描述符类型）为1时, 描述符为代码段描述符或者数据段描述符。类型域的最高位（段描述符的第二个双字的第11位）将决定该描述符为数据段描述符（为0）还是代码段描述符（为1）。</p></blockquote><blockquote><p>代码和数据段描述类型</p></blockquote><blockquote><p>对于数据段而言, 描述符的类型域的低3位（第8、9、10位）被解释为访问控制（A）、是否可写（W）、扩展方向（E）。数据段可以是只读或者可读写的段, 这取决于”是否可写”的标志。</p></blockquote><blockquote><p>堆栈段必须是可读写的数据段。将一个不可写的数据段的选择子置入SS寄存器会导致一般保护异常（#GP）。如果堆栈段的大小需要动态变化, 可以将其置为向下扩展数据段（扩展方向标志为1）。这里, 动态改变段界限将导致栈空间朝着栈底部空间扩展。如果栈的长度保持不变, 堆栈段可以是向上扩展的, 也可以是向下扩展的。</p></blockquote><blockquote><p>访问位表示自最后一次被操作系统清零后, 段是否被访问过。每当处理器将段的段选择子置入段寄存器时, 就将访问位置为1。该位一直保持1直到被显式清零。该位可以用于虚拟内存管理和测试。</p></blockquote><blockquote><p>对于代码段而言, 类型域的低3位被解释为访问位（A）、可读位（R）、一致位（C）。根据可读位的设置, 代码段可以为”只执行”或者”可执行可读”。当有常量或者其它静态数据与指令代码一起在ROM中时, 必须使用”可执行可读”的段。要从代码段读取数据, 可以通过带有CS前缀的指令或者将代码段选择子置入数目段寄存器（DS、ES、FS或者GS）。在保护模式下, 代码段是不可写的。</p></blockquote><blockquote><p>代码段可以是一致性的, 也可以是不一致性的。转入一个特权级更高的一致性段的进程可以在当前特权级继续执行下去。除非使用了调用门或者任务门, 否则, 转入一个不同特权级的非一致性段将使处理器产生一个”一般保护异常”（#GP）。不访问受保护程序的系统程序和某些类型的异常处理程序（比如除法错误或者溢出）可以被载入一致性的代码段。不能被特权级更低的程序和过程访问的程序应该被载入非一致性的代码段。</p></blockquote><div class="note bug"><p><strong>注意</strong></p><p>无论目标段是否为一致性代码段, 进程都不能因为<code>call</code>或<code>jump</code>而转入一个特权级较低（特权值较大）的代码段执行。试图进行这样的执行转换将导致一个一般保护异常（#GP）;</p></div><blockquote><p>所有数据段都是非一致性的, 这就意味着数据段不能被更低特权级的进程访问（特权级数值较大的执行代码）。然而, 和代码段不同, 数据段可以被更高优先级的程序或过程（特权级数值较小的执行代码）访问, 不需要使用特别的访问门.</p></blockquote><blockquote><p>如果GDT或者LDT中的段描述符被放置在ROM中, 当程序或者处理器试图更改在ROM中的段描述符时, 处理器将进入一个死循环。为了防止此类问题的发生, 可以将所有放置在ROM中的段描述符设置访问位。同时, 删除所有操作系统代码中试图更改放置在ROM中的段描述符的代码。</p></blockquote><h2 id="段控制内存访问方向知识点"><a href="#段控制内存访问方向知识点" class="headerlink" title="段控制内存访问方向知识点"></a>段控制内存访问方向知识点</h2><h3 id="代码实验-2"><a href="#代码实验-2" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 修改gdtr中0x48位置为00cff600`0000ffff（type域为6表示读/写, 内存向下扩展）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ds寄存器</span></span><br><span class="line">mov ax, <span class="number">0x48</span>;</span><br><span class="line">mov ds, ax;</span><br><span class="line"><span class="comment">// 运行将产生异常, 将Limit和Base修改成0进行修复（0c0f600`00000000）</span></span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><ul><li>非一致代码段: 应用层不能调用内核层代码;</li><li>一致代码段: 应用层可以直接调用CS描述的一致代码段;</li></ul></div>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;段&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-任务门</title>
    <link href="http://example.com/9144b229.html"/>
    <id>http://example.com/9144b229.html</id>
    <published>2024-09-28T01:10:10.000Z</published>
    <updated>2024-09-29T01:40:47.891Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>任务门</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>00407030 -&gt; 0000e940&#96;70300068</p><p>GDT: eq 80b98848 0000e940<code>70300068 IDT: eq 80b98100 0000e500</code>00480000</p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="INT-8双重异常"><a href="#INT-8双重异常" class="headerlink" title="INT 8双重异常"></a>INT 8双重异常</h3><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_28_TaskGate(任务门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务门</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf_s</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;任务门&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-任务段</title>
    <link href="http://example.com/f79a1477.html"/>
    <id>http://example.com/f79a1477.html</id>
    <published>2024-09-27T14:14:14.000Z</published>
    <updated>2024-09-28T15:55:56.090Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>任务段</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><ul><li>在程序中获取到<code>tss</code>的地址, 例如: <code>00407030</code>; </li><li>拼接段描述符: <strong>0000e940&#96;703020ac</strong>;</li><li>修改<code>GDTR</code>中段描述符;</li></ul><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="KTSS结构体"><a href="#KTSS结构体" class="headerlink" title="_KTSS结构体"></a>_KTSS结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> Esp0             : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Ss0              : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : Uint2B</span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> CR3              : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Eax              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> Esp              : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> Es               : Uint2B</span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : Uint2B</span><br><span class="line">   +<span class="number">0x04c</span> Cs               : Uint2B</span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : Uint2B</span><br><span class="line">   +<span class="number">0x050</span> Ss               : Uint2B</span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : Uint2B</span><br><span class="line">   +<span class="number">0x054</span> Ds               : Uint2B</span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : Uint2B</span><br><span class="line">   +<span class="number">0x058</span> Fs               : Uint2B</span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : Uint2B</span><br><span class="line">   +<span class="number">0x05c</span> Gs               : Uint2B</span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : Uint2B</span><br><span class="line">   +<span class="number">0x060</span> LDT              : Uint2B</span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : Uint2B</span><br><span class="line">   +<span class="number">0x064</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : Uint2B</span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>] UChar</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当输入CR3后进入0环断点后的各种情况</span></span><br><span class="line">kd&gt; r tr</span><br><span class="line">tr=<span class="number">00000048</span>         <span class="comment">// 当前tr寄存器已改变为0x48, 之前为0x28</span></span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0xad01fcb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401364</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0x246</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0xfde7b46e</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0x270178</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0x7ffd6000</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; u <span class="number">0x401364</span></span><br><span class="line"><span class="number">00401364</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line"><span class="number">00401365</span> c0528bcd        rcl     byte ptr [edx<span class="number">-75</span>h],<span class="number">0</span>CDh</span><br><span class="line"><span class="number">00401369</span> <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0040136</span>a <span class="number">8</span>d1598134000    lea     edx,ds:[<span class="number">401398</span>h]</span><br><span class="line"><span class="number">00401370</span> e87b020000      call    <span class="number">004015f</span>0</span><br><span class="line"><span class="number">00401375</span> <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">00401376</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">00401377</span> <span class="number">5f</span>              pop     edi</span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; dt _KTSS <span class="number">00407030</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0x28</span>               <span class="comment">// 上一个段的</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x40b0d0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f31e640</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401080</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x40d0d0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">8</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x30</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">00000000</span> ecx=<span class="number">00000000</span> edx=<span class="number">00000000</span> esi=<span class="number">00000000</span> edi=<span class="number">00000000</span></span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">0040</span>d0d0 ebp=<span class="number">00000000</span> iopl=<span class="number">0</span>         nv up di pl nz na po nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00004002</span> <span class="comment">// 0100 0000 0000 0010 NT</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0                <span class="comment">// 上面结构体中的esp</span></span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">7f</span>40f3fd`f0000fff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0000</span>eb40`<span class="number">70300100</span>       <span class="comment">// 段描述符中的eb和48中的一致</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0</span><br><span class="line">kd&gt; dds <span class="number">0040</span>d0d0        <span class="comment">// 使用call跨段跳转时会保存cs、esp、ss、eip</span></span><br><span class="line"><span class="number">0040</span>d0d0  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0dc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e0  <span class="number">00000004</span></span><br><span class="line"><span class="number">0040</span>d0e4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e8  <span class="number">00000002</span></span><br><span class="line"><span class="number">0040</span>d0ec  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f0  <span class="number">00000001</span></span><br><span class="line"><span class="number">0040</span>d0f4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0fc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d100  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d104  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d108  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d10c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d110  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d114  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d118  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d11c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d120  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d124  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d128  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d12c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d130  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d134  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d138  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d13c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d140  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d144  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d148  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d14c  <span class="number">00000000</span></span><br></pre></td></tr></table></figure><h4 id="通过jmp指令提权"><a href="#通过jmp指令提权" class="headerlink" title="通过jmp指令提权"></a>通过jmp指令提权</h4><ul><li>jmp可以通过任务段提权, 同时替换CS和SS寄存器</li></ul><h4 id="怎样返回3环"><a href="#怎样返回3环" class="headerlink" title="怎样返回3环"></a>怎样返回3环</h4><blockquote><p>使用call跨段跳转时会保存cs、esp、ss、eip, 使用任务门时没保存这些值, 怎么返回？</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;          <span class="comment">// &lt;-- 导致系统奔溃的主要原因, 清空了NT位</span></span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>问题剖析</strong></p><ul><li>恢复运行后将导致系统崩溃, 中断门会修改VM、NT、IF、TF位, 并按照堆栈返回, 当NT位置0后再根据堆栈返回时将出现系统崩溃;</li><li>iretd指令首先检测eflag.NT位, 如果NT位等于0, 就按照堆栈返回; 如果NT位等于1, 就按照Backlink找到要返回的上下文环境返回;</li></ul></div><ul><li>解决方式</li></ul><ol><li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">        pushfd;</span><br><span class="line">        pop eax;</span><br><span class="line">        <span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">        push eax;</span><br><span class="line">        popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>需要手动修复dg 28中_KTSS结构的CR3<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">...</span><br><span class="line">PROCESS <span class="number">85b</span>021a8  SessionId: <span class="number">1</span>  Cid: <span class="number">0e60</span>    Peb: <span class="number">7f</span>fde000  ParentCid: <span class="number">0e4</span>c</span><br><span class="line">    DirBase: <span class="number">3f</span>344640  ObjectTable: <span class="number">959357</span>d8  HandleCount:   <span class="number">7.</span></span><br><span class="line">    Image: <span class="number">09</span>_27_TaskSegments(ÈÎÎñ¶Î).exe</span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span>          <span class="comment">// &lt;-- 需要手动修复成该程序的CR3</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98c00+<span class="number">1</span>c <span class="number">3f</span>344640</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98c1c <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f344640</span>         <span class="comment">// &lt;-- 修复后</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><blockquote><p>包含使用jmp指令实现任务切换</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_27_TaskSegments(任务段).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务段</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ntdll!_KTSS</span></span><br><span class="line"><span class="comment">   +0x000 Backlink         : Uint2B</span></span><br><span class="line"><span class="comment">   +0x002 Reserved0        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x004 Esp0             : Uint4B</span></span><br><span class="line"><span class="comment">   +0x008 Ss0              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00a Reserved1        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00c NotUsed1         : [4] Uint4B</span></span><br><span class="line"><span class="comment">   +0x01c CR3              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x020 Eip              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x024 EFlags           : Uint4B</span></span><br><span class="line"><span class="comment">   +0x028 Eax              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x02c Ecx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x030 Edx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x034 Ebx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x038 Esp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x03c Ebp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x040 Esi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x044 Edi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x048 Es               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04a Reserved2        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04c Cs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04e Reserved3        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x050 Ss               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x052 Reserved4        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x054 Ds               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x056 Reserved5        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x058 Fs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05a Reserved6        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05c Gs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05e Reserved7        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x060 LDT              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x062 Reserved8        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x064 Flags            : Uint2B</span></span><br><span class="line"><span class="comment">   +0x066 IoMapBase        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x068 IoMaps           : [1] _KiIoAccessMap</span></span><br><span class="line"><span class="comment">   +0x208c IntDirectionMap  : [32] UChar</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> szRet[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">// jmp 任务切换跳回</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">__asm </span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">jmp fword ptr szRet;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// 0</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WORD tr = <span class="number">0</span>;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">str tr;</span><br><span class="line">&#125;</span><br><span class="line">*(WORD*)&amp;szRet[<span class="number">4</span>] = tr;       <span class="comment">// 保存旧的tr值</span></span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Eax = <span class="number">0x1111</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG ulCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG pCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line">jmp fword ptr bufCode;<span class="comment">// jmp实现任务切换</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;任务段&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
</feed>
