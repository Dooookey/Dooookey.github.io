<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dokey_</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-11-03T01:32:02.591Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Dokey_</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Windows内核-驱动内存加载</title>
    <link href="http://example.com/87f76606.html"/>
    <id>http://example.com/87f76606.html</id>
    <published>2024-11-03T01:21:39.000Z</published>
    <updated>2024-11-03T01:32:02.591Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动内存加载</strong></p></div><span id="more"></span><h2 id="驱动内存加载"><a href="#驱动内存加载" class="headerlink" title="驱动内存加载"></a>驱动内存加载</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><blockquote><ol><li>通过<code>explore.exe</code>定位到文件</li><li>使用<code>CreateProcess</code>创建进程（CreateUserProcess）<ul><li>a. 创建进程开辟一块内存   PEB     内核下需要挂<code>C0000000</code></li><li>b. 通过文件路径载入exe</li><li>c. 拉伸PE, 解析PE头, 把对应的数据目录存放到内存相关偏移的地址</li><li>d. 修复重定位</li><li>e. IAT 导入表修复</li><li>f. 修复TLS（驱动没有）</li><li>g. 修复延迟导入表（驱动没有, 驱动存在Cookie）</li><li>h. 修复异常表</li><li>i. CALL入口点</li></ul></li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动内存加载&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-驱动通信</title>
    <link href="http://example.com/6195666c.html"/>
    <id>http://example.com/6195666c.html</id>
    <published>2024-11-01T01:24:38.000Z</published>
    <updated>2024-11-03T01:26:52.746Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动通信</strong></p><p>驱动通信</p></div><span id="more"></span><h2 id="驱动通信"><a href="#驱动通信" class="headerlink" title="驱动通信"></a>驱动通信</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="DRIVER-OBJECT"><a href="#DRIVER-OBJECT" class="headerlink" title="DRIVER_OBJECT"></a>DRIVER_OBJECT</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DEVICE_OBJECT</span><br><span class="line">ntdll!_DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B                      <span class="comment">// 设备大小</span></span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> ReferenceCount   : Int4B</span><br><span class="line">   +<span class="number">0x008</span> DriverObject     : Ptr32 _DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x00c</span> NextDevice       : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x010</span> AttachedDevice   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x014</span> CurrentIrp       : Ptr32 _IRP                 <span class="comment">// 当前请求IRP</span></span><br><span class="line">   +<span class="number">0x018</span> Timer            : Ptr32 _IO_TIMER            <span class="comment">// 时钟</span></span><br><span class="line">   +<span class="number">0x01c</span> Flags            : Uint4B                     <span class="comment">// 以什么方式读写设备</span></span><br><span class="line">   +<span class="number">0x020</span> Characteristics  : Uint4B                     <span class="comment">// 设置属性</span></span><br><span class="line">   +<span class="number">0x024</span> Vpb              : Ptr32 _VPB                 <span class="comment">// 磁盘相关, 暂不涉及</span></span><br><span class="line">   +<span class="number">0x028</span> DeviceExtension  : Ptr32 Void                 <span class="comment">// 扩展</span></span><br><span class="line">   +<span class="number">0x02c</span> DeviceType       : Uint4B                     <span class="comment">// 设备类型</span></span><br><span class="line">   +<span class="number">0x030</span> StackSize        : Char                       <span class="comment">// 设备栈的大小</span></span><br><span class="line">   +<span class="number">0x034</span> Queue            : &lt;unnamed-tag&gt;              <span class="comment">// 队列</span></span><br><span class="line">   +<span class="number">0x05c</span> AlignmentRequirement : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> DeviceQueue      : _KDEVICE_QUEUE</span><br><span class="line">   +<span class="number">0x074</span> Dpc              : _KDPC</span><br><span class="line">   +<span class="number">0x094</span> ActiveThreadCount : Uint4B</span><br><span class="line">   +<span class="number">0x098</span> SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +<span class="number">0x09c</span> DeviceLock       : _KEVENT</span><br><span class="line">   +<span class="number">0x0ac</span> SectorSize       : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> Spare1           : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> DeviceObjectExtension : Ptr32 _DEVOBJ_EXTENSION</span><br><span class="line">   +<span class="number">0x0b4</span> Reserved         : Ptr32 Void</span><br></pre></td></tr></table></figure><h4 id="IRP"><a href="#IRP" class="headerlink" title="IRP"></a>IRP</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _IRP</span><br><span class="line">ntdll!_IRP</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> MdlAddress       : Ptr32 _MDL</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> AssociatedIrp    : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> IoStatus         : _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x020</span> RequestorMode    : Char</span><br><span class="line">   +<span class="number">0x021</span> PendingReturned  : UChar</span><br><span class="line">   +<span class="number">0x022</span> StackCount       : Char       <span class="comment">// 总大小（有多少设备）</span></span><br><span class="line">   +<span class="number">0x023</span> CurrentLocation  : Char       <span class="comment">// 当前设备栈的索引</span></span><br><span class="line">   +<span class="number">0x024</span> Cancel           : UChar</span><br><span class="line">   +<span class="number">0x025</span> CancelIrql       : UChar</span><br><span class="line">   +<span class="number">0x026</span> ApcEnvironment   : Char</span><br><span class="line">   +<span class="number">0x027</span> AllocationFlags  : UChar</span><br><span class="line">   +<span class="number">0x028</span> UserIosb         : Ptr32 _IO_STATUS_BLOCK</span><br><span class="line">   +<span class="number">0x02c</span> UserEvent        : Ptr32 _KEVENT</span><br><span class="line">   +<span class="number">0x030</span> Overlay          : &lt;unnamed-tag&gt;</span><br><span class="line">   +<span class="number">0x038</span> CancelRoutine    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x03c</span> UserBuffer       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Tail             : &lt;unnamed-tag&gt;</span><br></pre></td></tr></table></figure><h4 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  PDRIVER_OBJECT DriverObject,          <span class="comment">// 要提供的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceExtensionSize,            <span class="comment">// 设备扩展, 0代表这个地方没有指向</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PUNICODE_STRING DeviceName,        <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  DEVICE_TYPE DeviceType,               <span class="comment">// 设备类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  ULONG DeviceCharacteristics,          <span class="comment">// 设备属性</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  BOOLEAN Exclusive,                    <span class="comment">// 是否独占</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_result_nullonfailure_</span></span></span><br><span class="line"><span class="params"><span class="function">    _At_(*DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">        __drv_allocatesMem(Mem)</span></span></span><br><span class="line"><span class="params"><span class="function">        _When_((((_In_function_class_(DRIVER_INITIALIZE))</span></span></span><br><span class="line"><span class="params"><span class="function">               ||(_In_function_class_(DRIVER_DISPATCH)))),</span></span></span><br><span class="line"><span class="params"><span class="function">             __drv_aliasesMem))</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT *DeviceObject                <span class="comment">// 创建成功后返回的驱动对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="自定义控制码"><a href="#自定义控制码" class="headerlink" title="自定义控制码"></a>自定义控制码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE( DeviceType, Function, Method, Access ) (                 \</span></span><br><span class="line"><span class="meta">    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_KEY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line">                          <span class="comment">// 虚拟设备类型       // 索引号        // 通信方式        // 访问权限</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+1, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_MEMORY CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+2, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_BASE_DLL CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+3, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_PROTECT_PID CTL_CODE(FILE_DEVICE_UNKNOWN, CODE_CTR_INDEX+4, METHOD_BUFFERED, FILE_ANY_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure><h4 id="创建符号链接"><a href="#创建符号链接" class="headerlink" title="创建符号链接"></a>创建符号链接</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTKERNELAPI</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">IoCreateSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING SymbolicLinkName,          <span class="comment">// 符号链接名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING DeviceName                 <span class="comment">// 设备名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h4 id="设置驱动派发回调函数"><a href="#设置驱动派发回调函数" class="headerlink" title="设置驱动派发回调函数"></a>设置驱动派发回调函数</h4><blockquote><p><code>IRP_MJ_CREATE</code>和<code>IRP_MJ_CLOSE</code>必须设置</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建设备开启/关闭回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;        <span class="comment">// 输入</span></span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;       <span class="comment">// 输出</span></span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="驱动完整代码"><a href="#驱动完整代码" class="headerlink" title="驱动完整代码"></a>驱动完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义设备名称和符号链接</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\Device\\MyUniqueDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM_LINK_NAME <span class="string">L&quot;\\DosDevices\\MyUniqueDevice&quot;</span><span class="comment">// \\??\\ 等价于\\DosDevices\\， \\DosDevices\\兼容性更高</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 IOCTL 控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动卸载函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UnloadDriver</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> </span>&#123;</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"><span class="built_in">IoDeleteSymbolicLink</span>(&amp;symLink);  <span class="comment">// 删除符号链接</span></span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(DriverObject-&gt;DeviceObject);  <span class="comment">// 删除设备对象</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;-----------DriverUnloaded-----------\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 IOCTL 请求</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 当前栈</span></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line">ULONG controlCode = stack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">ULONG_PTR information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (controlCode) &#123;</span><br><span class="line"><span class="keyword">case</span> IOCTL_MY_CONTROL_CODE: &#123;</span><br><span class="line"><span class="comment">// 获取输入输出缓冲区（假设用 METHOD_BUFFERED 方法）</span></span><br><span class="line">PVOID inputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">PVOID outputBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">ULONG inputBufferLength = stack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">ULONG outputBufferLength = stack-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：简单地将接收到的输入数据拷贝到输出缓冲区</span></span><br><span class="line"><span class="keyword">if</span> (inputBufferLength &gt; <span class="number">0</span> &amp;&amp; outputBufferLength &gt;= inputBufferLength) &#123;</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(outputBuffer, inputBuffer, inputBufferLength);</span><br><span class="line">information = inputBufferLength;  <span class="comment">// 返回数据的长度</span></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Received from user: %s\n&quot;</span>, (<span class="type">char</span>*)inputBuffer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line">Irp-&gt;IoStatus.Information = information;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动入口</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">NTSTATUS status;</span><br><span class="line">PDEVICE_OBJECT deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">UNICODE_STRING deviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(DEVICE_NAME);</span><br><span class="line">UNICODE_STRING symLink = <span class="built_in">RTL_CONSTANT_STRING</span>(SYM_LINK_NAME);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建设备对象</span></span><br><span class="line">status = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0</span>, &amp;deviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;deviceObject);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create device\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建符号链接</span></span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;symLink, &amp;deviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(deviceObject);</span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to create symbolic link\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置驱动的卸载例程和设备控制例程</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverDeviceControl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">KdPrint</span>((<span class="string">&quot;Driver loaded successfully\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="用户态完整代码"><a href="#用户态完整代码" class="headerlink" title="用户态完整代码"></a>用户态完整代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 自定义控制码</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="string">L&quot;\\\\.\\MyUniqueDevice&quot;</span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> inputBuffer[<span class="number">100</span>] = <span class="string">&quot;Hello, driver!&quot;</span>;</span><br><span class="line"><span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesReturned;</span><br><span class="line"><span class="comment">// 使用DeviceIoControl打开设备并通过自定义控制码发送和接收数据</span></span><br><span class="line">BOOL success = <span class="built_in">DeviceIoControl</span>(hDevice,</span><br><span class="line">IOCTL_MY_CONTROL_CODE,</span><br><span class="line">inputBuffer, <span class="built_in">sizeof</span>(inputBuffer),</span><br><span class="line">outputBuffer, <span class="built_in">sizeof</span>(outputBuffer),</span><br><span class="line">&amp;bytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, outputBuffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;DeviceIoControl failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用ReadFile进行通信"><a href="#使用ReadFile进行通信" class="headerlink" title="使用ReadFile进行通信"></a>使用ReadFile进行通信</h3><h4 id="驱动代码"><a href="#驱动代码" class="headerlink" title="驱动代码"></a>驱动代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理读取回调函数</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverDeviceReadControl</span><span class="params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span> </span>&#123;</span><br><span class="line"><span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line"></span><br><span class="line">PIO_STACK_LOCATION stack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line">ULONG bufferLength = stack-&gt;Parameters.Read.Length;</span><br><span class="line">NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备要发送到用户态的数据</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* message = <span class="string">&quot;Hello From Kernel!&quot;</span>;</span><br><span class="line">ULONG messageLength = (ULONG)<span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查缓冲区大小</span></span><br><span class="line"><span class="keyword">if</span> (bufferLength &lt; messageLength) &#123;</span><br><span class="line">status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 将数据复制到用户态缓冲区</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(Irp-&gt;AssociatedIrp.SystemBuffer, message, messageLength);</span><br><span class="line">Irp-&gt;IoStatus.Information = messageLength;  <span class="comment">// 返回数据长度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Irp-&gt;IoStatus.Status = status;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建设备</span></span><br><span class="line">    ...</span><br><span class="line">    deviceObject-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">    <span class="comment">// 创建符号链接</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置回调函数</span></span><br><span class="line">DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate;<span class="comment">// 默认派发, 允许打开</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyDriverCreate;<span class="comment">// 默认派发, 允许关闭</span></span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_READ] = MyDriverDeviceReadControl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="用户态代码"><a href="#用户态代码" class="headerlink" title="用户态代码"></a>用户态代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11_01_R3_Communicate(3环通信).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MY_CONTROL_CODE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 创建设备</span></span><br><span class="line">HANDLE hDevice = <span class="built_in">CreateFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\MyUniqueDevice&quot;</span>), GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesRead;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ReadFile 从驱动读取数据</span></span><br><span class="line">BOOL success = <span class="built_in">ReadFile</span>(hDevice, buffer, <span class="built_in">sizeof</span>(buffer), &amp;bytesRead, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Received from driver: %s\n&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ReadFile failed. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_BUFFERED                 0       <span class="comment">// 缓冲模式, 复制一份数据</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_IN_DIRECT                1       <span class="comment">// 映射同一个物理地址, 共享物理地址</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_OUT_DIRECT               2       <span class="comment">// </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> METHOD_NEITHER                  3       <span class="comment">// 直写</span></span></span><br></pre></td></tr></table></figure><h3 id="驱动通信封装"><a href="#驱动通信封装" class="headerlink" title="驱动通信封装"></a>驱动通信封装</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li>注册通信方法</li><li>销毁的方法</li><li>发送通知</li></ol><div class="note red bug"><p><strong>注意</strong></p><p>在使用<code>WriteFile</code>时第四个参数不能使用<code>LPDWORD</code>指针类型直接传参, 会导致程序奔溃, 需要使用<code>DWORD</code>类型然后传递指针;</p></div>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动通信&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;驱动通信&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-驱动开发</title>
    <link href="http://example.com/b57f2803.html"/>
    <id>http://example.com/b57f2803.html</id>
    <published>2024-10-24T01:03:39.000Z</published>
    <updated>2024-11-01T00:33:36.445Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>驱动开发</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="驱动是进程吗"><a href="#驱动是进程吗" class="headerlink" title="驱动是进程吗"></a>驱动是进程吗</h3><blockquote><p>驱动并不是进程, 而是叫模块（本质上和dll是一样的）;</p></blockquote><h3 id="驱动类型"><a href="#驱动类型" class="headerlink" title="驱动类型"></a>驱动类型</h3><blockquote><p>NT: NT4虚拟驱动（现在基本没有纯NT4的驱动）;<br>WDM: 是一个热拔插方式;<br>WDF: 简化开发, 相当于事件驱动机制; KWDF（内核驱动框架）, UWDF（用户驱动框架）;</p></blockquote><h3 id="加载驱动"><a href="#加载驱动" class="headerlink" title="加载驱动"></a>加载驱动</h3><blockquote><ol><li>服务加载<br>OpenSrcManager<br>CreateService<br>StartService<br>StopService<br>DeleteService</li></ol></blockquote><blockquote><ol start="2"><li>本地加载<br>Zw&#x2F;NtLoadDriver<br>Zw&#x2F;NtUnloadDriver</li></ol></blockquote><h1 id="驱动基础"><a href="#驱动基础" class="headerlink" title="驱动基础"></a>驱动基础</h1><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><blockquote><p>int &#x3D;&gt; INT short &#x3D;&gt; SHORT long &#x3D;&gt; LONG</p></blockquote><h3 id="字符串函数-申请内存函数"><a href="#字符串函数-申请内存函数" class="headerlink" title="字符串函数, 申请内存函数"></a>字符串函数, 申请内存函数</h3><h4 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h4><blockquote><ol><li>RtlInitString: 初始化多字节ascii</li></ol></blockquote><blockquote><ol start="2"><li>RtlInitUnicodeString: 初始化宽字符</li></ol></blockquote><blockquote><ol start="3"><li>RtlFreeUnicodeString: 释放unicode字符串</li></ol></blockquote><blockquote><ol start="4"><li>RtlStringCbPrintfA: 格式化输出, 引用#include &lt;ntstrsafe.h&gt;</li></ol></blockquote><blockquote><ol start="5"><li>RtlCompareUnicodeString: 字符串比较</li></ol></blockquote><h4 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h4><blockquote><ol><li>ExAllocatePool（内存申请）<br>NonPagedPool &#x3D;&gt; 非分页内存（带执行属性）<br>PagedPool &#x3D;&gt; 分页内存（不带执行属性）</li></ol></blockquote><blockquote><ol start="2"><li>ExFreePool（释放内存）</li></ol></blockquote><h3 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h3><blockquote><ol><li>PsCreateSystemThread（创建线程）</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数</span></span><br><span class="line"><span class="function">VOID <span class="title">work</span><span class="params">(PVOID StartContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, work, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ZwClose</span>(hThread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="普通链表"><a href="#普通链表" class="headerlink" title="普通链表"></a>普通链表</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><blockquote><p>InitializeListHead（初始化链表）<br>IsListEmpty（判断链表是否为空）<br>InsertHeadList（链表头部插入数据）<br>InsertTailList（链表尾部插入数据）<br>RemoveHeadList（移除链表头部数据）<br>RemoveTailList（移除链表尾部数据）<br>RemoveEntryList（移除空链表）</p></blockquote><h3 id="驱动遍历"><a href="#驱动遍历" class="headerlink" title="驱动遍历"></a>驱动遍历</h3><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// DbgBreakPoint();</span></span><br><span class="line"><span class="comment">// 遍历驱动</span></span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (next != pre)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="驱动断链"><a href="#驱动断链" class="headerlink" title="驱动断链"></a>驱动断链</h3><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _DRIVER_OBJECT</span><br><span class="line">ntdll!_DRIVER_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Int2B</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : Ptr32 Void                 <span class="comment">// 链表</span></span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : Ptr32     <span class="type">long</span> </span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] Ptr32     <span class="type">long</span> </span><br></pre></td></tr></table></figure><h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KLDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">ULONG __Undefined1;</span><br><span class="line">ULONG __Undefined2;</span><br><span class="line">ULONG __Undefined3;</span><br><span class="line">ULONG NonPagedDebugInfo;</span><br><span class="line">ULONG DllBase;</span><br><span class="line">ULONG EntryPoint;</span><br><span class="line">ULONG SizeOfImage;</span><br><span class="line">UNICODE_STRING FullDllName;</span><br><span class="line">UNICODE_STRING BaseDllName;</span><br><span class="line">ULONG Flags;</span><br><span class="line">USHORT LoadCount;</span><br><span class="line">USHORT __Undefined5;</span><br><span class="line">ULONG  __Undefined6;</span><br><span class="line">ULONG  CheckSum;</span><br><span class="line">ULONG  TimeDateStamp;</span><br><span class="line"></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="function">NTKERNELAPI NTSTATUS <span class="title">ObReferenceObjectByName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">__in PUNICODE_STRING ObjectName,</span></span></span><br><span class="line"><span class="params"><span class="function">__in ULONG Attributes,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt PACCESS_STATE AccessState,</span></span></span><br><span class="line"><span class="params"><span class="function">__in_opt ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="params"><span class="function">__in POBJECT_TYPE ObjectType,</span></span></span><br><span class="line"><span class="params"><span class="function">__in KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">__inout_opt PVOID ParseContext,</span></span></span><br><span class="line"><span class="params"><span class="function">__out PVOID *Object</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE * IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverHide</span><span class="params">(PWCH wcObjectName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">LARGE_INTEGER in = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">in.QuadPart = <span class="number">-10000</span> * <span class="number">5000</span>;</span><br><span class="line"><span class="built_in">KeDelayExecutionThread</span>(KernelMode, FALSE, &amp;in);</span><br><span class="line">UNICODE_STRING usDriverName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;usDriverName, wcObjectName);</span><br><span class="line">PDRIVER_OBJECT pDriverObject = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">ObReferenceObjectByName</span>(&amp;usDriverName, FILE_ALL_ACCESS, <span class="number">0</span>, <span class="number">0</span>, IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;pDriverObject);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriverObject-&gt;DriverSection;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;[db]: Driver Name = %wZ\r\n&quot;</span>, &amp;ldr-&gt;FullDllName);</span><br><span class="line"><span class="comment">// pDriverObject-&gt;DriverSection = ldr-&gt;InLoadOrderLinks.Flink;// 修复pc hunter 卡死（移花接木）</span></span><br><span class="line"><span class="built_in">RemoveEntryList</span>(&amp;ldr-&gt;InLoadOrderLinks);</span><br><span class="line">pDriverObject-&gt;DriverInit = <span class="literal">NULL</span>;</span><br><span class="line">pDriverObject-&gt;DriverSection = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">ObDereferenceObject</span>(pDriverObject);<span class="comment">// 引用计数清除</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;DriverHide ObReferenceObjectByName Failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;-----------DriverUnload-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 断链隐藏自身</span></span><br><span class="line">HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">PsCreateSystemThread</span>(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, DriverHide, <span class="string">&quot;\\drivers\\MyDriver3&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NtClose</span>(hThread);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 有BUG</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">DbgBreakPoint();</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName1 = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName1, L&quot;\\drivers\\http&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">UNICODE_STRING usDriverName = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">RtlInitUnicodeString(&amp;usDriverName, L&quot;http.sys&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">while (next != pre)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">// DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">if (next-&gt;BaseDllName.Length != 0 &amp;&amp; RtlCompareUnicodeString(&amp;usDriverName, &amp;next-&gt;BaseDllName, TRUE) == 0)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">PDRIVER_OBJECT pDriverObject = NULL;</span></span><br><span class="line"><span class="comment">NTSTATUS status = ObReferenceObjectByName(&amp;usDriverName1, FILE_ALL_ACCESS, 0, 0, IoDriverObjectType, KernelMode, NULL, &amp;pDriverObject);</span></span><br><span class="line"><span class="comment">if (NT_SUCCESS(status))</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverInit = NULL;</span></span><br><span class="line"><span class="comment">pDriverObject-&gt;DriverSection = NULL;</span></span><br><span class="line"><span class="comment">// pDriverObject-&gt;Type = 0;// 规避暴露搜索</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">else</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;DriverHide ObReferenceObjectByName Failed&quot;);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">DbgPrintEx(77, 0, &quot;[db]: Driver Name = %wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span></span><br><span class="line"><span class="comment">break;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;驱动开发&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-控制寄存器</title>
    <link href="http://example.com/fefdec16.html"/>
    <id>http://example.com/fefdec16.html</id>
    <published>2024-10-21T15:35:45.000Z</published>
    <updated>2024-10-21T16:14:51.473Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>控制寄存器</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="CR2"><a href="#CR2" class="headerlink" title="CR2"></a>CR2</h3><blockquote><p>CR2寄存器（内存有问题）保存了出异常的线性地址;</p></blockquote><h3 id="CR3"><a href="#CR3" class="headerlink" title="CR3"></a>CR3</h3><h4 id="PCD"><a href="#PCD" class="headerlink" title="PCD"></a>PCD</h4><blockquote><p>当PCD位为1的时候, 整个页表的缓存全关;</p></blockquote><h4 id="PWT"><a href="#PWT" class="headerlink" title="PWT"></a>PWT</h4><blockquote><p>当PWT位为1的时候, 代表只写（优化性能）;</p></blockquote><h3 id="CR0"><a href="#CR0" class="headerlink" title="CR0"></a>CR0</h3><h4 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h4><blockquote><p>开启保护模式, 但是没有分页保护, 只有段保护;</p></blockquote><h4 id="PG"><a href="#PG" class="headerlink" title="PG"></a>PG</h4><blockquote><p>开启分页模式;</p></blockquote><blockquote><p>PE和PG组合<br>PE &#x3D; 0, PG &#x3D; 1 &#x3D;&gt; 错误的<br>PE &#x3D; 0, PG &#x3D; 0 &#x3D;&gt; 正确的（实模式）<br>PE &#x3D; 1, PG &#x3D; 0 &#x3D;&gt; 正确的（段模式）<br>PE &#x3D; 1, PG &#x3D; 1 &#x3D;&gt; 正确的（段页模式）</p></blockquote><h4 id="CD"><a href="#CD" class="headerlink" title="CD"></a>CD</h4><blockquote><p>关闭缓存; 如果CD位为1, 所有进程的页表缓存通通关闭;</p></blockquote><h4 id="AM"><a href="#AM" class="headerlink" title="AM"></a>AM</h4><blockquote><p>当AM位置为1时, 三环的应用程序必须经过对齐检查（堆栈在32位下必须是4字节对齐, 在64位下必须是8字节对齐）</p></blockquote><h4 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h4><blockquote><p>关闭写保护, 不可写的地址变为可写;</p></blockquote><h3 id="CR4"><a href="#CR4" class="headerlink" title="CR4"></a>CR4</h3><h4 id="VME"><a href="#VME" class="headerlink" title="VME"></a>VME</h4><blockquote><p>开启虚拟中断, 并且允许开启虚拟8086模式;</p></blockquote><h4 id="PVI"><a href="#PVI" class="headerlink" title="PVI"></a>PVI</h4><blockquote><p>当PVI位为1时, 允许虚拟8086模式支持虚拟化中断;</p></blockquote><h4 id="TSD"><a href="#TSD" class="headerlink" title="TSD"></a>TSD</h4><blockquote></blockquote><h4 id="DE"><a href="#DE" class="headerlink" title="DE"></a>DE</h4><blockquote></blockquote><h4 id="PSE"><a href="#PSE" class="headerlink" title="PSE"></a>PSE</h4><blockquote><p>当PSE位为0时, 就算PDE.ps &#x3D; 1也是小页; 控制所有大页的开关是否有效</p></blockquote><h4 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h4><blockquote><p>在32位下, 如果PAE位为1, 表示分页模式为2-9-9-12模式; 否则为10-10-12模式;</p></blockquote><h4 id="MCE"><a href="#MCE" class="headerlink" title="MCE"></a>MCE</h4><blockquote><p>机器检查</p></blockquote><h4 id="PGE"><a href="#PGE" class="headerlink" title="PGE"></a>PGE</h4><blockquote><p>如果PGE &#x3D; 1, G &#x3D; 1代表全局页有效; 如果PGE &#x3D; 0, G &#x3D; 1代表无效;</p></blockquote><h4 id="PCE"><a href="#PCE" class="headerlink" title="PCE"></a>PCE</h4><blockquote></blockquote><h4 id="VMXE"><a href="#VMXE" class="headerlink" title="VMXE"></a>VMXE</h4><blockquote><p>VT的开启位, 进入VT之后这个位必须为1</p></blockquote><h4 id="SMXE"><a href="#SMXE" class="headerlink" title="SMXE"></a>SMXE</h4><blockquote><p>上帝模式</p></blockquote><h4 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h4><blockquote><p>super mode execute protected</p></blockquote><h4 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h4><blockquote><p>super mode access protected</p></blockquote><h4 id="PKE"><a href="#PKE" class="headerlink" title="PKE"></a>PKE</h4><blockquote><p>页表密钥</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;控制寄存器&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-缓存</title>
    <link href="http://example.com/b89f0cae.html"/>
    <id>http://example.com/b89f0cae.html</id>
    <published>2024-10-19T01:34:43.000Z</published>
    <updated>2024-10-21T15:33:52.680Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>缓存</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="WC（写组合-写合并）"><a href="#WC（写组合-写合并）" class="headerlink" title="WC（写组合&#x2F;写合并）"></a>WC（写组合&#x2F;写合并）</h3><blockquote><p>同一时刻只能保证4个地址; </p></blockquote><h3 id="WB（写回绕-回写）"><a href="#WB（写回绕-回写）" class="headerlink" title="WB（写回绕&#x2F;回写）"></a>WB（写回绕&#x2F;回写）</h3><blockquote></blockquote><h3 id="WT（直写）"><a href="#WT（直写）" class="headerlink" title="WT（直写）"></a>WT（直写）</h3><blockquote><p>通常是做多媒体</p></blockquote><h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>课程中test1比test2快, 实验是test2比test1快???</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_19_Cache(缓存).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOCATE_SIZE 0x10000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MASK (ALLOCATE_SIZE - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> j = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (j--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = j &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = j;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PUCHAR x1 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x2 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x3 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x4 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x5 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line">PUCHAR x6 = (PUCHAR)<span class="built_in">malloc</span>(ALLOCATE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> startTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="type">int</span> i = INT_MAX;</span><br><span class="line"><span class="keyword">while</span> (i--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index = i &amp; MASK;</span><br><span class="line"><span class="type">char</span> b = i;</span><br><span class="line">x1[index] = b;</span><br><span class="line">x2[index] = b;</span><br><span class="line">x3[index] = b;</span><br><span class="line">x4[index] = b;</span><br><span class="line">x5[index] = b;</span><br><span class="line">x6[index] = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> endTime = <span class="built_in">GetTickCount</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2. 一共耗时%d毫秒\r\n&quot;</span>, endTime - startTime);</span><br><span class="line"><span class="built_in">free</span>(x1);</span><br><span class="line"><span class="built_in">free</span>(x2);</span><br><span class="line"><span class="built_in">free</span>(x3);</span><br><span class="line"><span class="built_in">free</span>(x4);</span><br><span class="line"><span class="built_in">free</span>(x5);</span><br><span class="line"><span class="built_in">free</span>(x6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"><span class="built_in">test1</span>();</span><br><span class="line"><span class="built_in">test2</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PAT"><a href="#PAT" class="headerlink" title="PAT"></a>PAT</h3><h2 id="TLB"><a href="#TLB" class="headerlink" title="TLB"></a>TLB</h2><blockquote><p>每个核有4个TLB, 2个数据核（dTLB）, 2个指令TLB（iTLB）;</p></blockquote><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>申请2个地址, 分别赋值;</li><li>把第一个地址挂在0地址上, 然后访问, 取出结果保存变量;</li><li>又把第二个地址挂在0地址上, 然后访问, 取出结果也保存变量;</li><li>观察变量1, 变量2有什么不同;</li></ol><blockquote><p>401080<br>gdtr: 0040ec00&#96;00081080</p></blockquote><h3 id="实验代码-1"><a href="#实验代码-1" class="headerlink" title="实验代码"></a>实验代码</h3><blockquote><p>代码出现问题, 获取0地址时为0;</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_21_TLB.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PUCHAR addr1 = <span class="literal">NULL</span>;</span><br><span class="line">PUCHAR addr2 = <span class="literal">NULL</span>;</span><br><span class="line">ULONG temp1 = <span class="number">0</span>, temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>  __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">pushad;</span><br><span class="line">pushfd;</span><br><span class="line">push <span class="number">0x30</span>;</span><br><span class="line">pop fs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov eax, [addr1]; <span class="comment">// 线形地址1, 使用原始汇编代码, 注释代码会导致系统蓝屏</span></span><br><span class="line">shr eax, <span class="number">0x9</span>;</span><br><span class="line"><span class="keyword">and</span> eax, <span class="number">0x7ffff8</span>;</span><br><span class="line">mov ecx, [eax<span class="number">-0x3FFFFFFC</span>];</span><br><span class="line">sub eax, <span class="number">0x40000000</span>;</span><br><span class="line">mov ecx, [eax];</span><br><span class="line">mov edx, [eax + <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//int 3;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000000</span>], ecx;</span><br><span class="line">mov dword ptr ds:[<span class="number">0xC0000004</span>], edx;</span><br><span class="line">mov eax, dword ptr ds:[<span class="number">0</span>];</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">mov [temp1], eax;</span><br><span class="line"></span><br><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov eax, [addr2]; // 线形地址2</span></span><br><span class="line"><span class="comment">//shr eax, 0x9;</span></span><br><span class="line"><span class="comment">//and eax, 0x7ffff8;</span></span><br><span class="line"><span class="comment">//and eax, 0xC0000000;</span></span><br><span class="line"><span class="comment">//mov ecx, [eax];// 取低4字节</span></span><br><span class="line"><span class="comment">//mov edx, [eax + 4];// 取高4字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000000], ecx;</span></span><br><span class="line"><span class="comment">//mov dword ptr ds : [0xC0000004], edx;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds : [0];</span></span><br><span class="line"><span class="comment">//mov [temp2], eax;</span></span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">popfd;</span><br><span class="line">popad;</span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">addr1 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">addr2 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">*(PUCHAR)addr1 = <span class="number">0x1000</span>;</span><br><span class="line">*(PUCHAR)addr2 = <span class="number">0x2000</span>;</span><br><span class="line"></span><br><span class="line">temp1 = <span class="number">0</span>;</span><br><span class="line">temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;addr1 = %x, addr2 = %x, test = %x\r\n&quot;</span>, addr1, addr2, test);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push fs;</span></span><br><span class="line">call fword ptr bufcode;</span><br><span class="line"><span class="comment">// pop fs;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;temp1 = %x, temp2 = %x\r\n&quot;</span>, temp1, temp2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="刷新CR3"><a href="#刷新CR3" class="headerlink" title="刷新CR3"></a>刷新CR3</h3><blockquote><ol><li>当切换CR3的时候, CPU就认为在切换不同的页表; 当页表发生变化的时候, TLB就会产生一个刷新; 凡是G位等于0的通通刷新掉; 刷新除G位为1的情况;<br>切换线程的时候, 判断当前被切换与切换是否是一个进程, 如果不是, 会切换页表（CR3）;</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax, cr3;<span class="comment">//刷新cr3</span></span><br><span class="line">mov cr3, eax;<span class="comment">// 刷新cr3</span></span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>把地址变为无效缓存; 刷新一条</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invlpg dword ptr ds:[<span class="number">0</span>];<span class="comment">// 强制刷新TLB中某一行</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>CR4控制寄存器中有一个PGE位, 这个是控制所有的G位是否有效; 刷新所有;</li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;缓存&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页下</title>
    <link href="http://example.com/2d7503f2.html"/>
    <id>http://example.com/2d7503f2.html</id>
    <published>2024-10-17T01:01:28.000Z</published>
    <updated>2024-10-17T15:48:19.838Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表基址</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><blockquote><p>线性地址和物理地址是一对一映射关系, 等价映射;</p></blockquote><blockquote><p>每个进程在高地址中有4兆空间是不共享的, 他指向的是本进程的PDE和PTE;</p></blockquote><blockquote><p>判断一个线性地址是否有效？</p></blockquote><ol><li>如果是PDE.p &#x3D; 1并且PS&#x3D;1, 那么有效</li><li>如果PDE.p&#x3D;1 PS&#x3D;0, PTE.p&#x3D;1 PTE.PAT&#x3D;0, 有效</li></ol><h3 id="101012下页表基址计算"><a href="#101012下页表基址计算" class="headerlink" title="101012下页表基址计算"></a>101012下页表基址计算</h3><ul><li>汇编代码<blockquote><p>MiIsAddressValid（线性地址有效性验证函数）</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0048</span>DBB8                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">0048</span>DBBA                 shr     eax, <span class="number">14</span>h        ; 右移动 <span class="number">20</span>位 eax &gt;&gt; <span class="number">20</span></span><br><span class="line">.text:<span class="number">0048</span>DBBD                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FCh      ; (eax &gt;&gt; <span class="number">20</span>) &amp; ffc</span><br><span class="line">.text:<span class="number">0048</span>DBC2                 sub     eax, <span class="number">3F</span>D00000h</span><br><span class="line">.text:<span class="number">0048</span>DBC7                 mov     eax, [eax]      ; C0300000是一个起始地址</span><br><span class="line">.text:<span class="number">0048</span>DBC9                 test    al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBCB                 jnz     <span class="type">short</span> loc_48DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBCD loc_48DBCD:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">32</span>↓j</span><br><span class="line">.text:<span class="number">0048</span>DBCD                 <span class="keyword">xor</span>     al, al</span><br><span class="line">.text:<span class="number">0048</span>DBCF                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD0</span><br><span class="line">.text:<span class="number">0048</span>DBD0 loc_48DBD0:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">13</span>↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD0                 test    al, al</span><br><span class="line">.text:<span class="number">0048</span>DBD2                 jns     <span class="type">short</span> loc_48DBD7 ; 判断是否是大页</span><br><span class="line">.text:<span class="number">0048</span>DBD4                 mov     al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0048</span>DBD6                 retn</span><br><span class="line">.text:<span class="number">0048</span>DBD7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0048</span>DBD7</span><br><span class="line">.text:<span class="number">0048</span>DBD7 loc_48DBD7:                             ; CODE XREF: <span class="built_in">MiIsAddressValid</span>(x,x)+<span class="number">1</span>A↑j</span><br><span class="line">.text:<span class="number">0048</span>DBD7                 shr     ecx, <span class="number">0</span>Ah</span><br><span class="line">.text:<span class="number">0048</span>DBDA                 <span class="keyword">and</span>     ecx, <span class="number">3F</span>FFFCh</span><br><span class="line">.text:<span class="number">0048</span>DBE0                 sub     ecx, <span class="number">40000000</span>h  ; C0000000</span><br><span class="line">.text:<span class="number">0048</span>DBE6                 mov     eax, [ecx]</span><br><span class="line">.text:<span class="number">0048</span>DBE8                 test    al, <span class="number">1</span>           ; PTE</span><br><span class="line">.text:<span class="number">0048</span>DBEA                 jz      <span class="type">short</span> loc_48DBCD</span><br><span class="line">.text:<span class="number">0048</span>DBEC                 <span class="keyword">and</span>     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBEE                 cmp     al, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0048</span>DBF0                 setnz   al</span><br><span class="line">.text:<span class="number">0048</span>DBF3                 retn</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>C0300000 PDE基址<br>C0300000 + ((线性地址 &gt;&gt; 0x14) &amp; 0xFFC)</p></blockquote><blockquote><p>C0000000 PTE基址<br>C000000 + ((线性地址 &gt;&gt; 0xA) &amp; 0x3FFFFC)</p></blockquote><h3 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h3><blockquote><p>最大能支持36根地址总线<br>2^32 &#x3D; 4G<br>2^33 &#x3D; 4G * 2 &#x3D; 8G<br>2^36 &#x3D; 4G*2^4 &#x3D; 64G</p></blockquote><h2 id="2-9-9-12分页"><a href="#2-9-9-12分页" class="headerlink" title="2-9-9-12分页"></a>2-9-9-12分页</h2><blockquote><ol><li>2^2 &#x3D; 4, 有4种（00, 01, 10, 11）, 所以CR3是以0x20来递增的;</li></ol></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><ol><li>2-9-9-12拆法;</li><li>逆向分析2-9-9-12分页模式下内核函数MmIsAddressValied;</li><li>通过调用门进入R0修改高2G的所有PDE、PTE的u&#x2F;s位, 然后返回应用层访问高地址, 分页模式10-10-12;</li></ol>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表基址&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页表</title>
    <link href="http://example.com/1d0822fc.html"/>
    <id>http://example.com/1d0822fc.html</id>
    <published>2024-10-14T01:22:18.000Z</published>
    <updated>2024-10-17T01:01:20.225Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表</strong></p></div><span id="more"></span><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="内核文件"><a href="#内核文件" class="headerlink" title="内核文件"></a>内核文件</h3><blockquote><p>32位特有的</p></blockquote><ul><li>如果是29912分页, 运行的内核 ntkrnlpa.exe;</li><li>如果是101012分页, 运行的内核 ntoskrnl.exe;</li></ul><blockquote><p>C:\Windows\System32\drivers目录下保存的都是一些系统驱动;</p></blockquote><blockquote><ol><li>线性地址一致, 为什么内存数据不一致</li><li>物理内存小于虚拟内存</li></ol></blockquote><h3 id="物理地址的拆分"><a href="#物理地址的拆分" class="headerlink" title="物理地址的拆分"></a>物理地址的拆分</h3><blockquote><p>10-10-12分页拆分</p></blockquote><ol><li>在notepad中键入字符串后使用CE找到该字符串的逻辑地址: 0009DE08</li><li>拆分地址<br>0009DE08 &#x3D;&gt; 0000 0000 0000 | 0000 1001 1101 | 1110 0000 1000<br>0000 0000 0000  &#x3D;&gt; 0        &#x2F;&#x2F; 页目录项<br>0000 1001 1101  &#x3D;&gt; 09D      &#x2F;&#x2F; 页表项<br>1110 0000 1000  &#x3D;&gt; E08      &#x2F;&#x2F; 页内偏移</li><li>在WinDBG中查找<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先使用命令!process 0 0找到notepad进程的CR3</span></span><br><span class="line"><span class="comment">// 注意：物理内存要使用感叹号(!)</span></span><br><span class="line"></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000            <span class="comment">// notepad进程的CR3（代表这本书）</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">32f</span>99000+<span class="number">0</span>*<span class="number">4</span>        <span class="comment">// 每一项代表的是指针, 32位下为4字节, 所以需要乘以4</span></span><br><span class="line">#<span class="number">32f</span>99000 <span class="number">1</span>c1ce867 <span class="number">25e09867</span> <span class="number">1</span>c16c867 <span class="number">18485867</span></span><br><span class="line">#<span class="number">32f</span>99010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99020 <span class="number">05265867</span> <span class="number">17</span>c66867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">32f</span>99070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c1ce000+<span class="number">09</span>D*<span class="number">4</span>      <span class="comment">// 去除最后的12位（后面的12位在页目录下代表了注意事项, 也就是属性）, 然后加上页表项09D</span></span><br><span class="line">#<span class="number">1</span>c1ce274 <span class="number">2</span>cea5867 <span class="number">212f</span>c867 <span class="number">27</span>c7e867 <span class="number">2</span>d13f867</span><br><span class="line">#<span class="number">1</span>c1ce284 <span class="number">20f</span>43867 <span class="number">28843867</span> <span class="number">286</span>c3867 <span class="number">03244867</span></span><br><span class="line">#<span class="number">1</span>c1ce294 <span class="number">02b</span>85847 <span class="number">3038b</span>867 <span class="number">0</span>a4ca847 <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2a4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2b4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2c4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2d4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c1ce2e4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2</span>cea5000+E08        <span class="comment">// 同样去除后12位后加上页内偏移后找到这个字</span></span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">00620061</span> <span class="number">00640063</span> <span class="number">00320031</span> <span class="number">00340033</span></span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">00370035</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00000000</span> <span class="number">005f</span>0004 <span class="number">59f</span>3c08e <span class="number">0800730b</span></span><br><span class="line">#<span class="number">2</span>cea5e58 <span class="number">000</span>a1aa0 <span class="number">000</span>a1c20 <span class="number">5</span>cf3c08b <span class="number">08007303</span></span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">00000409</span> <span class="number">0019f</span>2e0 <span class="number">0019f</span>220 <span class="number">0019f</span>2e0</span><br><span class="line">#<span class="number">2</span>cea5e78 <span class="number">001865</span>cc <span class="number">00000003</span> <span class="number">0019</span>ee7c <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">2</span>cea5000+E08</span><br><span class="line">#<span class="number">2</span>cea5e08 <span class="number">61</span> <span class="number">00</span> <span class="number">62</span> <span class="number">00</span> <span class="number">63</span> <span class="number">00</span> <span class="number">64</span> <span class="number">00</span><span class="number">-31</span> <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">33</span> <span class="number">00</span> <span class="number">34</span> <span class="number">00</span> a.b.c.d<span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.4</span>.</span><br><span class="line">#<span class="number">2</span>cea5e18 <span class="number">35</span> <span class="number">00</span> <span class="number">37</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5.7</span>.............</span><br><span class="line">#<span class="number">2</span>cea5e28 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e38 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">2</span>cea5e48 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">5f</span> <span class="number">00</span><span class="number">-8</span>e c0 f3 <span class="number">59</span> <span class="number">0b</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> ......_....Y.s..</span><br><span class="line">#<span class="number">2</span>cea5e58 a0 <span class="number">1</span>a <span class="number">0</span>a <span class="number">00</span> <span class="number">20</span> <span class="number">1</span>c <span class="number">0</span>a <span class="number">00</span><span class="number">-8b</span> c0 f3 <span class="number">5</span>c <span class="number">03</span> <span class="number">73</span> <span class="number">00</span> <span class="number">08</span> .... ......\.s..</span><br><span class="line">#<span class="number">2</span>cea5e68 <span class="number">09</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span><span class="number">-20</span> f2 <span class="number">19</span> <span class="number">00</span> e0 f2 <span class="number">19</span> <span class="number">00</span> ........ .......</span><br><span class="line">#<span class="number">2</span>cea5e78 cc <span class="number">65</span> <span class="number">18</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-7</span>c ee <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> .e......|.......</span><br></pre></td></tr></table></figure></li></ol><h3 id="计算一次缓存的字节数"><a href="#计算一次缓存的字节数" class="headerlink" title="计算一次缓存的字节数"></a>计算一次缓存的字节数</h3><blockquote><p>总字节数 &#x2F; linesize &#x2F; x way &#x3D; y组<br>y 组 &#x2F; x way &#x3D; 1组z行     z行 * linesize &#x3D; 一组缓存的字节数<br>(32K * 1024) &#x2F; 64 &#x2F; 8 &#x3D; 总组数（64）<br>64（总组数） &#x2F; 8 &#x3D; 8行<br>8 * 64字节 &#x3D; 512组的字节数</p></blockquote><h2 id="P-US-RW"><a href="#P-US-RW" class="headerlink" title="P_US_RW"></a>P_US_RW</h2><blockquote><p>PDE和PTE是与的关系（PDE.arr &amp; PTE.arr）, 最后得出为1的才是有效的;</p></blockquote><h3 id="P位"><a href="#P位" class="headerlink" title="P位"></a>P位</h3><blockquote><p>如果是PDE的P位置0, 那么代表PTT为无效;<br>如果是PTE的P为置0, 那么代表物理页为无效;</p></blockquote><h3 id="R-W位"><a href="#R-W位" class="headerlink" title="R&#x2F;W位"></a>R&#x2F;W位</h3><blockquote><p>R&#x2F;W位为0, 代表只读;<br>R&#x2F;W位为1, 代表可写;</p></blockquote><h4 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>a57 b30 &#x3D;&gt; 0000 0000 10 | 10 0101 0111 | 1011 0011 0000<br>0000 0000 0010  &#x3D;&gt; 2<br>0010 0101 0111  &#x3D;&gt; 257<br>1011 0011 0000  &#x3D;&gt; b30</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1622e000</span>+<span class="number">2</span>*<span class="number">4</span>        <span class="comment">// 1622e000为实验程序的CR3, PDE(18996867)最后一位为7(0111), 证明可写</span></span><br><span class="line">#<span class="number">1622e008</span> <span class="number">18996867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e018</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e028</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e038</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e048</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e058</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e068</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1622e078</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">18996000</span>+<span class="number">257</span>*<span class="number">4</span>      <span class="comment">// 去除后12位加上页表项乘以4, PTE(0abb8005)最后一位为5(0101), 证明不可写</span></span><br><span class="line">#<span class="number">1899695</span>c <span class="number">0</span>abb8005 <span class="number">1</span>cc79005 <span class="number">00000000</span> <span class="number">19352847</span></span><br><span class="line">#<span class="number">1899696</span>c <span class="number">31b</span>a6005 <span class="number">09e2</span>f205 <span class="number">3685e005</span> <span class="number">3</span>d0da005</span><br><span class="line">#<span class="number">1899697</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899698</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1899699</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>ac <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969b</span>c <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">189969</span>cc <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">1899695</span>c <span class="number">0</span>abb8007   <span class="comment">// 将0abb8005修改为0abb8007, PTE(0abb8007)最后一位为7(0111), &amp;之后R/W位为1, 修改为可写状态</span></span><br><span class="line">kd&gt; !dd <span class="number">0</span>abb8000+b30</span><br><span class="line"># abb8b30 <span class="number">61647361</span> <span class="number">73676473</span> <span class="number">00616664</span> <span class="number">00000000</span></span><br><span class="line"># abb8b40 <span class="number">0</span>a0d7825 <span class="number">00000000</span> <span class="number">73756170</span> <span class="number">00000065</span></span><br><span class="line"># abb8b50 <span class="number">0</span>a0d7325 <span class="number">00000000</span> <span class="number">00</span>a57c18 <span class="number">00</span>a57d28</span><br><span class="line"># abb8b60 <span class="number">00</span>a57e80 <span class="number">00</span>a57ea4 <span class="number">00</span>a57ee4 <span class="number">00</span>a57f18</span><br><span class="line"># abb8b70 <span class="number">00000001</span> <span class="number">00000000</span> <span class="number">00000001</span> <span class="number">00000001</span></span><br><span class="line"># abb8b80 <span class="number">00000001</span> <span class="number">00000001</span> <span class="number">63617453</span> <span class="number">7261206b</span></span><br><span class="line"># abb8b90 <span class="number">646e756</span>f <span class="number">65687420</span> <span class="number">72617620</span> <span class="number">6</span>c626169</span><br><span class="line"># abb8ba0 <span class="number">00272065</span> <span class="number">61772027</span> <span class="number">6f</span>632073 <span class="number">70757272</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30       <span class="comment">// 实验程序中的字符串</span></span><br><span class="line"># abb8b30 <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> asdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br><span class="line">kd&gt; g</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>abb8000+b30        <span class="comment">// 已经被修改</span></span><br><span class="line"># abb8b30 <span class="number">31</span> <span class="number">73</span> <span class="number">64</span> <span class="number">61</span> <span class="number">73</span> <span class="number">64</span> <span class="number">67</span> <span class="number">73</span><span class="number">-64</span> <span class="number">66</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>sdasdgsdfa.....</span><br><span class="line"># abb8b40 <span class="number">25</span> <span class="number">78</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-70</span> <span class="number">61</span> <span class="number">75</span> <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> %x......pause...</span><br><span class="line"># abb8b50 <span class="number">25</span> <span class="number">73</span> <span class="number">0</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-18</span> <span class="number">7</span>c a5 <span class="number">00</span> <span class="number">28</span> <span class="number">7</span>d a5 <span class="number">00</span> %s.......|..(&#125;..</span><br><span class="line"># abb8b60 <span class="number">80</span> <span class="number">7</span>e a5 <span class="number">00</span> a4 <span class="number">7</span>e a5 <span class="number">00</span>-e4 <span class="number">7</span>e a5 <span class="number">00</span> <span class="number">18</span> <span class="number">7f</span> a5 <span class="number">00</span> .~...~...~......</span><br><span class="line"># abb8b70 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># abb8b80 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-53</span> <span class="number">74</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6b</span> <span class="number">20</span> <span class="number">61</span> <span class="number">72</span> ........Stack ar</span><br><span class="line"># abb8b90 <span class="number">6f</span> <span class="number">75</span> <span class="number">6</span>e <span class="number">64</span> <span class="number">20</span> <span class="number">74</span> <span class="number">68</span> <span class="number">65</span><span class="number">-20</span> <span class="number">76</span> <span class="number">61</span> <span class="number">72</span> <span class="number">69</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6</span>c ound the variabl</span><br><span class="line"># abb8ba0 <span class="number">65</span> <span class="number">20</span> <span class="number">27</span> <span class="number">00</span> <span class="number">27</span> <span class="number">20</span> <span class="number">77</span> <span class="number">61</span><span class="number">-73</span> <span class="number">20</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">72</span> <span class="number">72</span> <span class="number">75</span> <span class="number">70</span> e <span class="string">&#x27;.&#x27;</span> was corrup</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> *x = (<span class="type">char</span>*)<span class="string">&quot;asdasdgsdfa&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line">x[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, x);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="U-S位（user-super）"><a href="#U-S位（user-super）" class="headerlink" title="U&#x2F;S位（user&#x2F;super）"></a>U&#x2F;S位（user&#x2F;super）</h3><blockquote><p>如果U&#x2F;S位为0, 代表只有内核可以访问页;<br>如果U&#x2F;S位为1, 代表三环可以访问页;</p></blockquote><h4 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h4><blockquote><ol><li>拆分地址<br>80b98800 &#x3D;&gt; 0010 0000 0010 | 0011 1001 1000 | 1000 0000 0000<br>0010 0000 0010 &#x3D;&gt; 202 &#x2F;&#x2F; 前面的往后移, 前面补0<br>0011 1001 1000 &#x3D;&gt; 398<br>1000 0000 0000 &#x3D;&gt; 100</li></ol></blockquote><blockquote><ol start="2"><li>查询gdtr属性</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x80b98800</span>     <span class="comment">// 查询默认gdtr地址</span></span><br><span class="line">                 VA <span class="number">80b</span>98800</span><br><span class="line">PDE at C0300808         PTE at C0202E60</span><br><span class="line">contains <span class="number">0018</span>A063       contains <span class="number">00B</span>98163   <span class="comment">// 最后一位是3（0011）, 代表P位和R/W位有值, U/S位为0, 意味着用户模式下访问不到, 只能内核访问</span></span><br><span class="line">pfn <span class="number">18</span>a   ---DA--KWEV   pfn b98   -G-DA--KWEV</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>WinDBG中设置</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span>      <span class="comment">// 获取当前进程的PDE</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a063 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !ed <span class="number">199</span>a808 <span class="number">0018</span>a067    <span class="comment">// 设置PDE中U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0199</span>a000+<span class="number">202</span>*<span class="number">4</span></span><br><span class="line"># <span class="number">199</span>a808 <span class="number">0018</span>a067 <span class="number">3</span>d3c7863 <span class="number">001b</span>7063 <span class="number">001b</span>8063</span><br><span class="line"># <span class="number">199</span>a818 <span class="number">001b</span>9063 <span class="number">001b</span>a063 <span class="number">001b</span>b063 <span class="number">001b</span>c063</span><br><span class="line"># <span class="number">199</span>a828 <span class="number">001b</span>d063 <span class="number">001b</span>e063 <span class="number">001b</span>f063 <span class="number">21</span>a3c863</span><br><span class="line"># <span class="number">199</span>a838 <span class="number">210</span>aa863 <span class="number">001</span>c2063 <span class="number">001</span>c3063 <span class="number">001</span>c4063</span><br><span class="line"># <span class="number">199</span>a848 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">001</span>c7063 <span class="number">05400863</span></span><br><span class="line"># <span class="number">199</span>a858 <span class="number">05801863</span> <span class="number">3f</span>ec0863 <span class="number">3f</span>e81863 <span class="number">3f</span>e82863</span><br><span class="line"># <span class="number">199</span>a868 <span class="number">3f</span>e83863 <span class="number">3f</span>e84863 <span class="number">3f</span>e85863 <span class="number">3f</span>e86863</span><br><span class="line"># <span class="number">199</span>a878 <span class="number">3f</span>e87863 <span class="number">18</span>c23863 <span class="number">3</span>a3a8863 <span class="number">3</span>d3c3863</span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span>      <span class="comment">// 查询当前进程的PTE</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98163 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98167     <span class="comment">// 设置PTE的U/S位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98167 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98167</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br><span class="line">kd&gt; !ed <span class="number">18</span>ae60 <span class="number">00b</span>98067         <span class="comment">// 设置PTE的G位为1</span></span><br><span class="line">kd&gt; !dd <span class="number">0018</span>a000+<span class="number">398</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">18</span>ae60 <span class="number">00b</span>98067 <span class="number">00b</span>99163 <span class="number">00b</span>9a163 <span class="number">00b</span>9b163</span><br><span class="line">#  <span class="number">18</span>ae70 <span class="number">00b</span>9c163 <span class="number">00b</span>9d163 <span class="number">00b</span>9e163 <span class="number">00b</span>9f163</span><br><span class="line">#  <span class="number">18</span>ae80 <span class="number">00b</span>a0163 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>ae90 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aea0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aeb0 <span class="number">00b</span>ac963 <span class="number">00b</span>ad121 <span class="number">00b</span>ae121 <span class="number">00b</span>af963</span><br><span class="line">#  <span class="number">18</span>aec0 <span class="number">03</span>d01060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#  <span class="number">18</span>aed0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !vtop <span class="number">0199</span>a000 <span class="number">0x80b98800</span>       <span class="comment">// 查询当前进程的CR3信息</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000080b</span>98800, pagedir <span class="number">000000000199</span>a000</span><br><span class="line">X86VtoP: PDE <span class="number">000000000199</span>a808 - <span class="number">0018</span>a067</span><br><span class="line">X86VtoP: PTE <span class="number">000000000018</span>ae60 - <span class="number">00b</span>98067</span><br><span class="line">X86VtoP: Mapped phys <span class="number">0000000000b</span>98800</span><br><span class="line">Virtual address <span class="number">80b</span>98800 translates to physical address b98800.</span><br></pre></td></tr></table></figure><blockquote><ol start="4"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_14_PageProperties(页属性).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// u/s位代码试验</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sgdt buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> address = *(PULONG)&amp;buf[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> * x = (<span class="type">int</span>*)address;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, *x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="A位"><a href="#A位" class="headerlink" title="A位"></a>A位</h3><blockquote><p>不是人为设置, 如果从来没有访问过可能是个0, 一旦访问过一次（读或者写）就会变成1;</p></blockquote><h3 id="G位（全局页）"><a href="#G位（全局页）" class="headerlink" title="G位（全局页）"></a>G位（全局页）</h3><h2 id="挂页（幽灵地址）"><a href="#挂页（幽灵地址）" class="headerlink" title="挂页（幽灵地址）"></a>挂页（幽灵地址）</h2><h3 id="申请内存并挂到0地址上"><a href="#申请内存并挂到0地址上" class="headerlink" title="申请内存并挂到0地址上"></a>申请内存并挂到0地址上</h3><blockquote><ol><li>拆地址<br>1d0000 &#x3D;&gt; 0000 0000 00 | 01 1101 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1101 0000 &#x3D;&gt; 1d0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 04922847</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000        <span class="comment">// 通过CR3获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>+<span class="number">1</span>d0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">23325740</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325750</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325760</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325770</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325780</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325790</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257</span>a0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">233257b</span>0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">04922000</span>            <span class="comment">// 查看PTE</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">4922070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">1</span>c2c5000            <span class="comment">// 获取PDE</span></span><br><span class="line">#<span class="number">1</span>c2c5000 <span class="number">23325867</span> <span class="number">06e4</span>b867 <span class="number">00000000</span> <span class="number">376e3867</span></span><br><span class="line">#<span class="number">1</span>c2c5010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1</span>c2c5070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span>            <span class="comment">// 查看PDE</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">23325000</span> <span class="number">04922847</span>       <span class="comment">// 将PDE指针指向PTE的值（04922847）</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922847</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; g</span><br><span class="line">Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line"><span class="number">84066</span>ed0 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; !dd <span class="number">23325000</span></span><br><span class="line">#<span class="number">23325000</span> <span class="number">04922867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325040</span> <span class="number">0b</span>841847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">23325070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">04922000</span>        <span class="comment">// 成功修改成100（0x64）</span></span><br><span class="line"># <span class="number">4922000</span> <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> d...............</span><br><span class="line"># <span class="number">4922010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">4922070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * x = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">*x = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在本进程中的0地址上执行shellcode"><a href="#在本进程中的0地址上执行shellcode" class="headerlink" title="在本进程中的0地址上执行shellcode"></a>在本进程中的0地址上执行shellcode</h3><blockquote><ol><li>拆地址<br>2f0000 &#x3D;&gt; 0000 0000 00 | 10 1111 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0010 1111 0000 &#x3D;&gt; 2f0<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置<br>PTE: 0a512867</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">20f</span>6a000        <span class="comment">// 根据进程CR3获取PDE</span></span><br><span class="line">#<span class="number">20f</span>6a000 <span class="number">38736867</span> <span class="number">03</span>c45867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">20f</span>6a070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>+<span class="number">2f</span>0*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">38736b</span>c0 <span class="number">0</span>a512867 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>d0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>e0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736b</span>f0 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c00 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c10 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c20 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736</span>c30 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">0</span>a512000            <span class="comment">// 查看数据</span></span><br><span class="line"># a512000 <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># a512010 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512020 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512030 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512040 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512050 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512060 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># a512070 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">38736000</span>            <span class="comment">// 查看0地址</span></span><br><span class="line">#<span class="number">38736000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736040</span> <span class="number">0</span>c350847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">38736070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">38736000</span> <span class="number">0</span>a512867       <span class="comment">// 将PTE（0a512867）挂到0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="built_in">func</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将物理页挂到其他进程并执行shellcode"><a href="#将物理页挂到其他进程并执行shellcode" class="headerlink" title="将物理页挂到其他进程并执行shellcode"></a>将物理页挂到其他进程并执行shellcode</h3><div class="note red bug"><p><strong>注意</strong></p><ul><li>该实验无法在cheatengine-i386.exe（CE）上成功复现, 在notepad.exe上成功复现;</li></ul></div><blockquote><ol><li>拆地址<br>180000 &#x3D;&gt; 0000 0000 00 | 01 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0001 1000 0000 &#x3D;&gt; 180<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li>notepad.exe进程信息<br>PROCESS 87460570  SessionId: 1  Cid: 0978    Peb: 7ffda000  ParentCid: 0a48<br>  DirBase: 015de000  ObjectTable: b3a87c30  HandleCount:  60.<br>  Image: notepad.exe</li><li>实验进程信息<br>PROCESS 87620030  SessionId: 1  Cid: 03f8    Peb: 7ffdc000  ParentCid: 060c<br>  DirBase: 03005000  ObjectTable: a4d11110  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">03005000</span>            <span class="comment">// 首先通过本进程的CR3获取PDE</span></span><br><span class="line"># <span class="number">3005000</span> <span class="number">22</span>edd867 <span class="number">1f</span>d2e867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">3005070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">22</span>edd000+<span class="number">180</span>*<span class="number">4</span>      <span class="comment">// 获取本进程的PTE</span></span><br><span class="line">#<span class="number">22</span>edd600 <span class="number">27e84867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd610 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd620 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd630 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">22</span>edd640 <span class="number">39944005</span> <span class="number">381</span>d4867 <span class="number">1f</span>dd5867 <span class="number">021</span>d6867</span><br><span class="line">#<span class="number">22</span>edd650 <span class="number">36457867</span> <span class="number">29b</span>d8867 <span class="number">1</span>d119867 <span class="number">22b</span>1a867</span><br><span class="line">#<span class="number">22</span>edd660 <span class="number">3175</span>c867 <span class="number">30</span>d5d867 <span class="number">2e620867</span> <span class="number">291</span>a1867</span><br><span class="line">#<span class="number">22</span>edd670 <span class="number">29f</span>21867 <span class="number">14</span>a62867 <span class="number">253e2867</span> <span class="number">03</span>c23867</span><br><span class="line">kd&gt; !db <span class="number">27e84000</span>            <span class="comment">// 查看数据</span></span><br><span class="line">#<span class="number">27e84000</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line">#<span class="number">27e84010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84020</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84030</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84040</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84050</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84060</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">#<span class="number">27e84070</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">015</span>de000            <span class="comment">// 通过notepad.exe的CR3获取PDE</span></span><br><span class="line"># <span class="number">15</span>de000 <span class="number">3b</span>822867 <span class="number">37</span>a23867 <span class="number">0</span>c64e867 <span class="number">07f</span>55867</span><br><span class="line"># <span class="number">15</span>de010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">29f</span>af867</span><br><span class="line"># <span class="number">15</span>de020 <span class="number">285b</span>3867 <span class="number">38</span>cf1867 <span class="number">023f</span>5867 <span class="number">04737867</span></span><br><span class="line"># <span class="number">15</span>de030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">15</span>de070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">3b</span>822000            <span class="comment">// 查看notepad.exe的PTE</span></span><br><span class="line">#<span class="number">3b</span>822000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822040 <span class="number">321f</span>8847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">3b</span>822070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">3b</span>822000 <span class="number">27e84867</span>       <span class="comment">// 将进程的PTE挂到notepad.exe的0地址上</span></span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> * mem = (<span class="type">int</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">2424</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="带页内偏移挂页"><a href="#带页内偏移挂页" class="headerlink" title="带页内偏移挂页"></a>带页内偏移挂页</h3><blockquote><ol><li>拆地址<br>80000 &#x3D;&gt; 0000 0000 00 | 00 1000 0000 | 0000 0000 0000<br>0000 0000 0000 &#x3D;&gt; 0<br>0000 1000 0000 &#x3D;&gt; 080<br>0000 0000 0000 &#x3D;&gt; 0</li></ol></blockquote><blockquote><ol start="2"><li>WinDBG中设置</li></ol></blockquote><ul><li><p>notepad.exe进程信息<br>PROCESS 87564030  SessionId: 1  Cid: 129c    Peb: 7ffdf000  ParentCid: 0a48<br>  DirBase: 34cc7000  ObjectTable: 95581928  HandleCount:  60.<br>  Image: notepad.exe</p></li><li><p>实验程序进程信息<br>PROCESS 86d307c8  SessionId: 1  Cid: 151c    Peb: 7ffd9000  ParentCid: 1478<br>  DirBase: 1611b000  ObjectTable: 954c7388  HandleCount:  19.<br>  Image: 10_16_HangingPage(¹ÒÒ³).exe</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">1611b</span>000        <span class="comment">// 通过实验程序获取PDE</span></span><br><span class="line">#<span class="number">1611b</span>000 <span class="number">2915f</span>867 <span class="number">0</span>c066867 <span class="number">00000000</span> <span class="number">05</span>cdc867</span><br><span class="line">#<span class="number">1611b</span>010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">1611b</span>070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">2915f</span>000+<span class="number">080</span>*<span class="number">4</span>      <span class="comment">// 获取PTE</span></span><br><span class="line">#<span class="number">2915f</span>200 <span class="number">06204867</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>210 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>220 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>230 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>240 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>250 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>260 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">2915f</span>270 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">06204000</span>            <span class="comment">// 查看数据</span></span><br><span class="line"># <span class="number">6204000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204010</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204020</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204030</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204040</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204050</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204060</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">6204070</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !db <span class="number">06204000</span>+<span class="number">0x100</span>      <span class="comment">// 由于页内偏移为0x100, 所以需要加上0x100</span></span><br><span class="line"># <span class="number">6204100</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span> <span class="number">6</span>a <span class="number">00</span>-b8 b1 ed da <span class="number">75</span> ff d0 c3 j.j.j.j.....u...</span><br><span class="line"># <span class="number">6204110</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204120</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204130</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204140</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204150</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204160</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line"># <span class="number">6204170</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ................</span><br><span class="line">kd&gt; !dd <span class="number">34</span>cc7000            <span class="comment">// 获取notepad.exe的PDE</span></span><br><span class="line">#<span class="number">34</span>cc7000 <span class="number">09f</span>40867 <span class="number">3</span>af52867 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7010 <span class="number">26825867</span> <span class="number">22b</span>e6867 <span class="number">0</span>c4c7867 <span class="number">30</span>d00867</span><br><span class="line">#<span class="number">34</span>cc7020 <span class="number">3</span>d901867 <span class="number">00000000</span> <span class="number">26f</span>d8867 <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7040 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">#<span class="number">34</span>cc7070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !dd <span class="number">09f</span>40000            <span class="comment">// 获取notepad.exe的PTE</span></span><br><span class="line"># <span class="number">9f</span>40000 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40010 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40020 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40030 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40040 <span class="number">28f</span>16847 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40050 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40060 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"># <span class="number">9f</span>40070 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">kd&gt; !ed <span class="number">09f</span>40000 <span class="number">06204867</span>   <span class="comment">// 将实验程序的PTE挂到notepad.exe的0地址上</span></span><br><span class="line">kd&gt; g</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>实验代码</li></ol></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_16_HangingPage(挂页).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(__stdcall * FuncProc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> * mem = (<span class="type">char</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">FuncProc func = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufcode[] = </span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0x6A</span>, <span class="number">0</span>,<span class="comment">// push 0</span></span><br><span class="line"><span class="number">0xb8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="comment">// mov eax, 0x12345678</span></span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xd0</span>,<span class="comment">// call eax</span></span><br><span class="line"><span class="number">0xc3</span>,<span class="comment">// ret</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">*(<span class="type">int</span>*)&amp;bufcode[<span class="number">9</span>] = (ULONG)MessageBoxA;</span><br><span class="line"><span class="built_in">memcpy</span>(mem+<span class="number">0x100</span>, bufcode, <span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FuncProc func = (FuncProc)mem;</span></span><br><span class="line"><span class="comment">// func();</span></span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="number">4764</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hProcess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OpenProcess Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)<span class="number">0x100</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateRemoteThread Failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hThread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, *mem);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-页表配置</title>
    <link href="http://example.com/220f9f18.html"/>
    <id>http://example.com/220f9f18.html</id>
    <published>2024-10-13T14:54:31.000Z</published>
    <updated>2024-10-14T01:21:57.880Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>页表配置</strong></p></div><span id="more"></span><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul><li>关闭pae选项<br>bcdedit &#x2F;set pae ForceDisable</li><li>设置nx<br>bcdedit &#x2F;set nx AlwaysOff</li></ul>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;页表配置&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-中断门</title>
    <link href="http://example.com/7297abab.html"/>
    <id>http://example.com/7297abab.html</id>
    <published>2024-10-11T01:13:13.000Z</published>
    <updated>2024-10-13T14:41:28.889Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>中断门</strong></p></div><span id="more"></span><h2 id="中断门知识点"><a href="#中断门知识点" class="headerlink" title="中断门知识点"></a>中断门知识点</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li><p>int 32的计算: 80b98100 - 80b98000 &#x3D; 100（16进制） &#x2F; 8 &#x3D; 20 &#x3D;&gt; 32（10进制）</p></li><li><p>填充中断门描述符, 函数地址是: 00401080;<br>0040ee00&#96;00081080</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">00000000</span>`<span class="number">00080000</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br><span class="line"></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98100 <span class="number">0040</span>ee00`<span class="number">00081080</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000 L30</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>98080  <span class="number">83e58</span>e00`<span class="number">0008</span>a154 <span class="number">83e58</span>e00`<span class="number">0008</span>a488</span><br><span class="line"><span class="number">80b</span>98090  <span class="number">00008500</span>`<span class="number">00</span>a00000 <span class="number">83e58</span>e00`<span class="number">0008</span>a7e4</span><br><span class="line"><span class="number">80b</span>980a0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980b0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980c0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980d0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980e0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br><span class="line"><span class="number">80b</span>980f0  <span class="number">83e58</span>e00`<span class="number">00089e40</span> <span class="number">83e58</span>e00`<span class="number">0008</span>abb0</span><br><span class="line"><span class="number">80b</span>98100  <span class="number">0040</span>ee00`<span class="number">00081080</span> <span class="number">00000000</span>`<span class="number">00080000</span></span><br></pre></td></tr></table></figure></li><li><p>中断门0环堆栈压了五个值, eip, cs, eflags, esp, ss, 3环堆栈无内容;<br>3环寄存器:<br>EAX &#x3D; 00000000 EBX &#x3D; 7FFD5000 ECX &#x3D; BFBDF6C4 EDX &#x3D; 005F0178 ESI &#x3D; 0012FE3C EDI &#x3D; 0012FF08 EIP &#x3D; 004011A7 ESP &#x3D; <code>0012FE3C</code> EBP &#x3D; 0012FF08 EFL &#x3D; 00000246<br>CS &#x3D; 001B DS &#x3D; 0023 ES &#x3D; 0023 SS &#x3D; 0023 FS &#x3D; 003B GS &#x3D; 0000<br>0环寄存器:<br>eax&#x3D;00000000 ebx&#x3D;7ffd5000 ecx&#x3D;bfbdf6c4 edx&#x3D;005f0178 esi&#x3D;0012fe3c edi&#x3D;0012ff08<br>eip&#x3D;00401080 esp&#x3D;<code>94e63c9c</code> ebp&#x3D;0012ff08 iopl&#x3D;0         nv up di pl zr na pe nc<br>cs&#x3D;0008  ss&#x3D;0010  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;0030  gs&#x3D;0000             efl&#x3D;00000046</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dds <span class="number">94e63</span>c9c</span><br><span class="line"><span class="number">94e63</span>c9c  <span class="number">004011</span>a9          &lt;== eip</span><br><span class="line"><span class="number">94e63</span>ca0  <span class="number">0000001b</span>          &lt;== cs</span><br><span class="line"><span class="number">94e63</span>ca4  <span class="number">00000246</span>          &lt;== eflags</span><br><span class="line"><span class="number">94e63</span>ca8  <span class="number">0012f</span>e3c          &lt;== esp</span><br><span class="line"><span class="number">94e63</span>cac  <span class="number">00000023</span>          &lt;== ss</span><br><span class="line"><span class="number">94e63</span>cb0  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb4  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cb8  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cbc  <span class="number">00000000</span></span><br><span class="line"><span class="number">94e63</span>cc0  <span class="number">0000027f</span></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_11_InterruptGate(中断门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_GDTINFO</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">short</span> limit;</span><br><span class="line">ULONG table;</span><br><span class="line">&#125;GDTINFO;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="comment">//char bufgdt[6];</span></span><br><span class="line"><span class="comment">//char bufidt[6];</span></span><br><span class="line">GDTINFO gdts;</span><br><span class="line">GDTINFO idts;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*sgdt bufgdt;</span></span><br><span class="line"><span class="comment">sidt bufidt;*/</span></span><br><span class="line">sgdt gdts;          <span class="comment">// 获取gdtr</span></span><br><span class="line">sidt idts;          <span class="comment">// 获取idtr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="IDT和GDT的关联"><a href="#IDT和GDT的关联" class="headerlink" title="IDT和GDT的关联"></a>IDT和GDT的关联</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">80b</span>98000</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98000</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98000  <span class="number">83e58</span>e00`<span class="number">00085210</span> <span class="number">83e58</span>e00`<span class="number">0008557</span>c</span><br><span class="line"><span class="number">80b</span>98010  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e5</span>ee00`<span class="number">00085f</span>c0</span><br><span class="line"><span class="number">80b</span>98020  <span class="number">83e5</span>ee00`<span class="number">00086338</span> <span class="number">83e58</span>e00`<span class="number">00086688</span></span><br><span class="line"><span class="number">80b</span>98030  <span class="number">83e58</span>e00`<span class="number">000869</span>ec <span class="number">83e58</span>e00`<span class="number">000876f</span>8</span><br><span class="line"><span class="number">80b</span>98040  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e58</span>e00`<span class="number">00087</span>d3c</span><br><span class="line"><span class="number">80b</span>98050  <span class="number">83e58</span>e00`<span class="number">00088050</span> <span class="number">83e58</span>e00`<span class="number">00088380</span></span><br><span class="line"><span class="number">80b</span>98060  <span class="number">83e58</span>e00`<span class="number">000887f</span>0 <span class="number">83e58</span>e00`<span class="number">00088</span>cfc</span><br><span class="line"><span class="number">80b</span>98070  <span class="number">83e58</span>e00`<span class="number">000899b</span>8 <span class="number">83e58</span>e00`<span class="number">00089e40</span></span><br></pre></td></tr></table></figure><ul><li>在IDT中, int3中的3代表的是索引;</li><li>83e5ee00<code>00085fc0</code>（int 3）中段选择子0008表示去查找GDT中00cf9b00&#96;0000ffff;</li></ul><h3 id="IDT描述符"><a href="#IDT描述符" class="headerlink" title="IDT描述符"></a>IDT描述符</h3><blockquote><p>5.11 页码123</p></blockquote><ul><li>D位（第11位）是指默认操作数, 32位下为1, 16位下为0;</li></ul><h3 id="3环获取GDT和IDT的指令"><a href="#3环获取GDT和IDT的指令" class="headerlink" title="3环获取GDT和IDT的指令"></a>3环获取GDT和IDT的指令</h3><ul><li><p>获取GDT&#x2F;获取IDT: sgdt&#x2F;sidt（3环下调用）;</p><blockquote><p>获取到gdt的值为<code>ff 03 00 88 b9 80</code>; 其中前两个字节为表的长度, 后四个字节为表的地址; </p></blockquote></li><li><p>修改GDT&#x2F;修改IDT: lgdt&#x2F;lidt（0环下才能调用）;</p></li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><blockquote><p>iretd中的<code>d</code>描述宽度用的; 16位（iret）、32位（iretd）、64位（iretq）;</p></blockquote><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>返回一定要用iretd吗? 使用retf;</li></ol></blockquote><ul><li>iretd 解除阻塞;</li><li>retf 没有解除阻塞;</li><li>sti 解除阻塞, 并且给eflags.IF &#x3D; 1;</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InterruptGate_retf.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断门使用retf返回</span></span><br><span class="line"><span class="comment">// 0040ee00`00081080 </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">sti;<span class="comment">// 解除阻塞, 并且使eflags.IF = 1</span></span><br><span class="line"><span class="comment">// int 3</span></span><br><span class="line">retf <span class="number">4</span>;<span class="comment">// 使用 retf 4 是为了确保在中断处理程序返回时，除了恢复 CS:EIP 外，还能从栈中弹出这个附加的 4 字节（通常是错误代码），确保栈平衡</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// push 0x12345678;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">push <span class="number">0x3b</span>;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>构建陷阱门自己调用;</li></ol></blockquote><ul><li>TYPE位为f, 0040ee00&#96;00081080;</li></ul><div class="note bug"><p><strong>中断门和陷阱门的区别</strong></p><p>1.<br>进入中断门会清除eflag VM NT IF TF 位<br>进入陷阱门会清除eflag VM NT TF 位<br>2.<br>由于中断门会清除IF位，导致一些中断触发会悬挂，陷阱门则不会</p></div><h2 id="int3-hook"><a href="#int3-hook" class="headerlink" title="int3_hook"></a>int3_hook</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>第一步：添加一个代码段在0x48位置</li><li>第二步：计算代码段0x48的base<br> 目标地址 - int 3偏移&#x3D; base<br> 写回0x48位置</li><li>第三步：修改int 3中断门的段选择子为0x48</li><li>Hook函数编写<br> 由于有缓存的存在, 可以执行一会, 那么我们在这要做二次跳转<br> jmp 0x48: xxx地址</li><li>当调到xxx地址后, 通过调用打印函数, 确定调用成功</li><li>jmp回int 3原本的偏移</li></ol><div class="note info"><p><strong></strong></p><p>base：401080 - 83e44fc0(int 3) &#x3D; 7C5B C0C0</p><p>段描述：00cf9b00&#96;0000ffff</p><p>修改gdtr 0x48位置<br>eq 80b98848 7Ccf9b5B&#96;C0C0ffff</p><p>修改int 3段选择子为48<br>eq 80b98018 83e7ee00&#96;0048dfc0</p><p>83e11c60</p></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_24_int3_hook.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BASE：401080 - 83e7dfc0(int 3) = 7C58 30C0</span></span><br><span class="line"><span class="comment">// 段描述：00cf9b00`0000ffff</span></span><br><span class="line"><span class="comment">// 修改GDTR：eq 80b98848 7Ccf9b58`30c0ffff</span></span><br><span class="line"><span class="comment">// 修改IDTR：eq 80b98018 83e7ee00`0048dfc0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span><span class="params">(__CRTDECL *DbgPrintProc)</span><span class="params">(_In_z_ _Printf_format_string_ <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span> _Format, ...)</span></span>;</span><br><span class="line">DbgPrintProc DbgPrint = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> * xxxstr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//push 0x8;</span></span><br><span class="line"><span class="comment">//push haha;</span></span><br><span class="line">sub esp, <span class="number">8</span>;</span><br><span class="line">lea eax, haha;</span><br><span class="line">mov [esp], eax;</span><br><span class="line">mov [esp+<span class="number">4</span>], <span class="number">0x8</span>;</span><br><span class="line">jmp fword ptr [esp];</span><br><span class="line">haha:</span><br><span class="line">add esp, <span class="number">8</span>;</span><br><span class="line">push fs;</span><br><span class="line">mov ax, <span class="number">0x30</span>;</span><br><span class="line">mov fs, ax;</span><br><span class="line"><span class="comment">// 业务逻辑</span></span><br><span class="line">mov eax, [xxxstr];</span><br><span class="line">push eax;</span><br><span class="line">call DbgPrint;</span><br><span class="line">add esp, <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">pop fs;</span><br><span class="line"><span class="comment">// 跳回int3</span></span><br><span class="line">mov dword ptr ss:[esp<span class="number">-4</span>], <span class="number">0x83e44fc0</span>;</span><br><span class="line">jmp dword ptr ss:[esp<span class="number">-4</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line">xxxstr = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(xxxstr, <span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>));</span><br><span class="line">xxxstr[<span class="built_in">strlen</span>(<span class="string">&quot;xxxx__main__xxxx\r\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">DbgPrint = (DbgPrintProc)<span class="number">0x83e11c60</span>;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;中断门&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-调用门提权</title>
    <link href="http://example.com/fb02f1f0.html"/>
    <id>http://example.com/fb02f1f0.html</id>
    <published>2024-10-10T14:40:57.000Z</published>
    <updated>2024-10-11T15:47:38.553Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>调用门提权</strong></p></div><span id="more"></span><h2 id="调用门知识点"><a href="#调用门知识点" class="headerlink" title="调用门知识点"></a>调用门知识点</h2><blockquote><p>当S位为0, TYPE位为C, 这个就是调用门;</p></blockquote><blockquote><p>cs.DPL &#x3D;&#x3D; ss.DPL &#x3D;&#x3D; 调用门.DPL;</p></blockquote><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li>填充调用门描述符（参数暂时为0个）; 函数地址为00401080;<br>0040ec00&#96;00081080</li><li>修改gdtr<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0040</span>ec02`<span class="number">00081080</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure></li><li>cs寄存器为0008, ss寄存器为0010<blockquote><p>cs + 8 &#x3D; ss</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">7f</span>fd6000 ecx=<span class="number">4</span>a36ab6a edx=<span class="number">0052017</span>c esi=<span class="number">0012f</span>e28 edi=<span class="number">0012f</span>f08</span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">89b</span>49c98 ebp=<span class="number">0012f</span>f08 iopl=<span class="number">0</span>         nv up ei pl zr na pe nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line"><span class="number">00401080</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li>返回时报错<blockquote><p>进入0环前fs寄存器为0x3b, 进入0环后会将fs修改成0x30, 在返回时未进行修复;</p></blockquote></li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10_10_CallGate(调用门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">retf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span> bufcode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, test);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">push fs;</span><br><span class="line">call fword ptr bufcode;</span><br><span class="line">pop fs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权只压两个值（eip, cs）; 跨段提权会压四个值（eip, cs, esp, ss）;</p></blockquote><blockquote><p>retf有参数时需要加上参数, 两个参数retf 8;</p></blockquote><h3 id="系统描述符类型"><a href="#系统描述符类型" class="headerlink" title="系统描述符类型"></a>系统描述符类型</h3><p>当段描述符的S标志（描述符类型）为0, 则描述符为系统描述符。处理器可以识别以下类型的系统描述符: </p><ul><li>局部描述符表（LDT）段描述符;</li><li>任务状态段（TSS）描述符;</li><li>调用门描述符;</li><li>中断门描述符;</li><li>陷阱门描述符;</li><li>任务门描述符;</li></ul><blockquote><p>这些描述符又可以分为两类: 系统段描述符和门描述符。系统段描述符指向系统段（LDT和TSS段）。门描述符它们自身就是”门”, 它们或者持有指向放置在代码段中的过程入口点的指针, 或者持有TSS（任务门）的段选择子。</p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png' data-fancybox='default' data-caption='系统段和门描述类型'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410112335684.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="系统段和门描述类型"></a><span class='image-caption'>系统段和门描述类型</span></div></div><h3 id="调用门格式"><a href="#调用门格式" class="headerlink" title="调用门格式"></a>调用门格式</h3><blockquote><p>4.8.3, 页码是93;</p></blockquote><blockquote><p>调用门为不同特权级间的进程控制转移提供了便利。它们一般只用在使用特权级保护机制的操作系统或管理程序中。调用门也可用于16位和32位代码段之间进程控制转移, 这在17.4.“混合尺寸代码段之间的控制转移”中进行描述。</p></blockquote><blockquote><p>调用门描述符可用在GDT或LDT中, 但是不能在中断描述符表（IDT）中。它具有六个方面的功能:</p></blockquote><ul><li>确定将要访问的代码段;</li><li>定义例程在指定代码段的入口;</li><li>指定调用例程的所应当有的特权级;</li><li>如果有栈切换, 就确定在栈之间拷贝的可选参数的个数;</li><li>定义压入目标栈的值的尺寸: 16位的门执行16位的压栈, 32位的门执行32位的压栈;</li><li>确定调用门描述符是否有效;</li></ul><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><ol><li>使用jmp跨段跳转调用门;</li></ol></blockquote><ul><li>在调用门上不支持改cs寄存器的值;</li><li>jmp在调用门只能同权限跳转;</li></ul><blockquote><ol start="2"><li>既然ret也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>无法修改cs寄存器的值, 无法提权, 也没有提权的悬念</li></ul><blockquote><ol start="3"><li>既然retf也能跳转, 那么是否可以提权;</li></ol></blockquote><ul><li>英特尔规定retf只能同权限或向低权限跳转;</li></ul><blockquote><p>补充</p></blockquote><ul><li>call是同权限或者提权跳转</li></ul>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;调用门提权&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-数据段代码段的权限规则</title>
    <link href="http://example.com/93e9d7f1.html"/>
    <id>http://example.com/93e9d7f1.html</id>
    <published>2024-10-08T16:52:16.000Z</published>
    <updated>2024-10-08T18:06:06.493Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>数据段代码段的权限规则</strong></p><ol><li>段的权限规则 代码段、数据段、堆栈段;</li><li>跨段跳转不提权 写法 jmp call;</li></ol></div><span id="more"></span><h2 id="裸函数知识点"><a href="#裸函数知识点" class="headerlink" title="裸函数知识点"></a>裸函数知识点</h2><ul><li>关闭<code>增量链接</code>;</li><li>关闭<code>随机基址</code>;</li></ul><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 裸函数 不生成多余汇编代码</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        ret     ;<span class="comment">// 不加ret会导致程序报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据段代码段的权限规则知识点"><a href="#数据段代码段的权限规则知识点" class="headerlink" title="数据段代码段的权限规则知识点"></a>数据段代码段的权限规则知识点</h2><ul><li>DPL: Descriptor privilege level;</li><li>CPL: Current privilege level（CS段描述符的DPL）;</li><li>RPL: Request privilege level;</li></ul><blockquote><p>普通的数据段（DS、ES）下RPL可以乱给的;<br>在堆栈段（SS）下是有用的, RPL &#x3D;&#x3D; CPL &#x3D;&#x3D; DPL才能更改;<br>在代码段（DS）上是没用的, CPL &#x3D;&#x3D; DPL能更改, RPL系统会改回去;</p></blockquote><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>跨段不提权跳转会将ESP和CS压到堆栈中, 所以会是ESP-8;<br>使用<code>retf</code>;</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;数据段代码段的权限规则&lt;/strong&gt;&lt;/p&gt;&lt;ol&gt;&lt;li&gt;段的权限规则 代码段、数据段、堆栈段;&lt;/li&gt;&lt;li&gt;跨段跳转不提权 写法 jmp call;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-段探测</title>
    <link href="http://example.com/b4fed552.html"/>
    <id>http://example.com/b4fed552.html</id>
    <published>2024-09-29T02:26:26.000Z</published>
    <updated>2024-10-11T15:37:05.770Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>段</strong></p></div><span id="more"></span><h2 id="段知识点"><a href="#段知识点" class="headerlink" title="段知识点"></a>段知识点</h2><div class="note info"><p><strong></strong></p><ul><li>CS 代码寄存器 描述的代码</li><li>SS 栈段 描述的栈  比如局部变量</li><li>DS 数据段 堆地址  比如全局变量</li><li>ES 扩展段 串copy movsb so edi esi</li><li>FS 上下文环境段 R3: 代表TEB R0: 代表KPCR</li></ul></div><h3 id="段选择子"><a href="#段选择子" class="headerlink" title="段选择子"></a>段选择子</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png' data-fancybox='default' data-caption='段选择子'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072350696.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段选择子"></a><span class='image-caption'>段选择子</span></div></div><blockquote><p>段选择子是一个16位的段的标识码。它并不直接指向段, 而是指向定义段的描述符。段选择子包含以下项目:</p></blockquote><ul><li><p>Index(索引): 第3位到第15位。选择GDT或LDT中8192个描述符中的某一个。处理器将索引值乘以8（段描述符的字节数）, 然后加上GDT或LDT的基地址（分别在GDTR寄存器或者LDTR寄存器中）。</p></li><li><p>TI(table indivator) flag: 第2位。确定使用哪一个描述符表: 将这个标志置0, 则表示用GDT。将这个标志置1, 标识用LDT;</p></li><li><p>Request Privilege Level(RPL 请求的特权级): 第0位和第1位。确定选择子的特权级。特权级的范围是0到3, 0为最高特权级。</p></li></ul><h3 id="段描述符"><a href="#段描述符" class="headerlink" title="段描述符"></a>段描述符</h3><blockquote><p><code>段描述符</code>是GDT或LDT中的一个数据结构, 它为处理器提供诸如段基地址、段大小、访问权限以及状态等信息。<code>段描述符</code>主要是由编译器、连接器、装载器或者操作系统&#x2F;管理程序设立的, 而不是由应用程序产生的。 </p></blockquote><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png' data-fancybox='default' data-caption='段描述符'><img fancybox itemprop="contentUrl" src="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202410072207100.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="段描述符"></a><span class='image-caption'>段描述符</span></div></div><h4 id="段描述符中的标志和域"><a href="#段描述符中的标志和域" class="headerlink" title="段描述符中的标志和域"></a>段描述符中的标志和域</h4><blockquote><p>段界限域: 指定段的大小。处理器将两个段界限域合在一起组成一个20位的段界限值。根据G标志位（粒度）的不同设置, 处理器按两种不同的方式解释段界限</p></blockquote><ul><li>如果粒度标志位为0, 则段大小可以从1字节到1M字节, 段长增量单位为字节（以字节为单位）;</li><li>如果粒度标志位为1, 则段大小可以从4K字节到4G字节, 段长增量单位为4K字节（以页为单位 （0xFFFFF +1） * 4096(0x1000) &#x3D; （0xFFFFF +1） * 4096(0x1000) - 1）;</li></ul><blockquote><p>基地址域: 确定段的第一个字节（字节0）在4GB线性地址空间中位置。处理器将3个基地址域组合在一起构成了一个32位地址值。段基地址应当是16字节边界对齐的。16字节边界对齐不是必须的, 当这种段边界的对齐能够是程序把代码和数据对齐到16字节边界上而最大化其性能;</p></blockquote><blockquote><p>类型域: 指明段或门的类型, 确定段的访问权限和增长方向。如何解释这个域, 取决于该描述符是应用程序描述符（代码和数据）还是系统描述符。代码段、数据段和系统段对类型域有不同的编码</p></blockquote><blockquote><p>S(描述符类型)标志: 确定段描述符四系统描述符（S标记为0）或者代码、数据段描述符（S标记为1）;</p></blockquote><blockquote><p>DPL(描述符特权级)域: 指明段的特权级。特权级从0到3, 0为最高特权。DPL用来控制对段的访问;</p></blockquote><blockquote><p>P(段有效位)标志: 指明段当前是否在内存中（1表示在内存中, 0表示不在）。当指向段描述符的段选择子被装进段寄存器时, 如果这个标志为0, 处理器会产生段不存在异常（#NP）。内存管理软件可以通过这个标志, 来控制在某个特定时间有哪些段是真正的被载入物理内存的。这是除分页之外的另一个虚拟内存控制机制;</p></blockquote><blockquote><p>D&#x2F;B(默认操作数大小&#x2F;默认栈指针大小和&#x2F;或上限)标志: 根据段描述符所指的是可执行代码段、向下扩展的数据段还是堆栈段, 这个标志有不同的功能。（对32位的代码和数据段, 这个标志总是被设置成1, 而16位的代码和数据段, 这个标志总是被置为0）</p></blockquote><ul><li><p>可执行代码段: 这个标志被称为D标志, 它指明段中指令的有效地址和操作符的默认位数。如果该标志为1, 则默认32位的地址, 32位或者8位的操作符; 若为0, 则默认16位的地址, 16位或者8位的操作符。指令前缀66H可以指定操作符的长度而不使用缺省长度。前缀67H可用来指定地址值的长度。</p></li><li><p>堆栈段（SS寄存器所指的数据段）: 这个标志位被称为B（大的）标志, 它为隐含的栈操作（如push、pop和call）确定栈指针的大小。如果该标志为1, 则使用32位的栈指针, 栈指针放在32位的ESP寄存器中; 如该标志为0, 则使用16位的栈指针, 栈指针存放在SP寄存器。 如果堆栈段为一个向下扩展的数据段, 则B标志还确定堆栈段的地址上界。</p></li><li><p>向下扩展的数据段: 这个标志称为B标志, 确定段的地址上界。如果该标志为1, 则段地址上界为FFFFFFFFH(4GB); 若该标志为0, 则段地址上界为FFFFH(64KB)。</p></li></ul><blockquote><p>G(粒度)标志: 确定段界限扩展的增量。当G标志为0, 则段界限以字节为单位扩展; G标志为1, 则段界限以4KB为单位扩展。（这个标志不影响段基址的粒度, 段基址的粒度永远都是字节）如果G标志为1, 那么当检测偏移是否超越段界限时, 不用测试偏移的低12位。</p></blockquote><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h4 id="1-段存在权限限制"><a href="#1-段存在权限限制" class="headerlink" title="1.段存在权限限制"></a>1.段存在权限限制</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Segments.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段的初探</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> val = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> val2 = <span class="number">0x2</span>;</span><br><span class="line"><span class="comment">// 段读写的探测</span></span><br><span class="line"><span class="comment">/*__asm</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">mov ax, cs;</span></span><br><span class="line"><span class="comment">mov ds, ax;</span></span><br><span class="line"><span class="comment">mov eax, dword ptr [val];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov cx, ss;</span></span><br><span class="line"><span class="comment">mov ds, cx;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">mov dword ptr [val2], eax;</span></span><br><span class="line"><span class="comment">&#125;;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对base的探测</span></span><br><span class="line"><span class="comment">//__asm </span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//mov ax, 0x4b;</span></span><br><span class="line"><span class="comment">//mov ds, ax;</span></span><br><span class="line"><span class="comment">//mov eax, dword ptr ds:[val];</span></span><br><span class="line"><span class="comment">//mov dword ptr ss:[val2], eax;</span></span><br><span class="line"><span class="comment">//mov cx, es;</span></span><br><span class="line"><span class="comment">//mov ds, cx;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对段长度的探测</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax, fs:[<span class="number">0xffc</span>];<span class="comment">// base + 0</span></span><br><span class="line">mov val2, eax;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>, val2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote><p>拆分GDTR</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq <span class="number">80b</span>98800 L30</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0001f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98880  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98890  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>988a0  <span class="number">800089b</span>9`ad900067 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>00cf9b00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cf9300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cffb00&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">b</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0000ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>80008bb9&#96;8c0020ab</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98c00</td><td align="left">000020ab</td><td align="left">b</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>804093b9&#96;b0004fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9b000</td><td align="left">4fff</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0040f300&#96;00000fff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000000</td><td align="left">00fff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>0000f200&#96;0400ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000400</td><td align="left">ffff</td><td align="left">2</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>00cff300&#96;0001ffff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">00000001</td><td align="left">fffff</td><td align="left">3</td><td align="left">1</td><td align="left">3</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">1</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad200067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad20</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;acb00067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9acb0</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800092b9&#96;880003ff</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b98800</td><td align="left">03ff</td><td align="left">2</td><td align="left">1</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><blockquote><p>800089b9&#96;ad900067</p><table><thead><tr><th align="left">Base</th><th align="left">Limit</th><th align="left">Type</th><th align="left">S</th><th align="left">DPL</th><th align="left">P</th><th align="left">AVL</th><th align="left">0</th><th align="left">D\B</th><th align="left">G</th></tr></thead><tbody><tr><td align="left">80b9ad90</td><td align="left">0067</td><td align="left">9</td><td align="left">0</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table></blockquote><h2 id="D-B标志知识点"><a href="#D-B标志知识点" class="headerlink" title="D&#x2F;B标志知识点"></a>D&#x2F;B标志知识点</h2><div class="note info"><p><strong>D/B标志</strong></p><ul><li>当D&#x2F;B位作用于代码段时为D位, 当作用于数据段时为B位;</li><li>当描述代码段时, 默认操作数将会改变成16位的段;</li><li>当描述堆栈段时, 堆栈寻址将变成16位;</li><li>当描述普通数据段时, 没有任何反应;</li></ul></div><h3 id="代码实验-1"><a href="#代码实验-1" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 描述代码段时</span></span><br><span class="line"><span class="comment">// 1. 复制GDTR中cs段的描述符至0x48位置</span></span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 使用JMP指令进行cs段修改</span></span><br><span class="line">jmp far <span class="number">0x0048</span>:<span class="number">0x77D7062E</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 描述堆栈段</span></span><br><span class="line"><span class="comment">// 1. 修改0x48位置为00cff200`0000ffff（type域为2）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff200`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ss寄存器的值</span></span><br><span class="line">mov ax, <span class="number">0x4b</span>;</span><br><span class="line">mov ss, ax;</span><br><span class="line"><span class="comment">// 3. 加载段时0x48位置type域变成3</span></span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff300`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><h2 id="TYPE域知识点"><a href="#TYPE域知识点" class="headerlink" title="TYPE域知识点"></a>TYPE域知识点</h2><blockquote><p>当段描述符中S标志（描述符类型）为1时, 描述符为代码段描述符或者数据段描述符。类型域的最高位（段描述符的第二个双字的第11位）将决定该描述符为数据段描述符（为0）还是代码段描述符（为1）。</p></blockquote><blockquote><p>代码和数据段描述类型</p></blockquote><blockquote><p>对于数据段而言, 描述符的类型域的低3位（第8、9、10位）被解释为访问控制（A）、是否可写（W）、扩展方向（E）。数据段可以是只读或者可读写的段, 这取决于”是否可写”的标志。</p></blockquote><blockquote><p>堆栈段必须是可读写的数据段。将一个不可写的数据段的选择子置入SS寄存器会导致一般保护异常（#GP）。如果堆栈段的大小需要动态变化, 可以将其置为向下扩展数据段（扩展方向标志为1）。这里, 动态改变段界限将导致栈空间朝着栈底部空间扩展。如果栈的长度保持不变, 堆栈段可以是向上扩展的, 也可以是向下扩展的。</p></blockquote><blockquote><p>访问位表示自最后一次被操作系统清零后, 段是否被访问过。每当处理器将段的段选择子置入段寄存器时, 就将访问位置为1。该位一直保持1直到被显式清零。该位可以用于虚拟内存管理和测试。</p></blockquote><blockquote><p>对于代码段而言, 类型域的低3位被解释为访问位（A）、可读位（R）、一致位（C）。根据可读位的设置, 代码段可以为”只执行”或者”可执行可读”。当有常量或者其它静态数据与指令代码一起在ROM中时, 必须使用”可执行可读”的段。要从代码段读取数据, 可以通过带有CS前缀的指令或者将代码段选择子置入数目段寄存器（DS、ES、FS或者GS）。在保护模式下, 代码段是不可写的。</p></blockquote><blockquote><p>代码段可以是一致性的, 也可以是不一致性的。转入一个特权级更高的一致性段的进程可以在当前特权级继续执行下去。除非使用了调用门或者任务门, 否则, 转入一个不同特权级的非一致性段将使处理器产生一个”一般保护异常”（#GP）。不访问受保护程序的系统程序和某些类型的异常处理程序（比如除法错误或者溢出）可以被载入一致性的代码段。不能被特权级更低的程序和过程访问的程序应该被载入非一致性的代码段。</p></blockquote><div class="note bug"><p><strong>注意</strong></p><p>无论目标段是否为一致性代码段, 进程都不能因为<code>call</code>或<code>jump</code>而转入一个特权级较低（特权值较大）的代码段执行。试图进行这样的执行转换将导致一个一般保护异常（#GP）;</p></div><blockquote><p>所有数据段都是非一致性的, 这就意味着数据段不能被更低特权级的进程访问（特权级数值较大的执行代码）。然而, 和代码段不同, 数据段可以被更高优先级的程序或过程（特权级数值较小的执行代码）访问, 不需要使用特别的访问门.</p></blockquote><blockquote><p>如果GDT或者LDT中的段描述符被放置在ROM中, 当程序或者处理器试图更改在ROM中的段描述符时, 处理器将进入一个死循环。为了防止此类问题的发生, 可以将所有放置在ROM中的段描述符设置访问位。同时, 删除所有操作系统代码中试图更改放置在ROM中的段描述符的代码。</p></blockquote><h2 id="段控制内存访问方向知识点"><a href="#段控制内存访问方向知识点" class="headerlink" title="段控制内存访问方向知识点"></a>段控制内存访问方向知识点</h2><h3 id="代码实验-2"><a href="#代码实验-2" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 修改gdtr中0x48位置为00cff600`0000ffff（type域为6表示读/写, 内存向下扩展）</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98848 <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98848 <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00</span>cff600`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="comment">// 2. 修改ds寄存器</span></span><br><span class="line">mov ax, <span class="number">0x48</span>;</span><br><span class="line">mov ds, ax;</span><br><span class="line"><span class="comment">// 运行将产生异常, 将Limit和Base修改成0进行修复（0c0f600`00000000）</span></span><br></pre></td></tr></table></figure><div class="note bug"><p><strong></strong></p><ul><li>非一致代码段: 应用层不能调用内核层代码;</li><li>一致代码段: 应用层可以直接调用CS描述的一致代码段;</li></ul></div>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;段&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-任务门</title>
    <link href="http://example.com/9144b229.html"/>
    <id>http://example.com/9144b229.html</id>
    <published>2024-09-28T01:10:10.000Z</published>
    <updated>2024-09-29T01:40:47.891Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>任务门</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>00407030 -&gt; 0000e940&#96;70300068</p><p>GDT: eq 80b98848 0000e940<code>70300068 IDT: eq 80b98100 0000e500</code>00480000</p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="INT-8双重异常"><a href="#INT-8双重异常" class="headerlink" title="INT 8双重异常"></a>INT 8双重异常</h3><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_28_TaskGate(任务门).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务门</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf_s</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line"><span class="type">int</span> <span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;任务门&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核-任务段</title>
    <link href="http://example.com/f79a1477.html"/>
    <id>http://example.com/f79a1477.html</id>
    <published>2024-09-27T14:14:14.000Z</published>
    <updated>2024-09-28T15:55:56.090Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>任务段</strong></p></div><span id="more"></span><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><ul><li>在程序中获取到<code>tss</code>的地址, 例如: <code>00407030</code>; </li><li>拼接段描述符: <strong>0000e940&#96;703020ac</strong>;</li><li>修改<code>GDTR</code>中段描述符;</li></ul><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="KTSS结构体"><a href="#KTSS结构体" class="headerlink" title="_KTSS结构体"></a>_KTSS结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> Esp0             : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Ss0              : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : Uint2B</span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> CR3              : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Eax              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> Esp              : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> Es               : Uint2B</span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : Uint2B</span><br><span class="line">   +<span class="number">0x04c</span> Cs               : Uint2B</span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : Uint2B</span><br><span class="line">   +<span class="number">0x050</span> Ss               : Uint2B</span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : Uint2B</span><br><span class="line">   +<span class="number">0x054</span> Ds               : Uint2B</span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : Uint2B</span><br><span class="line">   +<span class="number">0x058</span> Fs               : Uint2B</span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : Uint2B</span><br><span class="line">   +<span class="number">0x05c</span> Gs               : Uint2B</span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : Uint2B</span><br><span class="line">   +<span class="number">0x060</span> LDT              : Uint2B</span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : Uint2B</span><br><span class="line">   +<span class="number">0x064</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : Uint2B</span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>] UChar</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="代码实验"><a href="#代码实验" class="headerlink" title="代码实验"></a>代码实验</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当输入CR3后进入0环断点后的各种情况</span></span><br><span class="line">kd&gt; r tr</span><br><span class="line">tr=<span class="number">00000048</span>         <span class="comment">// 当前tr寄存器已改变为0x48, 之前为0x28</span></span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0xad01fcb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401364</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0x246</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0xfde7b46e</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0x270178</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0x7ffd6000</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0x12fe04</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0x12ff08</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; u <span class="number">0x401364</span></span><br><span class="line"><span class="number">00401364</span> cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line"><span class="number">00401365</span> c0528bcd        rcl     byte ptr [edx<span class="number">-75</span>h],<span class="number">0</span>CDh</span><br><span class="line"><span class="number">00401369</span> <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0040136</span>a <span class="number">8</span>d1598134000    lea     edx,ds:[<span class="number">401398</span>h]</span><br><span class="line"><span class="number">00401370</span> e87b020000      call    <span class="number">004015f</span>0</span><br><span class="line"><span class="number">00401375</span> <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">00401376</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">00401377</span> <span class="number">5f</span>              pop     edi</span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; dt _KTSS <span class="number">00407030</span></span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0x28</span>               <span class="comment">// 上一个段的</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x40b0d0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f31e640</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401080</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x40d0d0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">8</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x30</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">kd&gt; r</span><br><span class="line">eax=<span class="number">00000000</span> ebx=<span class="number">00000000</span> ecx=<span class="number">00000000</span> edx=<span class="number">00000000</span> esi=<span class="number">00000000</span> edi=<span class="number">00000000</span></span><br><span class="line">eip=<span class="number">00401080</span> esp=<span class="number">0040</span>d0d0 ebp=<span class="number">00000000</span> iopl=<span class="number">0</span>         nv up di pl nz na po nc</span><br><span class="line">cs=<span class="number">0008</span>  ss=<span class="number">0010</span>  ds=<span class="number">0023</span>  es=<span class="number">0023</span>  fs=<span class="number">0030</span>  gs=<span class="number">0000</span>             efl=<span class="number">00004002</span> <span class="comment">// 0100 0000 0000 0010 NT</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0                <span class="comment">// 上面结构体中的esp</span></span><br><span class="line">kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00407030</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">80b</span>98800</span><br><span class="line">kd&gt; dq <span class="number">80b</span>98800</span><br><span class="line">ReadVirtual: <span class="number">80b</span>98800 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>98800  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98810  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>98820  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>b9`<span class="number">8</span>c0020ab</span><br><span class="line"><span class="number">80b</span>98830  <span class="number">804093b</span>9`b0004fff <span class="number">7f</span>40f3fd`f0000fff</span><br><span class="line"><span class="number">80b</span>98840  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">0000</span>eb40`<span class="number">70300100</span>       <span class="comment">// 段描述符中的eb和48中的一致</span></span><br><span class="line"><span class="number">80b</span>98850  <span class="number">800089b</span>9`ad200067 <span class="number">800089b</span>9`acb00067</span><br><span class="line"><span class="number">80b</span>98860  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>98870  <span class="number">800092b</span>9`<span class="number">880003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">kd&gt; r esp</span><br><span class="line">esp=<span class="number">0040</span>d0d0</span><br><span class="line">kd&gt; dds <span class="number">0040</span>d0d0        <span class="comment">// 使用call跨段跳转时会保存cs、esp、ss、eip</span></span><br><span class="line"><span class="number">0040</span>d0d0  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0d8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0dc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e0  <span class="number">00000004</span></span><br><span class="line"><span class="number">0040</span>d0e4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0e8  <span class="number">00000002</span></span><br><span class="line"><span class="number">0040</span>d0ec  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f0  <span class="number">00000001</span></span><br><span class="line"><span class="number">0040</span>d0f4  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0f8  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d0fc  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d100  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d104  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d108  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d10c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d110  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d114  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d118  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d11c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d120  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d124  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d128  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d12c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d130  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d134  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d138  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d13c  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d140  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d144  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d148  <span class="number">00000000</span></span><br><span class="line"><span class="number">0040</span>d14c  <span class="number">00000000</span></span><br></pre></td></tr></table></figure><h4 id="通过jmp指令提权"><a href="#通过jmp指令提权" class="headerlink" title="通过jmp指令提权"></a>通过jmp指令提权</h4><ul><li>jmp可以通过任务段提权, 同时替换CS和SS寄存器</li></ul><h4 id="怎样返回3环"><a href="#怎样返回3环" class="headerlink" title="怎样返回3环"></a>怎样返回3环</h4><blockquote><p>使用call跨段跳转时会保存cs、esp、ss、eip, 使用任务门时没保存这些值, 怎么返回？</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;          <span class="comment">// &lt;-- 导致系统奔溃的主要原因, 清空了NT位</span></span><br><span class="line"></span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note info"><p><strong>问题剖析</strong></p><ul><li>恢复运行后将导致系统崩溃, 中断门会修改VM、NT、IF、TF位, 并按照堆栈返回, 当NT位置0后再根据堆栈返回时将出现系统崩溃;</li><li>iretd指令首先检测eflag.NT位, 如果NT位等于0, 就按照堆栈返回; 如果NT位等于1, 就按照Backlink找到要返回的上下文环境返回;</li></ul></div><ul><li>解决方式</li></ul><ol><li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">        pushfd;</span><br><span class="line">        pop eax;</span><br><span class="line">        <span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">        push eax;</span><br><span class="line">        popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>需要手动修复dg 28中_KTSS结构的CR3<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">...</span><br><span class="line">PROCESS <span class="number">85b</span>021a8  SessionId: <span class="number">1</span>  Cid: <span class="number">0e60</span>    Peb: <span class="number">7f</span>fde000  ParentCid: <span class="number">0e4</span>c</span><br><span class="line">    DirBase: <span class="number">3f</span>344640  ObjectTable: <span class="number">959357</span>d8  HandleCount:   <span class="number">7.</span></span><br><span class="line">    Image: <span class="number">09</span>_27_TaskSegments(ÈÎÎñ¶Î).exe</span><br><span class="line">kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">80b</span>98c00 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span>          <span class="comment">// &lt;-- 需要手动修复成该程序的CR3</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line">kd&gt; eq <span class="number">80b</span>98c00+<span class="number">1</span>c <span class="number">3f</span>344640</span><br><span class="line">WriteVirtual: <span class="number">80b</span>98c1c <span class="keyword">not</span> properly sign extended</span><br><span class="line">kd&gt; dt _KTSS <span class="number">80b</span>98c00</span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x83f75cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x3f344640</span>         <span class="comment">// &lt;-- 修复后</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><blockquote><p>包含使用jmp指令实现任务切换</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 09_27_TaskSegments(任务段).cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务段</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _KTSS 结构原形</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ntdll!_KTSS</span></span><br><span class="line"><span class="comment">   +0x000 Backlink         : Uint2B</span></span><br><span class="line"><span class="comment">   +0x002 Reserved0        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x004 Esp0             : Uint4B</span></span><br><span class="line"><span class="comment">   +0x008 Ss0              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00a Reserved1        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x00c NotUsed1         : [4] Uint4B</span></span><br><span class="line"><span class="comment">   +0x01c CR3              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x020 Eip              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x024 EFlags           : Uint4B</span></span><br><span class="line"><span class="comment">   +0x028 Eax              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x02c Ecx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x030 Edx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x034 Ebx              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x038 Esp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x03c Ebp              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x040 Esi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x044 Edi              : Uint4B</span></span><br><span class="line"><span class="comment">   +0x048 Es               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04a Reserved2        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04c Cs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x04e Reserved3        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x050 Ss               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x052 Reserved4        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x054 Ds               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x056 Reserved5        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x058 Fs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05a Reserved6        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05c Gs               : Uint2B</span></span><br><span class="line"><span class="comment">   +0x05e Reserved7        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x060 LDT              : Uint2B</span></span><br><span class="line"><span class="comment">   +0x062 Reserved8        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x064 Flags            : Uint2B</span></span><br><span class="line"><span class="comment">   +0x066 IoMapBase        : Uint2B</span></span><br><span class="line"><span class="comment">   +0x068 IoMaps           : [1] _KiIoAccessMap</span></span><br><span class="line"><span class="comment">   +0x208c IntDirectionMap  : [32] UChar</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> szRet[<span class="number">6</span>] = &#123; <span class="number">0</span> &#125;;<span class="comment">// jmp 任务切换跳回</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x2024 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x20ac bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS;</span><br><span class="line"></span><br><span class="line">KTSS tss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp0[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> bufEsp3[<span class="number">0x2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">pushfd;</span><br><span class="line">pop eax;</span><br><span class="line"><span class="keyword">or</span> eax, <span class="number">0x4000</span>;</span><br><span class="line">push eax;</span><br><span class="line">popfd;</span><br><span class="line">iretd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">__asm </span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> <span class="number">3</span>;</span><br><span class="line">jmp fword ptr szRet;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// 0</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WORD tr = <span class="number">0</span>;</span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">str tr;</span><br><span class="line">&#125;</span><br><span class="line">*(WORD*)&amp;szRet[<span class="number">4</span>] = tr;       <span class="comment">// 保存旧的tr值</span></span><br><span class="line"><span class="built_in">memset</span>(bufEsp0, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">memset</span>(bufEsp3, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">tss.Esp0 = (ULONG)bufEsp0 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Esp = (ULONG)bufEsp3 + <span class="number">0x1FF0</span>;</span><br><span class="line">tss.Eax = <span class="number">0x1111</span>;</span><br><span class="line">tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">tss.Ss = <span class="number">0x10</span>;</span><br><span class="line">tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">tss.Es = <span class="number">0x23</span>;</span><br><span class="line">tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">tss.EFlags = <span class="number">2</span>;</span><br><span class="line">tss.Eip = (ULONG)test;</span><br><span class="line">tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入你的CR3: &quot;</span>);</span><br><span class="line">DWORD dwCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG ulCr3 = <span class="number">0</span>;</span><br><span class="line">ULONG pCr3 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%x&quot;</span>, &amp;dwCr3);</span><br><span class="line"></span><br><span class="line">tss.CR3 = dwCr3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\r\n&quot;</span>, &amp;tss);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufCode[<span class="number">6</span>] = &#123; <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// call fword ptr bufCode;</span></span><br><span class="line">jmp fword ptr bufCode;<span class="comment">// jmp实现任务切换</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;任务段&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows内核" scheme="http://example.com/categories/Windows%E5%86%85%E6%A0%B8/"/>
    
    
    <category term="Windows内核" scheme="http://example.com/tags/Windows%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>加密壳</title>
    <link href="http://example.com/175feeb0.html"/>
    <id>http://example.com/175feeb0.html</id>
    <published>2024-08-07T09:14:54.000Z</published>
    <updated>2024-08-08T09:57:42.658Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>加密壳</strong></p></div><span id="more"></span><h2 id="加壳"><a href="#加壳" class="headerlink" title="加壳"></a>加壳</h2><h2 id="解壳"><a href="#解壳" class="headerlink" title="解壳"></a>解壳</h2>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;加密壳&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows" scheme="http://example.com/categories/Windows/"/>
    
    
    <category term="Windows" scheme="http://example.com/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Windows线程控制</title>
    <link href="http://example.com/a313d734.html"/>
    <id>http://example.com/a313d734.html</id>
    <published>2024-08-01T14:17:58.000Z</published>
    <updated>2024-08-02T15:55:04.938Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>Windows线程控制</p></div><span id="more"></span><h2 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h2><h2 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h2><h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Windows线程控制&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows" scheme="http://example.com/categories/Windows/"/>
    
    
    <category term="Windows" scheme="http://example.com/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>CreateEvent</title>
    <link href="http://example.com/a0774706.html"/>
    <id>http://example.com/a0774706.html</id>
    <published>2024-08-01T01:13:05.000Z</published>
    <updated>2024-08-01T01:38:35.004Z</updated>
    
    
    
    
    <category term="Windows API" scheme="http://example.com/categories/Windows-API/"/>
    
    
    <category term="Windows API" scheme="http://example.com/tags/Windows-API/"/>
    
  </entry>
  
  <entry>
    <title>CreateThread</title>
    <link href="http://example.com/906a06b0.html"/>
    <id>http://example.com/906a06b0.html</id>
    <published>2024-07-30T01:35:47.000Z</published>
    <updated>2024-07-31T13:49:46.373Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong></strong></p><p>创建在调用进程的虚拟地址空间内执行的线程。<br>若要创建在另一个进程的虚拟地址空间中运行的线程，请使用<code>CreateRemoteThread</code>函数。</p></div><span id="more"></span><h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">_Ret_maybenull_</span></span><br><span class="line"><span class="function">HANDLE</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">CreateThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ __drv_aliasesMem LPVOID lpParameter,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpThreadId</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><h3 id="lpThreadAttributes"><a href="#lpThreadAttributes" class="headerlink" title="lpThreadAttributes"></a>lpThreadAttributes</h3><p>指向<code>SECURITY_ATTRIBUTES</code>结构的指针, 该结构确定是否可由子进程继承返回的句柄。如果<code>lpThreadAttributes</code>为<code>NULL</code>, 则无法进程句柄;</p><h3 id="dwStackSize"><a href="#dwStackSize" class="headerlink" title="dwStackSize"></a>dwStackSize</h3><p>堆栈的初始大小（以字节为单位）。系统将此值舍入到最近的页面。如果此参数为零, 则新线程将使用可执行文件的默认大小;</p><h3 id="lpStartAddress"><a href="#lpStartAddress" class="headerlink" title="lpStartAddress"></a>lpStartAddress</h3><p>指向要由线程执行的应用程序定义函数的指针。此指针表示线程的起始地址;</p><ul><li><code>lpStartAddress</code>函数原型<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_ LPVOID lpParameter</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="lpParameter"><a href="#lpParameter" class="headerlink" title="lpParameter"></a>lpParameter</h3><p>指向要传递给线程的变量的指针;</p><h3 id="dwCreationFlags"><a href="#dwCreationFlags" class="headerlink" title="dwCreationFlags"></a>dwCreationFlags</h3><p>控制线程的标志</p><table><thead><tr><th align="left">值</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">线程在创建后立即运行</td></tr><tr><td align="left">CREATE_SUSPENDED 0x00000004</td><td align="left">线程以挂起状态创建, 在调用<code>ResumeThread</code>函数之前不会运行</td></tr><tr><td align="left">STACK_SIZE_PARAM_IS_A_RESERVATION 0x00010000</td><td align="left"><code>dwStackSize</code>参数指定堆栈的初始保留大小。如果未指定此标志, <code>dwStackSize</code>将指定提交大小</td></tr></tbody></table><h3 id="lpThreadId"><a href="#lpThreadId" class="headerlink" title="lpThreadId"></a>lpThreadId</h3><p>指向接收线程标识符的变量的指针。如果此参数为<code>NULL</code>, 则不返回线程标识符;</p><h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><blockquote><p>如果函数成功, 则返回值是新线程的句柄;<br>如果函数失败, 则返回值为<code>NULL</code>;</p></blockquote><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadFirstProc</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WCHAR wcBuffer[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line">DWORD dwTimer = <span class="number">0</span>;</span><br><span class="line">::<span class="built_in">GetWindowText</span>((HWND)lpParameter, wcBuffer, <span class="number">20</span>);</span><br><span class="line">WCHAR wcValue[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> iValue = _wtoi(wcBuffer);</span><br><span class="line"><span class="keyword">while</span> (iValue &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wsprintf</span>(wcValue, <span class="string">L&quot;%d&quot;</span>, --iValue);</span><br><span class="line">::<span class="built_in">SetWindowText</span>((HWND)lpParameter, wcValue);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadSecondProc</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">WCHAR wcBuffer[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line">DWORD dwTimer = <span class="number">0</span>;</span><br><span class="line">::<span class="built_in">GetWindowText</span>((HWND)lpParameter, wcBuffer, <span class="number">20</span>);</span><br><span class="line">WCHAR wcValue[<span class="number">20</span>]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> iValue = _wtoi(wcBuffer);</span><br><span class="line"><span class="keyword">while</span> (iValue &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wsprintf</span>(wcValue, <span class="string">L&quot;%d&quot;</span>, ++iValue);</span><br><span class="line">::<span class="built_in">SetWindowText</span>((HWND)lpParameter, wcValue);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CWnd* pWndFirst = <span class="built_in">GetDlgItem</span>(IDC_EDIT1);</span><br><span class="line">HWND hWndFirst = pWndFirst-&gt;<span class="built_in">GetSafeHwnd</span>();</span><br><span class="line">CWnd* pWndSecond = <span class="built_in">GetDlgItem</span>(IDC_EDIT2);</span><br><span class="line">HWND hWndSecond = pWndSecond-&gt;<span class="built_in">GetSafeHwnd</span>();</span><br><span class="line">HANDLE hThreadFirst = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadFirstProc, hWndFirst, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">HANDLE hThreadSecond = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadSecondProc, hWndSecond, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><h2 id="WaitForSingleObject"><a href="#WaitForSingleObject" class="headerlink" title="WaitForSingleObject"></a>WaitForSingleObject</h2><div class="note info"><p><strong>功能说明</strong></p><p>等待函数可使线程自愿进入等待状态, 直到一个特定的内核对象变为已通知状态为止;</p></div><h2 id="函数声明-1"><a href="#函数声明-1" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WaitForSingleObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hHandle,            <span class="comment">// handle to object</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds       <span class="comment">// time-out interval</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><h3 id="hHandle"><a href="#hHandle" class="headerlink" title="hHandle"></a>hHandle</h3><p>内核对象句柄, 可以是进程也可以是线程;</p><h3 id="dwMilliseconds"><a href="#dwMilliseconds" class="headerlink" title="dwMilliseconds"></a>dwMilliseconds</h3><p>等待时间, 单位是毫秒; <code>INFINITE(-1)</code>一直等待;</p><h2 id="返回值-1"><a href="#返回值-1" class="headerlink" title="返回值"></a>返回值</h2><ul><li>WAIT_OBJECT_0(0); 等待对象变为已通知;</li><li>WAIT_TIMEOUT(0x102); 超时;</li></ul><h2 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h2><blockquote><ol><li>内核对象中的每种对象都可以说是处于已通知或未通知的状态之中;</li><li>这种状态的切换是由Microsoft为每个对象建立的一套规则来决定的;</li><li>当线程正在运行的时候, 线程内核对象处于未通知状态;</li><li>当线程终止运行的时候, 它就变为已通知状态;</li><li>在内核中就是个BOOL值, 运行时FALSE, 结束TRUE;</li></ol></blockquote><h2 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc1</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;+++++++++\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread1 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc1, </span><br><span class="line">    DWORD dwCode = ::<span class="built_in">WaitForSingleObject</span>(hThread1, INFINITE);</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WaitForMultipleObjects"><a href="#WaitForMultipleObjects" class="headerlink" title="WaitForMultipleObjects"></a>WaitForMultipleObjects</h2><div class="note info"><p><strong>功能说明</strong></p><p>同时查看若干个内核对象的已通知状态;</p></div><h2 id="函数声明-2"><a href="#函数声明-2" class="headerlink" title="函数声明"></a>函数声明</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WINBASEAPI</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function">WINAPI</span></span><br><span class="line"><span class="function"><span class="title">WaitForMultipleObjects</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nCount,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_(nCount) CONST HANDLE* lpHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bWaitAll,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure><h2 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h2><h3 id="nCount"><a href="#nCount" class="headerlink" title="nCount"></a>nCount</h3><p>要查看内核对象的数量;</p><h3 id="lpHandles"><a href="#lpHandles" class="headerlink" title="lpHandles"></a>lpHandles</h3><p>内核对象数组</p><h3 id="bWaitAll"><a href="#bWaitAll" class="headerlink" title="bWaitAll"></a>bWaitAll</h3><p>等待类型; TRUE: 等待所有变为已通知, FALSE: 只要有一个变为已通知;</p><h3 id="dwMilliseconds-1"><a href="#dwMilliseconds-1" class="headerlink" title="dwMilliseconds"></a>dwMilliseconds</h3><p>超时时间; <code>INFINITE</code>一直等待;</p><h2 id="返回值-2"><a href="#返回值-2" class="headerlink" title="返回值"></a>返回值</h2><ul><li>bWaitAll为TRUE时, 返回WAIT_OBJECT_0(0)代码所有内核对象都变为已通知;</li><li>bWaitAll为FALSE时, 返回最先变成已通知的内核对象在数组中的索引;</li><li>WAIT_TIMEOUT(0x102), 超时;</li></ul><h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc1</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;+++++++++\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">                            </span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc2</span><span class="params">(LPVOID lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---------\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;               </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">                            </span><br><span class="line">                            </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">                            </span><br><span class="line">    HANDLE hArray[<span class="number">2</span>];              </span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread1 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc1, </span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                            </span><br><span class="line">    <span class="comment">//创建一个新的线程</span></span><br><span class="line">    HANDLE hThread2 = ::<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc2, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);            </span><br><span class="line">    hArray[<span class="number">0</span>] = hThread1;</span><br><span class="line">    hArray[<span class="number">1</span>] = hThread2;           </span><br><span class="line">    DWORD dwCode = ::<span class="built_in">WaitForMultipleObjects</span>(<span class="number">2</span>, hArray,FALSE,INFINITE);                </span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);                 </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;创建在调用进程的虚拟地址空间内执行的线程。&lt;br&gt;若要创建在另一个进程的虚拟地址空间中运行的线程，请使用&lt;code&gt;CreateRemoteThread&lt;/code&gt;函数。&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows API" scheme="http://example.com/categories/Windows-API/"/>
    
    
    <category term="Windows API" scheme="http://example.com/tags/Windows-API/"/>
    
  </entry>
  
  <entry>
    <title>移动重定位表</title>
    <link href="http://example.com/5e9312f.html"/>
    <id>http://example.com/5e9312f.html</id>
    <published>2024-07-02T07:15:23.000Z</published>
    <updated>2024-07-05T11:09:52.698Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>移动重定位表</strong></p><p><code>Relocation（重定位）</code>是一种将程序中的一些地址修正为运行时可用的实际地址的机制。在程序编译过程中，由于程序中使用了各种全局变量和函数，这些变量和函数的地址还没有确定，因此它们的地址只能暂时使用一个相对地址。当程序被加载到内存中运行时，这些相对地址需要被修正为实际的绝对地址，这个过程就是重定位;</p><p>在Windows操作系统中，程序被加载到内存中运行时，需要将程序中的各种内存地址进行重定位，以使程序能够正确地运行。Windows系统使用PE（Portable Executable）文件格式来存储可执行程序，其中包括重定位信息。当程序被加载到内存中时，系统会解析这些重定位信息，并将程序中的各种内存地址进行重定位;</p><p>重定位表一般出现在DLL中，因为DLL都是动态加载，所以地址不固定，DLL的入口点在整个执行过程中至少要执行2次，一次是在开始时执行初始化工作，一次则是在结束时做最后的收尾工作，重定位表则是解决DLL的地址问题;</p></div><span id="more"></span><h2 id="移动重定位表步骤"><a href="#移动重定位表步骤" class="headerlink" title="移动重定位表步骤"></a>移动重定位表步骤</h2><div class="note info"><p><strong></strong></p><ol><li>读取文件并在FileBuffer中新增一个节(<code>.rbase</code>);</li><li>设置节表信息并修正PE头;</li><li>解析重定位表、复制重定位表、修正数据目录;</li><li>将数据写入新的文件;</li><li>验证是否移动成功;</li></ol></div><h3 id="ROA转FOA"><a href="#ROA转FOA" class="headerlink" title="ROA转FOA"></a>ROA转FOA</h3><blockquote><p>将ROA转换成FOA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpBuffer);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FOA转RVA"><a href="#FOA转RVA" class="headerlink" title="FOA转RVA"></a>FOA转RVA</h3><blockquote><p>将FOA转化成RVA</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">FOA2RVA</span><span class="params">(DWORD dwFOA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwFOA &lt; pSec[<span class="number">0</span>].PointerToRawData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwFOA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwFOA &gt;= pSec[i].PointerToRawData &amp;&amp; dwFOA &lt; pSec[i].PointerToRawData + pSec[i].SizeOfRawData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pSec[i].VirtualAddress + dwFOA - pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwFOA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="移动重定位表具体步骤"><a href="#移动重定位表具体步骤" class="headerlink" title="移动重定位表具体步骤"></a>移动重定位表具体步骤</h3><ol><li>读取Dll文件至内存中</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">    FilePath_SRC,</span><br><span class="line">    GENERIC_READ,</span><br><span class="line">    FILE_SHARE_READ,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"><span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">DWORD dwRead = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br></pre></td></tr></table></figure><ol start="2"><li>新增节表<blockquote><p>新增<code>.rbase</code>节表</p></blockquote></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析PE文件</span></span><br><span class="line">PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"><span class="comment">//printf(&quot;pDos: %x\n&quot;, pDos-&gt;e_magic);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增节表</span></span><br><span class="line">PIMAGE_SECTION_HEADER pNewSec = pSec + pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line"><span class="keyword">if</span> (((DWORD)lpData + dwFileSize - (DWORD)pNewSec) &lt; <span class="number">80</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;空间不足新增节表\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置节表信息</span></span><br><span class="line"><span class="built_in">strcpy</span>((<span class="type">char</span>*)pNewSec-&gt;Name, <span class="string">&quot;.rbase&quot;</span>);</span><br><span class="line">pNewSec-&gt;Misc.VirtualSize = <span class="number">0x7000</span>;</span><br><span class="line">pNewSec-&gt;VirtualAddress = pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">pNewSec-&gt;SizeOfRawData = <span class="number">0x7000</span>;</span><br><span class="line">PIMAGE_SECTION_HEADER pLastSec = pSec + (pNt-&gt;FileHeader.NumberOfSections - <span class="number">1</span>);</span><br><span class="line">pNewSec-&gt;PointerToRawData = pLastSec-&gt;PointerToRawData + pLastSec-&gt;SizeOfRawData;</span><br><span class="line">pNewSec-&gt;Characteristics = pSec[<span class="number">0</span>].Characteristics;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正PE头</span></span><br><span class="line">pNt-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">pNt-&gt;OptionalHeader.SizeOfImage += <span class="number">0x7000</span>;</span><br></pre></td></tr></table></figure><ol start="3"><li>复制重定位表</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LPVOID lpSecMemory = <span class="keyword">new</span> BYTE[<span class="number">0x7000</span>];</span><br><span class="line"><span class="keyword">if</span> (lpSecMemory == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新节表申请内存失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(lpSecMemory, <span class="number">0</span>, <span class="number">0x7000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析重定位表</span></span><br><span class="line">PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pDir-&gt;Size: %x\n&quot;</span>, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制重定位表</span></span><br><span class="line"> <span class="built_in">memcpy</span>(lpSecMemory, pReloc, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正数据目录</span></span><br><span class="line">pDir-&gt;VirtualAddress = <span class="built_in">FOA2RVA</span>(dwFileSize, lpData);</span><br></pre></td></tr></table></figure><ol start="4"><li><p>将数据写入新文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开新文件</span></span><br><span class="line">HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写出第一部分</span></span><br><span class="line">DWORD lpNumberOfBytesWritten1 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten1, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile One Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写出新节</span></span><br><span class="line">DWORD lpNumberOfBytesWritten2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpSecMemory, <span class="number">0x7000</span>, &amp;lpNumberOfBytesWritten2, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Two Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success: %d %d\n&quot;</span>, lpNumberOfBytesWritten1, lpNumberOfBytesWritten2);</span><br></pre></td></tr></table></figure></li><li><p>调用新的Dll文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line"><span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line"><span class="built_in">myShowMessage</span>();</span><br></pre></td></tr></table></figure></li></ol><h3 id="运行成功"><a href="#运行成功" class="headerlink" title="运行成功"></a>运行成功</h3><p><img src="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021628694.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021628694.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="移动重定位表"></p><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> FilePath_SRC = <span class="string">&quot;xxx\\Dll1.dll&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> FilePath_DEST = <span class="string">&quot;xxx\\Dll1_demo.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">FOA2RVA</span><span class="params">(DWORD dwFOA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwFOA &lt; pSec[<span class="number">0</span>].PointerToRawData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwFOA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwFOA &gt;= pSec[i].PointerToRawData &amp;&amp; dwFOA &lt; pSec[i].PointerToRawData + pSec[i].SizeOfRawData)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> pSec[i].VirtualAddress + dwFOA - pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwFOA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取文件</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">        FilePath_SRC,</span><br><span class="line">        GENERIC_READ,</span><br><span class="line">        FILE_SHARE_READ,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_ARCHIVE,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">    LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">    <span class="keyword">if</span> (lpData == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析PE文件</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="comment">//printf(&quot;pDos: %x\n&quot;, pDos-&gt;e_magic);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增节表</span></span><br><span class="line">    PIMAGE_SECTION_HEADER pNewSec = pSec + pNt-&gt;FileHeader.NumberOfSections;</span><br><span class="line">    <span class="keyword">if</span> (((DWORD)lpData + dwFileSize - (DWORD)pNewSec) &lt; <span class="number">80</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;空间不足新增节表\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置节表信息</span></span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span>*)pNewSec-&gt;Name, <span class="string">&quot;.rbase&quot;</span>);</span><br><span class="line">    pNewSec-&gt;Misc.VirtualSize = <span class="number">0x7000</span>;</span><br><span class="line">    pNewSec-&gt;VirtualAddress = pNt-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">    pNewSec-&gt;SizeOfRawData = <span class="number">0x7000</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pLastSec = pSec + (pNt-&gt;FileHeader.NumberOfSections - <span class="number">1</span>);</span><br><span class="line">    pNewSec-&gt;PointerToRawData = pLastSec-&gt;PointerToRawData + pLastSec-&gt;SizeOfRawData;</span><br><span class="line">    pNewSec-&gt;Characteristics = pSec[<span class="number">0</span>].Characteristics;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修正PE头</span></span><br><span class="line">    pNt-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">    pNt-&gt;OptionalHeader.SizeOfImage += <span class="number">0x7000</span>;</span><br><span class="line"></span><br><span class="line">    LPVOID lpSecMemory = <span class="keyword">new</span> BYTE[<span class="number">0x7000</span>];</span><br><span class="line">    <span class="keyword">if</span> (lpSecMemory == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;新节表申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(lpSecMemory, <span class="number">0</span>, <span class="number">0x7000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析重定位表</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">    PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pDir-&gt;Size: %x\n&quot;</span>, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制重定位表</span></span><br><span class="line">     <span class="built_in">memcpy</span>(lpSecMemory, pReloc, pDir-&gt;Size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修正数据目录</span></span><br><span class="line">    pDir-&gt;VirtualAddress = <span class="built_in">FOA2RVA</span>(dwFileSize, lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 打开新文件</span></span><br><span class="line">    HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写出第一部分</span></span><br><span class="line">    DWORD lpNumberOfBytesWritten1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten1, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile One Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写出新节</span></span><br><span class="line">    DWORD lpNumberOfBytesWritten2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpSecMemory, <span class="number">0x7000</span>, &amp;lpNumberOfBytesWritten2, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Two Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success: %d %d\n&quot;</span>, lpNumberOfBytesWritten1, lpNumberOfBytesWritten2);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">    HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line">    <span class="built_in">myShowMessage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重建重定位结构"><a href="#重建重定位结构" class="headerlink" title="重建重定位结构"></a>重建重定位结构</h2><div class="note info"><p><strong></strong></p><p>重定位表的修复原理与IAT修复完全一致，我们需要分别读入脱壳前与脱壳后的两个程序，接着通过循环正确的重定位表信息，并依次覆盖到脱壳后的程序内，以此实现对重定位表的修复功能;</p></div><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Modify_ImageBase_Demo.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> FilePath_SRC = <span class="string">&quot;xxx\\Dll1.dll&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span> FilePath_DEST = <span class="string">&quot;xxx\\Dll1_Demo.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">RVA2FOA</span><span class="params">(DWORD dwRVA, LPVOID lpBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpBuffer;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)pDos);</span><br><span class="line">    PIMAGE_SECTION_HEADER pSec = <span class="built_in">IMAGE_FIRST_SECTION</span>(pNt);</span><br><span class="line">    <span class="keyword">if</span> (dwRVA &lt; pSec[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dwRVA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dwRVA &gt;= pSec[i].VirtualAddress &amp;&amp; dwRVA &lt;= pSec[i].VirtualAddress + pSec[i].Misc.VirtualSize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dwRVA - pSec[i].VirtualAddress + pSec[i].PointerToRawData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dwRVA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFileA</span>(</span><br><span class="line">        (LPSTR)FilePath_SRC,</span><br><span class="line">        GENERIC_READ,</span><br><span class="line">        FILE_SHARE_READ,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD dwFileSize = <span class="built_in">GetFileSize</span>(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dwFileSize: %d\n&quot;</span>, dwFileSize);</span><br><span class="line">    LPVOID lpData = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == lpData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;申请内存失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD lpNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;lpNumberOfBytesRead, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lpData: %x\n&quot;</span>, *(<span class="type">short</span>*)lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//解析PE</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpData;</span><br><span class="line">    PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + (DWORD)lpData);</span><br><span class="line">     <span class="comment">//定位重定位位置</span></span><br><span class="line">    PIMAGE_DATA_DIRECTORY pDataDir = (PIMAGE_DATA_DIRECTORY)(pNt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line">     <span class="comment">//获取重定位表</span></span><br><span class="line">    PIMAGE_BASE_RELOCATION pLoc = (PIMAGE_BASE_RELOCATION)(<span class="built_in">RVA2FOA</span>(pDataDir-&gt;VirtualAddress, lpData) + (DWORD)lpData);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//判断是否有重定位表, 数据目录表不存在时, VirtualAddress为0, 也就是指向映像基址</span></span><br><span class="line">    <span class="keyword">if</span> ((LPVOID)pLoc == lpData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//循环重定位表, 重定位表VirtualAddress和SizeOfBlock都为0表示重定位表结束</span></span><br><span class="line">    <span class="keyword">while</span> ((pLoc-&gt;VirtualAddress + pLoc-&gt;SizeOfBlock) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//重定位数据, 位于IMAGE_BASE_RELOCATION表开头8字节之后</span></span><br><span class="line">        PWORD pLocData = (PWORD)((PBYTE)pLoc + <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">         <span class="comment">//计算本节需要修正的重定位项（地址）的数目, 每个数据都是16字节（4+12字节, 高4位表示重定位类型, 低12位为RVA）</span></span><br><span class="line">         <span class="comment">//SizeOfBlock的值包括了SizeOfBlock和VirtualAddress的大小, 8字节需要减去</span></span><br><span class="line">        DWORD dwNumOfpLoc = (pLoc-&gt;SizeOfBlock - <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="built_in">sizeof</span>(WORD);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; dwNumOfpLoc; i++)</span><br><span class="line">        &#123;</span><br><span class="line">             <span class="comment">//高位为3表示有效重定位</span></span><br><span class="line">            <span class="keyword">if</span> ((DWORD)(pLocData[i] &amp; <span class="number">0x0000F000</span>) == <span class="number">0x00003000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="comment">/*需要修正的数据</span></span><br><span class="line"><span class="comment">                 修正重定位数据, 重定位表记录的是存在硬编码的地址, 以基址+偏移的形式</span></span><br><span class="line"><span class="comment">                 存在硬编码的地址 = 重定位基址 + 重定位表数据偏移</span></span><br><span class="line"><span class="comment">                      = 基址 + 重定位地址 + 重定位数据（数据后12位）*/</span></span><br><span class="line">                PDWORD pAddress = (PDWORD)((PBYTE)pDos + <span class="built_in">RVA2FOA</span>(pLoc-&gt;VirtualAddress + (pLocData[i] &amp; <span class="number">0x0FFF</span>), lpData));</span><br><span class="line">                 <span class="comment">//重定位地址 = 硬编码地址 - ImageBase + 实际基地址</span></span><br><span class="line">                 <span class="comment">//           = 实际基地址 - ImageBase + 硬编码地址</span></span><br><span class="line">                *pAddress = *pAddress - pNt-&gt;OptionalHeader.ImageBase + <span class="number">0x1500000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">//循环下一个重定位区段</span></span><br><span class="line">        pLoc = (PIMAGE_BASE_RELOCATION)((PBYTE)pLoc + pLoc-&gt;SizeOfBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改ImageBase</span></span><br><span class="line">    pNt-&gt;OptionalHeader.ImageBase = <span class="number">0x1500000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开新文件</span></span><br><span class="line">    HANDLE hNewFile = <span class="built_in">CreateFileA</span>(FilePath_DEST, GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hNewFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD lpNumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (FALSE == <span class="built_in">WriteFile</span>(hNewFile, lpData, dwFileSize, &amp;lpNumberOfBytesWritten, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hNewFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WriteFile Success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MyShowMessage)</span><span class="params">()</span></span>;</span><br><span class="line">    HMODULE hDll = <span class="built_in">LoadLibraryA</span>(FilePath_DEST);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibraryA Failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    MyShowMessage myShowMessage = (MyShowMessage)<span class="built_in">GetProcAddress</span>(hDll, <span class="string">&quot;ShowMessage&quot;</span>);</span><br><span class="line">    <span class="built_in">myShowMessage</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行成功-1"><a href="#运行成功-1" class="headerlink" title="运行成功"></a>运行成功</h3><p><img src="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021717655.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/Dooookey/Photos/main/202407021717655.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="重建重定位表"></p>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;移动重定位表&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;code&gt;Relocation（重定位）&lt;/code&gt;是一种将程序中的一些地址修正为运行时可用的实际地址的机制。在程序编译过程中，由于程序中使用了各种全局变量和函数，这些变量和函数的地址还没有确定，因此它们的地址只能暂时使用一个相对地址。当程序被加载到内存中运行时，这些相对地址需要被修正为实际的绝对地址，这个过程就是重定位;&lt;/p&gt;&lt;p&gt;在Windows操作系统中，程序被加载到内存中运行时，需要将程序中的各种内存地址进行重定位，以使程序能够正确地运行。Windows系统使用PE（Portable Executable）文件格式来存储可执行程序，其中包括重定位信息。当程序被加载到内存中时，系统会解析这些重定位信息，并将程序中的各种内存地址进行重定位;&lt;/p&gt;&lt;p&gt;重定位表一般出现在DLL中，因为DLL都是动态加载，所以地址不固定，DLL的入口点在整个执行过程中至少要执行2次，一次是在开始时执行初始化工作，一次则是在结束时做最后的收尾工作，重定位表则是解决DLL的地址问题;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows PE" scheme="http://example.com/categories/Windows-PE/"/>
    
    
    <category term="Windows PE" scheme="http://example.com/tags/Windows-PE/"/>
    
  </entry>
  
  <entry>
    <title>ShellCode加载器</title>
    <link href="http://example.com/3cf1e5d0.html"/>
    <id>http://example.com/3cf1e5d0.html</id>
    <published>2024-06-27T14:56:45.000Z</published>
    <updated>2024-06-27T14:57:58.557Z</updated>
    
    <content type="html"><![CDATA[<div class="note info"><p><strong>ShellCode加载器</strong></p></div><span id="more"></span>]]></content>
    
    
    <summary type="html">&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;&lt;strong&gt;ShellCode加载器&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;</summary>
    
    
    
    <category term="Windows" scheme="http://example.com/categories/Windows/"/>
    
    
    <category term="Windows" scheme="http://example.com/tags/Windows/"/>
    
  </entry>
  
</feed>
